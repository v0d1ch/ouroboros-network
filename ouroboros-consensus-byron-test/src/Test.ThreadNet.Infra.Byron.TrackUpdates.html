<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Test.ThreadNet.Infra.Byron.TrackUpdates</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProtocolVersionUpdateLabel"><span class="hs-identifier">ProtocolVersionUpdateLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#SoftwareVersionUpdateLabel"><span class="hs-identifier">SoftwareVersionUpdateLabel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkProtocolByronAndHardForkTxs"><span class="hs-identifier">mkProtocolByronAndHardForkTxs</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkUpdateLabels"><span class="hs-identifier">mkUpdateLabels</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">assert</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">guard</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Coerce</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">coerce</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word64</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HasCallStack</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Binary</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Block</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Block</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Byron.API</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ByronAPI</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Genesis</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Genesis</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.MempoolPayload</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MempoolPayload</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Slotting</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">EpochSlots</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SlotNumber</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Update</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Proposal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AProposal</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Proposal</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Proposal</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Validation.Interface</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Update</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Validation.Registration</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Registration</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Vote</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AVote</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Vote</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Vote</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Crypto</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Crypto</span></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Node.ProtocolInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">NumCoreNodes</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>                     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">ProtocolInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.NodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">CoreNodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Protocol.PBFT</span></a></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier">Ouroboros.Consensus.Byron.Crypto.DSIGN</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Crypto</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier">ByronBlock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Byron</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">Test.ThreadNet.Network</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">TestNodeInitialization</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">Test.ThreadNet.Ref.PBFT</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ref</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">Test.ThreadNet.Util.NodeJoinPlan</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">Test.ThreadNet.Util.NodeTopology</span></a></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html"><span class="hs-identifier">Test.ThreadNet.Infra.Byron.ProtocolInfo</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">Test.Util.Slots</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier">NumSlots</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | The expectation and observation regarding whether the hard-fork proposal</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- successfully updated the protocol version</span><span>
</span><span id="line-63"></span><span class="hs-comment">--</span><span>
</span><span id="line-64"></span><span class="hs-keyword">data</span><span> </span><span id="ProtocolVersionUpdateLabel"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProtocolVersionUpdateLabel"><span class="hs-identifier hs-var">ProtocolVersionUpdateLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ProtocolVersionUpdateLabel"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProtocolVersionUpdateLabel"><span class="hs-identifier hs-var">ProtocolVersionUpdateLabel</span></a></span></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="pvuObserved"><span class="annot"><span class="annottext">ProtocolVersionUpdateLabel -&gt; Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#pvuObserved"><span class="hs-identifier hs-var hs-var">pvuObserved</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">-- ^ whether the proposed protocol version is adopted or not adopted by the</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- end of the test</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="pvuRequired"><span class="annot"><span class="annottext">ProtocolVersionUpdateLabel -&gt; Maybe Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#pvuRequired"><span class="hs-identifier hs-var hs-var">pvuRequired</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- ^ @Just b@ indicates whether the final chains must have adopted or must</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- have not adopted the proposed protocol version. @Nothing@ means there is</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- no requirement.</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679175973"><span id="local-6989586621679175975"><span id="local-6989586621679175977"><span class="annot"><span class="annottext">Int -&gt; ProtocolVersionUpdateLabel -&gt; ShowS
[ProtocolVersionUpdateLabel] -&gt; ShowS
ProtocolVersionUpdateLabel -&gt; String
(Int -&gt; ProtocolVersionUpdateLabel -&gt; ShowS)
-&gt; (ProtocolVersionUpdateLabel -&gt; String)
-&gt; ([ProtocolVersionUpdateLabel] -&gt; ShowS)
-&gt; Show ProtocolVersionUpdateLabel
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ProtocolVersionUpdateLabel] -&gt; ShowS
$cshowList :: [ProtocolVersionUpdateLabel] -&gt; ShowS
show :: ProtocolVersionUpdateLabel -&gt; String
$cshow :: ProtocolVersionUpdateLabel -&gt; String
showsPrec :: Int -&gt; ProtocolVersionUpdateLabel -&gt; ShowS
$cshowsPrec :: Int -&gt; ProtocolVersionUpdateLabel -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- | As 'ProtocolVersionUpdateLabel', but for software version updates</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- Note that software version updates are adopted sooner than and perhaps</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- independently of protocol version updates, even when they are introduced by</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- the same proposal transaction.</span><span>
</span><span id="line-80"></span><span class="hs-comment">--</span><span>
</span><span id="line-81"></span><span class="hs-keyword">data</span><span> </span><span id="SoftwareVersionUpdateLabel"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#SoftwareVersionUpdateLabel"><span class="hs-identifier hs-var">SoftwareVersionUpdateLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SoftwareVersionUpdateLabel"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#SoftwareVersionUpdateLabel"><span class="hs-identifier hs-var">SoftwareVersionUpdateLabel</span></a></span></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="svuObserved"><span class="annot"><span class="annottext">SoftwareVersionUpdateLabel -&gt; Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#svuObserved"><span class="hs-identifier hs-var hs-var">svuObserved</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="svuRequired"><span class="annot"><span class="annottext">SoftwareVersionUpdateLabel -&gt; Maybe Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#svuRequired"><span class="hs-identifier hs-var hs-var">svuRequired</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679175963"><span id="local-6989586621679175965"><span id="local-6989586621679175967"><span class="annot"><span class="annottext">Int -&gt; SoftwareVersionUpdateLabel -&gt; ShowS
[SoftwareVersionUpdateLabel] -&gt; ShowS
SoftwareVersionUpdateLabel -&gt; String
(Int -&gt; SoftwareVersionUpdateLabel -&gt; ShowS)
-&gt; (SoftwareVersionUpdateLabel -&gt; String)
-&gt; ([SoftwareVersionUpdateLabel] -&gt; ShowS)
-&gt; Show SoftwareVersionUpdateLabel
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SoftwareVersionUpdateLabel] -&gt; ShowS
$cshowList :: [SoftwareVersionUpdateLabel] -&gt; ShowS
show :: SoftwareVersionUpdateLabel -&gt; String
$cshow :: SoftwareVersionUpdateLabel -&gt; String
showsPrec :: Int -&gt; SoftwareVersionUpdateLabel -&gt; ShowS
$cshowsPrec :: Int -&gt; SoftwareVersionUpdateLabel -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- | Classify the a @QuickCheck@ test's input and output with respect to</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- whether the protocol\/software version should have been\/was updated</span><span>
</span><span id="line-89"></span><span class="hs-comment">--</span><span>
</span><span id="line-90"></span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkUpdateLabels"><span class="hs-identifier hs-type">mkUpdateLabels</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">PBftParams</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">NumSlots</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Genesis.Config</span></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">NodeJoinPlan</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">NodeTopology</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Result</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Byron.LedgerState</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span>
</span><span id="line-98"></span><span>     </span><span class="hs-comment">-- ^ from 'nodeOutputFinalLedger'</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProtocolVersionUpdateLabel"><span class="hs-identifier hs-type">ProtocolVersionUpdateLabel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#SoftwareVersionUpdateLabel"><span class="hs-identifier hs-type">SoftwareVersionUpdateLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span id="mkUpdateLabels"><span class="annot"><span class="annottext">mkUpdateLabels :: PBftParams
-&gt; NumSlots
-&gt; Config
-&gt; NodeJoinPlan
-&gt; NodeTopology
-&gt; Result
-&gt; LedgerState ByronBlock
-&gt; (ProtocolVersionUpdateLabel, SoftwareVersionUpdateLabel)
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkUpdateLabels"><span class="hs-identifier hs-var hs-var">mkUpdateLabels</span></a></span></span><span> </span><span id="local-6989586621679175962"><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175962"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679175961"><span class="annot"><span class="annottext">NumSlots
</span><a href="#local-6989586621679175961"><span class="hs-identifier hs-var">numSlots</span></a></span></span><span> </span><span id="local-6989586621679175960"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175960"><span class="hs-identifier hs-var">genesisConfig</span></a></span></span><span> </span><span id="local-6989586621679175959"><span class="annot"><span class="annottext">NodeJoinPlan
</span><a href="#local-6989586621679175959"><span class="hs-identifier hs-var">nodeJoinPlan</span></a></span></span><span> </span><span id="local-6989586621679175958"><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679175958"><span class="hs-identifier hs-var">topology</span></a></span></span><span> </span><span id="local-6989586621679175957"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621679175957"><span class="hs-identifier hs-var">result</span></a></span></span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621679175956"><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679175956"><span class="hs-identifier hs-var">ldgr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProtocolVersionUpdateLabel
</span><a href="#local-6989586621679175955"><span class="hs-identifier hs-var">pvuLabel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SoftwareVersionUpdateLabel
</span><a href="#local-6989586621679175954"><span class="hs-identifier hs-var">svuLabel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">PBftParams</span></a></span><span class="hs-special">{</span><span id="local-6989586621679175952"><span class="annot"><span class="annottext">NumCoreNodes
pbftNumNodes :: PBftParams -&gt; NumCoreNodes
pbftNumNodes :: NumCoreNodes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">pbftNumNodes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679175950"><span class="annot"><span class="annottext">SecurityParam
pbftSecurityParam :: PBftParams -&gt; SecurityParam
pbftSecurityParam :: SecurityParam
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">pbftSecurityParam</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175962"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-comment">-- the slot immediately after the end of the simulation</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><a href="#local-6989586621679175948"><span class="hs-identifier hs-type">sentinel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNumber</span></span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621679175948"><span class="annot"><span class="annottext">sentinel :: SlotNumber
</span><a href="#local-6989586621679175948"><span class="hs-identifier hs-var hs-var">sentinel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNumber
</span><span class="hs-identifier hs-var">SlotNumber</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175946"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-110"></span><span>        </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">NumSlots</span></a></span><span> </span><span id="local-6989586621679175946"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175946"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NumSlots
</span><a href="#local-6989586621679175961"><span class="hs-identifier hs-var">numSlots</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">-- a block forged in slot @s@ becomes immutable/stable in slot @s + twoK@</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- according to the Byron Chain Density invariant</span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><a href="#local-6989586621679175944"><span class="hs-identifier hs-type">twoK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621679175944"><span class="annot"><span class="annottext">twoK :: SlotNo
</span><a href="#local-6989586621679175944"><span class="hs-identifier hs-var hs-var">twoK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><span class="hs-identifier hs-var">SlotNo</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; SlotNo) -&gt; Word64 -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Word64
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">maxRollbacks</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679175950"><span class="hs-identifier hs-var">pbftSecurityParam</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-comment">-- the number of slots in an epoch</span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><a href="#local-6989586621679175940"><span class="hs-identifier hs-type">epochSlots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621679175940"><span class="annot"><span class="annottext">epochSlots :: SlotNo
</span><a href="#local-6989586621679175940"><span class="hs-identifier hs-var hs-var">epochSlots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochSlots -&gt; SlotNo
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">(EpochSlots -&gt; SlotNo) -&gt; EpochSlots -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Config -&gt; EpochSlots
</span><span class="hs-identifier hs-var">Genesis.configEpochSlots</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175960"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">-- the protocol parameters</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- ASSUMPTION: These do not change during the test.</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621679175938"><span class="hs-identifier hs-type">pp0</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Update.ProtocolParameters</span></span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679175938"><span class="annot"><span class="annottext">pp0 :: ProtocolParameters
</span><a href="#local-6989586621679175938"><span class="hs-identifier hs-var hs-var">pp0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; ProtocolParameters
</span><span class="hs-identifier hs-var">Genesis.configProtocolParameters</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175960"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">-- how many votes/endorsements the proposal needs to gain</span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><a href="#local-6989586621679175936"><span class="hs-identifier hs-type">quorum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621679175936"><span class="annot"><span class="annottext">quorum :: Word64
</span><a href="#local-6989586621679175936"><span class="hs-identifier hs-var hs-var">quorum</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679175935"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175935"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Word64 -&gt; Word64
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175935"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175935"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word64) -&gt; Word64 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word64) -&gt; Int -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; ProtocolParameters -&gt; Int
</span><span class="hs-identifier hs-var">Update.upAdptThd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word8
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175932"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ProtocolParameters
</span><a href="#local-6989586621679175938"><span class="hs-identifier hs-var">pp0</span></a></span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-133"></span><span>        </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NumCoreNodes</span></a></span><span> </span><span id="local-6989586621679175932"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175932"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NumCoreNodes
</span><a href="#local-6989586621679175952"><span class="hs-identifier hs-var">pbftNumNodes</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- how many slots the proposal has to gain sufficient votes before it</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- expires</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><a href="#local-6989586621679175930"><span class="hs-identifier hs-type">ttl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621679175930"><span class="annot"><span class="annottext">ttl :: SlotNo
</span><a href="#local-6989586621679175930"><span class="hs-identifier hs-var hs-var">ttl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNumber -&gt; SlotNo
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">(SlotNumber -&gt; SlotNo) -&gt; SlotNumber -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProtocolParameters -&gt; SlotNumber
</span><span class="hs-identifier hs-var hs-var">Update.ppUpdateProposalTTL</span></span><span> </span><span class="annot"><span class="annottext">ProtocolParameters
</span><a href="#local-6989586621679175938"><span class="hs-identifier hs-var">pp0</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- the first slot of the epoch after the epoch containing the given slot</span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><a href="#local-6989586621679175928"><span class="hs-identifier hs-type">ebbSlotAfter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-142"></span><span>    </span><span id="local-6989586621679175928"><span class="annot"><span class="annottext">ebbSlotAfter :: SlotNo -&gt; SlotNo
</span><a href="#local-6989586621679175928"><span class="hs-identifier hs-var hs-var">ebbSlotAfter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span id="local-6989586621679175927"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175927"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><span class="hs-identifier hs-var">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175926"><span class="hs-identifier hs-var">denom</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">div</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175927"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175926"><span class="hs-identifier hs-var">denom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175940"><span class="hs-identifier hs-var">epochSlots</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span id="local-6989586621679175926"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175926"><span class="hs-identifier hs-var">denom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175940"><span class="hs-identifier hs-var">epochSlots</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="#local-6989586621679175923"><span class="hs-identifier hs-type">finalState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Outcome</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProposalState"><span class="hs-identifier hs-type">ProposalState</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621679175923"><span class="annot"><span class="annottext">finalState :: [Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175923"><span class="hs-identifier hs-var hs-var">finalState</span></a></span></span><span> </span><span id="local-6989586621679175922"><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175922"><span class="hs-identifier hs-var">outcomes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; SlotNo -&gt; [Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175921"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Proposing"><span class="hs-identifier hs-var">Proposing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><span class="hs-identifier hs-var">SlotNo</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175922"><span class="hs-identifier hs-var">outcomes</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-comment">-- compute the @Just@ case of 'pvuRequired' from the simulated outcomes</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="#local-6989586621679175921"><span class="hs-identifier hs-type">go</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProposalState"><span class="hs-identifier hs-type">ProposalState</span></a></span><span>
</span><span id="line-153"></span><span>         </span><span class="hs-comment">-- ^ the state before the next outcome</span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-155"></span><span>         </span><span class="hs-comment">-- ^ the slot described by the next outcome</span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Outcome</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProposalState"><span class="hs-identifier hs-type">ProposalState</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679175921"><span class="annot"><span class="annottext">go :: ProposalState -&gt; SlotNo -&gt; [Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175921"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679175919"><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679175918"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ProposalState -&gt; ProposalState
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNumber -&gt; SlotNo
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">SlotNumber
</span><a href="#local-6989586621679175948"><span class="hs-identifier hs-var">sentinel</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-160"></span><span>      </span><span id="local-6989586621679175917"><span class="annot"><span class="annottext">Outcome
</span><a href="#local-6989586621679175917"><span class="hs-identifier hs-var">o</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679175916"><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175916"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Outcome
</span><a href="#local-6989586621679175917"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-161"></span><span>          </span><span class="annot"><span class="annottext">Outcome
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">Ref.Absent</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-162"></span><span>          </span><span class="annot"><span class="annottext">Outcome
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">Ref.Unable</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-163"></span><span>          </span><span class="annot"><span class="annottext">Outcome
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">Ref.Wasted</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span class="annot"><span class="annottext">Outcome
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">Ref.Nominal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-165"></span><span>              </span><span class="hs-comment">-- the proposal is in this slot</span><span>
</span><span id="line-166"></span><span>              </span><span class="annot"><span class="annottext">ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Proposing"><span class="hs-identifier hs-var">Proposing</span></a></span><span>                    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- if this leader just joined, it will forge before the</span><span>
</span><span id="line-168"></span><span>                      </span><span class="hs-comment">-- proposal reaches its mempool, unless it's node 0</span><span>
</span><span id="line-169"></span><span>                      </span><span id="local-6989586621679175910"><span class="annot"><span class="annottext">lostRace :: Bool
</span><a href="#local-6989586621679175910"><span class="hs-identifier hs-var hs-var">lostRace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175909"><span class="hs-identifier hs-var">leaderJoinSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-170"></span><span>                                 </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175907"><span class="hs-identifier hs-var">leader</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; CoreNodeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">CoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-171"></span><span>                  </span><span class="hs-keyword">in</span><span>
</span><span id="line-172"></span><span>                  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679175910"><span class="hs-identifier hs-var">lostRace</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-173"></span><span>                  </span><span class="hs-comment">-- votes can be valid immediately and at least one should</span><span>
</span><span id="line-174"></span><span>                  </span><span class="hs-comment">-- also be in this block</span><span>
</span><span id="line-175"></span><span>                  </span><span class="annot"><span class="annottext">ProposalState -&gt; SlotNo -&gt; [Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175921"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Set CoreNodeId -&gt; ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Voting"><span class="hs-identifier hs-var">Voting</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Outcome
</span><a href="#local-6989586621679175917"><span class="hs-identifier hs-var">o</span></a></span><span class="annot"><span class="annottext">Outcome -&gt; [Outcome] -&gt; [Outcome]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175916"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>              </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Voting"><span class="hs-identifier hs-type">Voting</span></a></span><span> </span><span id="local-6989586621679175902"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175902"><span class="hs-identifier hs-var">proposalSlot</span></a></span></span><span> </span><span id="local-6989586621679175901"><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175901"><span class="hs-identifier hs-var">votes</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-177"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679175900"><span class="annot"><span class="annottext">votesInTheNewBlock :: Set CoreNodeId
</span><a href="#local-6989586621679175900"><span class="hs-identifier hs-var hs-var">votesInTheNewBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>                          </span><span class="hs-comment">-- an exception to the rule: the proposal and c0's</span><span>
</span><span id="line-179"></span><span>                          </span><span class="hs-comment">-- own vote always has time to reach its mempool</span><span>
</span><span id="line-180"></span><span>                          </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175907"><span class="hs-identifier hs-var">leader</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; CoreNodeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175899"><span class="hs-identifier hs-var">c0</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; Set CoreNodeId -&gt; Set CoreNodeId
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175899"><span class="hs-identifier hs-var">c0</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId -&gt; Set CoreNodeId
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set CoreNodeId -&gt; Set CoreNodeId)
-&gt; Set CoreNodeId -&gt; Set CoreNodeId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-181"></span><span>                          </span><span class="hs-comment">-- if the leader is joining in this slot, then no</span><span>
</span><span id="line-182"></span><span>                          </span><span class="hs-comment">-- votes will reach its mempool before it forges:</span><span>
</span><span id="line-183"></span><span>                          </span><span class="hs-comment">-- other nodes' votes will be delayed via</span><span>
</span><span id="line-184"></span><span>                          </span><span class="hs-comment">-- communication and its own vote is not valid</span><span>
</span><span id="line-185"></span><span>                          </span><span class="hs-comment">-- because it will forge before its ledger/mempool</span><span>
</span><span id="line-186"></span><span>                          </span><span class="hs-comment">-- contains the proposal</span><span>
</span><span id="line-187"></span><span>                          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175909"><span class="hs-identifier hs-var">leaderJoinSlot</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-188"></span><span>                          </span><span class="hs-comment">-- only votes from nodes that joined prior to this</span><span>
</span><span id="line-189"></span><span>                          </span><span class="hs-comment">-- slot can reach the leader's mempool before it</span><span>
</span><span id="line-190"></span><span>                          </span><span class="hs-comment">-- forges</span><span>
</span><span id="line-191"></span><span>                          </span><span class="annot"><span class="annottext">Map CoreNodeId SlotNo -&gt; Set CoreNodeId
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">(Map CoreNodeId SlotNo -&gt; Set CoreNodeId)
-&gt; Map CoreNodeId SlotNo -&gt; Set CoreNodeId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Bool) -&gt; Map CoreNodeId SlotNo -&gt; Map CoreNodeId SlotNo
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map CoreNodeId SlotNo
</span><a href="#local-6989586621679175893"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-192"></span><span>                        </span><span class="hs-keyword">where</span><span>
</span><span id="line-193"></span><span>                          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">NodeJoinPlan</span></a></span><span> </span><span id="local-6989586621679175893"><span class="annot"><span class="annottext">Map CoreNodeId SlotNo
</span><a href="#local-6989586621679175893"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeJoinPlan
</span><a href="#local-6989586621679175959"><span class="hs-identifier hs-var">nodeJoinPlan</span></a></span><span>
</span><span id="line-194"></span><span>                          </span><span id="local-6989586621679175899"><span class="annot"><span class="annottext">c0 :: CoreNodeId
</span><a href="#local-6989586621679175899"><span class="hs-identifier hs-var hs-var">c0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">CoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>                      </span><span id="local-6989586621679175891"><span class="annot"><span class="annottext">votes' :: Set CoreNodeId
</span><a href="#local-6989586621679175891"><span class="hs-identifier hs-var hs-var">votes'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId -&gt; Set CoreNodeId -&gt; Set CoreNodeId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.union</span></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175900"><span class="hs-identifier hs-var">votesInTheNewBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175901"><span class="hs-identifier hs-var">votes</span></a></span><span>
</span><span id="line-197"></span><span>                      </span><span id="local-6989586621679175889"><span class="annot"><span class="annottext">confirmed :: Bool
</span><a href="#local-6989586621679175889"><span class="hs-identifier hs-var hs-var">confirmed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CoreNodeId -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175891"><span class="hs-identifier hs-var">votes'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175936"><span class="hs-identifier hs-var">quorum</span></a></span><span>
</span><span id="line-198"></span><span>                      </span><span id="local-6989586621679175887"><span class="annot"><span class="annottext">expired :: Bool
</span><a href="#local-6989586621679175887"><span class="hs-identifier hs-var hs-var">expired</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175902"><span class="hs-identifier hs-var">proposalSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175930"><span class="hs-identifier hs-var">ttl</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-199"></span><span>                  </span><span class="hs-keyword">in</span><span>
</span><span id="line-200"></span><span>                  </span><span class="hs-keyword">if</span><span>  </span><span class="hs-comment">-- TODO cardano-ledger-byron checks for quorum before it checks</span><span>
</span><span id="line-201"></span><span>                      </span><span class="hs-comment">-- for expiry, so we do mimick that here. But is that</span><span>
</span><span id="line-202"></span><span>                      </span><span class="hs-comment">-- correct?</span><span>
</span><span id="line-203"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679175889"><span class="hs-identifier hs-var">confirmed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">(ProposalState -&gt; ProposalState) -&gt; ProposalState -&gt; ProposalState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Set CoreNodeId -&gt; ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Endorsing"><span class="hs-identifier hs-var">Endorsing</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span>
</span><span id="line-204"></span><span>                      </span><span class="hs-comment">-- c0 will re-propose the same proposal again at the next</span><span>
</span><span id="line-205"></span><span>                      </span><span class="hs-comment">-- opportunity</span><span>
</span><span id="line-206"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679175887"><span class="hs-identifier hs-var">expired</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">(ProposalState -&gt; ProposalState) -&gt; ProposalState -&gt; ProposalState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Proposing"><span class="hs-identifier hs-var">Proposing</span></a></span><span>
</span><span id="line-207"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">(ProposalState -&gt; ProposalState) -&gt; ProposalState -&gt; ProposalState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Set CoreNodeId -&gt; ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Voting"><span class="hs-identifier hs-var">Voting</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175902"><span class="hs-identifier hs-var">proposalSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175891"><span class="hs-identifier hs-var">votes'</span></a></span><span>
</span><span id="line-208"></span><span>              </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Endorsing"><span class="hs-identifier hs-type">Endorsing</span></a></span><span> </span><span id="local-6989586621679175885"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175885"><span class="hs-identifier hs-var">finalVoteSlot</span></a></span></span><span> </span><span id="local-6989586621679175884"><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175884"><span class="hs-identifier hs-var">ends</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>                  </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">(ProposalState -&gt; ProposalState) -&gt; ProposalState -&gt; ProposalState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-210"></span><span>                  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175885"><span class="hs-identifier hs-var">finalVoteSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175944"><span class="hs-identifier hs-var">twoK</span></a></span><span>
</span><span id="line-211"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span>  </span><span class="hs-comment">-- ignore endorsements until final vote is stable</span><span>
</span><span id="line-212"></span><span>                  </span><span class="hs-keyword">else</span><span>
</span><span id="line-213"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679175883"><span class="annot"><span class="annottext">ends' :: Set CoreNodeId
</span><a href="#local-6989586621679175883"><span class="hs-identifier hs-var hs-var">ends'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; Set CoreNodeId -&gt; Set CoreNodeId
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PBftParams -&gt; SlotNo -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">Ref.mkLeaderOf</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175962"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175884"><span class="hs-identifier hs-var">ends</span></a></span><span>
</span><span id="line-214"></span><span>                    </span><span class="hs-keyword">in</span><span>
</span><span id="line-215"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CoreNodeId -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175884"><span class="hs-identifier hs-var">ends</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679175936"><span class="hs-identifier hs-var">quorum</span></a></span><span>
</span><span id="line-216"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Set CoreNodeId -&gt; ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Endorsing"><span class="hs-identifier hs-var">Endorsing</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175885"><span class="hs-identifier hs-var">finalVoteSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Set CoreNodeId
</span><a href="#local-6989586621679175883"><span class="hs-identifier hs-var">ends'</span></a></span><span>
</span><span id="line-217"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; ProposalState
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Adopting"><span class="hs-identifier hs-var">Adopting</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span>   </span><span class="hs-comment">-- enough endorsements</span><span>
</span><span id="line-218"></span><span>              </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Adopting"><span class="hs-identifier hs-type">Adopting</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175919"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-220"></span><span>          </span><span id="local-6989586621679175907"><span class="annot"><span class="annottext">leader :: CoreNodeId
</span><a href="#local-6989586621679175907"><span class="hs-identifier hs-var hs-var">leader</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftParams -&gt; SlotNo -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">Ref.mkLeaderOf</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175962"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-221"></span><span>          </span><span id="local-6989586621679175909"><span class="annot"><span class="annottext">leaderJoinSlot :: SlotNo
</span><a href="#local-6989586621679175909"><span class="hs-identifier hs-var hs-var">leaderJoinSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(?callStack::CallStack) =&gt; NodeJoinPlan -&gt; CoreNodeId -&gt; SlotNo
NodeJoinPlan -&gt; CoreNodeId -&gt; SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">coreNodeIdJoinSlot</span></a></span><span> </span><span class="annot"><span class="annottext">NodeJoinPlan
</span><a href="#local-6989586621679175959"><span class="hs-identifier hs-var">nodeJoinPlan</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175907"><span class="hs-identifier hs-var">leader</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>          </span><span id="local-6989586621679175914"><span class="annot"><span class="annottext">continueWith :: ProposalState -&gt; ProposalState
</span><a href="#local-6989586621679175914"><span class="hs-identifier hs-var hs-var">continueWith</span></a></span></span><span> </span><span id="local-6989586621679175879"><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175879"><span class="hs-identifier hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProposalState -&gt; SlotNo -&gt; [Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175921"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ProposalState
</span><a href="#local-6989586621679175879"><span class="hs-identifier hs-var">st'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175918"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175916"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621679175955"><span class="annot"><span class="annottext">pvuLabel :: ProtocolVersionUpdateLabel
</span><a href="#local-6989586621679175955"><span class="hs-identifier hs-var hs-var">pvuLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolVersionUpdateLabel :: Bool -&gt; Maybe Bool -&gt; ProtocolVersionUpdateLabel
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProtocolVersionUpdateLabel"><span class="hs-identifier hs-type">ProtocolVersionUpdateLabel</span></a></span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pvuObserved :: Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#pvuObserved"><span class="hs-identifier hs-var">pvuObserved</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-227"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProtocolVersion -&gt; ProtocolVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html#theProposedProtocolVersion"><span class="hs-identifier hs-var">theProposedProtocolVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ProtocolVersion -&gt; Bool) -&gt; ProtocolVersion -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-228"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; ProtocolVersion
</span><span class="hs-identifier hs-var hs-var">Update.adoptedProtocolVersion</span></span><span> </span><span class="annot"><span class="annottext">(State -&gt; ProtocolVersion) -&gt; State -&gt; ProtocolVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-229"></span><span>            </span><span class="annot"><span class="annottext">ChainValidationState -&gt; State
</span><span class="hs-identifier hs-var hs-var">Block.cvsUpdateState</span></span><span> </span><span class="annot"><span class="annottext">(ChainValidationState -&gt; State) -&gt; ChainValidationState -&gt; State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-230"></span><span>            </span><span class="hs-comment">-- tick the chain over into the slot after the final simulated slot</span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="annottext">Config
-&gt; SlotNumber -&gt; ChainValidationState -&gt; ChainValidationState
</span><span class="hs-identifier hs-var">ByronAPI.applyChainTick</span></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175960"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNumber
</span><a href="#local-6989586621679175948"><span class="hs-identifier hs-var">sentinel</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainValidationState -&gt; ChainValidationState)
-&gt; ChainValidationState -&gt; ChainValidationState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-232"></span><span>            </span><span class="annot"><span class="annottext">LedgerState ByronBlock -&gt; ChainValidationState
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-var hs-var">Byron.byronLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679175956"><span class="hs-identifier hs-var">ldgr</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pvuRequired :: Maybe Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#pvuRequired"><span class="hs-identifier hs-var">pvuRequired</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621679175957"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-234"></span><span>            </span><span class="hs-comment">-- 'Ref.Forked' means there's only 1-block chains, and that's not enough</span><span>
</span><span id="line-235"></span><span>            </span><span class="hs-comment">-- for a proposal to succeed</span><span>
</span><span id="line-236"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Forked</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-237"></span><span>            </span><span class="hs-comment">-- we wouldn't necessarily be able to anticipate when the last</span><span>
</span><span id="line-238"></span><span>            </span><span class="hs-comment">-- endorsement happens, so give up</span><span>
</span><span id="line-239"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Nondeterministic</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-240"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Outcomes</span></a></span><span> </span><span id="local-6989586621679175869"><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175869"><span class="hs-identifier hs-var">outcomes</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>                </span><span class="annot"><span class="annottext">PBftParams -&gt; NodeTopology -&gt; Maybe ()
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#checkTopo"><span class="hs-identifier hs-var">checkTopo</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175962"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679175958"><span class="hs-identifier hs-var">topology</span></a></span><span>
</span><span id="line-242"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe Bool) -&gt; Bool -&gt; Maybe Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175923"><span class="hs-identifier hs-var">finalState</span></a></span><span> </span><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175869"><span class="hs-identifier hs-var">outcomes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-243"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Proposing"><span class="hs-identifier hs-type">Proposing</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-244"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Voting"><span class="hs-identifier hs-type">Voting</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-245"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Endorsing"><span class="hs-identifier hs-type">Endorsing</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-246"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Adopting"><span class="hs-identifier hs-type">Adopting</span></a></span><span> </span><span id="local-6989586621679175867"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175867"><span class="hs-identifier hs-var">finalEndorsementSlot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>                      </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
</span><a href="#local-6989586621679175928"><span class="hs-identifier hs-var">ebbSlotAfter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175867"><span class="hs-identifier hs-var">finalEndorsementSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175944"><span class="hs-identifier hs-var">twoK</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679175865"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-248"></span><span>                    </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>                      </span><span id="local-6989586621679175865"><span class="annot"><span class="annottext">s :: SlotNo
</span><a href="#local-6989586621679175865"><span class="hs-identifier hs-var hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNumber -&gt; SlotNo
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">SlotNumber
</span><a href="#local-6989586621679175948"><span class="hs-identifier hs-var">sentinel</span></a></span><span>
</span><span id="line-250"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621679175954"><span class="annot"><span class="annottext">svuLabel :: SoftwareVersionUpdateLabel
</span><a href="#local-6989586621679175954"><span class="hs-identifier hs-var hs-var">svuLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SoftwareVersionUpdateLabel :: Bool -&gt; Maybe Bool -&gt; SoftwareVersionUpdateLabel
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#SoftwareVersionUpdateLabel"><span class="hs-identifier hs-type">SoftwareVersionUpdateLabel</span></a></span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">svuObserved :: Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#svuObserved"><span class="hs-identifier hs-var">svuObserved</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool -&gt; Bool
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Bool -&gt; Bool) -&gt; Maybe Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679175864"><span class="annot"><span class="annottext">nm :: ApplicationName
</span><a href="#local-6989586621679175864"><span class="hs-identifier hs-var hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SoftwareVersion -&gt; ApplicationName
</span><span class="hs-identifier hs-var hs-var">Update.svAppName</span></span><span> </span><span class="annot"><span class="annottext">SoftwareVersion
</span><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html#theProposedSoftwareVersion"><span class="hs-identifier hs-var">theProposedSoftwareVersion</span></a></span><span>
</span><span id="line-255"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Registration.ApplicationVersion</span></span><span> </span><span id="local-6989586621679175860"><span class="annot"><span class="annottext">NumSoftwareVersion
</span><a href="#local-6989586621679175860"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span id="local-6989586621679175859"><span class="annot"><span class="annottext">SlotNumber
</span><a href="#local-6989586621679175859"><span class="hs-identifier hs-var">_slot</span></a></span></span><span> </span><span id="local-6989586621679175858"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621679175858"><span class="hs-identifier hs-var">_metadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ApplicationName
-&gt; Map ApplicationName ApplicationVersion
-&gt; Maybe ApplicationVersion
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">ApplicationName
</span><a href="#local-6989586621679175864"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ApplicationName ApplicationVersion
 -&gt; Maybe ApplicationVersion)
-&gt; Map ApplicationName ApplicationVersion
-&gt; Maybe ApplicationVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-256"></span><span>              </span><span class="annot"><span class="annottext">State -&gt; Map ApplicationName ApplicationVersion
</span><span class="hs-identifier hs-var hs-var">Update.appVersions</span></span><span> </span><span class="annot"><span class="annottext">(State -&gt; Map ApplicationName ApplicationVersion)
-&gt; State -&gt; Map ApplicationName ApplicationVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-257"></span><span>              </span><span class="annot"><span class="annottext">ChainValidationState -&gt; State
</span><span class="hs-identifier hs-var hs-var">Block.cvsUpdateState</span></span><span> </span><span class="annot"><span class="annottext">(ChainValidationState -&gt; State) -&gt; ChainValidationState -&gt; State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-258"></span><span>              </span><span class="hs-comment">-- unlike for protocol version updates, there is no need to tick</span><span>
</span><span id="line-259"></span><span>              </span><span class="hs-comment">-- since the passage of time isn't a prerequisite</span><span>
</span><span id="line-260"></span><span>              </span><span class="annot"><span class="annottext">LedgerState ByronBlock -&gt; ChainValidationState
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-var hs-var">Byron.byronLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679175956"><span class="hs-identifier hs-var">ldgr</span></a></span><span>
</span><span id="line-261"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe Bool) -&gt; Bool -&gt; Maybe Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NumSoftwareVersion
</span><a href="#local-6989586621679175860"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">NumSoftwareVersion -&gt; NumSoftwareVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SoftwareVersion -&gt; NumSoftwareVersion
</span><span class="hs-identifier hs-var hs-var">Update.svNumber</span></span><span> </span><span class="annot"><span class="annottext">SoftwareVersion
</span><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html#theProposedSoftwareVersion"><span class="hs-identifier hs-var">theProposedSoftwareVersion</span></a></span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">svuRequired :: Maybe Bool
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#svuRequired"><span class="hs-identifier hs-var">svuRequired</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621679175957"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-comment">-- 'Ref.Forked' means all blocks except perhaps the first were</span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-comment">-- forged in the slot in which the forging node joined, which means</span><span>
</span><span id="line-265"></span><span>            </span><span class="hs-comment">-- nodes other than c0 never forged after receiving the proposal. A</span><span>
</span><span id="line-266"></span><span>            </span><span class="hs-comment">-- block forged by node c0 will have proposed and might have</span><span>
</span><span id="line-267"></span><span>            </span><span class="hs-comment">-- confirmed it (depending on quorum), but the other nodes will not</span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-comment">-- have. This is very much a corner case, so we ignore it.</span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Forked</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-270"></span><span>            </span><span class="hs-comment">-- We wouldn't necessarily be able to anticipate if the proposal is</span><span>
</span><span id="line-271"></span><span>            </span><span class="hs-comment">-- confirmed or even in all of the final chains, so we ignore it.</span><span>
</span><span id="line-272"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Nondeterministic</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">Ref.Outcomes</span></a></span><span> </span><span id="local-6989586621679175854"><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175854"><span class="hs-identifier hs-var">outcomes</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>                </span><span class="annot"><span class="annottext">PBftParams -&gt; NodeTopology -&gt; Maybe ()
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#checkTopo"><span class="hs-identifier hs-var">checkTopo</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175962"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679175958"><span class="hs-identifier hs-var">topology</span></a></span><span>
</span><span id="line-275"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe Bool) -&gt; Bool -&gt; Maybe Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Outcome] -&gt; ProposalState
</span><a href="#local-6989586621679175923"><span class="hs-identifier hs-var">finalState</span></a></span><span> </span><span class="annot"><span class="annottext">[Outcome]
</span><a href="#local-6989586621679175854"><span class="hs-identifier hs-var">outcomes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Proposing"><span class="hs-identifier hs-type">Proposing</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-277"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Voting"><span class="hs-identifier hs-type">Voting</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-278"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Endorsing"><span class="hs-identifier hs-type">Endorsing</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-279"></span><span>                  </span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Adopting"><span class="hs-identifier hs-type">Adopting</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- if the topology is not mesh, then some assumptions in 'finalState' about</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- races maybe be wrong</span><span>
</span><span id="line-284"></span><span class="hs-comment">--</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- In particular, if the proposal is already on the chain, and the leader of</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- the next slot, call it node L, is joining and is only directly connected to</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- other nodes that are also joining, then those other node's votes will not</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- reach L's mempool before it forges in the next slot. In fact, those votes</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- will arrive to node L via TxSub during the current slot but /before/ the</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- block containing the proposal does, so node L's mempool will reject the</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- votes as invalid. The votes are not resent (at least not before node L</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- leads).</span><span>
</span><span id="line-293"></span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#checkTopo"><span class="hs-identifier hs-type">checkTopo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">PBftParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">NodeTopology</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span id="checkTopo"><span class="annot"><span class="annottext">checkTopo :: PBftParams -&gt; NodeTopology -&gt; Maybe ()
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#checkTopo"><span class="hs-identifier hs-var hs-var">checkTopo</span></a></span></span><span> </span><span id="local-6989586621679175853"><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175853"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679175852"><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679175852"><span class="hs-identifier hs-var">topology</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">PBftParams</span></a></span><span class="hs-special">{</span><span id="local-6989586621679175851"><span class="annot"><span class="annottext">NumCoreNodes
pbftNumNodes :: NumCoreNodes
pbftNumNodes :: PBftParams -&gt; NumCoreNodes
</span><a href="#local-6989586621679175851"><span class="hs-identifier hs-var hs-var">pbftNumNodes</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175853"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679175852"><span class="hs-identifier hs-var">topology</span></a></span><span> </span><span class="annot"><span class="annottext">NodeTopology -&gt; NodeTopology -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">NumCoreNodes -&gt; NodeTopology
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">meshNodeTopology</span></a></span><span> </span><span class="annot"><span class="annottext">NumCoreNodes
</span><a href="#local-6989586621679175851"><span class="hs-identifier hs-var">pbftNumNodes</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | The state of a proposal within a linear timeline</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span class="hs-keyword">data</span><span> </span><span id="ProposalState"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#ProposalState"><span class="hs-identifier hs-var">ProposalState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>    </span><span id="Proposing"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Proposing"><span class="hs-identifier hs-var">Proposing</span></a></span></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">-- ^ submitting the proposal (possibly not for the first time, if it has</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">-- previously expired)</span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Voting"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Voting"><span class="hs-identifier hs-var">Voting</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- ^ accumulating sufficient votes</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- The slot is when the proposal was submitted; it might expire during</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- voting. The set is who has voted.</span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Endorsing"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Endorsing"><span class="hs-identifier hs-var">Endorsing</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- ^ accumulating sufficient endorsements</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">-- The slot is when the first sufficient vote was submitted. The set is the</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- endorsements seen so far.</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Adopting"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#Adopting"><span class="hs-identifier hs-var">Adopting</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-comment">-- ^ waiting for epoch transition</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- The slot is when the first sufficient endorsement was submitted.</span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679175844"><span id="local-6989586621679175846"><span id="local-6989586621679175848"><span class="annot"><span class="annottext">Int -&gt; ProposalState -&gt; ShowS
[ProposalState] -&gt; ShowS
ProposalState -&gt; String
(Int -&gt; ProposalState -&gt; ShowS)
-&gt; (ProposalState -&gt; String)
-&gt; ([ProposalState] -&gt; ShowS)
-&gt; Show ProposalState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ProposalState] -&gt; ShowS
$cshowList :: [ProposalState] -&gt; ShowS
show :: ProposalState -&gt; String
$cshow :: ProposalState -&gt; String
showsPrec :: Int -&gt; ProposalState -&gt; ShowS
$cshowsPrec :: Int -&gt; ProposalState -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  ProtocolVersion update proposals
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">-- | The protocol info for a node as well as some initial transactions</span><span>
</span><span id="line-325"></span><span class="hs-comment">--</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- The transactions implement a smoke test for the hard-fork from Byron to</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- Shelley. See PR #1741 for details on how that hard-fork will work. The key</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- fact is that last thing the nodes will ever do while running the Byron</span><span>
</span><span id="line-329"></span><span class="hs-comment">-- protocol is adopt a specific (but as of yet to-be-determined) protocol</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- version. So this smoke test ensures that the nodes can in fact adopt a new</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- protocol version.</span><span>
</span><span id="line-332"></span><span class="hs-comment">--</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- Adopting a new protocol version requires four kinds of event in Byron.</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- Again, see PR #1741 for more details.</span><span>
</span><span id="line-335"></span><span class="hs-comment">--</span><span>
</span><span id="line-336"></span><span class="hs-comment">--  * Proposal transaction. A protocol parameter update proposal transaction</span><span>
</span><span id="line-337"></span><span class="hs-comment">--    makes it onto the chain (it doesn't have to actually change any</span><span>
</span><span id="line-338"></span><span class="hs-comment">--    parameters, just increase the protocol version). Proposals are</span><span>
</span><span id="line-339"></span><span class="hs-comment">--    'MempoolPayload.MempoolUpdateProposal' transactions; one is included in</span><span>
</span><span id="line-340"></span><span class="hs-comment">--    the return value of this function. In the smoke test, we immediately and</span><span>
</span><span id="line-341"></span><span class="hs-comment">--    repeatedly throughout the test add the proposal to @CoreNodeId 0@'s</span><span>
</span><span id="line-342"></span><span class="hs-comment">--    mempool; this seems realistic.</span><span>
</span><span id="line-343"></span><span class="hs-comment">--</span><span>
</span><span id="line-344"></span><span class="hs-comment">--  * Vote transactions. A sufficient number of nodes (@floor (0.6 *</span><span>
</span><span id="line-345"></span><span class="hs-comment">--    'pbftNumNodes')@ as of this writing) must vote for the proposal. Votes</span><span>
</span><span id="line-346"></span><span class="hs-comment">--    are 'MempoolPayload.MempoolUpdateVote' transactions; one per node is</span><span>
</span><span id="line-347"></span><span class="hs-comment">--    included in the return value of this function. In the smoke test, we</span><span>
</span><span id="line-348"></span><span class="hs-comment">--    immediately and repeatedly throughout the test add each node's vote to</span><span>
</span><span id="line-349"></span><span class="hs-comment">--    its own mempool; this seems realistic.</span><span>
</span><span id="line-350"></span><span class="hs-comment">--</span><span>
</span><span id="line-351"></span><span class="hs-comment">--  * Endorsement header field. After enough votes are 2k slots old, a</span><span>
</span><span id="line-352"></span><span class="hs-comment">--    sufficient number of nodes (@floor (0.6 * 'pbftNumNodes')@ as of this</span><span>
</span><span id="line-353"></span><span class="hs-comment">--    writing) must then endorse the proposal. Endorsements are not</span><span>
</span><span id="line-354"></span><span class="hs-comment">--    transactions. Instead, every Byron header includes a field that specifies</span><span>
</span><span id="line-355"></span><span class="hs-comment">--    a protocol version to endorse. At a particular stage of a corresponding</span><span>
</span><span id="line-356"></span><span class="hs-comment">--    proposal's lifetime, that field constitutes an endorsement. At all other</span><span>
</span><span id="line-357"></span><span class="hs-comment">--    times, it is essentially ignored. In the smoke test, we take advantage of</span><span>
</span><span id="line-358"></span><span class="hs-comment">--    that to avoid having to restart our nodes: the nodes' initial</span><span>
</span><span id="line-359"></span><span class="hs-comment">--    configuration causes them to immediately and always attempt to endorse</span><span>
</span><span id="line-360"></span><span class="hs-comment">--    the proposed protocol version; this seems only slightly unrealistic.</span><span>
</span><span id="line-361"></span><span class="hs-comment">--</span><span>
</span><span id="line-362"></span><span class="hs-comment">--  * Epoch transition. After enough endorsements are 2k slots old, the</span><span>
</span><span id="line-363"></span><span class="hs-comment">--    protocol version will be adopted at the next epoch transition, unless</span><span>
</span><span id="line-364"></span><span class="hs-comment">--    something else prevents it. In the smoke test, we check the validation</span><span>
</span><span id="line-365"></span><span class="hs-comment">--    state of the final chains for the new protocol version when we detect no</span><span>
</span><span id="line-366"></span><span class="hs-comment">--    mitigating circumstances, such as the test not even being scheduled to</span><span>
</span><span id="line-367"></span><span class="hs-comment">--    reach the second epoch.</span><span>
</span><span id="line-368"></span><span class="hs-comment">--</span><span>
</span><span id="line-369"></span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkProtocolByronAndHardForkTxs"><span class="hs-identifier hs-type">mkProtocolByronAndHardForkTxs</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679175843"><span class="annot"><a href="#local-6989586621679175843"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679175843"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">PBftParams</span></a></span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Genesis.Config</span></span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Genesis.GeneratedSecrets</span></span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Update.ProtocolVersion</span></span><span>
</span><span id="line-376"></span><span>     </span><span class="hs-comment">-- ^ the protocol version that triggers the hard fork</span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679175843"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span>
</span><span id="line-378"></span><span id="mkProtocolByronAndHardForkTxs"><span class="annot"><span class="annottext">mkProtocolByronAndHardForkTxs :: PBftParams
-&gt; CoreNodeId
-&gt; Config
-&gt; GeneratedSecrets
-&gt; ProtocolVersion
-&gt; TestNodeInitialization m ByronBlock
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkProtocolByronAndHardForkTxs"><span class="hs-identifier hs-var hs-var">mkProtocolByronAndHardForkTxs</span></a></span></span><span>
</span><span id="line-379"></span><span>  </span><span id="local-6989586621679175842"><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175842"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679175841"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175841"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679175840"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175840"><span class="hs-identifier hs-var">genesisConfig</span></a></span></span><span> </span><span id="local-6989586621679175839"><span class="annot"><span class="annottext">GeneratedSecrets
</span><a href="#local-6989586621679175839"><span class="hs-identifier hs-var">genesisSecrets</span></a></span></span><span> </span><span id="local-6989586621679175838"><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679175838"><span class="hs-identifier hs-var">propPV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><span class="annottext">TestNodeInitialization :: forall (m :: * -&gt; *) blk.
[GenTx blk] -&gt; ProtocolInfo m blk -&gt; TestNodeInitialization m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tniCrucialTxs :: [GenTx ByronBlock]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">tniCrucialTxs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[GenTx ByronBlock]
</span><a href="#local-6989586621679175835"><span class="hs-identifier hs-var">proposals</span></a></span><span> </span><span class="annot"><span class="annottext">[GenTx ByronBlock] -&gt; [GenTx ByronBlock] -&gt; [GenTx ByronBlock]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[GenTx ByronBlock]
</span><a href="#local-6989586621679175834"><span class="hs-identifier hs-var">votes</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tniProtocolInfo :: ProtocolInfo m ByronBlock
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-test-0.1.0.0/noopt/doc/html/ouroboros-consensus-test/src"><span class="hs-identifier hs-var">tniProtocolInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m ByronBlock
</span><a href="#local-6989586621679175832"><span class="hs-identifier hs-var">pInfo</span></a></span><span>
</span><span id="line-383"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679175830"><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
pInfoConfig :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
pInfoConfig :: TopLevelConfig ByronBlock
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">pInfoConfig</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m ByronBlock
</span><a href="#local-6989586621679175832"><span class="hs-identifier hs-var">pInfo</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621679175828"><span class="annot"><span class="annottext">bcfg :: BlockConfig ByronBlock
</span><a href="#local-6989586621679175828"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock -&gt; BlockConfig ByronBlock
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
</span><a href="#local-6989586621679175830"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span>    </span><span class="annot"><a href="#local-6989586621679175832"><span class="hs-identifier hs-type">pInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679175843"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><a href="#local-6989586621679175826"><span class="hs-identifier hs-type">opKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Crypto.SigningKey</span></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679175832"><span class="annot"><span class="annottext">ProtocolInfo m ByronBlock
</span><a href="#local-6989586621679175832"><span class="hs-identifier hs-var">pInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">Crypto.SignKeyByronDSIGN</span></a></span><span> </span><span id="local-6989586621679175826"><span class="annot"><a href="#local-6989586621679175826"><span class="hs-identifier hs-var">opKey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">PBftParams
-&gt; CoreNodeId
-&gt; Config
-&gt; GeneratedSecrets
-&gt; (ProtocolInfo m ByronBlock, SignKeyDSIGN ByronDSIGN)
forall (m :: * -&gt; *).
(Monad m, ?callStack::CallStack) =&gt;
PBftParams
-&gt; CoreNodeId
-&gt; Config
-&gt; GeneratedSecrets
-&gt; (ProtocolInfo m ByronBlock, SignKeyDSIGN ByronDSIGN)
</span><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html#mkProtocolByron"><span class="hs-identifier hs-var">mkProtocolByron</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175842"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175841"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175840"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span> </span><span class="annot"><span class="annottext">GeneratedSecrets
</span><a href="#local-6989586621679175839"><span class="hs-identifier hs-var">genesisSecrets</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><a href="#local-6989586621679175835"><span class="hs-identifier hs-type">proposals</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Byron.GenTx</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621679175835"><span class="annot"><span class="annottext">proposals :: [GenTx ByronBlock]
</span><a href="#local-6989586621679175835"><span class="hs-identifier hs-var hs-var">proposals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679175841"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; CoreNodeId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">CoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenTx ByronBlock -&gt; [GenTx ByronBlock] -&gt; [GenTx ByronBlock]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(GenTx ByronBlock -&gt; [GenTx ByronBlock])
-&gt; GenTx ByronBlock -&gt; [GenTx ByronBlock]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-397"></span><span>        </span><span class="annot"><span class="annottext">AMempoolPayload ByteString -&gt; GenTx ByronBlock
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-var">Byron.fromMempoolPayload</span></a></span><span> </span><span class="annot"><span class="annottext">(AMempoolPayload ByteString -&gt; GenTx ByronBlock)
-&gt; AMempoolPayload ByteString -&gt; GenTx ByronBlock
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-398"></span><span>        </span><span class="annot"><span class="annottext">AProposal ByteString -&gt; AMempoolPayload ByteString
forall a. AProposal a -&gt; AMempoolPayload a
</span><span class="hs-identifier hs-var">MempoolPayload.MempoolUpdateProposal</span></span><span> </span><span class="annot"><span class="annottext">AProposal ByteString
</span><a href="#local-6989586621679175821"><span class="hs-identifier hs-var">proposal</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><a href="#local-6989586621679175834"><span class="hs-identifier hs-type">votes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Byron.GenTx</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621679175834"><span class="annot"><span class="annottext">votes :: [GenTx ByronBlock]
</span><a href="#local-6989586621679175834"><span class="hs-identifier hs-var hs-var">votes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenTx ByronBlock -&gt; [GenTx ByronBlock] -&gt; [GenTx ByronBlock]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(GenTx ByronBlock -&gt; [GenTx ByronBlock])
-&gt; GenTx ByronBlock -&gt; [GenTx ByronBlock]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">AMempoolPayload ByteString -&gt; GenTx ByronBlock
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-var">Byron.fromMempoolPayload</span></a></span><span> </span><span class="annot"><span class="annottext">(AMempoolPayload ByteString -&gt; GenTx ByronBlock)
-&gt; AMempoolPayload ByteString -&gt; GenTx ByronBlock
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-404"></span><span>        </span><span class="annot"><span class="annottext">AVote ByteString -&gt; AMempoolPayload ByteString
forall a. AVote a -&gt; AMempoolPayload a
</span><span class="hs-identifier hs-var">MempoolPayload.MempoolUpdateVote</span></span><span> </span><span class="annot"><span class="annottext">AVote ByteString
</span><a href="#local-6989586621679175819"><span class="hs-identifier hs-var">vote</span></a></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><a href="#local-6989586621679175819"><span class="hs-identifier hs-type">vote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AVote</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-407"></span><span>    </span><span id="local-6989586621679175819"><span class="annot"><span class="annottext">vote :: AVote ByteString
</span><a href="#local-6989586621679175819"><span class="hs-identifier hs-var hs-var">vote</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="annottext">AVote () -&gt; AVote ByteString
forall (f :: * -&gt; *).
(FromCBOR (f ByteSpan), ToCBOR (f ()), Functor f) =&gt;
f () -&gt; f ByteString
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#loopbackAnnotations"><span class="hs-identifier hs-var">loopbackAnnotations</span></a></span><span> </span><span class="annot"><span class="annottext">(AVote () -&gt; AVote ByteString) -&gt; AVote () -&gt; AVote ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-409"></span><span>        </span><span class="hs-comment">-- signed by delegate SK</span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="annottext">ProtocolMagicId -&gt; UpId -&gt; Bool -&gt; SafeSigner -&gt; AVote ()
</span><span class="hs-identifier hs-var">Vote.signVote</span></span><span>
</span><span id="line-411"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig ByronBlock -&gt; ProtocolMagicId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-var">Byron.byronProtocolMagicId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig ByronBlock
</span><a href="#local-6989586621679175828"><span class="hs-identifier hs-var">bcfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AProposal ByteString -&gt; UpId
</span><span class="hs-identifier hs-var">Update.recoverUpId</span></span><span> </span><span class="annot"><span class="annottext">AProposal ByteString
</span><a href="#local-6989586621679175821"><span class="hs-identifier hs-var">proposal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>   </span><span class="hs-comment">-- the serialization hardwires this value anyway</span><span>
</span><span id="line-414"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SigningKey -&gt; SafeSigner
</span><span class="hs-identifier hs-var">Crypto.noPassSafeSigner</span></span><span> </span><span class="annot"><span class="annottext">SigningKey
</span><a href="#local-6989586621679175826"><span class="hs-identifier hs-var">opKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><a href="#local-6989586621679175821"><span class="hs-identifier hs-type">proposal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AProposal</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-417"></span><span>    </span><span id="local-6989586621679175821"><span class="annot"><span class="annottext">proposal :: AProposal ByteString
</span><a href="#local-6989586621679175821"><span class="hs-identifier hs-var hs-var">proposal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><span class="annottext">AProposal () -&gt; AProposal ByteString
forall (f :: * -&gt; *).
(FromCBOR (f ByteSpan), ToCBOR (f ()), Functor f) =&gt;
f () -&gt; f ByteString
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#loopbackAnnotations"><span class="hs-identifier hs-var">loopbackAnnotations</span></a></span><span> </span><span class="annot"><span class="annottext">(AProposal () -&gt; AProposal ByteString)
-&gt; AProposal () -&gt; AProposal ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-419"></span><span>        </span><span class="annot"><span class="annottext">(?callStack::CallStack) =&gt;
PBftParams
-&gt; Config -&gt; GeneratedSecrets -&gt; ProtocolVersion -&gt; AProposal ()
PBftParams
-&gt; Config -&gt; GeneratedSecrets -&gt; ProtocolVersion -&gt; AProposal ()
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkHardForkProposal"><span class="hs-identifier hs-var">mkHardForkProposal</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175842"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175840"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span> </span><span class="annot"><span class="annottext">GeneratedSecrets
</span><a href="#local-6989586621679175839"><span class="hs-identifier hs-var">genesisSecrets</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679175838"><span class="hs-identifier hs-var">propPV</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="hs-comment">-- | A protocol parameter update proposal that doesn't actually change any</span><span>
</span><span id="line-422"></span><span class="hs-comment">-- parameter value but does propose 'theProposedProtocolVersion'</span><span>
</span><span id="line-423"></span><span class="hs-comment">--</span><span>
</span><span id="line-424"></span><span class="hs-comment">-- Without loss of generality, the proposal is signed by @'CoreNodeId' 0@.</span><span>
</span><span id="line-425"></span><span class="hs-comment">--</span><span>
</span><span id="line-426"></span><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkHardForkProposal"><span class="hs-identifier hs-type">mkHardForkProposal</span></a></span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">PBftParams</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Genesis.Config</span></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Genesis.GeneratedSecrets</span></span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Update.ProtocolVersion</span></span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AProposal</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span id="mkHardForkProposal"><span class="annot"><span class="annottext">mkHardForkProposal :: PBftParams
-&gt; Config -&gt; GeneratedSecrets -&gt; ProtocolVersion -&gt; AProposal ()
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#mkHardForkProposal"><span class="hs-identifier hs-var hs-var">mkHardForkProposal</span></a></span></span><span> </span><span id="local-6989586621679175812"><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175812"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679175811"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175811"><span class="hs-identifier hs-var">genesisConfig</span></a></span></span><span> </span><span id="local-6989586621679175810"><span class="annot"><span class="annottext">GeneratedSecrets
</span><a href="#local-6989586621679175810"><span class="hs-identifier hs-var">genesisSecrets</span></a></span></span><span> </span><span id="local-6989586621679175809"><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679175809"><span class="hs-identifier hs-var">propPV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-comment">-- signed by delegate SK</span><span>
</span><span id="line-435"></span><span>    </span><span class="annot"><span class="annottext">ProtocolMagicId -&gt; ProposalBody -&gt; SafeSigner -&gt; AProposal ()
</span><span class="hs-identifier hs-var">Proposal.signProposal</span></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig ByronBlock -&gt; ProtocolMagicId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-var">Byron.byronProtocolMagicId</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig ByronBlock
</span><a href="#local-6989586621679175807"><span class="hs-identifier hs-var">bcfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>      </span><span class="annot"><span class="annottext">ProposalBody
</span><a href="#local-6989586621679175806"><span class="hs-identifier hs-var">propBody</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SigningKey -&gt; SafeSigner
</span><span class="hs-identifier hs-var">Crypto.noPassSafeSigner</span></span><span> </span><span class="annot"><span class="annottext">SigningKey
</span><a href="#local-6989586621679175805"><span class="hs-identifier hs-var">opKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><a href="#local-6989586621679175804"><span class="hs-identifier hs-type">pInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><a href="#local-6989586621679175805"><span class="hs-identifier hs-type">opKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Crypto.SigningKey</span></span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679175804"><span class="annot"><span class="annottext">ProtocolInfo Identity ByronBlock
</span><a href="#local-6989586621679175804"><span class="hs-identifier hs-var">pInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-byron-0.1.0.0/noopt/doc/html/ouroboros-consensus-byron/src"><span class="hs-identifier hs-type">Crypto.SignKeyByronDSIGN</span></a></span><span> </span><span id="local-6989586621679175805"><span class="annot"><a href="#local-6989586621679175805"><span class="hs-identifier hs-var">opKey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><span class="annottext">PBftParams
-&gt; CoreNodeId
-&gt; Config
-&gt; GeneratedSecrets
-&gt; (ProtocolInfo Identity ByronBlock, SignKeyDSIGN ByronDSIGN)
forall (m :: * -&gt; *).
(Monad m, ?callStack::CallStack) =&gt;
PBftParams
-&gt; CoreNodeId
-&gt; Config
-&gt; GeneratedSecrets
-&gt; (ProtocolInfo m ByronBlock, SignKeyDSIGN ByronDSIGN)
</span><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html#mkProtocolByron"><span class="hs-identifier hs-var">mkProtocolByron</span></a></span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621679175812"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">CoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679175811"><span class="hs-identifier hs-var">genesisConfig</span></a></span><span> </span><span class="annot"><span class="annottext">GeneratedSecrets
</span><a href="#local-6989586621679175810"><span class="hs-identifier hs-var">genesisSecrets</span></a></span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679175803"><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
pInfoConfig :: TopLevelConfig ByronBlock
pInfoConfig :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
</span><a href="#local-6989586621679175803"><span class="hs-identifier hs-var hs-var">pInfoConfig</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo Identity ByronBlock
</span><a href="#local-6989586621679175804"><span class="hs-identifier hs-var">pInfo</span></a></span><span>
</span><span id="line-446"></span><span>    </span><span id="local-6989586621679175807"><span class="annot"><span class="annottext">bcfg :: BlockConfig ByronBlock
</span><a href="#local-6989586621679175807"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock -&gt; BlockConfig ByronBlock
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
</span><a href="#local-6989586621679175803"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>    </span><span class="annot"><a href="#local-6989586621679175806"><span class="hs-identifier hs-type">propBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proposal.ProposalBody</span></span><span>
</span><span id="line-449"></span><span>    </span><span id="local-6989586621679175806"><span class="annot"><span class="annottext">propBody :: ProposalBody
</span><a href="#local-6989586621679175806"><span class="hs-identifier hs-var hs-var">propBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProposalBody :: ProtocolVersion
-&gt; ProtocolParametersUpdate
-&gt; SoftwareVersion
-&gt; Metadata
-&gt; ProposalBody
</span><span class="hs-identifier hs-type">Proposal.ProposalBody</span></span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:protocolVersion:ProposalBody :: ProtocolVersion
</span><span class="hs-identifier hs-var">Proposal.protocolVersion</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679175809"><span class="hs-identifier hs-var">propPV</span></a></span><span>
</span><span id="line-451"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:protocolParametersUpdate:ProposalBody :: ProtocolParametersUpdate
</span><span class="hs-identifier hs-var">Proposal.protocolParametersUpdate</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolParametersUpdate :: Maybe Word16
-&gt; Maybe Natural
-&gt; Maybe Natural
-&gt; Maybe Natural
-&gt; Maybe Natural
-&gt; Maybe Natural
-&gt; Maybe LovelacePortion
-&gt; Maybe LovelacePortion
-&gt; Maybe LovelacePortion
-&gt; Maybe LovelacePortion
-&gt; Maybe SlotNumber
-&gt; Maybe SoftforkRule
-&gt; Maybe TxFeePolicy
-&gt; Maybe EpochNumber
-&gt; ProtocolParametersUpdate
</span><span class="hs-identifier hs-type">Update.ProtocolParametersUpdate</span></span><span>
</span><span id="line-452"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ppuScriptVersion :: Maybe Word16
</span><span class="hs-identifier hs-var">Update.ppuScriptVersion</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Word16
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-453"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuSlotDuration :: Maybe Natural
</span><span class="hs-identifier hs-var">Update.ppuSlotDuration</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuMaxBlockSize :: Maybe Natural
</span><span class="hs-identifier hs-var">Update.ppuMaxBlockSize</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuMaxHeaderSize :: Maybe Natural
</span><span class="hs-identifier hs-var">Update.ppuMaxHeaderSize</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuMaxTxSize :: Maybe Natural
</span><span class="hs-identifier hs-var">Update.ppuMaxTxSize</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuMaxProposalSize :: Maybe Natural
</span><span class="hs-identifier hs-var">Update.ppuMaxProposalSize</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuMpcThd :: Maybe LovelacePortion
</span><span class="hs-identifier hs-var">Update.ppuMpcThd</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LovelacePortion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuHeavyDelThd :: Maybe LovelacePortion
</span><span class="hs-identifier hs-var">Update.ppuHeavyDelThd</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LovelacePortion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-460"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuUpdateVoteThd :: Maybe LovelacePortion
</span><span class="hs-identifier hs-var">Update.ppuUpdateVoteThd</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LovelacePortion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuUpdateProposalThd :: Maybe LovelacePortion
</span><span class="hs-identifier hs-var">Update.ppuUpdateProposalThd</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe LovelacePortion
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuUpdateProposalTTL :: Maybe SlotNumber
</span><span class="hs-identifier hs-var">Update.ppuUpdateProposalTTL</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SlotNumber
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-463"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuSoftforkRule :: Maybe SoftforkRule
</span><span class="hs-identifier hs-var">Update.ppuSoftforkRule</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SoftforkRule
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-464"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuTxFeePolicy :: Maybe TxFeePolicy
</span><span class="hs-identifier hs-var">Update.ppuTxFeePolicy</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TxFeePolicy
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-465"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ppuUnlockStakeEpoch :: Maybe EpochNumber
</span><span class="hs-identifier hs-var">Update.ppuUnlockStakeEpoch</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNumber
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-466"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-467"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:softwareVersion:ProposalBody :: SoftwareVersion
</span><span class="hs-identifier hs-var">Proposal.softwareVersion</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SoftwareVersion
</span><a href="Test.ThreadNet.Infra.Byron.ProtocolInfo.html#theProposedSoftwareVersion"><span class="hs-identifier hs-var">theProposedSoftwareVersion</span></a></span><span>
</span><span id="line-468"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:metadata:ProposalBody :: Metadata
</span><span class="hs-identifier hs-var">Proposal.metadata</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Metadata
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-469"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="hs-comment">-- | Add the bytestring annotations that would be present if we were to</span><span>
</span><span id="line-472"></span><span class="hs-comment">-- serialize the argument, send it to ourselves, receive it, and deserialize it</span><span>
</span><span id="line-473"></span><span class="hs-comment">--</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- The mempool payloads require the serialized bytes as annotations. It's</span><span>
</span><span id="line-475"></span><span class="hs-comment">-- tricky to get right, and this function lets use reuse the existing CBOR</span><span>
</span><span id="line-476"></span><span class="hs-comment">-- instances.</span><span>
</span><span id="line-477"></span><span class="hs-comment">--</span><span>
</span><span id="line-478"></span><span id="local-6989586621679176011"><span class="annot"><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#loopbackAnnotations"><span class="hs-identifier hs-type">loopbackAnnotations</span></a></span><span>
</span><span id="line-479"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Cardano.Binary.FromCBOR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679176011"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Cardano.Binary.ByteSpan</span></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Cardano.Binary.ToCBOR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679176011"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621679176011"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-482"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679176011"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679176011"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span></span><span>
</span><span id="line-485"></span><span id="loopbackAnnotations"><span class="annot"><span class="annottext">loopbackAnnotations :: f () -&gt; f ByteString
</span><a href="Test.ThreadNet.Infra.Byron.TrackUpdates.html#loopbackAnnotations"><span class="hs-identifier hs-var hs-var">loopbackAnnotations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><span class="annottext">(f () -&gt; Encoding)
-&gt; (forall s. Decoder s (f ByteSpan)) -&gt; f () -&gt; f ByteString
forall (f :: * -&gt; *) a.
Functor f =&gt;
(f a -&gt; Encoding)
-&gt; (forall s. Decoder s (f ByteSpan)) -&gt; f a -&gt; f ByteString
</span><span class="hs-identifier hs-var">ByronAPI.reAnnotateUsing</span></span><span>
</span><span id="line-487"></span><span>      </span><span class="annot"><span class="annottext">f () -&gt; Encoding
forall a. ToCBOR a =&gt; a -&gt; Encoding
</span><span class="hs-identifier hs-var">Cardano.Binary.toCBOR</span></span><span>
</span><span id="line-488"></span><span>      </span><span class="annot"><span class="annottext">forall s. Decoder s (f ByteSpan)
forall a s. FromCBOR a =&gt; Decoder s a
</span><span class="hs-identifier hs-var">Cardano.Binary.fromCBOR</span></span><span>
</span><span id="line-489"></span></pre></body></html>