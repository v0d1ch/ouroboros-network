<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE MultiWayIf      #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies    #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-orphans #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger.Inspect</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ByronLedgerUpdate"><span class="hs-identifier">ByronLedgerUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Layer around the Byron protocol update inteface</span></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier">ProtocolUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateState"><span class="hs-identifier">UpdateState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdates"><span class="hs-identifier">protocolUpdates</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Void</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Block</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CC</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Common</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CC</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Genesis</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CC.Genesis</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.ProtocolConstants</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CC</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Slotting</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CC</span></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">U</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Validation.Endorsement</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">U.E</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Validation.Interface</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">U.I</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Chain.Update.Validation.Registration</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">U.R</span></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.HardFork.History.Util</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">History</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.Condense</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger.Block</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Conversions.html"><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger.Conversions</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Ledger.html"><span class="hs-identifier">Ouroboros.Consensus.Byron.Ledger.Ledger</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Protocol update
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-comment">-- | Wrapper around a Byron protocol update with information about its state</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- NOTE: We don't currently record the 'U.ProtocolParameters' here because  we</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- don't really need to track them, and adding them would add a lot of  output</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- to the 'Show' instance. We could easily add them however if that would be</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- useful.</span><span>
</span><span id="line-55"></span><span class="hs-keyword">data</span><span> </span><span id="ProtocolUpdate"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-var">ProtocolUpdate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ProtocolUpdate"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-var">ProtocolUpdate</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-56"></span><span>      </span><span id="protocolUpdateVersion"><span class="annot"><span class="annottext">ProtocolUpdate -&gt; ProtocolVersion
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdateVersion"><span class="hs-identifier hs-var hs-var">protocolUpdateVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.ProtocolVersion</span></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="protocolUpdateState"><span class="annot"><span class="annottext">ProtocolUpdate -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdateState"><span class="hs-identifier hs-var hs-var">protocolUpdateState</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateState"><span class="hs-identifier hs-type">UpdateState</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679164410"><span id="local-6989586621679164412"><span id="local-6989586621679164414"><span class="annot"><span class="annottext">Int -&gt; ProtocolUpdate -&gt; ShowS
[ProtocolUpdate] -&gt; ShowS
ProtocolUpdate -&gt; String
(Int -&gt; ProtocolUpdate -&gt; ShowS)
-&gt; (ProtocolUpdate -&gt; String)
-&gt; ([ProtocolUpdate] -&gt; ShowS)
-&gt; Show ProtocolUpdate
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ProtocolUpdate] -&gt; ShowS
$cshowList :: [ProtocolUpdate] -&gt; ShowS
show :: ProtocolUpdate -&gt; String
$cshow :: ProtocolUpdate -&gt; String
showsPrec :: Int -&gt; ProtocolUpdate -&gt; ShowS
$cshowsPrec :: Int -&gt; ProtocolUpdate -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679164405"><span id="local-6989586621679164407"><span class="annot"><span class="annottext">ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool
(ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool)
-&gt; (ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool) -&gt; Eq ProtocolUpdate
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool
$c/= :: ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool
== :: ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool
$c== :: ProtocolUpdate -&gt; ProtocolUpdate -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | The various states a protocol update goes through</span><span>
</span><span id="line-62"></span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- Listed in chronological order.</span><span>
</span><span id="line-64"></span><span class="hs-keyword">data</span><span> </span><span id="UpdateState"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateState"><span class="hs-identifier hs-var">UpdateState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- | The update was registered, but does not yet have any votes</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- We record the 'SlotNo' of the slot in which the update was registered.</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">-- After registration, nodes must vote on it.</span><span>
</span><span id="line-69"></span><span>    </span><span id="UpdateRegistered"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateRegistered"><span class="hs-identifier hs-var">UpdateRegistered</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- | The update is accumulating votes</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-comment">-- We record which nodes have voted for the proposal. The proposal must</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- accumulate a sufficient number of votes before it can be confirmed.</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UpdateActive"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateActive"><span class="hs-identifier hs-var">UpdateActive</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.KeyHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- | The update has amassed a sufficient number of votes</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- We record the 'SlotNo' of the slot in which the required threshold of</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- votes was met. At this point @2k@ slots need to pass before the update</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">-- can be endorsed.</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UpdateConfirmed"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateConfirmed"><span class="hs-identifier hs-var">UpdateConfirmed</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- | The votes are stable. We can start to accumulate endorsements.</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- We record which nodes have endorsed the proposal. The proposal must</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">-- accumulate a sufficient number of endorsements before it is nominated</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- and becomes a candidate.</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UpdateStablyConfirmed"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateStablyConfirmed"><span class="hs-identifier hs-var">UpdateStablyConfirmed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.KeyHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">-- | The update has amassed a sufficient number of endorsements</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- We record the 'SlotNo' of the slot in which the required threshold of</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- endorsement was met. At this point a further @2k@ slots need to pass</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- before the update becomes a stable candidate and can be adopted.</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- We additionally record the 'EpochNo' in which the candidate will be</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- adopted, /if/ it becomes stable.</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UpdateCandidate"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateCandidate"><span class="hs-identifier hs-var">UpdateCandidate</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- | The endorsements are stable. The update will be accepted.</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">-- We record the 'EpochNo' of the epoch in which it will become active.</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UpdateStableCandidate"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateStableCandidate"><span class="hs-identifier hs-var">UpdateStableCandidate</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679164392"><span id="local-6989586621679164394"><span id="local-6989586621679164396"><span class="annot"><span class="annottext">Int -&gt; UpdateState -&gt; ShowS
[UpdateState] -&gt; ShowS
UpdateState -&gt; String
(Int -&gt; UpdateState -&gt; ShowS)
-&gt; (UpdateState -&gt; String)
-&gt; ([UpdateState] -&gt; ShowS)
-&gt; Show UpdateState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [UpdateState] -&gt; ShowS
$cshowList :: [UpdateState] -&gt; ShowS
show :: UpdateState -&gt; String
$cshow :: UpdateState -&gt; String
showsPrec :: Int -&gt; UpdateState -&gt; ShowS
$cshowsPrec :: Int -&gt; UpdateState -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679164388"><span id="local-6989586621679164390"><span class="annot"><span class="annottext">UpdateState -&gt; UpdateState -&gt; Bool
(UpdateState -&gt; UpdateState -&gt; Bool)
-&gt; (UpdateState -&gt; UpdateState -&gt; Bool) -&gt; Eq UpdateState
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: UpdateState -&gt; UpdateState -&gt; Bool
$c/= :: UpdateState -&gt; UpdateState -&gt; Bool
== :: UpdateState -&gt; UpdateState -&gt; Bool
$c== :: UpdateState -&gt; UpdateState -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-comment">-- | All proposal updates, from new to old</span><span>
</span><span id="line-108"></span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdates"><span class="hs-identifier hs-type">protocolUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-109"></span><span>       </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Block.html#ByronBlock"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Block.html#ByronBlock"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-112"></span><span id="protocolUpdates"><span class="annot"><span class="annottext">protocolUpdates :: LedgerConfig ByronBlock
-&gt; LedgerState ByronBlock -&gt; [ProtocolUpdate]
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdates"><span class="hs-identifier hs-var hs-var">protocolUpdates</span></a></span></span><span> </span><span id="local-6989586621679164387"><span class="annot"><span class="annottext">LedgerConfig ByronBlock
</span><a href="#local-6989586621679164387"><span class="hs-identifier hs-var">genesis</span></a></span></span><span> </span><span id="local-6989586621679164386"><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164386"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[ProtocolUpdate]] -&gt; [ProtocolUpdate]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-113"></span><span>      </span><span class="annot"><span class="annottext">(CandidateProtocolUpdate -&gt; ProtocolUpdate)
-&gt; [CandidateProtocolUpdate] -&gt; [ProtocolUpdate]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">CandidateProtocolUpdate -&gt; ProtocolUpdate
</span><a href="#local-6989586621679164384"><span class="hs-identifier hs-var">fromCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">[CandidateProtocolUpdate]
</span><a href="#local-6989586621679164383"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-comment">-- Don't record an update both as a proposal and a candidate</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((UpId, ProtocolUpdateProposal) -&gt; ProtocolUpdate)
-&gt; [(UpId, ProtocolUpdateProposal)] -&gt; [ProtocolUpdate]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(UpId, ProtocolUpdateProposal) -&gt; ProtocolUpdate
</span><a href="#local-6989586621679164382"><span class="hs-identifier hs-var">fromRegistered</span></a></span><span> </span><span class="annot"><span class="annottext">([(UpId, ProtocolUpdateProposal)] -&gt; [ProtocolUpdate])
-&gt; (Map UpId ProtocolUpdateProposal
    -&gt; [(UpId, ProtocolUpdateProposal)])
-&gt; Map UpId ProtocolUpdateProposal
-&gt; [ProtocolUpdate]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map UpId ProtocolUpdateProposal -&gt; [(UpId, ProtocolUpdateProposal)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Map UpId ProtocolUpdateProposal -&gt; [ProtocolUpdate])
-&gt; Map UpId ProtocolUpdateProposal -&gt; [ProtocolUpdate]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">(ProtocolUpdateProposal -&gt; Bool)
-&gt; Map UpId ProtocolUpdateProposal
-&gt; Map UpId ProtocolUpdateProposal
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (ProtocolUpdateProposal -&gt; Bool)
-&gt; ProtocolUpdateProposal
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion -&gt; Bool
</span><a href="#local-6989586621679164377"><span class="hs-identifier hs-var">hasCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">(ProtocolVersion -&gt; Bool)
-&gt; (ProtocolUpdateProposal -&gt; ProtocolVersion)
-&gt; ProtocolUpdateProposal
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolUpdateProposal -&gt; ProtocolVersion
</span><span class="hs-identifier hs-var hs-var">U.R.pupProtocolVersion</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map UpId ProtocolUpdateProposal
</span><a href="#local-6989586621679164375"><span class="hs-identifier hs-var">registered</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-comment">-- Configuration</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><a href="#local-6989586621679164374"><span class="hs-identifier hs-type">k</span></a></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.BlockCount</span></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><a href="#local-6989586621679164373"><span class="hs-identifier hs-type">epochSize</span></a></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.EpochSlots</span></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621679164372"><span class="hs-identifier hs-type">stableAfter</span></a></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="#local-6989586621679164371"><span class="hs-identifier hs-type">takesEffectAfter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621679164374"><span class="annot"><span class="annottext">k :: BlockCount
</span><a href="#local-6989586621679164374"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenesisData -&gt; BlockCount
</span><span class="hs-identifier hs-var hs-var">CC.Genesis.gdK</span></span><span> </span><span class="annot"><span class="annottext">(GenesisData -&gt; BlockCount) -&gt; GenesisData -&gt; BlockCount
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Config -&gt; GenesisData
</span><span class="hs-identifier hs-var hs-var">CC.Genesis.configGenesisData</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig ByronBlock
Config
</span><a href="#local-6989586621679164387"><span class="hs-identifier hs-var">genesis</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621679164373"><span class="annot"><span class="annottext">epochSize :: EpochSlots
</span><a href="#local-6989586621679164373"><span class="hs-identifier hs-var hs-var">epochSize</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; EpochSlots
</span><span class="hs-identifier hs-var">CC.Genesis.configEpochSlots</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig ByronBlock
Config
</span><a href="#local-6989586621679164387"><span class="hs-identifier hs-var">genesis</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621679164372"><span class="annot"><span class="annottext">stableAfter :: Word64
</span><a href="#local-6989586621679164372"><span class="hs-identifier hs-var hs-var">stableAfter</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotCount -&gt; Word64
</span><span class="hs-identifier hs-var hs-var">CC.unSlotCount</span></span><span> </span><span class="annot"><span class="annottext">(SlotCount -&gt; Word64) -&gt; SlotCount -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCount -&gt; SlotCount
</span><span class="hs-identifier hs-var">CC.kSlotSecurityParam</span></span><span>    </span><span class="annot"><span class="annottext">BlockCount
</span><a href="#local-6989586621679164374"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621679164371"><span class="annot"><span class="annottext">takesEffectAfter :: Word64
</span><a href="#local-6989586621679164371"><span class="hs-identifier hs-var hs-var">takesEffectAfter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotCount -&gt; Word64
</span><span class="hs-identifier hs-var hs-var">CC.unSlotCount</span></span><span> </span><span class="annot"><span class="annottext">(SlotCount -&gt; Word64) -&gt; SlotCount -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCount -&gt; SlotCount
</span><span class="hs-identifier hs-var">CC.kUpdateStabilityParam</span></span><span> </span><span class="annot"><span class="annottext">BlockCount
</span><a href="#local-6989586621679164374"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- The impossible cases are impossible because these slots refer to</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-comment">-- the slots of blocks on the chain.</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><a href="#local-6989586621679164364"><span class="hs-identifier hs-type">isStable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621679164364"><span class="annot"><span class="annottext">isStable :: SlotNo -&gt; Bool
</span><a href="#local-6989586621679164364"><span class="hs-identifier hs-var hs-var">isStable</span></a></span></span><span> </span><span id="local-6989586621679164363"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164363"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679164362"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679164372"><span class="hs-identifier hs-var">stableAfter</span></a></span><span>
</span><span id="line-136"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><a href="#local-6989586621679164362"><span class="hs-identifier hs-type">depth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-138"></span><span>        </span><span id="local-6989586621679164362"><span class="annot"><span class="annottext">depth :: Word64
</span><a href="#local-6989586621679164362"><span class="hs-identifier hs-var hs-var">depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock -&gt; WithOrigin SlotNo
forall blk.
UpdateLedger blk =&gt;
LedgerState blk -&gt; WithOrigin SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ledgerTipSlot</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164386"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-139"></span><span>                  </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><span class="hs-identifier hs-var">Origin</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Word64
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;isStable: impossible&quot;</span></span><span>
</span><span id="line-140"></span><span>                  </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679164357"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164357"><span class="hs-identifier hs-var">s</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164357"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164363"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-141"></span><span>                                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; Word64
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;isStable: impossible&quot;</span></span><span>
</span><span id="line-142"></span><span>                                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; SlotNo -&gt; SlotNo -&gt; Word64
SlotNo -&gt; SlotNo -&gt; Word64
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">History.countSlots</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164357"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164363"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- Extract relevant bits from the update state</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><a href="#local-6989586621679164354"><span class="hs-identifier hs-type">updState</span></a></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.I.State</span></span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="#local-6989586621679164375"><span class="hs-identifier hs-type">registered</span></a></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.R.ProtocolUpdateProposals</span></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><a href="#local-6989586621679164352"><span class="hs-identifier hs-type">registeredAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.UpId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.SlotNumber</span></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><a href="#local-6989586621679164351"><span class="hs-identifier hs-type">confirmed</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.UpId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.SlotNumber</span></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="#local-6989586621679164350"><span class="hs-identifier hs-type">votes</span></a></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.UpId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.KeyHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="#local-6989586621679164383"><span class="hs-identifier hs-type">candidates</span></a></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">U.E.CandidateProtocolUpdate</span></span><span class="hs-special">]</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="#local-6989586621679164349"><span class="hs-identifier hs-type">endorsements</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.ProtocolVersion</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.KeyHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>    </span><span id="local-6989586621679164354"><span class="annot"><span class="annottext">updState :: State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var hs-var">updState</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainValidationState -&gt; State
</span><span class="hs-identifier hs-var hs-var">CC.cvsUpdateState</span></span><span> </span><span class="annot"><span class="annottext">(ChainValidationState -&gt; State) -&gt; ChainValidationState -&gt; State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock -&gt; ChainValidationState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Ledger.html#byronLedgerState"><span class="hs-identifier hs-var hs-var">byronLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164386"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span id="local-6989586621679164375"><span class="annot"><span class="annottext">registered :: Map UpId ProtocolUpdateProposal
</span><a href="#local-6989586621679164375"><span class="hs-identifier hs-var hs-var">registered</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; Map UpId ProtocolUpdateProposal
</span><span class="hs-identifier hs-var hs-var">U.I.registeredProtocolUpdateProposals</span></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var">updState</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621679164352"><span class="annot"><span class="annottext">registeredAt :: Map UpId SlotNumber
</span><a href="#local-6989586621679164352"><span class="hs-identifier hs-var hs-var">registeredAt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; Map UpId SlotNumber
</span><span class="hs-identifier hs-var hs-var">U.I.proposalRegistrationSlot</span></span><span>          </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var">updState</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621679164351"><span class="annot"><span class="annottext">confirmed :: Map UpId SlotNumber
</span><a href="#local-6989586621679164351"><span class="hs-identifier hs-var hs-var">confirmed</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; Map UpId SlotNumber
</span><span class="hs-identifier hs-var hs-var">U.I.confirmedProposals</span></span><span>                </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var">updState</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679164350"><span class="annot"><span class="annottext">votes :: Map UpId (Set KeyHash)
</span><a href="#local-6989586621679164350"><span class="hs-identifier hs-var hs-var">votes</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; Map UpId (Set KeyHash)
</span><span class="hs-identifier hs-var hs-var">U.I.proposalVotes</span></span><span>                     </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var">updState</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621679164383"><span class="annot"><span class="annottext">candidates :: [CandidateProtocolUpdate]
</span><a href="#local-6989586621679164383"><span class="hs-identifier hs-var hs-var">candidates</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; [CandidateProtocolUpdate]
</span><span class="hs-identifier hs-var hs-var">U.I.candidateProtocolUpdates</span></span><span>          </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var">updState</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621679164349"><span class="annot"><span class="annottext">endorsements :: Map ProtocolVersion (Set KeyHash)
</span><a href="#local-6989586621679164349"><span class="hs-identifier hs-var hs-var">endorsements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Set KeyHash -&gt; Set KeyHash -&gt; Set KeyHash)
-&gt; [(ProtocolVersion, Set KeyHash)]
-&gt; Map ProtocolVersion (Set KeyHash)
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromListWith</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash -&gt; Set KeyHash -&gt; Set KeyHash
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span>
</span><span id="line-161"></span><span>                 </span><span class="annot"><span class="annottext">([(ProtocolVersion, Set KeyHash)]
 -&gt; Map ProtocolVersion (Set KeyHash))
-&gt; (Set Endorsement -&gt; [(ProtocolVersion, Set KeyHash)])
-&gt; Set Endorsement
-&gt; Map ProtocolVersion (Set KeyHash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Endorsement -&gt; (ProtocolVersion, Set KeyHash))
-&gt; [Endorsement] -&gt; [(ProtocolVersion, Set KeyHash)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679164339"><span class="annot"><span class="annottext">Endorsement
</span><a href="#local-6989586621679164339"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Endorsement -&gt; ProtocolVersion
</span><span class="hs-identifier hs-var hs-var">U.E.endorsementProtocolVersion</span></span><span>        </span><span class="annot"><span class="annottext">Endorsement
</span><a href="#local-6989586621679164339"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-162"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KeyHash -&gt; Set KeyHash
forall a. a -&gt; Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Endorsement -&gt; KeyHash
</span><span class="hs-identifier hs-var hs-var">U.E.endorsementKeyHash</span></span><span> </span><span class="annot"><span class="annottext">Endorsement
</span><a href="#local-6989586621679164339"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>                              </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>                 </span><span class="annot"><span class="annottext">([Endorsement] -&gt; [(ProtocolVersion, Set KeyHash)])
-&gt; (Set Endorsement -&gt; [Endorsement])
-&gt; Set Endorsement
-&gt; [(ProtocolVersion, Set KeyHash)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Set Endorsement -&gt; [Endorsement]
forall a. Set a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.toList</span></a></span><span>
</span><span id="line-165"></span><span>                 </span><span class="annot"><span class="annottext">(Set Endorsement -&gt; Map ProtocolVersion (Set KeyHash))
-&gt; Set Endorsement -&gt; Map ProtocolVersion (Set KeyHash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; Set Endorsement
</span><span class="hs-identifier hs-var hs-var">U.I.registeredEndorsements</span></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679164354"><span class="hs-identifier hs-var">updState</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- From registered proposals</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="#local-6989586621679164382"><span class="hs-identifier hs-type">fromRegistered</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">U.UpId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.R.ProtocolUpdateProposal</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679164382"><span class="annot"><span class="annottext">fromRegistered :: (UpId, ProtocolUpdateProposal) -&gt; ProtocolUpdate
</span><a href="#local-6989586621679164382"><span class="hs-identifier hs-var hs-var">fromRegistered</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679164333"><span class="annot"><span class="annottext">UpId
</span><a href="#local-6989586621679164333"><span class="hs-identifier hs-var">upId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679164332"><span class="annot"><span class="annottext">ProtocolUpdateProposal
</span><a href="#local-6989586621679164332"><span class="hs-identifier hs-var">proposal</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolUpdate :: ProtocolVersion -&gt; UpdateState -&gt; ProtocolUpdate
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="annottext">protocolUpdateVersion :: ProtocolVersion
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdateVersion"><span class="hs-identifier hs-var">protocolUpdateVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679164331"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">protocolUpdateState :: UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdateState"><span class="hs-identifier hs-var">protocolUpdateState</span></a></span><span>   </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>            </span><span class="hs-comment">-- We do the checks in reverse chronological order</span><span>
</span><span id="line-174"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set KeyHash -&gt; Bool
forall a. Set a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.null</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
</span><a href="#local-6989586621679164329"><span class="hs-identifier hs-var">updEndorsed</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>                   </span><span class="annot"><span class="annottext">Set KeyHash -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateStablyConfirmed"><span class="hs-identifier hs-var">UpdateStablyConfirmed</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
</span><a href="#local-6989586621679164329"><span class="hs-identifier hs-var">updEndorsed</span></a></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679164328"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164328"><span class="hs-identifier hs-var">confirmedInSlot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe SlotNo
</span><a href="#local-6989586621679164327"><span class="hs-identifier hs-var">updConfirmed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>                   </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Bool
</span><a href="#local-6989586621679164364"><span class="hs-identifier hs-var">isStable</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164328"><span class="hs-identifier hs-var">confirmedInSlot</span></a></span><span>
</span><span id="line-179"></span><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Set KeyHash -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateStablyConfirmed"><span class="hs-identifier hs-var">UpdateStablyConfirmed</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
forall a. Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-180"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateConfirmed"><span class="hs-identifier hs-var">UpdateConfirmed</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164328"><span class="hs-identifier hs-var">confirmedInSlot</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set KeyHash -&gt; Bool
forall a. Set a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.null</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
</span><a href="#local-6989586621679164325"><span class="hs-identifier hs-var">updVotes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>                   </span><span class="annot"><span class="annottext">Set KeyHash -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateActive"><span class="hs-identifier hs-var">UpdateActive</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
</span><a href="#local-6989586621679164325"><span class="hs-identifier hs-var">updVotes</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>                   </span><span class="annot"><span class="annottext">SlotNo -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateRegistered"><span class="hs-identifier hs-var">UpdateRegistered</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164324"><span class="hs-identifier hs-var">updSlot</span></a></span><span>
</span><span id="line-187"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><a href="#local-6989586621679164331"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.ProtocolVersion</span></span><span>
</span><span id="line-190"></span><span>        </span><span id="local-6989586621679164331"><span class="annot"><span class="annottext">version :: ProtocolVersion
</span><a href="#local-6989586621679164331"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolUpdateProposal -&gt; ProtocolVersion
</span><span class="hs-identifier hs-var hs-var">U.R.pupProtocolVersion</span></span><span> </span><span class="annot"><span class="annottext">ProtocolUpdateProposal
</span><a href="#local-6989586621679164332"><span class="hs-identifier hs-var">proposal</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><a href="#local-6989586621679164325"><span class="hs-identifier hs-type">updVotes</span></a></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.KeyHash</span></span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><a href="#local-6989586621679164327"><span class="hs-identifier hs-type">updConfirmed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><a href="#local-6989586621679164329"><span class="hs-identifier hs-type">updEndorsed</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CC.KeyHash</span></span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><a href="#local-6989586621679164324"><span class="hs-identifier hs-type">updSlot</span></a></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>        </span><span id="local-6989586621679164325"><span class="annot"><span class="annottext">updVotes :: Set KeyHash
</span><a href="#local-6989586621679164325"><span class="hs-identifier hs-var hs-var">updVotes</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set KeyHash -&gt; UpId -&gt; Map UpId (Set KeyHash) -&gt; Set KeyHash
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.findWithDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
forall a. Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.empty</span></a></span><span> </span><span class="annot"><span class="annottext">UpId
</span><a href="#local-6989586621679164333"><span class="hs-identifier hs-var">upId</span></a></span><span> </span><span class="annot"><span class="annottext">Map UpId (Set KeyHash)
</span><a href="#local-6989586621679164350"><span class="hs-identifier hs-var">votes</span></a></span><span>
</span><span id="line-198"></span><span>        </span><span id="local-6989586621679164327"><span class="annot"><span class="annottext">updConfirmed :: Maybe SlotNo
</span><a href="#local-6989586621679164327"><span class="hs-identifier hs-var hs-var">updConfirmed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNumber -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Byron.Ledger.Conversions.html#fromByronSlotNo"><span class="hs-identifier hs-var">fromByronSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNumber -&gt; SlotNo) -&gt; Maybe SlotNumber -&gt; Maybe SlotNo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UpId -&gt; Map UpId SlotNumber -&gt; Maybe SlotNumber
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">UpId
</span><a href="#local-6989586621679164333"><span class="hs-identifier hs-var">upId</span></a></span><span> </span><span class="annot"><span class="annottext">Map UpId SlotNumber
</span><a href="#local-6989586621679164351"><span class="hs-identifier hs-var">confirmed</span></a></span><span>
</span><span id="line-199"></span><span>        </span><span id="local-6989586621679164329"><span class="annot"><span class="annottext">updEndorsed :: Set KeyHash
</span><a href="#local-6989586621679164329"><span class="hs-identifier hs-var hs-var">updEndorsed</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set KeyHash
-&gt; ProtocolVersion
-&gt; Map ProtocolVersion (Set KeyHash)
-&gt; Set KeyHash
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.findWithDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Set KeyHash
forall a. Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.empty</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679164331"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">Map ProtocolVersion (Set KeyHash)
</span><a href="#local-6989586621679164349"><span class="hs-identifier hs-var">endorsements</span></a></span><span>
</span><span id="line-200"></span><span>        </span><span id="local-6989586621679164324"><span class="annot"><span class="annottext">updSlot :: SlotNo
</span><a href="#local-6989586621679164324"><span class="hs-identifier hs-var hs-var">updSlot</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UpId -&gt; Map UpId SlotNumber -&gt; Maybe SlotNumber
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">UpId
</span><a href="#local-6989586621679164333"><span class="hs-identifier hs-var">upId</span></a></span><span> </span><span class="annot"><span class="annottext">Map UpId SlotNumber
</span><a href="#local-6989586621679164352"><span class="hs-identifier hs-var">registeredAt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-201"></span><span>                         </span><span class="annot"><span class="annottext">Maybe SlotNumber
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SlotNo
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;updSlot: invalid Byron state&quot;</span></span><span>
</span><span id="line-202"></span><span>                         </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679164319"><span class="annot"><span class="annottext">SlotNumber
</span><a href="#local-6989586621679164319"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNumber -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Byron.Ledger.Conversions.html#fromByronSlotNo"><span class="hs-identifier hs-var">fromByronSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNumber
</span><a href="#local-6989586621679164319"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-comment">-- From candidate proposals</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621679164384"><span class="hs-identifier hs-type">fromCandidate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.E.CandidateProtocolUpdate</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621679164384"><span class="annot"><span class="annottext">fromCandidate :: CandidateProtocolUpdate -&gt; ProtocolUpdate
</span><a href="#local-6989586621679164384"><span class="hs-identifier hs-var hs-var">fromCandidate</span></a></span></span><span> </span><span id="local-6989586621679164318"><span class="annot"><span class="annottext">CandidateProtocolUpdate
</span><a href="#local-6989586621679164318"><span class="hs-identifier hs-var">candidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolUpdate :: ProtocolVersion -&gt; UpdateState -&gt; ProtocolUpdate
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-208"></span><span>          </span><span class="annot"><span class="annottext">protocolUpdateVersion :: ProtocolVersion
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdateVersion"><span class="hs-identifier hs-var">protocolUpdateVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679164317"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">protocolUpdateState :: UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdateState"><span class="hs-identifier hs-var">protocolUpdateState</span></a></span><span>   </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; Bool
</span><a href="#local-6989586621679164364"><span class="hs-identifier hs-var">isStable</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164316"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; EpochNo -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateCandidate"><span class="hs-identifier hs-var">UpdateCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164316"><span class="hs-identifier hs-var">slot</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; EpochNo
</span><a href="#local-6989586621679164315"><span class="hs-identifier hs-var">cpuEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164316"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; UpdateState
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#UpdateStableCandidate"><span class="hs-identifier hs-var">UpdateStableCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; EpochNo
</span><a href="#local-6989586621679164315"><span class="hs-identifier hs-var">cpuEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679164316"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-215"></span><span>        </span><span class="annot"><a href="#local-6989586621679164316"><span class="hs-identifier hs-type">slot</span></a></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><a href="#local-6989586621679164317"><span class="hs-identifier hs-type">version</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.ProtocolVersion</span></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>        </span><span id="local-6989586621679164316"><span class="annot"><span class="annottext">slot :: SlotNo
</span><a href="#local-6989586621679164316"><span class="hs-identifier hs-var hs-var">slot</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNumber -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Byron.Ledger.Conversions.html#fromByronSlotNo"><span class="hs-identifier hs-var">fromByronSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNumber -&gt; SlotNo) -&gt; SlotNumber -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CandidateProtocolUpdate -&gt; SlotNumber
</span><span class="hs-identifier hs-var hs-var">U.E.cpuSlot</span></span><span> </span><span class="annot"><span class="annottext">CandidateProtocolUpdate
</span><a href="#local-6989586621679164318"><span class="hs-identifier hs-var">candidate</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span id="local-6989586621679164317"><span class="annot"><span class="annottext">version :: ProtocolVersion
</span><a href="#local-6989586621679164317"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CandidateProtocolUpdate -&gt; ProtocolVersion
</span><span class="hs-identifier hs-var hs-var">U.E.cpuProtocolVersion</span></span><span>        </span><span class="annot"><span class="annottext">CandidateProtocolUpdate
</span><a href="#local-6989586621679164318"><span class="hs-identifier hs-var">candidate</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- Is there a candidate for this version?</span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><a href="#local-6989586621679164377"><span class="hs-identifier hs-type">hasCandidate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">U.ProtocolVersion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621679164377"><span class="annot"><span class="annottext">hasCandidate :: ProtocolVersion -&gt; Bool
</span><a href="#local-6989586621679164377"><span class="hs-identifier hs-var hs-var">hasCandidate</span></a></span></span><span> </span><span id="local-6989586621679164312"><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679164312"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CandidateProtocolUpdate -&gt; Bool)
-&gt; [CandidateProtocolUpdate] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProtocolVersion -&gt; ProtocolVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621679164312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ProtocolVersion -&gt; Bool)
-&gt; (CandidateProtocolUpdate -&gt; ProtocolVersion)
-&gt; CandidateProtocolUpdate
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CandidateProtocolUpdate -&gt; ProtocolVersion
</span><span class="hs-identifier hs-var hs-var">U.E.cpuProtocolVersion</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CandidateProtocolUpdate]
</span><a href="#local-6989586621679164383"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-comment">-- Given the 'SlotNo' of a candidate, compute in which 'Epoch' it will</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- become active.</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- This follows the same structure as the computation in the A/B test. Let</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- @s@ be the slot the update proposal was endorsed (gathered enough</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- endorsements). Note that the very first slot in which the transition</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-comment">-- /could/ occur is @s + 1@; adding the required stability, the first slot</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- in which the transition could occur is @s + 4k + 1@. This means that the</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">-- last slot which /must/ be in /this/ era is @s + 4k@. Hence the last</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-comment">-- /epoch/ that must be in this era is @epoch (s + 4k)@, and the first epoch</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">-- of the /next/ era is @succ (epoch (s + 4k))@.</span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><a href="#local-6989586621679164315"><span class="hs-identifier hs-type">cpuEpoch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621679164315"><span class="annot"><span class="annottext">cpuEpoch :: SlotNo -&gt; EpochNo
</span><a href="#local-6989586621679164315"><span class="hs-identifier hs-var hs-var">cpuEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; EpochNo
forall a. Enum a =&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">(EpochNo -&gt; EpochNo) -&gt; (SlotNo -&gt; EpochNo) -&gt; SlotNo -&gt; EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; EpochNo
</span><a href="#local-6989586621679164309"><span class="hs-identifier hs-var">slotToEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; EpochNo) -&gt; (SlotNo -&gt; SlotNo) -&gt; SlotNo -&gt; EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo -&gt; SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">History.addSlots</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679164371"><span class="hs-identifier hs-var">takesEffectAfter</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-comment">-- Slot conversion</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-comment">-- This is valid for slots in the Byron era only; just like the Byron</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- ledger itself, it assumes the Byron era is the /first/ era.</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><a href="#local-6989586621679164309"><span class="hs-identifier hs-type">slotToEpoch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621679164309"><span class="annot"><span class="annottext">slotToEpoch :: SlotNo -&gt; EpochNo
</span><a href="#local-6989586621679164309"><span class="hs-identifier hs-var hs-var">slotToEpoch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span id="local-6989586621679164306"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679164306"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; EpochNo
</span><span class="hs-identifier hs-var">EpochNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679164306"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">EpochSlots -&gt; Word64
</span><span class="hs-identifier hs-var hs-var">CC.unEpochSlots</span></span><span> </span><span class="annot"><span class="annottext">EpochSlots
</span><a href="#local-6989586621679164373"><span class="hs-identifier hs-var">epochSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Inspection
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-keyword">data</span><span> </span><span id="ByronLedgerUpdate"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ByronLedgerUpdate"><span class="hs-identifier hs-var">ByronLedgerUpdate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>    </span><span id="ByronUpdatedProtocolUpdates"><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ByronUpdatedProtocolUpdates"><span class="hs-identifier hs-var">ByronUpdatedProtocolUpdates</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679164296"><span id="local-6989586621679164298"><span id="local-6989586621679164300"><span class="annot"><span class="annottext">Int -&gt; ByronLedgerUpdate -&gt; ShowS
[ByronLedgerUpdate] -&gt; ShowS
ByronLedgerUpdate -&gt; String
(Int -&gt; ByronLedgerUpdate -&gt; ShowS)
-&gt; (ByronLedgerUpdate -&gt; String)
-&gt; ([ByronLedgerUpdate] -&gt; ShowS)
-&gt; Show ByronLedgerUpdate
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ByronLedgerUpdate] -&gt; ShowS
$cshowList :: [ByronLedgerUpdate] -&gt; ShowS
show :: ByronLedgerUpdate -&gt; String
$cshow :: ByronLedgerUpdate -&gt; String
showsPrec :: Int -&gt; ByronLedgerUpdate -&gt; ShowS
$cshowsPrec :: Int -&gt; ByronLedgerUpdate -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679164292"><span id="local-6989586621679164294"><span class="annot"><span class="annottext">ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool
(ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool)
-&gt; (ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool)
-&gt; Eq ByronLedgerUpdate
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool
$c/= :: ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool
== :: ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool
$c== :: ByronLedgerUpdate -&gt; ByronLedgerUpdate -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Condense</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ByronLedgerUpdate"><span class="hs-identifier hs-type">ByronLedgerUpdate</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-255"></span><span>  </span><span id="local-6989586621679164289"><span class="annot"><span class="annottext">condense :: ByronLedgerUpdate -&gt; String
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">condense</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByronLedgerUpdate -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Block.html#ByronBlock"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="LedgerWarning"><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">LedgerWarning</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Block.html#ByronBlock"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="LedgerUpdate"><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">LedgerUpdate</span></a></span></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Block.html#ByronBlock"><span class="hs-identifier hs-type">ByronBlock</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ByronLedgerUpdate"><span class="hs-identifier hs-type">ByronLedgerUpdate</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span>  </span><span id="local-6989586621679164278"><span class="annot"><span class="annottext">inspectLedger :: TopLevelConfig ByronBlock
-&gt; LedgerState ByronBlock
-&gt; LedgerState ByronBlock
-&gt; [LedgerEvent ByronBlock]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">inspectLedger</span></a></span></span><span> </span><span id="local-6989586621679164276"><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
</span><a href="#local-6989586621679164276"><span class="hs-identifier hs-var">tlc</span></a></span></span><span> </span><span id="local-6989586621679164275"><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164275"><span class="hs-identifier hs-var">before</span></a></span></span><span> </span><span id="local-6989586621679164274"><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164274"><span class="hs-identifier hs-var">after</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; [()]
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; [()]) -&gt; Bool -&gt; [()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[ProtocolUpdate]
</span><a href="#local-6989586621679164273"><span class="hs-identifier hs-var">updatesBefore</span></a></span><span> </span><span class="annot"><span class="annottext">[ProtocolUpdate] -&gt; [ProtocolUpdate] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">[ProtocolUpdate]
</span><a href="#local-6989586621679164271"><span class="hs-identifier hs-var">updatesAfter</span></a></span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">LedgerEvent ByronBlock -&gt; [LedgerEvent ByronBlock]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerEvent ByronBlock -&gt; [LedgerEvent ByronBlock])
-&gt; LedgerEvent ByronBlock -&gt; [LedgerEvent ByronBlock]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerUpdate ByronBlock -&gt; LedgerEvent ByronBlock
forall blk. LedgerUpdate blk -&gt; LedgerEvent blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">LedgerUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerUpdate ByronBlock -&gt; LedgerEvent ByronBlock)
-&gt; LedgerUpdate ByronBlock -&gt; LedgerEvent ByronBlock
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[ProtocolUpdate] -&gt; ByronLedgerUpdate
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ByronUpdatedProtocolUpdates"><span class="hs-identifier hs-var">ByronUpdatedProtocolUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">[ProtocolUpdate]
</span><a href="#local-6989586621679164271"><span class="hs-identifier hs-var">updatesAfter</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><a href="#local-6989586621679164273"><span class="hs-identifier hs-type">updatesBefore</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679164271"><span class="hs-identifier hs-type">updatesAfter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#ProtocolUpdate"><span class="hs-identifier hs-type">ProtocolUpdate</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-266"></span><span>      </span><span id="local-6989586621679164273"><span class="annot"><span class="annottext">updatesBefore :: [ProtocolUpdate]
</span><a href="#local-6989586621679164273"><span class="hs-identifier hs-var hs-var">updatesBefore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig ByronBlock
-&gt; LedgerState ByronBlock -&gt; [ProtocolUpdate]
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdates"><span class="hs-identifier hs-var">protocolUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock -&gt; LedgerConfig ByronBlock
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
</span><a href="#local-6989586621679164276"><span class="hs-identifier hs-var">tlc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164275"><span class="hs-identifier hs-var">before</span></a></span><span>
</span><span id="line-267"></span><span>      </span><span id="local-6989586621679164271"><span class="annot"><span class="annottext">updatesAfter :: [ProtocolUpdate]
</span><a href="#local-6989586621679164271"><span class="hs-identifier hs-var hs-var">updatesAfter</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig ByronBlock
-&gt; LedgerState ByronBlock -&gt; [ProtocolUpdate]
</span><a href="Ouroboros.Consensus.Byron.Ledger.Inspect.html#protocolUpdates"><span class="hs-identifier hs-var">protocolUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock -&gt; LedgerConfig ByronBlock
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig ByronBlock
</span><a href="#local-6989586621679164276"><span class="hs-identifier hs-var">tlc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState ByronBlock
</span><a href="#local-6989586621679164274"><span class="hs-identifier hs-var">after</span></a></span><span>
</span><span id="line-268"></span></pre></body></html>