<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs                      #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                 #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds                  #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE DataKinds                  #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns             #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeInType                 #-}</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- @UndecidableInstances@ extension is required for defining @Show@ instance of</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- @'AnyMessage'@.</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances       #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints      #-}</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TypedProtocol.Codec</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-16"></a><span>    </span><span class="hs-comment">-- * Defining and using Codecs</span><span>
</span><a name="line-17"></a><span>    </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#hoistCodec"><span class="hs-identifier hs-var">hoistCodec</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#isoCodec"><span class="hs-identifier hs-var">isoCodec</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#mapFailureCodec"><span class="hs-identifier hs-var">mapFailureCodec</span></a><span>
</span><a name="line-21"></a><span>    </span><span class="hs-comment">-- ** Related types</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#WeHaveAgency"><span class="hs-identifier hs-type">WeHaveAgency</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#TheyHaveAgency"><span class="hs-identifier hs-type">TheyHaveAgency</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-type">SomeMessage</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#CodecFailure"><span class="hs-identifier hs-type">CodecFailure</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>    </span><span class="hs-comment">-- ** Incremental decoding</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoderPure"><span class="hs-identifier hs-var">runDecoderPure</span></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-comment">-- ** Codec properties</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codecM"><span class="hs-identifier hs-var">prop_codecM</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec"><span class="hs-identifier hs-var">prop_codec</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec_splitsM"><span class="hs-identifier hs-var">prop_codec_splitsM</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec_splits"><span class="hs-identifier hs-var">prop_codec_splits</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec_binary_compatM"><span class="hs-identifier hs-var">prop_codec_binary_compatM</span></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec_binary_compat"><span class="hs-identifier hs-var">prop_codec_binary_compat</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier hs-type">SamePeerHasAgency</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html"><span class="hs-identifier">Network.TypedProtocol.Core</span></a><span>
</span><a name="line-47"></a><span>                   </span><span class="hs-special">(</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#Protocol"><span class="hs-identifier hs-type">Protocol</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#WeHaveAgency"><span class="hs-identifier hs-type">WeHaveAgency</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#TheyHaveAgency"><span class="hs-identifier hs-type">TheyHaveAgency</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html"><span class="hs-identifier">Network.TypedProtocol.Driver</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-type">SomeMessage</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- | A codec for a 'Protocol' handles the encoding and decoding of typed</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- protocol messages. This is typically used when sending protocol messages</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- over untyped channels. The codec chooses the exact encoding, for example</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- encoding in some text-based syntax, or some choice of binary format.</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- The codec is parametrised by:</span><span>
</span><a name="line-57"></a><span class="hs-comment">--</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- * The protocol</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- * The peer role (client\/server)</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- * the type of decoding failures</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- * the monad in which the decoder runs</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- * the type of the encoded data (typically strings or bytes)</span><span>
</span><a name="line-63"></a><span class="hs-comment">--</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- It is expected that typical codec implementations will be polymorphic in</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- the peer role. For example a codec for the ping\/pong protocol might have</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- type:</span><span>
</span><a name="line-67"></a><span class="hs-comment">--</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- &gt; codecPingPong :: forall m. Monad m =&gt; Codec PingPong String m String</span><span>
</span><a name="line-69"></a><span class="hs-comment">--</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- A codec consists of a message encoder and a decoder.</span><span>
</span><a name="line-71"></a><span class="hs-comment">--</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- The encoder is supplied both with the message to encode and the current</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- protocol state (matching the message). The protocol state can be either</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- a client or server state, but for either peer role it is a protocol state</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- in which the peer has agency, since those are the only states where a</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- peer needs to encode a message to be able to send it.</span><span>
</span><a name="line-77"></a><span class="hs-comment">--</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- For example a simple text encoder for the ping\/pong protocol could be:</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- &gt; encode :: WeHaveAgency pr st</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- &gt;        -&gt; Message PingPong st st'</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- &gt;        -&gt; String</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- &gt;  encode (ClientAgency TokIdle) MsgPing = &quot;ping\n&quot;</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- &gt;  encode (ClientAgency TokIdle) MsgDone = &quot;done\n&quot;</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- &gt;  encode (ServerAgency TokBusy) MsgPong = &quot;pong\n&quot;</span><span>
</span><a name="line-86"></a><span class="hs-comment">--</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- The decoder is also given the current protocol state and it is expected to</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- be able to decode /any/ message that is valid in that state, but /only/</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- messages that are valid in that state. Messages that are unexpected for the</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- current state should be treated like any other decoding format error.</span><span>
</span><a name="line-91"></a><span class="hs-comment">--</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- While the current protocol state is known, the state that the message will</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- have the peer transition to is not known. For this reason the decoded</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- message is wrapped in the 'SomeMessage' constructor which hides the \&quot;to\&quot;</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- state.</span><span>
</span><a name="line-96"></a><span class="hs-comment">--</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- The decoder uses an incremental decoding interface 'DecodeStep' so that</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- input can be supplied (e.g. from a Channel) bit by bit. This style of</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- decoder allows but does not require a format with message framing where the</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- decoder input matches exactly with the message boundaries.</span><span>
</span><a name="line-101"></a><span class="hs-comment">--</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- &gt; decode :: TheyHaveAgency pr st</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- &gt;        -&gt; m (DecodeStep String String m (SomeMessage st))</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- &gt; decode stok =</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- &gt;   decodeTerminatedFrame '\n' $ \str trailing -&gt;</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- &gt;     case (stok, str) of</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- &gt;       (ServerAgency TokBusy, &quot;pong&quot;) -&gt;</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- &gt;            DecodeDone (SomeMessage MsgPong) trailing</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- &gt;       (ClientAgency TokIdle, &quot;ping&quot;) -&gt;</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- &gt;            DecodeDone (SomeMessage MsgPing) trailing</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- &gt;       (ClientAgency TokIdle, &quot;done&quot;) -&gt;</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- &gt;            DecodeDone (SomeMessage MsgDone) trailing</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- &gt;       _ -&gt; DecodeFail (&quot;unexpected message: &quot; ++ str)</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- The main thing to note is the pattern matching on the combination of the</span><span>
</span><a name="line-116"></a><span class="hs-comment">-- message string and the protocol state. This neatly fulfils the requirement</span><span>
</span><a name="line-117"></a><span class="hs-comment">-- that we only return messages that are of the correct type for the given</span><span>
</span><a name="line-118"></a><span class="hs-comment">-- protocol state.</span><span>
</span><a name="line-119"></a><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- This toy example format uses newlines @\n@ as a framing format. See</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- 'DecodeStep' for suggestions on how to use it for more realistic formats.</span><span>
</span><a name="line-122"></a><span class="hs-comment">--</span><span>
</span><a name="line-123"></a><span class="hs-keyword">data</span><span> </span><a name="Codec"><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier">Codec</span></a></a><span> </span><a name="local-6989586621679045274"><a href="#local-6989586621679045274"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621679045275"><a href="#local-6989586621679045275"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045276"><a href="#local-6989586621679045276"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045277"><a href="#local-6989586621679045277"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Codec"><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier">Codec</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-124"></a><span>       </span><a name="encode"><a href="Network.TypedProtocol.Codec.html#encode"><span class="hs-identifier">encode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045278"><a href="#local-6989586621679045278"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045279"><a href="#local-6989586621679045279"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045274"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045280"><a href="#local-6989586621679045280"><span class="hs-identifier">st'</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045274"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><a name="line-125"></a><span>                 </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679045278"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045279"><span class="hs-identifier hs-type">st</span></a><span>
</span><a name="line-126"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-6989586621679045274"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045279"><span class="hs-identifier hs-type">st</span></a><span> </span><a href="#local-6989586621679045280"><span class="hs-identifier hs-type">st'</span></a><span>
</span><a name="line-127"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045277"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span>       </span><a name="decode"><a href="Network.TypedProtocol.Codec.html#decode"><span class="hs-identifier">decode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045281"><a href="#local-6989586621679045281"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045282"><a href="#local-6989586621679045282"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045274"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><a name="line-130"></a><span>                 </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679045281"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045282"><span class="hs-identifier hs-type">st</span></a><span>
</span><a name="line-131"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045276"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045277"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045275"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045276"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-type">SomeMessage</span></a><span> </span><a href="#local-6989586621679045282"><span class="hs-identifier hs-type">st</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">hoistCodec</span><span>
</span><a name="line-135"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679045355"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045360"><a href="#local-6989586621679045360"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679045356"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045360"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045355"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679045360"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045357"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045358"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045356"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045359"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045357"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045358"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045355"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679045359"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-139"></a><a name="hoistCodec"><a href="Network.TypedProtocol.Codec.html#hoistCodec"><span class="hs-identifier">hoistCodec</span></a></a><span> </span><a name="local-6989586621679045361"><a href="#local-6989586621679045361"><span class="hs-identifier">nat</span></a></a><span> </span><a name="local-6989586621679045362"><a href="#local-6989586621679045362"><span class="hs-identifier">codec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679045362"><span class="hs-identifier hs-var">codec</span></a><span>
</span><a name="line-140"></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">decode</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#hoistDecodeStep"><span class="hs-identifier hs-var">hoistDecodeStep</span></a><span> </span><a href="#local-6989586621679045361"><span class="hs-identifier hs-var">nat</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679045361"><span class="hs-identifier hs-var">nat</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">decode</span><span> </span><a href="#local-6989586621679045362"><span class="hs-identifier hs-var">codec</span></a><span>
</span><a name="line-141"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-identifier">isoCodec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679045350"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-144"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045351"><span class="hs-identifier hs-type">bytes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045352"><span class="hs-identifier hs-type">bytes'</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045352"><span class="hs-identifier hs-type">bytes'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045351"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045353"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045354"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045350"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045351"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-147"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045353"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045354"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045350"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045352"><span class="hs-identifier hs-type">bytes'</span></a><span>
</span><a name="line-148"></a><a name="isoCodec"><a href="Network.TypedProtocol.Codec.html#isoCodec"><span class="hs-identifier">isoCodec</span></a></a><span> </span><a name="local-6989586621679045363"><a href="#local-6989586621679045363"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679045364"><a href="#local-6989586621679045364"><span class="hs-identifier">finv</span></a></a><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-var">Codec</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679045365"><a href="#local-6989586621679045365"><span class="hs-identifier">encode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679045366"><a href="#local-6989586621679045366"><span class="hs-identifier">decode</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-var">Codec</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-149"></a><span>      </span><span class="hs-identifier">encode</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679045367"><a href="#local-6989586621679045367"><span class="hs-identifier">tok</span></a></a><span> </span><a name="local-6989586621679045368"><a href="#local-6989586621679045368"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045363"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679045365"><span class="hs-identifier hs-var">encode</span></a><span> </span><a href="#local-6989586621679045367"><span class="hs-identifier hs-var">tok</span></a><span> </span><a href="#local-6989586621679045368"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span>
</span><a name="line-150"></a><span>      </span><span class="hs-identifier">decode</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679045369"><a href="#local-6989586621679045369"><span class="hs-identifier">tok</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#isoDecodeStep"><span class="hs-identifier hs-var">isoDecodeStep</span></a><span> </span><a href="#local-6989586621679045363"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679045364"><span class="hs-identifier hs-var">finv</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679045366"><span class="hs-identifier hs-var">decode</span></a><span> </span><a href="#local-6989586621679045369"><span class="hs-identifier hs-var">tok</span></a><span>
</span><a name="line-151"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-identifier">mapFailureCodec</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679045345"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-155"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045346"><span class="hs-identifier hs-type">failure</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045347"><span class="hs-identifier hs-type">failure'</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045348"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045346"><span class="hs-identifier hs-type">failure</span></a><span>  </span><a href="#local-6989586621679045345"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045349"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045348"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045347"><span class="hs-identifier hs-type">failure'</span></a><span> </span><a href="#local-6989586621679045345"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045349"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-158"></a><a name="mapFailureCodec"><a href="Network.TypedProtocol.Codec.html#mapFailureCodec"><span class="hs-identifier">mapFailureCodec</span></a></a><span> </span><a name="local-6989586621679045370"><a href="#local-6989586621679045370"><span class="hs-identifier">f</span></a></a><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-var">Codec</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679045371"><a href="#local-6989586621679045371"><span class="hs-identifier">encode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679045372"><a href="#local-6989586621679045372"><span class="hs-identifier">decode</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-var">Codec</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-identifier">encode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679045371"><span class="hs-identifier hs-var">encode</span></a><span class="hs-special">,</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-identifier">decode</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679045373"><a href="#local-6989586621679045373"><span class="hs-identifier">tok</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#mapFailureDecodeStep"><span class="hs-identifier hs-var">mapFailureDecodeStep</span></a><span> </span><a href="#local-6989586621679045370"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679045372"><span class="hs-identifier hs-var">decode</span></a><span> </span><a href="#local-6989586621679045373"><span class="hs-identifier hs-var">tok</span></a><span>
</span><a name="line-161"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- The types here are pretty fancy. The decode is polymorphic in the protocol</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- state, but only for kinds that are the same kind as the protocol state.</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- The TheyHaveAgency is a type family that resolves to a singleton, and the</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- result uses existential types to hide the unknown type of the state we're</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- transitioning to.</span><span>
</span><a name="line-168"></a><span class="hs-comment">--</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- Both the Message and TheyHaveAgency data families are indexed on the kind ps</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- which is why it has to be a parameter here, otherwise these type functions</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- are unusable.</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">-- | An incremental decoder with return a value of type @a@.</span><span>
</span><a name="line-175"></a><span class="hs-comment">--</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- This interface is not designed to be used directly for implementing</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- decoders, only for running them. In real applications it is expected to use</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- libraries for text or binary decoding and to implement appropriate wrappers</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- to match up with this incremental decoder interface.</span><span>
</span><a name="line-180"></a><span class="hs-comment">--</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- This style of interface already closely matches that provided by libraries</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- such as @attoparsec@ for text formats, and @binary@, @cereal@ and @cborg@</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- for binary formats.</span><span>
</span><a name="line-184"></a><span class="hs-comment">--</span><span>
</span><a name="line-185"></a><span class="hs-keyword">data</span><span> </span><a name="DecodeStep"><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier">DecodeStep</span></a></a><span> </span><a name="local-6989586621679045270"><a href="#local-6989586621679045270"><span class="hs-identifier">bytes</span></a></a><span> </span><a name="local-6989586621679045271"><a href="#local-6989586621679045271"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045272"><a href="#local-6989586621679045272"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045273"><a href="#local-6989586621679045273"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-comment">-- | The decoder has consumed the available input and needs more</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-comment">-- to continue. Provide @'Just'@ if more input is available and</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-comment">-- @'Nothing'@ otherwise, and you will get a new @'DecodeStep'@.</span><span>
</span><a name="line-190"></a><span>    </span><a name="DecodePartial"><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier">DecodePartial</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679045270"><span class="hs-identifier hs-type">bytes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045272"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045270"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045271"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045272"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045273"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-comment">-- | The decoder has successfully finished. This provides the decoded</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-comment">-- result value plus any unused input.</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DecodeDone"><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier">DecodeDone</span></a></a><span> </span><a href="#local-6989586621679045273"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679045270"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-comment">-- | The decoder ran into an error. The decoder either used</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-comment">-- @'fail'@ or was not provided enough input.</span><span>
</span><a name="line-198"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DecodeFail"><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier">DecodeFail</span></a></a><span> </span><a href="#local-6989586621679045271"><span class="hs-identifier hs-type">failure</span></a><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-identifier">isoDecodeStep</span><span>
</span><a name="line-201"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679045340"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045341"><span class="hs-identifier hs-type">bytes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045342"><span class="hs-identifier hs-type">bytes'</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045342"><span class="hs-identifier hs-type">bytes'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045341"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045341"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045343"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045340"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045344"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045342"><span class="hs-identifier hs-type">bytes'</span></a><span> </span><a href="#local-6989586621679045343"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045340"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045344"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-206"></a><a name="isoDecodeStep"><a href="Network.TypedProtocol.Codec.html#isoDecodeStep"><span class="hs-identifier">isoDecodeStep</span></a></a><span> </span><a name="local-6989586621679045374"><a href="#local-6989586621679045374"><span class="hs-identifier">f</span></a></a><span>  </span><a name="local-6989586621679045375"><a href="#local-6989586621679045375"><span class="hs-identifier">finv</span></a></a><span>  </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><a name="local-6989586621679045376"><a href="#local-6989586621679045376"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#isoDecodeStep"><span class="hs-identifier hs-var">isoDecodeStep</span></a><span> </span><a href="#local-6989586621679045374"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679045375"><span class="hs-identifier hs-var">finv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679045376"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679045375"><span class="hs-identifier hs-var">finv</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span class="hs-identifier">isoDecodeStep</span><span> </span><a name="local-6989586621679045377"><a href="#local-6989586621679045377"><span class="hs-identifier">f</span></a></a><span>  </span><a name="local-6989586621679045378"><a href="#local-6989586621679045378"><span class="hs-identifier">_finv</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a name="local-6989586621679045379"><a href="#local-6989586621679045379"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679045380"><a href="#local-6989586621679045380"><span class="hs-identifier">bytes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a href="#local-6989586621679045379"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679045377"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679045380"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span class="hs-identifier">isoDecodeStep</span><span> </span><a name="local-6989586621679045381"><a href="#local-6989586621679045381"><span class="hs-identifier">_f</span></a></a><span> </span><a name="local-6989586621679045382"><a href="#local-6989586621679045382"><span class="hs-identifier">_finv</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><a name="local-6989586621679045383"><a href="#local-6989586621679045383"><span class="hs-identifier">failure</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><a href="#local-6989586621679045383"><span class="hs-identifier hs-var">failure</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">hoistDecodeStep</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679045334"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045339"><a href="#local-6989586621679045339"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679045335"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045339"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045334"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679045339"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045336"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045337"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045335"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045338"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045336"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045337"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045334"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679045338"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-215"></a><a name="hoistDecodeStep"><a href="Network.TypedProtocol.Codec.html#hoistDecodeStep"><span class="hs-identifier">hoistDecodeStep</span></a></a><span> </span><a name="local-6989586621679045384"><a href="#local-6989586621679045384"><span class="hs-identifier">nat</span></a></a><span> </span><a name="local-6989586621679045385"><a href="#local-6989586621679045385"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679045385"><span class="hs-identifier hs-var">step</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-216"></a><span>  </span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a name="local-6989586621679045386"><a href="#local-6989586621679045386"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679045387"><a href="#local-6989586621679045387"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a href="#local-6989586621679045386"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679045387"><span class="hs-identifier hs-var">mb</span></a><span>
</span><a name="line-217"></a><span>  </span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><a name="local-6989586621679045388"><a href="#local-6989586621679045388"><span class="hs-identifier">fail_AvoidNameShadow</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><a href="#local-6989586621679045388"><span class="hs-identifier hs-var">fail_AvoidNameShadow</span></a><span>
</span><a name="line-218"></a><span>  </span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><a name="local-6989586621679045389"><a href="#local-6989586621679045389"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#hoistDecodeStep"><span class="hs-identifier hs-var">hoistDecodeStep</span></a><span> </span><a href="#local-6989586621679045384"><span class="hs-identifier hs-var">nat</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679045384"><span class="hs-identifier hs-var">nat</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679045389"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-identifier">mapFailureDecodeStep</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679045329"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045330"><span class="hs-identifier hs-type">failure</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045331"><span class="hs-identifier hs-type">failure'</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045332"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045330"><span class="hs-identifier hs-type">failure</span></a><span>  </span><a href="#local-6989586621679045329"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045333"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045332"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045331"><span class="hs-identifier hs-type">failure'</span></a><span> </span><a href="#local-6989586621679045329"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045333"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-225"></a><a name="mapFailureDecodeStep"><a href="Network.TypedProtocol.Codec.html#mapFailureDecodeStep"><span class="hs-identifier">mapFailureDecodeStep</span></a></a><span> </span><a name="local-6989586621679045390"><a href="#local-6989586621679045390"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679045391"><a href="#local-6989586621679045391"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679045391"><span class="hs-identifier hs-var">step</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-226"></a><span>  </span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a name="local-6989586621679045392"><a href="#local-6989586621679045392"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679045393"><a href="#local-6989586621679045393"><span class="hs-identifier">mb</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a href="#local-6989586621679045392"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679045393"><span class="hs-identifier hs-var">mb</span></a><span>
</span><a name="line-227"></a><span>  </span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><a name="local-6989586621679045394"><a href="#local-6989586621679045394"><span class="hs-identifier">failure</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045390"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679045394"><span class="hs-identifier hs-var">failure</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>  </span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><a name="local-6989586621679045395"><a href="#local-6989586621679045395"><span class="hs-identifier">k</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#mapFailureDecodeStep"><span class="hs-identifier hs-var">mapFailureDecodeStep</span></a><span> </span><a href="#local-6989586621679045390"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679045395"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-comment">-- | Each 'Codec' can use whatever @failure@ type is appropriate. This simple</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- exception type is provided for use by simple codecs (e.g. \&quot;identity\&quot;) when</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- nothing more than a 'String' is needed. It is an instance of 'Exception'.</span><span>
</span><a name="line-234"></a><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span class="hs-keyword">data</span><span> </span><a name="CodecFailure"><a href="Network.TypedProtocol.Codec.html#CodecFailure"><span class="hs-identifier">CodecFailure</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CodecFailureOutOfInput"><a href="Network.TypedProtocol.Codec.html#CodecFailureOutOfInput"><span class="hs-identifier">CodecFailureOutOfInput</span></a></a><span>
</span><a name="line-236"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a name="CodecFailure"><a href="Network.TypedProtocol.Codec.html#CodecFailure"><span class="hs-identifier">CodecFailure</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-237"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">-- safe instance with @UndecidableInstances@ in scope</span><span>
</span><a name="line-240"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Network.TypedProtocol.Codec.html#CodecFailure"><span class="hs-identifier hs-type">CodecFailure</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-comment">--</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- Running decoders</span><span>
</span><a name="line-245"></a><span class="hs-comment">--</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">-- | Run a codec incremental decoder 'DecodeStep' against a list of input.</span><span>
</span><a name="line-248"></a><span class="hs-comment">--</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- It ignores any unused trailing data. This is useful for demos, quick</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- experiments and tests.</span><span>
</span><a name="line-251"></a><span class="hs-comment">--</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- See also 'Network.TypedProtocol.Driver.runDecoderWithChannel'</span><span>
</span><a name="line-253"></a><span class="hs-comment">--</span><span>
</span><a name="line-254"></a><span class="hs-identifier">runDecoder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045325"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-255"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679045326"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">]</span><span>
</span><a name="line-256"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045326"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045327"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045325"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045328"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-257"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045325"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679045327"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045328"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><a name="runDecoder"><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier">runDecoder</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeDone"><span class="hs-identifier hs-var">DecodeDone</span></a><span> </span><a name="local-6989586621679045396"><a href="#local-6989586621679045396"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679045397"><a href="#local-6989586621679045397"><span class="hs-identifier">_trailing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679045396"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span class="hs-identifier">runDecoder</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeFail"><span class="hs-identifier hs-var">DecodeFail</span></a><span> </span><a name="local-6989586621679045398"><a href="#local-6989586621679045398"><span class="hs-identifier">failure</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679045398"><span class="hs-identifier hs-var">failure</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span class="hs-identifier">runDecoder</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><a name="local-6989586621679045399"><a href="#local-6989586621679045399"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679045399"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-261"></a><span class="hs-identifier">runDecoder</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045400"><a href="#local-6989586621679045400"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679045401"><a href="#local-6989586621679045401"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodePartial"><span class="hs-identifier hs-var">DecodePartial</span></a><span> </span><a name="local-6989586621679045402"><a href="#local-6989586621679045402"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679045402"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679045400"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><a href="#local-6989586621679045401"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">-- | A variant of 'runDecoder' that is suitable for \&quot;pure\&quot; monads that have</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- a run function. This includes 'ST', using 'Control.Monad.ST.runST'.</span><span>
</span><a name="line-266"></a><span class="hs-comment">--</span><span>
</span><a name="line-267"></a><span class="hs-identifier">runDecoderPure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045320"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-268"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045324"><a href="#local-6989586621679045324"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679045320"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045324"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045324"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045320"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#DecodeStep"><span class="hs-identifier hs-type">DecodeStep</span></a><span> </span><a href="#local-6989586621679045321"><span class="hs-identifier hs-type">bytes</span></a><span> </span><a href="#local-6989586621679045322"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045320"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045323"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679045321"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">]</span><span>
</span><a name="line-271"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679045322"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045323"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-272"></a><a name="runDecoderPure"><a href="Network.TypedProtocol.Codec.html#runDecoderPure"><span class="hs-identifier">runDecoderPure</span></a></a><span> </span><a name="local-6989586621679045403"><a href="#local-6989586621679045403"><span class="hs-identifier">runM</span></a></a><span> </span><a name="local-6989586621679045404"><a href="#local-6989586621679045404"><span class="hs-identifier">decoder</span></a></a><span> </span><a name="local-6989586621679045405"><a href="#local-6989586621679045405"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679045403"><span class="hs-identifier hs-var">runM</span></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><a href="#local-6989586621679045405"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="#local-6989586621679045404"><span class="hs-identifier hs-var">decoder</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-comment">--</span><span>
</span><a name="line-276"></a><span class="hs-comment">-- Codec properties</span><span>
</span><a name="line-277"></a><span class="hs-comment">--</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">-- | Any message for a protocol, without knowing the protocol state.</span><span>
</span><a name="line-280"></a><span class="hs-comment">--</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- Used at least for 'Eq' instances for messages, but also as a target for an</span><span>
</span><a name="line-282"></a><span class="hs-comment">-- identity codec `Codec ps failure m (AnyMessage ps)` .</span><span>
</span><a name="line-283"></a><span class="hs-comment">--</span><span>
</span><a name="line-284"></a><span class="hs-keyword">data</span><span> </span><a name="AnyMessage"><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier">AnyMessage</span></a></a><span> </span><a name="local-6989586621679045266"><a href="#local-6989586621679045266"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-285"></a><span>     </span><a name="AnyMessage"><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier">AnyMessage</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-6989586621679045267"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045268"><span class="hs-identifier hs-type">st</span></a><span> </span><a href="#local-6989586621679045269"><span class="hs-identifier hs-type">st'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045267"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- requires @UndecidableInstances@ and @QuantifiedConstraints@.</span><span>
</span><a name="line-288"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045284"><a href="#local-6989586621679045284"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679045285"><a href="#local-6989586621679045285"><span class="hs-identifier">st'</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-6989586621679045283"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045284"><span class="hs-identifier hs-type">st</span></a><span> </span><a href="#local-6989586621679045285"><span class="hs-identifier hs-type">st'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045283"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-289"></a><span>    </span><a name="local-8214565720323790323"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a name="local-6989586621679045286"><a href="#local-6989586621679045286"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679045286"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-- | Used to hold the 'PeerHasAgency' state token and a corresponding 'Message'.</span><span>
</span><a name="line-292"></a><span class="hs-comment">--</span><span>
</span><a name="line-293"></a><span class="hs-comment">-- Used where we don't know statically what the state type is, but need the</span><span>
</span><a name="line-294"></a><span class="hs-comment">-- agency and message to match each other.</span><span>
</span><a name="line-295"></a><span class="hs-comment">--</span><span>
</span><a name="line-296"></a><span class="hs-keyword">data</span><span> </span><a name="AnyMessageAndAgency"><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier">AnyMessageAndAgency</span></a></a><span> </span><a name="local-6989586621679045261"><a href="#local-6989586621679045261"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-297"></a><span>  </span><a name="AnyMessageAndAgency"><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier">AnyMessageAndAgency</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679045263"><span class="hs-identifier hs-type">pr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045264"><span class="hs-identifier hs-type">st</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045262"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-6989586621679045262"><span class="hs-identifier hs-type">ps</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045264"><span class="hs-identifier hs-type">st</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045262"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045265"><span class="hs-identifier hs-type">st'</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045262"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045262"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-comment">-- | The 'Codec' round-trip property: decode after encode gives the same</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- message. Every codec must satisfy this property.</span><span>
</span><a name="line-304"></a><span class="hs-comment">--</span><span>
</span><a name="line-305"></a><span class="hs-identifier">prop_codecM</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045316"><a href="#local-6989586621679045316"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621679045317"><a href="#local-6989586621679045317"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045318"><a href="#local-6989586621679045318"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045319"><a href="#local-6989586621679045319"><span class="hs-identifier">bytes</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-307"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045318"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-308"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045316"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045316"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045317"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045318"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045319"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045316"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-312"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045318"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-313"></a><a name="prop_codecM"><a href="Network.TypedProtocol.Codec.html#prop_codecM"><span class="hs-identifier">prop_codecM</span></a></a><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-var">Codec</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679045406"><a href="#local-6989586621679045406"><span class="hs-identifier">encode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679045407"><a href="#local-6989586621679045407"><span class="hs-identifier">decode</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-var">AnyMessageAndAgency</span></a><span> </span><a name="local-6989586621679045408"><a href="#local-6989586621679045408"><span class="hs-identifier">stok</span></a></a><span> </span><a name="local-6989586621679045409"><a href="#local-6989586621679045409"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>    </span><a name="local-6989586621679045410"><a href="#local-6989586621679045410"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679045407"><span class="hs-identifier hs-var">decode</span></a><span> </span><a href="#local-6989586621679045408"><span class="hs-identifier hs-var">stok</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679045406"><span class="hs-identifier hs-var">encode</span></a><span> </span><a href="#local-6989586621679045408"><span class="hs-identifier hs-var">stok</span></a><span> </span><a href="#local-6989586621679045409"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">]</span><span>
</span><a name="line-315"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679045410"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-316"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-var">SomeMessage</span></a><span> </span><a name="local-6989586621679045411"><a href="#local-6989586621679045411"><span class="hs-identifier">msg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a href="#local-6989586621679045411"><span class="hs-identifier hs-var">msg'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a href="#local-6989586621679045409"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-317"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- | The 'Codec' round-trip property in a pure monad.</span><span>
</span><a name="line-320"></a><span class="hs-comment">--</span><span>
</span><a name="line-321"></a><span class="hs-identifier">prop_codec</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045311"><a href="#local-6989586621679045311"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621679045312"><a href="#local-6989586621679045312"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045313"><a href="#local-6989586621679045313"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045314"><a href="#local-6989586621679045314"><span class="hs-identifier">bytes</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-323"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045313"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045311"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045315"><a href="#local-6989586621679045315"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679045313"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045315"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045315"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045311"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045312"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045313"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045314"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-326"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045311"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-327"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-328"></a><a name="prop_codec"><a href="Network.TypedProtocol.Codec.html#prop_codec"><span class="hs-identifier">prop_codec</span></a></a><span> </span><a name="local-6989586621679045412"><a href="#local-6989586621679045412"><span class="hs-identifier">runM</span></a></a><span> </span><a name="local-6989586621679045413"><a href="#local-6989586621679045413"><span class="hs-identifier">codec</span></a></a><span> </span><a name="local-6989586621679045414"><a href="#local-6989586621679045414"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-329"></a><span>    </span><a href="#local-6989586621679045412"><span class="hs-identifier hs-var">runM</span></a><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#prop_codecM"><span class="hs-identifier hs-var">prop_codecM</span></a><span> </span><a href="#local-6989586621679045413"><span class="hs-identifier hs-var">codec</span></a><span> </span><a href="#local-6989586621679045414"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-comment">-- | A variant on the codec round-trip property: given the encoding of a</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- message, check that decode always gives the same result irrespective</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- of how the chunks of input are fed to the incremental decoder.</span><span>
</span><a name="line-335"></a><span class="hs-comment">--</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- This property guards against boundary errors in incremental decoders.</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- It is not necessary to check this for every message type, just for each</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- generic codec construction. For example given some binary serialisation</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- library one would write a generic adaptor to the codec interface. This</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- adaptor has to deal with the incremental decoding and this is what needs</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- to be checked.</span><span>
</span><a name="line-342"></a><span class="hs-comment">--</span><span>
</span><a name="line-343"></a><span class="hs-identifier">prop_codec_splitsM</span><span>
</span><a name="line-344"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045307"><a href="#local-6989586621679045307"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621679045308"><a href="#local-6989586621679045308"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045309"><a href="#local-6989586621679045309"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045310"><a href="#local-6989586621679045310"><span class="hs-identifier">bytes</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-345"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045309"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045307"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045310"><span class="hs-identifier hs-type">bytes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="#local-6989586621679045310"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- ^ alternative re-chunkings of serialised form</span><span>
</span><a name="line-347"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045307"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045308"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045309"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045310"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045307"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045309"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-350"></a><a name="prop_codec_splitsM"><a href="Network.TypedProtocol.Codec.html#prop_codec_splitsM"><span class="hs-identifier">prop_codec_splitsM</span></a></a><span> </span><a name="local-6989586621679045415"><a href="#local-6989586621679045415"><span class="hs-identifier">splits</span></a></a><span>
</span><a name="line-351"></a><span>                  </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-var">Codec</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679045416"><a href="#local-6989586621679045416"><span class="hs-identifier">encode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679045417"><a href="#local-6989586621679045417"><span class="hs-identifier">decode</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-var">AnyMessageAndAgency</span></a><span> </span><a name="local-6989586621679045418"><a href="#local-6989586621679045418"><span class="hs-identifier">stok</span></a></a><span> </span><a name="local-6989586621679045419"><a href="#local-6989586621679045419"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-352"></a><span>    </span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">sequence</span><span>
</span><a name="line-353"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679046548"><a href="#local-6989586621679046548"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679045417"><span class="hs-identifier hs-var">decode</span></a><span> </span><a href="#local-6989586621679045418"><span class="hs-identifier hs-var">stok</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><a href="#local-6989586621679046547"><span class="hs-identifier hs-var">bytes'</span></a><span>
</span><a name="line-354"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679046548"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-355"></a><span>             </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-var">SomeMessage</span></a><span> </span><a name="local-6989586621679046549"><a href="#local-6989586621679046549"><span class="hs-identifier">msg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a href="#local-6989586621679046549"><span class="hs-identifier hs-var">msg'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a href="#local-6989586621679045419"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-356"></a><span>             </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679046546"><a href="#local-6989586621679046546"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679045416"><span class="hs-identifier hs-var">encode</span></a><span> </span><a href="#local-6989586621679045418"><span class="hs-identifier hs-var">stok</span></a><span> </span><a href="#local-6989586621679045419"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-359"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679046547"><a href="#local-6989586621679046547"><span class="hs-identifier">bytes'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679045415"><span class="hs-identifier hs-var">splits</span></a><span> </span><a href="#local-6989586621679046546"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">-- | Like @'prop_codec_splitsM'@ but run in a pure monad @m@, e.g. @Identity@.</span><span>
</span><a name="line-363"></a><span class="hs-comment">--</span><span>
</span><a name="line-364"></a><span class="hs-identifier">prop_codec_splits</span><span>
</span><a name="line-365"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045302"><a href="#local-6989586621679045302"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621679045303"><a href="#local-6989586621679045303"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045304"><a href="#local-6989586621679045304"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045305"><a href="#local-6989586621679045305"><span class="hs-identifier">bytes</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-366"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045304"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045302"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679045305"><span class="hs-identifier hs-type">bytes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="#local-6989586621679045305"><span class="hs-identifier hs-type">bytes</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045306"><a href="#local-6989586621679045306"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679045304"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045306"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045306"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045302"><span class="hs-identifier hs-type">ps</span></a><span> </span><a href="#local-6989586621679045303"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045304"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045305"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-370"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045302"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-372"></a><a name="prop_codec_splits"><a href="Network.TypedProtocol.Codec.html#prop_codec_splits"><span class="hs-identifier">prop_codec_splits</span></a></a><span> </span><a name="local-6989586621679046550"><a href="#local-6989586621679046550"><span class="hs-identifier">splits</span></a></a><span> </span><a name="local-6989586621679046551"><a href="#local-6989586621679046551"><span class="hs-identifier">runM</span></a></a><span> </span><a name="local-6989586621679046552"><a href="#local-6989586621679046552"><span class="hs-identifier">codec</span></a></a><span> </span><a name="local-6989586621679046553"><a href="#local-6989586621679046553"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-373"></a><span>    </span><a href="#local-6989586621679046551"><span class="hs-identifier hs-var">runM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec_splitsM"><span class="hs-identifier hs-var">prop_codec_splitsM</span></a><span> </span><a href="#local-6989586621679046550"><span class="hs-identifier hs-var">splits</span></a><span> </span><a href="#local-6989586621679046552"><span class="hs-identifier hs-var">codec</span></a><span> </span><a href="#local-6989586621679046553"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-comment">-- | Auxiliary definition for 'prop_codec_binary_compatM'.</span><span>
</span><a name="line-377"></a><span class="hs-comment">--</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- Used for the existential @st :: ps@ parameter when expressing that for each</span><span>
</span><a name="line-379"></a><span class="hs-comment">-- value of 'PeerHasAgency' for protocol A, there is a corresponding</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- 'PeerHasAgency' for protocol B of some @st :: ps@.</span><span>
</span><a name="line-381"></a><span class="hs-keyword">data</span><span> </span><a name="SamePeerHasAgency"><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier">SamePeerHasAgency</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679045256"><a href="#local-6989586621679045256"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045257"><a href="#local-6989586621679045257"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator">*</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-382"></a><span>  </span><a name="SamePeerHasAgency"><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier">SamePeerHasAgency</span></a></a><span>
</span><a name="line-383"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045259"><a href="#local-6989586621679045259"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679045260"><a href="#local-6989586621679045260"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045258"><span class="hs-identifier hs-type">ps</span></a><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><a name="line-384"></a><span>       </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679045259"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045260"><span class="hs-identifier hs-type">st</span></a><span>
</span><a name="line-385"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier hs-type">SamePeerHasAgency</span></a><span> </span><a href="#local-6989586621679045259"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045258"><span class="hs-identifier hs-type">ps</span></a><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-- | Binary compatibility of two protocols</span><span>
</span><a name="line-388"></a><span class="hs-comment">--</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- We check the following property:</span><span>
</span><a name="line-390"></a><span class="hs-comment">--</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- 1. Using codec A, we encode a message of protocol @psA@ to @bytes@.</span><span>
</span><a name="line-392"></a><span class="hs-comment">--</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- 2. When we decode those @bytes@ using codec B, we get a message of protocol</span><span>
</span><a name="line-394"></a><span class="hs-comment">-- @ps@B.</span><span>
</span><a name="line-395"></a><span class="hs-comment">--</span><span>
</span><a name="line-396"></a><span class="hs-comment">-- 3. When we encode that message again using codec B, we get @bytes@.</span><span>
</span><a name="line-397"></a><span class="hs-comment">--</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- 4. When we decode those @bytes@ using codec A, we get the original message</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- again.</span><span>
</span><a name="line-400"></a><span class="hs-identifier">prop_codec_binary_compatM</span><span>
</span><a name="line-401"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045295"><a href="#local-6989586621679045295"><span class="hs-identifier">psA</span></a></a><span> </span><a name="local-6989586621679045296"><a href="#local-6989586621679045296"><span class="hs-identifier">psB</span></a></a><span> </span><a name="local-6989586621679045297"><a href="#local-6989586621679045297"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045298"><a href="#local-6989586621679045298"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045299"><a href="#local-6989586621679045299"><span class="hs-identifier">bytes</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-402"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045298"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-403"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045295"><span class="hs-identifier hs-type">psA</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045295"><span class="hs-identifier hs-type">psA</span></a><span> </span><a href="#local-6989586621679045297"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045298"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045299"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-406"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045296"><span class="hs-identifier hs-type">psB</span></a><span> </span><a href="#local-6989586621679045297"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045298"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045299"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-407"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045300"><a href="#local-6989586621679045300"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679045301"><a href="#local-6989586621679045301"><span class="hs-identifier">stA</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045295"><span class="hs-identifier hs-type">psA</span></a><span class="hs-special">)</span><span class="hs-operator">.</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679045300"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045301"><span class="hs-identifier hs-type">stA</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier hs-type">SamePeerHasAgency</span></a><span> </span><a href="#local-6989586621679045300"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045296"><span class="hs-identifier hs-type">psB</span></a><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>     </span><span class="hs-comment">-- ^ The states of A map directly of states of B.</span><span>
</span><a name="line-409"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045295"><span class="hs-identifier hs-type">psA</span></a><span>
</span><a name="line-410"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045298"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-411"></a><a name="prop_codec_binary_compatM"><a href="Network.TypedProtocol.Codec.html#prop_codec_binary_compatM"><span class="hs-identifier">prop_codec_binary_compatM</span></a></a><span>
</span><a name="line-412"></a><span>    </span><a name="local-6989586621679046554"><a href="#local-6989586621679046554"><span class="hs-identifier">codecA</span></a></a><span> </span><a name="local-6989586621679046555"><a href="#local-6989586621679046555"><span class="hs-identifier">codecB</span></a></a><span> </span><a name="local-6989586621679046556"><a href="#local-6989586621679046556"><span class="hs-identifier">stokEq</span></a></a><span>
</span><a name="line-413"></a><span>    </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-var">AnyMessageAndAgency</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679046559"><a href="#local-6989586621679046559"><span class="hs-identifier">stokA</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679046557"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679046558"><span class="hs-identifier hs-type">stA</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679046560"><a href="#local-6989586621679046560"><span class="hs-identifier">msgA</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-414"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679046556"><span class="hs-identifier hs-var">stokEq</span></a><span> </span><a href="#local-6989586621679046559"><span class="hs-identifier hs-var">stokA</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-415"></a><span>    </span><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier hs-var">SamePeerHasAgency</span></a><span> </span><a name="local-6989586621679046561"><a href="#local-6989586621679046561"><span class="hs-identifier">stokB</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-416"></a><span>      </span><span class="hs-comment">-- 1.</span><span>
</span><a name="line-417"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679046562"><a href="#local-6989586621679046562"><span class="hs-identifier">bytesA</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">encode</span><span> </span><a href="#local-6989586621679046554"><span class="hs-identifier hs-var">codecA</span></a><span> </span><a href="#local-6989586621679046559"><span class="hs-identifier hs-var">stokA</span></a><span> </span><a href="#local-6989586621679046560"><span class="hs-identifier hs-var">msgA</span></a><span>
</span><a name="line-418"></a><span>      </span><span class="hs-comment">-- 2.</span><span>
</span><a name="line-419"></a><span>      </span><a name="local-6989586621679046563"><a href="#local-6989586621679046563"><span class="hs-identifier">r1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">decode</span><span> </span><a href="#local-6989586621679046555"><span class="hs-identifier hs-var">codecB</span></a><span> </span><a href="#local-6989586621679046561"><span class="hs-identifier hs-var">stokB</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679046562"><span class="hs-identifier hs-var">bytesA</span></a><span class="hs-special">]</span><span>
</span><a name="line-420"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679046563"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-421"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-422"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-var">SomeMessage</span></a><span> </span><a name="local-6989586621679046564"><a href="#local-6989586621679046564"><span class="hs-identifier">msgB</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-423"></a><span>          </span><span class="hs-comment">-- 3.</span><span>
</span><a name="line-424"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679046565"><a href="#local-6989586621679046565"><span class="hs-identifier">bytesB</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">encode</span><span> </span><a href="#local-6989586621679046555"><span class="hs-identifier hs-var">codecB</span></a><span> </span><a href="#local-6989586621679046561"><span class="hs-identifier hs-var">stokB</span></a><span> </span><a href="#local-6989586621679046564"><span class="hs-identifier hs-var">msgB</span></a><span>
</span><a name="line-425"></a><span>          </span><span class="hs-comment">-- 4.</span><span>
</span><a name="line-426"></a><span>          </span><a name="local-6989586621679046566"><a href="#local-6989586621679046566"><span class="hs-identifier">r2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">decode</span><span> </span><a href="#local-6989586621679046554"><span class="hs-identifier hs-var">codecA</span></a><span> </span><a href="#local-6989586621679046559"><span class="hs-identifier hs-var">stokA</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Network.TypedProtocol.Codec.html#runDecoder"><span class="hs-identifier hs-var">runDecoder</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679046565"><span class="hs-identifier hs-var">bytesB</span></a><span class="hs-special">]</span><span>
</span><a name="line-427"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679046566"><span class="hs-identifier hs-var">r2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-428"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-429"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Driver.html#SomeMessage"><span class="hs-identifier hs-var">SomeMessage</span></a><span> </span><a name="local-6989586621679046567"><a href="#local-6989586621679046567"><span class="hs-identifier">msgA'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a href="#local-6989586621679046567"><span class="hs-identifier hs-var">msgA'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-var">AnyMessage</span></a><span> </span><a href="#local-6989586621679046560"><span class="hs-identifier hs-var">msgA</span></a><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-- | Like @'prop_codec_splitsM'@ but run in a pure monad @m@, e.g. @Identity@.</span><span>
</span><a name="line-432"></a><span class="hs-identifier">prop_codec_binary_compat</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045287"><a href="#local-6989586621679045287"><span class="hs-identifier">psA</span></a></a><span> </span><a name="local-6989586621679045288"><a href="#local-6989586621679045288"><span class="hs-identifier">psB</span></a></a><span> </span><a name="local-6989586621679045289"><a href="#local-6989586621679045289"><span class="hs-identifier">failure</span></a></a><span> </span><a name="local-6989586621679045290"><a href="#local-6989586621679045290"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679045291"><a href="#local-6989586621679045291"><span class="hs-identifier">bytes</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-434"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679045290"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-435"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.TypedProtocol.Codec.html#AnyMessage"><span class="hs-identifier hs-type">AnyMessage</span></a><span> </span><a href="#local-6989586621679045287"><span class="hs-identifier hs-type">psA</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045292"><a href="#local-6989586621679045292"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679045290"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045292"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679045292"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045287"><span class="hs-identifier hs-type">psA</span></a><span> </span><a href="#local-6989586621679045289"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045290"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045291"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-439"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#Codec"><span class="hs-identifier hs-type">Codec</span></a><span> </span><a href="#local-6989586621679045288"><span class="hs-identifier hs-type">psB</span></a><span> </span><a href="#local-6989586621679045289"><span class="hs-identifier hs-type">failure</span></a><span> </span><a href="#local-6989586621679045290"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679045291"><span class="hs-identifier hs-type">bytes</span></a><span>
</span><a name="line-440"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679045293"><a href="#local-6989586621679045293"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679045294"><a href="#local-6989586621679045294"><span class="hs-identifier">stA</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679045287"><span class="hs-identifier hs-type">psA</span></a><span class="hs-special">)</span><span class="hs-operator">.</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src/Network.TypedProtocol.Core.html#PeerHasAgency"><span class="hs-identifier hs-type">PeerHasAgency</span></a><span> </span><a href="#local-6989586621679045293"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045294"><span class="hs-identifier hs-type">stA</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#SamePeerHasAgency"><span class="hs-identifier hs-type">SamePeerHasAgency</span></a><span> </span><a href="#local-6989586621679045293"><span class="hs-identifier hs-type">pr</span></a><span> </span><a href="#local-6989586621679045288"><span class="hs-identifier hs-type">psB</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.TypedProtocol.Codec.html#AnyMessageAndAgency"><span class="hs-identifier hs-type">AnyMessageAndAgency</span></a><span> </span><a href="#local-6989586621679045287"><span class="hs-identifier hs-type">psA</span></a><span>
</span><a name="line-442"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-443"></a><a name="prop_codec_binary_compat"><a href="Network.TypedProtocol.Codec.html#prop_codec_binary_compat"><span class="hs-identifier">prop_codec_binary_compat</span></a></a><span> </span><a name="local-6989586621679046568"><a href="#local-6989586621679046568"><span class="hs-identifier">runM</span></a></a><span> </span><a name="local-6989586621679046569"><a href="#local-6989586621679046569"><span class="hs-identifier">codecA</span></a></a><span> </span><a name="local-6989586621679046570"><a href="#local-6989586621679046570"><span class="hs-identifier">codecB</span></a></a><span> </span><a name="local-6989586621679046571"><a href="#local-6989586621679046571"><span class="hs-identifier">stokEq</span></a></a><span> </span><a name="local-6989586621679046572"><a href="#local-6989586621679046572"><span class="hs-identifier">msgA</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-444"></a><span>     </span><a href="#local-6989586621679046568"><span class="hs-identifier hs-var">runM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TypedProtocol.Codec.html#prop_codec_binary_compatM"><span class="hs-identifier hs-var">prop_codec_binary_compatM</span></a><span> </span><a href="#local-6989586621679046569"><span class="hs-identifier hs-var">codecA</span></a><span> </span><a href="#local-6989586621679046570"><span class="hs-identifier hs-var">codecB</span></a><span> </span><a href="#local-6989586621679046571"><span class="hs-identifier hs-var">stokEq</span></a><span> </span><a href="#local-6989586621679046572"><span class="hs-identifier hs-var">msgA</span></a><span>
</span><a name="line-445"></a></pre></body></html>