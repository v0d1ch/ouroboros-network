<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Exported for testing purposes</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Operations involving chain selection: the initial chain selection and
 adding a block.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:initialChainSelection">initialChainSelection</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-ImmDB.html#t:ImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.ImmDB">ImmDB</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-VolDB.html#t:VolDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.VolDB">VolDB</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-LgrDB.html#t:LgrDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB">LgrDB</a> m blk &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceEvent</a> blk) &#8594; <a href="Ouroboros-Consensus-Config.html#t:TopLevelConfig" title="Ouroboros.Consensus.Config">TopLevelConfig</a> blk &#8594; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m (<a href="Ouroboros-Consensus-Util-STM.html#t:WithFingerprint" title="Ouroboros.Consensus.Util.STM">WithFingerprint</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:InvalidBlocks" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">InvalidBlocks</a> blk)) &#8594; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:FutureBlocks" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">FutureBlocks</a> blk) &#8594; <a href="Ouroboros-Consensus-Fragment-InFuture.html#t:CheckInFuture" title="Ouroboros.Consensus.Fragment.InFuture">CheckInFuture</a> m blk &#8594; m (ChainAndLedger blk)</li><li class="src short"><a href="#v:addBlockAsync">addBlockAsync</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; blk &#8594; m (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:AddBlockPromise" title="Ouroboros.Consensus.Storage.ChainDB.API">AddBlockPromise</a> m blk)</li><li class="src short"><a href="#v:addBlockSync">addBlockSync</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:BlockToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">BlockToAdd</a> m blk &#8594; m ()</li><li class="src short"><a href="#v:chainSelectionForBlock">chainSelectionForBlock</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-BlockCache.html#t:BlockCache" title="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache">BlockCache</a> blk &#8594; <a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk &#8594; m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:Point" title="Ouroboros.Network.Block">Point</a> blk)</li><li class="src short"><a href="#v:olderThanK">olderThanK</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8658; <a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk &#8594; <a href="Ouroboros-Consensus-Block-EBB.html#t:IsEBB" title="Ouroboros.Consensus.Block.EBB">IsEBB</a> &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Slot.html#t:WithOrigin" title="Cardano.Slotting.Slot">WithOrigin</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Block.html#t:BlockNo" title="Cardano.Slotting.Block">BlockNo</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:initialChainSelection" class="def">initialChainSelection</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-ImmDB.html#t:ImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.ImmDB">ImmDB</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-VolDB.html#t:VolDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.VolDB">VolDB</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-LgrDB.html#t:LgrDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB">LgrDB</a> m blk &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceEvent</a> blk) &#8594; <a href="Ouroboros-Consensus-Config.html#t:TopLevelConfig" title="Ouroboros.Consensus.Config">TopLevelConfig</a> blk &#8594; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m (<a href="Ouroboros-Consensus-Util-STM.html#t:WithFingerprint" title="Ouroboros.Consensus.Util.STM">WithFingerprint</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:InvalidBlocks" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">InvalidBlocks</a> blk)) &#8594; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:FutureBlocks" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">FutureBlocks</a> blk) &#8594; <a href="Ouroboros-Consensus-Fragment-InFuture.html#t:CheckInFuture" title="Ouroboros.Consensus.Fragment.InFuture">CheckInFuture</a> m blk &#8594; m (ChainAndLedger blk) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection" class="link">Source</a> <a href="#v:initialChainSelection" class="selflink">#</a></p><div class="doc"><p>Perform the initial chain selection based on the tip of the ImmutableDB
 and the contents of the VolatileDB.</p><p>Returns the chosen validated chain and corresponding ledger.</p><p>See &quot;## Initialization&quot; in ChainDB.md.</p></div></div><div class="top"><p class="src"><a id="v:addBlockAsync" class="def">addBlockAsync</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; blk &#8594; m (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:AddBlockPromise" title="Ouroboros.Consensus.Storage.ChainDB.API">AddBlockPromise</a> m blk) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync" class="link">Source</a> <a href="#v:addBlockAsync" class="selflink">#</a></p><div class="doc"><p>Add a block to the ChainDB, <em>asynchronously</em>.</p><p>This adds a <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:BlockToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">BlockToAdd</a></code> corresponding to the given block to the
 <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbBlocksToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbBlocksToAdd</a></code> queue. The entries in that queue are processed using
 <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-ChainSel.html#v:addBlockSync" title="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel">addBlockSync</a></code>, see that function for more information.</p><p>When the queue is full, this function will still block.</p><p>An important advantage of this asynchronous approach over a synchronous
 approach is that it doesn't have the following disadvantage: when a thread
 adding a block to the ChainDB is killed, which can happen when
 disconnecting from the corresponding node, we might have written the block
 to disk, but not updated the corresponding in-memory state (e.g., that of
 the VolatileDB), leaving both out of sync.</p><p>With this asynchronous approach, threads adding blocks asynchronously can
 be killed without worries, the background thread processing the blocks
 synchronously won't be killed. Only when the whole ChainDB shuts down will
 that background thread get killed. But since there will be no more
 in-memory state, it can't get out of sync with the file system state. On
 the next startup, a correct in-memory state will be reconstructed from the
 file system state.</p></div></div><div class="top"><p class="src"><a id="v:addBlockSync" class="def">addBlockSync</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:BlockToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">BlockToAdd</a> m blk &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync" class="link">Source</a> <a href="#v:addBlockSync" class="selflink">#</a></p><div class="doc"><p>Add a block to the ChainDB, <em>synchronously</em>.</p><p>This is the only operation that actually changes the ChainDB. It will store
 the block on disk and trigger chain selection, possibly switching to a
 fork.</p><p>When the slot of the block is &gt; the current slot, a chain selection will be
 scheduled in the slot of the block.</p></div></div><div class="top"><p class="src"><a id="v:chainSelectionForBlock" class="def">chainSelectionForBlock</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-BlockCache.html#t:BlockCache" title="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache">BlockCache</a> blk &#8594; <a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk &#8594; m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:Point" title="Ouroboros.Network.Block">Point</a> blk) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock" class="link">Source</a> <a href="#v:chainSelectionForBlock" class="selflink">#</a></p><div class="doc"><p>Trigger chain selection for the given block.</p><p>PRECONDITION: the block is in the VolatileDB.</p><p>PRECONDITION: the slot of the block &lt;= the current (wall) slot</p><p>The new tip of the current chain is returned.</p><h1>Constructing candidate fragments</h1><p>The VolatileDB keeps a &quot;successors&quot; map in memory, telling us the hashes
 of the known successors of any block, but it does not keep <em>headers</em> in
 memory, which are needed to construct candidate fargments. We try to reuse
 the headers from the current chain fragment where possible, but it will not
 contain all needed headers. This means that we will need to read some
 blocks from disk and extract their headers. Under normal circumstances this
 does not matter too much; although this will be done every time we add a
 block, the expected number of headers to read from disk is very small:</p><ul><li>None if we stay on the current chain and this is just the next block</li><li>A handful if we stay on the current chain and the block we just received
   was a missing block and we already received some of its successors</li><li>A handful if we switch to a short fork</li></ul><p>This is expensive only</p><ul><li>on startup: in this case we need to read at least <code>k</code> blocks from the
   VolatileDB, and possibly more if there are some other chains in the
   VolatileDB starting from the tip of the ImmutableDB</li><li>when we switch to a distant fork</li></ul><p>This cost is currently deemed acceptable.</p></div></div><a href="#g:1" id="g:1"><h1>Exported for testing purposes</h1></a><div class="top"><p class="src"><a id="v:olderThanK" class="def">olderThanK</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK" class="link">Source</a> <a href="#v:olderThanK" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk</td><td class="doc"><p>Header of the block to add</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Block-EBB.html#t:IsEBB" title="Ouroboros.Consensus.Block.EBB">IsEBB</a></td><td class="doc"><p>Whether the block is an EBB or not</p></td></tr><tr><td class="src">&#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Slot.html#t:WithOrigin" title="Cardano.Slotting.Slot">WithOrigin</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Block.html#t:BlockNo" title="Cardano.Slotting.Block">BlockNo</a></td><td class="doc"><p>The block number of the most recent &quot;immutable&quot; block, i.e., the
 block <code>k</code> blocks back.</p></td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Return <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:True" title="Data.Bool">True</a></code> when the given header should be ignored when adding it
 because it is too old, i.e., we wouldn't be able to switch to a chain
 containing the corresponding block because its block number is more than
 <code>k</code> blocks or exactly <code>k</code> blocks back.</p><p>Special case: the header corresponds to an EBB which has the same block
 number as the block <code>k</code> blocks back (the most recent &quot;immutable&quot; block).
 As EBBs share their block number with the block before them, the EBB is not
 too old in that case and can be adopted as part of our chain.</p><p>This special case can occur, for example, when the VolatileDB is empty
 (because of corruption). The &quot;immutable&quot; block is then also the tip of
 the chain. If we then try to add the EBB after it, it will have the same
 block number, so we must allow it.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>