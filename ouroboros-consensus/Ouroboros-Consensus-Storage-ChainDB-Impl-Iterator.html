<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Exported for testing purposes</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Iterators</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:stream">stream</a> &#8759; &#8704; m blk b. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbHandle" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbHandle</a> m blk &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-Common.html#t:BlockComponent" title="Ouroboros.Consensus.Storage.Common">BlockComponent</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:ChainDB" title="Ouroboros.Consensus.Storage.ChainDB.API">ChainDB</a> m blk) b &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamFrom" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamFrom</a> blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamTo" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamTo</a> blk &#8594; m (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:UnknownRange" title="Ouroboros.Consensus.Storage.ChainDB.API">UnknownRange</a> blk) (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:Iterator" title="Ouroboros.Consensus.Storage.ChainDB.API">Iterator</a> m blk b))</li><li class="src short"><a href="#v:closeAllIterators">closeAllIterators</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m ()</li><li class="src short"><span class="keyword">data</span> <a href="#t:IteratorEnv">IteratorEnv</a> m blk = <a href="#v:IteratorEnv">IteratorEnv</a> {<ul class="subs"><li><a href="#v:itImmDB">itImmDB</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-ImmDB.html#t:ImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.ImmDB">ImmDB</a> m blk</li><li><a href="#v:itVolDB">itVolDB</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-VolDB.html#t:VolDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.VolDB">VolDB</a> m blk</li><li><a href="#v:itIterators">itIterators</a> &#8759; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-Base.html#t:Map" title="Cardano.Prelude.Base">Map</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:IteratorKey" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">IteratorKey</a> (m ()))</li><li><a href="#v:itNextIteratorKey">itNextIteratorKey</a> &#8759; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:IteratorKey" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">IteratorKey</a></li><li><a href="#v:itTracer">itTracer</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceIteratorEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceIteratorEvent</a> blk)</li></ul>}</li><li class="src short"><a href="#v:newIterator">newIterator</a> &#8759; &#8704; m blk b. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Iterator.html#t:IteratorEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator">IteratorEnv</a> m blk &#8594; (&#8704; r. (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Iterator.html#t:IteratorEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator">IteratorEnv</a> m blk &#8594; m r) &#8594; m r) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-Common.html#t:BlockComponent" title="Ouroboros.Consensus.Storage.Common">BlockComponent</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:ChainDB" title="Ouroboros.Consensus.Storage.ChainDB.API">ChainDB</a> m blk) b &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamFrom" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamFrom</a> blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamTo" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamTo</a> blk &#8594; m (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:UnknownRange" title="Ouroboros.Consensus.Storage.ChainDB.API">UnknownRange</a> blk) (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:Iterator" title="Ouroboros.Consensus.Storage.ChainDB.API">Iterator</a> m blk b))</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:stream" class="def">stream</a> &#8759; &#8704; m blk b. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbHandle" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbHandle</a> m blk &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-Common.html#t:BlockComponent" title="Ouroboros.Consensus.Storage.Common">BlockComponent</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:ChainDB" title="Ouroboros.Consensus.Storage.ChainDB.API">ChainDB</a> m blk) b &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamFrom" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamFrom</a> blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamTo" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamTo</a> blk &#8594; m (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:UnknownRange" title="Ouroboros.Consensus.Storage.ChainDB.API">UnknownRange</a> blk) (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:Iterator" title="Ouroboros.Consensus.Storage.ChainDB.API">Iterator</a> m blk b)) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html#stream" class="link">Source</a> <a href="#v:stream" class="selflink">#</a></p><div class="doc"><p>Stream blocks</p><h1>Start &amp; end point</h1><p>The start point can either be in the ImmutableDB (on our chain) or in the
 VolatileDB (on our chain or on a recent fork). We first check whether it is
 in the VolatileDB, if not, we check if it is in the ImmutableDB (see
 &quot;Garbage collection&quot; for why this order is important). Similarly for the
 end point.</p><p>If a bound can't be found in the ChainDB, an <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:UnknownRange" title="Ouroboros.Consensus.Storage.ChainDB.API">UnknownRange</a></code> error is
 returned.</p><p>When the bounds are nonsensical, e.g.,
 &gt; StreamFromExclusive (Point { pointSlot = SlotNo 3 , .. }
 &gt; StreamToInclusive   (Point { pointSlot = SlotNo 3 , .. }
 An <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#v:InvalidIteratorRange" title="Ouroboros.Consensus.Storage.ChainDB.API">InvalidIteratorRange</a></code> exception is thrown.</p><h1>Paths of blocks</h1><p>To stream blocks from the ImmutableDB we can simply use the iterators
 offered by the ImmutableDB.</p><p>To stream blocks from the VolatileDB we have to construct a path of block
 hashes backwards through the VolatileDB, starting from the end point using
 <code>getPredecessor</code> until we get to the start point, genesis, or we get to a
 block that is not in the VolatileDB. Then, for each hash in the path, we
 can ask the VolatileDB for the corresponding block.</p><p>If the path through the VolatileDB is incomplete, we will first have to
 stream blocks from the ImmutableDB and then switch to the path through the
 VolatileDB. We only allow the tip of the ImmutableDB to be the switchover
 point between the two DBs. In other words, the incomplete path through the
 VolatileDB must fit onto the tip of the ImmutableDB. This must be true at
 the time of initialising the iterator, but does not have to hold during the
 whole lifetime of the iterator. If it doesn't fit on it, it means the path
 forked off more than <code>k</code> blocks in the past and blocks belonging to it are
 more likely to go missing because of garbage-collection (see the next
 paragraph). In that case, we return <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#v:ForkTooOld" title="Ouroboros.Consensus.Storage.ChainDB.API">ForkTooOld</a></code>.</p><h1>Garbage collection</h1><p>We have to be careful about the following: as our chain grows, blocks from
 our chain will be copied to the ImmutableDB in the background. After a
 while, old blocks will be garbage-collected from the VolatileDB. Blocks
 that were part of the current chain will be in the ImmutableDB, but blocks
 that only lived on forks will be gone forever.</p><p>This means that blocks that were part of the VolatileDB when the iterator
 was initialised might no longer be part of the VolatileDB when we come to
 the point that the iterator will try to read them. When this is noticed, we
 will try to open an iterator from the ImmutableDB to obtain the blocks that
 have moved over. However, this will only work if they were and are part of
 the current chain, otherwise they will have been deleted from the
 VolatileDB without being copied to the ImmutableDB.</p><p>This iterator is opened with an open upper bound and will be used to stream
 blocks until the path has been fully streamed, the iterator is exhausted,
 or a block doesn't match the expected hash. In the latter two cases, we
 switch back to the VolatileDB. If the block is missing from the VolatileDB,
 we will switch back to streaming from the ImmutableDB. If that fails, we
 switch back to the VolatileDB. To avoid eternally switching between the two
 DBs, we only switch back to the VolatileDB if the stream from the
 ImmutableDB has made progress, i.e. streamed at least one block with the
 expected hash. If no block was streamed from the ImmutableDB, not even the
 first one, we know for sure that that block isn't part of the VolatileDB
 (the reason we switch to the ImmutableDB) and isn't part of the ImmutableDB
 (no block was streamed). In that case, we return <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#v:IteratorBlockGCed" title="Ouroboros.Consensus.Storage.ChainDB.API">IteratorBlockGCed</a></code> and
 stop the stream.</p><p>Note that the open upper bound doesn't allow us to include blocks in the
 stream that are copied to the ImmutableDB after opening this iterator, as
 the bound of the iterator is fixed upon initialisation. These newly added
 blocks will be included in the stream because we will repeatedly open new
 ImmutableDB iterators (as long as we make progress).</p><h1>Bounds checking</h1><p>The VolatileDB is hash-based instead of point-based. While the bounds of a
 stream are <em>point</em>s, we can simply check whether the hashes of the bounds
 match the hashes stored in the points.</p><p>The ImmutableDB is slot-based instead of point-based, which means that
 before we know whether a block in the ImmutableDB matches a given point, we
 must first read the block at the point's slot to obtain its hash, after
 which we can then verify whether it matches the hash of the point. This is
 important for the start and end bounds (both points) of a stream in case
 they are in the ImmutableDB (i.e., their slots are &lt;= the tip of the
 ImmutableDB): we must first read the blocks corresponding to the bounds to
 be sure the range is valid. Note that these reads happen before the first
 call to <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#v:iteratorNext" title="Ouroboros.Consensus.Storage.ChainDB.API">iteratorNext</a></code> (which will trigger a second read of the first
 block).</p><p>Note that when streaming to an <em>exclusive</em> bound, the block corresponding
 to that bound (<code><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:Point" title="Ouroboros.Network.Block">Point</a></code>) must exist in the ChainDB.</p><h1>Costs</h1><p>Opening an iterator has some costs:</p><ul><li>When blocks have to be streamed from the ImmutableDB: as discussed in
   &quot;Bounds checking&quot;, the blocks corresponding to the bounds have to be
   read from disk.</li><li>When blocks have to be streamed both from the ImmutableDB and the
   VolatileDB, only the block corresponding to the lower bound will have to
   be read from the ImmutableDB upfront, as described in the previous bullet
   point. Note that the block corresponding to the upper bound does not have
   to be read from disk, since it will be in the VolatileDB, which means
   that we know its hash already from the in-memory index.</li></ul><p>In summary:</p><ul><li>Only streaming from the VolatileDB: 0 blocks read upfront.</li><li>Only streaming from the ImmutableDB: 2 blocks read upfront.</li><li>Streaming from both the ImmutableDB and the VolatileDB: 1 block read
   upfront.</li></ul><p>Additionally, when we notice during streaming that a block is no longer in
 the VolatileDB, we try to see whether it can be streamed from the
 ImmutableDB instead. Opening such an iterator (with an exclusive bound) has
 the cost of reading (but not parsing) one extra block from disk, in
 addition to the block(s) we are actually interested in. This can happen
 multiple times. See #548.</p></div></div><div class="top"><p class="src"><a id="v:closeAllIterators" class="def">closeAllIterators</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html#closeAllIterators" class="link">Source</a> <a href="#v:closeAllIterators" class="selflink">#</a></p><div class="doc"><p>Close all open <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:Iterator" title="Ouroboros.Consensus.Storage.ChainDB.API">Iterator</a></code>s.</p><p>This <em>can</em> be called when the ChainDB is already closed.</p></div></div><a href="#g:1" id="g:1"><h1>Exported for testing purposes</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:IteratorEnv" class="def">IteratorEnv</a> m blk <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html#IteratorEnv" class="link">Source</a> <a href="#t:IteratorEnv" class="selflink">#</a></p><div class="doc"><p>Environment containing everything needed to implement iterators.</p><p>The main purpose of bundling these things in a separate record is to make
 it easier to test this code: no need to set up a whole ChainDB, just
 provide this record.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:IteratorEnv" class="def">IteratorEnv</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:itImmDB" class="def">itImmDB</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-ImmDB.html#t:ImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.ImmDB">ImmDB</a> m blk</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:itVolDB" class="def">itVolDB</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-VolDB.html#t:VolDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.VolDB">VolDB</a> m blk</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:itIterators" class="def">itIterators</a> &#8759; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-Base.html#t:Map" title="Cardano.Prelude.Base">Map</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:IteratorKey" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">IteratorKey</a> (m ()))</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:itNextIteratorKey" class="def">itNextIteratorKey</a> &#8759; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:StrictTVar" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">StrictTVar</a> m <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:IteratorKey" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">IteratorKey</a></dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:itTracer" class="def">itTracer</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceIteratorEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceIteratorEvent</a> blk)</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:newIterator" class="def">newIterator</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html#newIterator" class="link">Source</a> <a href="#v:newIterator" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Iterator.html#t:IteratorEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator">IteratorEnv</a> m blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (&#8704; r. (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Iterator.html#t:IteratorEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator">IteratorEnv</a> m blk &#8594; m r) &#8594; m r)</td><td class="doc"><p>Function with which the operations on the returned iterator should
 obtain their <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Iterator.html#t:IteratorEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator">IteratorEnv</a></code>. This function should check whether the
 ChainDB is still open or throw an exception otherwise. This makes sure
 that when we call <code><a href="Ouroboros-Consensus-Storage-ChainDB-API.html#v:iteratorNext" title="Ouroboros.Consensus.Storage.ChainDB.API">iteratorNext</a></code>, we first check whether the ChainDB
 is still open.</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-Common.html#t:BlockComponent" title="Ouroboros.Consensus.Storage.Common">BlockComponent</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:ChainDB" title="Ouroboros.Consensus.Storage.ChainDB.API">ChainDB</a> m blk) b</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamFrom" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamFrom</a> blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:StreamTo" title="Ouroboros.Consensus.Storage.ChainDB.API">StreamTo</a> blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; m (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:UnknownRange" title="Ouroboros.Consensus.Storage.ChainDB.API">UnknownRange</a> blk) (<a href="Ouroboros-Consensus-Storage-ChainDB-API.html#t:Iterator" title="Ouroboros.Consensus.Storage.ChainDB.API">Iterator</a> m blk b))</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>See <code>streamBlocks</code>.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>