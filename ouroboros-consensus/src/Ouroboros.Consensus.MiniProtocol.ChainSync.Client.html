<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns               #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds                  #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass             #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification  #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase                 #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf                 #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns             #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving         #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE TupleSections              #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications           #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances       #-}</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-strictness #-}</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- NOTE: With @-fstrictness@ optimisation (enabled by default for -O1), we get</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- an unexplained thunk in 'KnownIntersectionState' and thus a space leak. See</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- #1356.</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.ChainSync.Client</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier">Consensus</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#chainSyncClient"><span class="hs-identifier">chainSyncClient</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#bracketChainSyncClient"><span class="hs-identifier">bracketChainSyncClient</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier">ChainSyncClientResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier">ChainSyncClientException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier">ChainDbView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#defaultChainDbView"><span class="hs-identifier">defaultChainDbView</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Trace events</span></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier">TraceChainSyncClientEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier">InvalidBlockReason</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Kind</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word64</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HasCallStack</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeNoThunks</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier">Network.TypedProtocol.Pipelined</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">AnchoredFragment</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>                     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">AnchoredSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredSeq</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AS</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Tip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">getTipBlockNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">Ouroboros.Network.Mux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">ControlMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">ControlMessageSTM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.ClientPipelined</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.PipelineDecision</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Config.html"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Forecast.html"><span class="hs-identifier">Ouroboros.Consensus.Forecast</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderStateHistory</span></a></span><span>
</span><span id="line-68"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier">HeaderStateHistory</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#validateHeader"><span class="hs-identifier">validateHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderStateHistory</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HeaderStateHistory</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderValidation</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#validateHeader"><span class="hs-identifier">validateHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerConfig"><span class="hs-identifier">LedgerConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier">LedgerState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#applyChainTick"><span class="hs-identifier">applyChainTick</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#tickThenReapply"><span class="hs-identifier">tickThenReapply</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Node.NetworkProtocolVersion.html"><span class="hs-identifier">Ouroboros.Consensus.Node.NetworkProtocolVersion</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Node.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Node.Types</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Abstract</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Assert.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.Assert.html#assertWithMsg"><span class="hs-identifier">assertWithMsg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html"><span class="hs-identifier">Ouroboros.Consensus.Util.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Fingerprint"><span class="hs-identifier">Fingerprint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Watcher"><span class="hs-identifier">Watcher</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#withWatcher"><span class="hs-identifier">withWatcher</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier">ChainDB</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier">InvalidBlockReason</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainDB</span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-keyword">type</span><span> </span><span id="Consensus"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-var">Consensus</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680037207"><span class="annot"><a href="#local-6989586621680037207"><span class="hs-identifier hs-type">client</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680037206"><span class="annot"><a href="#local-6989586621680037206"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680037205"><span class="annot"><a href="#local-6989586621680037205"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-88"></span><span>   </span><span class="annot"><a href="#local-6989586621680037207"><span class="hs-identifier hs-type">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037206"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037206"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037206"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037205"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- | Abstract over the ChainDB</span><span>
</span><span id="line-91"></span><span class="hs-keyword">data</span><span> </span><span id="ChainDbView"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-var">ChainDbView</span></a></span></span><span> </span><span id="local-6989586621680037644"><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680037643"><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChainDbView"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-var">ChainDbView</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-92"></span><span>      </span><span id="%24sel%3AgetCurrentChain%3AChainDbView"><span class="annot"><span class="annottext">ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetCurrentChain%3AChainDbView"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="annot"><span class="annottext">ChainDbView m blk -&gt; STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="hs-identifier hs-var hs-var">getHeaderStateHistory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AgetPastLedger%3AChainDbView"><span class="annot"><span class="annottext">ChainDbView m blk
-&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetPastLedger%3AChainDbView"><span class="hs-identifier hs-var hs-var">getPastLedger</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="annot"><span class="annottext">ChainDbView m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="hs-identifier hs-var hs-var">getIsInvalidBlock</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AgetIsFetched%3AChainDbView"><span class="annot"><span class="annottext">ChainDbView m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsFetched%3AChainDbView"><span class="hs-identifier hs-var hs-var">getIsFetched</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AgetBlock%3AChainDbView"><span class="annot"><span class="annottext">ChainDbView m blk -&gt; RealPoint blk -&gt; m (Maybe blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetBlock%3AChainDbView"><span class="hs-identifier hs-var hs-var">getBlock</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037644"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680037643"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span id="local-6989586621680037196"><span id="local-6989586621680037197"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#defaultChainDbView"><span class="hs-identifier hs-type">defaultChainDbView</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-101"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037197"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037196"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037196"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037196"><span class="hs-identifier hs-type">blk</span></a></span></span></span><span>
</span><span id="line-103"></span><span id="defaultChainDbView"><span class="annot"><span class="annottext">defaultChainDbView :: ChainDB m blk -&gt; ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#defaultChainDbView"><span class="hs-identifier hs-var hs-var">defaultChainDbView</span></a></span></span><span> </span><span id="local-6989586621680037195"><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView :: forall (m :: * -&gt; *) blk.
STM m (AnchoredFragment (Header blk))
-&gt; STM m (HeaderStateHistory blk)
-&gt; (Point blk -&gt; STM m (Maybe (ExtLedgerState blk)))
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (Point blk -&gt; Bool)
-&gt; (RealPoint blk -&gt; m (Maybe blk))
-&gt; ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">$sel:getCurrentChain:ChainDbView :: STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetCurrentChain%3AChainDbView"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
ChainDB m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getCurrentChain"><span class="hs-identifier hs-var hs-var">ChainDB.getCurrentChain</span></a></span><span>       </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getHeaderStateHistory:ChainDbView :: STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="hs-identifier hs-var">getHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (HeaderStateHistory blk)
forall (m :: * -&gt; *) blk.
Monad (STM m) =&gt;
ChainDB m blk -&gt; STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getHeaderStateHistory"><span class="hs-identifier hs-var">ChainDB.getHeaderStateHistory</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getPastLedger:ChainDbView :: Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetPastLedger%3AChainDbView"><span class="hs-identifier hs-var">getPastLedger</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
forall (m :: * -&gt; *) blk.
(Monad (STM m), LedgerSupportsProtocol blk) =&gt;
ChainDB m blk -&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getPastLedger"><span class="hs-identifier hs-var">ChainDB.getPastLedger</span></a></span><span>         </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getIsInvalidBlock:ChainDbView :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
forall (m :: * -&gt; *) blk.
ChainDB m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getIsInvalidBlock"><span class="hs-identifier hs-var hs-var">ChainDB.getIsInvalidBlock</span></a></span><span>     </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getIsFetched:ChainDbView :: STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsFetched%3AChainDbView"><span class="hs-identifier hs-var">getIsFetched</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (Point blk -&gt; Bool)
forall (m :: * -&gt; *) blk.
ChainDB m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getIsFetched"><span class="hs-identifier hs-var hs-var">ChainDB.getIsFetched</span></a></span><span>          </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getBlock:ChainDbView :: RealPoint blk -&gt; m (Maybe blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetBlock%3AChainDbView"><span class="hs-identifier hs-var">getBlock</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
-&gt; BlockComponent blk blk -&gt; RealPoint blk -&gt; m (Maybe blk)
forall (m :: * -&gt; *) blk.
ChainDB m blk
-&gt; forall b. BlockComponent blk b -&gt; RealPoint blk -&gt; m (Maybe b)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getBlockComponent"><span class="hs-identifier hs-var hs-var">ChainDB.getBlockComponent</span></a></span><span>     </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621680037195"><span class="hs-identifier hs-var">chainDB</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk blk
forall blk. BlockComponent blk blk
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetVerifiedBlock"><span class="hs-identifier hs-var">ChainDB.GetVerifiedBlock</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- newtype wrappers to avoid confusing our tip with their tip.</span><span>
</span><span id="line-113"></span><span class="hs-keyword">newtype</span><span> </span><span id="Their"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span></span><span> </span><span id="local-6989586621680037441"><span class="annot"><a href="#local-6989586621680037441"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Their"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AunTheir%3ATheir"><span class="annot"><span class="annottext">Their a -&gt; a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AunTheir%3ATheir"><span class="hs-identifier hs-var hs-var">unTheir</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680037441"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621680037182"><span id="local-6989586621680037184"><span class="annot"><span class="annottext">Their a -&gt; Their a -&gt; Bool
(Their a -&gt; Their a -&gt; Bool)
-&gt; (Their a -&gt; Their a -&gt; Bool) -&gt; Eq (Their a)
forall a. Eq a =&gt; Their a -&gt; Their a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Their a -&gt; Their a -&gt; Bool
$c/= :: forall a. Eq a =&gt; Their a -&gt; Their a -&gt; Bool
== :: Their a -&gt; Their a -&gt; Bool
$c== :: forall a. Eq a =&gt; Their a -&gt; Their a -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680037175"><span id="local-6989586621680037177"><span id="local-6989586621680037179"><span class="annot"><span class="annottext">Int -&gt; Their a -&gt; ShowS
[Their a] -&gt; ShowS
Their a -&gt; String
(Int -&gt; Their a -&gt; ShowS)
-&gt; (Their a -&gt; String) -&gt; ([Their a] -&gt; ShowS) -&gt; Show (Their a)
forall a. Show a =&gt; Int -&gt; Their a -&gt; ShowS
forall a. Show a =&gt; [Their a] -&gt; ShowS
forall a. Show a =&gt; Their a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Their a] -&gt; ShowS
$cshowList :: forall a. Show a =&gt; [Their a] -&gt; ShowS
show :: Their a -&gt; String
$cshow :: forall a. Show a =&gt; Their a -&gt; String
showsPrec :: Int -&gt; Their a -&gt; ShowS
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; Their a -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037168"><span id="local-6989586621680037170"><span id="local-6989586621680037172"><span class="annot"><span class="annottext">Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
Proxy (Their a) -&gt; String
(Context -&gt; Their a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Their a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Their a) -&gt; String)
-&gt; NoThunks (Their a)
forall a. NoThunks a =&gt; Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
forall a. NoThunks a =&gt; Proxy (Their a) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy (Their a) -&gt; String
$cshowTypeOf :: forall a. NoThunks a =&gt; Proxy (Their a) -&gt; String
wNoThunks :: Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall a. NoThunks a =&gt; Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall a. NoThunks a =&gt; Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-keyword">newtype</span><span> </span><span id="Our"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-var">Our</span></a></span></span><span>   </span><span id="local-6989586621680037328"><span class="annot"><a href="#local-6989586621680037328"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Our"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-var">Our</span></a></span></span><span>   </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AunOur%3AOur"><span class="annot"><span class="annottext">Our a -&gt; a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AunOur%3AOur"><span class="hs-identifier hs-var hs-var">unOur</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680037328"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621680037161"><span id="local-6989586621680037163"><span class="annot"><span class="annottext">Our a -&gt; Our a -&gt; Bool
(Our a -&gt; Our a -&gt; Bool) -&gt; (Our a -&gt; Our a -&gt; Bool) -&gt; Eq (Our a)
forall a. Eq a =&gt; Our a -&gt; Our a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Our a -&gt; Our a -&gt; Bool
$c/= :: forall a. Eq a =&gt; Our a -&gt; Our a -&gt; Bool
== :: Our a -&gt; Our a -&gt; Bool
$c== :: forall a. Eq a =&gt; Our a -&gt; Our a -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680037155"><span id="local-6989586621680037157"><span id="local-6989586621680037159"><span class="annot"><span class="annottext">Int -&gt; Our a -&gt; ShowS
[Our a] -&gt; ShowS
Our a -&gt; String
(Int -&gt; Our a -&gt; ShowS)
-&gt; (Our a -&gt; String) -&gt; ([Our a] -&gt; ShowS) -&gt; Show (Our a)
forall a. Show a =&gt; Int -&gt; Our a -&gt; ShowS
forall a. Show a =&gt; [Our a] -&gt; ShowS
forall a. Show a =&gt; Our a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Our a] -&gt; ShowS
$cshowList :: forall a. Show a =&gt; [Our a] -&gt; ShowS
show :: Our a -&gt; String
$cshow :: forall a. Show a =&gt; Our a -&gt; String
showsPrec :: Int -&gt; Our a -&gt; ShowS
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; Our a -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037149"><span id="local-6989586621680037151"><span id="local-6989586621680037153"><span class="annot"><span class="annottext">Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
Proxy (Our a) -&gt; String
(Context -&gt; Our a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Our a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Our a) -&gt; String)
-&gt; NoThunks (Our a)
forall a. NoThunks a =&gt; Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
forall a. NoThunks a =&gt; Proxy (Our a) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy (Our a) -&gt; String
$cshowTypeOf :: forall a. NoThunks a =&gt; Proxy (Our a) -&gt; String
wNoThunks :: Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall a. NoThunks a =&gt; Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall a. NoThunks a =&gt; Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680037149"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span id="local-6989586621680037145"><span id="local-6989586621680037146"><span id="local-6989586621680037147"><span id="local-6989586621680037148"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#bracketChainSyncClient"><span class="hs-identifier hs-type">bracketChainSyncClient</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-123"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680037147"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-124"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037146"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-125"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037146"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-126"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037146"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037146"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621680037147"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037146"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>       </span><span class="hs-comment">-- ^ The candidate chains, we need the whole map because we</span><span>
</span><span id="line-131"></span><span>       </span><span class="hs-comment">-- (de)register nodes (@peer@).</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037147"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037146"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037145"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-135"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037148"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037145"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-137"></span><span id="bracketChainSyncClient"><span class="annot"><span class="annottext">bracketChainSyncClient :: Tracer m (TraceChainSyncClientEvent blk)
-&gt; ChainDbView m blk
-&gt; StrictTVar
     m (Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; peer
-&gt; ((CandidateFragment (Header blk) -&gt; m ()) -&gt; m a)
-&gt; m a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#bracketChainSyncClient"><span class="hs-identifier hs-var hs-var">bracketChainSyncClient</span></a></span></span><span> </span><span id="local-6989586621680037144"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037144"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680037143"><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
getIsInvalidBlock :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
$sel:getIsInvalidBlock:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621680037143"><span class="hs-identifier hs-var hs-var">getIsInvalidBlock</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621680037142"><span class="annot"><span class="annottext">StrictTVar
  m (Map peer (StrictTVar m (CandidateFragment (Header blk))))
</span><a href="#local-6989586621680037142"><span class="hs-identifier hs-var">varCandidates</span></a></span></span><span>
</span><span id="line-138"></span><span>                       </span><span id="local-6989586621680037141"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621680037141"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621680037140"><span class="annot"><span class="annottext">(CandidateFragment (Header blk) -&gt; m ()) -&gt; m a
</span><a href="#local-6989586621680037140"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">m (StrictTVar m (CandidateFragment (Header blk)))
-&gt; (StrictTVar m (CandidateFragment (Header blk)) -&gt; m ())
-&gt; (StrictTVar m (CandidateFragment (Header blk)) -&gt; m a)
-&gt; m a
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">bracket</span></a></span><span> </span><span class="annot"><span class="annottext">m (StrictTVar m (CandidateFragment (Header blk)))
</span><a href="#local-6989586621680037138"><span class="hs-identifier hs-var">newCandidateVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk)) -&gt; m ()
</span><a href="#local-6989586621680037137"><span class="hs-identifier hs-var">releaseCandidateVar</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span class="annot"><span class="annottext">((StrictTVar m (CandidateFragment (Header blk)) -&gt; m a) -&gt; m a)
-&gt; (StrictTVar m (CandidateFragment (Header blk)) -&gt; m a) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680037136"><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037136"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
-&gt; m a
-&gt; m a
forall (m :: * -&gt; *) a fp r.
(IOLike m, Eq fp, HasCallStack) =&gt;
String -&gt; Watcher m a fp -&gt; m r -&gt; m r
</span><a href="Ouroboros.Consensus.Util.STM.html#withWatcher"><span class="hs-identifier hs-var">withWatcher</span></a></span><span>
</span><span id="line-142"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSync.Client.rejectInvalidBlocks&quot;</span></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="#local-6989586621680037135"><span class="hs-identifier hs-var">invalidBlockWatcher</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037136"><span class="hs-identifier hs-var">varCandidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>        </span><span class="annot"><span class="annottext">(m a -&gt; m a) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(CandidateFragment (Header blk) -&gt; m ()) -&gt; m a
</span><a href="#local-6989586621680037140"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ())
-&gt; (CandidateFragment (Header blk) -&gt; STM m ())
-&gt; CandidateFragment (Header blk)
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
-&gt; CandidateFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037136"><span class="hs-identifier hs-var">varCandidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621680037138"><span class="annot"><span class="annottext">newCandidateVar :: m (StrictTVar m (CandidateFragment (Header blk)))
</span><a href="#local-6989586621680037138"><span class="hs-identifier hs-var hs-var">newCandidateVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>      </span><span id="local-6989586621680037131"><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037131"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CandidateFragment (Header blk)
-&gt; m (StrictTVar m (CandidateFragment (Header blk)))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.MonadSTM.NormalForm.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(CandidateFragment (Header blk)
 -&gt; m (StrictTVar m (CandidateFragment (Header blk))))
-&gt; CandidateFragment (Header blk)
-&gt; m (StrictTVar m (CandidateFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CandidateFragment :: forall header.
Bool -&gt; AnchoredFragment header -&gt; CandidateFragment header
</span><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">candidateChain :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateChain"><span class="hs-identifier hs-var">candidateChain</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk) -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.Empty</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
forall block. Anchor block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.AnchorGenesis</span></a></span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">candidateIsLowDensity :: Bool
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateIsLowDensity"><span class="hs-identifier hs-var">candidateIsLowDensity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; (Map peer (StrictTVar m (CandidateFragment (Header blk)))
    -&gt; Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map peer (StrictTVar m (CandidateFragment (Header blk))))
</span><a href="#local-6989586621680037142"><span class="hs-identifier hs-var">varCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">((Map peer (StrictTVar m (CandidateFragment (Header blk)))
  -&gt; Map peer (StrictTVar m (CandidateFragment (Header blk))))
 -&gt; STM m ())
-&gt; (Map peer (StrictTVar m (CandidateFragment (Header blk)))
    -&gt; Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">peer
-&gt; StrictTVar m (CandidateFragment (Header blk))
-&gt; Map peer (StrictTVar m (CandidateFragment (Header blk)))
-&gt; Map peer (StrictTVar m (CandidateFragment (Header blk)))
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621680037141"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037131"><span class="hs-identifier hs-var">varCandidate</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
-&gt; m (StrictTVar m (CandidateFragment (Header blk)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037131"><span class="hs-identifier hs-var">varCandidate</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>    </span><span id="local-6989586621680037137"><span class="annot"><span class="annottext">releaseCandidateVar :: StrictTVar m (CandidateFragment (Header blk)) -&gt; m ()
</span><a href="#local-6989586621680037137"><span class="hs-identifier hs-var hs-var">releaseCandidateVar</span></a></span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>      </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; (Map peer (StrictTVar m (CandidateFragment (Header blk)))
    -&gt; Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map peer (StrictTVar m (CandidateFragment (Header blk))))
</span><a href="#local-6989586621680037142"><span class="hs-identifier hs-var">varCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">((Map peer (StrictTVar m (CandidateFragment (Header blk)))
  -&gt; Map peer (StrictTVar m (CandidateFragment (Header blk))))
 -&gt; STM m ())
-&gt; (Map peer (StrictTVar m (CandidateFragment (Header blk)))
    -&gt; Map peer (StrictTVar m (CandidateFragment (Header blk))))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">peer
-&gt; Map peer (StrictTVar m (CandidateFragment (Header blk)))
-&gt; Map peer (StrictTVar m (CandidateFragment (Header blk)))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.delete</span></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621680037141"><span class="hs-identifier hs-var">peer</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621680037135"><span class="annot"><span class="annottext">invalidBlockWatcher :: StrictTVar m (CandidateFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="#local-6989586621680037135"><span class="hs-identifier hs-var hs-var">invalidBlockWatcher</span></a></span></span><span> </span><span id="local-6989586621680037121"><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037121"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-158"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
forall (m :: * -&gt; *) blk.
(IOLike m, BlockSupportsProtocol blk,
 LedgerSupportsProtocol blk) =&gt;
Tracer m (TraceChainSyncClientEvent blk)
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#invalidBlockRejector"><span class="hs-identifier hs-var">invalidBlockRejector</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037144"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621680037143"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CandidateFragment (Header blk) -&gt; AnchoredFragment (Header blk)
forall header. CandidateFragment header -&gt; AnchoredFragment header
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateChain"><span class="hs-identifier hs-var hs-var">candidateChain</span></a></span><span> </span><span class="annot"><span class="annottext">(CandidateFragment (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; STM m (CandidateFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
-&gt; STM m (CandidateFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (CandidateFragment (Header blk))
</span><a href="#local-6989586621680037121"><span class="hs-identifier hs-var">varCandidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- Our task: after connecting to an upstream node, try to maintain an</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- up-to-date header-only fragment representing their chain. We maintain</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- such candidate chains in a map with upstream nodes as keys.</span><span>
</span><span id="line-166"></span><span class="hs-comment">--</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- The block fetch logic will use these candidate chains to download</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- blocks from, prioritising certain candidate chains over others using</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- the consensus protocol. Whenever such a block has been downloaded and</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- added to the local 'ChainDB', the 'ChainDB' will perform chain</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- selection.</span><span>
</span><span id="line-172"></span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- We also validate the headers of a candidate chain by advancing the</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- 'ChainDepState' with the headers, which returns an error when validation</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- failed. Thus, in addition to the chain fragment of each candidate, we also</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- store a 'ChainDepState' corresponding to the head of the candidate chain.</span><span>
</span><span id="line-177"></span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- We must keep the candidate chain synchronised with the corresponding</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- upstream chain. The upstream node's chain might roll forward or</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- backwards, and they will inform us about this. When we get these</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- messages, we will replicate these actions on our candidate chain.</span><span>
</span><span id="line-182"></span><span class="hs-comment">--</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- INVARIANT:</span><span>
</span><span id="line-184"></span><span class="hs-comment">--</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- &gt;           our tip</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- &gt;             v</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- &gt;   /--* .... *</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- &gt;   |</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- &gt; --*</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- &gt;   |</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- &gt;   \--* .... *</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- &gt;        fragment tip</span><span>
</span><span id="line-193"></span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- The distance from our tip to the intersection between our chain and the</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- fragment maintained for the upstream node cannot exceed @k@ blocks. When</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- this invariant cannot be maintained, the upstream node is on a fork that</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- is too distant and we should disconnect.</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- TODO #423 rate-limit switching chains, otherwise we can't place blame (we</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- don't know which candidate's chain included the point that was</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- poisoned). E.g. two rollbacks per time slot -&gt; make it configurable -&gt;</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- just a simple argument for now.</span><span>
</span><span id="line-203"></span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- TODO #467 if the 'theirTip' that they sent us is on our chain, just</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- switch to it.</span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">-- = Candidate fragment size</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- -------------------------</span><span>
</span><span id="line-210"></span><span class="hs-comment">--</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- The size of the downloaded candidate fragment ('theirFrag') and the</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- corresponding header state history ('theirHeaderStateHistory', which has the</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- same size as 'theirFrag') is limited by how far in the future the ledger view</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- can forecast.</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- For PBFT (Byron), we can forecast up to @2k@ slots ahead. Assuming a chain</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- density of 100%, this means the look-ahead is @2k@ headers. For mainnet this</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- means @2 * 2160 = 4320@ headers.</span><span>
</span><span id="line-219"></span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- For TPraos (Shelley), we can forecast up to @3k/f@ slots ahead. Assuming a</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- density of @f@, this means the look-ahead is @3k@ headers. For mainnet, this</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- means @3 * 2160 = 6480@ headers.</span><span>
</span><span id="line-223"></span><span class="hs-comment">--</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- The figure below shows the relation between 'ourFrag' and 'theirFrag':</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- &gt;                       k headers or less, when A is genesis</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- &gt;              &lt;---------------------&gt;</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- &gt;            anchor    header       tip</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- &gt;              |         |           |</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- &gt;              V         V           V</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- &gt; 'ourFrag':   A-H-H-H-H-H-H-H-H-...-H</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- &gt;                     \</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- &gt; 'theirFrag':         H-H-H-H-...   ...   ...</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- &gt;                    ^</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- &gt;                    |</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- &gt;           most recent intersection (between A and the tip)</span><span>
</span><span id="line-237"></span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- Note that the 'ourFrag' and 'theirFrag' share anchors /at all times/. In the</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- figure above, the first three headers on 'ourFrag' are thus also on</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- 'theirFrag'. The further away the most recent intersection is from the anchor</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- point, the more headers 'theirFrag' and 'ourFrag' will have in common.</span><span>
</span><span id="line-242"></span><span class="hs-comment">--</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- In the \&quot;worst\&quot; case 'theirFrag' has the following length:</span><span>
</span><span id="line-244"></span><span class="hs-comment">--</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- &gt;                        k</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- &gt;              &lt;---------------------&gt;</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- &gt; 'ourFrag':   A-H-H-H-H-H-H-H-H-...-H</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- &gt;                                    \</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- &gt; 'theirFrag':                        H-H-H-H-H-H-H-H-H-H-H-H-H-H-H...-H</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- &gt;                                     &lt;--------------------------------&gt;</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- &gt;                                               max look-ahead</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- &gt; max length   &lt;-------------------------------------------------------&gt;</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- &gt; of 'theirFrag'         k + max look-ahead</span><span>
</span><span id="line-254"></span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- For PBFT this is @2160 + 4320 = 6480@ headers, for TPraos this is @2160 +</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- 6480 = 8640@ headers. The header state history will have the same length.</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- This worst case can happen when:</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- * We are more than 6480 or respectively 8640 blocks behind, bulk syncing, and</span><span>
</span><span id="line-260"></span><span class="hs-comment">--   the BlockFetch client and/or the ChainDB can't keep up with the ChainSync</span><span>
</span><span id="line-261"></span><span class="hs-comment">--   client.</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- * When our clock is running behind such that we are not adopting the</span><span>
</span><span id="line-263"></span><span class="hs-comment">--   corresponding blocks because we think they are from the future.</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- * When an attacker is serving us headers from the future.</span><span>
</span><span id="line-265"></span><span class="hs-comment">--</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- When we are in sync with the network, the fragment will typically be @k@ to</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- @k + 1@ headers long.</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-comment">-- | State used when the intersection between the candidate and the current</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- chain is unknown.</span><span>
</span><span id="line-271"></span><span id="local-6989586621680037116"><span id="local-6989586621680037117"></span></span><span class="hs-keyword">data</span><span> </span><span id="UnknownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-var">UnknownIntersectionState</span></a></span></span><span> </span><span id="local-6989586621680037453"><span class="annot"><a href="#local-6989586621680037453"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UnknownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-var">UnknownIntersectionState</span></a></span></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AourFrag%3AUnknownIntersectionState"><span class="annot"><span class="annottext">UnknownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AUnknownIntersectionState"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-comment">-- ^ A view of the current chain fragment. Note that this might be</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-comment">-- temporarily out of date w.r.t. the actual current chain until we update</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-comment">-- it again.</span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">-- This fragment is used to select points from to find an intersection</span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-comment">-- with the candidate.</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-comment">-- INVARIANT: 'ourFrag' contains @k@ headers, unless close to genesis.</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="annot"><span class="annottext">UnknownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="hs-identifier hs-var hs-var">ourHeaderStateHistory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- ^ 'HeaderStateHistory' corresponding to the tip (most recent block) of</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-comment">-- 'ourFrag'.</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 UnknownIntersectionState blk
 -&gt; Rep (UnknownIntersectionState blk) x)
-&gt; (forall x.
    Rep (UnknownIntersectionState blk) x
    -&gt; UnknownIntersectionState blk)
-&gt; Generic (UnknownIntersectionState blk)
forall x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
forall x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
forall blk x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
$cto :: forall blk x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
$cfrom :: forall blk x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span id="local-6989586621680037109"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037105"><span id="local-6989586621680037107"><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037109"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-288"></span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037109"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-289"></span><span>  </span><span id="local-6989586621680037103"><span class="annot"><span class="annottext">showTypeOf :: Proxy (UnknownIntersectionState blk) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">showTypeOf</span></span></span><span> </span><span class="annot"><span class="annottext">Proxy (UnknownIntersectionState blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(TypeRep -&gt; String) -&gt; TypeRep -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Proxy (UnknownIntersectionState blk) -&gt; TypeRep
forall k (proxy :: k -&gt; *) (a :: k).
Typeable a =&gt;
proxy a -&gt; TypeRep
</span><span class="hs-identifier hs-var">typeRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy (UnknownIntersectionState blk)
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037109"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | State used when the intersection between the candidate and the current</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- chain is known.</span><span>
</span><span id="line-293"></span><span id="local-6989586621680037097"><span id="local-6989586621680037098"></span></span><span class="hs-keyword">data</span><span> </span><span id="KnownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-var">KnownIntersectionState</span></a></span></span><span> </span><span id="local-6989586621680037526"><span class="annot"><a href="#local-6989586621680037526"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="KnownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-var">KnownIntersectionState</span></a></span></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AtheirFrag%3AKnownIntersectionState"><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037526"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- ^ The candidate, the synched fragment of their chain.</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-comment">-- See the \&quot;Candidate fragment size\&quot; note above.</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037526"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- ^ 'HeaderStateHistory' corresponding to the tip (most recent block) of</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-comment">-- 'theirFrag'.</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">-- INVARIANT: the tips in 'theirHeaderStateHistory' correspond to the</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-comment">-- headers in 'theirFrag', including the anchor.</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- See the \&quot;Candidate fragment size\&quot; note above.</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AourFrag%3AKnownIntersectionState"><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037526"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- ^ A view of the current chain fragment used to maintain the invariants</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- with. Note that this might be temporarily out of date w.r.t. the actual</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- current chain until we update it again.</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">-- INVARIANT: 'ourFrag' contains @k@ headers, unless close to genesis.</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- INVARIANT: 'theirFrag' and 'ourFrag' have the same anchor point. From</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- this follows that both fragments intersect. This also means that</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-comment">-- 'theirFrag' forks off within the last @k@ headers/blocks of the</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- 'ourFrag'.</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037526"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-comment">-- ^ The most recent intersection point between 'theirFrag' and 'ourFrag'.</span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-comment">-- Note that this is not necessarily the anchor point of both 'theirFrag'</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- and 'ourFrag', they might have many more headers in common.</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- INVARIANT:</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- &gt; Just 'mostRecentIntersection' == 'AF.intersectionPoint' 'theirFrag' 'ourFrag'</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-comment">-- It follows from the invariants on 'ourFrag' that this point is within</span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-comment">-- the last @k@ headers of the current chain fragment, at time of</span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-comment">-- computing the 'KnownIntersectionState'.</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x)
-&gt; (forall x.
    Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk)
-&gt; Generic (KnownIntersectionState blk)
forall x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
forall x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
forall blk x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
$cto :: forall blk x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
$cfrom :: forall blk x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span id="local-6989586621680037089"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037085"><span id="local-6989586621680037087"><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037089"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-332"></span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037089"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-333"></span><span>  </span><span id="local-6989586621680037083"><span class="annot"><span class="annottext">showTypeOf :: Proxy (KnownIntersectionState blk) -&gt; String
</span><a href="#local-6989586621680037083"><span class="hs-identifier hs-var hs-var hs-var hs-var">showTypeOf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy (KnownIntersectionState blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(TypeRep -&gt; String) -&gt; TypeRep -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Proxy (KnownIntersectionState blk) -&gt; TypeRep
forall k (proxy :: k -&gt; *) (a :: k).
Typeable a =&gt;
proxy a -&gt; TypeRep
</span><span class="hs-identifier hs-var">typeRep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy (KnownIntersectionState blk)
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037089"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span id="local-6989586621680037486"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownIntersectionInvariants"><span class="hs-identifier hs-type">checkKnownIntersectionInvariants</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037486"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-337"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037486"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HasAnnTip"><span class="hs-identifier hs-type">HasAnnTip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037486"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-339"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037486"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037486"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037486"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-344"></span><span id="checkKnownIntersectionInvariants"><span class="annot"><span class="annottext">checkKnownIntersectionInvariants :: ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; Either String ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownIntersectionInvariants"><span class="hs-identifier hs-var hs-var">checkKnownIntersectionInvariants</span></a></span></span><span> </span><span id="local-6989586621680037081"><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621680037081"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span>
</span><span id="line-345"></span><span>                                     </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680037080"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
$sel:ourFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037080"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-346"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037079"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037079"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-347"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037078"><span class="annot"><span class="annottext">HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="#local-6989586621680037078"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-348"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037077"><span class="annot"><span class="annottext">Point blk
mostRecentIntersection :: Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
</span><a href="#local-6989586621680037077"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-349"></span><span>                                     </span><span class="hs-special">}</span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-comment">-- 'theirHeaderStateHistory' invariant</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span id="local-6989586621680037075"><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
</span><a href="#local-6989586621680037075"><span class="hs-identifier hs-var">snapshots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680037078"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span id="local-6989586621680037074"><span class="annot"><span class="annottext">historyTips :: [WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621680037074"><span class="hs-identifier hs-var hs-var">historyTips</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderState blk -&gt; WithOrigin (AnnTip blk)
forall blk. HeaderState blk -&gt; WithOrigin (AnnTip blk)
</span><a href="Ouroboros.Consensus.HeaderValidation.html#headerStateTip"><span class="hs-identifier hs-var hs-var">headerStateTip</span></a></span><span>        </span><span class="annot"><span class="annottext">(HeaderState blk -&gt; WithOrigin (AnnTip blk))
-&gt; [HeaderState blk] -&gt; [WithOrigin (AnnTip blk)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
-&gt; [HeaderState blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AS.toOldestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
</span><a href="#local-6989586621680037075"><span class="hs-identifier hs-var">snapshots</span></a></span><span>
</span><span id="line-353"></span><span>          </span><span id="local-6989586621680037071"><span class="annot"><span class="annottext">fragmentTips :: [WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621680037071"><span class="hs-identifier hs-var hs-var">fragmentTips</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnTip blk -&gt; WithOrigin (AnnTip blk)
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">(AnnTip blk -&gt; WithOrigin (AnnTip blk))
-&gt; (Header blk -&gt; AnnTip blk)
-&gt; Header blk
-&gt; WithOrigin (AnnTip blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; AnnTip blk
forall blk.
(HasHeader (Header blk), HasAnnTip blk) =&gt;
Header blk -&gt; AnnTip blk
</span><a href="Ouroboros.Consensus.HeaderValidation.html#getAnnTip"><span class="hs-identifier hs-var">getAnnTip</span></a></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; WithOrigin (AnnTip blk))
-&gt; [Header blk] -&gt; [WithOrigin (AnnTip blk)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.toOldestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037079"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-354"></span><span>          </span><span id="local-6989586621680037068"><span class="annot"><span class="annottext">historyAnchorPoint :: Point blk
</span><a href="#local-6989586621680037068"><span class="hs-identifier hs-var hs-var">historyAnchorPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-355"></span><span>            </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk) -&gt; Point blk
forall blk. WithOrigin (RealPoint blk) -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#withOriginRealPointToPoint"><span class="hs-identifier hs-var">withOriginRealPointToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithOrigin (RealPoint blk) -&gt; Point blk)
-&gt; WithOrigin (RealPoint blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-356"></span><span>              </span><span class="annot"><span class="annottext">AnnTip blk -&gt; RealPoint blk
forall blk. HasAnnTip blk =&gt; AnnTip blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.HeaderValidation.html#annTipRealPoint"><span class="hs-identifier hs-var">annTipRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(AnnTip blk -&gt; RealPoint blk)
-&gt; WithOrigin (AnnTip blk) -&gt; WithOrigin (RealPoint blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HeaderState blk -&gt; WithOrigin (AnnTip blk)
forall blk. HeaderState blk -&gt; WithOrigin (AnnTip blk)
</span><a href="Ouroboros.Consensus.HeaderValidation.html#headerStateTip"><span class="hs-identifier hs-var hs-var">headerStateTip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
-&gt; HeaderState blk
forall v a b. AnchoredSeq v a b -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var hs-var">AS.anchor</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
</span><a href="#local-6989586621680037075"><span class="hs-identifier hs-var">snapshots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>          </span><span id="local-6989586621680037064"><span class="annot"><span class="annottext">fragmentAnchorPoint :: Point blk
</span><a href="#local-6989586621680037064"><span class="hs-identifier hs-var hs-var">fragmentAnchorPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037079"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621680037074"><span class="hs-identifier hs-var">historyTips</span></a></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)] -&gt; [WithOrigin (AnnTip blk)] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621680037071"><span class="hs-identifier hs-var">fragmentTips</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037068"><span class="hs-identifier hs-var">historyAnchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037064"><span class="hs-identifier hs-var">fragmentAnchorPoint</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;The tips in theirHeaderStateHistory didn't match the headers in theirFrag:&quot;</span></span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621680037074"><span class="hs-identifier hs-var">historyTips</span></a></span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621680037071"><span class="hs-identifier hs-var">fragmentTips</span></a></span><span>
</span><span id="line-364"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;with anchors&quot;</span></span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037068"><span class="hs-identifier hs-var">historyAnchorPoint</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-367"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037064"><span class="hs-identifier hs-var">fragmentAnchorPoint</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-comment">-- 'ourFrag' invariants</span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680037057"><span class="annot"><span class="annottext">nbHeaders :: Int
</span><a href="#local-6989586621680037057"><span class="hs-identifier hs-var hs-var">nbHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037080"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-372"></span><span>          </span><span id="local-6989586621680037055"><span class="annot"><span class="annottext">ourAnchorPoint :: Point (Header blk)
</span><a href="#local-6989586621680037055"><span class="hs-identifier hs-var hs-var">ourAnchorPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037080"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680037057"><span class="hs-identifier hs-var">nbHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037053"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680037055"><span class="hs-identifier hs-var">ourAnchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
forall block. Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">GenesisPoint</span></a></span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-376"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ourFrag contains fewer than k headers and not close to genesis:&quot;</span></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680037057"><span class="hs-identifier hs-var">nbHeaders</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-379"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037053"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;with anchor&quot;</span></span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680037055"><span class="hs-identifier hs-var">ourAnchorPoint</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680037051"><span class="annot"><span class="annottext">ourFragAnchor :: Point (Header blk)
</span><a href="#local-6989586621680037051"><span class="hs-identifier hs-var hs-var">ourFragAnchor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037080"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-385"></span><span>          </span><span id="local-6989586621680037050"><span class="annot"><span class="annottext">theirFragAnchor :: Point (Header blk)
</span><a href="#local-6989586621680037050"><span class="hs-identifier hs-var hs-var">theirFragAnchor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037079"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680037051"><span class="hs-identifier hs-var">ourFragAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680037050"><span class="hs-identifier hs-var">theirFragAnchor</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-388"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ourFrag and theirFrag have different anchor points:&quot;</span></span><span>
</span><span id="line-389"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680037051"><span class="hs-identifier hs-var">ourFragAnchor</span></a></span><span>
</span><span id="line-390"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-391"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680037050"><span class="hs-identifier hs-var">theirFragAnchor</span></a></span><span>
</span><span id="line-392"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-comment">-- 'mostRecentIntersection' invariant</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680037049"><span class="annot"><span class="annottext">actualMostRecentIntersection :: Maybe (Point blk)
</span><a href="#local-6989586621680037049"><span class="hs-identifier hs-var hs-var">actualMostRecentIntersection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Maybe (Point (Header blk)) -&gt; Maybe (Point blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Maybe (Point (Header blk))
forall block1 block2.
(HasHeader block1, HasHeader block2,
 HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; AnchoredFragment block2 -&gt; Maybe (Point block1)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.intersectionPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037079"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037080"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Maybe (Point blk)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037077"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk) -&gt; Maybe (Point blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk)
</span><a href="#local-6989586621680037049"><span class="hs-identifier hs-var">actualMostRecentIntersection</span></a></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-399"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mostRecentIntersection not the most recent intersection&quot;</span></span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;of theirFrag and ourFrag:&quot;</span></span><span>
</span><span id="line-401"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037077"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-403"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk)
</span><a href="#local-6989586621680037049"><span class="hs-identifier hs-var">actualMostRecentIntersection</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either String ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621680037053"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037053"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk) -&gt; SecurityParam
forall p. ConsensusProtocol p =&gt; ConsensusConfig p -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#protocolSecurityParam"><span class="hs-identifier hs-var">protocolSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621680037081"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span id="local-6989586621680037431"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-type">assertKnownIntersectionInvariants</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-413"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HasAnnTip"><span class="hs-identifier hs-type">HasAnnTip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-415"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-417"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037431"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-421"></span><span id="assertKnownIntersectionInvariants"><span class="annot"><span class="annottext">assertKnownIntersectionInvariants :: ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var hs-var">assertKnownIntersectionInvariants</span></a></span></span><span> </span><span id="local-6989586621680037044"><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621680037044"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621680037043"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680037043"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><span class="annottext">Either String ()
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a. HasCallStack =&gt; Either String () -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Util.Assert.html#assertWithMsg"><span class="hs-identifier hs-var">assertWithMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; Either String ()
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; Either String ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownIntersectionInvariants"><span class="hs-identifier hs-var">checkKnownIntersectionInvariants</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621680037044"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680037043"><span class="hs-identifier hs-var">kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680037043"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">-- | Chain sync client</span><span>
</span><span id="line-425"></span><span class="hs-comment">--</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- This never terminates. In case of a failure, a 'ChainSyncClientException'</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- is thrown. The network layer classifies exception such that the</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- corresponding peer will never be chosen again.</span><span>
</span><span id="line-429"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#chainSyncClient"><span class="hs-identifier hs-type">chainSyncClient</span></a></span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037042"><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680037041"><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-431"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-432"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-433"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MkPipelineDecision</span></a></span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">ControlMessageSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainSyncClientPipelined</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-442"></span><span id="chainSyncClient"><span class="annot"><span class="annottext">chainSyncClient :: MkPipelineDecision
-&gt; Tracer m (TraceChainSyncClientEvent blk)
-&gt; TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; (CandidateFragment (Header blk) -&gt; m ())
-&gt; Consensus ChainSyncClientPipelined blk m
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#chainSyncClient"><span class="hs-identifier hs-var hs-var">chainSyncClient</span></a></span></span><span> </span><span id="local-6989586621680037040"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680037040"><span class="hs-identifier hs-var">mkPipelineDecision0</span></a></span></span><span> </span><span id="local-6989586621680037039"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037039"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680037038"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-443"></span><span>                </span><span id="local-6989586621680037037"><span class="annot"><span class="annottext">cdbView :: ChainDbView m blk
</span><a href="#local-6989586621680037037"><span class="hs-identifier hs-var">cdbView</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span>
</span><span id="line-444"></span><span>                </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680037036"><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
getCurrentChain :: STM m (AnchoredFragment (Header blk))
$sel:getCurrentChain:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680037036"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span>
</span><span id="line-445"></span><span>                </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037035"><span class="annot"><span class="annottext">STM m (HeaderStateHistory blk)
getHeaderStateHistory :: STM m (HeaderStateHistory blk)
$sel:getHeaderStateHistory:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (HeaderStateHistory blk)
</span><a href="#local-6989586621680037035"><span class="hs-identifier hs-var hs-var">getHeaderStateHistory</span></a></span></span><span>
</span><span id="line-446"></span><span>                </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037034"><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
getIsInvalidBlock :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
$sel:getIsInvalidBlock:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621680037034"><span class="hs-identifier hs-var hs-var">getIsInvalidBlock</span></a></span></span><span>
</span><span id="line-447"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-448"></span><span>                </span><span id="local-6989586621680037033"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621680037033"><span class="hs-identifier hs-var">_version</span></a></span></span><span>
</span><span id="line-449"></span><span>                </span><span id="local-6989586621680037032"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621680037032"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span>
</span><span id="line-450"></span><span>                </span><span id="local-6989586621680037031"><span class="annot"><span class="annottext">CandidateFragment (Header blk) -&gt; m ()
</span><a href="#local-6989586621680037031"><span class="hs-identifier hs-var">setCandidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Consensus ChainSyncClientPipelined blk m
forall header point tip (m :: * -&gt; *) a.
m (ClientPipelinedStIdle 'Z header point tip m a)
-&gt; ChainSyncClientPipelined header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">ChainSyncClientPipelined</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Consensus ChainSyncClientPipelined blk m)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Consensus ChainSyncClientPipelined blk m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><span class="annottext">()
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stateful
   m
   ()
   (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stateful
  m
  ()
  (ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037028"><span class="hs-identifier hs-var">initialise</span></a></span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-comment">-- | Start ChainSync by looking for an intersection between our current</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-comment">-- chain fragment and their chain.</span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><a href="#local-6989586621680037028"><span class="hs-identifier hs-type">initialise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621680037028"><span class="annot"><span class="annottext">initialise :: Stateful
  m
  ()
  (ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037028"><span class="hs-identifier hs-var hs-var">initialise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037027"><span class="hs-identifier hs-var">findIntersection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-var">ForkTooDeep</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
forall block. Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">GenesisPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-comment">-- | Try to find an intersection by sending points of our current chain to</span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-comment">-- the server, if any of them intersect with their chain, roll back our</span><span>
</span><span id="line-460"></span><span>    </span><span class="hs-comment">-- chain to that point and start synching using that fragment. If none</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-comment">-- intersect, disconnect by throwing the exception obtained by calling the</span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">-- passed function.</span><span>
</span><span id="line-463"></span><span>    </span><span class="annot"><a href="#local-6989586621680037027"><span class="hs-identifier hs-type">findIntersection</span></a></span><span>
</span><span id="line-464"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>         </span><span class="hs-comment">-- ^ Exception to throw when no intersection is found.</span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621680037027"><span class="annot"><span class="annottext">findIntersection :: (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037027"><span class="hs-identifier hs-var hs-var">findIntersection</span></a></span></span><span> </span><span id="local-6989586621680037025"><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="#local-6989586621680037025"><span class="hs-identifier hs-var">mkResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(()
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((()
  -&gt; m (ClientPipelinedStIdle
          'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
 -&gt; Stateful
      m
      ()
      (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; (()
    -&gt; m (ClientPipelinedStIdle
            'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680037023"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037023"><span class="hs-identifier hs-var">ourFrag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037022"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680037022"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
 -&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>        </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; HeaderStateHistory blk
 -&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; STM
     m
     (HeaderStateHistory blk
      -&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680037036"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>
</span><span id="line-470"></span><span>        </span><span class="annot"><span class="annottext">STM
  m
  (HeaderStateHistory blk
   -&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; STM m (HeaderStateHistory blk)
-&gt; STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m (HeaderStateHistory blk)
</span><a href="#local-6989586621680037035"><span class="hs-identifier hs-var">getHeaderStateHistory</span></a></span><span>
</span><span id="line-471"></span><span>      </span><span class="hs-comment">-- We select points from the last @k@ headers of our current chain. This</span><span>
</span><span id="line-472"></span><span>      </span><span class="hs-comment">-- means that if an intersection is found for one of these points, it</span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-comment">-- was an intersection within the last @k@ blocks of our current chain.</span><span>
</span><span id="line-474"></span><span>      </span><span class="hs-comment">-- If not, we could never switch to this candidate chain anyway.</span><span>
</span><span id="line-475"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680037021"><span class="annot"><span class="annottext">maxOffset :: Word64
</span><a href="#local-6989586621680037021"><span class="hs-identifier hs-var hs-var">maxOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037023"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>          </span><span id="local-6989586621680037020"><span class="annot"><span class="annottext">points :: [Point blk]
</span><a href="#local-6989586621680037020"><span class="hs-identifier hs-var hs-var">points</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; [Point (Header blk)] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span>
</span><span id="line-477"></span><span>                    </span><span class="annot"><span class="annottext">([Point (Header blk)] -&gt; [Point blk])
-&gt; [Point (Header blk)] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; AnchoredFragment (Header blk) -&gt; [Point (Header blk)]
forall block.
HasHeader block =&gt;
[Int] -&gt; AnchoredFragment block -&gt; [Point block]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.selectPoints</span></a></span><span>
</span><span id="line-478"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Word64 -&gt; Int) -&gt; [Word64] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; [Word64]
</span><a href="#local-6989586621680037018"><span class="hs-identifier hs-var">offsets</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037021"><span class="hs-identifier hs-var">maxOffset</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>                        </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037023"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-480"></span><span>          </span><span id="local-6989586621680037017"><span class="annot"><span class="annottext">uis :: UnknownIntersectionState blk
</span><a href="#local-6989586621680037017"><span class="hs-identifier hs-var hs-var">uis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnknownIntersectionState :: forall blk.
AnchoredFragment (Header blk)
-&gt; HeaderStateHistory blk -&gt; UnknownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-481"></span><span>              </span><span class="annot"><span class="annottext">$sel:ourFrag:UnknownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AUnknownIntersectionState"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037023"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-482"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ourHeaderStateHistory:UnknownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680037022"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-484"></span><span>      </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Point blk]
-&gt; ClientPipelinedStIntersect
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall point header tip (m :: * -&gt; *) a.
[point]
-&gt; ClientPipelinedStIntersect header point tip m a
-&gt; ClientPipelinedStIdle 'Z header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">SendMsgFindIntersect</span></a></span><span> </span><span class="annot"><span class="annottext">[Point blk]
</span><a href="#local-6989586621680037020"><span class="hs-identifier hs-var">points</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientPipelinedStIntersect
   (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientPipelinedStIntersect
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientPipelinedStIntersect :: forall header point tip (m :: * -&gt; *) a.
(point -&gt; tip -&gt; m (ClientPipelinedStIdle 'Z header point tip m a))
-&gt; (tip -&gt; m (ClientPipelinedStIdle 'Z header point tip m a))
-&gt; ClientPipelinedStIntersect header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIntersect</span></a></span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">recvMsgIntersectFound :: Point blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">recvMsgIntersectFound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680037013"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037013"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621680037012"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680037012"><span class="hs-identifier hs-var">theirTip'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-486"></span><span>            </span><span class="annot"><span class="annottext">UnknownIntersectionState blk
-&gt; Stateful
     m
     (UnknownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">UnknownIntersectionState blk
</span><a href="#local-6989586621680037017"><span class="hs-identifier hs-var">uis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m
   (UnknownIntersectionState blk)
   (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     (UnknownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-487"></span><span>              </span><span class="annot"><span class="annottext">Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m
     (UnknownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037011"><span class="hs-identifier hs-var">intersectFound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037013"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680037012"><span class="hs-identifier hs-var">theirTip'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgIntersectNotFound :: Tip blk
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">recvMsgIntersectNotFound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680037009"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680037009"><span class="hs-identifier hs-var">theirTip'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037008"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientResult
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-490"></span><span>              </span><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="#local-6989586621680037025"><span class="hs-identifier hs-var">mkResult</span></a></span><span>
</span><span id="line-491"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037023"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680037009"><span class="hs-identifier hs-var">theirTip'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>    </span><span class="hs-comment">-- | One of the points we sent intersected our chain. This intersection</span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-comment">-- point will become the new tip of the candidate chain.</span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><a href="#local-6989586621680037011"><span class="hs-identifier hs-type">intersectFound</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>  </span><span class="hs-comment">-- ^ Intersection</span><span>
</span><span id="line-498"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-500"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>    </span><span id="local-6989586621680037011"><span class="annot"><span class="annottext">intersectFound :: Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m
     (UnknownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037011"><span class="hs-identifier hs-var hs-var">intersectFound</span></a></span></span><span> </span><span id="local-6989586621680037006"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037006"><span class="hs-identifier hs-var">intersection</span></a></span></span><span> </span><span id="local-6989586621680037005"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680037005"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span>
</span><span id="line-503"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UnknownIntersectionState blk
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     (UnknownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((UnknownIntersectionState blk
  -&gt; m (ClientPipelinedStIdle
          'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
 -&gt; Stateful
      m
      (UnknownIntersectionState blk)
      (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; (UnknownIntersectionState blk
    -&gt; m (ClientPipelinedStIdle
            'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     (UnknownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span>
</span><span id="line-504"></span><span>                     </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680037004"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
$sel:ourFrag:UnknownIntersectionState :: forall blk.
UnknownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037004"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-505"></span><span>                     </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037003"><span class="annot"><span class="annottext">HeaderStateHistory blk
ourHeaderStateHistory :: HeaderStateHistory blk
$sel:ourHeaderStateHistory:UnknownIntersectionState :: forall blk. UnknownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="#local-6989586621680037003"><span class="hs-identifier hs-var hs-var">ourHeaderStateHistory</span></a></span></span><span>
</span><span id="line-506"></span><span>                     </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037039"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; TraceChainSyncClientEvent blk
forall blk.
Point blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceFoundIntersection"><span class="hs-identifier hs-var">TraceFoundIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037006"><span class="hs-identifier hs-var">intersection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037004"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680037005"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-509"></span><span>      </span><span class="annot"><span class="annottext">m (ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a. m a -&gt; m a
</span><a href="#local-6989586621680037000"><span class="hs-identifier hs-var">traceException</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-510"></span><span>        </span><span class="hs-comment">-- Roll back the current chain fragment to the @intersection@.</span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-comment">-- While the primitives in the ChainSync protocol are &quot;roll back&quot;,</span><span>
</span><span id="line-513"></span><span>        </span><span class="hs-comment">-- &quot;roll forward (apply block)&quot;, etc. The /real/ primitive is &quot;switch</span><span>
</span><span id="line-514"></span><span>        </span><span class="hs-comment">-- to fork&quot;, which means that a roll back is always followed by</span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-comment">-- applying at least as many blocks that we rolled back.</span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-517"></span><span>        </span><span class="hs-comment">-- This is important for 'rewindHeaderStateHistory', which can only roll</span><span>
</span><span id="line-518"></span><span>        </span><span class="hs-comment">-- back up to @k@ blocks, /once/, i.e., we cannot keep rolling back the</span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-comment">-- same chain state multiple times, because that would mean that we</span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-comment">-- store the chain state for the /whole chain/, all the way to genesis.</span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-comment">-- So the rewind below is fine when we are switching to a fork (i.e.</span><span>
</span><span id="line-523"></span><span>        </span><span class="hs-comment">-- it is followed by rolling forward again), but we need some</span><span>
</span><span id="line-524"></span><span>        </span><span class="hs-comment">-- guarantees that the ChainSync protocol /does/ in fact give us a</span><span>
</span><span id="line-525"></span><span>        </span><span class="hs-comment">-- switch-to-fork instead of a true rollback.</span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621680036999"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036999"><span class="hs-identifier hs-var">theirFrag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036998"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036998"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, HasAnnTip blk) =&gt;
Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-var">attemptRollback</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037006"><span class="hs-identifier hs-var">intersection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037004"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680037003"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-528"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036996"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036996"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036995"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036995"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036996"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036995"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-comment">-- The @intersection@ is not on the candidate chain, even though</span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-comment">-- we sent only points from the candidate chain to find an</span><span>
</span><span id="line-531"></span><span>            </span><span class="hs-comment">-- intersection with. The node must have sent us an invalid</span><span>
</span><span id="line-532"></span><span>            </span><span class="hs-comment">-- intersection point.</span><span>
</span><span id="line-533"></span><span>            </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall (m' :: * -&gt; *) x'.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' x'
</span><a href="#local-6989586621680036994"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientException
 -&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; ChainSyncClientException
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-534"></span><span>              </span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientException
forall blk.
BlockSupportsProtocol blk =&gt;
Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-var">InvalidIntersection</span></a></span><span>
</span><span id="line-535"></span><span>                </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037006"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-536"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037004"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>                </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680037005"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-538"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036992"><span class="annot"><span class="annottext">kis :: KnownIntersectionState blk
</span><a href="#local-6989586621680036992"><span class="hs-identifier hs-var hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-539"></span><span>              </span><span class="annot"><span class="annottext">KnownIntersectionState :: forall blk.
AnchoredFragment (Header blk)
-&gt; HeaderStateHistory blk
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span>
</span><span id="line-540"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:theirFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036999"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-541"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036998"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-542"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ourFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680037004"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-543"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680037006"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-544"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-545"></span><span>        </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036992"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m
   (KnownIntersectionState blk)
   (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat 'Z
-&gt; Their (Tip blk)
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036990"><span class="hs-identifier hs-var">nextStep</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680037040"><span class="hs-identifier hs-var">mkPipelineDecision0</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680037005"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-comment">-- | Request the next message (roll forward or backward), unless our chain</span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-comment">-- has changed such that it no longer intersects with the candidate, in</span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- which case we initiate the intersection finding part of the protocol.</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-551"></span><span>    </span><span class="hs-comment">-- This is the main place we check whether our current chain has changed.</span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-comment">-- We also check it in 'rollForward' to make sure we have an up-to-date</span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-comment">-- intersection before calling 'getLedgerView'.</span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-comment">-- This is also the place where we checked whether we're asked to terminate</span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-comment">-- by the mux layer.</span><span>
</span><span id="line-557"></span><span>    </span><span id="local-6989586621680037427"><span class="annot"><a href="#local-6989586621680036990"><span class="hs-identifier hs-type">nextStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MkPipelineDecision</span></a></span><span>
</span><span id="line-558"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037427"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-559"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-561"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037427"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-563"></span><span>    </span><span id="local-6989586621680036990"><span class="annot"><span class="annottext">nextStep :: MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036990"><span class="hs-identifier hs-var hs-var">nextStep</span></a></span></span><span> </span><span id="local-6989586621680036988"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036988"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621680036987"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036987"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680036986"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036986"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; StatefulConsensus
      m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n))
-&gt; (KnownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036985"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036985"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>      </span><span class="annot"><span class="annottext">ControlMessageSTM m -&gt; m ControlMessage
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621680037032"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span> </span><span class="annot"><span class="annottext">m ControlMessage
-&gt; (ControlMessage
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-565"></span><span>        </span><span class="hs-comment">-- We have been asked to terminate the client</span><span>
</span><span id="line-566"></span><span>        </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">Terminate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-567"></span><span>          </span><span class="annot"><span class="annottext">Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="#local-6989586621680036983"><span class="hs-identifier hs-var">terminateAfterDrain</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036987"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientResult
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span>
</span><span id="line-568"></span><span>        </span><span id="local-6989586621680036981"><span class="annot"><span class="annottext">ControlMessage
</span><a href="#local-6989586621680036981"><span class="hs-identifier hs-var">_continue</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-569"></span><span>          </span><span id="local-6989586621680036980"><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="#local-6989586621680036980"><span class="hs-identifier hs-var">rechk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (IntersectsRecheck blk) -&gt; m (IntersectsRecheck blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (IntersectsRecheck blk) -&gt; m (IntersectsRecheck blk))
-&gt; STM m (IntersectsRecheck blk) -&gt; m (IntersectsRecheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#stillIntersectsWithCurrentChain"><span class="hs-identifier hs-var">stillIntersectsWithCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680037037"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036985"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-570"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; IntersectsRecheck blk -&gt; Maybe (KnownIntersectionState blk)
forall blk.
KnownIntersectionState blk
-&gt; IntersectsRecheck blk -&gt; Maybe (KnownIntersectionState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#recheckToMaybe"><span class="hs-identifier hs-var">recheckToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036985"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="#local-6989586621680036980"><span class="hs-identifier hs-var">rechk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-571"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036977"><span class="annot"><span class="annottext">kis' :: KnownIntersectionState blk
</span><a href="#local-6989586621680036977"><span class="hs-identifier hs-var">kis'</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680036976"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036976"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-572"></span><span>              </span><span class="hs-comment">-- Our chain (tip) didn't change or if it did, it still intersects</span><span>
</span><span id="line-573"></span><span>              </span><span class="hs-comment">-- with the candidate fragment, so we can continue requesting the</span><span>
</span><span id="line-574"></span><span>              </span><span class="hs-comment">-- next block.</span><span>
</span><span id="line-575"></span><span>              </span><span class="annot"><span class="annottext">CandidateFragment (Header blk) -&gt; m ()
</span><a href="#local-6989586621680037031"><span class="hs-identifier hs-var">setCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">CandidateFragment :: forall header.
Bool -&gt; AnchoredFragment header -&gt; CandidateFragment header
</span><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span>
</span><span id="line-576"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">candidateChain :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateChain"><span class="hs-identifier hs-var">candidateChain</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036976"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-577"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">candidateIsLowDensity :: Bool
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateIsLowDensity"><span class="hs-identifier hs-var">candidateIsLowDensity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-578"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-579"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036975"><span class="annot"><span class="annottext">candTipBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621680036975"><span class="hs-identifier hs-var hs-var">candTipBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; WithOrigin BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036976"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-580"></span><span>              </span><span class="annot"><span class="annottext">Consensus (ClientPipelinedStIdle n) blk m
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Consensus (ClientPipelinedStIdle n) blk m
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Consensus (ClientPipelinedStIdle n) blk m
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-581"></span><span>                </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621680036973"><span class="hs-identifier hs-var">requestNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036977"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036988"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036987"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036986"><span class="hs-identifier hs-var">theirTip</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680036975"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span>
</span><span id="line-582"></span><span>            </span><span class="annot"><span class="annottext">Maybe (KnownIntersectionState blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-583"></span><span>              </span><span class="hs-comment">-- Our chain (tip) has changed and it no longer intersects with</span><span>
</span><span id="line-584"></span><span>              </span><span class="hs-comment">-- the candidate fragment, so we have to find a new intersection,</span><span>
</span><span id="line-585"></span><span>              </span><span class="hs-comment">-- but first drain the pipe.</span><span>
</span><span id="line-586"></span><span>              </span><span class="annot"><span class="annottext">()
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>                </span><span class="annot"><span class="annottext">(Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036972"><span class="hs-identifier hs-var">drainThePipe</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036987"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-588"></span><span>                </span><span class="annot"><span class="annottext">(Stateful
   m
   ()
   (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037027"><span class="hs-identifier hs-var">findIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-var">NoMoreIntersection</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-comment">-- | &quot;Drain the pipe&quot;: collect and discard all in-flight responses and</span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-comment">-- finally execute the given action.</span><span>
</span><span id="line-592"></span><span>    </span><span class="annot"><a href="#local-6989586621680036972"><span class="hs-identifier hs-type">drainThePipe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037412"><span class="annot"><a href="#local-6989586621680037412"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680037411"><span class="annot"><a href="#local-6989586621680037411"><span class="hs-identifier hs-type">n</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621680037412"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-593"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037411"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-594"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037412"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037412"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037411"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>    </span><span id="local-6989586621680036972"><span class="annot"><span class="annottext">drainThePipe :: Nat n
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036972"><span class="hs-identifier hs-var hs-var">drainThePipe</span></a></span></span><span> </span><span id="local-6989586621680036970"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036970"><span class="hs-identifier hs-var">n0</span></a></span></span><span> </span><span id="local-6989586621680036969"><span class="annot"><span class="annottext">StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621680036969"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n))
-&gt; (s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Nat n -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621680036968"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036970"><span class="hs-identifier hs-var">n0</span></a></span><span>
</span><span id="line-597"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-598"></span><span>        </span><span class="annot"><a href="#local-6989586621680036968"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037407"><span class="annot"><a href="#local-6989586621680037407"><span class="hs-identifier hs-type">n'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037407"><span class="hs-identifier hs-type">n'</span></a></span><span>
</span><span id="line-599"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037412"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-600"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037407"><span class="hs-identifier hs-type">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>        </span><span id="local-6989586621680036968"><span class="annot"><span class="annottext">go :: Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621680036968"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621680036967"><span class="annot"><span class="annottext">Nat n'
</span><a href="#local-6989586621680036967"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680036966"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036966"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Nat n'
</span><a href="#local-6989586621680036967"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-602"></span><span>          </span><span class="annot"><span class="annottext">Nat n'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036966"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621680036969"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-603"></span><span>          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Succ</span></a></span><span> </span><span id="local-6989586621680036964"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036964"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; m (ClientPipelinedStIdle
         ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) (n1 :: N) header point tip a.
Maybe (m (ClientPipelinedStIdle ('S n1) header point tip m a))
-&gt; ClientStNext n1 header point tip m a
-&gt; ClientPipelinedStIdle ('S n1) header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">CollectResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(ClientStNext
   n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; ClientPipelinedStIdle
      ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientStNext :: forall (n :: N) header point tip (m :: * -&gt; *) a.
(header -&gt; tip -&gt; m (ClientPipelinedStIdle n header point tip m a))
-&gt; (point
    -&gt; tip -&gt; m (ClientPipelinedStIdle n header point tip m a))
-&gt; ClientStNext n header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientStNext</span></a></span><span>
</span><span id="line-604"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">recvMsgRollForward :: Header blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">recvMsgRollForward</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036960"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036960"><span class="hs-identifier hs-var">_hdr</span></a></span></span><span> </span><span id="local-6989586621680036959"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680036959"><span class="hs-identifier hs-var">_tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; s
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621680036968"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036964"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036966"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-605"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgRollBackward :: Point blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">recvMsgRollBackward</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036957"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036957"><span class="hs-identifier hs-var">_pt</span></a></span></span><span>  </span><span id="local-6989586621680036956"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680036956"><span class="hs-identifier hs-var">_tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; s
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621680036968"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036964"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036966"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-606"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span>    </span><span id="local-6989586621680037413"><span class="annot"><a href="#local-6989586621680036973"><span class="hs-identifier hs-type">requestNext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-609"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MkPipelineDecision</span></a></span><span>
</span><span id="line-610"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037413"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-611"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-613"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037413"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-614"></span><span>    </span><span id="local-6989586621680036973"><span class="annot"><span class="annottext">requestNext :: KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621680036973"><span class="hs-identifier hs-var hs-var">requestNext</span></a></span></span><span> </span><span id="local-6989586621680036955"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621680036954"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036954"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621680036953"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036953"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680036952"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036952"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span id="local-6989586621680036951"><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680036951"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-615"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036953"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(PipelineDecision n, MkPipelineDecision)
</span><a href="#local-6989586621680036950"><span class="hs-identifier hs-var">decision</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-616"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">Request</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036948"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036948"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-617"></span><span>            </span><span class="annot"><span class="annottext">ClientStNext
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientStNext
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall header point tip (m :: * -&gt; *) a.
ClientStNext 'Z header point tip m a
-&gt; m (ClientStNext 'Z header point tip m a)
-&gt; ClientPipelinedStIdle 'Z header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">SendMsgRequestNext</span></a></span><span>
</span><span id="line-618"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat 'Z
-&gt; ClientStNext
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621680036946"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036948"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientStNext
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientStNext
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ClientStNext
   'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; m (ClientStNext
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientStNext
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat 'Z
-&gt; ClientStNext
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621680036946"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036948"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- when we have to wait</span><span>
</span><span id="line-620"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">Pipeline</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036944"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036944"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-621"></span><span>            </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; Consensus (ClientPipelinedStIdle n) blk m
forall (n :: N) header point tip (m :: * -&gt; *) a.
ClientPipelinedStIdle ('S n) header point tip m a
-&gt; ClientPipelinedStIdle n header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">SendMsgRequestNextPipelined</span></a></span><span>
</span><span id="line-622"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat ('S n)
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621680036973"><span class="hs-identifier hs-var">requestNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036944"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S n)
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Succ</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036953"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036952"><span class="hs-identifier hs-var">theirTip</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680036951"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Succ</span></a></span><span> </span><span id="local-6989586621680036942"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036942"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">CollectOrPipeline</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036940"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036940"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-624"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) (n1 :: N) header point tip a.
Maybe (m (ClientPipelinedStIdle ('S n1) header point tip m a))
-&gt; ClientStNext n1 header point tip m a
-&gt; ClientPipelinedStIdle ('S n1) header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">CollectResponse</span></a></span><span>
</span><span id="line-625"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Maybe
     (m (ClientPipelinedStIdle
           ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m (ClientPipelinedStIdle
      ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Maybe
      (m (ClientPipelinedStIdle
            ('S n)
            (Header blk)
            (Point blk)
            (Tip blk)
            m
            ChainSyncClientResult)))
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Maybe
     (m (ClientPipelinedStIdle
           ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; m (ClientPipelinedStIdle
         ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S ('S n))
  (Header blk)
  (Point blk)
  (Tip blk)
  m
  ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N) header point tip (m :: * -&gt; *) a.
ClientPipelinedStIdle ('S n) header point tip m a
-&gt; ClientPipelinedStIdle n header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">SendMsgRequestNextPipelined</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   ('S ('S n))
   (Header blk)
   (Point blk)
   (Tip blk)
   m
   ChainSyncClientResult
 -&gt; ClientPipelinedStIdle
      ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientPipelinedStIdle
     ('S ('S n))
     (Header blk)
     (Point blk)
     (Tip blk)
     m
     ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-626"></span><span>                </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat ('S ('S n))
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; ClientPipelinedStIdle
     ('S ('S n))
     (Header blk)
     (Point blk)
     (Tip blk)
     m
     ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621680036973"><span class="hs-identifier hs-var">requestNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036940"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S ('S n))
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Succ</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036953"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036952"><span class="hs-identifier hs-var">theirTip</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680036951"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621680036946"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036940"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036942"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-628"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Succ</span></a></span><span> </span><span id="local-6989586621680036939"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036939"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">Collect</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036937"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036937"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-629"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) (n1 :: N) header point tip a.
Maybe (m (ClientPipelinedStIdle ('S n1) header point tip m a))
-&gt; ClientStNext n1 header point tip m a
-&gt; ClientPipelinedStIdle ('S n1) header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">CollectResponse</span></a></span><span>
</span><span id="line-630"></span><span>              </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-631"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621680036946"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036955"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036937"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036939"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-633"></span><span>        </span><span id="local-6989586621680036936"><span class="annot"><span class="annottext">theirTipBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621680036936"><span class="hs-identifier hs-var hs-var">theirTipBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; WithOrigin BlockNo
forall b. Tip b -&gt; WithOrigin BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">getTipBlockNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Their (Tip blk) -&gt; Tip blk
forall a. Their a -&gt; a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AunTheir%3ATheir"><span class="hs-identifier hs-var hs-var">unTheir</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036952"><span class="hs-identifier hs-var">theirTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-634"></span><span>        </span><span id="local-6989586621680036950"><span class="annot"><span class="annottext">decision :: (PipelineDecision n, MkPipelineDecision)
</span><a href="#local-6989586621680036950"><span class="hs-identifier hs-var hs-var">decision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; WithOrigin BlockNo
-&gt; WithOrigin BlockNo
-&gt; (PipelineDecision n, MkPipelineDecision)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; WithOrigin BlockNo
-&gt; WithOrigin BlockNo
-&gt; (PipelineDecision n, MkPipelineDecision)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">runPipelineDecision</span></a></span><span>
</span><span id="line-635"></span><span>          </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036954"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span>
</span><span id="line-636"></span><span>          </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036953"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-637"></span><span>          </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680036951"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span>
</span><span id="line-638"></span><span>          </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621680036936"><span class="hs-identifier hs-var">theirTipBlockNo</span></a></span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span>    </span><span id="local-6989586621680037393"><span class="annot"><a href="#local-6989586621680036946"><span class="hs-identifier hs-type">handleNext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-641"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MkPipelineDecision</span></a></span><span>
</span><span id="line-642"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037393"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-643"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientStNext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037393"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-644"></span><span>    </span><span id="local-6989586621680036946"><span class="annot"><span class="annottext">handleNext :: KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621680036946"><span class="hs-identifier hs-var hs-var">handleNext</span></a></span></span><span> </span><span id="local-6989586621680036934"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036934"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621680036933"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036933"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621680036932"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036932"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientStNext :: forall (n :: N) header point tip (m :: * -&gt; *) a.
(header -&gt; tip -&gt; m (ClientPipelinedStIdle n header point tip m a))
-&gt; (point
    -&gt; tip -&gt; m (ClientPipelinedStIdle n header point tip m a))
-&gt; ClientStNext n header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientStNext</span></a></span><span>
</span><span id="line-645"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">recvMsgRollForward :: Header blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">recvMsgRollForward</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036931"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036931"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621680036930"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680036930"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-646"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037039"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; TraceChainSyncClientEvent blk
forall blk. Header blk -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceDownloadedHeader"><span class="hs-identifier hs-var">TraceDownloadedHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036931"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-647"></span><span>          </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036934"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m
   (KnownIntersectionState blk)
   (ClientPipelinedStIdle
      n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; m (ClientPipelinedStIdle
         n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-648"></span><span>            </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036928"><span class="hs-identifier hs-var">rollForward</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036933"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036932"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036931"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680036930"><span class="hs-identifier hs-var">theirTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgRollBackward :: Point blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">recvMsgRollBackward</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036927"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036927"><span class="hs-identifier hs-var">intersection</span></a></span></span><span> </span><span id="local-6989586621680036926"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680036926"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-650"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680036925"><span class="hs-identifier hs-type">intersection'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-651"></span><span>              </span><span id="local-6989586621680036925"><span class="annot"><span class="annottext">intersection' :: Point blk
</span><a href="#local-6989586621680036925"><span class="hs-identifier hs-var hs-var">intersection'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036927"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-652"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037039"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; TraceChainSyncClientEvent blk
forall blk. Point blk -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceRolledBack"><span class="hs-identifier hs-var">TraceRolledBack</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036925"><span class="hs-identifier hs-var">intersection'</span></a></span><span>
</span><span id="line-653"></span><span>          </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036934"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m
   (KnownIntersectionState blk)
   (ClientPipelinedStIdle
      n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; m (ClientPipelinedStIdle
         n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-654"></span><span>            </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m
     (KnownIntersectionState blk)
     (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Point blk
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036923"><span class="hs-identifier hs-var">rollBackward</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036933"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036932"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036925"><span class="hs-identifier hs-var">intersection'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621680036926"><span class="hs-identifier hs-var">theirTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-comment">-- This handler validates the received header. It cannot do so before</span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-comment">-- acquiring a 'LedgerView' for that header's slot.</span><span>
</span><span id="line-659"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-660"></span><span>    </span><span class="hs-comment">-- Under normal circumstances, the 'LedgerView' is forecast from the</span><span>
</span><span id="line-661"></span><span>    </span><span class="hs-comment">-- (cached) 'LedgerState' that resulted from applying the block that is the</span><span>
</span><span id="line-662"></span><span>    </span><span class="hs-comment">-- 'mostRecentIntersection' of the peer's chain with the (local node's)</span><span>
</span><span id="line-663"></span><span>    </span><span class="hs-comment">-- current chain. However, if the peer's chain has reached a low enough</span><span>
</span><span id="line-664"></span><span>    </span><span class="hs-comment">-- density (low enough to indicate a disaster of some sort), we will not be</span><span>
</span><span id="line-665"></span><span>    </span><span class="hs-comment">-- able to forecast from the intersection's ledger state to the new</span><span>
</span><span id="line-666"></span><span>    </span><span class="hs-comment">-- header's slot.</span><span>
</span><span id="line-667"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-668"></span><span>    </span><span class="hs-comment">-- There are two possible ways foward in the low-density case. First, we</span><span>
</span><span id="line-669"></span><span>    </span><span class="hs-comment">-- can reactively wait until our current chain evolves such that the</span><span>
</span><span id="line-670"></span><span>    </span><span class="hs-comment">-- intersection becomes recent enough that the new forecast range reaches</span><span>
</span><span id="line-671"></span><span>    </span><span class="hs-comment">-- the RollForward header. (Note that this is not gauranteed to happen.)</span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-comment">-- Second, we can proactively begin fetching the blocks on their chain. In</span><span>
</span><span id="line-673"></span><span>    </span><span class="hs-comment">-- general, these fetchs will not affect the local node's current chain</span><span>
</span><span id="line-674"></span><span>    </span><span class="hs-comment">-- selection. Each block we fetch lets us advance the intersection's ledger</span><span>
</span><span id="line-675"></span><span>    </span><span class="hs-comment">-- state through time by applying block to it (via 'tickThenReapply'). This</span><span>
</span><span id="line-676"></span><span>    </span><span class="hs-comment">-- advancement is happening temporarily, in this ChainSync client's</span><span>
</span><span id="line-677"></span><span>    </span><span class="hs-comment">-- ephemeral local state; we're not affecting the local node's selected</span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-comment">-- chain at all. Eventually that advanced ledger state will either be able</span><span>
</span><span id="line-679"></span><span>    </span><span class="hs-comment">-- to forecast the ledger view for the RollForward header's slot or else it</span><span>
</span><span id="line-680"></span><span>    </span><span class="hs-comment">-- will actually be the ledger state in which that header was forged and so</span><span>
</span><span id="line-681"></span><span>    </span><span class="hs-comment">-- we can simply tick it up to the necessary slot. In that latter case,</span><span>
</span><span id="line-682"></span><span>    </span><span class="hs-comment">-- since there are no blocks in between, we need not do any /forecasting/.</span><span>
</span><span id="line-683"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-684"></span><span>    </span><span class="hs-comment">-- We support both of those ways forward: we react to changes in the local</span><span>
</span><span id="line-685"></span><span>    </span><span class="hs-comment">-- node's current chain and, for a low density chain, we /simultaneously/</span><span>
</span><span id="line-686"></span><span>    </span><span class="hs-comment">-- instruct BlockFetch to fetch the blocks on the peer's chain (but only up</span><span>
</span><span id="line-687"></span><span>    </span><span class="hs-comment">-- to @k@ blocks after the intersection) and ephemerally apply them as</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- discussed above they become available.</span><span>
</span><span id="line-689"></span><span>    </span><span id="local-6989586621680037383"><span class="annot"><a href="#local-6989586621680036928"><span class="hs-identifier hs-type">rollForward</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MkPipelineDecision</span></a></span><span>
</span><span id="line-690"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037383"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-691"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-692"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-694"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037383"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-696"></span><span>    </span><span id="local-6989586621680036928"><span class="annot"><span class="annottext">rollForward :: MkPipelineDecision
-&gt; Nat n
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036928"><span class="hs-identifier hs-var hs-var">rollForward</span></a></span></span><span> </span><span id="local-6989586621680036922"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036922"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621680036921"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036921"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680036920"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621680036919"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036919"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span>
</span><span id="line-697"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; StatefulConsensus
      m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n))
-&gt; (KnownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036918"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036918"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a. m a -&gt; m a
</span><a href="#local-6989586621680037000"><span class="hs-identifier hs-var">traceException</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-698"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036917"><span class="annot"><span class="annottext">hdrSlot :: SlotNo
</span><a href="#local-6989586621680036917"><span class="hs-identifier hs-var hs-var">hdrSlot</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockSlot</span></a></span><span>   </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-699"></span><span>          </span><span id="local-6989586621680036915"><span class="annot"><span class="annottext">hdrPoint :: Point blk
</span><a href="#local-6989586621680036915"><span class="hs-identifier hs-var hs-var">hdrPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-700"></span><span>      </span><span class="hs-comment">-- Reject the block if invalid</span><span>
</span><span id="line-701"></span><span>      </span><span id="local-6989586621680036913"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621680036913"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
 -&gt; m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
 -&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621680037034"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>
</span><span id="line-702"></span><span>      </span><span class="annot"><span class="annottext">Maybe (InvalidBlockReason blk)
-&gt; (InvalidBlockReason blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621680036913"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span>  </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((InvalidBlockReason blk -&gt; m ()) -&gt; m ())
-&gt; (InvalidBlockReason blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036909"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036909"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-703"></span><span>        </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m ()
forall (m' :: * -&gt; *) x'.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' x'
</span><a href="#local-6989586621680036994"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientException -&gt; m ())
-&gt; ChainSyncClientException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; InvalidBlockReason blk -&gt; ChainSyncClientException
forall blk.
LedgerSupportsProtocol blk =&gt;
Point blk -&gt; InvalidBlockReason blk -&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036915"><span class="hs-identifier hs-var">hdrPoint</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036909"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>      </span><span class="hs-comment">-- Get the ledger view required to validate the header</span><span>
</span><span id="line-706"></span><span>      </span><span id="local-6989586621680036907"><span class="annot"><span class="annottext">LedgerViewCheck blk
</span><a href="#local-6989586621680036907"><span class="hs-identifier hs-var">intersectCheck</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (m (LedgerViewCheck blk)) -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(m (m (LedgerViewCheck blk)) -&gt; m (LedgerViewCheck blk))
-&gt; m (m (LedgerViewCheck blk)) -&gt; m (LedgerViewCheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (m (LedgerViewCheck blk)) -&gt; m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (m (LedgerViewCheck blk)) -&gt; m (m (LedgerViewCheck blk)))
-&gt; STM m (m (LedgerViewCheck blk)) -&gt; m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-707"></span><span>        </span><span id="local-6989586621680036906"><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="#local-6989586621680036906"><span class="hs-identifier hs-var">rechk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#stillIntersectsWithCurrentChain"><span class="hs-identifier hs-var">stillIntersectsWithCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680037037"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036918"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-708"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; IntersectsRecheck blk -&gt; Maybe (KnownIntersectionState blk)
forall blk.
KnownIntersectionState blk
-&gt; IntersectsRecheck blk -&gt; Maybe (KnownIntersectionState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#recheckToMaybe"><span class="hs-identifier hs-var">recheckToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036918"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="#local-6989586621680036906"><span class="hs-identifier hs-var">rechk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-709"></span><span>          </span><span class="annot"><span class="annottext">Maybe (KnownIntersectionState blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk
forall blk. LedgerViewCheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span>
</span><span id="line-710"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036904"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036904"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-711"></span><span>              </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
-&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036904"><span class="hs-identifier hs-var">kis'</span></a></span><span>
</span><span id="line-712"></span><span>                </span><span class="annot"><span class="annottext">(Stateful
   (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
 -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
-&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkDensityOrContinue"><span class="hs-identifier hs-var">checkDensityOrContinue</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680037037"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036917"><span class="hs-identifier hs-var">hdrSlot</span></a></span><span>
</span><span id="line-713"></span><span>                </span><span class="annot"><span class="annottext">(Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
 -&gt; Stateful
      (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk)))
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; (CandidateFragment (Header blk) -&gt; m ())
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; (CandidateFragment (Header blk) -&gt; m ())
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#lowDensityHandler"><span class="hs-identifier hs-var">lowDensityHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680037037"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">CandidateFragment (Header blk) -&gt; m ()
</span><a href="#local-6989586621680037031"><span class="hs-identifier hs-var">setCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036917"><span class="hs-identifier hs-var">hdrSlot</span></a></span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk
</span><a href="#local-6989586621680036907"><span class="hs-identifier hs-var">intersectCheck</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-716"></span><span>        </span><span class="annot"><span class="annottext">LedgerViewCheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-717"></span><span>          </span><span class="hs-comment">-- Our chain (tip) has changed and it no longer intersects with the</span><span>
</span><span id="line-718"></span><span>          </span><span class="hs-comment">-- candidate fragment, so we have to find a new intersection, but</span><span>
</span><span id="line-719"></span><span>          </span><span class="hs-comment">-- first drain the pipe.</span><span>
</span><span id="line-720"></span><span>          </span><span class="annot"><span class="annottext">()
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>            </span><span class="annot"><span class="annottext">(Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036972"><span class="hs-identifier hs-var">drainThePipe</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036921"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-722"></span><span>            </span><span class="annot"><span class="annottext">(Stateful
   m
   ()
   (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037027"><span class="hs-identifier hs-var">findIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-var">NoMoreIntersection</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewAcquired"><span class="hs-identifier hs-type">LedgerViewAcquired</span></a></span><span> </span><span id="local-6989586621680036900"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036900"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span id="local-6989586621680036899"><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036899"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-725"></span><span>          </span><span class="hs-comment">-- Our chain still intersects with the candidate fragment and we</span><span>
</span><span id="line-726"></span><span>          </span><span class="hs-comment">-- have obtained a 'LedgerView' that we can use to validate @hdr@.</span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-729"></span><span>                  </span><span id="local-6989586621680036898"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
$sel:ourFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036898"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-730"></span><span>                </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036897"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036897"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-731"></span><span>                </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036896"><span class="annot"><span class="annottext">HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="#local-6989586621680036896"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-732"></span><span>                </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036895"><span class="annot"><span class="annottext">Point blk
mostRecentIntersection :: Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
</span><a href="#local-6989586621680036895"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-733"></span><span>                </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036900"><span class="hs-identifier hs-var">kis'</span></a></span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span>          </span><span class="hs-comment">-- Validate header</span><span>
</span><span id="line-736"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036894"><span class="annot"><span class="annottext">expectPrevHash :: ChainHash blk
</span><a href="#local-6989586621680036894"><span class="hs-identifier hs-var hs-var">expectPrevHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainHash (Header blk) -&gt; ChainHash blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
ChainHash b -&gt; ChainHash b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; ChainHash (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; ChainHash block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headHash</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036897"><span class="hs-identifier hs-var">theirFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>              </span><span id="local-6989586621680036891"><span class="annot"><span class="annottext">actualPrevHash :: ChainHash blk
</span><a href="#local-6989586621680036891"><span class="hs-identifier hs-var hs-var">actualPrevHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; ChainHash blk
forall blk. GetPrevHash blk =&gt; Header blk -&gt; ChainHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPrevHash"><span class="hs-identifier hs-var">headerPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-738"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036891"><span class="hs-identifier hs-var">actualPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; ChainHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036894"><span class="hs-identifier hs-var">expectPrevHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-739"></span><span>            </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m ()
forall (m' :: * -&gt; *) x'.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' x'
</span><a href="#local-6989586621680036994"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientException -&gt; m ())
-&gt; ChainSyncClientException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-740"></span><span>              </span><span class="annot"><span class="annottext">ChainHash blk
-&gt; ChainHash blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; ChainSyncClientException
forall blk.
BlockSupportsProtocol blk =&gt;
ChainHash blk
-&gt; ChainHash blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DoesntFit"><span class="hs-identifier hs-var">DoesntFit</span></a></span><span>
</span><span id="line-741"></span><span>                </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036891"><span class="hs-identifier hs-var">actualPrevHash</span></a></span><span>
</span><span id="line-742"></span><span>                </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036894"><span class="hs-identifier hs-var">expectPrevHash</span></a></span><span>
</span><span id="line-743"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036898"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span>                </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036919"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>          </span><span id="local-6989586621680036887"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036887"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-747"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Except (HeaderError blk) (HeaderStateHistory blk)
-&gt; Either (HeaderError blk) (HeaderStateHistory blk)
forall e a. Except e a -&gt; Either e a
</span><span class="hs-identifier hs-var">runExcept</span></span><span> </span><span class="annot"><span class="annottext">(Except (HeaderError blk) (HeaderStateHistory blk)
 -&gt; Either (HeaderError blk) (HeaderStateHistory blk))
-&gt; Except (HeaderError blk) (HeaderStateHistory blk)
-&gt; Either (HeaderError blk) (HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; Ticked (LedgerView (BlockProtocol blk))
-&gt; Header blk
-&gt; HeaderStateHistory blk
-&gt; Except (HeaderError blk) (HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, ValidateEnvelope blk) =&gt;
TopLevelConfig blk
-&gt; Ticked (LedgerView (BlockProtocol blk))
-&gt; Header blk
-&gt; HeaderStateHistory blk
-&gt; Except (HeaderError blk) (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.HeaderStateHistory.html#validateHeader"><span class="hs-identifier hs-var">validateHeader</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036899"><span class="hs-identifier hs-var">ledgerView</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036896"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-748"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680036885"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036885"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk -&gt; m (HeaderStateHistory blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036885"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span><span>
</span><span id="line-749"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621680036884"><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621680036884"><span class="hs-identifier hs-var">vErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-750"></span><span>                </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m (HeaderStateHistory blk)
forall (m' :: * -&gt; *) x'.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' x'
</span><a href="#local-6989586621680036994"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientException -&gt; m (HeaderStateHistory blk))
-&gt; ChainSyncClientException -&gt; m (HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-751"></span><span>                  </span><span class="annot"><span class="annottext">Point blk
-&gt; HeaderError blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; ChainSyncClientException
forall blk.
(BlockSupportsProtocol blk, ValidateEnvelope blk) =&gt;
Point blk
-&gt; HeaderError blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-var">HeaderError</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036915"><span class="hs-identifier hs-var">hdrPoint</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621680036884"><span class="hs-identifier hs-var">vErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036898"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036919"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-752"></span><span>
</span><span id="line-753"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036882"><span class="annot"><span class="annottext">theirFrag' :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036882"><span class="hs-identifier hs-var hs-var">theirFrag'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036897"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Header blk -&gt; AnchoredFragment (Header blk)
forall v a b.
Anchorable v a b =&gt;
AnchoredSeq v a b -&gt; b -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-operator hs-var">:&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-754"></span><span>              </span><span class="hs-comment">-- Advance the most recent intersection if we have the same header</span><span>
</span><span id="line-755"></span><span>              </span><span class="hs-comment">-- on our fragment too. This is cheaper than recomputing the</span><span>
</span><span id="line-756"></span><span>              </span><span class="hs-comment">-- intersection from scratch.</span><span>
</span><span id="line-757"></span><span>              </span><span id="local-6989586621680036880"><span class="annot"><span class="annottext">mostRecentIntersection' :: Point blk
</span><a href="#local-6989586621680036880"><span class="hs-identifier hs-var hs-var">mostRecentIntersection'</span></a></span></span><span>
</span><span id="line-758"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036879"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036879"><span class="hs-identifier hs-var">ourSuccessor</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-759"></span><span>                    </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Maybe (Header blk)
forall block.
HasHeader block =&gt;
Point block -&gt; AnchoredFragment block -&gt; Maybe block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.successorBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036895"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036898"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-760"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036879"><span class="hs-identifier hs-var">ourSuccessor</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; HeaderHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-761"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036920"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-762"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-763"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036895"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-764"></span><span>              </span><span id="local-6989586621680036877"><span class="annot"><span class="annottext">kis'' :: KnownIntersectionState blk
</span><a href="#local-6989586621680036877"><span class="hs-identifier hs-var hs-var">kis''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-765"></span><span>                </span><span class="annot"><span class="annottext">KnownIntersectionState :: forall blk.
AnchoredFragment (Header blk)
-&gt; HeaderStateHistory blk
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-766"></span><span>                    </span><span class="annot"><span class="annottext">$sel:theirFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036882"><span class="hs-identifier hs-var">theirFrag'</span></a></span><span>
</span><span id="line-767"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036887"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span><span>
</span><span id="line-768"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ourFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036898"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-769"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036880"><span class="hs-identifier hs-var">mostRecentIntersection'</span></a></span><span>
</span><span id="line-770"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span>          </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036877"><span class="hs-identifier hs-var">kis''</span></a></span><span> </span><span class="annot"><span class="annottext">(StatefulConsensus
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036990"><span class="hs-identifier hs-var">nextStep</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036922"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036921"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036919"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621680037382"><span class="annot"><a href="#local-6989586621680036923"><span class="hs-identifier hs-type">rollBackward</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MkPipelineDecision</span></a></span><span>
</span><span id="line-775"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037382"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-776"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-777"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-type">StatefulConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-779"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037382"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-781"></span><span>    </span><span id="local-6989586621680036923"><span class="annot"><span class="annottext">rollBackward :: MkPipelineDecision
-&gt; Nat n
-&gt; Point blk
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036923"><span class="hs-identifier hs-var hs-var">rollBackward</span></a></span></span><span> </span><span id="local-6989586621680036876"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036876"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621680036875"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036875"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680036874"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036874"><span class="hs-identifier hs-var">rollBackPoint</span></a></span></span><span>
</span><span id="line-782"></span><span>                 </span><span id="local-6989586621680036873"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036873"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span>
</span><span id="line-783"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; StatefulConsensus
      m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n))
-&gt; (KnownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span>
</span><span id="line-784"></span><span>                   </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680036872"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036872"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-785"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036871"><span class="annot"><span class="annottext">HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="#local-6989586621680036871"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-786"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036870"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
$sel:ourFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036870"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-787"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036869"><span class="annot"><span class="annottext">Point blk
mostRecentIntersection :: Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
</span><a href="#local-6989586621680036869"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-788"></span><span>                   </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a. m a -&gt; m a
</span><a href="#local-6989586621680037000"><span class="hs-identifier hs-var">traceException</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, HasAnnTip blk) =&gt;
Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-var">attemptRollback</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036874"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036872"><span class="hs-identifier hs-var">theirFrag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036871"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-790"></span><span>          </span><span class="hs-comment">-- Remember that we use our current chain fragment as the starting</span><span>
</span><span id="line-791"></span><span>          </span><span class="hs-comment">-- point for the candidate's chain. Our fragment contained @k@</span><span>
</span><span id="line-792"></span><span>          </span><span class="hs-comment">-- headers. At this point, the candidate fragment might have grown to</span><span>
</span><span id="line-793"></span><span>          </span><span class="hs-comment">-- more than @k@ or rolled back to less than @k@ headers.</span><span>
</span><span id="line-794"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-795"></span><span>          </span><span class="hs-comment">-- But now, it rolled back to some point that is not on the fragment,</span><span>
</span><span id="line-796"></span><span>          </span><span class="hs-comment">-- which means that it tried to roll back to some point before one of</span><span>
</span><span id="line-797"></span><span>          </span><span class="hs-comment">-- the last @k@ headers we initially started from. We could never</span><span>
</span><span id="line-798"></span><span>          </span><span class="hs-comment">-- switch to this fork anyway, so just disconnect. Furthermore, our</span><span>
</span><span id="line-799"></span><span>          </span><span class="hs-comment">-- current chain might have advanced in the meantime, so the point we</span><span>
</span><span id="line-800"></span><span>          </span><span class="hs-comment">-- would have to roll back to might have been much further back than</span><span>
</span><span id="line-801"></span><span>          </span><span class="hs-comment">-- @k@ blocks (&gt; @k@ + the number of blocks we have advanced since</span><span>
</span><span id="line-802"></span><span>          </span><span class="hs-comment">-- starting syncing).</span><span>
</span><span id="line-803"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-804"></span><span>          </span><span class="hs-comment">-- INVARIANT: a candidate fragment contains @&gt;=k@ headers (unless</span><span>
</span><span id="line-805"></span><span>          </span><span class="hs-comment">-- near genesis, in which case we mean the total number of blocks in</span><span>
</span><span id="line-806"></span><span>          </span><span class="hs-comment">-- the fragment) minus @r@ headers where @r &lt;= k@. This ghost</span><span>
</span><span id="line-807"></span><span>          </span><span class="hs-comment">-- variable @r@ indicates the number of headers we temporarily</span><span>
</span><span id="line-808"></span><span>          </span><span class="hs-comment">-- rolled back. Such a rollback must always be followed by rolling</span><span>
</span><span id="line-809"></span><span>          </span><span class="hs-comment">-- forward @s@ new headers where @s &gt;= r@.</span><span>
</span><span id="line-810"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-811"></span><span>          </span><span class="hs-comment">-- Thus, @k - r + s &gt;= k@.</span><span>
</span><span id="line-812"></span><span>          </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-813"></span><span>            </span><span class="annot"><span class="annottext">Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="#local-6989586621680036983"><span class="hs-identifier hs-var">terminateAfterDrain</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036875"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientResult
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-814"></span><span>              </span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-var">RolledBackPastIntersection</span></a></span><span>
</span><span id="line-815"></span><span>                </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036874"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span>
</span><span id="line-816"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036870"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>                </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036873"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036867"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036867"><span class="hs-identifier hs-var">theirFrag'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036866"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036866"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-820"></span><span>            </span><span class="hs-comment">-- We just rolled back to @intersection@, either our most recent</span><span>
</span><span id="line-821"></span><span>            </span><span class="hs-comment">-- intersection was after or at @intersection@, in which case</span><span>
</span><span id="line-822"></span><span>            </span><span class="hs-comment">-- @intersection@ becomes the new most recent intersection.</span><span>
</span><span id="line-823"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-824"></span><span>            </span><span class="hs-comment">-- But if the most recent intersection was /before/ @intersection@,</span><span>
</span><span id="line-825"></span><span>            </span><span class="hs-comment">-- then the most recent intersection doesn't change.</span><span>
</span><span id="line-826"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036865"><span class="annot"><span class="annottext">mostRecentIntersection' :: Point blk
</span><a href="#local-6989586621680036865"><span class="hs-identifier hs-var hs-var">mostRecentIntersection'</span></a></span></span><span>
</span><span id="line-827"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; AnchoredFragment (Header blk) -&gt; Bool
forall block.
HasHeader block =&gt;
Point block -&gt; AnchoredFragment block -&gt; Bool
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.withinFragmentBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036874"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036870"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-828"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036874"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span>
</span><span id="line-829"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-830"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036869"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-831"></span><span>                </span><span id="local-6989586621680036863"><span class="annot"><span class="annottext">kis' :: KnownIntersectionState blk
</span><a href="#local-6989586621680036863"><span class="hs-identifier hs-var hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-832"></span><span>                  </span><span class="annot"><span class="annottext">KnownIntersectionState :: forall blk.
AnchoredFragment (Header blk)
-&gt; HeaderStateHistory blk
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-833"></span><span>                      </span><span class="annot"><span class="annottext">$sel:theirFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036867"><span class="hs-identifier hs-var">theirFrag'</span></a></span><span>
</span><span id="line-834"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036866"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span><span>
</span><span id="line-835"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ourFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036870"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-836"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036865"><span class="hs-identifier hs-var">mostRecentIntersection'</span></a></span><span>
</span><span id="line-837"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span>            </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036863"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">(StatefulConsensus
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; StatefulConsensus
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036990"><span class="hs-identifier hs-var">nextStep</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621680036876"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036875"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036873"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-comment">-- | Gracefully terminate the connection with the upstream node with the</span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-comment">-- given result.</span><span>
</span><span id="line-843"></span><span>    </span><span class="annot"><a href="#local-6989586621680037008"><span class="hs-identifier hs-type">terminate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Z</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>    </span><span id="local-6989586621680037008"><span class="annot"><span class="annottext">terminate :: ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037008"><span class="hs-identifier hs-var hs-var">terminate</span></a></span></span><span> </span><span id="local-6989586621680036862"><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621680036862"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-845"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037039"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncClientResult -&gt; TraceChainSyncClientEvent blk
forall blk. ChainSyncClientResult -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceTermination"><span class="hs-identifier hs-var">TraceTermination</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621680036862"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>      </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a header point tip (m :: * -&gt; *).
a -&gt; ClientPipelinedStIdle 'Z header point tip m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">SendMsgDone</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621680036862"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span>    </span><span class="hs-comment">-- | Same as 'terminate', but first 'drainThePipe'.</span><span>
</span><span id="line-849"></span><span>    </span><span id="local-6989586621680037420"><span class="annot"><a href="#local-6989586621680036983"><span class="hs-identifier hs-type">terminateAfterDrain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037420"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037420"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-850"></span><span>    </span><span id="local-6989586621680036983"><span class="annot"><span class="annottext">terminateAfterDrain :: Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="#local-6989586621680036983"><span class="hs-identifier hs-var hs-var">terminateAfterDrain</span></a></span></span><span> </span><span id="local-6989586621680036859"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036859"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680036858"><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621680036858"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-851"></span><span>          </span><span class="annot"><span class="annottext">()
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-852"></span><span>        </span><span class="annot"><span class="annottext">(Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle 'Z)
-&gt; StatefulConsensus m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621680036972"><span class="hs-identifier hs-var">drainThePipe</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621680036859"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-853"></span><span>        </span><span class="annot"><span class="annottext">(Stateful
   m
   ()
   (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Stateful m () (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(()
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((()
  -&gt; m (ClientPipelinedStIdle
          'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
 -&gt; Stateful
      m
      ()
      (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; (()
    -&gt; m (ClientPipelinedStIdle
            'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m
     ()
     (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m (ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ()
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(m (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; ()
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ()
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621680037008"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621680036858"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>    </span><span class="hs-comment">-- | Disconnect from the upstream node by throwing the given exception.</span><span>
</span><span id="line-856"></span><span>    </span><span class="hs-comment">-- The cleanup is handled in 'bracketChainSyncClient'.</span><span>
</span><span id="line-857"></span><span>    </span><span class="annot"><a href="#local-6989586621680036994"><span class="hs-identifier hs-type">disconnect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037434"><span class="annot"><a href="#local-6989586621680037434"><span class="hs-identifier hs-type">m'</span></a></span></span><span> </span><span id="local-6989586621680037433"><span class="annot"><a href="#local-6989586621680037433"><span class="hs-identifier hs-type">x'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037434"><span class="hs-identifier hs-type">m'</span></a></span><span>
</span><span id="line-858"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037434"><span class="hs-identifier hs-type">m'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037433"><span class="hs-identifier hs-type">x'</span></a></span><span>
</span><span id="line-859"></span><span>    </span><span id="local-6989586621680036994"><span class="annot"><span class="annottext">disconnect :: ChainSyncClientException -&gt; m' x'
</span><a href="#local-6989586621680036994"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m' x'
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span>
</span><span id="line-860"></span><span>
</span><span id="line-861"></span><span>    </span><span class="hs-comment">-- | Trace any 'ChainSyncClientException' if thrown.</span><span>
</span><span id="line-862"></span><span>    </span><span id="local-6989586621680037437"><span class="annot"><a href="#local-6989586621680037000"><span class="hs-identifier hs-type">traceException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037437"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037437"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-863"></span><span>    </span><span id="local-6989586621680037000"><span class="annot"><span class="annottext">traceException :: m a -&gt; m a
</span><a href="#local-6989586621680037000"><span class="hs-identifier hs-var hs-var">traceException</span></a></span></span><span> </span><span id="local-6989586621680036855"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621680036855"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621680036855"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (ChainSyncClientException -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680036853"><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621680036853"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-864"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680037039"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
forall blk.
ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceException"><span class="hs-identifier hs-var">TraceException</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621680036853"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-865"></span><span>      </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621680036853"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-866"></span><span>
</span><span id="line-867"></span><span>    </span><span class="annot"><a href="#local-6989586621680037007"><span class="hs-identifier hs-type">ourTipFromChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-868"></span><span>    </span><span id="local-6989586621680037007"><span class="annot"><span class="annottext">ourTipFromChain :: AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="#local-6989586621680037007"><span class="hs-identifier hs-var hs-var">ourTipFromChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; Our (Tip blk)
forall a. a -&gt; Our a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-var">Our</span></a></span><span> </span><span class="annot"><span class="annottext">(Tip blk -&gt; Our (Tip blk))
-&gt; (AnchoredFragment (Header blk) -&gt; Tip blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Our (Tip blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk) -&gt; Tip blk
forall a b. (HeaderHash a ~ HeaderHash b) =&gt; Anchor a -&gt; Tip b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorToTip</span></a></span><span> </span><span class="annot"><span class="annottext">(Anchor (Header blk) -&gt; Tip blk)
-&gt; (AnchoredFragment (Header blk) -&gt; Anchor (Header blk))
-&gt; AnchoredFragment (Header blk)
-&gt; Tip blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Anchor (Header blk)
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headAnchor</span></a></span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span>    </span><span class="hs-comment">-- Recent offsets</span><span>
</span><span id="line-871"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-872"></span><span>    </span><span class="hs-comment">-- These offsets are used to find an intersection point between our chain</span><span>
</span><span id="line-873"></span><span>    </span><span class="hs-comment">-- and the upstream node's. We use the fibonacci sequence to try blocks</span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-comment">-- closer to our tip, and fewer blocks further down the chain. It is</span><span>
</span><span id="line-875"></span><span>    </span><span class="hs-comment">-- important that this sequence constains at least a point @k@ back: if no</span><span>
</span><span id="line-876"></span><span>    </span><span class="hs-comment">-- intersection can be found at most @k@ back, then this is not a peer</span><span>
</span><span id="line-877"></span><span>    </span><span class="hs-comment">-- that we can sync with (since we will never roll back more than @k).</span><span>
</span><span id="line-878"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-879"></span><span>    </span><span class="hs-comment">-- For @k = 2160@, this evaluates to</span><span>
</span><span id="line-880"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-881"></span><span>    </span><span class="hs-comment">-- &gt; [0,1,2,3,5,8,13,21,34,55,89,144,233,377,610,987,1597,2160]</span><span>
</span><span id="line-882"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-883"></span><span>    </span><span class="hs-comment">-- For @k = 5@ (during testing), this evaluates to</span><span>
</span><span id="line-884"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-885"></span><span>    </span><span class="hs-comment">-- &gt; [0,1,2,3,5]</span><span>
</span><span id="line-886"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-887"></span><span>    </span><span class="hs-comment">-- In case the fragment contains less than @k@ blocks, we use the length</span><span>
</span><span id="line-888"></span><span>    </span><span class="hs-comment">-- of the fragment as @k@. This ensures that the oldest rollback point is</span><span>
</span><span id="line-889"></span><span>    </span><span class="hs-comment">-- selected.</span><span>
</span><span id="line-890"></span><span>    </span><span class="annot"><a href="#local-6989586621680037018"><span class="hs-identifier hs-type">offsets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span class="hs-special">]</span><span>
</span><span id="line-891"></span><span>    </span><span id="local-6989586621680037018"><span class="annot"><span class="annottext">offsets :: Word64 -&gt; [Word64]
</span><a href="#local-6989586621680037018"><span class="hs-identifier hs-var hs-var">offsets</span></a></span></span><span> </span><span id="local-6989586621680036849"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036849"><span class="hs-identifier hs-var">maxOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Word64] -&gt; [Word64] -&gt; [Word64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Bool) -&gt; [Word64] -&gt; [Word64]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">takeWhile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036847"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64 -&gt; Word64
</span><a href="Ouroboros.Consensus.Util.html#fib"><span class="hs-identifier hs-var">fib</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036845"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621680036845"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036845"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">2</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Word64] -&gt; [Word64] -&gt; [Word64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036847"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-892"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-893"></span><span>        </span><span id="local-6989586621680036847"><span class="annot"><span class="annottext">l :: Word64
</span><a href="#local-6989586621680036847"><span class="hs-identifier hs-var hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036844"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`min`</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036849"><span class="hs-identifier hs-var">maxOffset</span></a></span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span>    </span><span class="annot"><a href="#local-6989586621680036844"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-896"></span><span>    </span><span id="local-6989586621680036844"><span class="annot"><span class="annottext">k :: Word64
</span><a href="#local-6989586621680036844"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Word64
</span><a href="Ouroboros.Consensus.Config.SecurityParam.html#maxRollbacks"><span class="hs-identifier hs-var hs-var">maxRollbacks</span></a></span><span> </span><span class="annot"><span class="annottext">(SecurityParam -&gt; Word64) -&gt; SecurityParam -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; SecurityParam
forall blk.
ConsensusProtocol (BlockProtocol blk) =&gt;
TopLevelConfig blk -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Config.html#configSecurityParam"><span class="hs-identifier hs-var">configSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680037038"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Reacting to changes in the local node's current chain
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span class="hs-keyword">data</span><span> </span><span id="IntersectsRecheck"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#IntersectsRecheck"><span class="hs-identifier hs-var">IntersectsRecheck</span></a></span></span><span> </span><span id="local-6989586621680037315"><span class="annot"><a href="#local-6989586621680037315"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-903"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="LostIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LostIntersection"><span class="hs-identifier hs-var">LostIntersection</span></a></span></span><span>
</span><span id="line-904"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="NewIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NewIntersection"><span class="hs-identifier hs-var">NewIntersection</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037315"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-905"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SameIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#SameIntersection"><span class="hs-identifier hs-var">SameIntersection</span></a></span></span><span>
</span><span id="line-906"></span><span>
</span><span id="line-907"></span><span id="local-6989586621680037416"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#recheckToMaybe"><span class="hs-identifier hs-type">recheckToMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-908"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037416"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-909"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#IntersectsRecheck"><span class="hs-identifier hs-type">IntersectsRecheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037416"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-910"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037416"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-911"></span><span id="recheckToMaybe"><span class="annot"><span class="annottext">recheckToMaybe :: KnownIntersectionState blk
-&gt; IntersectsRecheck blk -&gt; Maybe (KnownIntersectionState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#recheckToMaybe"><span class="hs-identifier hs-var hs-var">recheckToMaybe</span></a></span></span><span> </span><span id="local-6989586621680036837"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036837"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-912"></span><span>    </span><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LostIntersection"><span class="hs-identifier hs-var">LostIntersection</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (KnownIntersectionState blk)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-913"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NewIntersection"><span class="hs-identifier hs-type">NewIntersection</span></a></span><span> </span><span id="local-6989586621680036836"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036836"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; Maybe (KnownIntersectionState blk)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036836"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-914"></span><span>    </span><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#SameIntersection"><span class="hs-identifier hs-var">SameIntersection</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; Maybe (KnownIntersectionState blk)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036837"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-915"></span><span>
</span><span id="line-916"></span><span class="hs-comment">-- | Look at the current chain fragment that may have been updated in the</span><span>
</span><span id="line-917"></span><span class="hs-comment">-- background. Check whether the candidate fragment still intersects with</span><span>
</span><span id="line-918"></span><span class="hs-comment">-- it. If so, update the 'KnownIntersectionState' and trim the candidate</span><span>
</span><span id="line-919"></span><span class="hs-comment">-- fragment to the new current chain fragment's anchor point. If not,</span><span>
</span><span id="line-920"></span><span class="hs-comment">-- return 'Nothing'.</span><span>
</span><span id="line-921"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#stillIntersectsWithCurrentChain"><span class="hs-identifier hs-type">stillIntersectsWithCurrentChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037417"><span class="annot"><a href="#local-6989586621680037417"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680037418"><span class="annot"><a href="#local-6989586621680037418"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-922"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037418"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037417"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-924"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037418"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-925"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-926"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037418"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#IntersectsRecheck"><span class="hs-identifier hs-type">IntersectsRecheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037417"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span id="stillIntersectsWithCurrentChain"><span class="annot"><span class="annottext">stillIntersectsWithCurrentChain :: TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#stillIntersectsWithCurrentChain"><span class="hs-identifier hs-var hs-var">stillIntersectsWithCurrentChain</span></a></span></span><span> </span><span id="local-6989586621680036835"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036835"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621680036834"><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036834"><span class="hs-identifier hs-var">cdbView</span></a></span></span><span> </span><span id="local-6989586621680036833"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036833"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-928"></span><span>    </span><span id="local-6989586621680036832"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036832"><span class="hs-identifier hs-var">ourFrag'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680036831"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>
</span><span id="line-929"></span><span>    </span><span class="hs-keyword">if</span><span>
</span><span id="line-930"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036829"><span class="hs-identifier hs-var">ourFrag</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036832"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-comment">-- Our current chain didn't change, and changes to their chain that</span><span>
</span><span id="line-932"></span><span>        </span><span class="hs-comment">-- might affect the intersection point are handled elsewhere</span><span>
</span><span id="line-933"></span><span>        </span><span class="hs-comment">-- ('rollBackward'), so we have nothing to do.</span><span>
</span><span id="line-934"></span><span>        </span><span class="annot"><span class="annottext">IntersectsRecheck blk -&gt; STM m (IntersectsRecheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IntersectsRecheck blk
forall blk. IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#SameIntersection"><span class="hs-identifier hs-var">SameIntersection</span></a></span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036828"><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680036828"><span class="hs-identifier hs-var">intersection</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Maybe (Point (Header blk))
forall block1 block2.
(HasHeader block1, HasHeader block2,
 HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; AnchoredFragment block2 -&gt; Maybe (Point block1)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.intersectionPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036832"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036827"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-937"></span><span>        </span><span class="hs-comment">-- Our current chain changed, but it still intersects with candidate</span><span>
</span><span id="line-938"></span><span>        </span><span class="hs-comment">-- fragment, so update the 'ourFrag' field and trim to the candidate</span><span>
</span><span id="line-939"></span><span>        </span><span class="hs-comment">-- fragment to the same anchor point.</span><span>
</span><span id="line-940"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-941"></span><span>        </span><span class="hs-comment">-- Note that this is the only place we need to trim. Headers on their</span><span>
</span><span id="line-942"></span><span>        </span><span class="hs-comment">-- chain can only become unnecessary (eligible for trimming) in two</span><span>
</span><span id="line-943"></span><span>        </span><span class="hs-comment">-- ways: 1. we adopted them, i.e., our chain changed (handled in this</span><span>
</span><span id="line-944"></span><span>        </span><span class="hs-comment">-- function); 2. we will /never/ adopt them, which is handled in the</span><span>
</span><span id="line-945"></span><span>        </span><span class="hs-comment">-- &quot;no more intersection case&quot;.</span><span>
</span><span id="line-946"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Point (Header blk)
-&gt; Maybe
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
forall block1 block2.
(HasHeader block1, HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; Point block2
-&gt; Maybe (AnchoredFragment block1, AnchoredFragment block1)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.splitAfterPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036827"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.anchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036832"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-947"></span><span>         </span><span class="hs-comment">-- + Before the update to our fragment, both fragments were</span><span>
</span><span id="line-948"></span><span>         </span><span class="hs-comment">--   anchored at the same anchor.</span><span>
</span><span id="line-949"></span><span>         </span><span class="hs-comment">-- + We still have an intersection.</span><span>
</span><span id="line-950"></span><span>         </span><span class="hs-comment">-- + The number of blocks after the intersection cannot have</span><span>
</span><span id="line-951"></span><span>         </span><span class="hs-comment">--   shrunk, but could have increased.</span><span>
</span><span id="line-952"></span><span>         </span><span class="hs-comment">-- + If it did increase, the anchor point will have shifted up.</span><span>
</span><span id="line-953"></span><span>         </span><span class="hs-comment">-- + It can't have moved up past the intersection point (because</span><span>
</span><span id="line-954"></span><span>         </span><span class="hs-comment">--   then there would be no intersection anymore).</span><span>
</span><span id="line-955"></span><span>         </span><span class="hs-comment">-- + This means the new anchor point must be between the old anchor</span><span>
</span><span id="line-956"></span><span>         </span><span class="hs-comment">--   point and the new intersection point.</span><span>
</span><span id="line-957"></span><span>         </span><span class="hs-comment">-- + Since we know both the old anchor point and the new</span><span>
</span><span id="line-958"></span><span>         </span><span class="hs-comment">--   intersection point exist on their fragment, the new anchor</span><span>
</span><span id="line-959"></span><span>         </span><span class="hs-comment">--   point must also.</span><span>
</span><span id="line-960"></span><span>         </span><span class="annot"><span class="annottext">Maybe
  (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; STM m (IntersectsRecheck blk)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span>
</span><span id="line-961"></span><span>             </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;anchor point must be on candidate fragment if they intersect&quot;</span></span><span>
</span><span id="line-962"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036824"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036824"><span class="hs-identifier hs-var">trimmedCandidateFrag</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntersectsRecheck blk -&gt; STM m (IntersectsRecheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IntersectsRecheck blk -&gt; STM m (IntersectsRecheck blk))
-&gt; IntersectsRecheck blk -&gt; STM m (IntersectsRecheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; IntersectsRecheck blk
forall blk. KnownIntersectionState blk -&gt; IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NewIntersection"><span class="hs-identifier hs-var">NewIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; IntersectsRecheck blk)
-&gt; KnownIntersectionState blk -&gt; IntersectsRecheck blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-963"></span><span>             </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036835"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-964"></span><span>               </span><span class="annot"><span class="annottext">KnownIntersectionState :: forall blk.
AnchoredFragment (Header blk)
-&gt; HeaderStateHistory blk
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-965"></span><span>                   </span><span class="annot"><span class="annottext">$sel:ourFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036832"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span>
</span><span id="line-966"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirFrag:KnownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirFrag%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036824"><span class="hs-identifier hs-var">trimmedCandidateFrag</span></a></span><span>
</span><span id="line-967"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036823"><span class="hs-identifier hs-var">trimmedHeaderStateHistory'</span></a></span><span>
</span><span id="line-968"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621680036828"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-969"></span><span>                 </span><span class="hs-special">}</span><span>
</span><span id="line-970"></span><span>           </span><span class="hs-keyword">where</span><span>
</span><span id="line-971"></span><span>             </span><span class="hs-comment">-- We trim the 'HeaderStateHistory' to the same size as our</span><span>
</span><span id="line-972"></span><span>             </span><span class="hs-comment">-- fragment so they keep in sync.</span><span>
</span><span id="line-973"></span><span>             </span><span id="local-6989586621680036823"><span class="annot"><span class="annottext">trimmedHeaderStateHistory' :: HeaderStateHistory blk
</span><a href="#local-6989586621680036823"><span class="hs-identifier hs-var hs-var">trimmedHeaderStateHistory'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-974"></span><span>               </span><span class="annot"><span class="annottext">Int -&gt; HeaderStateHistory blk -&gt; HeaderStateHistory blk
forall blk. Int -&gt; HeaderStateHistory blk -&gt; HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.HeaderStateHistory.html#trim"><span class="hs-identifier hs-var">HeaderStateHistory.trim</span></a></span><span>
</span><span id="line-975"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036824"><span class="hs-identifier hs-var">trimmedCandidateFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-976"></span><span>                 </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036821"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-979"></span><span>        </span><span class="hs-comment">-- No more intersection with the current chain</span><span>
</span><span id="line-980"></span><span>        </span><span class="annot"><span class="annottext">IntersectsRecheck blk -&gt; STM m (IntersectsRecheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">IntersectsRecheck blk
forall blk. IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LostIntersection"><span class="hs-identifier hs-var">LostIntersection</span></a></span><span>
</span><span id="line-981"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-982"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-983"></span><span>        </span><span id="local-6989586621680036831"><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
getCurrentChain :: STM m (AnchoredFragment (Header blk))
$sel:getCurrentChain:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680036831"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span>
</span><span id="line-984"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036834"><span class="hs-identifier hs-var">cdbView</span></a></span><span>
</span><span id="line-985"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-986"></span><span>        </span><span id="local-6989586621680036827"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036827"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-987"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036821"><span class="annot"><span class="annottext">HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="#local-6989586621680036821"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-988"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036829"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
$sel:ourFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036829"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-989"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036833"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Acquiring a ledger view for RollForward validation
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-994"></span><span>
</span><span id="line-995"></span><span class="hs-keyword">data</span><span> </span><span id="LedgerViewCheck"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-var">LedgerViewCheck</span></a></span></span><span> </span><span id="local-6989586621680037370"><span class="annot"><a href="#local-6989586621680037370"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-996"></span><span>    </span><span class="hs-comment">-- | The upstream chain no longer intersects with our current chain because</span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-comment">-- our current chain changed in the background.</span><span>
</span><span id="line-998"></span><span>    </span><span id="NoLongerIntersects"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span></span><span>
</span><span id="line-999"></span><span>    </span><span class="hs-comment">-- | The upstream chain still intersects with our chain, return the latest</span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-comment">-- 'KnownIntersectionState' and the 'LedgerView' necessary to validate the</span><span>
</span><span id="line-1001"></span><span>    </span><span class="hs-comment">-- RollForward header.</span><span>
</span><span id="line-1002"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LedgerViewAcquired"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewAcquired"><span class="hs-identifier hs-var">LedgerViewAcquired</span></a></span></span><span>
</span><span id="line-1003"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037370"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1004"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier hs-type">Ticked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037370"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span>
</span><span id="line-1006"></span><span class="hs-comment">-- | The peer has sent a RollForward header but their chain is not dense enough</span><span>
</span><span id="line-1007"></span><span class="hs-comment">-- for us to validate the header in the usual way (via forecasting). We'll have</span><span>
</span><span id="line-1008"></span><span class="hs-comment">-- to pre-emptively fetch some of their blocks in order to do so.</span><span>
</span><span id="line-1009"></span><span class="hs-comment">--</span><span>
</span><span id="line-1010"></span><span class="hs-comment">-- This is the state type for the logic requests fetchs and processes the</span><span>
</span><span id="line-1011"></span><span class="hs-comment">-- fetched blocks.</span><span>
</span><span id="line-1012"></span><span id="local-6989586621680036819"><span id="local-6989586621680036820"></span></span><span class="hs-keyword">data</span><span> </span><span id="LowDensity"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-var">LowDensity</span></a></span></span><span> </span><span id="local-6989586621680037291"><span class="annot"><a href="#local-6989586621680037291"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-1013"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="LowDensity"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-var">LowDensity</span></a></span></span><span>
</span><span id="line-1014"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037291"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1015"></span><span>      </span><span class="hs-comment">-- ^ The 'mostRecentIntersection' via which we obtain the</span><span>
</span><span id="line-1016"></span><span>      </span><span class="hs-comment">-- initially-unadvanced 'LedgerState' (whose 'LedgerView' forecast did</span><span>
</span><span id="line-1017"></span><span>      </span><span class="hs-comment">-- not reach the slot of the RollForward header).</span><span>
</span><span id="line-1018"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037291"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1019"></span><span>      </span><span class="hs-comment">-- ^ The advanced ledger state so far.</span><span>
</span><span id="line-1020"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037291"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1021"></span><span>      </span><span class="hs-comment">-- ^ The remaining blocks on the peer's chain to fetch and then apply in</span><span>
</span><span id="line-1022"></span><span>      </span><span class="hs-comment">-- order to further advance this ledger state.</span><span>
</span><span id="line-1023"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span>
</span><span id="line-1024"></span><span>      </span><span class="hs-comment">-- ^ Whether the candidate fragment is certainly set to the next point.</span><span>
</span><span id="line-1025"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. LowDensity blk -&gt; Rep (LowDensity blk) x)
-&gt; (forall x. Rep (LowDensity blk) x -&gt; LowDensity blk)
-&gt; Generic (LowDensity blk)
forall x. Rep (LowDensity blk) x -&gt; LowDensity blk
forall x. LowDensity blk -&gt; Rep (LowDensity blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x. Rep (LowDensity blk) x -&gt; LowDensity blk
forall blk x. LowDensity blk -&gt; Rep (LowDensity blk) x
$cto :: forall blk x. Rep (LowDensity blk) x -&gt; LowDensity blk
$cfrom :: forall blk x. LowDensity blk -&gt; Rep (LowDensity blk) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-1026"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036810"><span id="local-6989586621680036812"><span id="local-6989586621680036814"><span class="annot"><span class="annottext">Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo)
Proxy (LowDensity blk) -&gt; String
(Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (LowDensity blk) -&gt; String)
-&gt; NoThunks (LowDensity blk)
forall blk.
LedgerSupportsProtocol blk =&gt;
Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo)
forall blk.
LedgerSupportsProtocol blk =&gt;
Proxy (LowDensity blk) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy (LowDensity blk) -&gt; String
$cshowTypeOf :: forall blk.
LedgerSupportsProtocol blk =&gt;
Proxy (LowDensity blk) -&gt; String
wNoThunks :: Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall blk.
LedgerSupportsProtocol blk =&gt;
Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall blk.
LedgerSupportsProtocol blk =&gt;
Context -&gt; LowDensity blk -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680036810"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span id="local-6989586621680036808"><span id="local-6989586621680036809"></span></span><span class="hs-keyword">data</span><span> </span><span id="RequestStatus"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestStatus"><span class="hs-identifier hs-var">RequestStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RequestReady"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestReady"><span class="hs-identifier hs-var">RequestReady</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="RequestStale"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestStale"><span class="hs-identifier hs-var">RequestStale</span></a></span></span><span>
</span><span id="line-1029"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. RequestStatus -&gt; Rep RequestStatus x)
-&gt; (forall x. Rep RequestStatus x -&gt; RequestStatus)
-&gt; Generic RequestStatus
forall x. Rep RequestStatus x -&gt; RequestStatus
forall x. RequestStatus -&gt; Rep RequestStatus x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep RequestStatus x -&gt; RequestStatus
$cfrom :: forall x. RequestStatus -&gt; Rep RequestStatus x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036800"><span id="local-6989586621680036802"><span class="annot"><span class="annottext">RequestStatus -&gt; RequestStatus -&gt; Bool
(RequestStatus -&gt; RequestStatus -&gt; Bool)
-&gt; (RequestStatus -&gt; RequestStatus -&gt; Bool) -&gt; Eq RequestStatus
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RequestStatus -&gt; RequestStatus -&gt; Bool
$c/= :: RequestStatus -&gt; RequestStatus -&gt; Bool
== :: RequestStatus -&gt; RequestStatus -&gt; Bool
$c== :: RequestStatus -&gt; RequestStatus -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1030"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036794"><span id="local-6989586621680036796"><span id="local-6989586621680036798"><span class="annot"><span class="annottext">Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo)
Proxy RequestStatus -&gt; String
(Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy RequestStatus -&gt; String)
-&gt; NoThunks RequestStatus
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy RequestStatus -&gt; String
$cshowTypeOf :: Proxy RequestStatus -&gt; String
wNoThunks :: Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: Context -&gt; RequestStatus -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680036794"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1031"></span><span>
</span><span id="line-1032"></span><span class="hs-comment">-- | Attempt to forecast the necessary ledger view from the</span><span>
</span><span id="line-1033"></span><span class="hs-comment">-- 'mostRecentIntersection'. If that doesn't work, enter the supplied</span><span>
</span><span id="line-1034"></span><span class="hs-comment">-- 'LowDensity' handler.</span><span>
</span><span id="line-1035"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkDensityOrContinue"><span class="hs-identifier hs-type">checkDensityOrContinue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037367"><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680037368"><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1036"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1038"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1039"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-1040"></span><span>     </span><span class="hs-comment">-- ^ forecast to this slot</span><span>
</span><span id="line-1041"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-type">LowDensity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-type">LedgerViewCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>     </span><span class="hs-comment">-- ^ how to handle a low density chain</span><span>
</span><span id="line-1043"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680037368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-type">LedgerViewCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span id="checkDensityOrContinue"><span class="annot"><span class="annottext">checkDensityOrContinue :: TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkDensityOrContinue"><span class="hs-identifier hs-var hs-var">checkDensityOrContinue</span></a></span></span><span> </span><span id="local-6989586621680036793"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036793"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621680036792"><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036792"><span class="hs-identifier hs-var">cdbView</span></a></span></span><span> </span><span id="local-6989586621680036791"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036791"><span class="hs-identifier hs-var">hdrSlot</span></a></span></span><span> </span><span id="local-6989586621680036790"><span class="annot"><span class="annottext">Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036790"><span class="hs-identifier hs-var">kont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk -&gt; STM m (m (LedgerViewCheck blk)))
 -&gt; Stateful
      (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk)))
-&gt; (KnownIntersectionState blk -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036789"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036789"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1045"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1046"></span><span>            </span><span id="local-6989586621680036788"><span class="annot"><span class="annottext">Point blk
mostRecentIntersection :: Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
</span><a href="#local-6989586621680036788"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-1047"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036787"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036787"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-1048"></span><span>          </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036789"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1049"></span><span>
</span><span id="line-1050"></span><span>        </span><span class="annot"><a href="#local-6989586621680036786"><span class="hs-identifier hs-type">theirSuffix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1051"></span><span>        </span><span id="local-6989586621680036786"><span class="annot"><span class="annottext">theirSuffix :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036786"><span class="hs-identifier hs-var hs-var">theirSuffix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1052"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; Maybe
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
forall block1 block2.
(HasHeader block1, HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; Point block2
-&gt; Maybe (AnchoredFragment block1, AnchoredFragment block1)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.splitAfterPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036787"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036788"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1053"></span><span>              </span><span class="annot"><span class="annottext">Maybe
  (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
</span><span class="hs-identifier hs-var">Nothing</span></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; AnchoredFragment (Header blk)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible!&quot;</span></span><span>
</span><span id="line-1054"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036785"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036785"><span class="hs-identifier hs-var">_upto</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036784"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036784"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036784"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-1055"></span><span>
</span><span id="line-1056"></span><span>    </span><span id="local-6989586621680036783"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036783"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
-&gt; KnownIntersectionState blk -&gt; STM m (LedgerState blk)
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
ChainDbView m blk
-&gt; KnownIntersectionState blk -&gt; STM m (LedgerState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#getIntersectionLedgerState"><span class="hs-identifier hs-var">getIntersectionLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036792"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036789"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1057"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; LedgerConfig blk
-&gt; LedgerState blk
-&gt; SlotNo
-&gt; Maybe (Ticked (LedgerView (BlockProtocol blk)))
forall (proxy :: * -&gt; *) blk.
LedgerSupportsProtocol blk =&gt;
proxy blk
-&gt; LedgerConfig blk
-&gt; LedgerState blk
-&gt; SlotNo
-&gt; Maybe (Ticked (LedgerView (BlockProtocol blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#tryForecastLedgerView"><span class="hs-identifier hs-var">tryForecastLedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680037367"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036780"><span class="hs-identifier hs-var">lCfg</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036783"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036791"><span class="hs-identifier hs-var">hdrSlot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1058"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036779"><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036779"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LedgerViewCheck blk -&gt; m (LedgerViewCheck blk))
-&gt; LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
forall blk.
KnownIntersectionState blk
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewAcquired"><span class="hs-identifier hs-var">LedgerViewAcquired</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036789"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036779"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1059"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Ticked (LedgerView (BlockProtocol blk)))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1060"></span><span>          </span><span class="hs-comment">-- If their suffix is so long that the normal ChainSync/BlockFetch</span><span>
</span><span id="line-1061"></span><span>          </span><span class="hs-comment">-- logic should already be requesting it, then just wait for our</span><span>
</span><span id="line-1062"></span><span>          </span><span class="hs-comment">-- chain to catch up, which will change our intersection point, which</span><span>
</span><span id="line-1063"></span><span>          </span><span class="hs-comment">-- will abort this STM transaction.</span><span>
</span><span id="line-1064"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (stm :: * -&gt; *). MonadSTMTx stm =&gt; Bool -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m ()) -&gt; Bool -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036786"><span class="hs-identifier hs-var">theirSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036776"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-1065"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036775"><span class="annot"><span class="annottext">toApply :: [RealPoint blk]
</span><a href="#local-6989586621680036775"><span class="hs-identifier hs-var hs-var">toApply</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1066"></span><span>                </span><span class="annot"><span class="annottext">(Header blk -&gt; RealPoint blk) -&gt; [Header blk] -&gt; [RealPoint blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">([Header blk] -&gt; [RealPoint blk])
-&gt; [Header blk] -&gt; [RealPoint blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1067"></span><span>                </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.toOldestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; [Header blk])
-&gt; AnchoredFragment (Header blk) -&gt; [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1068"></span><span>                </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036786"><span class="hs-identifier hs-var">theirSuffix</span></a></span><span>
</span><span id="line-1069"></span><span>              </span><span id="local-6989586621680036773"><span class="annot"><span class="annottext">ld :: LowDensity blk
</span><a href="#local-6989586621680036773"><span class="hs-identifier hs-var hs-var">ld</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; LedgerState blk
-&gt; [RealPoint blk]
-&gt; RequestStatus
-&gt; LowDensity blk
forall blk.
KnownIntersectionState blk
-&gt; LedgerState blk
-&gt; [RealPoint blk]
-&gt; RequestStatus
-&gt; LowDensity blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-var">LowDensity</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036789"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036783"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036775"><span class="hs-identifier hs-var">toApply</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestStale"><span class="hs-identifier hs-var">RequestStale</span></a></span><span>
</span><span id="line-1070"></span><span>          </span><span class="annot"><span class="annottext">LowDensity blk
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036773"><span class="hs-identifier hs-var">ld</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036790"><span class="hs-identifier hs-var">kont</span></a></span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1072"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621680036776"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680036776"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk) -&gt; SecurityParam
forall p. ConsensusProtocol p =&gt; ConsensusConfig p -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#protocolSecurityParam"><span class="hs-identifier hs-var">protocolSecurityParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036793"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1073"></span><span>    </span><span id="local-6989586621680036780"><span class="annot"><span class="annottext">lCfg :: LedgerConfig blk
</span><a href="#local-6989586621680036780"><span class="hs-identifier hs-var hs-var">lCfg</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036793"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1074"></span><span>
</span><span id="line-1075"></span><span class="hs-comment">-- | Acquire the requisite 'LedgerView' despite the peer having a low density</span><span>
</span><span id="line-1076"></span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-1077"></span><span class="hs-comment">--</span><span>
</span><span id="line-1078"></span><span class="hs-comment">-- TODO If we receive a RollForward that involves low density, and then the</span><span>
</span><span id="line-1079"></span><span class="hs-comment">-- next reply from the server (NB the RequestNext was already sent due to</span><span>
</span><span id="line-1080"></span><span class="hs-comment">-- pipelining) is a RollBackward, will we be able to process that, aborting our</span><span>
</span><span id="line-1081"></span><span class="hs-comment">-- now-expensive low density RollForward handler? We don't think so. Is that</span><span>
</span><span id="line-1082"></span><span class="hs-comment">-- OK? Seems suboptimal, but fine considering the narrow (disastrous)</span><span>
</span><span id="line-1083"></span><span class="hs-comment">-- circumstances of a low density chain.</span><span>
</span><span id="line-1084"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#lowDensityHandler"><span class="hs-identifier hs-type">lowDensityHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037365"><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680037366"><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1085"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-1090"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-type">LowDensity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-type">LedgerViewCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span id="lowDensityHandler"><span class="annot"><span class="annottext">lowDensityHandler :: TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; (CandidateFragment (Header blk) -&gt; m ())
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#lowDensityHandler"><span class="hs-identifier hs-var hs-var">lowDensityHandler</span></a></span></span><span> </span><span id="local-6989586621680036771"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036771"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621680036770"><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036770"><span class="hs-identifier hs-var">cdbView</span></a></span></span><span> </span><span id="local-6989586621680036769"><span class="annot"><span class="annottext">CandidateFragment (Header blk) -&gt; m ()
</span><a href="#local-6989586621680036769"><span class="hs-identifier hs-var">setCandidate</span></a></span></span><span> </span><span id="local-6989586621680036768"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036768"><span class="hs-identifier hs-var">hdrSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1092"></span><span>    </span><span class="annot"><span class="annottext">Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036767"><span class="hs-identifier hs-var">go1</span></a></span><span>
</span><span id="line-1093"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1094"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1095"></span><span>        </span><span id="local-6989586621680036766"><span class="annot"><span class="annottext">RealPoint blk -&gt; m (Maybe blk)
getBlock :: RealPoint blk -&gt; m (Maybe blk)
$sel:getBlock:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; RealPoint blk -&gt; m (Maybe blk)
</span><a href="#local-6989586621680036766"><span class="hs-identifier hs-var hs-var">getBlock</span></a></span></span><span>
</span><span id="line-1096"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036765"><span class="annot"><span class="annottext">STM m (Point blk -&gt; Bool)
getIsFetched :: STM m (Point blk -&gt; Bool)
$sel:getIsFetched:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="#local-6989586621680036765"><span class="hs-identifier hs-var hs-var">getIsFetched</span></a></span></span><span>
</span><span id="line-1097"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036770"><span class="hs-identifier hs-var">cdbView</span></a></span><span>
</span><span id="line-1098"></span><span>
</span><span id="line-1099"></span><span>    </span><span id="local-6989586621680036764"><span class="annot"><span class="annottext">lCfg :: LedgerConfig blk
</span><a href="#local-6989586621680036764"><span class="hs-identifier hs-var hs-var">lCfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036771"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span>    </span><span class="annot"><a href="#local-6989586621680036767"><span class="hs-identifier hs-type">go1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-type">LowDensity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-type">LedgerViewCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1102"></span><span>    </span><span id="local-6989586621680036767"><span class="annot"><span class="annottext">go1 :: Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036767"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LowDensity blk -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">LowDensity blk -&gt; STM m (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036763"><span class="hs-identifier hs-var">worker</span></a></span><span>
</span><span id="line-1103"></span><span>
</span><span id="line-1104"></span><span>    </span><span class="hs-comment">-- NOTE This binding has its own where clause.</span><span>
</span><span id="line-1105"></span><span>    </span><span id="local-6989586621680036763"><span class="annot"><span class="annottext">worker :: LowDensity blk -&gt; STM m (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036763"><span class="hs-identifier hs-var hs-var">worker</span></a></span></span><span> </span><span id="local-6989586621680036762"><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036762"><span class="hs-identifier hs-var">ld</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036761"><span class="hs-identifier hs-var">toApply</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span>        </span><span class="hs-comment">-- We have fetched and applied all blocks between the intersection</span><span>
</span><span id="line-1108"></span><span>        </span><span class="hs-comment">-- and the RollForward header.</span><span>
</span><span id="line-1109"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1110"></span><span>            </span><span class="hs-comment">-- We can simply tick up to it, since there are no remaining</span><span>
</span><span id="line-1111"></span><span>            </span><span class="hs-comment">-- blocks in between.</span><span>
</span><span id="line-1112"></span><span>            </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1113"></span><span>              </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1114"></span><span>              </span><span class="annot"><span class="annottext">(LedgerViewCheck blk -&gt; m (LedgerViewCheck blk))
-&gt; LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
forall blk.
KnownIntersectionState blk
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewAcquired"><span class="hs-identifier hs-var">LedgerViewAcquired</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036760"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1115"></span><span>              </span><span class="annot"><span class="annottext">(Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk)
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; Ticked (LedgerState blk)
-&gt; Ticked (LedgerView (BlockProtocol blk))
forall blk.
LedgerSupportsProtocol blk =&gt;
LedgerConfig blk
-&gt; Ticked (LedgerState blk)
-&gt; Ticked (LedgerView (BlockProtocol blk))
</span><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#protocolLedgerView"><span class="hs-identifier hs-var">protocolLedgerView</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036764"><span class="hs-identifier hs-var">lCfg</span></a></span><span>   </span><span class="hs-comment">-- project without forecasting</span><span>
</span><span id="line-1116"></span><span>              </span><span class="annot"><span class="annottext">(Ticked (LedgerState blk)
 -&gt; Ticked (LedgerView (BlockProtocol blk)))
-&gt; Ticked (LedgerState blk)
-&gt; Ticked (LedgerView (BlockProtocol blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; SlotNo -&gt; LedgerState blk -&gt; Ticked (LedgerState blk)
forall l. IsLedger l =&gt; LedgerCfg l -&gt; SlotNo -&gt; l -&gt; Ticked l
</span><a href="Ouroboros.Consensus.Ledger.Basics.html#applyChainTick"><span class="hs-identifier hs-var">applyChainTick</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036764"><span class="hs-identifier hs-var">lCfg</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036768"><span class="hs-identifier hs-var">hdrSlot</span></a></span><span>
</span><span id="line-1117"></span><span>              </span><span class="annot"><span class="annottext">(LedgerState blk -&gt; Ticked (LedgerState blk))
-&gt; LedgerState blk -&gt; Ticked (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036758"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1118"></span><span>
</span><span id="line-1119"></span><span>        </span><span class="hs-comment">-- Once the next block is fetched, advance the state and check if the</span><span>
</span><span id="line-1120"></span><span>        </span><span class="hs-comment">-- density is still too low.</span><span>
</span><span id="line-1121"></span><span>        </span><span id="local-6989586621680036757"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680036757"><span class="hs-identifier hs-var">rp</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621680036756"><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036756"><span class="hs-identifier hs-var">toApply'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1122"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036755"><span class="annot"><span class="annottext">p :: Point blk
</span><a href="#local-6989586621680036755"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; Point blk
forall blk. RealPoint blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointToPoint"><span class="hs-identifier hs-var">realPointToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680036757"><span class="hs-identifier hs-var">rp</span></a></span><span>
</span><span id="line-1123"></span><span>            </span><span class="hs-comment">-- TODO Will the blocks necessarily be in the restricted domain</span><span>
</span><span id="line-1124"></span><span>            </span><span class="hs-comment">-- of ChainDB.getIsFetched? We may need to widen it, or maybe</span><span>
</span><span id="line-1125"></span><span>            </span><span class="hs-comment">-- merely its current comment is too strong a statement.</span><span>
</span><span id="line-1126"></span><span>            </span><span id="local-6989586621680036753"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680036753"><span class="hs-identifier hs-var">isFetched</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Point blk -&gt; Bool)
</span><a href="#local-6989586621680036765"><span class="hs-identifier hs-var">getIsFetched</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Point blk -&gt; Bool) -&gt; STM m (Point blk) -&gt; STM m Bool
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; STM m (Point blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036755"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span>            </span><span class="hs-keyword">if</span><span>
</span><span id="line-1129"></span><span>
</span><span id="line-1130"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680036753"><span class="hs-identifier hs-var">isFetched</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; [RealPoint blk] -&gt; m (LedgerViewCheck blk)
</span><a href="#local-6989586621680036752"><span class="hs-identifier hs-var">advanceAndRetryForecast</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680036757"><span class="hs-identifier hs-var">rp</span></a></span><span> </span><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036756"><span class="hs-identifier hs-var">toApply'</span></a></span><span>
</span><span id="line-1131"></span><span>
</span><span id="line-1132"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestReady"><span class="hs-identifier hs-var">RequestReady</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus -&gt; RequestStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621680036751"><span class="hs-identifier hs-var">reqStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1133"></span><span>                </span><span class="hs-comment">-- Block this STM transaction until the next block is fetched.</span><span>
</span><span id="line-1134"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1135"></span><span>                </span><span class="hs-comment">-- TODO what if the upstream peer is unable to serve the</span><span>
</span><span id="line-1136"></span><span>                </span><span class="hs-comment">-- block? Does BlockFetch silently ignore that? How could we</span><span>
</span><span id="line-1137"></span><span>                </span><span class="hs-comment">-- notice here?</span><span>
</span><span id="line-1138"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1139"></span><span>                </span><span class="hs-comment">-- TODO separate but related, we need a timeout here. Maybe</span><span>
</span><span id="line-1140"></span><span>                </span><span class="hs-comment">-- this will also handle the case where the peer actually can't</span><span>
</span><span id="line-1141"></span><span>                </span><span class="hs-comment">-- provide the block after all.</span><span>
</span><span id="line-1142"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (stm :: * -&gt; *). MonadSTMTx stm =&gt; Bool -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680036753"><span class="hs-identifier hs-var">isFetched</span></a></span><span>
</span><span id="line-1143"></span><span>                </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; [RealPoint blk] -&gt; m (LedgerViewCheck blk)
</span><a href="#local-6989586621680036752"><span class="hs-identifier hs-var">advanceAndRetryForecast</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680036757"><span class="hs-identifier hs-var">rp</span></a></span><span> </span><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036756"><span class="hs-identifier hs-var">toApply'</span></a></span><span>
</span><span id="line-1144"></span><span>
</span><span id="line-1145"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1146"></span><span>                </span><span class="hs-comment">-- Tell BlockFetch to fetch the next block on the peer's chain</span><span>
</span><span id="line-1147"></span><span>                </span><span class="hs-comment">-- regardless of their chain's plausibility.</span><span>
</span><span id="line-1148"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-1149"></span><span>                </span><span class="hs-comment">-- NB All BlockFetch requests should be anchored at</span><span>
</span><span id="line-1150"></span><span>                </span><span class="hs-comment">-- 'mostRecentIntersection'.</span><span>
</span><span id="line-1151"></span><span>                </span><span class="annot"><span class="annottext">CandidateFragment (Header blk) -&gt; m ()
</span><a href="#local-6989586621680036769"><span class="hs-identifier hs-var">setCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">CandidateFragment :: forall header.
Bool -&gt; AnchoredFragment header -&gt; CandidateFragment header
</span><a href="Ouroboros.Consensus.Node.Types.html#CandidateFragment"><span class="hs-identifier hs-type">CandidateFragment</span></a></span><span>
</span><span id="line-1152"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">candidateChain :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateChain"><span class="hs-identifier hs-var">candidateChain</span></a></span><span>        </span><span class="hs-glyph">=</span><span>
</span><span id="line-1153"></span><span>                      </span><span class="hs-comment">-- We only request the next block. We'll only request the</span><span>
</span><span id="line-1154"></span><span>                      </span><span class="hs-comment">-- block after that if this next block is still</span><span>
</span><span id="line-1155"></span><span>                      </span><span class="hs-comment">-- insufficient. And so on. This doesn't allow</span><span>
</span><span id="line-1156"></span><span>                      </span><span class="hs-comment">-- pipelining, but that's OK in disaster mode. This way</span><span>
</span><span id="line-1157"></span><span>                      </span><span class="hs-comment">-- avoids unnecessary work.</span><span>
</span><span id="line-1158"></span><span>                      </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; ((AnchoredFragment (Header blk), AnchoredFragment (Header blk))
    -&gt; AnchoredFragment (Header blk))
-&gt; Maybe
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; AnchoredFragment (Header blk)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible!&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-1159"></span><span>                        </span><span class="annot"><span class="annottext">(Maybe
   (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
 -&gt; AnchoredFragment (Header blk))
-&gt; Maybe
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; Maybe
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk))
forall block1 block2.
(HasHeader block1, HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; Point block2
-&gt; Maybe (AnchoredFragment block1, AnchoredFragment block1)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.splitAfterPoint</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036749"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036755"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1160"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">candidateIsLowDensity :: Bool
</span><a href="Ouroboros.Consensus.Node.Types.html#candidateIsLowDensity"><span class="hs-identifier hs-var">candidateIsLowDensity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1161"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-1162"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036748"><span class="annot"><span class="annottext">ld' :: LowDensity blk
</span><a href="#local-6989586621680036748"><span class="hs-identifier hs-var hs-var">ld'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; LedgerState blk
-&gt; [RealPoint blk]
-&gt; RequestStatus
-&gt; LowDensity blk
forall blk.
KnownIntersectionState blk
-&gt; LedgerState blk
-&gt; [RealPoint blk]
-&gt; RequestStatus
-&gt; LowDensity blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-var">LowDensity</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036760"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036758"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036761"><span class="hs-identifier hs-var">toApply</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestReady"><span class="hs-identifier hs-var">RequestReady</span></a></span><span>
</span><span id="line-1163"></span><span>                </span><span class="annot"><span class="annottext">LowDensity blk
-&gt; Stateful m (LowDensity blk) (LedgerViewCheck blk)
-&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036748"><span class="hs-identifier hs-var">ld'</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful m (LowDensity blk) (LedgerViewCheck blk)
</span><a href="#local-6989586621680036747"><span class="hs-identifier hs-var">go2</span></a></span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1166"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-type">LowDensity</span></a></span><span> </span><span id="local-6989586621680036760"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036760"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621680036758"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036758"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621680036761"><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036761"><span class="hs-identifier hs-var">toApply</span></a></span></span><span> </span><span id="local-6989586621680036751"><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621680036751"><span class="hs-identifier hs-var">reqStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036762"><span class="hs-identifier hs-var">ld</span></a></span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1169"></span><span>            </span><span id="local-6989586621680036749"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
$sel:theirFrag:KnownIntersectionState :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036749"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-1170"></span><span>          </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036760"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1171"></span><span>
</span><span id="line-1172"></span><span>        </span><span class="hs-comment">-- Get the block, advance the state, and try again to forecast.</span><span>
</span><span id="line-1173"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1174"></span><span>        </span><span class="hs-comment">-- PREREQUISITE: The block is fetched.</span><span>
</span><span id="line-1175"></span><span>        </span><span class="annot"><a href="#local-6989586621680036752"><span class="hs-identifier hs-type">advanceAndRetryForecast</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1176"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-type">LedgerViewCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1177"></span><span>        </span><span id="local-6989586621680036752"><span class="annot"><span class="annottext">advanceAndRetryForecast :: RealPoint blk -&gt; [RealPoint blk] -&gt; m (LedgerViewCheck blk)
</span><a href="#local-6989586621680036752"><span class="hs-identifier hs-var hs-var">advanceAndRetryForecast</span></a></span></span><span> </span><span id="local-6989586621680036746"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680036746"><span class="hs-identifier hs-var">rp</span></a></span></span><span> </span><span id="local-6989586621680036745"><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036745"><span class="hs-identifier hs-var">toApply'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1178"></span><span>            </span><span class="hs-comment">-- TODO We don't think ChainDB GC will remove them. Explain why</span><span>
</span><span id="line-1179"></span><span>            </span><span class="hs-comment">-- not.</span><span>
</span><span id="line-1180"></span><span>            </span><span id="local-6989586621680036744"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680036744"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">blk -&gt; Maybe blk -&gt; blk
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; blk
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible!&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe blk -&gt; blk) -&gt; m (Maybe blk) -&gt; m blk
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; m (Maybe blk)
</span><a href="#local-6989586621680036766"><span class="hs-identifier hs-var">getBlock</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621680036746"><span class="hs-identifier hs-var">rp</span></a></span><span>
</span><span id="line-1181"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036743"><span class="annot"><span class="annottext">st' :: LedgerState blk
</span><a href="#local-6989586621680036743"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk -&gt; blk -&gt; LedgerState blk -&gt; LedgerState blk
forall l blk. ApplyBlock l blk =&gt; LedgerCfg l -&gt; blk -&gt; l -&gt; l
</span><a href="Ouroboros.Consensus.Ledger.Abstract.html#tickThenReapply"><span class="hs-identifier hs-var">tickThenReapply</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036764"><span class="hs-identifier hs-var">lCfg</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680036744"><span class="hs-identifier hs-var">blk</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036758"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1182"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; LedgerConfig blk
-&gt; LedgerState blk
-&gt; SlotNo
-&gt; Maybe (Ticked (LedgerView (BlockProtocol blk)))
forall (proxy :: * -&gt; *) blk.
LedgerSupportsProtocol blk =&gt;
proxy blk
-&gt; LedgerConfig blk
-&gt; LedgerState blk
-&gt; SlotNo
-&gt; Maybe (Ticked (LedgerView (BlockProtocol blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#tryForecastLedgerView"><span class="hs-identifier hs-var">tryForecastLedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036764"><span class="hs-identifier hs-var">lCfg</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036743"><span class="hs-identifier hs-var">st'</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036768"><span class="hs-identifier hs-var">hdrSlot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1183"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036742"><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036742"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LedgerViewCheck blk -&gt; m (LedgerViewCheck blk))
-&gt; LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
forall blk.
KnownIntersectionState blk
-&gt; Ticked (LedgerView (BlockProtocol blk)) -&gt; LedgerViewCheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewAcquired"><span class="hs-identifier hs-var">LedgerViewAcquired</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036760"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036742"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1184"></span><span>              </span><span class="annot"><span class="annottext">Maybe (Ticked (LedgerView (BlockProtocol blk)))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1185"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036741"><span class="annot"><span class="annottext">ld' :: LowDensity blk
</span><a href="#local-6989586621680036741"><span class="hs-identifier hs-var hs-var">ld'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; LedgerState blk
-&gt; [RealPoint blk]
-&gt; RequestStatus
-&gt; LowDensity blk
forall blk.
KnownIntersectionState blk
-&gt; LedgerState blk
-&gt; [RealPoint blk]
-&gt; RequestStatus
-&gt; LowDensity blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-var">LowDensity</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036760"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036743"><span class="hs-identifier hs-var">st'</span></a></span><span> </span><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036745"><span class="hs-identifier hs-var">toApply'</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RequestStale"><span class="hs-identifier hs-var">RequestStale</span></a></span><span>
</span><span id="line-1186"></span><span>                  </span><span class="annot"><span class="annottext">LowDensity blk
-&gt; Stateful m (LowDensity blk) (LedgerViewCheck blk)
-&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036741"><span class="hs-identifier hs-var">ld'</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful m (LowDensity blk) (LedgerViewCheck blk)
</span><a href="#local-6989586621680036747"><span class="hs-identifier hs-var">go2</span></a></span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span>    </span><span class="hs-comment">-- Restart the STM transaction.</span><span>
</span><span id="line-1189"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1190"></span><span>    </span><span class="hs-comment">-- Note that this STM transaction is sensitive simultaneously to both the</span><span>
</span><span id="line-1191"></span><span>    </span><span class="hs-comment">-- current chain ('stillIntersectsWithCurrentChain') and also which of the</span><span>
</span><span id="line-1192"></span><span>    </span><span class="hs-comment">-- peer's blocks have been fetched (via 'go1').</span><span>
</span><span id="line-1193"></span><span>    </span><span class="annot"><a href="#local-6989586621680036747"><span class="hs-identifier hs-type">go2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-type">LowDensity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LedgerViewCheck"><span class="hs-identifier hs-type">LedgerViewCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037365"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>    </span><span id="local-6989586621680036747"><span class="annot"><span class="annottext">go2 :: Stateful m (LowDensity blk) (LedgerViewCheck blk)
</span><a href="#local-6989586621680036747"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LowDensity blk -&gt; m (LedgerViewCheck blk))
-&gt; Stateful m (LowDensity blk) (LedgerViewCheck blk)
forall (m :: * -&gt; *) s r. (s -&gt; m r) -&gt; Stateful m s r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((LowDensity blk -&gt; m (LedgerViewCheck blk))
 -&gt; Stateful m (LowDensity blk) (LedgerViewCheck blk))
-&gt; (LowDensity blk -&gt; m (LedgerViewCheck blk))
-&gt; Stateful m (LowDensity blk) (LedgerViewCheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680036740"><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036740"><span class="hs-identifier hs-var">ld</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (m (LedgerViewCheck blk)) -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(m (m (LedgerViewCheck blk)) -&gt; m (LedgerViewCheck blk))
-&gt; m (m (LedgerViewCheck blk)) -&gt; m (LedgerViewCheck blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (m (LedgerViewCheck blk)) -&gt; m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (m (LedgerViewCheck blk)) -&gt; m (m (LedgerViewCheck blk)))
-&gt; STM m (m (LedgerViewCheck blk)) -&gt; m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1195"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LowDensity"><span class="hs-identifier hs-type">LowDensity</span></a></span><span> </span><span id="local-6989586621680036739"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036739"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621680036738"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036738"><span class="hs-identifier hs-var">_st</span></a></span></span><span> </span><span id="local-6989586621680036737"><span class="annot"><span class="annottext">[RealPoint blk]
</span><a href="#local-6989586621680036737"><span class="hs-identifier hs-var">_toApply</span></a></span></span><span> </span><span id="local-6989586621680036736"><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621680036736"><span class="hs-identifier hs-var">_reqStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036740"><span class="hs-identifier hs-var">ld</span></a></span><span>
</span><span id="line-1196"></span><span>        </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; KnownIntersectionState blk
-&gt; STM m (IntersectsRecheck blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#stillIntersectsWithCurrentChain"><span class="hs-identifier hs-var">stillIntersectsWithCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036771"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036770"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036739"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (IntersectsRecheck blk)
-&gt; (IntersectsRecheck blk -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1197"></span><span>          </span><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#LostIntersection"><span class="hs-identifier hs-var">LostIntersection</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; m (LedgerViewCheck blk) -&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk -&gt; m (LedgerViewCheck blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">LedgerViewCheck blk
forall blk. LedgerViewCheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span>
</span><span id="line-1198"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NewIntersection"><span class="hs-identifier hs-type">NewIntersection</span></a></span><span> </span><span id="local-6989586621680036735"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036735"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1199"></span><span>              </span><span class="hs-comment">-- We throw away our advance 'LedgerState' and resume from that</span><span>
</span><span id="line-1200"></span><span>              </span><span class="hs-comment">-- of the new intersection. We could check if we can carry on</span><span>
</span><span id="line-1201"></span><span>              </span><span class="hs-comment">-- from where we are, but it doesn't seem worth the extra</span><span>
</span><span id="line-1202"></span><span>              </span><span class="hs-comment">-- complexity.</span><span>
</span><span id="line-1203"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1204"></span><span>              </span><span class="hs-comment">-- Note that, if we could have kept the old state, the loop will</span><span>
</span><span id="line-1205"></span><span>              </span><span class="hs-comment">-- most likely catch up to where it was without having to refetch</span><span>
</span><span id="line-1206"></span><span>              </span><span class="hs-comment">-- any blocks.</span><span>
</span><span id="line-1207"></span><span>              </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
-&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036735"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
 -&gt; STM m (m (LedgerViewCheck blk)))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
-&gt; STM m (m (LedgerViewCheck blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1208"></span><span>                </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
forall blk (m :: * -&gt; *).
(MonadSTM m, LedgerSupportsProtocol blk) =&gt;
TopLevelConfig blk
-&gt; ChainDbView m blk
-&gt; SlotNo
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; Stateful
     (STM m) (KnownIntersectionState blk) (m (LedgerViewCheck blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkDensityOrContinue"><span class="hs-identifier hs-var">checkDensityOrContinue</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680036771"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036770"><span class="hs-identifier hs-var">cdbView</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036768"><span class="hs-identifier hs-var">hdrSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036767"><span class="hs-identifier hs-var">go1</span></a></span><span>
</span><span id="line-1209"></span><span>          </span><span class="annot"><span class="annottext">IntersectsRecheck blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#SameIntersection"><span class="hs-identifier hs-var">SameIntersection</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LowDensity blk
-&gt; Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
-&gt; STM m (m (LedgerViewCheck blk))
forall (m :: * -&gt; *) s r. NoThunks s =&gt; s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">LowDensity blk
</span><a href="#local-6989586621680036740"><span class="hs-identifier hs-var">ld</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful (STM m) (LowDensity blk) (m (LedgerViewCheck blk))
</span><a href="#local-6989586621680036767"><span class="hs-identifier hs-var">go1</span></a></span><span>
</span><span id="line-1210"></span><span>
</span><span id="line-1211"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Local abbreviations
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1214"></span><span>
</span><span id="line-1215"></span><span id="local-6989586621680037436"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-type">attemptRollback</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1216"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1217"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HasAnnTip"><span class="hs-identifier hs-type">HasAnnTip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1218"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1219"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1220"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1221"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037436"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1222"></span><span id="attemptRollback"><span class="annot"><span class="annottext">attemptRollback :: Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-var hs-var">attemptRollback</span></a></span></span><span> </span><span id="local-6989586621680036734"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036734"><span class="hs-identifier hs-var">rollBackPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036733"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036733"><span class="hs-identifier hs-var">frag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680036732"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036732"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1223"></span><span>    </span><span id="local-6989586621680036731"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036731"><span class="hs-identifier hs-var">frag'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Maybe (AnchoredFragment (Header blk))
forall block.
HasHeader block =&gt;
Point block
-&gt; AnchoredFragment block -&gt; Maybe (AnchoredFragment block)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.rollback</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036734"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036733"><span class="hs-identifier hs-var">frag</span></a></span><span>
</span><span id="line-1224"></span><span>    </span><span id="local-6989586621680036729"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036729"><span class="hs-identifier hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; HeaderStateHistory blk -&gt; Maybe (HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, HasAnnTip blk) =&gt;
Point blk
-&gt; HeaderStateHistory blk -&gt; Maybe (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.HeaderStateHistory.html#rewind"><span class="hs-identifier hs-var">HeaderStateHistory.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036734"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036732"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1225"></span><span>    </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036731"><span class="hs-identifier hs-var">frag'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621680036729"><span class="hs-identifier hs-var">state'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1226"></span><span>
</span><span id="line-1227"></span><span class="hs-comment">-- | Watch the invalid block checker function for changes (using its</span><span>
</span><span id="line-1228"></span><span class="hs-comment">-- fingerprint). Whenever it changes, i.e., a new invalid block is detected,</span><span>
</span><span id="line-1229"></span><span class="hs-comment">-- check whether the current candidate fragment contains any header that is</span><span>
</span><span id="line-1230"></span><span class="hs-comment">-- invalid, if so, disconnect by throwing an 'InvalidBlock' exception.</span><span>
</span><span id="line-1231"></span><span class="hs-comment">--</span><span>
</span><span id="line-1232"></span><span class="hs-comment">-- Note that it is possible, yet unlikely, that the candidate fragment</span><span>
</span><span id="line-1233"></span><span class="hs-comment">-- contains a header that corresponds to an invalid block, but before we have</span><span>
</span><span id="line-1234"></span><span class="hs-comment">-- discovered this (after downloading and validating the block), the upstream</span><span>
</span><span id="line-1235"></span><span class="hs-comment">-- node could have rolled back such that its candidate chain no longer</span><span>
</span><span id="line-1236"></span><span class="hs-comment">-- contains the invalid block, in which case we do not disconnect from it.</span><span>
</span><span id="line-1237"></span><span class="hs-comment">--</span><span>
</span><span id="line-1238"></span><span class="hs-comment">-- The cost of this check is \( O(cand * check) \) where /cand/ is the size of</span><span>
</span><span id="line-1239"></span><span class="hs-comment">-- the candidate fragment and /check/ is the cost of checking whether a block</span><span>
</span><span id="line-1240"></span><span class="hs-comment">-- is invalid (typically \( O(\log(invalid)) \) where /invalid/ is the number</span><span>
</span><span id="line-1241"></span><span class="hs-comment">-- of invalid blocks).</span><span>
</span><span id="line-1242"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#invalidBlockRejector"><span class="hs-identifier hs-type">invalidBlockRejector</span></a></span><span>
</span><span id="line-1243"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037562"><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680037561"><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1244"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1245"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1246"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1247"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-1248"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1249"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1250"></span><span>       </span><span class="hs-comment">-- ^ Get the invalid block checker</span><span>
</span><span id="line-1251"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1252"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Watcher"><span class="hs-identifier hs-type">Watcher</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1253"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1254"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a></span><span>
</span><span id="line-1255"></span><span id="invalidBlockRejector"><span class="annot"><span class="annottext">invalidBlockRejector :: Tracer m (TraceChainSyncClientEvent blk)
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#invalidBlockRejector"><span class="hs-identifier hs-var hs-var">invalidBlockRejector</span></a></span></span><span> </span><span id="local-6989586621680036727"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680036727"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680036726"><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621680036726"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span></span><span> </span><span id="local-6989586621680036725"><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680036725"><span class="hs-identifier hs-var">getCandidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1256"></span><span>    </span><span class="annot"><span class="annottext">Watcher :: forall (m :: * -&gt; *) a fp.
(a -&gt; fp) -&gt; Maybe fp -&gt; (a -&gt; m ()) -&gt; STM m a -&gt; Watcher m a fp
</span><a href="Ouroboros.Consensus.Util.STM.html#Watcher"><span class="hs-identifier hs-type">Watcher</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1257"></span><span>        </span><span class="annot"><span class="annottext">wFingerprint :: WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#wFingerprint"><span class="hs-identifier hs-var">wFingerprint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; Fingerprint
forall a. WithFingerprint a -&gt; Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#getFingerprint"><span class="hs-identifier hs-var hs-var">getFingerprint</span></a></span><span>
</span><span id="line-1258"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wInitial :: Maybe Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#wInitial"><span class="hs-identifier hs-var">wInitial</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Fingerprint
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1259"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wNotify :: WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m ()
</span><a href="Ouroboros.Consensus.Util.STM.html#wNotify"><span class="hs-identifier hs-var">wNotify</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)) -&gt; m ()
</span><a href="#local-6989586621680036719"><span class="hs-identifier hs-var">checkInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)) -&gt; m ())
-&gt; (WithFingerprint
      (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
    -&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var hs-var">forgetFingerprint</span></a></span><span>
</span><span id="line-1260"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wReader :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.Util.STM.html#wReader"><span class="hs-identifier hs-var">wReader</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621680036726"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>
</span><span id="line-1261"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1262"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1263"></span><span>    </span><span class="annot"><a href="#local-6989586621680036719"><span class="hs-identifier hs-type">checkInvalid</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1264"></span><span>    </span><span id="local-6989586621680036719"><span class="annot"><span class="annottext">checkInvalid :: (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)) -&gt; m ()
</span><a href="#local-6989586621680036719"><span class="hs-identifier hs-var hs-var">checkInvalid</span></a></span></span><span> </span><span id="local-6989586621680036717"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621680036717"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1265"></span><span>      </span><span id="local-6989586621680036716"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036716"><span class="hs-identifier hs-var">theirFrag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
-&gt; m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680036725"><span class="hs-identifier hs-var">getCandidate</span></a></span><span>
</span><span id="line-1266"></span><span>      </span><span class="hs-comment">-- The invalid block is likely to be a more recent block, so check from</span><span>
</span><span id="line-1267"></span><span>      </span><span class="hs-comment">-- newest to oldest.</span><span>
</span><span id="line-1268"></span><span>      </span><span class="annot"><span class="annottext">((Header blk, InvalidBlockReason blk) -&gt; m ())
-&gt; Maybe (Header blk, InvalidBlockReason blk) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Header blk -&gt; InvalidBlockReason blk -&gt; m ())
-&gt; (Header blk, InvalidBlockReason blk) -&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; InvalidBlockReason blk -&gt; m ()
</span><a href="#local-6989586621680036713"><span class="hs-identifier hs-var">disconnect</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Header blk, InvalidBlockReason blk) -&gt; m ())
-&gt; Maybe (Header blk, InvalidBlockReason blk) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; Maybe (Header blk, InvalidBlockReason blk))
-&gt; [Header blk] -&gt; Maybe (Header blk, InvalidBlockReason blk)
forall a b (f :: * -&gt; *).
Foldable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; Maybe b
</span><a href="Ouroboros.Consensus.Util.html#firstJust"><span class="hs-identifier hs-var">firstJust</span></a></span><span>
</span><span id="line-1269"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680036711"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036711"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036711"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InvalidBlockReason blk -&gt; (Header blk, InvalidBlockReason blk))
-&gt; Maybe (InvalidBlockReason blk)
-&gt; Maybe (Header blk, InvalidBlockReason blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621680036717"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036711"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1270"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.toNewestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680036716"><span class="hs-identifier hs-var">theirFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1271"></span><span>
</span><span id="line-1272"></span><span>    </span><span class="annot"><a href="#local-6989586621680036713"><span class="hs-identifier hs-type">disconnect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037561"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1273"></span><span>    </span><span id="local-6989586621680036713"><span class="annot"><span class="annottext">disconnect :: Header blk -&gt; InvalidBlockReason blk -&gt; m ()
</span><a href="#local-6989586621680036713"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span> </span><span id="local-6989586621680036709"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036709"><span class="hs-identifier hs-var">invalidHeader</span></a></span></span><span> </span><span id="local-6989586621680036708"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036708"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1274"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680036707"><span class="annot"><span class="annottext">ex :: ChainSyncClientException
</span><a href="#local-6989586621680036707"><span class="hs-identifier hs-var hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; InvalidBlockReason blk -&gt; ChainSyncClientException
forall blk.
LedgerSupportsProtocol blk =&gt;
Point blk -&gt; InvalidBlockReason blk -&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680036709"><span class="hs-identifier hs-var">invalidHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036708"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-1275"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621680036727"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
forall blk.
ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceException"><span class="hs-identifier hs-var">TraceException</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621680036707"><span class="hs-identifier hs-var">ex</span></a></span><span>
</span><span id="line-1276"></span><span>      </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621680036707"><span class="hs-identifier hs-var">ex</span></a></span><span>
</span><span id="line-1277"></span><span>
</span><span id="line-1278"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#tryForecastLedgerView"><span class="hs-identifier hs-type">tryForecastLedgerView</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037295"><span class="annot"><a href="#local-6989586621680037295"><span class="hs-identifier hs-type">proxy</span></a></span></span><span> </span><span id="local-6989586621680037296"><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1279"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1280"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037295"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1281"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerConfig"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1282"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1283"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-1284"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier hs-type">Ticked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span id="tryForecastLedgerView"><span class="annot"><span class="annottext">tryForecastLedgerView :: proxy blk
-&gt; LedgerConfig blk
-&gt; LedgerState blk
-&gt; SlotNo
-&gt; Maybe (Ticked (LedgerView (BlockProtocol blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#tryForecastLedgerView"><span class="hs-identifier hs-var hs-var">tryForecastLedgerView</span></a></span></span><span> </span><span class="annot"><span class="annottext">proxy blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680036706"><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036706"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621680036705"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036705"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621680036704"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036704"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1286"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Except
  OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk)))
-&gt; Either
     OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk)))
forall e a. Except e a -&gt; Either e a
</span><span class="hs-identifier hs-var">runExcept</span></span><span> </span><span class="annot"><span class="annottext">(Except
   OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk)))
 -&gt; Either
      OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk))))
-&gt; Except
     OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk)))
-&gt; Either
     OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Forecast (LedgerView (BlockProtocol blk))
-&gt; SlotNo
-&gt; Except
     OutsideForecastRange (Ticked (LedgerView (BlockProtocol blk)))
forall a.
Forecast a -&gt; SlotNo -&gt; Except OutsideForecastRange (Ticked a)
</span><a href="Ouroboros.Consensus.Forecast.html#forecastFor"><span class="hs-identifier hs-var hs-var">forecastFor</span></a></span><span> </span><span class="annot"><span class="annottext">Forecast (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036702"><span class="hs-identifier hs-var">forecast</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680036704"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1287"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Forecast.html#OutsideForecastRange"><span class="hs-identifier hs-type">OutsideForecastRange</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Ticked (LedgerView (BlockProtocol blk)))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1288"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span>                      </span><span id="local-6989586621680036700"><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036700"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
-&gt; Maybe (Ticked (LedgerView (BlockProtocol blk)))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036700"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1289"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1290"></span><span>    </span><span class="annot"><a href="#local-6989586621680036702"><span class="hs-identifier hs-type">forecast</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Forecast.html#Forecast"><span class="hs-identifier hs-type">Forecast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037296"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1291"></span><span>    </span><span id="local-6989586621680036702"><span class="annot"><span class="annottext">forecast :: Forecast (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621680036702"><span class="hs-identifier hs-var hs-var">forecast</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk -&gt; Forecast (LedgerView (BlockProtocol blk))
forall blk.
(LedgerSupportsProtocol blk, HasCallStack) =&gt;
LedgerConfig blk
-&gt; LedgerState blk -&gt; Forecast (LedgerView (BlockProtocol blk))
</span><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#ledgerViewForecastAt"><span class="hs-identifier hs-var">ledgerViewForecastAt</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621680036706"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621680036705"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1292"></span><span>
</span><span id="line-1293"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#getIntersectionLedgerState"><span class="hs-identifier hs-type">getIntersectionLedgerState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037298"><span class="annot"><a href="#local-6989586621680037298"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680037299"><span class="annot"><a href="#local-6989586621680037299"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1294"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037299"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037298"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1295"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037299"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037298"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1296"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037298"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1297"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037299"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037298"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1298"></span><span id="getIntersectionLedgerState"><span class="annot"><span class="annottext">getIntersectionLedgerState :: ChainDbView m blk
-&gt; KnownIntersectionState blk -&gt; STM m (LedgerState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#getIntersectionLedgerState"><span class="hs-identifier hs-var hs-var">getIntersectionLedgerState</span></a></span></span><span> </span><span id="local-6989586621680036698"><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036698"><span class="hs-identifier hs-var">cdbView</span></a></span></span><span> </span><span id="local-6989586621680036697"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036697"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1299"></span><span>    </span><span class="annot"><span class="annottext">Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="#local-6989586621680036696"><span class="hs-identifier hs-var">getPastLedger</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036695"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Maybe (ExtLedgerState blk))
-&gt; (Maybe (ExtLedgerState blk) -&gt; STM m (LedgerState blk))
-&gt; STM m (LedgerState blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1300"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680036694"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680036694"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1301"></span><span>          </span><span class="annot"><span class="annottext">LedgerState blk -&gt; STM m (LedgerState blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(LedgerState blk -&gt; STM m (LedgerState blk))
-&gt; LedgerState blk -&gt; STM m (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621680036694"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1302"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ExtLedgerState blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1303"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; STM m (LedgerState blk)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; STM m (LedgerState blk))
-&gt; String -&gt; STM m (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1304"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;intersection not within last k blocks: &quot;</span></span><span>
</span><span id="line-1305"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036695"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-1306"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1307"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1308"></span><span>        </span><span id="local-6989586621680036696"><span class="annot"><span class="annottext">Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
getPastLedger :: Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
$sel:getPastLedger:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="#local-6989586621680036696"><span class="hs-identifier hs-var hs-var">getPastLedger</span></a></span></span><span>
</span><span id="line-1309"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621680036698"><span class="hs-identifier hs-var">cdbView</span></a></span><span>
</span><span id="line-1310"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1311"></span><span>        </span><span id="local-6989586621680036695"><span class="annot"><span class="annottext">Point blk
mostRecentIntersection :: Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
</span><a href="#local-6989586621680036695"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-1312"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621680036697"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1313"></span><span>
</span><span id="line-1314"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Explicit state
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1317"></span><span>
</span><span id="line-1318"></span><span class="hs-comment">-- | Make the state maintained by the chain sync client explicit</span><span>
</span><span id="line-1319"></span><span class="hs-comment">--</span><span>
</span><span id="line-1320"></span><span class="hs-comment">-- The chain sync client contains of a bunch of functions that basically look</span><span>
</span><span id="line-1321"></span><span class="hs-comment">-- like &quot;do some network stuff, compute some stuff, and then continue with</span><span>
</span><span id="line-1322"></span><span class="hs-comment">-- such-and-such a new state&quot;. We want to make sure to keep that state in NF</span><span>
</span><span id="line-1323"></span><span class="hs-comment">-- at all times, but since we don't use a TVar to store it, we cannot reuse</span><span>
</span><span id="line-1324"></span><span class="hs-comment">-- the existing infrastructure for checking TVars for NF. Instead, we make</span><span>
</span><span id="line-1325"></span><span class="hs-comment">-- the state explicit in the types and do the check in 'continueWithState'.</span><span>
</span><span id="line-1326"></span><span class="hs-keyword">newtype</span><span> </span><span id="Stateful"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span></span><span> </span><span id="local-6989586621680037462"><span class="annot"><a href="#local-6989586621680037462"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680037463"><span class="annot"><a href="#local-6989586621680037463"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680037461"><span class="annot"><a href="#local-6989586621680037461"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Stateful"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680037463"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037462"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037461"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1327"></span><span>
</span><span id="line-1328"></span><span class="hs-keyword">type</span><span> </span><span id="StatefulConsensus"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StatefulConsensus"><span class="hs-identifier hs-var">StatefulConsensus</span></a></span></span><span> </span><span id="local-6989586621680036692"><span class="annot"><a href="#local-6989586621680036692"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680036691"><span class="annot"><a href="#local-6989586621680036691"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680036690"><span class="annot"><a href="#local-6989586621680036690"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680036689"><span class="annot"><a href="#local-6989586621680036689"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036692"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036690"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036689"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036691"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036692"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1329"></span><span>
</span><span id="line-1330"></span><span class="hs-comment">-- | See 'Stateful'.</span><span>
</span><span id="line-1331"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-type">continueWithState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037466"><span class="annot"><a href="#local-6989586621680037466"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680037467"><span class="annot"><a href="#local-6989586621680037467"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680037465"><span class="annot"><a href="#local-6989586621680037465"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1332"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621680037467"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1333"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037467"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037466"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037467"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037465"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037466"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037465"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-1334"></span><span id="continueWithState"><span class="annot"><span class="annottext">continueWithState :: s -&gt; Stateful m s r -&gt; m r
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var hs-var">continueWithState</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680036688"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036688"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span id="local-6989586621680036687"><span class="annot"><span class="annottext">s -&gt; m r
</span><a href="#local-6989586621680036687"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1335"></span><span>    </span><span class="annot"><span class="annottext">Maybe String -&gt; m r -&gt; m r
forall a. HasCallStack =&gt; Maybe String -&gt; a -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">checkInvariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThunkInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(ThunkInfo -&gt; String) -&gt; Maybe ThunkInfo -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe ThunkInfo
forall a. NoThunks a =&gt; a -&gt; Maybe ThunkInfo
</span><span class="hs-identifier hs-var">unsafeNoThunks</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036688"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m r -&gt; m r) -&gt; m r -&gt; m r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">s -&gt; m r
</span><a href="#local-6989586621680036687"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680036688"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1336"></span><span>
</span><span id="line-1337"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Return value
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1340"></span><span>
</span><span id="line-1341"></span><span class="hs-comment">-- | The Chain sync client only _gracefully_ terminates when the upstream node's</span><span>
</span><span id="line-1342"></span><span class="hs-comment">-- chain is not interesting (e.g., forked off too far in the past). By</span><span>
</span><span id="line-1343"></span><span class="hs-comment">-- gracefully terminating, the network layer can keep the other mini-protocols</span><span>
</span><span id="line-1344"></span><span class="hs-comment">-- connect to the same upstream node running.</span><span>
</span><span id="line-1345"></span><span class="hs-comment">--</span><span>
</span><span id="line-1346"></span><span class="hs-comment">-- For example, a relay node will often receive connections from nodes syncing</span><span>
</span><span id="line-1347"></span><span class="hs-comment">-- from scratch or an old chain. Since these nodes have a chain that is shorter</span><span>
</span><span id="line-1348"></span><span class="hs-comment">-- than the relay node's chain, it's useless for the relay node to run the</span><span>
</span><span id="line-1349"></span><span class="hs-comment">-- client-side of the chain sync protocol. However, the other direction of the</span><span>
</span><span id="line-1350"></span><span class="hs-comment">-- protocol, and, e.g., the transaction submission protocol, should keep</span><span>
</span><span id="line-1351"></span><span class="hs-comment">-- running.</span><span>
</span><span id="line-1352"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSyncClientResult"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-var">ChainSyncClientResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1353"></span><span>      </span><span class="hs-comment">-- | The server we're connecting to forked more than @k@ blocks ago.</span><span>
</span><span id="line-1354"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037464"><span class="annot"><a href="#local-6989586621680037464"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037464"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1355"></span><span>        </span><span id="ForkTooDeep"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-var">ForkTooDeep</span></a></span></span><span>
</span><span id="line-1356"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037464"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Intersection</span><span>
</span><span id="line-1357"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037464"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1358"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037464"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1359"></span><span>
</span><span id="line-1360"></span><span>      </span><span class="hs-comment">-- | Our chain changed such that it no longer intersects with the</span><span>
</span><span id="line-1361"></span><span>      </span><span class="hs-comment">-- candidate's fragment, and asking for a new intersection did not yield</span><span>
</span><span id="line-1362"></span><span>      </span><span class="hs-comment">-- one.</span><span>
</span><span id="line-1363"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037410"><span class="annot"><a href="#local-6989586621680037410"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037410"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1364"></span><span>        </span><span id="NoMoreIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-var">NoMoreIntersection</span></a></span></span><span>
</span><span id="line-1365"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037410"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1366"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037410"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1367"></span><span>
</span><span id="line-1368"></span><span>      </span><span class="hs-comment">-- | We were asked to roll back past the anchor point of the candidate's</span><span>
</span><span id="line-1369"></span><span>      </span><span class="hs-comment">-- fragment. This means the candidate chain no longer forks off within</span><span>
</span><span id="line-1370"></span><span>      </span><span class="hs-comment">-- @k@, making it impossible to switch to.</span><span>
</span><span id="line-1371"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680036685"><span class="annot"><a href="#local-6989586621680036685"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036685"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1372"></span><span>        </span><span id="RolledBackPastIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-var">RolledBackPastIntersection</span></a></span></span><span>
</span><span id="line-1373"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036685"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Point asked to roll back to</span><span>
</span><span id="line-1374"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036685"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1375"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036685"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1376"></span><span>
</span><span id="line-1377"></span><span>      </span><span class="hs-comment">-- | We were asked to terminate via the 'ControlMessageSTM'</span><span>
</span><span id="line-1378"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="AskedToTerminate"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span></span><span>
</span><span id="line-1379"></span><span>
</span><span id="line-1380"></span><span id="local-6989586621680036679"><span id="local-6989586621680036681"><span id="local-6989586621680036683"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span></span></span></span><span>
</span><span id="line-1381"></span><span>
</span><span id="line-1382"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680036676"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1383"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-type">ForkTooDeep</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036675"><span id="local-6989586621680036674"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036674"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036675"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036673"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036673"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621680036672"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036672"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621680036671"><span class="annot"><span class="annottext">== :: ChainSyncClientResult -&gt; ChainSyncClientResult -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-type">ForkTooDeep</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036670"><span id="local-6989586621680036669"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036669"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036670"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036668"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036668"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621680036667"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036667"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1384"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036675"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036670"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1385"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1386"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036674"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036673"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036672"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621680036669"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621680036668"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621680036667"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1387"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-type">ForkTooDeep</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1388"></span><span>
</span><span id="line-1389"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-type">NoMoreIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036664"><span id="local-6989586621680036663"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036663"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036664"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036662"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036662"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-type">NoMoreIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036661"><span id="local-6989586621680036660"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036660"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036661"><span class="hs-identifier hs-type">blk'</span></a></span><span class="hs-special">)</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036659"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036659"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1390"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036664"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036661"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1391"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1392"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036663"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036662"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Our (Tip blk), Their (Tip blk))
-&gt; (Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621680036660"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621680036659"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1393"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-type">NoMoreIntersection</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1394"></span><span>
</span><span id="line-1395"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-type">RolledBackPastIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036658"><span id="local-6989586621680036657"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036657"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036658"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036656"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036656"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621680036655"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036655"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-type">RolledBackPastIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036654"><span id="local-6989586621680036653"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036653"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036654"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036652"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036652"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621680036651"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036651"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1396"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036658"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036654"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1397"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1398"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036657"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036656"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036655"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621680036653"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621680036652"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621680036651"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1399"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-type">RolledBackPastIntersection</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1400"></span><span>
</span><span id="line-1401"></span><span>  </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1402"></span><span>  </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1403"></span><span>
</span><span id="line-1404"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Exception
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1407"></span><span>
</span><span id="line-1408"></span><span class="hs-comment">-- | When the upstream node violates the protocol or exhibits malicious</span><span>
</span><span id="line-1409"></span><span class="hs-comment">-- behaviour, e.g., serving an invalid header or a header corresponding to a</span><span>
</span><span id="line-1410"></span><span class="hs-comment">-- known invalid block, we throw an exception to disconnect. This will bring</span><span>
</span><span id="line-1411"></span><span class="hs-comment">-- down all miniprotocols in both directions with that node.</span><span>
</span><span id="line-1412"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSyncClientException"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-var">ChainSyncClientException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1413"></span><span>      </span><span class="hs-comment">-- | Header validation threw an error.</span><span>
</span><span id="line-1414"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037348"><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#ValidateEnvelope"><span class="hs-identifier hs-type">ValidateEnvelope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1415"></span><span>        </span><span id="HeaderError"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-var">HeaderError</span></a></span></span><span>
</span><span id="line-1416"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Invalid header</span><span>
</span><span id="line-1417"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1418"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1419"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037348"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1420"></span><span>
</span><span id="line-1421"></span><span>      </span><span class="hs-comment">-- | We send the upstream node a bunch of points from a chain fragment and</span><span>
</span><span id="line-1422"></span><span>      </span><span class="hs-comment">-- the upstream node responded with an intersection point that is not on</span><span>
</span><span id="line-1423"></span><span>      </span><span class="hs-comment">-- our chain fragment, and thus not among the points we sent.</span><span>
</span><span id="line-1424"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1425"></span><span>      </span><span class="hs-comment">-- We store the intersection point the upstream node sent us.</span><span>
</span><span id="line-1426"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037432"><span class="annot"><a href="#local-6989586621680037432"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037432"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1427"></span><span>        </span><span id="InvalidIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-var">InvalidIntersection</span></a></span></span><span>
</span><span id="line-1428"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037432"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Intersection</span><span>
</span><span id="line-1429"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037432"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1430"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037432"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1431"></span><span>
</span><span id="line-1432"></span><span>      </span><span class="hs-comment">-- | The received header to roll forward doesn't fit onto the previous</span><span>
</span><span id="line-1433"></span><span>      </span><span class="hs-comment">-- one.</span><span>
</span><span id="line-1434"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1435"></span><span>      </span><span class="hs-comment">-- The first 'ChainHash' is the previous hash of the received header and</span><span>
</span><span id="line-1436"></span><span>      </span><span class="hs-comment">-- the second 'ChainHash' is that of the previous one.</span><span>
</span><span id="line-1437"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037355"><span class="annot"><a href="#local-6989586621680037355"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037355"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1438"></span><span>        </span><span id="DoesntFit"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DoesntFit"><span class="hs-identifier hs-var">DoesntFit</span></a></span></span><span>
</span><span id="line-1439"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037355"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Received hash</span><span>
</span><span id="line-1440"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037355"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Expected hash</span><span>
</span><span id="line-1441"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037355"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1442"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037355"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1443"></span><span>
</span><span id="line-1444"></span><span>      </span><span class="hs-comment">-- | The upstream node's chain contained a block that we know is invalid.</span><span>
</span><span id="line-1445"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037374"><span class="annot"><a href="#local-6989586621680037374"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037374"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1446"></span><span>        </span><span id="InvalidBlock"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span></span><span>
</span><span id="line-1447"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037374"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Invalid block</span><span>
</span><span id="line-1448"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037374"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1449"></span><span>
</span><span id="line-1450"></span><span id="local-6989586621680036645"><span id="local-6989586621680036647"><span id="local-6989586621680036649"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span></span></span></span><span>
</span><span id="line-1451"></span><span>
</span><span id="line-1452"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680036642"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1453"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036641"><span id="local-6989586621680036640"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036640"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036641"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036639"><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621680036639"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621680036638"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036638"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621680036637"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036637"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621680036636"><span class="annot"><span class="annottext">== :: ChainSyncClientException -&gt; ChainSyncClientException -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036635"><span id="local-6989586621680036634"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036634"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036635"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036633"><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621680036633"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621680036632"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036632"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span id="local-6989586621680036631"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036631"><span class="hs-identifier hs-var">d'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1454"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036641"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036635"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1455"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1456"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036640"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621680036639"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036638"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036637"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, HeaderError blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, HeaderError blk, Our (Tip blk), Their (Tip blk))
-&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621680036634"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderError blk
HeaderError blk
</span><a href="#local-6989586621680036633"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621680036632"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621680036631"><span class="hs-identifier hs-var">d'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1457"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1458"></span><span>
</span><span id="line-1459"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-type">InvalidIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036630"><span id="local-6989586621680036629"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036629"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036630"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036628"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036628"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621680036627"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036627"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-type">InvalidIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036626"><span id="local-6989586621680036625"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036625"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036626"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036624"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036624"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621680036623"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036623"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1460"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036630"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036626"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1461"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1462"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036629"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036628"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036627"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621680036625"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621680036624"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621680036623"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1463"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-type">InvalidIntersection</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1464"></span><span>
</span><span id="line-1465"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DoesntFit"><span class="hs-identifier hs-type">DoesntFit</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036622"><span id="local-6989586621680036621"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036621"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036622"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036620"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036620"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621680036619"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036619"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621680036618"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036618"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DoesntFit"><span class="hs-identifier hs-type">DoesntFit</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036617"><span id="local-6989586621680036616"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036616"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036617"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036615"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036615"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621680036614"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036614"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span id="local-6989586621680036613"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036613"><span class="hs-identifier hs-var">d'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1466"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036622"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036617"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1467"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1468"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036621"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621680036620"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621680036619"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621680036618"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainHash blk, ChainHash blk, Our (Tip blk), Their (Tip blk))
-&gt; (ChainHash blk, ChainHash blk, Our (Tip blk), Their (Tip blk))
-&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainHash blk
ChainHash blk
</span><a href="#local-6989586621680036616"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainHash blk
ChainHash blk
</span><a href="#local-6989586621680036615"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621680036614"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621680036613"><span class="hs-identifier hs-var">d'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1469"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DoesntFit"><span class="hs-identifier hs-type">DoesntFit</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1470"></span><span>
</span><span id="line-1471"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-type">InvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036612"><span id="local-6989586621680036611"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036611"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036612"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036610"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036610"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-type">InvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680036609"><span id="local-6989586621680036608"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036608"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036609"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680036607"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036607"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1472"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Typeable blk, Typeable blk) =&gt; Maybe (blk :~: blk)
forall k (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
</span><span class="hs-identifier hs-var">eqT</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036612"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680036609"><span class="hs-identifier hs-type">blk'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1473"></span><span>      </span><span class="annot"><span class="annottext">Maybe (blk :~: blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1474"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><span class="hs-identifier hs-var">Refl</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680036611"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621680036610"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, InvalidBlockReason blk)
-&gt; (Point blk, InvalidBlockReason blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621680036608"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
InvalidBlockReason blk
</span><a href="#local-6989586621680036607"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1475"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-type">InvalidBlock</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1476"></span><span>
</span><span id="line-1477"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680036599"><span id="local-6989586621680036601"><span id="local-6989586621680036603"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span></span></span></span><span>
</span><span id="line-1478"></span><span>
</span><span id="line-1479"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  TODO #221: Implement genesis

  Genesis in paper:

    When we compare a candidate to our own chain, and that candidate forks off
    more than k in the past, we compute the intersection point between that
    candidate and our chain, select s slots from both chains, and compare the
    number of blocks within those s slots. If the candidate has more blocks
    in those s slots, we prefer the candidate, otherwise we stick with our own
    chain.

  Genesis as we will implement it:

    * We decide we are in genesis mode if the head of our chain is more than
      @k@ blocks behind the blockchain time. We will have to approximate this
      as @k/f@ /slots/ behind the blockchain time time.
    * In this situation, we must make sure we have a sufficient number of
      upstream nodes &quot;and collect chains from all of them&quot;
    * We still never consider chains that would require /us/ to rollback more
      than k blocks.
    * In order to compare two candidates, we compute the intersection point of
      X of those two candidates and compare the density at point X.




  Scribbled notes during meeting with Duncan:

   geensis mode: compare clock to our chain
   do we have enough peers?
   still only interested in chains that don't fork more than k from our own chain

     downloading headers from a /single/ node, download at least s headers
     inform /other/ peers: &quot;here is a point on our chain&quot;
     if all agree (&quot;intersection imporved&quot;) -- all peers agree
     avoid downloading tons of headers
     /if/ there is a difference, get s headers from the peer who disagrees,
       pick the denser one, and ignore the other
       PROBLEM: what if the denser node has invalid block bodies??
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1520"></span><span>
</span><span id="line-1521"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Trace events
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1524"></span><span>
</span><span id="line-1525"></span><span class="hs-comment">-- | Events traced by the Chain Sync Client.</span><span>
</span><span id="line-1526"></span><span class="hs-keyword">data</span><span> </span><span id="TraceChainSyncClientEvent"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-var">TraceChainSyncClientEvent</span></a></span></span><span> </span><span id="local-6989586621680037438"><span class="annot"><a href="#local-6989586621680037438"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-1527"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TraceDownloadedHeader"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceDownloadedHeader"><span class="hs-identifier hs-var">TraceDownloadedHeader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037438"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1528"></span><span>    </span><span class="hs-comment">-- ^ While following a candidate chain, we rolled forward by downloading a</span><span>
</span><span id="line-1529"></span><span>    </span><span class="hs-comment">-- header.</span><span>
</span><span id="line-1530"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceRolledBack"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceRolledBack"><span class="hs-identifier hs-var">TraceRolledBack</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037438"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1531"></span><span>    </span><span class="hs-comment">-- ^ While following a candidate chain, we rolled back to the given point.</span><span>
</span><span id="line-1532"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceFoundIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceFoundIntersection"><span class="hs-identifier hs-var">TraceFoundIntersection</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037438"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037438"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037438"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1533"></span><span>    </span><span class="hs-comment">-- ^ We found an intersection between our chain fragment and the</span><span>
</span><span id="line-1534"></span><span>    </span><span class="hs-comment">-- candidate's chain.</span><span>
</span><span id="line-1535"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceException"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceException"><span class="hs-identifier hs-var">TraceException</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span><span>
</span><span id="line-1536"></span><span>    </span><span class="hs-comment">-- ^ An exception was thrown by the Chain Sync Client.</span><span>
</span><span id="line-1537"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceTermination"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceTermination"><span class="hs-identifier hs-var">TraceTermination</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-1538"></span><span>    </span><span class="hs-comment">-- ^ The client has terminated.</span><span>
</span><span id="line-1539"></span><span>
</span><span id="line-1540"></span><span id="local-6989586621680036593"><span id="local-6989586621680036595"><span id="local-6989586621680036597"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036597"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1541"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ValidationErr"><span class="hs-identifier hs-type">ValidationErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036597"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1542"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036597"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1543"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-1544"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036597"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1545"></span><span id="local-6989586621680036586"><span id="local-6989586621680036588"><span id="local-6989586621680036590"><span id="local-6989586621680036592"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036592"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1546"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036592"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1547"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-1548"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680036592"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1549"></span></pre></body></html>