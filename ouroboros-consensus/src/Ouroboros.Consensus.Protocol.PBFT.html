<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass            #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric             #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts          #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances         #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses     #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns            #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms           #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards           #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables       #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving        #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications          #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilyDependencies    #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators             #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances      #-}</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Protocol.PBFT</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier">PBft</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier">PBftCanBeLeader</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier">PBftFields</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier">PBftIsLeader</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier">PBftLedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftParams"><span class="hs-identifier">PBftParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier">PBftSelectView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSignatureThreshold"><span class="hs-identifier">PBftSignatureThreshold</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#mkPBftSelectView"><span class="hs-identifier">mkPBftSelectView</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowExceedsThreshold"><span class="hs-identifier">pbftWindowExceedsThreshold</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowSize"><span class="hs-identifier">pbftWindowSize</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Forging</span></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#forgePBftFields"><span class="hs-identifier">forgePBftFields</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Classes</span></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier">PBftCrypto</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftMockCrypto"><span class="hs-identifier">PBftMockCrypto</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftMockVerKeyHash"><span class="hs-identifier">PBftMockVerKeyHash</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateView"><span class="hs-identifier">PBftValidateView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftValidateBoundary"><span class="hs-identifier">pbftValidateBoundary</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftValidateRegular"><span class="hs-identifier">pbftValidateRegular</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-comment">-- * CannotForge</span></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForge"><span class="hs-identifier">PBftCannotForge</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftCheckCanForge"><span class="hs-identifier">pbftCheckCanForge</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Type instances</span></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier">Ticked</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exported for tracing errors</span></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidationErr"><span class="hs-identifier">PBftValidationErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.Serialise</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Serialise</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Exn</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Bimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bimap</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Bimap</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word64</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoThunks</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Crypto.DSIGN.Class</span></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Node.ProtocolInfo.html"><span class="hs-identifier">Ouroboros.Consensus.Node.ProtocolInfo</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.NodeId.html"><span class="hs-identifier">Ouroboros.Consensus.NodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.NodeId.html#CoreNodeId"><span class="hs-identifier">CoreNodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Abstract</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.PBFT.Crypto</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.PBFT.State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier">PBftState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.PBFT.State</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Signed.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Signed</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ticked.html"><span class="hs-identifier">Ouroboros.Consensus.Ticked</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Condense.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Condense</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Orphans.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Fields that PBFT requires present in a block
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span id="local-6989586621680038040"><span id="local-6989586621680038041"></span></span><span class="hs-keyword">data</span><span> </span><span id="PBftFields"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-var">PBftFields</span></a></span></span><span> </span><span id="local-6989586621680038208"><span class="annot"><a href="#local-6989586621680038208"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621680038207"><span class="annot"><a href="#local-6989586621680038207"><span class="hs-identifier hs-type">toSign</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftFields"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-var">PBftFields</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-80"></span><span>      </span><span class="hs-comment">-- | The actual issuer of a block</span><span>
</span><span id="line-81"></span><span>      </span><span id="pbftIssuer"><span class="annot"><span class="annottext">PBftFields c toSign -&gt; VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIssuer"><span class="hs-identifier hs-var hs-var">pbftIssuer</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">VerKeyDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038208"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>      </span><span class="hs-comment">-- | The stakeholder on whose behalf the block is being issued</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftGenKey"><span class="annot"><span class="annottext">PBftFields c toSign -&gt; VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftGenKey"><span class="hs-identifier hs-var hs-var">pbftGenKey</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">VerKeyDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038208"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftSignature"><span class="annot"><span class="annottext">PBftFields c toSign -&gt; SignedDSIGN (PBftDSIGN c) toSign
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSignature"><span class="hs-identifier hs-var hs-var">pbftSignature</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SignedDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038208"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680038207"><span class="hs-identifier hs-type">toSign</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftFields c toSign -&gt; Rep (PBftFields c toSign) x)
-&gt; (forall x. Rep (PBftFields c toSign) x -&gt; PBftFields c toSign)
-&gt; Generic (PBftFields c toSign)
forall x. Rep (PBftFields c toSign) x -&gt; PBftFields c toSign
forall x. PBftFields c toSign -&gt; Rep (PBftFields c toSign) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c toSign x.
Rep (PBftFields c toSign) x -&gt; PBftFields c toSign
forall c toSign x.
PBftFields c toSign -&gt; Rep (PBftFields c toSign) x
$cto :: forall c toSign x.
Rep (PBftFields c toSign) x -&gt; PBftFields c toSign
$cfrom :: forall c toSign x.
PBftFields c toSign -&gt; Rep (PBftFields c toSign) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span id="local-6989586621680038025"><span id="local-6989586621680038027"><span id="local-6989586621680038029"><span id="local-6989586621680038031"><span id="local-6989586621680038032"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038032"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038032"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038031"><span class="hs-identifier hs-type">toSign</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-89"></span><span id="local-6989586621680038018"><span id="local-6989586621680038020"><span id="local-6989586621680038022"><span id="local-6989586621680038023"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038023"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038023"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038022"><span class="hs-identifier hs-type">toSign</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span id="local-6989586621680038015"><span id="local-6989586621680038016"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680038009"><span id="local-6989586621680038011"><span id="local-6989586621680038013"><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038016"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621680038015"><span class="hs-identifier hs-type">toSign</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038016"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038015"><span class="hs-identifier hs-type">toSign</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-comment">-- use generic instance</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- | Part of the header that we validate</span><span>
</span><span id="line-95"></span><span class="hs-keyword">data</span><span> </span><span id="PBftValidateView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateView"><span class="hs-identifier hs-var">PBftValidateView</span></a></span></span><span> </span><span id="local-6989586621680038237"><span class="annot"><a href="#local-6989586621680038237"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>     </span><span class="hs-comment">-- | Regular block</span><span>
</span><span id="line-97"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span>     </span><span class="hs-comment">-- Regular blocks are signed, and so we need to validate them.</span><span>
</span><span id="line-99"></span><span>     </span><span class="hs-comment">-- We also need to know the slot number of the block</span><span>
</span><span id="line-100"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680038236"><span class="annot"><a href="#local-6989586621680038236"><span class="hs-identifier hs-type">signed</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Signable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038237"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680038236"><span class="hs-identifier hs-type">signed</span></a></span><span>
</span><span id="line-101"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span id="PBftValidateRegular"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateRegular"><span class="hs-identifier hs-var">PBftValidateRegular</span></a></span></span><span>
</span><span id="line-102"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038237"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038236"><span class="hs-identifier hs-type">signed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>                      </span><span class="annot"><a href="#local-6989586621680038236"><span class="hs-identifier hs-type">signed</span></a></span><span>
</span><span id="line-104"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContextDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038237"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>     </span><span class="hs-comment">-- | Boundary block (EBB)</span><span>
</span><span id="line-107"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span>     </span><span class="hs-comment">-- EBBs are not signed and they do not affect the consensus state.</span><span>
</span><span id="line-109"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="PBftValidateBoundary"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateBoundary"><span class="hs-identifier hs-var">PBftValidateBoundary</span></a></span></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Convenience constructor for 'PBftValidateView' for regular blocks</span><span>
</span><span id="line-112"></span><span id="local-6989586621680038004"><span id="local-6989586621680038005"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftValidateRegular"><span class="hs-identifier hs-type">pbftValidateRegular</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Signed.html#SignedHeader"><span class="hs-identifier hs-type">SignedHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038005"><span class="hs-identifier hs-type">hdr</span></a></span><span>
</span><span id="line-113"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Signable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038004"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Signed.html#Signed"><span class="hs-identifier hs-type">Signed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038005"><span class="hs-identifier hs-type">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContextDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038004"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680038005"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038004"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Signed.html#Signed"><span class="hs-identifier hs-type">Signed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038005"><span class="hs-identifier hs-type">hdr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680038005"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateView"><span class="hs-identifier hs-type">PBftValidateView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038004"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-118"></span><span id="pbftValidateRegular"><span class="annot"><span class="annottext">pbftValidateRegular :: ContextDSIGN (PBftDSIGN c)
-&gt; (hdr -&gt; PBftFields c (Signed hdr)) -&gt; hdr -&gt; PBftValidateView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftValidateRegular"><span class="hs-identifier hs-var hs-var">pbftValidateRegular</span></a></span></span><span> </span><span id="local-6989586621680038003"><span class="annot"><span class="annottext">ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680038003"><span class="hs-identifier hs-var">contextDSIGN</span></a></span></span><span> </span><span id="local-6989586621680038002"><span class="annot"><span class="annottext">hdr -&gt; PBftFields c (Signed hdr)
</span><a href="#local-6989586621680038002"><span class="hs-identifier hs-var">getFields</span></a></span></span><span> </span><span id="local-6989586621680038001"><span class="annot"><span class="annottext">hdr
</span><a href="#local-6989586621680038001"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><span class="annottext">PBftFields c (Signed hdr)
-&gt; Signed hdr -&gt; ContextDSIGN (PBftDSIGN c) -&gt; PBftValidateView c
forall c signed.
Signable (PBftDSIGN c) signed =&gt;
PBftFields c signed
-&gt; signed -&gt; ContextDSIGN (PBftDSIGN c) -&gt; PBftValidateView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateRegular"><span class="hs-identifier hs-var">PBftValidateRegular</span></a></span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">hdr -&gt; PBftFields c (Signed hdr)
</span><a href="#local-6989586621680038002"><span class="hs-identifier hs-var">getFields</span></a></span><span> </span><span class="annot"><span class="annottext">hdr
</span><a href="#local-6989586621680038001"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">hdr -&gt; Signed hdr
forall hdr. SignedHeader hdr =&gt; hdr -&gt; Signed hdr
</span><a href="Ouroboros.Consensus.Protocol.Signed.html#headerSigned"><span class="hs-identifier hs-var">headerSigned</span></a></span><span> </span><span class="annot"><span class="annottext">hdr
</span><a href="#local-6989586621680038001"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><span class="annottext">ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680038003"><span class="hs-identifier hs-var">contextDSIGN</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | Convenience constructor for 'PBftValidateView' for boundary blocks</span><span>
</span><span id="line-125"></span><span id="local-6989586621680037998"><span id="local-6989586621680037999"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftValidateBoundary"><span class="hs-identifier hs-type">pbftValidateBoundary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680037999"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateView"><span class="hs-identifier hs-type">PBftValidateView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037998"><span class="hs-identifier hs-type">c</span></a></span></span></span><span>
</span><span id="line-126"></span><span id="pbftValidateBoundary"><span class="annot"><span class="annottext">pbftValidateBoundary :: hdr -&gt; PBftValidateView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftValidateBoundary"><span class="hs-identifier hs-var hs-var">pbftValidateBoundary</span></a></span></span><span> </span><span id="local-6989586621680037997"><span class="annot"><span class="annottext">hdr
</span><a href="#local-6989586621680037997"><span class="hs-identifier hs-var">_hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftValidateView c
forall c. PBftValidateView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateBoundary"><span class="hs-identifier hs-var">PBftValidateBoundary</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- | Part of the header required for chain selection</span><span>
</span><span id="line-129"></span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- EBBs share a block number with regular blocks, and so for chain selection</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- we need to know if a block is an EBB or not (because a chain ending on an</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- EBB with a particular block number is longer than a chain on a regular</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- block with that same block number).</span><span>
</span><span id="line-134"></span><span class="hs-keyword">data</span><span> </span><span id="PBftSelectView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-var">PBftSelectView</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftSelectView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-var">PBftSelectView</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-135"></span><span>      </span><span id="pbftSelectViewBlockNo"><span class="annot"><span class="annottext">PBftSelectView -&gt; BlockNo
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSelectViewBlockNo"><span class="hs-identifier hs-var hs-var">pbftSelectViewBlockNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftSelectViewIsEBB"><span class="annot"><span class="annottext">PBftSelectView -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSelectViewIsEBB"><span class="hs-identifier hs-var hs-var">pbftSelectViewIsEBB</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680037988"><span id="local-6989586621680037990"><span id="local-6989586621680037992"><span class="annot"><span class="annottext">Int -&gt; PBftSelectView -&gt; ShowS
[PBftSelectView] -&gt; ShowS
PBftSelectView -&gt; String
(Int -&gt; PBftSelectView -&gt; ShowS)
-&gt; (PBftSelectView -&gt; String)
-&gt; ([PBftSelectView] -&gt; ShowS)
-&gt; Show PBftSelectView
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PBftSelectView] -&gt; ShowS
$cshowList :: [PBftSelectView] -&gt; ShowS
show :: PBftSelectView -&gt; String
$cshow :: PBftSelectView -&gt; String
showsPrec :: Int -&gt; PBftSelectView -&gt; ShowS
$cshowsPrec :: Int -&gt; PBftSelectView -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037984"><span id="local-6989586621680037986"><span class="annot"><span class="annottext">PBftSelectView -&gt; PBftSelectView -&gt; Bool
(PBftSelectView -&gt; PBftSelectView -&gt; Bool)
-&gt; (PBftSelectView -&gt; PBftSelectView -&gt; Bool) -&gt; Eq PBftSelectView
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PBftSelectView -&gt; PBftSelectView -&gt; Bool
$c/= :: PBftSelectView -&gt; PBftSelectView -&gt; Bool
== :: PBftSelectView -&gt; PBftSelectView -&gt; Bool
$c== :: PBftSelectView -&gt; PBftSelectView -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span id="local-6989586621680037983"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#mkPBftSelectView"><span class="hs-identifier hs-type">mkPBftSelectView</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetHeader"><span class="hs-identifier hs-type">GetHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037983"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037983"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-type">PBftSelectView</span></a></span></span><span>
</span><span id="line-141"></span><span id="mkPBftSelectView"><span class="annot"><span class="annottext">mkPBftSelectView :: Header blk -&gt; PBftSelectView
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#mkPBftSelectView"><span class="hs-identifier hs-var hs-var">mkPBftSelectView</span></a></span></span><span> </span><span id="local-6989586621680037982"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680037982"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftSelectView :: BlockNo -&gt; IsEBB -&gt; PBftSelectView
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-type">PBftSelectView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">pbftSelectViewBlockNo :: BlockNo
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSelectViewBlockNo"><span class="hs-identifier hs-var">pbftSelectViewBlockNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; BlockNo
forall b. HasHeader b =&gt; b -&gt; BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockNo</span></a></span><span>       </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680037982"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pbftSelectViewIsEBB :: IsEBB
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSelectViewIsEBB"><span class="hs-identifier hs-var">pbftSelectViewIsEBB</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB
forall blk. GetHeader blk =&gt; Header blk -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerToIsEBB"><span class="hs-identifier hs-var">headerToIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680037982"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037966"><span id="local-6989586621680037968"><span id="local-6989586621680037970"><span id="local-6989586621680037972"><span id="local-6989586621680037974"><span id="local-6989586621680037976"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-type">PBftSelectView</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621680037964"><span class="annot"><span class="annottext">compare :: PBftSelectView -&gt; PBftSelectView -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">compare</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-type">PBftSelectView</span></a></span><span> </span><span id="local-6989586621680037962"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621680037962"><span class="hs-identifier hs-var">lBlockNo</span></a></span></span><span> </span><span id="local-6989586621680037961"><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680037961"><span class="hs-identifier hs-var">lIsEBB</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-type">PBftSelectView</span></a></span><span> </span><span id="local-6989586621680037960"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621680037960"><span class="hs-identifier hs-var">rBlockNo</span></a></span></span><span> </span><span id="local-6989586621680037959"><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680037959"><span class="hs-identifier hs-var">rIsEBB</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>      </span><span class="annot"><span class="annottext">[Ordering] -&gt; Ordering
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-comment">-- Prefer the highest block number, as it is a proxy for chain length</span><span>
</span><span id="line-150"></span><span>          </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621680037962"><span class="hs-identifier hs-var">lBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo -&gt; BlockNo -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621680037960"><span class="hs-identifier hs-var">rBlockNo</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-comment">-- If the block numbers are the same, check if one of them is an EBB.</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-comment">-- An EBB has the same block number as the block before it, so the</span><span>
</span><span id="line-154"></span><span>          </span><span class="hs-comment">-- chain ending with an EBB is actually longer than the one ending</span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-comment">-- with a regular block.</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IsEBB -&gt; Int
</span><a href="#local-6989586621680037958"><span class="hs-identifier hs-var">score</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680037961"><span class="hs-identifier hs-var">lIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">IsEBB -&gt; Int
</span><a href="#local-6989586621680037958"><span class="hs-identifier hs-var">score</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621680037959"><span class="hs-identifier hs-var">rIsEBB</span></a></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-158"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-159"></span><span>       </span><span class="annot"><a href="#local-6989586621680037958"><span class="hs-identifier hs-type">score</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-160"></span><span>       </span><span id="local-6989586621680037958"><span class="annot"><span class="annottext">score :: IsEBB -&gt; Int
</span><a href="#local-6989586621680037958"><span class="hs-identifier hs-var hs-var">score</span></a></span></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-var">IsEBB</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-161"></span><span>       </span><span class="annot"><a href="#local-6989586621680037958"><span class="hs-identifier hs-var">score</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsNotEBB"><span class="hs-identifier hs-var">IsNotEBB</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Block forging
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#forgePBftFields"><span class="hs-identifier hs-type">forgePBftFields</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037955"><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621680037954"><span class="annot"><a href="#local-6989586621680037954"><span class="hs-identifier hs-type">toSign</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-168"></span><span>                       </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-169"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Signable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680037954"><span class="hs-identifier hs-type">toSign</span></a></span><span>
</span><span id="line-170"></span><span>                     </span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">VerKeyDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContextDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>                </span><span class="hs-comment">-- ^ Construct DSIGN context given 'pbftGenKey'</span><span>
</span><span id="line-173"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#IsLeader"><span class="hs-identifier hs-type">IsLeader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680037954"><span class="hs-identifier hs-type">toSign</span></a></span><span>
</span><span id="line-175"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037955"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037954"><span class="hs-identifier hs-type">toSign</span></a></span><span>
</span><span id="line-176"></span><span id="forgePBftFields"><span class="annot"><span class="annottext">forgePBftFields :: (VerKeyDSIGN (PBftDSIGN c) -&gt; ContextDSIGN (PBftDSIGN c))
-&gt; IsLeader (PBft c) -&gt; toSign -&gt; PBftFields c toSign
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#forgePBftFields"><span class="hs-identifier hs-var hs-var">forgePBftFields</span></a></span></span><span> </span><span id="local-6989586621680037953"><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037953"><span class="hs-identifier hs-var">contextDSIGN</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier hs-type">PBftIsLeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037950"><span id="local-6989586621680037951"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIsLeaderDlgCert"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680037947"><span class="annot"><span class="annottext">toSign
</span><a href="#local-6989586621680037947"><span class="hs-identifier hs-var">toSign</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; PBftFields c toSign -&gt; PBftFields c toSign
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">Exn.assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037946"><span class="hs-identifier hs-var">issuer</span></a></span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; VerKeyDSIGN (PBftDSIGN c) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SignKeyDSIGN (PBftDSIGN c) -&gt; VerKeyDSIGN (PBftDSIGN c)
forall v. DSIGNAlgorithm v =&gt; SignKeyDSIGN v -&gt; VerKeyDSIGN v
</span><span class="hs-identifier hs-var">deriveVerKeyDSIGN</span></span><span> </span><span class="annot"><span class="annottext">SignKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037951"><span class="hs-identifier hs-var">pbftIsLeaderSignKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PBftFields c toSign -&gt; PBftFields c toSign)
-&gt; PBftFields c toSign -&gt; PBftFields c toSign
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftFields :: forall c toSign.
VerKeyDSIGN (PBftDSIGN c)
-&gt; VerKeyDSIGN (PBftDSIGN c)
-&gt; SignedDSIGN (PBftDSIGN c) toSign
-&gt; PBftFields c toSign
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><span class="annottext">pbftIssuer :: VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIssuer"><span class="hs-identifier hs-var">pbftIssuer</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037946"><span class="hs-identifier hs-var">issuer</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pbftGenKey :: VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftGenKey"><span class="hs-identifier hs-var">pbftGenKey</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037944"><span class="hs-identifier hs-var">genKey</span></a></span><span>
</span><span id="line-180"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pbftSignature :: SignedDSIGN (PBftDSIGN c) toSign
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSignature"><span class="hs-identifier hs-var">pbftSignature</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SignedDSIGN (PBftDSIGN c) toSign
</span><a href="#local-6989586621680037943"><span class="hs-keyword hs-var">signature</span></a></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-183"></span><span>    </span><span id="local-6989586621680037946"><span class="annot"><span class="annottext">issuer :: VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037946"><span class="hs-identifier hs-var hs-var">issuer</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c)
forall c.
PBftCrypto c =&gt;
PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#dlgCertDlgVerKey"><span class="hs-identifier hs-var">dlgCertDlgVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c
</span><a href="#local-6989586621680037950"><span class="hs-identifier hs-var">pbftIsLeaderDlgCert</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621680037944"><span class="annot"><span class="annottext">genKey :: VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037944"><span class="hs-identifier hs-var hs-var">genKey</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c)
forall c.
PBftCrypto c =&gt;
PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#dlgCertGenVerKey"><span class="hs-identifier hs-var">dlgCertGenVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c
</span><a href="#local-6989586621680037950"><span class="hs-identifier hs-var">pbftIsLeaderDlgCert</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621680037940"><span class="annot"><span class="annottext">ctxtDSIGN :: ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037940"><span class="hs-identifier hs-var hs-var">ctxtDSIGN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037953"><span class="hs-identifier hs-var">contextDSIGN</span></a></span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037944"><span class="hs-identifier hs-var">genKey</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621680037943"><span class="annot"><span class="annottext">signature :: SignedDSIGN (PBftDSIGN c) toSign
</span><a href="#local-6989586621680037943"><span class="hs-keyword hs-var hs-var">signature</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContextDSIGN (PBftDSIGN c)
-&gt; toSign
-&gt; SignKeyDSIGN (PBftDSIGN c)
-&gt; SignedDSIGN (PBftDSIGN c) toSign
forall v a.
(DSIGNAlgorithm v, Signable v a) =&gt;
ContextDSIGN v -&gt; a -&gt; SignKeyDSIGN v -&gt; SignedDSIGN v a
</span><span class="hs-identifier hs-var">signedDSIGN</span></span><span> </span><span class="annot"><span class="annottext">ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037940"><span class="hs-identifier hs-var">ctxtDSIGN</span></a></span><span> </span><span class="annot"><span class="annottext">toSign
</span><a href="#local-6989586621680037947"><span class="hs-identifier hs-var">toSign</span></a></span><span> </span><span class="annot"><span class="annottext">SignKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037951"><span class="hs-identifier hs-var">pbftIsLeaderSignKey</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Information PBFT requires from the ledger
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span id="local-6989586621680037937"><span id="local-6989586621680037938"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="PBftLedgerView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-var">PBftLedgerView</span></a></span></span><span> </span><span id="local-6989586621680038179"><span class="annot"><a href="#local-6989586621680038179"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftLedgerView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-var">PBftLedgerView</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-comment">-- | ProtocolParameters: map from genesis to delegate keys.</span><span>
</span><span id="line-194"></span><span>      </span><span id="pbftDelegates"><span class="annot"><span class="annottext">PBftLedgerView c -&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftDelegates"><span class="hs-identifier hs-var hs-var">pbftDelegates</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038179"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038179"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftLedgerView c -&gt; Rep (PBftLedgerView c) x)
-&gt; (forall x. Rep (PBftLedgerView c) x -&gt; PBftLedgerView c)
-&gt; Generic (PBftLedgerView c)
forall x. Rep (PBftLedgerView c) x -&gt; PBftLedgerView c
forall x. PBftLedgerView c -&gt; Rep (PBftLedgerView c) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c x. Rep (PBftLedgerView c) x -&gt; PBftLedgerView c
forall c x. PBftLedgerView c -&gt; Rep (PBftLedgerView c) x
$cto :: forall c x. Rep (PBftLedgerView c) x -&gt; PBftLedgerView c
$cfrom :: forall c x. PBftLedgerView c -&gt; Rep (PBftLedgerView c) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="Ticked"><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier hs-var">Ticked</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span id="local-6989586621680037932"><span class="annot"><a href="#local-6989586621680037932"><span class="hs-identifier hs-type hs-type">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TickedPBftLedgerView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftLedgerView"><span class="hs-identifier hs-var">TickedPBftLedgerView</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-comment">-- | The updated delegates</span><span>
</span><span id="line-200"></span><span>      </span><span id="tickedPBftDelegates"><span class="annot"><span class="annottext">Ticked (PBftLedgerView c)
-&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#tickedPBftDelegates"><span class="hs-identifier hs-var hs-var">tickedPBftDelegates</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037932"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037932"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span id="local-6989586621680037923"><span id="local-6989586621680037925"><span id="local-6989586621680037927"><span id="local-6989586621680037929"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037929"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037929"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-comment">-- use generic instance</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span id="local-6989586621680037918"><span id="local-6989586621680037920"><span id="local-6989586621680037922"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037922"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037922"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-207"></span><span id="local-6989586621680037911"><span id="local-6989586621680037913"><span id="local-6989586621680037915"><span id="local-6989586621680037917"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037917"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037917"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span id="local-6989586621680037910"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037904"><span id="local-6989586621680037906"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Serialise</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037910"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037910"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Serialise</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037910"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-211"></span><span>  </span><span id="local-6989586621680037902"><span class="annot"><span class="annottext">encode :: PBftLedgerView c -&gt; Encoding
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">encode</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span id="local-6989586621680037900"><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037900"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PBftVerKeyHash c, PBftVerKeyHash c)] -&gt; Encoding
forall a. Serialise a =&gt; a -&gt; Encoding
</span><span class="hs-identifier hs-var">encode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
-&gt; [(PBftVerKeyHash c, PBftVerKeyHash c)]
forall a b. Bimap a b -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">Bimap.toList</span></span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037900"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span id="local-6989586621680037898"><span class="annot"><span class="annottext">decode :: Decoder s (PBftLedgerView c)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">decode</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c
forall c.
Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-var">PBftLedgerView</span></a></span><span> </span><span class="annot"><span class="annottext">(Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c)
-&gt; ([(PBftVerKeyHash c, PBftVerKeyHash c)]
    -&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c))
-&gt; [(PBftVerKeyHash c, PBftVerKeyHash c)]
-&gt; PBftLedgerView c
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(PBftVerKeyHash c, PBftVerKeyHash c)]
-&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Bimap a b
</span><span class="hs-identifier hs-var">Bimap.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(PBftVerKeyHash c, PBftVerKeyHash c)] -&gt; PBftLedgerView c)
-&gt; Decoder s [(PBftVerKeyHash c, PBftVerKeyHash c)]
-&gt; Decoder s (PBftLedgerView c)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Decoder s [(PBftVerKeyHash c, PBftVerKeyHash c)]
forall a s. Serialise a =&gt; Decoder s a
</span><span class="hs-identifier hs-var">decode</span></span></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Protocol proper
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- | Permissive BFT</span><span>
</span><span id="line-219"></span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- As defined in https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/byronChainSpec/latest/download-by-type/doc-pdf/blockchain-spec</span><span>
</span><span id="line-221"></span><span class="hs-keyword">data</span><span> </span><span id="PBft"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-var">PBft</span></a></span></span><span> </span><span id="local-6989586621680037893"><span class="annot"><a href="#local-6989586621680037893"><span class="hs-identifier hs-type">c</span></a></span></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- | Signature threshold. This represents the proportion of blocks in a</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- @pbftSignatureWindow@-sized window which may be signed by any single key.</span><span>
</span><span id="line-226"></span><span id="local-6989586621680037891"><span id="local-6989586621680037892"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="PBftSignatureThreshold"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSignatureThreshold"><span class="hs-identifier hs-var">PBftSignatureThreshold</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftSignatureThreshold"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSignatureThreshold"><span class="hs-identifier hs-var">PBftSignatureThreshold</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-227"></span><span>      </span><span id="getPBftSignatureThreshold"><span class="annot"><span class="annottext">PBftSignatureThreshold -&gt; Double
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#getPBftSignatureThreshold"><span class="hs-identifier hs-var hs-var">getPBftSignatureThreshold</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680037885"><span id="local-6989586621680037887"><span class="annot"><span class="annottext">PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool
(PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool)
-&gt; (PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool)
-&gt; Eq PBftSignatureThreshold
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool
$c/= :: PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool
== :: PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool
$c== :: PBftSignatureThreshold -&gt; PBftSignatureThreshold -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037879"><span id="local-6989586621680037881"><span id="local-6989586621680037883"><span class="annot"><span class="annottext">Int -&gt; PBftSignatureThreshold -&gt; ShowS
[PBftSignatureThreshold] -&gt; ShowS
PBftSignatureThreshold -&gt; String
(Int -&gt; PBftSignatureThreshold -&gt; ShowS)
-&gt; (PBftSignatureThreshold -&gt; String)
-&gt; ([PBftSignatureThreshold] -&gt; ShowS)
-&gt; Show PBftSignatureThreshold
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PBftSignatureThreshold] -&gt; ShowS
$cshowList :: [PBftSignatureThreshold] -&gt; ShowS
show :: PBftSignatureThreshold -&gt; String
$cshow :: PBftSignatureThreshold -&gt; String
showsPrec :: Int -&gt; PBftSignatureThreshold -&gt; ShowS
$cshowsPrec :: Int -&gt; PBftSignatureThreshold -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PBftSignatureThreshold -&gt; Rep PBftSignatureThreshold x)
-&gt; (forall x.
    Rep PBftSignatureThreshold x -&gt; PBftSignatureThreshold)
-&gt; Generic PBftSignatureThreshold
forall x. Rep PBftSignatureThreshold x -&gt; PBftSignatureThreshold
forall x. PBftSignatureThreshold -&gt; Rep PBftSignatureThreshold x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PBftSignatureThreshold x -&gt; PBftSignatureThreshold
$cfrom :: forall x. PBftSignatureThreshold -&gt; Rep PBftSignatureThreshold x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037871"><span id="local-6989586621680037873"><span id="local-6989586621680037875"><span class="annot"><span class="annottext">Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo)
Proxy PBftSignatureThreshold -&gt; String
(Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy PBftSignatureThreshold -&gt; String)
-&gt; NoThunks PBftSignatureThreshold
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy PBftSignatureThreshold -&gt; String
$cshowTypeOf :: Proxy PBftSignatureThreshold -&gt; String
wNoThunks :: Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: Context -&gt; PBftSignatureThreshold -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680037871"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-comment">-- | Protocol parameters</span><span>
</span><span id="line-232"></span><span id="local-6989586621680037869"><span id="local-6989586621680037870"></span></span><span class="hs-keyword">data</span><span> </span><span id="PBftParams"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftParams"><span class="hs-identifier hs-var">PBftParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftParams"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftParams"><span class="hs-identifier hs-var">PBftParams</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-comment">-- | Security parameter</span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-comment">-- Although the protocol proper does not have such a security parameter,</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-comment">-- we insist on it.</span><span>
</span><span id="line-237"></span><span>      </span><span id="pbftSecurityParam"><span class="annot"><span class="annottext">PBftParams -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSecurityParam"><span class="hs-identifier hs-var hs-var">pbftSecurityParam</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-comment">-- | Number of core nodes</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftNumNodes"><span class="annot"><span class="annottext">PBftParams -&gt; NumCoreNodes
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftNumNodes"><span class="hs-identifier hs-var hs-var">pbftNumNodes</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Node.ProtocolInfo.html#NumCoreNodes"><span class="hs-identifier hs-type">NumCoreNodes</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-comment">-- | Signature threshold</span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-comment">-- This bounds the proportion of the latest 'pbftSecurityParam'-many</span><span>
</span><span id="line-245"></span><span>      </span><span class="hs-comment">-- blocks which is allowed to be signed by any single key. The protocol</span><span>
</span><span id="line-246"></span><span>      </span><span class="hs-comment">-- proper is parameterized over the size of this window of recent blocks,</span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-comment">-- but this implementation follows the specification by fixing that</span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-comment">-- parameter to the ambient security parameter @k@.</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftSignatureThreshold"><span class="annot"><span class="annottext">PBftParams -&gt; PBftSignatureThreshold
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSignatureThreshold"><span class="hs-identifier hs-var hs-var">pbftSignatureThreshold</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSignatureThreshold"><span class="hs-identifier hs-type">PBftSignatureThreshold</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftParams -&gt; Rep PBftParams x)
-&gt; (forall x. Rep PBftParams x -&gt; PBftParams) -&gt; Generic PBftParams
forall x. Rep PBftParams x -&gt; PBftParams
forall x. PBftParams -&gt; Rep PBftParams x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PBftParams x -&gt; PBftParams
$cfrom :: forall x. PBftParams -&gt; Rep PBftParams x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037857"><span id="local-6989586621680037859"><span id="local-6989586621680037861"><span class="annot"><span class="annottext">Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo)
Proxy PBftParams -&gt; String
(Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy PBftParams -&gt; String)
-&gt; NoThunks PBftParams
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy PBftParams -&gt; String
$cshowTypeOf :: Proxy PBftParams -&gt; String
wNoThunks :: Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: Context -&gt; PBftParams -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680037857"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037851"><span id="local-6989586621680037853"><span id="local-6989586621680037855"><span class="annot"><span class="annottext">Int -&gt; PBftParams -&gt; ShowS
[PBftParams] -&gt; ShowS
PBftParams -&gt; String
(Int -&gt; PBftParams -&gt; ShowS)
-&gt; (PBftParams -&gt; String)
-&gt; ([PBftParams] -&gt; ShowS)
-&gt; Show PBftParams
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PBftParams] -&gt; ShowS
$cshowList :: [PBftParams] -&gt; ShowS
show :: PBftParams -&gt; String
$cshow :: PBftParams -&gt; String
showsPrec :: Int -&gt; PBftParams -&gt; ShowS
$cshowsPrec :: Int -&gt; PBftParams -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | If we are a core node (i.e. a block producing node) we know which core</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- node we are, and we have the operational key pair and delegation certificate.</span><span>
</span><span id="line-255"></span><span class="hs-comment">--</span><span>
</span><span id="line-256"></span><span id="local-6989586621680037849"><span id="local-6989586621680037850"></span></span><span class="hs-keyword">data</span><span> </span><span id="PBftCanBeLeader"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-var">PBftCanBeLeader</span></a></span></span><span> </span><span id="local-6989586621680038062"><span class="annot"><a href="#local-6989586621680038062"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftCanBeLeader"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-var">PBftCanBeLeader</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-257"></span><span>      </span><span id="pbftCanBeLeaderCoreNodeId"><span class="annot"><span class="annottext">PBftCanBeLeader c -&gt; CoreNodeId
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftCanBeLeaderCoreNodeId"><span class="hs-identifier hs-var hs-var">pbftCanBeLeaderCoreNodeId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.NodeId.html#CoreNodeId"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftCanBeLeaderSignKey"><span class="annot"><span class="annottext">PBftCanBeLeader c -&gt; SignKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftCanBeLeaderSignKey"><span class="hs-identifier hs-var hs-var">pbftCanBeLeaderSignKey</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SignKeyDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038062"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftCanBeLeaderDlgCert"><span class="annot"><span class="annottext">PBftCanBeLeader c -&gt; PBftDelegationCert c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftCanBeLeaderDlgCert"><span class="hs-identifier hs-var hs-var">pbftCanBeLeaderDlgCert</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDelegationCert"><span class="hs-identifier hs-type">PBftDelegationCert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038062"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftCanBeLeader c -&gt; Rep (PBftCanBeLeader c) x)
-&gt; (forall x. Rep (PBftCanBeLeader c) x -&gt; PBftCanBeLeader c)
-&gt; Generic (PBftCanBeLeader c)
forall x. Rep (PBftCanBeLeader c) x -&gt; PBftCanBeLeader c
forall x. PBftCanBeLeader c -&gt; Rep (PBftCanBeLeader c) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c x. Rep (PBftCanBeLeader c) x -&gt; PBftCanBeLeader c
forall c x. PBftCanBeLeader c -&gt; Rep (PBftCanBeLeader c) x
$cto :: forall c x. Rep (PBftCanBeLeader c) x -&gt; PBftCanBeLeader c
$cfrom :: forall c x. PBftCanBeLeader c -&gt; Rep (PBftCanBeLeader c) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621680037842"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037836"><span id="local-6989586621680037838"><span id="local-6989586621680037840"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037842"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-type">PBftCanBeLeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037842"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- | Information required to produce a block.</span><span>
</span><span id="line-266"></span><span id="local-6989586621680037834"><span id="local-6989586621680037835"></span></span><span class="hs-keyword">data</span><span> </span><span id="PBftIsLeader"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier hs-var">PBftIsLeader</span></a></span></span><span> </span><span id="local-6989586621680038123"><span class="annot"><a href="#local-6989586621680038123"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftIsLeader"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier hs-var">PBftIsLeader</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-267"></span><span>      </span><span id="pbftIsLeaderSignKey"><span class="annot"><span class="annottext">PBftIsLeader c -&gt; SignKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIsLeaderSignKey"><span class="hs-identifier hs-var hs-var">pbftIsLeaderSignKey</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SignKeyDSIGN</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDSIGN"><span class="hs-identifier hs-type">PBftDSIGN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038123"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pbftIsLeaderDlgCert"><span class="annot"><span class="annottext">PBftIsLeader c -&gt; PBftDelegationCert c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIsLeaderDlgCert"><span class="hs-identifier hs-var hs-var">pbftIsLeaderDlgCert</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftDelegationCert"><span class="hs-identifier hs-type">PBftDelegationCert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038123"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftIsLeader c -&gt; Rep (PBftIsLeader c) x)
-&gt; (forall x. Rep (PBftIsLeader c) x -&gt; PBftIsLeader c)
-&gt; Generic (PBftIsLeader c)
forall x. Rep (PBftIsLeader c) x -&gt; PBftIsLeader c
forall x. PBftIsLeader c -&gt; Rep (PBftIsLeader c) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c x. Rep (PBftIsLeader c) x -&gt; PBftIsLeader c
forall c x. PBftIsLeader c -&gt; Rep (PBftIsLeader c) x
$cto :: forall c x. Rep (PBftIsLeader c) x -&gt; PBftIsLeader c
$cfrom :: forall c x. PBftIsLeader c -&gt; Rep (PBftIsLeader c) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span id="local-6989586621680037831"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037825"><span id="local-6989586621680037827"><span id="local-6989586621680037829"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037831"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier hs-type">PBftIsLeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037831"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span class="hs-comment">-- | (Static) node configuration</span><span>
</span><span id="line-275"></span><span class="hs-keyword">newtype</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="ConsensusConfig"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-var">ConsensusConfig</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span id="local-6989586621680038126"><span class="annot"><a href="#local-6989586621680038126"><span class="hs-identifier hs-type hs-type">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftConfig"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftConfig"><span class="hs-identifier hs-var">PBftConfig</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-276"></span><span>      </span><span id="pbftParams"><span class="annot"><span class="annottext">ConsensusConfig (PBft c) -&gt; PBftParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftParams"><span class="hs-identifier hs-var hs-var">pbftParams</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftParams"><span class="hs-identifier hs-type">PBftParams</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 ConsensusConfig (PBft c) -&gt; Rep (ConsensusConfig (PBft c)) x)
-&gt; (forall x.
    Rep (ConsensusConfig (PBft c)) x -&gt; ConsensusConfig (PBft c))
-&gt; Generic (ConsensusConfig (PBft c))
forall x.
Rep (ConsensusConfig (PBft c)) x -&gt; ConsensusConfig (PBft c)
forall x.
ConsensusConfig (PBft c) -&gt; Rep (ConsensusConfig (PBft c)) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c x.
Rep (ConsensusConfig (PBft c)) x -&gt; ConsensusConfig (PBft c)
forall c x.
ConsensusConfig (PBft c) -&gt; Rep (ConsensusConfig (PBft c)) x
$cto :: forall c x.
Rep (ConsensusConfig (PBft c)) x -&gt; ConsensusConfig (PBft c)
$cfrom :: forall c x.
ConsensusConfig (PBft c) -&gt; Rep (ConsensusConfig (PBft c)) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037813"><span id="local-6989586621680037815"><span id="local-6989586621680037817"><span class="annot"><span class="annottext">Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo)
Proxy (ConsensusConfig (PBft c)) -&gt; String
(Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (ConsensusConfig (PBft c)) -&gt; String)
-&gt; NoThunks (ConsensusConfig (PBft c))
forall c.
Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo)
forall c. Proxy (ConsensusConfig (PBft c)) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy (ConsensusConfig (PBft c)) -&gt; String
$cshowTypeOf :: forall c. Proxy (ConsensusConfig (PBft c)) -&gt; String
wNoThunks :: Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall c.
Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall c.
Context -&gt; ConsensusConfig (PBft c) -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680037813"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- Ticking has no effect on the PBFtState, but we do need the ticked ledger view</span><span>
</span><span id="line-281"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="Ticked"><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier hs-var">Ticked</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span> </span><span id="local-6989586621680038122"><span class="annot"><a href="#local-6989586621680038122"><span class="hs-identifier hs-type hs-type">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TickedPBftState"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftState"><span class="hs-identifier hs-var">TickedPBftState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-282"></span><span>      </span><span id="tickedPBftLedgerView"><span class="annot"><span class="annottext">Ticked (PBftState c) -&gt; Ticked (LedgerView (PBft c))
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#tickedPBftLedgerView"><span class="hs-identifier hs-var hs-var">tickedPBftLedgerView</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier hs-type">Ticked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038122"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getTickedPBftState"><span class="annot"><span class="annottext">Ticked (PBftState c) -&gt; PBftState c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#getTickedPBftState"><span class="hs-identifier hs-var hs-var">getTickedPBftState</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038122"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span id="local-6989586621680037809"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="ValidationErr"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ValidationErr"><span class="hs-identifier hs-var">ValidationErr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidationErr"><span class="hs-identifier hs-type">PBftValidationErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="ValidateView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ValidateView"><span class="hs-identifier hs-var">ValidateView</span></a></span></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateView"><span class="hs-identifier hs-type">PBftValidateView</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="SelectView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#SelectView"><span class="hs-identifier hs-var">SelectView</span></a></span></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftSelectView"><span class="hs-identifier hs-type">PBftSelectView</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-comment">-- | We require two things from the ledger state:</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-comment">--   - Protocol parameters, for the signature window and threshold.</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-comment">--   - The delegation map.</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="LedgerView"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-var">LedgerView</span></a></span></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="IsLeader"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#IsLeader"><span class="hs-identifier hs-var">IsLeader</span></a></span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier hs-type">PBftIsLeader</span></a></span><span>    </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="ChainDepState"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ChainDepState"><span class="hs-identifier hs-var">ChainDepState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="CanBeLeader"><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#CanBeLeader"><span class="hs-identifier hs-var">CanBeLeader</span></a></span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-type">PBftCanBeLeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037809"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>  </span><span id="local-6989586621680037791"><span class="annot"><span class="annottext">protocolSecurityParam :: ConsensusConfig (PBft c) -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#protocolSecurityParam"><span class="hs-identifier hs-var hs-var hs-var hs-var">protocolSecurityParam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftParams -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftSecurityParam"><span class="hs-identifier hs-var hs-var">pbftSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">(PBftParams -&gt; SecurityParam)
-&gt; (ConsensusConfig (PBft c) -&gt; PBftParams)
-&gt; ConsensusConfig (PBft c)
-&gt; SecurityParam
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c) -&gt; PBftParams
forall c. ConsensusConfig (PBft c) -&gt; PBftParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftParams"><span class="hs-identifier hs-var hs-var">pbftParams</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>  </span><span id="local-6989586621680037789"><span class="annot"><span class="annottext">checkIsLeader :: ConsensusConfig (PBft c)
-&gt; CanBeLeader (PBft c)
-&gt; SlotNo
-&gt; Ticked (ChainDepState (PBft c))
-&gt; Maybe (IsLeader (PBft c))
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#checkIsLeader"><span class="hs-identifier hs-var hs-var hs-var hs-var">checkIsLeader</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftConfig"><span class="hs-identifier hs-type">PBftConfig</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037787"><span class="annot"><a href="#local-6989586621680037787"><span class="hs-identifier hs-var hs-var">pbftParams</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-303"></span><span>                </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-type">PBftCanBeLeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037784"><span id="local-6989586621680037785"><span id="local-6989586621680037786"><span class="annot"><a href="#local-6989586621680037784"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-304"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span id="local-6989586621680037782"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037782"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>                </span><span id="local-6989586621680037781"><span class="annot"><span class="annottext">Ticked (ChainDepState (PBft c))
</span><a href="#local-6989586621680037781"><span class="hs-identifier hs-var">_tickedChainDepState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-comment">-- We are the slot leader based on our node index, and the current</span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-comment">-- slot number. Our node index depends which genesis key has delegated</span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-comment">-- to us, see 'genesisKeyCoreNodeId'.</span><span>
</span><span id="line-309"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037782"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037779"><span class="hs-identifier hs-var">numCoreNodes</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037778"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-310"></span><span>        </span><span class="annot"><span class="annottext">PBftIsLeader c -&gt; Maybe (PBftIsLeader c)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PBftIsLeader :: forall c.
SignKeyDSIGN (PBftDSIGN c)
-&gt; PBftDelegationCert c -&gt; PBftIsLeader c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftIsLeader"><span class="hs-identifier hs-type">PBftIsLeader</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">pbftIsLeaderSignKey :: SignKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIsLeaderSignKey"><span class="hs-identifier hs-var">pbftIsLeaderSignKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SignKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037785"><span class="hs-identifier hs-var">pbftCanBeLeaderSignKey</span></a></span><span>
</span><span id="line-312"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pbftIsLeaderDlgCert :: PBftDelegationCert c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftIsLeaderDlgCert"><span class="hs-identifier hs-var">pbftIsLeaderDlgCert</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c
</span><a href="#local-6989586621680037784"><span class="hs-identifier hs-var">pbftCanBeLeaderDlgCert</span></a></span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">Maybe (IsLeader (PBft c))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftParams"><span class="hs-identifier hs-type">PBftParams</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">pbftNumNodes :: PBftParams -&gt; NumCoreNodes
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftNumNodes"><span class="hs-identifier hs-var">pbftNumNodes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Node.ProtocolInfo.html#NumCoreNodes"><span class="hs-identifier hs-type">NumCoreNodes</span></a></span><span> </span><span id="local-6989586621680037779"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037779"><span class="hs-identifier hs-var">numCoreNodes</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621680037787"><span class="hs-identifier hs-var">pbftParams</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.NodeId.html#CoreNodeId"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span> </span><span id="local-6989586621680037778"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037778"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621680037786"><span class="hs-identifier hs-var">pbftCanBeLeaderCoreNodeId</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621680037775"><span class="annot"><span class="annottext">tickChainDepState :: ConsensusConfig (PBft c)
-&gt; Ticked (LedgerView (PBft c))
-&gt; SlotNo
-&gt; ChainDepState (PBft c)
-&gt; Ticked (ChainDepState (PBft c))
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#tickChainDepState"><span class="hs-identifier hs-var hs-var hs-var hs-var">tickChainDepState</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680037773"><span class="annot"><span class="annottext">Ticked (LedgerView (PBft c))
</span><a href="#local-6989586621680037773"><span class="hs-identifier hs-var">lv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (PBft c)) -&gt; PBftState c -&gt; Ticked (PBftState c)
forall c.
Ticked (LedgerView (PBft c)) -&gt; PBftState c -&gt; Ticked (PBftState c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftState"><span class="hs-identifier hs-var">TickedPBftState</span></a></span><span> </span><span class="annot"><span class="annottext">Ticked (LedgerView (PBft c))
</span><a href="#local-6989586621680037773"><span class="hs-identifier hs-var">lv</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>  </span><span id="local-6989586621680037772"><span class="annot"><span class="annottext">updateChainDepState :: ConsensusConfig (PBft c)
-&gt; ValidateView (PBft c)
-&gt; SlotNo
-&gt; Ticked (ChainDepState (PBft c))
-&gt; Except (ValidationErr (PBft c)) (ChainDepState (PBft c))
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#updateChainDepState"><span class="hs-identifier hs-var hs-var hs-var hs-var">updateChainDepState</span></a></span></span><span> </span><span id="local-6989586621680037770"><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037770"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-323"></span><span>                      </span><span id="local-6989586621680037769"><span class="annot"><span class="annottext">ValidateView (PBft c)
</span><a href="#local-6989586621680037769"><span class="hs-identifier hs-var">toValidate</span></a></span></span><span>
</span><span id="line-324"></span><span>                      </span><span id="local-6989586621680037768"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037768"><span class="hs-identifier hs-var">slot</span></a></span></span><span>
</span><span id="line-325"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftState"><span class="hs-identifier hs-type">TickedPBftState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftLedgerView"><span class="hs-identifier hs-type">TickedPBftLedgerView</span></a></span><span> </span><span id="local-6989586621680037767"><span class="annot"><a href="#local-6989586621680037767"><span class="hs-identifier hs-var">dms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680037766"><span class="annot"><a href="#local-6989586621680037766"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-326"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ValidateView (PBft c)
</span><a href="#local-6989586621680037769"><span class="hs-identifier hs-var">toValidate</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><span class="annottext">ValidateView (PBft c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateBoundary"><span class="hs-identifier hs-var">PBftValidateBoundary</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><span class="annottext">PBftState c -&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037766"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateRegular"><span class="hs-identifier hs-type">PBftValidateRegular</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037763"><span id="local-6989586621680037764"><span id="local-6989586621680037765"><span class="annot"><a href="#local-6989586621680037763"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680037762"><span class="annot"><a href="#local-6989586621680037762"><span class="hs-identifier hs-var">signed</span></a></span></span><span> </span><span id="local-6989586621680037761"><span class="annot"><a href="#local-6989586621680037761"><span class="hs-identifier hs-var">contextDSIGN</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-330"></span><span>          </span><span class="hs-comment">-- Check that the issuer signature verifies, and that it's a delegate of a</span><span>
</span><span id="line-331"></span><span>          </span><span class="hs-comment">-- genesis key, and that genesis key hasn't voted too many times.</span><span>
</span><span id="line-332"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ContextDSIGN (PBftDSIGN c)
-&gt; VerKeyDSIGN (PBftDSIGN c)
-&gt; signed
-&gt; SignedDSIGN (PBftDSIGN c) signed
-&gt; Either String ()
forall v a.
(DSIGNAlgorithm v, Signable v a, ?callStack::CallStack) =&gt;
ContextDSIGN v
-&gt; VerKeyDSIGN v -&gt; a -&gt; SignedDSIGN v a -&gt; Either String ()
</span><span class="hs-identifier hs-var">verifySignedDSIGN</span></span><span>
</span><span id="line-333"></span><span>                 </span><span class="annot"><span class="annottext">ContextDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037761"><span class="hs-identifier hs-var">contextDSIGN</span></a></span><span>
</span><span id="line-334"></span><span>                 </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037765"><span class="hs-identifier hs-var">pbftIssuer</span></a></span><span>
</span><span id="line-335"></span><span>                 </span><span class="annot"><span class="annottext">signed
</span><a href="#local-6989586621680037762"><span class="hs-identifier hs-var">signed</span></a></span><span>
</span><span id="line-336"></span><span>                 </span><span class="annot"><span class="annottext">SignedDSIGN (PBftDSIGN c) signed
</span><a href="#local-6989586621680037763"><span class="hs-identifier hs-var">pbftSignature</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-337"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT (PBftValidationErr c) Identity ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680037759"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680037759"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PBftValidationErr c -&gt; ExceptT (PBftValidationErr c) Identity ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(PBftValidationErr c -&gt; ExceptT (PBftValidationErr c) Identity ())
-&gt; PBftValidationErr c -&gt; ExceptT (PBftValidationErr c) Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PBftValidationErr c
forall c. Text -&gt; PBftValidationErr c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftInvalidSignature"><span class="hs-identifier hs-var">PBftInvalidSignature</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680037759"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>          </span><span class="hs-comment">-- FIXME confirm that non-strict inequality is ok in general.</span><span>
</span><span id="line-341"></span><span>          </span><span class="hs-comment">-- It's here because EBBs have the same slot as the first block of their</span><span>
</span><span id="line-342"></span><span>          </span><span class="hs-comment">-- epoch.</span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT (PBftValidationErr c) Identity ()
-&gt; ExceptT (PBftValidationErr c) Identity ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; WithOrigin SlotNo
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037768"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo -&gt; WithOrigin SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">PBftState c -&gt; WithOrigin SlotNo
forall c. PBftState c -&gt; WithOrigin SlotNo
</span><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#lastSignedSlot"><span class="hs-identifier hs-var">S.lastSignedSlot</span></a></span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037766"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>            </span><span class="annot"><span class="annottext">(ExceptT (PBftValidationErr c) Identity ()
 -&gt; ExceptT (PBftValidationErr c) Identity ())
-&gt; ExceptT (PBftValidationErr c) Identity ()
-&gt; ExceptT (PBftValidationErr c) Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftValidationErr c -&gt; ExceptT (PBftValidationErr c) Identity ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">PBftValidationErr c
forall c. PBftValidationErr c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftInvalidSlot"><span class="hs-identifier hs-var">PBftInvalidSlot</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
-&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
-&gt; Maybe (PBftVerKeyHash c)
forall a b (m :: * -&gt; *).
(Ord a, Ord b, MonadThrow m) =&gt;
b -&gt; Bimap a b -&gt; m a
</span><span class="hs-identifier hs-var">Bimap.lookupR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
forall c.
PBftCrypto c =&gt;
VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#hashVerKey"><span class="hs-identifier hs-var">hashVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037765"><span class="hs-identifier hs-var">pbftIssuer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037767"><span class="hs-identifier hs-var">dms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-347"></span><span>            </span><span class="annot"><span class="annottext">Maybe (PBftVerKeyHash c)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>              </span><span class="annot"><span class="annottext">PBftValidationErr c
-&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(PBftValidationErr c
 -&gt; ExceptT (PBftValidationErr c) Identity (PBftState c))
-&gt; PBftValidationErr c
-&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c -&gt; PBftLedgerView c -&gt; PBftValidationErr c
forall c.
PBftVerKeyHash c -&gt; PBftLedgerView c -&gt; PBftValidationErr c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftNotGenesisDelegate"><span class="hs-identifier hs-var">PBftNotGenesisDelegate</span></a></span><span>
</span><span id="line-349"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
forall c.
PBftCrypto c =&gt;
VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#hashVerKey"><span class="hs-identifier hs-var">hashVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037765"><span class="hs-identifier hs-var">pbftIssuer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c
forall c.
Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-var">PBftLedgerView</span></a></span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037767"><span class="hs-identifier hs-var">dms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680037748"><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037748"><span class="hs-identifier hs-var">gk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680037747"><span class="annot"><span class="annottext">state' :: PBftState c
</span><a href="#local-6989586621680037747"><span class="hs-identifier hs-var hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
forall c.
PBftCrypto c =&gt;
ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#append"><span class="hs-identifier hs-var">append</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037770"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
</span><a href="#local-6989586621680037745"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037768"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037748"><span class="hs-identifier hs-var">gk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037766"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-353"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
forall c.
PBftCrypto c =&gt;
PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowExceedsThreshold"><span class="hs-identifier hs-var">pbftWindowExceedsThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
</span><a href="#local-6989586621680037745"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037747"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037748"><span class="hs-identifier hs-var">gk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-354"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680037744"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037744"><span class="hs-identifier hs-var">n</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PBftValidationErr c
-&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(PBftValidationErr c
 -&gt; ExceptT (PBftValidationErr c) Identity (PBftState c))
-&gt; PBftValidationErr c
-&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c -&gt; Word64 -&gt; PBftValidationErr c
forall c. PBftVerKeyHash c -&gt; Word64 -&gt; PBftValidationErr c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftExceededSignThreshold"><span class="hs-identifier hs-var">PBftExceededSignThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037748"><span class="hs-identifier hs-var">gk</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037744"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-355"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PBftState c -&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PBftState c
 -&gt; ExceptT (PBftValidationErr c) Identity (PBftState c))
-&gt; PBftState c
-&gt; ExceptT (PBftValidationErr c) Identity (PBftState c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037747"><span class="hs-identifier hs-var">state'</span></a></span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-357"></span><span>      </span><span id="local-6989586621680037745"><span class="annot"><span class="annottext">params :: PBftWindowParams
</span><a href="#local-6989586621680037745"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c) -&gt; PBftWindowParams
forall c. ConsensusConfig (PBft c) -&gt; PBftWindowParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowParams"><span class="hs-identifier hs-var">pbftWindowParams</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037770"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span>  </span><span id="local-6989586621680037740"><span class="annot"><span class="annottext">reupdateChainDepState :: ConsensusConfig (PBft c)
-&gt; ValidateView (PBft c)
-&gt; SlotNo
-&gt; Ticked (ChainDepState (PBft c))
-&gt; ChainDepState (PBft c)
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#reupdateChainDepState"><span class="hs-identifier hs-var hs-var hs-var hs-var">reupdateChainDepState</span></a></span></span><span> </span><span id="local-6989586621680037738"><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037738"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-360"></span><span>                        </span><span id="local-6989586621680037737"><span class="annot"><span class="annottext">ValidateView (PBft c)
</span><a href="#local-6989586621680037737"><span class="hs-identifier hs-var">toValidate</span></a></span></span><span>
</span><span id="line-361"></span><span>                        </span><span id="local-6989586621680037736"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037736"><span class="hs-identifier hs-var">slot</span></a></span></span><span>
</span><span id="line-362"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftState"><span class="hs-identifier hs-type">TickedPBftState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftLedgerView"><span class="hs-identifier hs-type">TickedPBftLedgerView</span></a></span><span> </span><span id="local-6989586621680037735"><span class="annot"><a href="#local-6989586621680037735"><span class="hs-identifier hs-var">dms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680037734"><span class="annot"><a href="#local-6989586621680037734"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ValidateView (PBft c)
</span><a href="#local-6989586621680037737"><span class="hs-identifier hs-var">toValidate</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">ValidateView (PBft c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateBoundary"><span class="hs-identifier hs-var">PBftValidateBoundary</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainDepState (PBft c)
PBftState c
</span><a href="#local-6989586621680037734"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidateRegular"><span class="hs-identifier hs-type">PBftValidateRegular</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037733"><span class="annot"><a href="#local-6989586621680037733"><span class="hs-identifier hs-var hs-var">pbftIssuer</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
-&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
-&gt; Maybe (PBftVerKeyHash c)
forall a b (m :: * -&gt; *).
(Ord a, Ord b, MonadThrow m) =&gt;
b -&gt; Bimap a b -&gt; m a
</span><span class="hs-identifier hs-var">Bimap.lookupR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
forall c.
PBftCrypto c =&gt;
VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#hashVerKey"><span class="hs-identifier hs-var">hashVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037733"><span class="hs-identifier hs-var">pbftIssuer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037735"><span class="hs-identifier hs-var">dms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-367"></span><span>            </span><span class="annot"><span class="annottext">Maybe (PBftVerKeyHash c)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; PBftState c
forall a. (?callStack::CallStack) =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PBftState c) -&gt; String -&gt; PBftState c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftValidationErr c -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(PBftValidationErr c -&gt; String) -&gt; PBftValidationErr c -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c -&gt; PBftLedgerView c -&gt; PBftValidationErr c
forall c.
PBftVerKeyHash c -&gt; PBftLedgerView c -&gt; PBftValidationErr c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftNotGenesisDelegate"><span class="hs-identifier hs-var">PBftNotGenesisDelegate</span></a></span><span>
</span><span id="line-369"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
forall c.
PBftCrypto c =&gt;
VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#hashVerKey"><span class="hs-identifier hs-var">hashVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037733"><span class="hs-identifier hs-var">pbftIssuer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c
forall c.
Bimap (PBftVerKeyHash c) (PBftVerKeyHash c) -&gt; PBftLedgerView c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-var">PBftLedgerView</span></a></span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037735"><span class="hs-identifier hs-var">dms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680037730"><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037730"><span class="hs-identifier hs-var">gk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680037729"><span class="annot"><span class="annottext">state' :: PBftState c
</span><a href="#local-6989586621680037729"><span class="hs-identifier hs-var hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
forall c.
PBftCrypto c =&gt;
ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#append"><span class="hs-identifier hs-var">append</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037738"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
</span><a href="#local-6989586621680037728"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037736"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037730"><span class="hs-identifier hs-var">gk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037734"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-373"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
forall c.
PBftCrypto c =&gt;
PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowExceedsThreshold"><span class="hs-identifier hs-var">pbftWindowExceedsThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
</span><a href="#local-6989586621680037728"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037729"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037730"><span class="hs-identifier hs-var">gk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-374"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680037727"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037727"><span class="hs-identifier hs-var">n</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; PBftState c
forall a. (?callStack::CallStack) =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PBftState c) -&gt; String -&gt; PBftState c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftValidationErr c -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(PBftValidationErr c -&gt; String) -&gt; PBftValidationErr c -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c -&gt; Word64 -&gt; PBftValidationErr c
forall c. PBftVerKeyHash c -&gt; Word64 -&gt; PBftValidationErr c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftExceededSignThreshold"><span class="hs-identifier hs-var">PBftExceededSignThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037730"><span class="hs-identifier hs-var">gk</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037727"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-375"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainDepState (PBft c)
PBftState c
</span><a href="#local-6989586621680037729"><span class="hs-identifier hs-var">state'</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-377"></span><span>      </span><span id="local-6989586621680037728"><span class="annot"><span class="annottext">params :: PBftWindowParams
</span><a href="#local-6989586621680037728"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c) -&gt; PBftWindowParams
forall c. ConsensusConfig (PBft c) -&gt; PBftWindowParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowParams"><span class="hs-identifier hs-var">pbftWindowParams</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037738"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: thin wrapper on top of 'PBftState'
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="hs-comment">-- | Parameters for the window check</span><span>
</span><span id="line-384"></span><span class="hs-keyword">data</span><span> </span><span id="PBftWindowParams"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-var">PBftWindowParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PBftWindowParams"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-var">PBftWindowParams</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-comment">-- | Window size</span><span>
</span><span id="line-386"></span><span>      </span><span id="windowSize"><span class="annot"><span class="annottext">PBftWindowParams -&gt; WindowSize
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#windowSize"><span class="hs-identifier hs-var hs-var">windowSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#WindowSize"><span class="hs-identifier hs-type">S.WindowSize</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span>      </span><span class="hs-comment">-- | Threshold (maximum number of slots anyone is allowed to sign)</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="threshold"><span class="annot"><span class="annottext">PBftWindowParams -&gt; Word64
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#threshold"><span class="hs-identifier hs-var hs-var">threshold</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="hs-comment">-- | Compute window check parameters from the node config</span><span>
</span><span id="line-393"></span><span id="local-6989586621680038096"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowParams"><span class="hs-identifier hs-type">pbftWindowParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038096"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-type">PBftWindowParams</span></a></span></span><span>
</span><span id="line-394"></span><span id="pbftWindowParams"><span class="annot"><span class="annottext">pbftWindowParams :: ConsensusConfig (PBft c) -&gt; PBftWindowParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowParams"><span class="hs-identifier hs-var hs-var">pbftWindowParams</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftConfig"><span class="hs-identifier hs-type">PBftConfig</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037723"><span class="annot"><a href="#local-6989586621680037723"><span class="hs-glyph hs-var hs-var">..</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftWindowParams :: WindowSize -&gt; Word64 -&gt; PBftWindowParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-type">PBftWindowParams</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-395"></span><span>      </span><span class="annot"><span class="annottext">windowSize :: WindowSize
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#windowSize"><span class="hs-identifier hs-var">windowSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WindowSize
</span><a href="#local-6989586621680037722"><span class="hs-identifier hs-var">winSize</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">threshold :: Word64
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#threshold"><span class="hs-identifier hs-var">threshold</span></a></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>        </span><span class="annot"><span class="annottext">Double -&gt; Word64
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">floor</span></span><span> </span><span class="annot"><span class="annottext">(Double -&gt; Word64) -&gt; Double -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-398"></span><span>          </span><span class="annot"><span class="annottext">PBftSignatureThreshold -&gt; Double
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#getPBftSignatureThreshold"><span class="hs-identifier hs-var hs-var">getPBftSignatureThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">PBftSignatureThreshold
</span><a href="#local-6989586621680037720"><span class="hs-identifier hs-var">pbftSignatureThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">WindowSize -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">WindowSize
</span><a href="#local-6989586621680037722"><span class="hs-identifier hs-var">winSize</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-401"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftParams"><span class="hs-identifier hs-type">PBftParams</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037717"><span id="local-6989586621680037718"><span id="local-6989586621680037720"><span class="annot"><span class="annottext">SecurityParam
NumCoreNodes
PBftSignatureThreshold
pbftNumNodes :: NumCoreNodes
pbftSecurityParam :: SecurityParam
pbftSignatureThreshold :: PBftSignatureThreshold
pbftSignatureThreshold :: PBftParams -&gt; PBftSignatureThreshold
pbftNumNodes :: PBftParams -&gt; NumCoreNodes
pbftSecurityParam :: PBftParams -&gt; SecurityParam
</span><a href="#local-6989586621680037717"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftParams
</span><a href="#local-6989586621680037723"><span class="hs-identifier hs-var">pbftParams</span></a></span><span>
</span><span id="line-402"></span><span>    </span><span id="local-6989586621680037722"><span class="annot"><span class="annottext">winSize :: WindowSize
</span><a href="#local-6989586621680037722"><span class="hs-identifier hs-var hs-var">winSize</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; WindowSize
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowSize"><span class="hs-identifier hs-var">pbftWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621680037718"><span class="hs-identifier hs-var">pbftSecurityParam</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="hs-comment">-- | Window size used by PBFT</span><span>
</span><span id="line-405"></span><span class="hs-comment">--</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- We set the window size to be equal to k.</span><span>
</span><span id="line-407"></span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowSize"><span class="hs-identifier hs-type">pbftWindowSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#WindowSize"><span class="hs-identifier hs-type">S.WindowSize</span></a></span><span>
</span><span id="line-408"></span><span id="pbftWindowSize"><span class="annot"><span class="annottext">pbftWindowSize :: SecurityParam -&gt; WindowSize
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowSize"><span class="hs-identifier hs-var hs-var">pbftWindowSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621680037715"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037715"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; WindowSize
</span><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#WindowSize"><span class="hs-identifier hs-var">S.WindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037715"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">-- | Does the number of blocks signed by this key exceed the threshold?</span><span>
</span><span id="line-411"></span><span class="hs-comment">--</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- Returns @Just@ the number of blocks signed if exceeded.</span><span>
</span><span id="line-413"></span><span id="local-6989586621680038097"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowExceedsThreshold"><span class="hs-identifier hs-type">pbftWindowExceedsThreshold</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-414"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038097"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-type">PBftWindowParams</span></a></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038097"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038097"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-419"></span><span id="pbftWindowExceedsThreshold"><span class="annot"><span class="annottext">pbftWindowExceedsThreshold :: PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowExceedsThreshold"><span class="hs-identifier hs-var hs-var">pbftWindowExceedsThreshold</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-type">PBftWindowParams</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037712"><span id="local-6989586621680037713"><span class="annot"><span class="annottext">Word64
WindowSize
threshold :: Word64
windowSize :: WindowSize
threshold :: PBftWindowParams -&gt; Word64
windowSize :: PBftWindowParams -&gt; WindowSize
</span><a href="#local-6989586621680037712"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680037711"><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037711"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621680037710"><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037710"><span class="hs-identifier hs-var">gk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037709"><span class="hs-identifier hs-var">numSigned</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037712"><span class="hs-identifier hs-var">threshold</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Either Word64 ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680037709"><span class="hs-identifier hs-var">numSigned</span></a></span><span>
</span><span id="line-422"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Word64 ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621680037709"><span class="annot"><span class="annottext">numSigned :: Word64
</span><a href="#local-6989586621680037709"><span class="hs-identifier hs-var hs-var">numSigned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PBftState c -&gt; PBftVerKeyHash c -&gt; Word64
forall c. PBftCrypto c =&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Word64
</span><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#countSignedBy"><span class="hs-identifier hs-var">S.countSignedBy</span></a></span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037711"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037710"><span class="hs-identifier hs-var">gk</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span id="local-6989586621680038098"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#append"><span class="hs-identifier hs-type">append</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038098"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-427"></span><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038098"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-type">PBftWindowParams</span></a></span><span>
</span><span id="line-429"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038098"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038098"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038098"><span class="hs-identifier hs-type">c</span></a></span></span><span>
</span><span id="line-431"></span><span id="append"><span class="annot"><span class="annottext">append :: ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#append"><span class="hs-identifier hs-var hs-var">append</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftConfig"><span class="hs-identifier hs-type">PBftConfig</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftWindowParams"><span class="hs-identifier hs-type">PBftWindowParams</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037705"><span id="local-6989586621680037706"><span class="annot"><span class="annottext">Word64
WindowSize
threshold :: Word64
windowSize :: WindowSize
threshold :: PBftWindowParams -&gt; Word64
windowSize :: PBftWindowParams -&gt; WindowSize
</span><a href="#local-6989586621680037705"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-432"></span><span>    </span><span class="annot"><span class="annottext">WindowSize -&gt; PBftSigner c -&gt; PBftState c -&gt; PBftState c
forall c.
PBftCrypto c =&gt;
WindowSize -&gt; PBftSigner c -&gt; PBftState c -&gt; PBftState c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#append"><span class="hs-identifier hs-var">S.append</span></a></span><span> </span><span class="annot"><span class="annottext">WindowSize
</span><a href="#local-6989586621680037706"><span class="hs-identifier hs-var">windowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(PBftSigner c -&gt; PBftState c -&gt; PBftState c)
-&gt; ((SlotNo, PBftVerKeyHash c) -&gt; PBftSigner c)
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; PBftVerKeyHash c -&gt; PBftSigner c)
-&gt; (SlotNo, PBftVerKeyHash c) -&gt; PBftSigner c
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; PBftVerKeyHash c -&gt; PBftSigner c
forall c. SlotNo -&gt; PBftVerKeyHash c -&gt; PBftSigner c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftSigner"><span class="hs-identifier hs-var">S.PBftSigner</span></a></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  PBFT specific types
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">-- | NOTE: this type is stored in the state, so it must be in normal form to</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- avoid space leaks.</span><span>
</span><span id="line-440"></span><span id="local-6989586621680037700"><span id="local-6989586621680037701"></span></span><span class="hs-keyword">data</span><span> </span><span id="PBftValidationErr"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidationErr"><span class="hs-identifier hs-var">PBftValidationErr</span></a></span></span><span> </span><span id="local-6989586621680038108"><span class="annot"><a href="#local-6989586621680038108"><span class="hs-identifier hs-type">c</span></a></span></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="PBftInvalidSignature"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftInvalidSignature"><span class="hs-identifier hs-var">PBftInvalidSignature</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PBftNotGenesisDelegate"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftNotGenesisDelegate"><span class="hs-identifier hs-var">PBftNotGenesisDelegate</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038108"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftLedgerView"><span class="hs-identifier hs-type">PBftLedgerView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038108"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>  </span><span class="hs-comment">-- | We record how many slots this key signed</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PBftExceededSignThreshold"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftExceededSignThreshold"><span class="hs-identifier hs-var">PBftExceededSignThreshold</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038108"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PBftInvalidSlot"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftInvalidSlot"><span class="hs-identifier hs-var">PBftInvalidSlot</span></a></span></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftValidationErr c -&gt; Rep (PBftValidationErr c) x)
-&gt; (forall x. Rep (PBftValidationErr c) x -&gt; PBftValidationErr c)
-&gt; Generic (PBftValidationErr c)
forall x. Rep (PBftValidationErr c) x -&gt; PBftValidationErr c
forall x. PBftValidationErr c -&gt; Rep (PBftValidationErr c) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c x. Rep (PBftValidationErr c) x -&gt; PBftValidationErr c
forall c x. PBftValidationErr c -&gt; Rep (PBftValidationErr c) x
$cto :: forall c x. Rep (PBftValidationErr c) x -&gt; PBftValidationErr c
$cfrom :: forall c x. PBftValidationErr c -&gt; Rep (PBftValidationErr c) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680037692"><span id="local-6989586621680037694"><span id="local-6989586621680037696"><span class="annot"><span class="annottext">Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo)
Proxy (PBftValidationErr c) -&gt; String
(Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (PBftValidationErr c) -&gt; String)
-&gt; NoThunks (PBftValidationErr c)
forall c.
PBftCrypto c =&gt;
Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo)
forall c. PBftCrypto c =&gt; Proxy (PBftValidationErr c) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy (PBftValidationErr c) -&gt; String
$cshowTypeOf :: forall c. PBftCrypto c =&gt; Proxy (PBftValidationErr c) -&gt; String
wNoThunks :: Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall c.
PBftCrypto c =&gt;
Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall c.
PBftCrypto c =&gt;
Context -&gt; PBftValidationErr c -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621680037692"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span id="local-6989586621680037685"><span id="local-6989586621680037687"><span id="local-6989586621680037689"><span id="local-6989586621680037691"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037691"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidationErr"><span class="hs-identifier hs-type">PBftValidationErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037691"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-449"></span><span id="local-6989586621680037680"><span id="local-6989586621680037682"><span id="local-6989586621680037684"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037684"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftValidationErr"><span class="hs-identifier hs-type">PBftValidationErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037684"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  CannotForge
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="hs-comment">-- | Expresses that, whilst we believe ourselves to be a leader for this slot,</span><span>
</span><span id="line-456"></span><span class="hs-comment">-- we are nonetheless unable to forge a block.</span><span>
</span><span id="line-457"></span><span id="local-6989586621680037678"><span id="local-6989586621680037679"></span></span><span class="hs-keyword">data</span><span> </span><span id="PBftCannotForge"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForge"><span class="hs-identifier hs-var">PBftCannotForge</span></a></span></span><span> </span><span id="local-6989586621680038061"><span class="annot"><a href="#local-6989586621680038061"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-comment">-- | We cannot forge a block because we are not the current delegate of the</span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-comment">-- genesis key we have a delegation certificate from.</span><span>
</span><span id="line-460"></span><span>    </span><span id="PBftCannotForgeInvalidDelegation"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForgeInvalidDelegation"><span class="hs-identifier hs-var">PBftCannotForgeInvalidDelegation</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680038061"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-comment">-- | We cannot lead because delegates of the genesis key we have a</span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">-- delegation from have already forged the maximum number of blocks in this</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-comment">-- signing window.</span><span>
</span><span id="line-464"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PBftCannotForgeThresholdExceeded"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForgeThresholdExceeded"><span class="hs-identifier hs-var">PBftCannotForgeThresholdExceeded</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. PBftCannotForge c -&gt; Rep (PBftCannotForge c) x)
-&gt; (forall x. Rep (PBftCannotForge c) x -&gt; PBftCannotForge c)
-&gt; Generic (PBftCannotForge c)
forall x. Rep (PBftCannotForge c) x -&gt; PBftCannotForge c
forall x. PBftCannotForge c -&gt; Rep (PBftCannotForge c) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall c x. Rep (PBftCannotForge c) x -&gt; PBftCannotForge c
forall c x. PBftCannotForge c -&gt; Rep (PBftCannotForge c) x
$cto :: forall c x. Rep (PBftCannotForge c) x -&gt; PBftCannotForge c
$cfrom :: forall c x. PBftCannotForge c -&gt; Rep (PBftCannotForge c) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span id="local-6989586621680037667"><span id="local-6989586621680037669"><span id="local-6989586621680037671"><span id="local-6989586621680037673"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037673"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForge"><span class="hs-identifier hs-type">PBftCannotForge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037673"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span id="local-6989586621680037666"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680037660"><span id="local-6989586621680037662"><span id="local-6989586621680037664"><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037666"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForge"><span class="hs-identifier hs-type">PBftCannotForge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037666"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-470"></span><span> </span><span class="hs-comment">-- use generic instance</span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftCheckCanForge"><span class="hs-identifier hs-type">pbftCheckCanForge</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-473"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680037659"><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-474"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBft"><span class="hs-identifier hs-type">PBft</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-type">PBftCanBeLeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ticked.html#Ticked"><span class="hs-identifier hs-type">Ticked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.State.html#PBftState"><span class="hs-identifier hs-type">PBftState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForge"><span class="hs-identifier hs-type">PBftCannotForge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span id="pbftCheckCanForge"><span class="annot"><span class="annottext">pbftCheckCanForge :: ConsensusConfig (PBft c)
-&gt; PBftCanBeLeader c
-&gt; SlotNo
-&gt; Ticked (PBftState c)
-&gt; Either (PBftCannotForge c) ()
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftCheckCanForge"><span class="hs-identifier hs-var hs-var">pbftCheckCanForge</span></a></span></span><span> </span><span id="local-6989586621680037658"><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037658"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCanBeLeader"><span class="hs-identifier hs-type">PBftCanBeLeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037655"><span id="local-6989586621680037656"><span id="local-6989586621680037657"><span class="annot"><span class="annottext">SignKeyDSIGN (PBftDSIGN c)
PBftDelegationCert c
CoreNodeId
pbftCanBeLeaderDlgCert :: PBftDelegationCert c
pbftCanBeLeaderSignKey :: SignKeyDSIGN (PBftDSIGN c)
pbftCanBeLeaderCoreNodeId :: CoreNodeId
pbftCanBeLeaderDlgCert :: forall c. PBftCanBeLeader c -&gt; PBftDelegationCert c
pbftCanBeLeaderSignKey :: forall c. PBftCanBeLeader c -&gt; SignKeyDSIGN (PBftDSIGN c)
pbftCanBeLeaderCoreNodeId :: forall c. PBftCanBeLeader c -&gt; CoreNodeId
</span><a href="#local-6989586621680037655"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680037654"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037654"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621680037653"><span class="annot"><span class="annottext">Ticked (PBftState c)
</span><a href="#local-6989586621680037653"><span class="hs-identifier hs-var">tickedChainDepState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
-&gt; Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
-&gt; Maybe (PBftVerKeyHash c)
forall a b (m :: * -&gt; *).
(Ord a, Ord b, MonadThrow m) =&gt;
b -&gt; Bimap a b -&gt; m a
</span><span class="hs-identifier hs-var">Bimap.lookupR</span></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037652"><span class="hs-identifier hs-var">dlgKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">Bimap (PBftVerKeyHash c) (PBftVerKeyHash c)
</span><a href="#local-6989586621680037651"><span class="hs-identifier hs-var">dms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-481"></span><span>      </span><span class="annot"><span class="annottext">Maybe (PBftVerKeyHash c)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PBftCannotForge c -&gt; Either (PBftCannotForge c) ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(PBftCannotForge c -&gt; Either (PBftCannotForge c) ())
-&gt; PBftCannotForge c -&gt; Either (PBftCannotForge c) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c -&gt; PBftCannotForge c
forall c. PBftVerKeyHash c -&gt; PBftCannotForge c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForgeInvalidDelegation"><span class="hs-identifier hs-var">PBftCannotForgeInvalidDelegation</span></a></span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037652"><span class="hs-identifier hs-var">dlgKeyHash</span></a></span><span>
</span><span id="line-482"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680037650"><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037650"><span class="hs-identifier hs-var">gk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><span class="annottext">(Word64 -&gt; PBftCannotForge c)
-&gt; Either Word64 () -&gt; Either (PBftCannotForge c) ()
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; PBftCannotForge c
forall c. Word64 -&gt; PBftCannotForge c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftCannotForgeThresholdExceeded"><span class="hs-identifier hs-var">PBftCannotForgeThresholdExceeded</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Word64 () -&gt; Either (PBftCannotForge c) ())
-&gt; Either Word64 () -&gt; Either (PBftCannotForge c) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-484"></span><span>          </span><span class="annot"><span class="annottext">PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
forall c.
PBftCrypto c =&gt;
PBftWindowParams
-&gt; PBftState c -&gt; PBftVerKeyHash c -&gt; Either Word64 ()
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowExceedsThreshold"><span class="hs-identifier hs-var">pbftWindowExceedsThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
</span><a href="#local-6989586621680037649"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
forall c.
PBftCrypto c =&gt;
ConsensusConfig (PBft c)
-&gt; PBftWindowParams
-&gt; (SlotNo, PBftVerKeyHash c)
-&gt; PBftState c
-&gt; PBftState c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#append"><span class="hs-identifier hs-var">append</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037658"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">PBftWindowParams
</span><a href="#local-6989586621680037649"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680037654"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037650"><span class="hs-identifier hs-var">gk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PBftState c
</span><a href="#local-6989586621680037648"><span class="hs-identifier hs-var">cds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PBftVerKeyHash c
</span><a href="#local-6989586621680037650"><span class="hs-identifier hs-var">gk</span></a></span><span>
</span><span id="line-485"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-486"></span><span>    </span><span id="local-6989586621680037649"><span class="annot"><span class="annottext">params :: PBftWindowParams
</span><a href="#local-6989586621680037649"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c) -&gt; PBftWindowParams
forall c. ConsensusConfig (PBft c) -&gt; PBftWindowParams
</span><a href="Ouroboros.Consensus.Protocol.PBFT.html#pbftWindowParams"><span class="hs-identifier hs-var">pbftWindowParams</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (PBft c)
</span><a href="#local-6989586621680037658"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><a href="#local-6989586621680037652"><span class="hs-identifier hs-type">dlgKeyHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftVerKeyHash"><span class="hs-identifier hs-type">PBftVerKeyHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037659"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span id="local-6989586621680037652"><span class="annot"><span class="annottext">dlgKeyHash :: PBftVerKeyHash c
</span><a href="#local-6989586621680037652"><span class="hs-identifier hs-var hs-var">dlgKeyHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
forall c.
PBftCrypto c =&gt;
VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#hashVerKey"><span class="hs-identifier hs-var">hashVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">(VerKeyDSIGN (PBftDSIGN c) -&gt; PBftVerKeyHash c)
-&gt; (PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c))
-&gt; PBftDelegationCert c
-&gt; PBftVerKeyHash c
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c)
forall c.
PBftCrypto c =&gt;
PBftDelegationCert c -&gt; VerKeyDSIGN (PBftDSIGN c)
</span><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#dlgCertDlgVerKey"><span class="hs-identifier hs-var">dlgCertDlgVerKey</span></a></span><span> </span><span class="annot"><span class="annottext">(PBftDelegationCert c -&gt; PBftVerKeyHash c)
-&gt; PBftDelegationCert c -&gt; PBftVerKeyHash c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PBftDelegationCert c
</span><a href="#local-6989586621680037655"><span class="hs-identifier hs-var">pbftCanBeLeaderDlgCert</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftState"><span class="hs-identifier hs-type">TickedPBftState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#TickedPBftLedgerView"><span class="hs-identifier hs-type">TickedPBftLedgerView</span></a></span><span> </span><span id="local-6989586621680037651"><span class="annot"><a href="#local-6989586621680037651"><span class="hs-identifier hs-var">dms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680037648"><span class="annot"><a href="#local-6989586621680037648"><span class="hs-identifier hs-var">cds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ticked (PBftState c)
</span><a href="#local-6989586621680037653"><span class="hs-identifier hs-var">tickedChainDepState</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Condense
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span id="local-6989586621680037646"><span id="local-6989586621680037647"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.Crypto.html#PBftCrypto"><span class="hs-identifier hs-type">PBftCrypto</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037647"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Condense.html#Condense"><span class="hs-identifier hs-type">Condense</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037647"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680037646"><span class="hs-identifier hs-type">toSign</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-498"></span><span>  </span><span id="local-6989586621680037643"><span class="annot"><span class="annottext">condense :: PBftFields c toSign -&gt; String
</span><a href="Ouroboros.Consensus.Util.Condense.html#condense"><span class="hs-identifier hs-var hs-var hs-var hs-var">condense</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.PBFT.html#PBftFields"><span class="hs-identifier hs-type">PBftFields</span></a></span><span class="hs-special">{</span><span id="local-6989586621680037639"><span id="local-6989586621680037640"><span id="local-6989586621680037641"><span class="annot"><span class="annottext">VerKeyDSIGN (PBftDSIGN c)
SignedDSIGN (PBftDSIGN c) toSign
pbftSignature :: SignedDSIGN (PBftDSIGN c) toSign
pbftGenKey :: VerKeyDSIGN (PBftDSIGN c)
pbftIssuer :: VerKeyDSIGN (PBftDSIGN c)
pbftSignature :: forall c toSign.
PBftFields c toSign -&gt; SignedDSIGN (PBftDSIGN c) toSign
pbftGenKey :: forall c toSign. PBftFields c toSign -&gt; VerKeyDSIGN (PBftDSIGN c)
pbftIssuer :: forall c toSign. PBftFields c toSign -&gt; VerKeyDSIGN (PBftDSIGN c)
</span><a href="#local-6989586621680037639"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SignedDSIGN (PBftDSIGN c) toSign -&gt; String
forall a. Condense a =&gt; a -&gt; String
</span><a href="Ouroboros.Consensus.Util.Condense.html#condense"><span class="hs-identifier hs-var">condense</span></a></span><span> </span><span class="annot"><span class="annottext">SignedDSIGN (PBftDSIGN c) toSign
</span><a href="#local-6989586621680037639"><span class="hs-identifier hs-var">pbftSignature</span></a></span></span></span><span>
</span><span id="line-499"></span></pre></body></html>