<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                        #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass             #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards            #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications           #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#simpleChunkInfo"><span class="hs-identifier hs-var">simpleChunkInfo</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#singleChunkInfo"><span class="hs-identifier hs-var">singleChunkInfo</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkInfoSupportsEBBs"><span class="hs-identifier hs-var">chunkInfoSupportsEBBs</span></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-comment">-- * Chunk number</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoToInt"><span class="hs-identifier hs-var">chunkNoToInt</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoFromInt"><span class="hs-identifier hs-var">chunkNoFromInt</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#prevChunkNo"><span class="hs-identifier hs-var">prevChunkNo</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#countChunks"><span class="hs-identifier hs-var">countChunks</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunksBetween"><span class="hs-identifier hs-var">chunksBetween</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier hs-var">unsafeEpochNoToChunkNo</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeChunkNoToEpochNo"><span class="hs-identifier hs-var">unsafeChunkNoToEpochNo</span></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-comment">-- * Chunk size</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier hs-var">getChunkSize</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-comment">-- * Layout</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#maxRelativeIndex"><span class="hs-identifier hs-var">maxRelativeIndex</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#mkRelativeSlot"><span class="hs-identifier hs-var">mkRelativeSlot</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertRelativeSlotInChunk"><span class="hs-identifier hs-var">assertRelativeSlotInChunk</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#compareRelativeSlot"><span class="hs-identifier hs-var">compareRelativeSlot</span></a><span>
</span><a name="line-34"></a><span>    </span><span class="hs-comment">-- * Assertions</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkAssertionFailure"><span class="hs-identifier hs-type">ChunkAssertionFailure</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier hs-var">assertWithinBounds</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertChunkCanContainEBB"><span class="hs-identifier hs-var">assertChunkCanContainEBB</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throw</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Word</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Generics</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.html"><span class="hs-identifier">Cardano.Prelude</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html"><span class="hs-identifier">Cardano.Slotting.Slot</span></a><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.CallStack.html"><span class="hs-identifier">Ouroboros.Consensus.Util.CallStack</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html"><span class="hs-identifier">Ouroboros.Consensus.Util.RedundantConstraints</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-comment">-- | Size of the chunks of the immutable DB</span><span>
</span><a name="line-53"></a><span class="hs-comment">--</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- This is the key data structure that drives all layout functions.</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- TODO: Add support for non-uniform 'ChunkInfo'</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- &lt;https://github.com/input-output-hk/ouroboros-network/issues/1754&gt;</span><span>
</span><a name="line-58"></a><span class="hs-keyword">data</span><span> </span><a name="ChunkInfo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier">ChunkInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-comment">-- | A single, uniform, chunk size</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-comment">-- If EBBs are present, the chunk size must line up precisely with the</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-comment">-- epoch size (that is, the number of regular blocks in the chunk must equal</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-comment">-- the number of regular blocks in an epoch).</span><span>
</span><a name="line-64"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-65"></a><span>    </span><a name="UniformChunkSize"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier">UniformChunkSize</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- | Simple chunk config with a single chunk size</span><span>
</span><a name="line-70"></a><span class="hs-comment">--</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- This intentionally takes 'EpochSize' (number of slots) rather than</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- 'ChunkSize': the translation from 'EpochSize' to 'ChunkSize' (number of</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- available entries in a chunk) should not be done by client code.</span><span>
</span><a name="line-74"></a><span class="hs-identifier">simpleChunkInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-type">EpochSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span>
</span><a name="line-75"></a><a name="simpleChunkInfo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#simpleChunkInfo"><span class="hs-identifier">simpleChunkInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-var">EpochSize</span></a><span> </span><a name="local-6989586621679580769"><a href="#local-6989586621679580769"><span class="hs-identifier">sz</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-var">ChunkSize</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621679580769"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- | 'ChunkInfo' for a single 'ChunkSize'</span><span>
</span><a name="line-78"></a><span class="hs-comment">--</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- See also 'simpleChunkInfo'.</span><span>
</span><a name="line-80"></a><span class="hs-identifier">singleChunkInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span>
</span><a name="line-81"></a><a name="singleChunkInfo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#singleChunkInfo"><span class="hs-identifier">singleChunkInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- | Can we store EBBs in the chunks described by this 'ChunkInfo'?</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- This is only used for tests. This API will need to change (and the tests will</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- become more complicated) once we support non-uniform 'ChunkInfo'.</span><span>
</span><a name="line-87"></a><span class="hs-identifier">chunkInfoSupportsEBBs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-88"></a><a name="chunkInfoSupportsEBBs"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkInfoSupportsEBBs"><span class="hs-identifier">chunkInfoSupportsEBBs</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a><span> </span><a name="local-6989586621679580770"><a href="#local-6989586621679580770"><span class="hs-identifier">chunkSize</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-identifier">chunkCanContainEBB</span><span> </span><a href="#local-6989586621679580770"><span class="hs-identifier hs-var">chunkSize</span></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Queries
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">-- | Size of a chunk</span><span>
</span><a name="line-96"></a><span class="hs-comment">--</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- The total number of slots available in a chunk is equal to 'numRegularBlocks'</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- if @not@ 'chunkCanContainEBB', and 'numRegularBlocks' @+ 1@ otherwise.</span><span>
</span><a name="line-99"></a><span class="hs-keyword">data</span><span> </span><a name="ChunkSize"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier">ChunkSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ChunkSize"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier">ChunkSize</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-100"></a><span>      </span><span class="hs-comment">-- | Does this chunk also accomodate an EBB?</span><span>
</span><a name="line-101"></a><span>      </span><a name="chunkCanContainEBB"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkCanContainEBB"><span class="hs-identifier">chunkCanContainEBB</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span>      </span><span class="hs-comment">-- | The number of regular blocks in this chunk</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="numRegularBlocks"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#numRegularBlocks"><span class="hs-identifier">numRegularBlocks</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-106"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-comment">-- | Chunk number</span><span>
</span><a name="line-110"></a><span class="hs-keyword">newtype</span><span> </span><a name="ChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier">ChunkNo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier">ChunkNo</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unChunkNo"><span class="hs-identifier">unChunkNo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">newtype</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- | First chunk</span><span>
</span><a name="line-115"></a><span class="hs-identifier">firstChunkNo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-116"></a><a name="firstChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier">firstChunkNo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- | Convert 'ChunkNo' to 'Int'</span><span>
</span><a name="line-119"></a><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- This is primarily useful for the immutable DB, which uses an 'IntPSQ'.</span><span>
</span><a name="line-121"></a><span class="hs-identifier">chunkNoToInt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-122"></a><a name="chunkNoToInt"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoToInt"><span class="hs-identifier">chunkNoToInt</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580771"><a href="#local-6989586621679580771"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679580771"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | Convert 'Int' to 'ChunkNo'</span><span>
</span><a name="line-125"></a><span class="hs-comment">--</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- See 'chunkNoToInt' for motivation.</span><span>
</span><a name="line-127"></a><span class="hs-identifier">chunkNoFromInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-128"></a><a name="chunkNoFromInt"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoFromInt"><span class="hs-identifier">chunkNoFromInt</span></a></a><span> </span><a name="local-6989586621679580772"><a href="#local-6989586621679580772"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679580772"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-identifier">nextChunkNo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-131"></a><a name="nextChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier">nextChunkNo</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580773"><a href="#local-6989586621679580773"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679580773"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-identifier">prevChunkNo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-134"></a><a name="prevChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#prevChunkNo"><span class="hs-identifier">prevChunkNo</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580774"><a href="#local-6989586621679580774"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679580774"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679580774"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-comment">-- | Count number of chunks between two indices</span><span>
</span><a name="line-137"></a><span class="hs-comment">--</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- &gt; countChunks x              x  == 0</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- &gt; countChunks x (nextChunkNo x) == 1</span><span>
</span><a name="line-140"></a><span class="hs-identifier">countChunks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-141"></a><a name="countChunks"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#countChunks"><span class="hs-identifier">countChunks</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580775"><a href="#local-6989586621679580775"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580776"><a href="#local-6989586621679580776"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679580775"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679580776"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679580775"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679580776"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679580776"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679580775"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | Enumerate all chunks</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- &gt; chunksBetween x              x  == [x]</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- &gt; chunksBetween x (nextChunkNo x) == [x, nextChunkNo x]</span><span>
</span><a name="line-147"></a><span class="hs-identifier">chunksBetween</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span class="hs-special">]</span><span>
</span><a name="line-148"></a><a name="chunksBetween"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunksBetween"><span class="hs-identifier">chunksBetween</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580777"><a href="#local-6989586621679580777"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580778"><a href="#local-6989586621679580778"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-149"></a><span>                                          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679580777"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679580778"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679580777"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621679580778"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679580778"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621679580777"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- | Translate 'EpochNo' to 'ChunkNo'</span><span>
</span><a name="line-152"></a><span class="hs-comment">--</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- This should /ONLY/ be used to translate the 'EpochNo' of an EBB, since the</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- invariant says EBBs can only exist in the first period of the DB, where the</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- chunk size must equal the epoch size. See 'ChunkInfo' for details.</span><span>
</span><a name="line-156"></a><span class="hs-identifier">unsafeEpochNoToChunkNo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-157"></a><a name="unsafeEpochNoToChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier">unsafeEpochNoToChunkNo</span></a></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><a name="local-6989586621679580779"><a href="#local-6989586621679580779"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a href="#local-6989586621679580779"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-comment">-- | Translate 'ChunkNo' to 'EpochNo'</span><span>
</span><a name="line-160"></a><span class="hs-comment">--</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- This should /ONLY/ be used for chunks that contain EBBs.</span><span>
</span><a name="line-162"></a><span class="hs-comment">-- See 'unsafeEpochNoToChunkNo' and 'ChunkInfo' for details.</span><span>
</span><a name="line-163"></a><span class="hs-identifier">unsafeChunkNoToEpochNo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-164"></a><a name="unsafeChunkNoToEpochNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeChunkNoToEpochNo"><span class="hs-identifier">unsafeChunkNoToEpochNo</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a><span> </span><a name="local-6989586621679580780"><a href="#local-6989586621679580780"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><a href="#local-6989586621679580780"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">getChunkSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span>
</span><a name="line-167"></a><a name="getChunkSize"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier">getChunkSize</span></a></a><span> </span><a name="local-6989586621679580781"><a href="#local-6989586621679580781"><span class="hs-identifier">chunkInfo</span></a></a><span> </span><a name="local-6989586621679580782"><a href="#local-6989586621679580782"><span class="hs-identifier">_chunk</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679580781"><span class="hs-identifier hs-var">chunkInfo</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-169"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a><span> </span><a name="local-6989586621679580783"><a href="#local-6989586621679580783"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580783"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Layout

  These are defined in the @Internal@ module so that most code can safely
  import from &quot;Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout&quot; without
  worrying that it's making assumptions that it shouldn't. All bets are off for
  modules that import &quot;Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal&quot;.
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- | A /relative/ slot within a chunk</span><span>
</span><a name="line-181"></a><span class="hs-keyword">data</span><span> </span><a name="RelativeSlot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier">RelativeSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RelativeSlot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier">RelativeSlot</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-comment">-- | The chunk index of the chunk this slot is in</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-comment">-- Recorded primarily to be able to define a semi-sensible 'Ord' instance.</span><span>
</span><a name="line-185"></a><span>    </span><a name="relativeSlotChunkNo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier">relativeSlotChunkNo</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-comment">-- | The size of the chunk that this slot is in</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-comment">-- We record this for bounds checking as well as to be able to answer</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-comment">-- questions such as 'relativeSlotIsEBB'.</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="relativeSlotChunkSize"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkSize"><span class="hs-identifier">relativeSlotChunkSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>    </span><span class="hs-comment">-- | The index within the chunk</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="relativeSlotIndex"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier">relativeSlotIndex</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-195"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- | Maximum relative index within a chunk</span><span>
</span><a name="line-200"></a><span class="hs-identifier">maxRelativeIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-201"></a><a name="maxRelativeIndex"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#maxRelativeIndex"><span class="hs-identifier">maxRelativeIndex</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-var">ChunkSize</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679580784"><span class="hs-identifier hs-var">chunkCanContainEBB</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679580785"><span class="hs-identifier hs-var">numRegularBlocks</span></a><span>
</span><a name="line-203"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679580785"><span class="hs-identifier hs-var">numRegularBlocks</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- | Smart constructor for 'RelativeSlot'</span><span>
</span><a name="line-206"></a><span class="hs-identifier">mkRelativeSlot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a><span>
</span><a name="line-207"></a><a name="mkRelativeSlot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#mkRelativeSlot"><span class="hs-identifier">mkRelativeSlot</span></a></a><span> </span><a name="local-6989586621679580786"><a href="#local-6989586621679580786"><span class="hs-identifier">chunkInfo</span></a></a><span> </span><a name="local-6989586621679580787"><a href="#local-6989586621679580787"><span class="hs-identifier">chunk</span></a></a><span> </span><a name="local-6989586621679580788"><a href="#local-6989586621679580788"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-208"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier hs-var">assertWithinBounds</span></a><span> </span><a href="#local-6989586621679580788"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621679580789"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-209"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-var">RelativeSlot</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-identifier">relativeSlotChunkNo</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679580787"><span class="hs-identifier hs-var">chunk</span></a><span>
</span><a name="line-211"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">relativeSlotChunkSize</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679580789"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-212"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">relativeSlotIndex</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679580788"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-213"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-214"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-215"></a><span>    </span><a name="local-6989586621679580789"><a href="#local-6989586621679580789"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier hs-var">getChunkSize</span></a><span> </span><a href="#local-6989586621679580786"><span class="hs-identifier hs-var">chunkInfo</span></a><span> </span><a href="#local-6989586621679580787"><span class="hs-identifier hs-var">chunk</span></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-218"></a><span>  </span><a name="local-6989586621679580764"><a href="#local-6989586621679580764"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span> </span><a name="local-6989586621679580765"><a href="#local-6989586621679580765"><span class="hs-identifier">b</span></a></a><span>
</span><a name="line-219"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580764"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580765"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-comment">-- If the 'ChunkNo's are the same, then the 'ChunkSize's /must/ also be</span><span>
</span><a name="line-222"></a><span>        </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580764"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580765"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-223"></a><span>          </span><span class="hs-identifier">relativeSlotIndex</span><span> </span><a href="#local-6989586621679580764"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">relativeSlotIndex</span><span> </span><a href="#local-6989586621679580765"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-- | 'RelativeSlot' is partially ordered, not totally ordered</span><span>
</span><a name="line-226"></a><span class="hs-comment">--</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- It makes no sense to compare 'RelativeSlots' from different chunks. Doing so</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- will result in an assertion failure.</span><span>
</span><a name="line-229"></a><span class="hs-identifier">compareRelativeSlot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-230"></a><a name="compareRelativeSlot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#compareRelativeSlot"><span class="hs-identifier">compareRelativeSlot</span></a></a><span> </span><a name="local-6989586621679580790"><a href="#local-6989586621679580790"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679580791"><a href="#local-6989586621679580791"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-231"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580790"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580791"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-232"></a><span>      </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotIndex</span><span> </span><a href="#local-6989586621679580790"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotIndex</span><span> </span><a href="#local-6989586621679580791"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">assertRelativeSlotInChunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-235"></a><a name="assertRelativeSlotInChunk"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertRelativeSlotInChunk"><span class="hs-identifier">assertRelativeSlotInChunk</span></a></a><span> </span><a name="local-6989586621679580792"><a href="#local-6989586621679580792"><span class="hs-identifier">chunk</span></a></a><span> </span><a name="local-6989586621679580793"><a href="#local-6989586621679580793"><span class="hs-identifier">relSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-236"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">relativeSlotChunkNo</span><span> </span><a href="#local-6989586621679580793"><span class="hs-identifier hs-var">relSlot</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679580792"><span class="hs-identifier hs-var">chunk</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-237"></a><span>      </span><span class="hs-identifier">relativeSlotIndex</span><span> </span><a href="#local-6989586621679580793"><span class="hs-identifier hs-var">relSlot</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Assert failures

  We insist on keeping the HasCallStack constraint here, because if we make
  that constraint depend on CPP, we will get redundant constraint warnings for
  any functions that (transitively) call these functions.
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-keyword">data</span><span> </span><a name="ChunkAssertionFailure"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkAssertionFailure"><span class="hs-identifier">ChunkAssertionFailure</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-248"></a><span>    </span><a name="NotSameChunk"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#NotSameChunk"><span class="hs-identifier">NotSameChunk</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><a href="Ouroboros.Consensus.Util.CallStack.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NotWithinBounds"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#NotWithinBounds"><span class="hs-identifier">NotWithinBounds</span></a></a><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span> </span><a href="Ouroboros.Consensus.Util.CallStack.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ChunkCannotContainEBBs"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkCannotContainEBBs"><span class="hs-identifier">ChunkCannotContainEBBs</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><a href="Ouroboros.Consensus.Util.CallStack.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a><span>
</span><a name="line-251"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkAssertionFailure"><span class="hs-identifier hs-type">ChunkAssertionFailure</span></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">assertSameChunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580768"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580768"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-256"></a><span class="hs-cpp">#if ENABLE_ASSERTIONS
</span><a name="assertSameChunk"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier">assertSameChunk</span></a></a><span> </span><a name="local-6989586621679580794"><a href="#local-6989586621679580794"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679580795"><a href="#local-6989586621679580795"><span class="hs-identifier">b</span></a></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679580794"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679580795"><span class="hs-identifier hs-var">b</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#NotSameChunk"><span class="hs-identifier hs-var">NotSameChunk</span></a><span> </span><a href="#local-6989586621679580794"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679580795"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="Ouroboros.Consensus.Util.CallStack.html#prettyCallStack"><span class="hs-identifier hs-var">prettyCallStack</span></a><span>
</span><a name="line-260"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">assertSameChunk</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span>
</span><a name="line-262"></a><span class="hs-cpp">#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html#keepRedundantConstraint"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-identifier">assertWithinBounds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580767"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580767"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-267"></a><span class="hs-cpp">#if ENABLE_ASSERTIONS
</span><a name="assertWithinBounds"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier">assertWithinBounds</span></a></a><span> </span><a name="local-6989586621679580796"><a href="#local-6989586621679580796"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621679580797"><a href="#local-6989586621679580797"><span class="hs-identifier">sz</span></a></a><span>
</span><a name="line-269"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679580796"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#maxRelativeIndex"><span class="hs-identifier hs-var">maxRelativeIndex</span></a><span> </span><a href="#local-6989586621679580797"><span class="hs-identifier hs-var">sz</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#NotWithinBounds"><span class="hs-identifier hs-var">NotWithinBounds</span></a><span> </span><a href="#local-6989586621679580796"><span class="hs-identifier hs-var">ix</span></a><span> </span><a href="#local-6989586621679580797"><span class="hs-identifier hs-var">sz</span></a><span> </span><a href="Ouroboros.Consensus.Util.CallStack.html#prettyCallStack"><span class="hs-identifier hs-var">prettyCallStack</span></a><span>
</span><a name="line-271"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">assertWithinBounds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span>
</span><a name="line-273"></a><span class="hs-cpp">#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html#keepRedundantConstraint"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-identifier">assertChunkCanContainEBB</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580766"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679580766"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-278"></a><span class="hs-cpp">#if ENABLE_ASSERTIONS
</span><a name="assertChunkCanContainEBB"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertChunkCanContainEBB"><span class="hs-identifier">assertChunkCanContainEBB</span></a></a><span> </span><a name="local-6989586621679580798"><a href="#local-6989586621679580798"><span class="hs-identifier">chunk</span></a></a><span> </span><a name="local-6989586621679580799"><a href="#local-6989586621679580799"><span class="hs-identifier">size</span></a></a><span>
</span><a name="line-280"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">chunkCanContainEBB</span><span> </span><a href="#local-6989586621679580799"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkCannotContainEBBs"><span class="hs-identifier hs-var">ChunkCannotContainEBBs</span></a><span> </span><a href="#local-6989586621679580798"><span class="hs-identifier hs-var">chunk</span></a><span> </span><a href="Ouroboros.Consensus.Util.CallStack.html#prettyCallStack"><span class="hs-identifier hs-var">prettyCallStack</span></a><span>
</span><a name="line-282"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">assertChunkCanContainEBB</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span>
</span><a name="line-284"></a><span class="hs-cpp">#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html#keepRedundantConstraint"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a></pre></body></html>