<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes                 #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving         #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances       #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE UndecidableSuperClasses    #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Mempool.API</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier">Mempool</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#addTxs"><span class="hs-identifier">addTxs</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeLedgerState"><span class="hs-identifier">ForgeLedgerState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolCapacityBytes"><span class="hs-identifier">MempoolCapacityBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier">MempoolSnapshot</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier">MempoolAddTxResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier">isMempoolTxAdded</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier">isMempoolTxRejected</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier">MempoolSize</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceEventMempool"><span class="hs-identifier">TraceEventMempool</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exports</span></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">TxSizeInBytes</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word32</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">TxSizeInBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsMempool</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- | Mempool</span><span>
</span><span id="line-36"></span><span class="hs-comment">--</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- The mempool is the set of transactions that should be included in the next</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- block. In principle this is a /set/ of all the transactions that we receive</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- from our peers. In order to avoid flooding the network with invalid</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- transactions,  however, we only want to keep /valid/ transactions in the</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- mempool. That raises the question: valid with respect to which ledger state?</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- We opt for a very simple answer to this: the mempool will be interpreted</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- as a /list/ of transactions; which are validated strictly in order, starting</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- from the current ledger state. This has a number of advantages:</span><span>
</span><span id="line-46"></span><span class="hs-comment">--</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- * It's simple to implement and it's efficient. In particular, no search for</span><span>
</span><span id="line-48"></span><span class="hs-comment">--   a valid subset is ever required.</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- * When producing a block, we can simply take the longest possible prefix</span><span>
</span><span id="line-50"></span><span class="hs-comment">--   of transactions that fits in a block.</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- * It supports wallets that submit dependent transactions (where later</span><span>
</span><span id="line-52"></span><span class="hs-comment">--   transaction depends on outputs from earlier ones).</span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="Mempool"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-var">Mempool</span></a></span></span><span> </span><span id="local-6989586621680009378"><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680009377"><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680009376"><span class="annot"><a href="#local-6989586621680009376"><span class="hs-identifier hs-type">idx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Mempool"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-var">Mempool</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-54"></span><span>      </span><span class="hs-comment">-- | Add a bunch of transactions (oldest to newest)</span><span>
</span><span id="line-55"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span>      </span><span class="hs-comment">-- As long as we keep the mempool entirely in-memory this could live in</span><span>
</span><span id="line-57"></span><span>      </span><span class="hs-comment">-- @STM m@; we keep it in @m@ instead to leave open the possibility of</span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-comment">-- persistence.</span><span>
</span><span id="line-59"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-comment">-- The new transactions provided will be validated, /in order/, against</span><span>
</span><span id="line-61"></span><span>      </span><span class="hs-comment">-- the ledger state obtained by applying all the transactions already in</span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-comment">-- the Mempool to it. Transactions which are found to be invalid, with</span><span>
</span><span id="line-63"></span><span>      </span><span class="hs-comment">-- respect to the ledger state, are dropped, whereas valid transactions</span><span>
</span><span id="line-64"></span><span>      </span><span class="hs-comment">-- are added to the mempool.</span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span>      </span><span class="hs-comment">-- Note that transactions that are invalid, with respect to the ledger</span><span>
</span><span id="line-67"></span><span>      </span><span class="hs-comment">-- state, will /never/ be added to the mempool. However, it is possible</span><span>
</span><span id="line-68"></span><span>      </span><span class="hs-comment">-- that, at a given point in time, transactions which were once valid</span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-comment">-- but are now invalid, with respect to the current ledger state, could</span><span>
</span><span id="line-70"></span><span>      </span><span class="hs-comment">-- exist within the mempool until they are revalidated and dropped from</span><span>
</span><span id="line-71"></span><span>      </span><span class="hs-comment">-- the mempool via a call to 'syncWithLedger' or by the background</span><span>
</span><span id="line-72"></span><span>      </span><span class="hs-comment">-- thread that watches the ledger for changes.</span><span>
</span><span id="line-73"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span>      </span><span class="hs-comment">-- This function will return two lists</span><span>
</span><span id="line-75"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span>      </span><span class="hs-comment">-- 1. A list containing the following transactions:</span><span>
</span><span id="line-77"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span>      </span><span class="hs-comment">--    * Those transactions provided which were found to be valid, along</span><span>
</span><span id="line-79"></span><span>      </span><span class="hs-comment">--      with 'MempoolTxAdded' for their accompanying</span><span>
</span><span id="line-80"></span><span>      </span><span class="hs-comment">--      'MempoolAddTxResult' values. These transactions are now in the</span><span>
</span><span id="line-81"></span><span>      </span><span class="hs-comment">--      Mempool.</span><span>
</span><span id="line-82"></span><span>      </span><span class="hs-comment">--    * Those transactions provided which were found to be invalid,</span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-comment">--      along with their accompanying validation errors. These</span><span>
</span><span id="line-84"></span><span>      </span><span class="hs-comment">--      transactions are not in the Mempool.</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-comment">-- 2. A list containing the transactions that have not yet been added</span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-comment">--    yet, as the capacity of the Mempool has been reached. I.e., there</span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-comment">--    is no space in the Mempool to add the first transaction in this</span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-comment">--    list. Note that we won't try to add smaller transactions after</span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-comment">--    that first transaction because they might depend on the first</span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-comment">--    transaction.</span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- POSTCONDITION:</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-comment">-- &gt; (processed, toProcess) &lt;- tryAddTxs txs</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-comment">-- &gt; map fst processed ++ toProcess == txs</span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-comment">-- Note that previously valid transaction that are now invalid with</span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-comment">-- respect to the current ledger state are dropped from the mempool, but</span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-comment">-- are not part of the first returned list (nor the second).</span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span>      </span><span class="hs-comment">-- In principle it is possible that validation errors are transient; for</span><span>
</span><span id="line-102"></span><span>      </span><span class="hs-comment">-- example, it is possible that a transaction is rejected because one of</span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-comment">-- its inputs is not /yet/ available in the UTxO (the transaction it</span><span>
</span><span id="line-104"></span><span>      </span><span class="hs-comment">-- depends on is not yet in the chain, nor in the mempool). In practice</span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-comment">-- however it is likely that rejected transactions will still be</span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-comment">-- rejected later, and should just be dropped.</span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- It is important to note one important special case of transactions</span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-comment">-- being &quot;invalid&quot;: a transaction will /also/ be considered invalid if</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- /that very same transaction/ is already included on the blockchain</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-comment">-- (after all, by definition that must mean its inputs have been used).</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-comment">-- Rejected transactions are therefore not necessarily a sign of</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-comment">-- malicious behaviour. Indeed, we would expect /most/ transactions that</span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-comment">-- are reported as invalid by 'tryAddTxs' to be invalid precisely</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-comment">-- because they have already been included. Distinguishing between these</span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-comment">-- two cases can be done in theory, but it is expensive unless we have</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-comment">-- an index of transaction hashes that have been included on the</span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-comment">-- blockchain.</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-120"></span><span>      </span><span id="tryAddTxs"><span class="annot"><span class="annottext">Mempool m blk idx
-&gt; [GenTx blk]
-&gt; m ([(GenTx blk, MempoolAddTxResult blk)], [GenTx blk])
</span><a href="Ouroboros.Consensus.Mempool.API.html#tryAddTxs"><span class="hs-identifier hs-var hs-var">tryAddTxs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-122"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-123"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>      </span><span class="hs-comment">-- | Manually remove the given transactions from the mempool.</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="removeTxs"><span class="annot"><span class="annottext">Mempool m blk idx -&gt; [GenTxId blk] -&gt; m ()
</span><a href="Ouroboros.Consensus.Mempool.API.html#removeTxs"><span class="hs-identifier hs-var hs-var">removeTxs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>      </span><span class="hs-comment">-- | Sync the transactions in the mempool with the current ledger state</span><span>
</span><span id="line-129"></span><span>      </span><span class="hs-comment">--  of the 'ChainDB'.</span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span>      </span><span class="hs-comment">-- The transactions that exist within the mempool will be revalidated</span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-comment">-- against the current ledger state. Transactions which are found to be</span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-comment">-- invalid with respect to the current ledger state, will be dropped</span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-comment">-- from the mempool, whereas valid transactions will remain.</span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span>      </span><span class="hs-comment">-- We keep this in @m@ instead of @STM m@ to leave open the possibility</span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-comment">-- of persistence. Additionally, this makes it possible to trace the</span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-comment">-- removal of invalid transactions.</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-comment">-- n.b. in our current implementation, when one opens a mempool, we</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-comment">-- spawn a thread which performs this action whenever the 'ChainDB' tip</span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-comment">-- point changes.</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="syncWithLedger"><span class="annot"><span class="annottext">Mempool m blk idx -&gt; m (MempoolSnapshot blk idx)
</span><a href="Ouroboros.Consensus.Mempool.API.html#syncWithLedger"><span class="hs-identifier hs-var hs-var">syncWithLedger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009376"><span class="hs-identifier hs-type">idx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-comment">-- | Get a snapshot of the current mempool state. This allows for</span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-comment">-- further pure queries on the snapshot.</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-comment">-- This doesn't look at the ledger state at all.</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getSnapshot"><span class="annot"><span class="annottext">Mempool m blk idx -&gt; STM m (MempoolSnapshot blk idx)
</span><a href="Ouroboros.Consensus.Mempool.API.html#getSnapshot"><span class="hs-identifier hs-var hs-var">getSnapshot</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009376"><span class="hs-identifier hs-type">idx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-comment">-- | Get a snapshot of the mempool state that is valid with respect to</span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-comment">-- the given ledger state</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-comment">-- This does not update the state of the mempool.</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getSnapshotFor"><span class="annot"><span class="annottext">Mempool m blk idx
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk idx)
</span><a href="Ouroboros.Consensus.Mempool.API.html#getSnapshotFor"><span class="hs-identifier hs-var hs-var">getSnapshotFor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeLedgerState"><span class="hs-identifier hs-type">ForgeLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009376"><span class="hs-identifier hs-type">idx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- | Get the mempool's capacity in bytes.</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-comment">-- Note that the capacity of the Mempool, unless it is overridden with</span><span>
</span><span id="line-160"></span><span>      </span><span class="hs-comment">-- 'MempoolCapacityBytesOverride', can dynamically change when the</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-comment">-- ledger state is updated: it will be set to twice the current ledger's</span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-comment">-- maximum transaction capacity of a block.</span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-comment">-- When the capacity happens to shrink at some point, we /do not/ remove</span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-comment">-- transactions from the Mempool to satisfy this new lower limit.</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-comment">-- Instead, we treat it the same way as a Mempool which is /at/</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-comment">-- capacity, i.e., we won't admit new transactions until some have been</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-comment">-- removed because they have become invalid.</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getCapacity"><span class="annot"><span class="annottext">Mempool m blk idx -&gt; STM m MempoolCapacityBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getCapacity"><span class="hs-identifier hs-var hs-var">getCapacity</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolCapacityBytes"><span class="hs-identifier hs-type">MempoolCapacityBytes</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>      </span><span class="hs-comment">-- | Return the post-serialisation size in bytes of a 'GenTx'.</span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getTxSize"><span class="annot"><span class="annottext">Mempool m blk idx -&gt; GenTx blk -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getTxSize"><span class="hs-identifier hs-var hs-var">getTxSize</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009377"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">TxSizeInBytes</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-comment">-- | Represents the initial value at which the transaction ticket number</span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-comment">-- counter will start (i.e. the zeroth ticket number).</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="zeroIdx"><span class="annot"><span class="annottext">Mempool m blk idx -&gt; idx
</span><a href="Ouroboros.Consensus.Mempool.API.html#zeroIdx"><span class="hs-identifier hs-var hs-var">zeroIdx</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680009376"><span class="hs-identifier hs-type">idx</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">-- | The result of attempting to add a transaction to the mempool.</span><span>
</span><span id="line-180"></span><span class="hs-keyword">data</span><span> </span><span id="MempoolAddTxResult"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-var">MempoolAddTxResult</span></a></span></span><span> </span><span id="local-6989586621680009306"><span class="annot"><a href="#local-6989586621680009306"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MempoolTxAdded"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxAdded"><span class="hs-identifier hs-var">MempoolTxAdded</span></a></span></span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">-- ^ The transaction was added to the mempool.</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MempoolTxRejected"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxRejected"><span class="hs-identifier hs-var">MempoolTxRejected</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009306"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- ^ The transaction was rejected and could not be added to the mempool</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-comment">-- for the specified reason.</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span id="local-6989586621680009299"><span id="local-6989586621680009301"><span id="local-6989586621680009303"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009303"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009303"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-188"></span><span id="local-6989586621680009291"><span id="local-6989586621680009293"><span id="local-6989586621680009295"><span id="local-6989586621680009297"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009297"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009297"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span id="local-6989586621680009289"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier hs-type">isMempoolTxAdded</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009289"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-191"></span><span id="isMempoolTxAdded"><span class="annot"><span class="annottext">isMempoolTxAdded :: MempoolAddTxResult blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier hs-var hs-var">isMempoolTxAdded</span></a></span></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxAdded"><span class="hs-identifier hs-var">MempoolTxAdded</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-192"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier hs-var">isMempoolTxAdded</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><span class="hs-identifier">_</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span id="local-6989586621680009288"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier hs-type">isMempoolTxRejected</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009288"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-195"></span><span id="isMempoolTxRejected"><span class="annot"><span class="annottext">isMempoolTxRejected :: MempoolAddTxResult blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier hs-var hs-var">isMempoolTxRejected</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxRejected"><span class="hs-identifier hs-type">MempoolTxRejected</span></a></span><span> </span><span class="annot"><span class="annottext">ApplyTxErr blk
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-196"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier hs-var">isMempoolTxRejected</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><span class="hs-identifier">_</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Wrapper around 'implTryAddTxs' that blocks until all transaction have</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- either been added to the Mempool or rejected.</span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- This function does not sync the Mempool contents with the ledger state in</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- case the latter changes, it relies on the background thread to do that.</span><span>
</span><span id="line-203"></span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- POSTCONDITON:</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- &gt; processed &lt;- addTxs mpEnv txs</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- &gt; map fst processed == txs</span><span>
</span><span id="line-207"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#addTxs"><span class="hs-identifier hs-type">addTxs</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680009287"><span class="annot"><a href="#local-6989586621680009287"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680009286"><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680009285"><span class="annot"><a href="#local-6989586621680009285"><span class="hs-identifier hs-type">idx</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009287"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-type">Mempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009287"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009285"><span class="hs-identifier hs-type">idx</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680009287"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span id="addTxs"><span class="annot"><span class="annottext">addTxs :: Mempool m blk idx
-&gt; [GenTx blk] -&gt; m [(GenTx blk, MempoolAddTxResult blk)]
</span><a href="Ouroboros.Consensus.Mempool.API.html#addTxs"><span class="hs-identifier hs-var hs-var">addTxs</span></a></span></span><span> </span><span id="local-6989586621680009284"><span class="annot"><span class="annottext">Mempool m blk idx
</span><a href="#local-6989586621680009284"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680009283"><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009283"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680009282"><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009282"><span class="hs-identifier hs-var">processed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680009281"><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009281"><span class="hs-identifier hs-var">toAdd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
-&gt; [GenTx blk]
-&gt; m ([(GenTx blk, MempoolAddTxResult blk)], [GenTx blk])
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx
-&gt; [GenTx blk]
-&gt; m ([(GenTx blk, MempoolAddTxResult blk)], [GenTx blk])
</span><a href="Ouroboros.Consensus.Mempool.API.html#tryAddTxs"><span class="hs-identifier hs-var hs-var">tryAddTxs</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
</span><a href="#local-6989586621680009284"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009283"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009281"><span class="hs-identifier hs-var">toAdd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
-&gt; m [(GenTx blk, MempoolAddTxResult blk)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009282"><span class="hs-identifier hs-var">processed</span></a></span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">[GenTx blk]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
-&gt; [GenTx blk] -&gt; m [(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009280"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009282"><span class="hs-identifier hs-var">processed</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009281"><span class="hs-identifier hs-var">toAdd</span></a></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><a href="#local-6989586621680009280"><span class="hs-identifier hs-type">go</span></a></span><span>
</span><span id="line-219"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-220"></span><span>         </span><span class="hs-comment">-- ^ The outer list is in reverse order, but all the inner lists will</span><span>
</span><span id="line-221"></span><span>         </span><span class="hs-comment">-- be in the right order.</span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-223"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680009287"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009286"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621680009280"><span class="annot"><span class="annottext">go :: [[(GenTx blk, MempoolAddTxResult blk)]]
-&gt; [GenTx blk] -&gt; m [(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009280"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621680009279"><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
</span><a href="#local-6989586621680009279"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
-&gt; m [(GenTx blk, MempoolAddTxResult blk)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
-&gt; [(GenTx blk, MempoolAddTxResult blk)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
-&gt; [[(GenTx blk, MempoolAddTxResult blk)]]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
</span><a href="#local-6989586621680009279"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><a href="#local-6989586621680009280"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621680009276"><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
</span><a href="#local-6989586621680009276"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621680009275"><span class="annot"><span class="annottext">txs :: [GenTx blk]
</span><a href="#local-6989586621680009275"><span class="hs-identifier hs-var">txs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621680009274"><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621680009274"><span class="hs-identifier hs-var">tx</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[GenTx blk]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680009273"><span class="annot"><span class="annottext">firstTxSize :: TxSizeInBytes
</span><a href="#local-6989586621680009273"><span class="hs-identifier hs-var hs-var">firstTxSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx -&gt; GenTx blk -&gt; TxSizeInBytes
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx -&gt; GenTx blk -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getTxSize"><span class="hs-identifier hs-var hs-var">getTxSize</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
</span><a href="#local-6989586621680009284"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621680009274"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-227"></span><span>      </span><span class="hs-comment">-- Wait until there's at least room for the first transaction we're</span><span>
</span><span id="line-228"></span><span>      </span><span class="hs-comment">-- trying to add, otherwise there's no point in trying to add it.</span><span>
</span><span id="line-229"></span><span>      </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>        </span><span id="local-6989586621680009271"><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009271"><span class="hs-identifier hs-var">curSize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MempoolSize -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#msNumBytes"><span class="hs-identifier hs-var hs-var">msNumBytes</span></a></span><span> </span><span class="annot"><span class="annottext">(MempoolSize -&gt; TxSizeInBytes)
-&gt; (MempoolSnapshot blk idx -&gt; MempoolSize)
-&gt; MempoolSnapshot blk idx
-&gt; TxSizeInBytes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; MempoolSize
forall blk idx. MempoolSnapshot blk idx -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotMempoolSize"><span class="hs-identifier hs-var hs-var">snapshotMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">(MempoolSnapshot blk idx -&gt; TxSizeInBytes)
-&gt; STM m (MempoolSnapshot blk idx) -&gt; STM m TxSizeInBytes
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx -&gt; STM m (MempoolSnapshot blk idx)
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx -&gt; STM m (MempoolSnapshot blk idx)
</span><a href="Ouroboros.Consensus.Mempool.API.html#getSnapshot"><span class="hs-identifier hs-var hs-var">getSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
</span><a href="#local-6989586621680009284"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-231"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolCapacityBytes"><span class="hs-identifier hs-type">MempoolCapacityBytes</span></a></span><span> </span><span id="local-6989586621680009265"><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009265"><span class="hs-identifier hs-var">capacity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx -&gt; STM m MempoolCapacityBytes
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx -&gt; STM m MempoolCapacityBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getCapacity"><span class="hs-identifier hs-var hs-var">getCapacity</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
</span><a href="#local-6989586621680009284"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (stm :: * -&gt; *). MonadSTMTx stm =&gt; Bool -&gt; stm ()
</span><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009271"><span class="hs-identifier hs-var">curSize</span></a></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes -&gt; TxSizeInBytes -&gt; TxSizeInBytes
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009273"><span class="hs-identifier hs-var">firstTxSize</span></a></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes -&gt; TxSizeInBytes -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009265"><span class="hs-identifier hs-var">capacity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-comment">-- It is possible that between the check above and the call below, other</span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-comment">-- transactions are added, stealing our spot, but that's fine, we'll</span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-comment">-- just recurse again without progress.</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680009261"><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009261"><span class="hs-identifier hs-var">added</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680009260"><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009260"><span class="hs-identifier hs-var">toAdd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
-&gt; [GenTx blk]
-&gt; m ([(GenTx blk, MempoolAddTxResult blk)], [GenTx blk])
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx
-&gt; [GenTx blk]
-&gt; m ([(GenTx blk, MempoolAddTxResult blk)], [GenTx blk])
</span><a href="Ouroboros.Consensus.Mempool.API.html#tryAddTxs"><span class="hs-identifier hs-var hs-var">tryAddTxs</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk idx
</span><a href="#local-6989586621680009284"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009275"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-237"></span><span>      </span><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
-&gt; [GenTx blk] -&gt; m [(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009280"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
</span><a href="#local-6989586621680009261"><span class="hs-identifier hs-var">added</span></a></span><span class="annot"><span class="annottext">[(GenTx blk, MempoolAddTxResult blk)]
-&gt; [[(GenTx blk, MempoolAddTxResult blk)]]
-&gt; [[(GenTx blk, MempoolAddTxResult blk)]]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[[(GenTx blk, MempoolAddTxResult blk)]]
</span><a href="#local-6989586621680009276"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621680009260"><span class="hs-identifier hs-var">toAdd</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | The ledger state wrt to which we should produce a block</span><span>
</span><span id="line-240"></span><span class="hs-comment">--</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- The transactions in the mempool will be part of the body of a block, but a</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- block consists of a header and a body, and the full validation of a block</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- consists of first processing its header and only then processing the body.</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- This is important, because processing the header may change the state of the</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- ledger: the update system might be updated, scheduled delegations might be</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- applied, etc., and such changes should take effect before we validate any</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- transactions.</span><span>
</span><span id="line-248"></span><span class="hs-keyword">data</span><span> </span><span id="ForgeLedgerState"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeLedgerState"><span class="hs-identifier hs-var">ForgeLedgerState</span></a></span></span><span> </span><span id="local-6989586621680009259"><span class="annot"><a href="#local-6989586621680009259"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-comment">-- | The slot number of the block is known</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- This will only be the case when we realized that we are the slot leader</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">-- and we are actually producing a block. It is the caller's responsibility</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- to call 'applyChainTick' and produce the ticked ledger state.</span><span>
</span><span id="line-254"></span><span>    </span><span id="ForgeInKnownSlot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeInKnownSlot"><span class="hs-identifier hs-var">ForgeInKnownSlot</span></a></span></span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#TickedLedgerState"><span class="hs-identifier hs-type">TickedLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009259"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- | The slot number of the block is not yet known</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- When we are validating transactions before we know in which block they</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- will end up, we have to make an assumption about which slot number to use</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- for 'applyChainTick' to prepare the ledger state; we will assume that</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-comment">-- they will end up in the slot after the slot at the tip of the ledger.</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ForgeInUnknownSlot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeInUnknownSlot"><span class="hs-identifier hs-var">ForgeInUnknownSlot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009259"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="hs-comment">-- | Represents the maximum number of bytes worth of transactions that a</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- 'Mempool' can contain.</span><span>
</span><span id="line-266"></span><span class="hs-keyword">newtype</span><span> </span><span id="MempoolCapacityBytes"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolCapacityBytes"><span class="hs-identifier hs-var">MempoolCapacityBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MempoolCapacityBytes"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolCapacityBytes"><span class="hs-identifier hs-var">MempoolCapacityBytes</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-267"></span><span>      </span><span id="getMempoolCapacityBytes"><span class="annot"><span class="annottext">MempoolCapacityBytes -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getMempoolCapacityBytes"><span class="hs-identifier hs-var hs-var">getMempoolCapacityBytes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680009251"><span id="local-6989586621680009253"><span class="annot"><span class="annottext">MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool
(MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool)
-&gt; (MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool)
-&gt; Eq MempoolCapacityBytes
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool
$c/= :: MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool
== :: MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool
$c== :: MempoolCapacityBytes -&gt; MempoolCapacityBytes -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680009245"><span id="local-6989586621680009247"><span id="local-6989586621680009249"><span class="annot"><span class="annottext">Int -&gt; MempoolCapacityBytes -&gt; ShowS
[MempoolCapacityBytes] -&gt; ShowS
MempoolCapacityBytes -&gt; String
(Int -&gt; MempoolCapacityBytes -&gt; ShowS)
-&gt; (MempoolCapacityBytes -&gt; String)
-&gt; ([MempoolCapacityBytes] -&gt; ShowS)
-&gt; Show MempoolCapacityBytes
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MempoolCapacityBytes] -&gt; ShowS
$cshowList :: [MempoolCapacityBytes] -&gt; ShowS
show :: MempoolCapacityBytes -&gt; String
$cshow :: MempoolCapacityBytes -&gt; String
showsPrec :: Int -&gt; MempoolCapacityBytes -&gt; ShowS
$cshowsPrec :: Int -&gt; MempoolCapacityBytes -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680009239"><span id="local-6989586621680009241"><span id="local-6989586621680009243"><span class="annot"><span class="annottext">Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo)
Proxy MempoolCapacityBytes -&gt; String
(Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy MempoolCapacityBytes -&gt; String)
-&gt; NoThunks MempoolCapacityBytes
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy MempoolCapacityBytes -&gt; String
$cshowTypeOf :: Proxy MempoolCapacityBytes -&gt; String
wNoThunks :: Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: Context -&gt; MempoolCapacityBytes -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">-- | A pure snapshot of the contents of the mempool. It allows fetching</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- information about transactions in the mempool, and fetching individual</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- transactions.</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- This uses a transaction sequence number type for identifying transactions</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- within the mempool sequence. The sequence number is local to this mempool,</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- unlike the transaction hash. This allows us to ask for all transactions</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- after a known sequence number, to get new transactions. It is also used to</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- look up individual transactions.</span><span>
</span><span id="line-280"></span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span class="hs-comment">-- Note that it is expected that 'getTx' will often return 'Nothing'</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- even for tx sequence numbers returned in previous snapshots. This happens</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- when the transaction has been removed from the mempool between snapshots.</span><span>
</span><span id="line-284"></span><span class="hs-comment">--</span><span>
</span><span id="line-285"></span><span class="hs-keyword">data</span><span> </span><span id="MempoolSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-var">MempoolSnapshot</span></a></span></span><span> </span><span id="local-6989586621680009359"><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621680009358"><span class="annot"><a href="#local-6989586621680009358"><span class="hs-identifier hs-type">idx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MempoolSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-var">MempoolSnapshot</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">-- | Get all transactions (oldest to newest) in the mempool snapshot along</span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-comment">-- with their ticket number.</span><span>
</span><span id="line-288"></span><span>    </span><span id="snapshotTxs"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; [(GenTx blk, idx)]
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotTxs"><span class="hs-identifier hs-var hs-var">snapshotTxs</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680009358"><span class="hs-identifier hs-type">idx</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-comment">-- | Get all transactions (oldest to newest) in the mempool snapshot,</span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-comment">-- along with their ticket number, which are associated with a ticket</span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-comment">-- number greater than the one provided.</span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotTxsAfter"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; idx -&gt; [(GenTx blk, idx)]
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotTxsAfter"><span class="hs-identifier hs-var hs-var">snapshotTxsAfter</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680009358"><span class="hs-identifier hs-type">idx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680009358"><span class="hs-identifier hs-type">idx</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- | Get as many transactions (oldest to newest) from the mempool</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">-- snapshot, along with their ticket number, such that their combined size</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-comment">-- is &lt;= the given limit (in bytes).</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotTxsForSize"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; TxSizeInBytes -&gt; [(GenTx blk, idx)]
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotTxsForSize"><span class="hs-identifier hs-var hs-var">snapshotTxsForSize</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680009358"><span class="hs-identifier hs-type">idx</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-comment">-- | Get a specific transaction from the mempool snapshot by its ticket</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-comment">-- number, if it exists.</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotLookupTx"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; idx -&gt; Maybe (GenTx blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotLookupTx"><span class="hs-identifier hs-var hs-var">snapshotLookupTx</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680009358"><span class="hs-identifier hs-type">idx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-comment">-- | Determine whether a specific transaction exists within the mempool</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- snapshot.</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotHasTx"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; GenTxId blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotHasTx"><span class="hs-identifier hs-var hs-var">snapshotHasTx</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- | Get the size of the mempool snapshot.</span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotMempoolSize"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotMempoolSize"><span class="hs-identifier hs-var hs-var">snapshotMempoolSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">-- | The block number of the &quot;virtual block&quot; under construction</span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotSlotNo"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotSlotNo"><span class="hs-identifier hs-var hs-var">snapshotSlotNo</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.2/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- | The ledger state after all transactions in the snapshot</span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotLedgerState"><span class="annot"><span class="annottext">MempoolSnapshot blk idx -&gt; TickedLedgerState blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotLedgerState"><span class="hs-identifier hs-var hs-var">snapshotLedgerState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#TickedLedgerState"><span class="hs-identifier hs-type">TickedLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009359"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-comment">-- | The size of a mempool.</span><span>
</span><span id="line-319"></span><span class="hs-keyword">data</span><span> </span><span id="MempoolSize"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-var">MempoolSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MempoolSize"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-var">MempoolSize</span></a></span></span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="msNumTxs"><span class="annot"><span class="annottext">MempoolSize -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#msNumTxs"><span class="hs-identifier hs-var hs-var">msNumTxs</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">-- ^ The number of transactions in the mempool.</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msNumBytes"><span class="annot"><span class="annottext">MempoolSize -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#msNumBytes"><span class="hs-identifier hs-var hs-var">msNumBytes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- ^ The summed byte size of all the transactions in the mempool.</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680009224"><span id="local-6989586621680009226"><span class="annot"><span class="annottext">MempoolSize -&gt; MempoolSize -&gt; Bool
(MempoolSize -&gt; MempoolSize -&gt; Bool)
-&gt; (MempoolSize -&gt; MempoolSize -&gt; Bool) -&gt; Eq MempoolSize
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: MempoolSize -&gt; MempoolSize -&gt; Bool
$c/= :: MempoolSize -&gt; MempoolSize -&gt; Bool
== :: MempoolSize -&gt; MempoolSize -&gt; Bool
$c== :: MempoolSize -&gt; MempoolSize -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680009218"><span id="local-6989586621680009220"><span id="local-6989586621680009222"><span class="annot"><span class="annottext">Int -&gt; MempoolSize -&gt; ShowS
[MempoolSize] -&gt; ShowS
MempoolSize -&gt; String
(Int -&gt; MempoolSize -&gt; ShowS)
-&gt; (MempoolSize -&gt; String)
-&gt; ([MempoolSize] -&gt; ShowS)
-&gt; Show MempoolSize
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MempoolSize] -&gt; ShowS
$cshowList :: [MempoolSize] -&gt; ShowS
show :: MempoolSize -&gt; String
$cshow :: MempoolSize -&gt; String
showsPrec :: Int -&gt; MempoolSize -&gt; ShowS
$cshowsPrec :: Int -&gt; MempoolSize -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680009213"><span id="local-6989586621680009215"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-327"></span><span>  </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span> </span><span id="local-6989586621680009211"><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009211"><span class="hs-identifier hs-var">xt</span></a></span></span><span> </span><span id="local-6989586621680009210"><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009210"><span class="hs-identifier hs-var">xb</span></a></span></span><span> </span><span id="local-6989586621680009209"><span class="annot"><span class="annottext">&lt;&gt; :: MempoolSize -&gt; MempoolSize -&gt; MempoolSize
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span> </span><span id="local-6989586621680009208"><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009208"><span class="hs-identifier hs-var">yt</span></a></span></span><span> </span><span id="local-6989586621680009207"><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009207"><span class="hs-identifier hs-var">yb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes -&gt; TxSizeInBytes -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-var">MempoolSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009211"><span class="hs-identifier hs-var">xt</span></a></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes -&gt; TxSizeInBytes -&gt; TxSizeInBytes
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009208"><span class="hs-identifier hs-var">yt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009210"><span class="hs-identifier hs-var">xb</span></a></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes -&gt; TxSizeInBytes -&gt; TxSizeInBytes
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621680009207"><span class="hs-identifier hs-var">yb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680009202"><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-330"></span><span>  </span><span id="local-6989586621680009200"><span class="annot"><span class="annottext">mempty :: MempoolSize
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolSize :: TxSizeInBytes -&gt; TxSizeInBytes -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">msNumTxs :: TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#msNumTxs"><span class="hs-identifier hs-var">msNumTxs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msNumBytes :: TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#msNumBytes"><span class="hs-identifier hs-var">msNumBytes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-331"></span><span>  </span><span id="local-6989586621680009199"><span class="annot"><span class="annottext">mappend :: MempoolSize -&gt; MempoolSize -&gt; MempoolSize
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mappend</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolSize -&gt; MempoolSize -&gt; MempoolSize
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(&lt;&gt;)</span></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span class="hs-comment">-- | Events traced by the Mempool.</span><span>
</span><span id="line-334"></span><span class="hs-keyword">data</span><span> </span><span id="TraceEventMempool"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceEventMempool"><span class="hs-identifier hs-var">TraceEventMempool</span></a></span></span><span> </span><span id="local-6989586621680009198"><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TraceMempoolAddedTx"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceMempoolAddedTx"><span class="hs-identifier hs-var">TraceMempoolAddedTx</span></a></span></span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>      </span><span class="hs-comment">-- ^ New, valid transaction that was added to the Mempool.</span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span>
</span><span id="line-339"></span><span>      </span><span class="hs-comment">-- ^ The size of the Mempool before adding the transaction.</span><span>
</span><span id="line-340"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-comment">-- ^ The size of the Mempool after adding the transaction.</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceMempoolRejectedTx"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceMempoolRejectedTx"><span class="hs-identifier hs-var">TraceMempoolRejectedTx</span></a></span></span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-comment">-- ^ New, invalid transaction thas was rejected and thus not added to</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-comment">-- the Mempool.</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>      </span><span class="hs-comment">-- ^ The reason for rejecting the transaction.</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span>
</span><span id="line-349"></span><span>      </span><span class="hs-comment">-- ^ The current size of the Mempool.</span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceMempoolRemoveTxs"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceMempoolRemoveTxs"><span class="hs-identifier hs-var">TraceMempoolRemoveTxs</span></a></span></span><span>
</span><span id="line-351"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-comment">-- ^ Previously valid transactions that are no longer valid because of</span><span>
</span><span id="line-353"></span><span>      </span><span class="hs-comment">-- changes in the ledger state. These transactions have been removed</span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-comment">-- from the Mempool.</span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="hs-comment">-- ^ The current size of the Mempool.</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceMempoolManuallyRemovedTxs"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceMempoolManuallyRemovedTxs"><span class="hs-identifier hs-var">TraceMempoolManuallyRemovedTxs</span></a></span></span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>      </span><span class="hs-comment">-- ^ Transactions that have been manually removed from the Mempool.</span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-comment">-- ^ Previously valid transactions that are no longer valid because they</span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-comment">-- dependend on transactions that were manually removed from the</span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-comment">-- Mempool. These transactions have also been removed from the Mempool.</span><span>
</span><span id="line-364"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-comment">-- This list shares not transactions with the list of manually removed</span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-comment">-- transactions.</span><span>
</span><span id="line-367"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSize"><span class="hs-identifier hs-type">MempoolSize</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="hs-comment">-- ^ The current size of the Mempool.</span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span id="local-6989586621680009189"><span id="local-6989586621680009191"><span id="local-6989586621680009193"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009193"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009193"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009193"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>                  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceEventMempool"><span class="hs-identifier hs-type">TraceEventMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009193"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span id="local-6989586621680009182"><span id="local-6989586621680009184"><span id="local-6989586621680009186"><span id="local-6989586621680009188"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009188"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009188"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009188"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>                  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#TraceEventMempool"><span class="hs-identifier hs-type">TraceEventMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680009188"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-379"></span></pre></body></html>