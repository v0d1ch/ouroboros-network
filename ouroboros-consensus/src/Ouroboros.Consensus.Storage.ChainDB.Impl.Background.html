<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms     #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- | Background tasks:</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- * Copying blocks from the VolatileDB to the ImmutableDB</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- * Performing and scheduling garbage collections on the VolatileDB</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- * Writing snapshots of the LedgerDB to disk and deleting old ones</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- * Executing scheduled chain selections</span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Launch background tasks</span></span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#launchBgTasks"><span class="hs-identifier">launchBgTasks</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Copying blocks from the VolatileDB to the ImmutableDB</span></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyAndSnapshotRunner"><span class="hs-identifier">copyAndSnapshotRunner</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmutableDB"><span class="hs-identifier">copyToImmutableDB</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots"><span class="hs-identifier">updateLedgerSnapshots</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Executing garbage collection</span></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect"><span class="hs-identifier">garbageCollect</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Scheduling garbage collections</span></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier">GcParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier">GcSchedule</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#computeTimeForGC"><span class="hs-identifier">computeTimeForGC</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcScheduleRunner"><span class="hs-identifier">gcScheduleRunner</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#newGcSchedule"><span class="hs-identifier">newGcSchedule</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduleGC"><span class="hs-identifier">scheduleGC</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Testing</span></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier">ScheduledGc</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#dumpGcSchedule"><span class="hs-identifier">dumpGcSchedule</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Adding blocks to the ChainDB</span></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner"><span class="hs-identifier">addBlockRunner</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">forever</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Sequence.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StrictSeq</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Sequence.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Seq</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier">Data.Time.Clock</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">AnchoredSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Config.html"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Abstract</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Abstract</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#.%3A"><span class="hs-operator">(.:)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Condense.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Condense</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier">BlockComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel</span></a></span><span>
</span><span id="line-71"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier">addBlockSync</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span>
</span><span id="line-73"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDbSerialiseConstraints"><span class="hs-identifier">LgrDbSerialiseConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LgrDB</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Types</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImmutableDB</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy</span></a></span><span>
</span><span id="line-78"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#TimeSinceLast"><span class="hs-identifier">TimeSinceLast</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VolatileDB</span></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Launch background tasks
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#launchBgTasks"><span class="hs-identifier hs-type">launchBgTasks</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680022824"><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680022823"><span class="annot"><a href="#local-6989586621680022823"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-87"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-88"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022823"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-89"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022823"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-90"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022823"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-91"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDbSerialiseConstraints"><span class="hs-identifier hs-type">LgrDbSerialiseConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022823"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-92"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022823"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-comment">-- ^ Number of immutable blocks replayed on ledger DB startup</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span id="launchBgTasks"><span class="annot"><span class="annottext">launchBgTasks :: ChainDbEnv m blk -&gt; Word64 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#launchBgTasks"><span class="hs-identifier hs-var hs-var">launchBgTasks</span></a></span></span><span> </span><span id="local-6989586621680022822"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621680022822"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022799"><span id="local-6989586621680022800"><span id="local-6989586621680022801"><span id="local-6989586621680022802"><span id="local-6989586621680022803"><span id="local-6989586621680022804"><span id="local-6989586621680022805"><span id="local-6989586621680022806"><span id="local-6989586621680022807"><span id="local-6989586621680022808"><span id="local-6989586621680022809"><span id="local-6989586621680022810"><span id="local-6989586621680022811"><span id="local-6989586621680022812"><span id="local-6989586621680022813"><span id="local-6989586621680022814"><span id="local-6989586621680022815"><span id="local-6989586621680022816"><span id="local-6989586621680022817"><span id="local-6989586621680022818"><span id="local-6989586621680022819"><span id="local-6989586621680022820"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbFutureBlocks"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680022776"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022776"><span class="hs-identifier hs-var">replayed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621680022775"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680022775"><span class="hs-identifier hs-var">addBlockThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m Void -&gt; m (m ())
</span><a href="#local-6989586621680022774"><span class="hs-identifier hs-var">launch</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainDB.addBlockRunner&quot;</span></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; m (m ())) -&gt; m Void -&gt; m (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-98"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m Void
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner"><span class="hs-identifier hs-var">addBlockRunner</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022822"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621680022773"><span class="annot"><span class="annottext">GcSchedule m
</span><a href="#local-6989586621680022773"><span class="hs-identifier hs-var">gcSchedule</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (GcSchedule m)
forall (m :: * -&gt; *). IOLike m =&gt; m (GcSchedule m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#newGcSchedule"><span class="hs-identifier hs-var">newGcSchedule</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621680022772"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680022772"><span class="hs-identifier hs-var">gcThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m Void -&gt; m (m ())
</span><a href="#local-6989586621680022774"><span class="hs-identifier hs-var">launch</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainDB.gcScheduleRunner&quot;</span></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; m (m ())) -&gt; m Void -&gt; m (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="annottext">GcSchedule m -&gt; (SlotNo -&gt; m ()) -&gt; m Void
forall (m :: * -&gt; *).
IOLike m =&gt;
GcSchedule m -&gt; (SlotNo -&gt; m ()) -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcScheduleRunner"><span class="hs-identifier hs-var">gcScheduleRunner</span></a></span><span> </span><span class="annot"><span class="annottext">GcSchedule m
</span><a href="#local-6989586621680022773"><span class="hs-identifier hs-var">gcSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; m ()) -&gt; m Void) -&gt; (SlotNo -&gt; m ()) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; SlotNo -&gt; m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDbEnv m blk -&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect"><span class="hs-identifier hs-var">garbageCollect</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022822"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621680022771"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680022771"><span class="hs-identifier hs-var">copyAndSnapshotThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m Void -&gt; m (m ())
</span><a href="#local-6989586621680022774"><span class="hs-identifier hs-var">launch</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainDB.copyAndSnapshotRunner&quot;</span></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; m (m ())) -&gt; m Void -&gt; m (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; GcSchedule m -&gt; Word64 -&gt; m Void
forall (m :: * -&gt; *) blk.
(IOLike m, ConsensusProtocol (BlockProtocol blk), HasHeader blk,
 GetHeader blk, IsLedger (LedgerState blk),
 LgrDbSerialiseConstraints blk) =&gt;
ChainDbEnv m blk -&gt; GcSchedule m -&gt; Word64 -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyAndSnapshotRunner"><span class="hs-identifier hs-var">copyAndSnapshotRunner</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022822"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">GcSchedule m
</span><a href="#local-6989586621680022773"><span class="hs-identifier hs-var">gcSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022776"><span class="hs-identifier hs-var">replayed</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (m ()) -&gt; m () -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (m ())
</span><a href="#local-6989586621680022804"><span class="hs-identifier hs-var">cdbKillBgThreads</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; STM m ()) -&gt; m () -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-105"></span><span>      </span><span class="annot"><span class="annottext">[m ()] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">sequence_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680022775"><span class="hs-identifier hs-var">addBlockThread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680022772"><span class="hs-identifier hs-var">gcThread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680022771"><span class="hs-identifier hs-var">copyAndSnapshotThread</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><a href="#local-6989586621680022774"><span class="hs-identifier hs-type">launch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680022824"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621680022774"><span class="annot"><span class="annottext">launch :: String -&gt; m Void -&gt; m (m ())
</span><a href="#local-6989586621680022774"><span class="hs-identifier hs-var hs-var">launch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Thread m Void -&gt; m ()) -&gt; m (Thread m Void) -&gt; m (m ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m Void -&gt; m ()
forall (m :: * -&gt; *) a. IOLike m =&gt; Thread m a -&gt; m ()
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#cancelThread"><span class="hs-identifier hs-var">cancelThread</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Thread m Void) -&gt; m (m ()))
-&gt; (String -&gt; m Void -&gt; m (Thread m Void))
-&gt; String
-&gt; m Void
-&gt; m (m ())
forall y z x0 x1. (y -&gt; z) -&gt; (x0 -&gt; x1 -&gt; y) -&gt; x0 -&gt; x1 -&gt; z
</span><a href="Ouroboros.Consensus.Util.html#.%3A"><span class="hs-operator hs-var">.:</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m Void -&gt; m (Thread m Void)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#forkLinkedThread"><span class="hs-identifier hs-var">forkLinkedThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621680022807"><span class="hs-identifier hs-var">cdbRegistry</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Copying blocks from the VolatileDB to the ImmutableDB
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="hs-comment">-- | Copy the blocks older than @k@ from the VolatileDB to the ImmutableDB.</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- These headers of these blocks can be retrieved by dropping the @k@ most</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- recent blocks from the fragment stored in 'cdbChain'.</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- The copied blocks are removed from the fragment stored in 'cdbChain'.</span><span>
</span><span id="line-120"></span><span class="hs-comment">--</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- This function does not remove blocks from the VolatileDB.</span><span>
</span><span id="line-122"></span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- The 'SlotNo' of the tip of the ImmutableDB after copying the blocks is</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- returned. This can be used for a garbage collection on the VolatileDB.</span><span>
</span><span id="line-125"></span><span class="hs-comment">--</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- NOTE: this function would not be safe when called multiple times</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- concurrently. To enforce thread-safety, a lock is obtained at the start of</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- this function and released at the end. So in practice, this function can be</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- called multiple times concurrently, but the calls will be serialised.</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- NOTE: this function /can/ run concurrently with all other functions, just</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- not with itself.</span><span>
</span><span id="line-133"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmutableDB"><span class="hs-identifier hs-type">copyToImmutableDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-134"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680022926"><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680022925"><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-135"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-136"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-138"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetHeader"><span class="hs-identifier hs-type">GetHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-139"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-140"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span id="copyToImmutableDB"><span class="annot"><span class="annottext">copyToImmutableDB :: ChainDbEnv m blk -&gt; m (WithOrigin SlotNo)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmutableDB"><span class="hs-identifier hs-var hs-var">copyToImmutableDB</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022744"><span id="local-6989586621680022745"><span id="local-6989586621680022746"><span id="local-6989586621680022747"><span id="local-6989586621680022748"><span id="local-6989586621680022749"><span id="local-6989586621680022750"><span id="local-6989586621680022751"><span id="local-6989586621680022752"><span id="local-6989586621680022753"><span id="local-6989586621680022754"><span id="local-6989586621680022755"><span id="local-6989586621680022756"><span id="local-6989586621680022757"><span id="local-6989586621680022758"><span id="local-6989586621680022759"><span id="local-6989586621680022760"><span id="local-6989586621680022761"><span id="local-6989586621680022762"><span id="local-6989586621680022763"><span id="local-6989586621680022764"><span id="local-6989586621680022765"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
</span><a href="#local-6989586621680022744"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo)
forall a. HasCallStack =&gt; m a -&gt; m a
</span><a href="#local-6989586621680022743"><span class="hs-identifier hs-var">withCopyLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo))
-&gt; m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621680022742"><span class="annot"><span class="annottext">[Point blk]
</span><a href="#local-6989586621680022742"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m [Point blk] -&gt; m [Point blk]
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m [Point blk] -&gt; m [Point blk])
-&gt; STM m [Point blk] -&gt; m [Point blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>      </span><span id="local-6989586621680022741"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022741"><span class="hs-identifier hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680022762"><span class="hs-identifier hs-var">cdbChain</span></a></span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680022739"><span class="annot"><span class="annottext">nbToCopy :: Int
</span><a href="#local-6989586621680022739"><span class="hs-identifier hs-var hs-var">nbToCopy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022741"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022736"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>          </span><span class="annot"><a href="#local-6989586621680022735"><span class="hs-identifier hs-type">toCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-148"></span><span>          </span><span id="local-6989586621680022735"><span class="annot"><span class="annottext">toCopy :: [Point blk]
</span><a href="#local-6989586621680022735"><span class="hs-identifier hs-var hs-var">toCopy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; Point blk) -&gt; [Header blk] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span>
</span><span id="line-149"></span><span>                 </span><span class="annot"><span class="annottext">([Header blk] -&gt; [Point blk]) -&gt; [Header blk] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.toOldestFirst</span></a></span><span>
</span><span id="line-150"></span><span>                 </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; [Header blk])
-&gt; AnchoredFragment (Header blk) -&gt; [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; AnchoredFragment (Header blk) -&gt; AnchoredFragment (Header blk)
forall v a b.
Anchorable v a b =&gt;
Int -&gt; AnchoredSeq v a b -&gt; AnchoredSeq v a b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.takeOldest</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680022739"><span class="hs-identifier hs-var">nbToCopy</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022741"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">[Point blk] -&gt; STM m [Point blk]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[Point blk]
</span><a href="#local-6989586621680022735"><span class="hs-identifier hs-var">toCopy</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Point blk] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Point blk]
</span><a href="#local-6989586621680022742"><span class="hs-identifier hs-var">toCopy</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-comment">-- This can't happen in practice, as we're only called when the fragment</span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-comment">-- is longer than @k@. However, in the tests, we will be calling this</span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-comment">-- function manually, which means it might be called when there are no</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- blocks to copy.</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TraceCopyToImmutableDBEvent blk -&gt; m ()
</span><a href="#local-6989586621680022730"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">TraceCopyToImmutableDBEvent blk
forall blk. TraceCopyToImmutableDBEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#NoBlocksToCopyToImmutableDB"><span class="hs-identifier hs-var">NoBlocksToCopyToImmutableDB</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Point blk] -&gt; (Point blk -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Point blk]
</span><a href="#local-6989586621680022742"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">((Point blk -&gt; m ()) -&gt; m ()) -&gt; (Point blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680022728"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022728"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680022727"><span class="annot"><span class="annottext">hash :: HeaderHash blk
</span><a href="#local-6989586621680022727"><span class="hs-identifier hs-var hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; ChainHash blk
forall block. Point block -&gt; ChainHash block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">pointHash</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022728"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-161"></span><span>              </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">BlockHash</span></a></span><span> </span><span id="local-6989586621680022724"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680022724"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680022724"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-162"></span><span>              </span><span class="hs-comment">-- There is no actual genesis block that can occur on a chain</span><span>
</span><span id="line-163"></span><span>              </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">GenesisHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; HeaderHash blk
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;genesis block on current chain&quot;</span></span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621680022721"><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><a href="#local-6989586621680022721"><span class="hs-identifier hs-var">slotNoAtImmutableDBTip</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo))
-&gt; STM m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; STM m (WithOrigin SlotNo)
forall (m :: * -&gt; *) blk.
(MonadSTM m, HasCallStack) =&gt;
ImmutableDB m blk -&gt; STM m (WithOrigin SlotNo)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getTipSlot"><span class="hs-identifier hs-var">ImmutableDB.getTipSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621680022765"><span class="hs-identifier hs-var">cdbImmutableDB</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; WithOrigin SlotNo
forall block. Point block -&gt; WithOrigin SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">pointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022728"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo -&gt; WithOrigin SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><a href="#local-6989586621680022721"><span class="hs-identifier hs-var">slotNoAtImmutableDBTip</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-comment">-- When the block is corrupt, the function below will throw an</span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-comment">-- exception. This exception will make sure that we shut down the node</span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-comment">-- and that the next time we start, validation will be enabled.</span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621680022718"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680022718"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; BlockComponent blk blk -&gt; HeaderHash blk -&gt; m blk
forall (m :: * -&gt; *) blk b.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk -&gt; BlockComponent blk b -&gt; HeaderHash blk -&gt; m b
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getKnownBlockComponent"><span class="hs-identifier hs-var">VolatileDB.getKnownBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680022764"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk blk
forall blk. BlockComponent blk blk
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetVerifiedBlock"><span class="hs-identifier hs-var">GetVerifiedBlock</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621680022727"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-comment">-- We're the only one modifying the ImmutableDB, so the tip cannot</span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-comment">-- have changed since we last checked it.</span><span>
</span><span id="line-172"></span><span>        </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; blk -&gt; m ()
forall (m :: * -&gt; *) blk.
HasCallStack =&gt;
ImmutableDB m blk -&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#appendBlock"><span class="hs-identifier hs-var">ImmutableDB.appendBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621680022765"><span class="hs-identifier hs-var">cdbImmutableDB</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621680022718"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-comment">-- TODO the invariant of 'cdbChain' is shortly violated between</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-comment">-- these two lines: the tip was updated on the line above, but the</span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-comment">-- anchor point is only updated on the line below.</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; STM m ()
</span><a href="#local-6989586621680022714"><span class="hs-identifier hs-var">removeFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022728"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-177"></span><span>        </span><span class="annot"><span class="annottext">TraceCopyToImmutableDBEvent blk -&gt; m ()
</span><a href="#local-6989586621680022730"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceCopyToImmutableDBEvent blk -&gt; m ())
-&gt; TraceCopyToImmutableDBEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; TraceCopyToImmutableDBEvent blk
forall blk. Point blk -&gt; TraceCopyToImmutableDBEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CopiedBlockToImmutableDB"><span class="hs-identifier hs-var">CopiedBlockToImmutableDB</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022728"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-comment">-- Get the /possibly/ updated tip of the ImmutableDB</span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">STM m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo))
-&gt; STM m (WithOrigin SlotNo) -&gt; m (WithOrigin SlotNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; STM m (WithOrigin SlotNo)
forall (m :: * -&gt; *) blk.
(MonadSTM m, HasCallStack) =&gt;
ImmutableDB m blk -&gt; STM m (WithOrigin SlotNo)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getTipSlot"><span class="hs-identifier hs-var">ImmutableDB.getTipSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621680022765"><span class="hs-identifier hs-var">cdbImmutableDB</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621680022736"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022736"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; SecurityParam
forall blk.
ConsensusProtocol (BlockProtocol blk) =&gt;
TopLevelConfig blk -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Config.html#configSecurityParam"><span class="hs-identifier hs-var">configSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680022759"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span id="local-6989586621680022730"><span class="annot"><span class="annottext">trace :: TraceCopyToImmutableDBEvent blk -&gt; m ()
</span><a href="#local-6989586621680022730"><span class="hs-identifier hs-var hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceCopyToImmutableDBEvent blk)
-&gt; TraceCopyToImmutableDBEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceCopyToImmutableDBEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk)
-&gt; Tracer m (TraceCopyToImmutableDBEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceCopyToImmutableDBEvent blk -&gt; TraceEvent blk
forall blk. TraceCopyToImmutableDBEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceCopyToImmutableDBEvent"><span class="hs-identifier hs-var">TraceCopyToImmutableDBEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680022754"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-comment">-- | Remove the header corresponding to the given point from the beginning</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- of the current chain fragment.</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- PRECONDITION: the header must be the first one (oldest) in the chain</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><a href="#local-6989586621680022714"><span class="hs-identifier hs-type">removeFromChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022925"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621680022714"><span class="annot"><span class="annottext">removeFromChain :: Point blk -&gt; STM m ()
</span><a href="#local-6989586621680022714"><span class="hs-identifier hs-var hs-var">removeFromChain</span></a></span></span><span> </span><span id="local-6989586621680022707"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022707"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-comment">-- The chain might have been extended in the meantime.</span><span>
</span><span id="line-192"></span><span>      </span><span id="local-6989586621680022706"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022706"><span class="hs-identifier hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680022762"><span class="hs-identifier hs-var">cdbChain</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022706"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-194"></span><span>        </span><span id="local-6989586621680022705"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680022705"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-operator hs-type">:&lt;</span></a></span><span> </span><span id="local-6989586621680022703"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022703"><span class="hs-identifier hs-var">curChain'</span></a></span></span><span>
</span><span id="line-195"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621680022705"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621680022707"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-196"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680022762"><span class="hs-identifier hs-var">cdbChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022703"><span class="hs-identifier hs-var">curChain'</span></a></span><span>
</span><span id="line-197"></span><span>        </span><span class="hs-comment">-- We're the only one removing things from 'curChain', so this cannot</span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-comment">-- happen if the precondition was satisfied.</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; STM m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;header to remove not on the current chain&quot;</span></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="#local-6989586621680022743"><span class="hs-identifier hs-type">withCopyLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680023009"><span class="annot"><a href="#local-6989586621680023009"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023009"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022926"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023009"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621680022743"><span class="annot"><span class="annottext">withCopyLock :: m a -&gt; m a
</span><a href="#local-6989586621680022743"><span class="hs-identifier hs-var hs-var">withCopyLock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; m b -&gt; m c -&gt; m c
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">bracket_</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe () -&gt; ()) -&gt; m (Maybe ()) -&gt; m ()
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; ()
forall b. HasCallStack =&gt; Maybe b -&gt; b
</span><a href="#local-6989586621680022701"><span class="hs-identifier hs-var">mustBeUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe ()) -&gt; m ()) -&gt; m (Maybe ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMVar m () -&gt; m (Maybe ())
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictMVar m a -&gt; m (Maybe a)
</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#tryTakeMVar"><span class="hs-identifier hs-var">tryTakeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMVar m ()
</span><a href="#local-6989586621680022755"><span class="hs-identifier hs-var">cdbCopyLock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictMVar m () -&gt; () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictMVar m a -&gt; a -&gt; m ()
</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span>  </span><span class="annot"><span class="annottext">StrictMVar m ()
</span><a href="#local-6989586621680022755"><span class="hs-identifier hs-var">cdbCopyLock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621680022701"><span class="hs-identifier hs-type">mustBeUnlocked</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680022945"><span class="annot"><a href="#local-6989586621680022945"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022945"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022945"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621680022701"><span class="annot"><span class="annottext">mustBeUnlocked :: Maybe b -&gt; b
</span><a href="#local-6989586621680022701"><span class="hs-identifier hs-var hs-var">mustBeUnlocked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe b -&gt; b
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span>
</span><span id="line-208"></span><span>                   </span><span class="annot"><span class="annottext">(b -&gt; Maybe b -&gt; b) -&gt; b -&gt; Maybe b -&gt; b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; b
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;copyToImmutableDB running concurrently with itself&quot;</span></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | Copy blocks from the VolatileDB to ImmutableDB and take snapshots of the</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- LgrDB</span><span>
</span><span id="line-212"></span><span class="hs-comment">--</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- We watch the chain for changes. Whenever the chain is longer than @k@, then</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- the headers older than @k@ are copied from the VolatileDB to the ImmutableDB</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- (using 'copyToImmutableDB'). Once that is complete,</span><span>
</span><span id="line-216"></span><span class="hs-comment">--</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- * We periodically take a snapshot of the LgrDB (depending on its config).</span><span>
</span><span id="line-218"></span><span class="hs-comment">--   When enough blocks (depending on its config) have been replayed during</span><span>
</span><span id="line-219"></span><span class="hs-comment">--   startup, a snapshot of the replayed LgrDB will be written to disk at the</span><span>
</span><span id="line-220"></span><span class="hs-comment">--   start of this function.</span><span>
</span><span id="line-221"></span><span class="hs-comment">--   NOTE: After this initial snapshot we do not take a snapshot of the LgrDB</span><span>
</span><span id="line-222"></span><span class="hs-comment">--   until the chain has changed again, irrespective of the LgrDB policy.</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- * Schedule GC of the VolatileDB ('scheduleGC') for the 'SlotNo' of the most</span><span>
</span><span id="line-224"></span><span class="hs-comment">--   recent block that was copied.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- It is important that we only take LgrDB snapshots when are are /sure/ they</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- have been copied to the ImmutableDB, since the LgrDB assumes that all</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- snapshots correspond to immutable blocks. (Of course, data corruption can</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- occur and we can handle it by reverting to an older LgrDB snapshot, but we</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- should need this only in exceptional circumstances.)</span><span>
</span><span id="line-231"></span><span class="hs-comment">--</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- We do not store any state of the VolatileDB GC. If the node shuts down before</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- GC can happen, when we restart the node and schedule the /next/ GC, it will</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- /imply/ any previously scheduled GC, since GC is driven by slot number</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- (&quot;garbage collect anything older than @x@&quot;).</span><span>
</span><span id="line-236"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyAndSnapshotRunner"><span class="hs-identifier hs-type">copyAndSnapshotRunner</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680023042"><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680023041"><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-238"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-239"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-241"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetHeader"><span class="hs-identifier hs-type">GetHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-242"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#IsLedger"><span class="hs-identifier hs-type">IsLedger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDbSerialiseConstraints"><span class="hs-identifier hs-type">LgrDbSerialiseConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-244"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023041"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-comment">-- ^ Number of immutable blocks replayed on ledger DB startup</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-249"></span><span id="copyAndSnapshotRunner"><span class="annot"><span class="annottext">copyAndSnapshotRunner :: ChainDbEnv m blk -&gt; GcSchedule m -&gt; Word64 -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyAndSnapshotRunner"><span class="hs-identifier hs-var hs-var">copyAndSnapshotRunner</span></a></span></span><span> </span><span id="local-6989586621680022698"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621680022698"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022676"><span id="local-6989586621680022677"><span id="local-6989586621680022678"><span id="local-6989586621680022679"><span id="local-6989586621680022680"><span id="local-6989586621680022681"><span id="local-6989586621680022682"><span id="local-6989586621680022683"><span id="local-6989586621680022684"><span id="local-6989586621680022685"><span id="local-6989586621680022686"><span id="local-6989586621680022687"><span id="local-6989586621680022688"><span id="local-6989586621680022689"><span id="local-6989586621680022690"><span id="local-6989586621680022691"><span id="local-6989586621680022692"><span id="local-6989586621680022693"><span id="local-6989586621680022694"><span id="local-6989586621680022695"><span id="local-6989586621680022696"><span id="local-6989586621680022697"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
</span><a href="#local-6989586621680022676"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680022675"><span class="annot"><span class="annottext">GcSchedule m
</span><a href="#local-6989586621680022675"><span class="hs-identifier hs-var">gcSchedule</span></a></span></span><span> </span><span id="local-6989586621680022674"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022674"><span class="hs-identifier hs-var">replayed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
</span><a href="#local-6989586621680022673"><span class="hs-identifier hs-var">onDiskShouldTakeSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSinceLast DiffTime
forall time. TimeSinceLast time
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#NoSnapshotTakenYet"><span class="hs-identifier hs-var">NoSnapshotTakenYet</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022674"><span class="hs-identifier hs-var">replayed</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, LgrDbSerialiseConstraints blk, HasHeader blk,
 IsLedger (LedgerState blk)) =&gt;
ChainDbEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots"><span class="hs-identifier hs-var">updateLedgerSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022698"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-252"></span><span>      </span><span id="local-6989586621680022671"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022671"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="annottext">TimeSinceLast Time -&gt; Word64 -&gt; m Void
</span><a href="#local-6989586621680022669"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Time -&gt; TimeSinceLast Time
forall time. time -&gt; TimeSinceLast time
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#TimeSinceLast"><span class="hs-identifier hs-var">TimeSinceLast</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022671"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-keyword">else</span><span>
</span><span id="line-255"></span><span>      </span><span class="annot"><span class="annottext">TimeSinceLast Time -&gt; Word64 -&gt; m Void
</span><a href="#local-6989586621680022669"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSinceLast Time
forall time. TimeSinceLast time
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#NoSnapshotTakenYet"><span class="hs-identifier hs-var">NoSnapshotTakenYet</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022674"><span class="hs-identifier hs-var">replayed</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621680022667"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022667"><span class="hs-identifier hs-var">k</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; SecurityParam
forall blk.
ConsensusProtocol (BlockProtocol blk) =&gt;
TopLevelConfig blk -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Config.html#configSecurityParam"><span class="hs-identifier hs-var">configSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621680022691"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#DiskPolicy"><span class="hs-identifier hs-type">LgrDB.DiskPolicy</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022665"><span id="local-6989586621680022673"><span class="annot"><span class="annottext">Word
TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
onDiskShouldTakeSnapshot :: DiskPolicy -&gt; TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
onDiskNumSnapshots :: DiskPolicy -&gt; Word
onDiskNumSnapshots :: Word
onDiskShouldTakeSnapshot :: TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#onDiskShouldTakeSnapshot"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; DiskPolicy
forall (m :: * -&gt; *) blk. LgrDB m blk -&gt; DiskPolicy
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getDiskPolicy"><span class="hs-identifier hs-var">LgrDB.getDiskPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680022695"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><a href="#local-6989586621680022669"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#TimeSinceLast"><span class="hs-identifier hs-type">TimeSinceLast</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">Time</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621680022669"><span class="annot"><span class="annottext">loop :: TimeSinceLast Time -&gt; Word64 -&gt; m Void
</span><a href="#local-6989586621680022669"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621680022661"><span class="annot"><span class="annottext">TimeSinceLast Time
</span><a href="#local-6989586621680022661"><span class="hs-identifier hs-var">mPrevSnapshot</span></a></span></span><span> </span><span id="local-6989586621680022660"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022660"><span class="hs-identifier hs-var">distance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>      </span><span class="hs-comment">-- Wait for the chain to grow larger than @k@</span><span>
</span><span id="line-263"></span><span>      </span><span id="local-6989586621680022659"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022659"><span class="hs-identifier hs-var">numToWrite</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Word64 -&gt; m Word64
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m Word64 -&gt; m Word64) -&gt; STM m Word64 -&gt; m Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>        </span><span id="local-6989586621680022658"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022658"><span class="hs-identifier hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621680022694"><span class="hs-identifier hs-var">cdbChain</span></a></span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m ()) -&gt; Bool -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022658"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022667"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; STM m Word64
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; STM m Word64) -&gt; Word64 -&gt; STM m Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.length</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621680022658"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022667"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-comment">-- Copy blocks to ImmutableDB</span><span>
</span><span id="line-269"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-270"></span><span>      </span><span class="hs-comment">-- This is a synchronous operation: when it returns, the blocks have been</span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-comment">-- copied to disk (though not flushed, necessarily).</span><span>
</span><span id="line-272"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m (WithOrigin SlotNo)
forall (m :: * -&gt; *) blk.
(IOLike m, ConsensusProtocol (BlockProtocol blk), HasHeader blk,
 GetHeader blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; m (WithOrigin SlotNo)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmutableDB"><span class="hs-identifier hs-var">copyToImmutableDB</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022698"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">m (WithOrigin SlotNo) -&gt; (WithOrigin SlotNo -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo -&gt; m ()
</span><a href="#local-6989586621680022655"><span class="hs-identifier hs-var">scheduleGC'</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621680022654"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022654"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680022653"><span class="annot"><span class="annottext">distance' :: Word64
</span><a href="#local-6989586621680022653"><span class="hs-identifier hs-var hs-var">distance'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022660"><span class="hs-identifier hs-var">distance</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022659"><span class="hs-identifier hs-var">numToWrite</span></a></span><span>
</span><span id="line-276"></span><span>          </span><span id="local-6989586621680022651"><span class="annot"><span class="annottext">elapsed :: TimeSinceLast DiffTime
</span><a href="#local-6989586621680022651"><span class="hs-identifier hs-var hs-var">elapsed</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680022650"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022650"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022654"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-operator hs-var">`diffTime`</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022650"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Time -&gt; DiffTime) -&gt; TimeSinceLast Time -&gt; TimeSinceLast DiffTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSinceLast Time
</span><a href="#local-6989586621680022661"><span class="hs-identifier hs-var">mPrevSnapshot</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TimeSinceLast DiffTime -&gt; Word64 -&gt; Bool
</span><a href="#local-6989586621680022673"><span class="hs-identifier hs-var">onDiskShouldTakeSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSinceLast DiffTime
</span><a href="#local-6989586621680022651"><span class="hs-identifier hs-var">elapsed</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022653"><span class="hs-identifier hs-var">distance'</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, LgrDbSerialiseConstraints blk, HasHeader blk,
 IsLedger (LedgerState blk)) =&gt;
ChainDbEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots"><span class="hs-identifier hs-var">updateLedgerSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022698"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="annot"><span class="annottext">TimeSinceLast Time -&gt; Word64 -&gt; m Void
</span><a href="#local-6989586621680022669"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Time -&gt; TimeSinceLast Time
forall time. time -&gt; TimeSinceLast time
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy.html#TimeSinceLast"><span class="hs-identifier hs-var">TimeSinceLast</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022654"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">TimeSinceLast Time -&gt; Word64 -&gt; m Void
</span><a href="#local-6989586621680022669"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSinceLast Time
</span><a href="#local-6989586621680022661"><span class="hs-identifier hs-var">mPrevSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680022653"><span class="hs-identifier hs-var">distance'</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><a href="#local-6989586621680022655"><span class="hs-identifier hs-type">scheduleGC'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621680022655"><span class="annot"><span class="annottext">scheduleGC' :: WithOrigin SlotNo -&gt; m ()
</span><a href="#local-6989586621680022655"><span class="hs-identifier hs-var hs-var">scheduleGC'</span></a></span></span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><span class="hs-identifier hs-var">Origin</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><a href="#local-6989586621680022655"><span class="hs-identifier hs-var">scheduleGC'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621680022645"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022645"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-287"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceGCEvent blk)
-&gt; SlotNo -&gt; GcParams -&gt; GcSchedule m -&gt; m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
Tracer m (TraceGCEvent blk)
-&gt; SlotNo -&gt; GcParams -&gt; GcSchedule m -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduleGC"><span class="hs-identifier hs-var">scheduleGC</span></a></span><span>
</span><span id="line-288"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceGCEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceGCEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceGCEvent blk -&gt; TraceEvent blk
forall blk. TraceGCEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceGCEvent"><span class="hs-identifier hs-var">TraceGCEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680022686"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>          </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022645"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-290"></span><span>          </span><span class="annot"><span class="annottext">GcParams :: DiffTime -&gt; DiffTime -&gt; GcParams
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier hs-type">GcParams</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-291"></span><span>              </span><span class="annot"><span class="annottext">gcDelay :: DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcDelay"><span class="hs-identifier hs-var">gcDelay</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022683"><span class="hs-identifier hs-var">cdbGcDelay</span></a></span><span>
</span><span id="line-292"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">gcInterval :: DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcInterval"><span class="hs-identifier hs-var">gcInterval</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022682"><span class="hs-identifier hs-var">cdbGcInterval</span></a></span><span>
</span><span id="line-293"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-294"></span><span>          </span><span class="annot"><span class="annottext">GcSchedule m
</span><a href="#local-6989586621680022675"><span class="hs-identifier hs-var">gcSchedule</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-comment">-- | Write a snapshot of the LedgerDB to disk and remove old snapshots</span><span>
</span><span id="line-297"></span><span class="hs-comment">-- (typically one) so that only 'onDiskNumSnapshots' snapshots are on disk.</span><span>
</span><span id="line-298"></span><span id="local-6989586621680022933"><span id="local-6989586621680022934"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots"><span class="hs-identifier hs-type">updateLedgerSnapshots</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022934"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-300"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDbSerialiseConstraints"><span class="hs-identifier hs-type">LgrDbSerialiseConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022933"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-301"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022933"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-302"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#IsLedger"><span class="hs-identifier hs-type">IsLedger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022933"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022934"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022933"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022934"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-305"></span><span id="updateLedgerSnapshots"><span class="annot"><span class="annottext">updateLedgerSnapshots :: ChainDbEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots"><span class="hs-identifier hs-var hs-var">updateLedgerSnapshots</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022619"><span id="local-6989586621680022620"><span id="local-6989586621680022621"><span id="local-6989586621680022622"><span id="local-6989586621680022623"><span id="local-6989586621680022624"><span id="local-6989586621680022625"><span id="local-6989586621680022626"><span id="local-6989586621680022627"><span id="local-6989586621680022628"><span id="local-6989586621680022629"><span id="local-6989586621680022630"><span id="local-6989586621680022631"><span id="local-6989586621680022632"><span id="local-6989586621680022633"><span id="local-6989586621680022634"><span id="local-6989586621680022635"><span id="local-6989586621680022636"><span id="local-6989586621680022637"><span id="local-6989586621680022638"><span id="local-6989586621680022639"><span id="local-6989586621680022640"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
</span><a href="#local-6989586621680022619"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">m (Maybe (DiskSnapshot, RealPoint blk)) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (DiskSnapshot, RealPoint blk)) -&gt; m ())
-&gt; m (Maybe (DiskSnapshot, RealPoint blk)) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; m (Maybe (DiskSnapshot, RealPoint blk))
forall (m :: * -&gt; *) blk.
(IOLike m, LgrDbSerialiseConstraints blk, HasHeader blk,
 IsLedger (LedgerState blk)) =&gt;
LgrDB m blk -&gt; m (Maybe (DiskSnapshot, RealPoint blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#takeSnapshot"><span class="hs-identifier hs-var">LgrDB.takeSnapshot</span></a></span><span>  </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680022638"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="annottext">m [DiskSnapshot] -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m [DiskSnapshot] -&gt; m ()) -&gt; m [DiskSnapshot] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; m [DiskSnapshot]
forall (m :: * -&gt; *) blk.
(MonadCatch m, HasHeader blk) =&gt;
LgrDB m blk -&gt; m [DiskSnapshot]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#trimSnapshots"><span class="hs-identifier hs-var">LgrDB.trimSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680022638"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Executing garbage collection
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="hs-comment">-- | Trigger a garbage collection for blocks older than the given 'SlotNo' on</span><span>
</span><span id="line-314"></span><span class="hs-comment">-- the VolatileDB.</span><span>
</span><span id="line-315"></span><span class="hs-comment">--</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- Also removes the corresponding cached &quot;previously applied points&quot; from the</span><span>
</span><span id="line-317"></span><span class="hs-comment">-- LedgerDB.</span><span>
</span><span id="line-318"></span><span class="hs-comment">--</span><span>
</span><span id="line-319"></span><span class="hs-comment">-- This is thread-safe as the VolatileDB locks itself while performing a GC.</span><span>
</span><span id="line-320"></span><span class="hs-comment">--</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- When calling this function it is __critical__ that the blocks that will be</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- garbage collected, which are determined by the @slotNo@ parameter, have</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- already been copied to the immutable DB (if they are part of the current</span><span>
</span><span id="line-324"></span><span class="hs-comment">-- selection).</span><span>
</span><span id="line-325"></span><span class="hs-comment">--</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- TODO will a long GC be a bottleneck? It will block any other calls to</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- @putBlock@ and @getBlock@.</span><span>
</span><span id="line-328"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect"><span class="hs-identifier hs-type">garbageCollect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680023044"><span class="annot"><a href="#local-6989586621680023044"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680023043"><span class="annot"><a href="#local-6989586621680023043"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023043"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023044"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span id="garbageCollect"><span class="annot"><span class="annottext">garbageCollect :: ChainDbEnv m blk -&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect"><span class="hs-identifier hs-var hs-var">garbageCollect</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022595"><span id="local-6989586621680022596"><span id="local-6989586621680022597"><span id="local-6989586621680022598"><span id="local-6989586621680022599"><span id="local-6989586621680022600"><span id="local-6989586621680022601"><span id="local-6989586621680022602"><span id="local-6989586621680022603"><span id="local-6989586621680022604"><span id="local-6989586621680022605"><span id="local-6989586621680022606"><span id="local-6989586621680022607"><span id="local-6989586621680022608"><span id="local-6989586621680022609"><span id="local-6989586621680022610"><span id="local-6989586621680022611"><span id="local-6989586621680022612"><span id="local-6989586621680022613"><span id="local-6989586621680022614"><span id="local-6989586621680022615"><span id="local-6989586621680022616"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
</span><a href="#local-6989586621680022595"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680022594"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022594"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; SlotNo -&gt; m ()
forall (m :: * -&gt; *) blk.
VolatileDB m blk -&gt; HasCallStack =&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#garbageCollect"><span class="hs-identifier hs-var hs-var">VolatileDB.garbageCollect</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621680022615"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022594"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; SlotNo -&gt; STM m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; SlotNo -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#garbageCollectPrevApplied"><span class="hs-identifier hs-var">LgrDB.garbageCollectPrevApplied</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621680022614"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022594"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-333"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; (WithFingerprint (InvalidBlocks blk)
    -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621680022609"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((WithFingerprint (InvalidBlocks blk)
  -&gt; WithFingerprint (InvalidBlocks blk))
 -&gt; STM m ())
-&gt; (WithFingerprint (InvalidBlocks blk)
    -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidBlocks blk -&gt; InvalidBlocks blk)
-&gt; WithFingerprint (InvalidBlocks blk)
-&gt; WithFingerprint (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">((InvalidBlocks blk -&gt; InvalidBlocks blk)
 -&gt; WithFingerprint (InvalidBlocks blk)
 -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; (InvalidBlocks blk -&gt; InvalidBlocks blk)
-&gt; WithFingerprint (InvalidBlocks blk)
-&gt; WithFingerprint (InvalidBlocks blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidBlockInfo blk -&gt; Bool)
-&gt; InvalidBlocks blk -&gt; InvalidBlocks blk
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022594"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; Bool)
-&gt; (InvalidBlockInfo blk -&gt; SlotNo) -&gt; InvalidBlockInfo blk -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockInfo blk -&gt; SlotNo
forall blk. InvalidBlockInfo blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#invalidBlockSlotNo"><span class="hs-identifier hs-var hs-var">invalidBlockSlotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621680022605"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceGCEvent blk -&gt; TraceEvent blk
forall blk. TraceGCEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceGCEvent"><span class="hs-identifier hs-var">TraceGCEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceGCEvent blk -&gt; TraceEvent blk)
-&gt; TraceGCEvent blk -&gt; TraceEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; TraceGCEvent blk
forall blk. SlotNo -&gt; TraceGCEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#PerformedGC"><span class="hs-identifier hs-var">PerformedGC</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022594"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Scheduling garbage collections
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="hs-comment">-- | Scheduled garbage collections</span><span>
</span><span id="line-341"></span><span class="hs-comment">--</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- When a block has been copied to the ImmutableDB, we schedule a VolatileDB</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- garbage collection for the slot corresponding to the block in the future.</span><span>
</span><span id="line-344"></span><span class="hs-comment">-- How far in the future is determined by the 'gcDelay' parameter. The goal is</span><span>
</span><span id="line-345"></span><span class="hs-comment">-- to allow some overlap so that the write to the ImmutableDB will have been</span><span>
</span><span id="line-346"></span><span class="hs-comment">-- flushed to disk before the block is removed from the VolatileDB.</span><span>
</span><span id="line-347"></span><span class="hs-comment">--</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- We store scheduled garbage collections in a LIFO queue. Since the queue</span><span>
</span><span id="line-349"></span><span class="hs-comment">-- will be very short (see further down for why) and entries are more often</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- added (at the block sync speed by a single thread) than removed (once every</span><span>
</span><span id="line-351"></span><span class="hs-comment">-- 'gcInterval'), we simply use a 'StrictSeq' stored in a 'TVar' to make</span><span>
</span><span id="line-352"></span><span class="hs-comment">-- reasoning and testing easier. Entries are enqueued at the end (right) and</span><span>
</span><span id="line-353"></span><span class="hs-comment">-- dequeued from the head (left).</span><span>
</span><span id="line-354"></span><span class="hs-comment">--</span><span>
</span><span id="line-355"></span><span class="hs-comment">-- The 'Time's in the queue will be monotonically increasing. A fictional</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- example (with hh:mm:ss):</span><span>
</span><span id="line-357"></span><span class="hs-comment">--</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- &gt; [(16:01:12, SlotNo 1012), (16:04:38, SlotNo 1045), ..]</span><span>
</span><span id="line-359"></span><span class="hs-comment">--</span><span>
</span><span id="line-360"></span><span class="hs-comment">-- Scheduling a garbage collection with 'scheduleGC' will add an entry to the</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- end of the queue for the given slot at the time equal to now</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- ('getMonotonicTime') + the @gcDelay@ rounded to @gcInterval@. Unless the</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- last entry in the queue was scheduled for the same rounded time, in that</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- case the new entry replaces the existing entry. The goal of this is to</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- batch garbage collections so that, when possible, at most one garbage</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- collection happens every @gcInterval@.</span><span>
</span><span id="line-367"></span><span class="hs-comment">--</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- For example, starting with an empty queue and @gcDelay = 5min@ and</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- @gcInterval = 10s@:</span><span>
</span><span id="line-370"></span><span class="hs-comment">--</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- At 8:43:22, we schedule a GC for slot 10:</span><span>
</span><span id="line-372"></span><span class="hs-comment">--</span><span>
</span><span id="line-373"></span><span class="hs-comment">-- &gt; [(8:48:30, SlotNo 10)]</span><span>
</span><span id="line-374"></span><span class="hs-comment">--</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- The scheduled time is rounded up to the next interval. Next, at 8:43:24, we</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- schedule a GC for slot 11:</span><span>
</span><span id="line-377"></span><span class="hs-comment">--</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- &gt; [(8:48:30, SlotNo 11)]</span><span>
</span><span id="line-379"></span><span class="hs-comment">--</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- Note that the existing entry is replaced with the new one, as they map to</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- the same @gcInterval@. Instead of two GCs 2 seconds apart, we will only</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- schedule one GC.</span><span>
</span><span id="line-383"></span><span class="hs-comment">--</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- Next, at 8:44:02, we schedule a GC for slot 12:</span><span>
</span><span id="line-385"></span><span class="hs-comment">--</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- &gt; [(8:48:30, SlotNo 11), (8:49:10, SlotNo 12)]</span><span>
</span><span id="line-387"></span><span class="hs-comment">--</span><span>
</span><span id="line-388"></span><span class="hs-comment">-- Now, a new entry was appended to the queue, as it doesn't map to the same</span><span>
</span><span id="line-389"></span><span class="hs-comment">-- @gcInterval@ as the last one.</span><span>
</span><span id="line-390"></span><span class="hs-comment">--</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- In other words, everything scheduled in the first 10s will be done after</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- 20s. The bounds are the open-closed interval:</span><span>
</span><span id="line-393"></span><span class="hs-comment">--</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- &gt; (now + gcDelay, now + gcDelay + gcInterval]</span><span>
</span><span id="line-395"></span><span class="hs-comment">--</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- Whether we're syncing at high speed or downloading blocks as they are</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- produced, the length of the queue will be at most @&#8968;gcDelay / gcInterval&#8969; +</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- 1@, e.g., 5min / 10s = 31 entries. The @+ 1@ is needed because we might be</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- somewhere in the middle of a @gcInterval@.</span><span>
</span><span id="line-400"></span><span class="hs-comment">--</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- The background thread will look at head of the queue and wait until that</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- has 'Time' passed. After the wait, it will pop off the head of the queue</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- and perform a garbage collection for the 'SlotNo' in the head. Note that</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- the 'SlotNo' before the wait can be different from the one after the wait,</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- precisely because of batching.</span><span>
</span><span id="line-406"></span><span class="hs-keyword">newtype</span><span> </span><span id="GcSchedule"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-var">GcSchedule</span></a></span></span><span> </span><span id="local-6989586621680022871"><span class="annot"><a href="#local-6989586621680022871"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="GcSchedule"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-var">GcSchedule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022871"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictSeq</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span id="local-6989586621680022584"><span id="local-6989586621680022585"></span></span><span class="hs-keyword">data</span><span> </span><span id="ScheduledGc"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-var">ScheduledGc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScheduledGc"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-var">ScheduledGc</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-409"></span><span>      </span><span id="scheduledGcTime"><span class="annot"><span class="annottext">ScheduledGc -&gt; Time
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduledGcTime"><span class="hs-identifier hs-var hs-var">scheduledGcTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">Time</span></a></span><span>
</span><span id="line-410"></span><span>      </span><span class="hs-comment">-- ^ Time at which to run the garbage collection</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="scheduledGcSlot"><span class="annot"><span class="annottext">ScheduledGc -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduledGcSlot"><span class="hs-identifier hs-var hs-var">scheduledGcSlot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-comment">-- ^ For which slot to run the garbage collection</span><span>
</span><span id="line-413"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680022577"><span id="local-6989586621680022579"><span class="annot"><span class="annottext">ScheduledGc -&gt; ScheduledGc -&gt; Bool
(ScheduledGc -&gt; ScheduledGc -&gt; Bool)
-&gt; (ScheduledGc -&gt; ScheduledGc -&gt; Bool) -&gt; Eq ScheduledGc
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ScheduledGc -&gt; ScheduledGc -&gt; Bool
$c/= :: ScheduledGc -&gt; ScheduledGc -&gt; Bool
== :: ScheduledGc -&gt; ScheduledGc -&gt; Bool
$c== :: ScheduledGc -&gt; ScheduledGc -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680022570"><span id="local-6989586621680022572"><span id="local-6989586621680022574"><span class="annot"><span class="annottext">Int -&gt; ScheduledGc -&gt; ShowS
[ScheduledGc] -&gt; ShowS
ScheduledGc -&gt; String
(Int -&gt; ScheduledGc -&gt; ShowS)
-&gt; (ScheduledGc -&gt; String)
-&gt; ([ScheduledGc] -&gt; ShowS)
-&gt; Show ScheduledGc
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ScheduledGc] -&gt; ShowS
$cshowList :: [ScheduledGc] -&gt; ShowS
show :: ScheduledGc -&gt; String
$cshow :: ScheduledGc -&gt; String
showsPrec :: Int -&gt; ScheduledGc -&gt; ShowS
$cshowsPrec :: Int -&gt; ScheduledGc -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. ScheduledGc -&gt; Rep ScheduledGc x)
-&gt; (forall x. Rep ScheduledGc x -&gt; ScheduledGc)
-&gt; Generic ScheduledGc
forall x. Rep ScheduledGc x -&gt; ScheduledGc
forall x. ScheduledGc -&gt; Rep ScheduledGc x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep ScheduledGc x -&gt; ScheduledGc
$cfrom :: forall x. ScheduledGc -&gt; Rep ScheduledGc x
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680022560"><span id="local-6989586621680022562"><span id="local-6989586621680022564"><span class="annot"><span class="annottext">Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo)
Proxy ScheduledGc -&gt; String
(Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy ScheduledGc -&gt; String)
-&gt; NoThunks ScheduledGc
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
showTypeOf :: Proxy ScheduledGc -&gt; String
$cshowTypeOf :: Proxy ScheduledGc -&gt; String
wNoThunks :: Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: Context -&gt; ScheduledGc -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Condense.html#Condense"><span class="hs-identifier hs-type">Condense</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-417"></span><span>  </span><span id="local-6989586621680022556"><span class="annot"><span class="annottext">condense :: ScheduledGc -&gt; String
</span><a href="Ouroboros.Consensus.Util.Condense.html#condense"><span class="hs-identifier hs-var hs-var hs-var hs-var">condense</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span> </span><span id="local-6989586621680022554"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022554"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621680022553"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022553"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Time, SlotNo) -&gt; String
forall a. Condense a =&gt; a -&gt; String
</span><a href="Ouroboros.Consensus.Util.Condense.html#condense"><span class="hs-identifier hs-var">condense</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022554"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022553"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span class="hs-keyword">data</span><span> </span><span id="GcParams"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier hs-var">GcParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="GcParams"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier hs-var">GcParams</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-420"></span><span>      </span><span id="gcDelay"><span class="annot"><span class="annottext">GcParams -&gt; DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcDelay"><span class="hs-identifier hs-var hs-var">gcDelay</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-comment">-- ^ How long to wait until performing the GC. See 'cdbsGcDelay'.</span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="gcInterval"><span class="annot"><span class="annottext">GcParams -&gt; DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcInterval"><span class="hs-identifier hs-var hs-var">gcInterval</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-423"></span><span>      </span><span class="hs-comment">-- ^ The GC interval: the minimum time between two GCs. See</span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-comment">-- 'cdbsGcInterval'.</span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680022547"><span id="local-6989586621680022549"><span id="local-6989586621680022551"><span class="annot"><span class="annottext">Int -&gt; GcParams -&gt; ShowS
[GcParams] -&gt; ShowS
GcParams -&gt; String
(Int -&gt; GcParams -&gt; ShowS)
-&gt; (GcParams -&gt; String) -&gt; ([GcParams] -&gt; ShowS) -&gt; Show GcParams
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [GcParams] -&gt; ShowS
$cshowList :: [GcParams] -&gt; ShowS
show :: GcParams -&gt; String
$cshow :: GcParams -&gt; String
showsPrec :: Int -&gt; GcParams -&gt; ShowS
$cshowsPrec :: Int -&gt; GcParams -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span id="local-6989586621680023047"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#newGcSchedule"><span class="hs-identifier hs-type">newGcSchedule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023047"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023047"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023047"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-429"></span><span id="newGcSchedule"><span class="annot"><span class="annottext">newGcSchedule :: m (GcSchedule m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#newGcSchedule"><span class="hs-identifier hs-var hs-var">newGcSchedule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc) -&gt; GcSchedule m
forall (m :: * -&gt; *).
StrictTVar m (StrictSeq ScheduledGc) -&gt; GcSchedule m
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-var">GcSchedule</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictTVar m (StrictSeq ScheduledGc) -&gt; GcSchedule m)
-&gt; m (StrictTVar m (StrictSeq ScheduledGc)) -&gt; m (GcSchedule m)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc -&gt; m (StrictTVar m (StrictSeq ScheduledGc))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.MonadSTM.NormalForm.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
forall a. StrictSeq a
</span><span class="hs-identifier hs-var">Seq.empty</span></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduleGC"><span class="hs-identifier hs-type">scheduleGC</span></a></span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680022917"><span class="annot"><a href="#local-6989586621680022917"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680022916"><span class="annot"><a href="#local-6989586621680022916"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022917"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680022917"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceGCEvent"><span class="hs-identifier hs-type">TraceGCEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022916"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>    </span><span class="hs-comment">-- ^ The slot to use for garbage collection</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier hs-type">GcParams</span></a></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022917"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022917"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span id="scheduleGC"><span class="annot"><span class="annottext">scheduleGC :: Tracer m (TraceGCEvent blk)
-&gt; SlotNo -&gt; GcParams -&gt; GcSchedule m -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduleGC"><span class="hs-identifier hs-var hs-var">scheduleGC</span></a></span></span><span> </span><span id="local-6989586621680022544"><span class="annot"><span class="annottext">Tracer m (TraceGCEvent blk)
</span><a href="#local-6989586621680022544"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680022543"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022543"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span id="local-6989586621680022542"><span class="annot"><span class="annottext">GcParams
</span><a href="#local-6989586621680022542"><span class="hs-identifier hs-var">gcParams</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span id="local-6989586621680022541"><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022541"><span class="hs-identifier hs-var">varQueue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621680022540"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022540"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GcParams -&gt; Time -&gt; Time
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#computeTimeForGC"><span class="hs-identifier hs-var">computeTimeForGC</span></a></span><span> </span><span class="annot"><span class="annottext">GcParams
</span><a href="#local-6989586621680022542"><span class="hs-identifier hs-var">gcParams</span></a></span><span> </span><span class="annot"><span class="annottext">(Time -&gt; Time) -&gt; m Time -&gt; m Time
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
-&gt; (StrictSeq ScheduledGc -&gt; StrictSeq ScheduledGc) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022541"><span class="hs-identifier hs-var">varQueue</span></a></span><span> </span><span class="annot"><span class="annottext">((StrictSeq ScheduledGc -&gt; StrictSeq ScheduledGc) -&gt; STM m ())
-&gt; (StrictSeq ScheduledGc -&gt; StrictSeq ScheduledGc) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-441"></span><span>      </span><span id="local-6989586621680022539"><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><a href="#local-6989586621680022539"><span class="hs-identifier hs-var">queue'</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|&gt;</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scheduledGcTime :: ScheduledGc -&gt; Time
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduledGcTime"><span class="hs-identifier hs-var">scheduledGcTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680022537"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022537"><span class="hs-identifier hs-var">lastTimeScheduledForGC</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022540"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022537"><span class="hs-identifier hs-var">lastTimeScheduledForGC</span></a></span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">-- Same interval, batch it</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><a href="#local-6989586621680022539"><span class="hs-identifier hs-var">queue'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc -&gt; ScheduledGc -&gt; StrictSeq ScheduledGc
forall a. StrictSeq a -&gt; a -&gt; StrictSeq a
</span><span class="hs-operator hs-var">:|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Time -&gt; SlotNo -&gt; ScheduledGc
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-var">ScheduledGc</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022540"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022543"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-445"></span><span>      </span><span id="local-6989586621680022536"><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><a href="#local-6989586621680022536"><span class="hs-identifier hs-var">queue</span></a></span></span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-comment">-- Different interval or empty, so append it</span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><a href="#local-6989586621680022536"><span class="hs-identifier hs-var">queue</span></a></span><span>  </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc -&gt; ScheduledGc -&gt; StrictSeq ScheduledGc
forall a. StrictSeq a -&gt; a -&gt; StrictSeq a
</span><span class="hs-operator hs-var">:|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Time -&gt; SlotNo -&gt; ScheduledGc
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-var">ScheduledGc</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022540"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022543"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="annot"><span class="annottext">Tracer m (TraceGCEvent blk) -&gt; TraceGCEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceGCEvent blk)
</span><a href="#local-6989586621680022544"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceGCEvent blk -&gt; m ()) -&gt; TraceGCEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Time -&gt; TraceGCEvent blk
forall blk. SlotNo -&gt; Time -&gt; TraceGCEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ScheduledGC"><span class="hs-identifier hs-var">ScheduledGC</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022543"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022540"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#computeTimeForGC"><span class="hs-identifier hs-type">computeTimeForGC</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier hs-type">GcParams</span></a></span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">Time</span></a></span><span>  </span><span class="hs-comment">-- ^ Now</span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">Time</span></a></span><span>  </span><span class="hs-comment">-- ^ The time at which to perform the GC</span><span>
</span><span id="line-454"></span><span id="computeTimeForGC"><span class="annot"><span class="annottext">computeTimeForGC :: GcParams -&gt; Time -&gt; Time
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#computeTimeForGC"><span class="hs-identifier hs-var hs-var">computeTimeForGC</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams"><span class="hs-identifier hs-type">GcParams</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680022534"><span class="annot"><span class="annottext">DiffTime
gcDelay :: DiffTime
gcDelay :: GcParams -&gt; DiffTime
</span><a href="#local-6989586621680022534"><span class="hs-identifier hs-var hs-var">gcDelay</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680022533"><span class="annot"><span class="annottext">DiffTime
gcInterval :: DiffTime
gcInterval :: GcParams -&gt; DiffTime
</span><a href="#local-6989586621680022533"><span class="hs-identifier hs-var hs-var">gcInterval</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">Time</span></a></span><span> </span><span id="local-6989586621680022531"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022531"><span class="hs-identifier hs-var">now</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><span class="annottext">DiffTime -&gt; Time
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">Time</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; Time) -&gt; DiffTime -&gt; Time
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; DiffTime
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-var">picosecondsToDiffTime</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; DiffTime) -&gt; Integer -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-comment">-- We're rounding up to the nearest interval, because rounding down</span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-comment">-- would mean GC'ing too early.</span><span>
</span><span id="line-458"></span><span>      </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a b. (Integral a, Integral b) =&gt; b -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#roundUpToInterval"><span class="hs-identifier hs-var">roundUpToInterval</span></a></span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Integer
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-var">diffTimeToPicoseconds</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022533"><span class="hs-identifier hs-var">gcInterval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Integer
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-var">diffTimeToPicoseconds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022531"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022534"><span class="hs-identifier hs-var">gcDelay</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span class="hs-comment">-- | Round to an interval</span><span>
</span><span id="line-463"></span><span class="hs-comment">--</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- PRECONDITION: interval &gt; 0</span><span>
</span><span id="line-465"></span><span class="hs-comment">--</span><span>
</span><span id="line-466"></span><span class="hs-comment">-- &gt;    [roundUpToInterval 5 n | n &lt;- [1..15]]</span><span>
</span><span id="line-467"></span><span class="hs-comment">-- &gt; == [5,5,5,5,5, 10,10,10,10,10, 15,15,15,15,15]</span><span>
</span><span id="line-468"></span><span class="hs-comment">--</span><span>
</span><span id="line-469"></span><span class="hs-comment">-- &gt;    roundUpToInterval 5 0</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- &gt; == 0</span><span>
</span><span id="line-471"></span><span id="local-6989586621680022863"><span id="local-6989586621680022864"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#roundUpToInterval"><span class="hs-identifier hs-type">roundUpToInterval</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Integral</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022864"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Integral</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022863"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022863"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022864"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680022864"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-472"></span><span id="roundUpToInterval"><span class="annot"><span class="annottext">roundUpToInterval :: b -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#roundUpToInterval"><span class="hs-identifier hs-var hs-var">roundUpToInterval</span></a></span></span><span> </span><span id="local-6989586621680022527"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680022527"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span id="local-6989586621680022526"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022526"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022525"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022524"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680022527"><span class="hs-identifier hs-var">interval</span></a></span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022524"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680022527"><span class="hs-identifier hs-var">interval</span></a></span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680022524"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022524"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680022525"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022525"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680022526"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; (a, a)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">`divMod`</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680022527"><span class="hs-identifier hs-var">interval</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcScheduleRunner"><span class="hs-identifier hs-type">gcScheduleRunner</span></a></span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680023045"><span class="annot"><a href="#local-6989586621680023045"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023045"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023045"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023045"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ GC function</span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023045"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-485"></span><span id="gcScheduleRunner"><span class="annot"><span class="annottext">gcScheduleRunner :: GcSchedule m -&gt; (SlotNo -&gt; m ()) -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcScheduleRunner"><span class="hs-identifier hs-var hs-var">gcScheduleRunner</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span id="local-6989586621680022521"><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022521"><span class="hs-identifier hs-var">varQueue</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680022520"><span class="annot"><span class="annottext">SlotNo -&gt; m ()
</span><a href="#local-6989586621680022520"><span class="hs-identifier hs-var">runGc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m Void) -&gt; m () -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>    </span><span class="hs-comment">-- Peek to know how long to wait</span><span>
</span><span id="line-487"></span><span>    </span><span id="local-6989586621680022519"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022519"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Time -&gt; m Time
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m Time -&gt; m Time) -&gt; STM m Time -&gt; m Time
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-488"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
-&gt; STM m (StrictSeq ScheduledGc)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022521"><span class="hs-identifier hs-var">varQueue</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (StrictSeq ScheduledGc)
-&gt; (StrictSeq ScheduledGc -&gt; STM m Time) -&gt; STM m Time
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-489"></span><span>        </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><span class="hs-identifier hs-var">Seq.Empty</span></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m Time
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-490"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680022516"><span class="annot"><span class="annottext">Time
scheduledGcTime :: Time
scheduledGcTime :: ScheduledGc -&gt; Time
</span><a href="#local-6989586621680022516"><span class="hs-identifier hs-var hs-var">scheduledGcTime</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-type">:&lt;|</span></span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Time -&gt; STM m Time
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022516"><span class="hs-identifier hs-var">scheduledGcTime</span></a></span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621680022514"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022514"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680022513"><span class="annot"><span class="annottext">toWait :: DiffTime
</span><a href="#local-6989586621680022513"><span class="hs-identifier hs-var hs-var">toWait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022519"><span class="hs-identifier hs-var">timeScheduledForGC</span></a></span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-operator hs-var">`diffTime`</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621680022514"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>    </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">threadDelay</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680022513"><span class="hs-identifier hs-var">toWait</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-comment">-- After waiting, find the slot for which to GC and remove the entry from</span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-comment">-- the queue.</span><span>
</span><span id="line-498"></span><span>    </span><span id="local-6989586621680022511"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022511"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m SlotNo -&gt; m SlotNo
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m SlotNo -&gt; m SlotNo) -&gt; STM m SlotNo -&gt; m SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-499"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
-&gt; STM m (StrictSeq ScheduledGc)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022521"><span class="hs-identifier hs-var">varQueue</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (StrictSeq ScheduledGc)
-&gt; (StrictSeq ScheduledGc -&gt; STM m SlotNo) -&gt; STM m SlotNo
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-500"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680022510"><span class="annot"><span class="annottext">SlotNo
scheduledGcSlot :: SlotNo
scheduledGcSlot :: ScheduledGc -&gt; SlotNo
</span><a href="#local-6989586621680022510"><span class="hs-identifier hs-var hs-var">scheduledGcSlot</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-type">:&lt;|</span></span><span> </span><span id="local-6989586621680022509"><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><a href="#local-6989586621680022509"><span class="hs-identifier hs-var">queue'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>          </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
-&gt; StrictSeq ScheduledGc -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022521"><span class="hs-identifier hs-var">varQueue</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><a href="#local-6989586621680022509"><span class="hs-identifier hs-var">queue'</span></a></span><span>
</span><span id="line-502"></span><span>          </span><span class="annot"><span class="annottext">SlotNo -&gt; STM m SlotNo
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022510"><span class="hs-identifier hs-var">scheduledGcSlot</span></a></span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-comment">-- Impossible, we peeked at the queue and it contained an entry. We</span><span>
</span><span id="line-505"></span><span>        </span><span class="hs-comment">-- are the only one removing entries, so it can't have been removed</span><span>
</span><span id="line-506"></span><span>        </span><span class="hs-comment">-- while we were waiting.</span><span>
</span><span id="line-507"></span><span>        </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc
</span><span class="hs-identifier hs-var">Seq.Empty</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; STM m SlotNo
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;queue empty after waiting&quot;</span></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-comment">-- Garbage collection is called synchronously</span><span>
</span><span id="line-510"></span><span>    </span><span class="annot"><span class="annottext">SlotNo -&gt; m ()
</span><a href="#local-6989586621680022520"><span class="hs-identifier hs-var">runGc</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621680022511"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span class="hs-comment">-- | Return the current contents of the 'GcSchedule' queue without modifying</span><span>
</span><span id="line-513"></span><span class="hs-comment">-- it.</span><span>
</span><span id="line-514"></span><span class="hs-comment">--</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- For testing purposes.</span><span>
</span><span id="line-516"></span><span id="local-6989586621680022508"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#dumpGcSchedule"><span class="hs-identifier hs-type">dumpGcSchedule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680022508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc"><span class="hs-identifier hs-type">ScheduledGc</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-517"></span><span id="dumpGcSchedule"><span class="annot"><span class="annottext">dumpGcSchedule :: GcSchedule m -&gt; STM m [ScheduledGc]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#dumpGcSchedule"><span class="hs-identifier hs-var hs-var">dumpGcSchedule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule"><span class="hs-identifier hs-type">GcSchedule</span></a></span><span> </span><span id="local-6989586621680022507"><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022507"><span class="hs-identifier hs-var">varQueue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictSeq ScheduledGc -&gt; [ScheduledGc]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictSeq ScheduledGc -&gt; [ScheduledGc])
-&gt; STM m (StrictSeq ScheduledGc) -&gt; STM m [ScheduledGc]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
-&gt; STM m (StrictSeq ScheduledGc)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictSeq ScheduledGc)
</span><a href="#local-6989586621680022507"><span class="hs-identifier hs-var">varQueue</span></a></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Adding blocks to the ChainDB
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="hs-comment">-- | Read blocks from 'cdbBlocksToAdd' and add them synchronously to the</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- ChainDB.</span><span>
</span><span id="line-525"></span><span id="local-6989586621680023053"><span id="local-6989586621680023055"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner"><span class="hs-identifier hs-type">addBlockRunner</span></a></span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023055"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-527"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023053"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-528"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023053"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-529"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023053"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-530"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-531"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680023053"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680023055"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span></span></span><span>
</span><span id="line-534"></span><span id="addBlockRunner"><span class="annot"><span class="annottext">addBlockRunner :: ChainDbEnv m blk -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner"><span class="hs-identifier hs-var hs-var">addBlockRunner</span></a></span></span><span> </span><span id="local-6989586621680022506"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621680022506"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621680022484"><span id="local-6989586621680022485"><span id="local-6989586621680022486"><span id="local-6989586621680022487"><span id="local-6989586621680022488"><span id="local-6989586621680022489"><span id="local-6989586621680022490"><span id="local-6989586621680022491"><span id="local-6989586621680022492"><span id="local-6989586621680022493"><span id="local-6989586621680022494"><span id="local-6989586621680022495"><span id="local-6989586621680022496"><span id="local-6989586621680022497"><span id="local-6989586621680022498"><span id="local-6989586621680022499"><span id="local-6989586621680022500"><span id="local-6989586621680022501"><span id="local-6989586621680022502"><span id="local-6989586621680022503"><span id="local-6989586621680022504"><span id="local-6989586621680022505"><span class="annot"><span class="annottext">DiffTime
StrictTVar m (m ())
StrictTVar m (FutureBlocks blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbFutureBlocks :: StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: BlocksToAdd m blk
cdbCheckInFuture :: CheckInFuture m blk
cdbCheckIntegrity :: blk -&gt; Bool
cdbChunkInfo :: ChunkInfo
cdbKillBgThreads :: StrictTVar m (m ())
cdbGcInterval :: DiffTime
cdbGcDelay :: DiffTime
cdbRegistry :: ResourceRegistry m
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbCopyLock :: StrictMVar m ()
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: LgrDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbImmutableDB :: ImmutableDB m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks blk)
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
</span><a href="#local-6989586621680022484"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m Void) -&gt; m () -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>    </span><span id="local-6989586621680022483"><span class="annot"><span class="annottext">BlockToAdd m blk
</span><a href="#local-6989586621680022483"><span class="hs-identifier hs-var">blockToAdd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlocksToAdd m blk -&gt; m (BlockToAdd m blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
BlocksToAdd m blk -&gt; m (BlockToAdd m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getBlockToAdd"><span class="hs-identifier hs-var">getBlockToAdd</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksToAdd m blk
</span><a href="#local-6989586621680022485"><span class="hs-identifier hs-var">cdbBlocksToAdd</span></a></span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockToAdd m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, GetPrevHash blk, LedgerSupportsProtocol blk,
 InspectLedger blk, HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockToAdd m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier hs-var">addBlockSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621680022506"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockToAdd m blk
</span><a href="#local-6989586621680022483"><span class="hs-identifier hs-var">blockToAdd</span></a></span><span>
</span><span id="line-537"></span></pre></body></html>