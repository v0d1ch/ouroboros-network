<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | IO implementation of the 'HasFS' class</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.IO</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><span class="hs-comment">-- * IO implementation &amp; monad</span></span><span>
</span><span id="line-4"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.IO.html#HandleIO"><span class="hs-identifier">HandleIO</span></a></span><span>
</span><span id="line-5"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.IO.html#ioHasFS"><span class="hs-identifier">ioHasFS</span></a></span><span>
</span><span id="line-6"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.MVar</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Unsafe</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Foreign</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">castPtr</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Dir</span></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API.Types</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.Handle.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.Handle</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.IO.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.IO</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">F</span></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  I/O implementation of HasFS
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-comment">-- | File handlers for the IO instance for HasFS</span><span>
</span><span id="line-26"></span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- We store the path the handle points to for better error messages</span><span>
</span><span id="line-28"></span><span class="hs-keyword">type</span><span> </span><span id="HandleIO"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.IO.html#HandleIO"><span class="hs-identifier hs-var">HandleIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.IO.html#FHandle"><span class="hs-identifier hs-type">F.FHandle</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.IO.html#ioHasFS"><span class="hs-identifier hs-type">ioHasFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#MountPoint"><span class="hs-identifier hs-type">MountPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.IO.html#HandleIO"><span class="hs-identifier hs-type">HandleIO</span></a></span><span>
</span><span id="line-31"></span><span id="ioHasFS"><span class="annot"><span class="annottext">ioHasFS :: MountPoint -&gt; HasFS IO HandleIO
</span><a href="Ouroboros.Consensus.Storage.FS.IO.html#ioHasFS"><span class="hs-identifier hs-var hs-var">ioHasFS</span></a></span></span><span> </span><span id="local-6989586621679982867"><span class="annot"><span class="annottext">MountPoint
</span><a href="#local-6989586621679982867"><span class="hs-identifier hs-var">mount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS :: forall (m :: * -&gt; *) h.
m String
-&gt; (HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h))
-&gt; (HasCallStack =&gt; Handle h -&gt; m ())
-&gt; (HasCallStack =&gt; Handle h -&gt; m Bool)
-&gt; (HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ())
-&gt; (HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString)
-&gt; (HasCallStack =&gt;
    Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString)
-&gt; (HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64)
-&gt; (HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ())
-&gt; (HasCallStack =&gt; Handle h -&gt; m Word64)
-&gt; (HasCallStack =&gt; FsPath -&gt; m ())
-&gt; (HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ())
-&gt; (HasCallStack =&gt; FsPath -&gt; m (Set String))
-&gt; (HasCallStack =&gt; FsPath -&gt; m Bool)
-&gt; (HasCallStack =&gt; FsPath -&gt; m Bool)
-&gt; (HasCallStack =&gt; FsPath -&gt; m ())
-&gt; (HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ())
-&gt; (FsPath -&gt; FsErrorPath)
-&gt; HasFS m h
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-32"></span><span>      </span><span class="hs-comment">-- TODO(adn) Might be useful to implement this properly by reading all</span><span>
</span><span id="line-33"></span><span>      </span><span class="hs-comment">-- the stuff available at the 'MountPoint'.</span><span>
</span><span id="line-34"></span><span>      </span><span class="annot"><span class="annottext">dumpState :: IO String
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#dumpState"><span class="hs-identifier hs-var">dumpState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO String
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&lt;dumpState@IO&gt;&quot;</span></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; IO (Handle HandleIO)
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hOpen"><span class="hs-identifier hs-var">hOpen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982863"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982863"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621679982862"><span class="annot"><span class="annottext">OpenMode
</span><a href="#local-6989586621679982862"><span class="hs-identifier hs-var">openMode</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-36"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679982861"><span class="annot"><span class="annottext">path :: String
</span><a href="#local-6989586621679982861"><span class="hs-identifier hs-var hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982863"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-37"></span><span>        </span><span id="local-6989586621679982859"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679982859"><span class="hs-identifier hs-var">osHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO Fd -&gt; IO Fd
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982863"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Fd -&gt; IO Fd) -&gt; IO Fd -&gt; IO Fd
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-38"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; OpenMode -&gt; IO Fd
</span><a href="Ouroboros.Consensus.Storage.IO.html#open"><span class="hs-identifier hs-var">F.open</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679982861"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">OpenMode
</span><a href="#local-6989586621679982862"><span class="hs-identifier hs-var">openMode</span></a></span><span>
</span><span id="line-39"></span><span>        </span><span id="local-6989586621679982856"><span class="annot"><span class="annottext">MVar (Maybe Fd)
</span><a href="#local-6989586621679982856"><span class="hs-identifier hs-var">hVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Fd -&gt; IO (MVar (Maybe Fd))
forall a. a -&gt; IO (MVar a)
</span><span class="hs-identifier hs-var">newMVar</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Fd -&gt; IO (MVar (Maybe Fd)))
-&gt; Maybe Fd -&gt; IO (MVar (Maybe Fd))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fd -&gt; Maybe Fd
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621679982859"><span class="hs-identifier hs-var">osHandle</span></a></span><span>
</span><span id="line-40"></span><span>        </span><span class="annot"><span class="annottext">Handle HandleIO -&gt; IO (Handle HandleIO)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Handle HandleIO -&gt; IO (Handle HandleIO))
-&gt; Handle HandleIO -&gt; IO (Handle HandleIO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandleIO -&gt; FsPath -&gt; Handle HandleIO
forall h. h -&gt; FsPath -&gt; Handle h
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-var">Handle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; MVar (Maybe Fd) -&gt; HandleIO
forall osHandle.
String -&gt; MVar (Maybe osHandle) -&gt; HandleOS osHandle
</span><a href="Ouroboros.Consensus.Storage.FS.Handle.html#HandleOS"><span class="hs-identifier hs-var">H.HandleOS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679982861"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe Fd)
</span><a href="#local-6989586621679982856"><span class="hs-identifier hs-var">hVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982863"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hClose :: HasCallStack =&gt; Handle HandleIO -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose"><span class="hs-identifier hs-var">hClose</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982851"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982851"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982850"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982850"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982850"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-42"></span><span>        </span><span class="annot"><span class="annottext">HandleIO -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.IO.html#close"><span class="hs-identifier hs-var">F.close</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982851"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hIsOpen :: HasCallStack =&gt; Handle HandleIO -&gt; IO Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hIsOpen"><span class="hs-identifier hs-var">hIsOpen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HandleIO -&gt; IO Bool
forall osHandle. HandleOS osHandle -&gt; IO Bool
</span><a href="Ouroboros.Consensus.Storage.FS.Handle.html#isOpenHandleOS"><span class="hs-identifier hs-var">H.isOpenHandleOS</span></a></span><span> </span><span class="annot"><span class="annottext">(HandleIO -&gt; IO Bool)
-&gt; (Handle HandleIO -&gt; HandleIO) -&gt; Handle HandleIO -&gt; IO Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Handle HandleIO -&gt; HandleIO
forall h. Handle h -&gt; h
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#handleRaw"><span class="hs-identifier hs-var hs-var">handleRaw</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hSeek :: HasCallStack =&gt; Handle HandleIO -&gt; SeekMode -&gt; Int64 -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hSeek"><span class="hs-identifier hs-var">hSeek</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982843"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982843"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982842"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982842"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679982841"><span class="annot"><span class="annottext">SeekMode
</span><a href="#local-6989586621679982841"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621679982840"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679982840"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982842"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-45"></span><span>        </span><span class="annot"><span class="annottext">HandleIO -&gt; SeekMode -&gt; Int64 -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.IO.html#seek"><span class="hs-identifier hs-var">F.seek</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982843"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">SeekMode
</span><a href="#local-6989586621679982841"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679982840"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hGetSome :: HasCallStack =&gt; Handle HandleIO -&gt; Word64 -&gt; IO ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSome"><span class="hs-identifier hs-var">hGetSome</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982837"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982837"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982836"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982836"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679982835"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679982835"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO ByteString -&gt; IO ByteString
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982836"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ByteString) -&gt; IO ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-47"></span><span>        </span><span class="annot"><span class="annottext">HandleIO -&gt; Word64 -&gt; IO ByteString
</span><a href="Ouroboros.Consensus.Storage.IO.html#read"><span class="hs-identifier hs-var">F.read</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982837"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679982835"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hGetSomeAt :: HasCallStack =&gt;
Handle HandleIO -&gt; Word64 -&gt; AbsOffset -&gt; IO ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSomeAt"><span class="hs-identifier hs-var">hGetSomeAt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982832"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982832"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982831"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982831"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679982830"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679982830"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679982829"><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679982829"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO ByteString -&gt; IO ByteString
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982831"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ByteString) -&gt; IO ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-49"></span><span>        </span><span class="annot"><span class="annottext">HandleIO -&gt; Word64 -&gt; Word64 -&gt; IO ByteString
</span><a href="Ouroboros.Consensus.Storage.IO.html#pread"><span class="hs-identifier hs-var">F.pread</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982832"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679982830"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbsOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#unAbsOffset"><span class="hs-identifier hs-var hs-var">unAbsOffset</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679982829"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hTruncate :: HasCallStack =&gt; Handle HandleIO -&gt; Word64 -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hTruncate"><span class="hs-identifier hs-var">hTruncate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982825"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982825"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982824"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982824"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679982823"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679982823"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982824"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-51"></span><span>        </span><span class="annot"><span class="annottext">HandleIO -&gt; Word64 -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.IO.html#truncate"><span class="hs-identifier hs-var">F.truncate</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982825"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679982823"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hGetSize :: HasCallStack =&gt; Handle HandleIO -&gt; IO Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSize"><span class="hs-identifier hs-var">hGetSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982820"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982820"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982819"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982819"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO Word64 -&gt; IO Word64
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982819"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Word64 -&gt; IO Word64) -&gt; IO Word64 -&gt; IO Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-53"></span><span>        </span><span class="annot"><span class="annottext">HandleIO -&gt; IO Word64
</span><a href="Ouroboros.Consensus.Storage.IO.html#getSize"><span class="hs-identifier hs-var">F.getSize</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982820"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hPutSome :: HasCallStack =&gt; Handle HandleIO -&gt; ByteString -&gt; IO Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutSome"><span class="hs-identifier hs-var">hPutSome</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span id="local-6989586621679982816"><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982816"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679982815"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982815"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679982814"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679982814"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO Word64 -&gt; IO Word64
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982815"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Word64 -&gt; IO Word64) -&gt; IO Word64 -&gt; IO Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; (CStringLen -&gt; IO Word64) -&gt; IO Word64
forall a. ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.unsafeUseAsCStringLen</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679982814"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">((CStringLen -&gt; IO Word64) -&gt; IO Word64)
-&gt; (CStringLen -&gt; IO Word64) -&gt; IO Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679982812"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621679982812"><span class="hs-identifier hs-var">ptr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679982811"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679982811"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-56"></span><span>            </span><span class="annot"><span class="annottext">Word32 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Word64) -&gt; IO Word32 -&gt; IO Word64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HandleIO -&gt; Ptr Word8 -&gt; Int64 -&gt; IO Word32
</span><a href="Ouroboros.Consensus.Storage.IO.html#write"><span class="hs-identifier hs-var">F.write</span></a></span><span> </span><span class="annot"><span class="annottext">HandleIO
</span><a href="#local-6989586621679982816"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621679982812"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679982811"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">createDirectory :: HasCallStack =&gt; FsPath -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#createDirectory"><span class="hs-identifier hs-var">createDirectory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982807"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982807"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982807"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-58"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">Dir.createDirectory</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982807"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">listDirectory :: HasCallStack =&gt; FsPath -&gt; IO (Set String)
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#listDirectory"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982804"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982804"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO (Set String) -&gt; IO (Set String)
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982804"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Set String) -&gt; IO (Set String))
-&gt; IO (Set String) -&gt; IO (Set String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-60"></span><span>        </span><span class="annot"><span class="annottext">[String] -&gt; Set String
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; Set String) -&gt; IO [String] -&gt; IO (Set String)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO [String]
</span><span class="hs-identifier hs-var">Dir.listDirectory</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982804"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">doesDirectoryExist :: HasCallStack =&gt; FsPath -&gt; IO Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#doesDirectoryExist"><span class="hs-identifier hs-var">doesDirectoryExist</span></a></span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982800"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982800"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO Bool -&gt; IO Bool
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982800"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO Bool) -&gt; IO Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-62"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO Bool
</span><span class="hs-identifier hs-var">Dir.doesDirectoryExist</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982800"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">doesFileExist :: HasCallStack =&gt; FsPath -&gt; IO Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#doesFileExist"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982797"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982797"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO Bool -&gt; IO Bool
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982797"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO Bool) -&gt; IO Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO Bool
</span><span class="hs-identifier hs-var">Dir.doesFileExist</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982797"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">createDirectoryIfMissing :: HasCallStack =&gt; Bool -&gt; FsPath -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#createDirectoryIfMissing"><span class="hs-identifier hs-var">createDirectoryIfMissing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982794"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679982794"><span class="hs-identifier hs-var">createParent</span></a></span></span><span> </span><span id="local-6989586621679982793"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982793"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982793"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-66"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">Dir.createDirectoryIfMissing</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679982794"><span class="hs-identifier hs-var">createParent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982793"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">removeFile :: HasCallStack =&gt; FsPath -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#removeFile"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982790"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982790"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982790"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-68"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">Dir.removeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982790"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; IO ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#renameFile"><span class="hs-identifier hs-var">renameFile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679982787"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982787"><span class="hs-identifier hs-var">fp1</span></a></span></span><span> </span><span id="local-6989586621679982786"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982786"><span class="hs-identifier hs-var">fp2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; IO () -&gt; IO ()
forall a. HasCallStack =&gt; FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var">rethrowFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982787"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-70"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">Dir.renameFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982787"><span class="hs-identifier hs-var">fp1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var">root</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982786"><span class="hs-identifier hs-var">fp2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mkFsErrorPath :: FsPath -&gt; FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#mkFsErrorPath"><span class="hs-identifier hs-var">mkFsErrorPath</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MountPoint -&gt; FsPath -&gt; FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsToFsErrorPath"><span class="hs-identifier hs-var">fsToFsErrorPath</span></a></span><span> </span><span class="annot"><span class="annottext">MountPoint
</span><a href="#local-6989586621679982867"><span class="hs-identifier hs-var">mount</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="#local-6989586621679982860"><span class="hs-identifier hs-type">root</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621679982860"><span class="annot"><span class="annottext">root :: FsPath -&gt; String
</span><a href="#local-6989586621679982860"><span class="hs-identifier hs-var hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MountPoint -&gt; FsPath -&gt; String
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsToFilePath"><span class="hs-identifier hs-var">fsToFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">MountPoint
</span><a href="#local-6989586621679982867"><span class="hs-identifier hs-var">mount</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- | Catch IO exceptions and rethrow them as 'FsError'</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- See comments for 'ioToFsError'</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621679982905"><span class="annot"><a href="#local-6989586621679982858"><span class="hs-identifier hs-type">rethrowFsError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679982905"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679982905"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621679982858"><span class="annot"><span class="annottext">rethrowFsError :: FsPath -&gt; IO a -&gt; IO a
</span><a href="#local-6989586621679982858"><span class="hs-identifier hs-var hs-var">rethrowFsError</span></a></span></span><span> </span><span id="local-6989586621679982780"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982780"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621679982779"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679982779"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-82"></span><span>        </span><span id="local-6989586621679982778"><span class="annot"><span class="annottext">Either IOError a
</span><a href="#local-6989586621679982778"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO (Either IOError a)
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">E.try</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679982779"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-83"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either IOError a
</span><a href="#local-6989586621679982778"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-84"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679982776"><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679982776"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IOError -&gt; IO a
forall a. HasCallStack =&gt; IOError -&gt; IO a
</span><a href="#local-6989586621679982775"><span class="hs-identifier hs-var">handleError</span></a></span><span> </span><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679982776"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-85"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679982774"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679982774"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679982774"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-87"></span><span>        </span><span id="local-6989586621679982875"><span class="annot"><a href="#local-6989586621679982775"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOError</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679982875"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-88"></span><span>        </span><span id="local-6989586621679982775"><span class="annot"><span class="annottext">handleError :: IOError -&gt; IO a
</span><a href="#local-6989586621679982775"><span class="hs-identifier hs-var hs-var">handleError</span></a></span></span><span> </span><span id="local-6989586621679982773"><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679982773"><span class="hs-identifier hs-var">ioErr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FsError -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(FsError -&gt; IO a) -&gt; FsError -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsErrorPath -&gt; IOError -&gt; FsError
FsErrorPath -&gt; IOError -&gt; FsError
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#ioToFsError"><span class="hs-identifier hs-var">ioToFsError</span></a></span><span> </span><span class="annot"><span class="annottext">FsErrorPath
</span><a href="#local-6989586621679982770"><span class="hs-identifier hs-var">errorPath</span></a></span><span> </span><span class="annot"><span class="annottext">IOError
</span><a href="#local-6989586621679982773"><span class="hs-identifier hs-var">ioErr</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>        </span><span class="annot"><a href="#local-6989586621679982770"><span class="hs-identifier hs-type">errorPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsErrorPath"><span class="hs-identifier hs-type">FsErrorPath</span></a></span><span>
</span><span id="line-91"></span><span>        </span><span id="local-6989586621679982770"><span class="annot"><span class="annottext">errorPath :: FsErrorPath
</span><a href="#local-6989586621679982770"><span class="hs-identifier hs-var hs-var">errorPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MountPoint -&gt; FsPath -&gt; FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsToFsErrorPath"><span class="hs-identifier hs-var">fsToFsErrorPath</span></a></span><span> </span><span class="annot"><span class="annottext">MountPoint
</span><a href="#local-6989586621679982867"><span class="hs-identifier hs-var">mount</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679982780"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-92"></span></pre></body></html>