<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass             #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification  #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase                 #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns             #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings          #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                 #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards            #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.State</span><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * State types</span><span>
</span><a name="line-14"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#dbIsOpen"><span class="hs-identifier hs-var">dbIsOpen</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>    </span><span class="hs-comment">-- * State helpers</span><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#getOpenState"><span class="hs-identifier hs-var">getOpenState</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#modifyOpenState"><span class="hs-identifier hs-var">modifyOpenState</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#withOpenState"><span class="hs-identifier hs-var">withOpenState</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#closeOpenHandles"><span class="hs-identifier hs-var">closeOpenHandles</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cleanUp"><span class="hs-identifier hs-var">cleanUp</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.State.Strict</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html"><span class="hs-identifier">Control.Tracer</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Generics</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Stack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.html"><span class="hs-identifier">Cardano.Prelude</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.html#SomePair"><span class="hs-identifier hs-type">SomePair</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>                     </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var">allocateTemp</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#modifyWithTempRegistry"><span class="hs-identifier hs-var">modifyWithTempRegistry</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.FS.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API.Types</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Index</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a><span>
</span><a name="line-47"></a><span>                     </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a><span>
</span><a name="line-49"></a><span>                     </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockOffset"><span class="hs-identifier hs-type">BlockOffset</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Parser.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Parser</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Parser.html#BlockSummary"><span class="hs-identifier hs-type">BlockSummary</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Types</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">{------------------------------------------------------------------------------
  Main types
------------------------------------------------------------------------------}</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-comment">-- | The environment used by the immutable database.</span><span>
</span><a name="line-59"></a><span class="hs-keyword">data</span><span> </span><a name="ImmutableDBEnv"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier">ImmutableDBEnv</span></a></a><span> </span><a name="local-6989586621679495124"><a href="#local-6989586621679495124"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495125"><a href="#local-6989586621679495125"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679495126"><a href="#local-6989586621679495126"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679495127"><a href="#local-6989586621679495127"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679495126"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="ImmutableDBEnv"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier">ImmutableDBEnv</span></a></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="hasFS"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#hasFS"><span class="hs-identifier">hasFS</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495124"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495126"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="varInternalState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#varInternalState"><span class="hs-identifier">varInternalState</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#StrictMVar"><span class="hs-identifier hs-type">StrictMVar</span></a><span> </span><a href="#local-6989586621679495124"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a><span> </span><a href="#local-6989586621679495124"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495125"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495126"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="chunkFileParser"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkFileParser"><span class="hs-identifier">chunkFileParser</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ChunkFileParser"><span class="hs-identifier hs-type">ChunkFileParser</span></a><span> </span><a href="#local-6989586621679495127"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679495124"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Parser.html#BlockSummary"><span class="hs-identifier hs-type">BlockSummary</span></a><span> </span><a href="#local-6989586621679495125"><span class="hs-identifier hs-type">hash</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679495125"><span class="hs-identifier hs-type">hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="chunkInfo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier">chunkInfo</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a><span>
</span><a name="line-64"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="hashInfo"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#hashInfo"><span class="hs-identifier">hashInfo</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#HashInfo"><span class="hs-identifier hs-type">HashInfo</span></a><span> </span><a href="#local-6989586621679495125"><span class="hs-identifier hs-type">hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tracer"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#tracer"><span class="hs-identifier">tracer</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679495124"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a><span> </span><a href="#local-6989586621679495127"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679495125"><span class="hs-identifier hs-type">hash</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="registry"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#registry"><span class="hs-identifier">registry</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a><span> </span><a href="#local-6989586621679495124"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="cacheConfig"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cacheConfig"><span class="hs-identifier">cacheConfig</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier hs-type">Index.CacheConfig</span></a><span>
</span><a name="line-68"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-keyword">data</span><span> </span><a name="InternalState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#InternalState"><span class="hs-identifier">InternalState</span></a></a><span> </span><a name="local-6989586621679495121"><a href="#local-6989586621679495121"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495122"><a href="#local-6989586621679495122"><span class="hs-identifier">hash</span></a></a><span> </span><a name="local-6989586621679495123"><a href="#local-6989586621679495123"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-71"></a><span>    </span><a name="DbClosed"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier">DbClosed</span></a></a><span>
</span><a name="line-72"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DbOpen"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier">DbOpen</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495121"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495122"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495123"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-identifier">dbIsOpen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a><span> </span><a href="#local-6989586621679495147"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495148"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495149"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-76"></a><a name="dbIsOpen"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#dbIsOpen"><span class="hs-identifier">dbIsOpen</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-77"></a><span class="hs-identifier">dbIsOpen</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-comment">-- | Internal state when the database is open.</span><span>
</span><a name="line-80"></a><span class="hs-keyword">data</span><span> </span><a name="OpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier">OpenState</span></a></a><span> </span><a name="local-6989586621679495118"><a href="#local-6989586621679495118"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495119"><a href="#local-6989586621679495119"><span class="hs-identifier">hash</span></a></a><span> </span><a name="local-6989586621679495120"><a href="#local-6989586621679495120"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier">OpenState</span></a></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="currentChunk"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunk"><span class="hs-identifier">currentChunk</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-82"></a><span>      </span><span class="hs-comment">-- ^ The current 'ChunkNo' the immutable store is writing to.</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentChunkOffset"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunkOffset"><span class="hs-identifier">currentChunkOffset</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockOffset"><span class="hs-identifier hs-type">BlockOffset</span></a><span>
</span><a name="line-84"></a><span>      </span><span class="hs-comment">-- ^ The offset at which the next block will be written in the current</span><span>
</span><a name="line-85"></a><span>      </span><span class="hs-comment">-- chunk file.</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentSecondaryOffset"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentSecondaryOffset"><span class="hs-identifier">currentSecondaryOffset</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a><span>
</span><a name="line-87"></a><span>      </span><span class="hs-comment">-- ^ The offset at which the next index entry will be written in the</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-comment">-- current secondary index.</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentChunkHandle"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunkHandle"><span class="hs-identifier">currentChunkHandle</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><a href="#local-6989586621679495120"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-comment">-- ^ The write handle for the current chunk file.</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentPrimaryHandle"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentPrimaryHandle"><span class="hs-identifier">currentPrimaryHandle</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><a href="#local-6989586621679495120"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>      </span><span class="hs-comment">-- ^ The write handle for the current primary index file.</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentSecondaryHandle"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentSecondaryHandle"><span class="hs-identifier">currentSecondaryHandle</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><a href="#local-6989586621679495120"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>      </span><span class="hs-comment">-- ^ The write handle for the current secondary index file.</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentTip"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentTip"><span class="hs-identifier">currentTip</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ImmTipWithInfo"><span class="hs-identifier hs-type">ImmTipWithInfo</span></a><span> </span><a href="#local-6989586621679495119"><span class="hs-identifier hs-type">hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>      </span><span class="hs-comment">-- ^ The current tip of the database.</span><span>
</span><a name="line-97"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="currentIndex"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentIndex"><span class="hs-identifier">currentIndex</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a><span> </span><a href="#local-6989586621679495118"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495119"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495120"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>      </span><span class="hs-comment">-- ^ An abstraction layer on top of the indices to allow for caching.</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-100"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">{------------------------------------------------------------------------------
  State helpers
------------------------------------------------------------------------------}</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">-- | Create the internal open state for the given chunk.</span><span>
</span><a name="line-107"></a><span class="hs-identifier">mkOpenState</span><span>
</span><a name="line-108"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679495144"><a href="#local-6989586621679495144"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495145"><a href="#local-6989586621679495145"><span class="hs-identifier">hash</span></a></a><span> </span><a name="local-6989586621679495146"><a href="#local-6989586621679495146"><span class="hs-identifier">h</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span>
</span><a name="line-110"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495145"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a><span>
</span><a name="line-112"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ImmTipWithInfo"><span class="hs-identifier hs-type">ImmTipWithInfo</span></a><span> </span><a href="#local-6989586621679495145"><span class="hs-identifier hs-type">hash</span></a><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AllowExisting"><span class="hs-identifier hs-type">AllowExisting</span></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495145"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495145"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><a name="mkOpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#mkOpenState"><span class="hs-identifier">mkOpenState</span></a></a><span> </span><a name="local-6989586621679495150"><a href="#local-6989586621679495150"><span class="hs-identifier">hasFS</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-var">HasFS</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679495169"><a href="#local-6989586621679495169"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621679495170"><a href="#local-6989586621679495170"><span class="hs-identifier">chunk</span></a></a><span> </span><a name="local-6989586621679495171"><a href="#local-6989586621679495171"><span class="hs-identifier">tip</span></a></a><span> </span><a name="local-6989586621679495172"><a href="#local-6989586621679495172"><span class="hs-identifier">existing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-116"></a><span>    </span><a name="local-6989586621679495177"><a href="#local-6989586621679495177"><span class="hs-identifier">eHnd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679495174"><span class="hs-identifier hs-var">allocateHandle</span></a><span> </span><span class="hs-identifier">currentChunkHandle</span><span>     </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679495152"><span class="hs-identifier hs-var">hOpen</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a><span>          </span><a href="#local-6989586621679495170"><span class="hs-identifier hs-var">chunk</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679495173"><span class="hs-identifier hs-var">appendMode</span></a><span>
</span><a name="line-117"></a><span>    </span><a name="local-6989586621679495178"><a href="#local-6989586621679495178"><span class="hs-identifier">pHnd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679495174"><span class="hs-identifier hs-var">allocateHandle</span></a><span> </span><span class="hs-identifier">currentPrimaryHandle</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">Index.openPrimaryIndex</span><span> </span><a href="#local-6989586621679495169"><span class="hs-identifier hs-var">index</span></a><span>    </span><a href="#local-6989586621679495170"><span class="hs-identifier hs-var">chunk</span></a><span>  </span><a href="#local-6989586621679495172"><span class="hs-identifier hs-var">existing</span></a><span>
</span><a name="line-118"></a><span>    </span><a name="local-6989586621679495179"><a href="#local-6989586621679495179"><span class="hs-identifier">sHnd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679495174"><span class="hs-identifier hs-var">allocateHandle</span></a><span> </span><span class="hs-identifier">currentSecondaryHandle</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679495152"><span class="hs-identifier hs-var">hOpen</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathSecondaryIndexFile"><span class="hs-identifier hs-var">fsPathSecondaryIndexFile</span></a><span> </span><a href="#local-6989586621679495170"><span class="hs-identifier hs-var">chunk</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679495173"><span class="hs-identifier hs-var">appendMode</span></a><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621679495180"><a href="#local-6989586621679495180"><span class="hs-identifier">chunkOffset</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679495160"><span class="hs-identifier hs-var">hGetSize</span></a><span> </span><a href="#local-6989586621679495177"><span class="hs-identifier hs-var">eHnd</span></a><span>
</span><a name="line-120"></a><span>    </span><a name="local-6989586621679495181"><a href="#local-6989586621679495181"><span class="hs-identifier">secondaryOffset</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679495160"><span class="hs-identifier hs-var">hGetSize</span></a><span> </span><a href="#local-6989586621679495179"><span class="hs-identifier hs-var">sHnd</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span>
</span><a name="line-122"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">currentChunk</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495170"><span class="hs-identifier hs-var">chunk</span></a><span>
</span><a name="line-123"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentChunkOffset</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockOffset"><span class="hs-identifier hs-var">BlockOffset</span></a><span> </span><a href="#local-6989586621679495180"><span class="hs-identifier hs-var">chunkOffset</span></a><span>
</span><a name="line-124"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentSecondaryOffset</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679495181"><span class="hs-identifier hs-var">secondaryOffset</span></a><span>
</span><a name="line-125"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentChunkHandle</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495177"><span class="hs-identifier hs-var">eHnd</span></a><span>
</span><a name="line-126"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentPrimaryHandle</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495178"><span class="hs-identifier hs-var">pHnd</span></a><span>
</span><a name="line-127"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentSecondaryHandle</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495179"><span class="hs-identifier hs-var">sHnd</span></a><span>
</span><a name="line-128"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentTip</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495171"><span class="hs-identifier hs-var">tip</span></a><span>
</span><a name="line-129"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">currentIndex</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495169"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-130"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-131"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-132"></a><span>    </span><a name="local-6989586621679495173"><a href="#local-6989586621679495173"><span class="hs-identifier">appendMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AppendMode"><span class="hs-identifier hs-var">AppendMode</span></a><span> </span><a href="#local-6989586621679495172"><span class="hs-identifier hs-var">existing</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span>    </span><span class="hs-identifier">allocateHandle</span><span>
</span><a name="line-135"></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495145"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495145"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679495144"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><a href="#local-6989586621679495146"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>    </span><a name="local-6989586621679495174"><a href="#local-6989586621679495174"><span class="hs-identifier">allocateHandle</span></a></a><span> </span><a name="local-6989586621679495175"><a href="#local-6989586621679495175"><span class="hs-identifier">getHandle</span></a></a><span> </span><a name="local-6989586621679495176"><a href="#local-6989586621679495176"><span class="hs-identifier">open</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-139"></a><span>      </span><span class="hs-comment">-- To check whether the handle made it in the final state, we check for</span><span>
</span><a name="line-140"></a><span>      </span><span class="hs-comment">-- equality.</span><span>
</span><a name="line-141"></a><span>      </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var">allocateTemp</span></a><span> </span><a href="#local-6989586621679495176"><span class="hs-identifier hs-var">open</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose%27"><span class="hs-identifier hs-var">hClose'</span></a><span> </span><a href="#local-6989586621679495150"><span class="hs-identifier hs-var">hasFS</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679495175"><span class="hs-identifier hs-var">getHandle</span></a><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | Get the 'OpenState' of the given database, throw a 'ClosedDBError' in</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- case it is closed.</span><span>
</span><a name="line-145"></a><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- NOTE: Since the 'OpenState' is parameterized over a type parameter @h@ of</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- handles, which is not visible from the type of the @ImmutableDBEnv@,</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- we return a @SomePair@ here that returns the open state along with a 'HasFS'</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- instance for the /same/ type parameter @h@. Note that it would be impossible</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- to use an existing 'HasFS' instance already in scope otherwise, since the</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- @h@ parameters would not be known to match.</span><span>
</span><a name="line-152"></a><span class="hs-identifier">getOpenState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679495142"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a><span> </span><a href="#local-6989586621679495142"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495143"><span class="hs-identifier hs-type">hash</span></a><span>
</span><a name="line-154"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495142"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.html#SomePair"><span class="hs-identifier hs-type">SomePair</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495142"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495142"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495143"><span class="hs-identifier hs-type">hash</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><a name="getOpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#getOpenState"><span class="hs-identifier">getOpenState</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-var">ImmutableDBEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-156"></a><span>    </span><span class="hs-comment">-- We use 'readMVarSTM' to read a potentially stale internal state if</span><span>
</span><a name="line-157"></a><span>    </span><span class="hs-comment">-- somebody's appending to the ImmutableDB at the same time.</span><span>
</span><a name="line-158"></a><span>    </span><a name="local-6989586621679495190"><a href="#local-6989586621679495190"><span class="hs-identifier">internalState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#readMVarSTM"><span class="hs-identifier hs-var">readMVarSTM</span></a><span> </span><a href="#local-6989586621679495183"><span class="hs-identifier hs-var">varInternalState</span></a><span>
</span><a name="line-159"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679495190"><span class="hs-identifier hs-var">internalState</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-160"></a><span>       </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#throwUserError"><span class="hs-identifier hs-var">throwUserError</span></a><span>  </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ClosedDBError"><span class="hs-identifier hs-var">ClosedDBError</span></a><span>
</span><a name="line-161"></a><span>       </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a name="local-6989586621679495191"><a href="#local-6989586621679495191"><span class="hs-identifier">openState</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.html#SomePair"><span class="hs-identifier hs-var">SomePair</span></a><span> </span><a href="#local-6989586621679495182"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679495191"><span class="hs-identifier hs-var">openState</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- | Shorthand</span><span>
</span><a name="line-164"></a><span class="hs-keyword">type</span><span> </span><a name="ModifyOpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier">ModifyOpenState</span></a></a><span> </span><a name="local-6989586621679495115"><a href="#local-6989586621679495115"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495116"><a href="#local-6989586621679495116"><span class="hs-identifier">hash</span></a></a><span> </span><a name="local-6989586621679495117"><a href="#local-6989586621679495117"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-165"></a><span>  </span><span class="hs-identifier hs-type">StateT</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495115"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495116"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495117"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495115"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495116"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495117"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679495115"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">-- | Modify the internal state of an open database.</span><span>
</span><a name="line-168"></a><span class="hs-comment">--</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- In case the database is closed, a 'ClosedDBError' is thrown.</span><span>
</span><a name="line-170"></a><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- In case an 'UnexpectedError' is thrown, the database is closed to prevent</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- further appending to a database in a potentially inconsistent state.</span><span>
</span><a name="line-173"></a><span class="hs-comment">--</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- The action is run in the 'ModifyOpenState' monad, which is a 'StateT'</span><span>
</span><a name="line-175"></a><span class="hs-comment">-- transformer (of the 'OpenState') over the 'WithTempRegistry' monad. This</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- monad can be used to allocate resources in that will be transferred to the</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- returned 'OpenState' that is safely stored in the 'ImmutableDBEnv'. This</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- approach makes sure that no resources are leaked when an exception is</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- thrown while running the action modifying the state.</span><span>
</span><a name="line-180"></a><span class="hs-comment">--</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- __Note__: This /takes/ the 'TMVar', /then/ runs the action (which might be</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- in 'IO'), and then puts the 'TMVar' back, just like</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- 'Control.Concurrent.MVar.modifyMVar' does. Consequently, it has the same</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- gotchas that @modifyMVar@ does; the effects are observable and it is</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- susceptible to deadlock.</span><span>
</span><a name="line-186"></a><span class="hs-identifier">modifyOpenState</span><span>
</span><a name="line-187"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679495138"><a href="#local-6989586621679495138"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495139"><a href="#local-6989586621679495139"><span class="hs-identifier">hash</span></a></a><span> </span><a name="local-6989586621679495140"><a href="#local-6989586621679495140"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495139"><span class="hs-identifier hs-type">hash</span></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679495141"><a href="#local-6989586621679495141"><span class="hs-identifier">h</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679495141"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495141"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495139"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495141"><span class="hs-identifier hs-type">h</span></a><span> </span><a href="#local-6989586621679495140"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495140"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-191"></a><a name="modifyOpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#modifyOpenState"><span class="hs-identifier">modifyOpenState</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-var">ImmutableDBEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hasFS</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679495193"><a href="#local-6989586621679495193"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495192"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><a name="local-6989586621679495201"><a href="#local-6989586621679495201"><span class="hs-identifier">modSt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-192"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#wrapFsError"><span class="hs-identifier hs-var">wrapFsError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#modifyWithTempRegistry"><span class="hs-identifier hs-var">modifyWithTempRegistry</span></a><span> </span><a href="#local-6989586621679495202"><span class="hs-identifier hs-var">getSt</span></a><span> </span><a href="#local-6989586621679495203"><span class="hs-identifier hs-var">putSt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679495201"><span class="hs-identifier hs-var">modSt</span></a><span> </span><a href="#local-6989586621679495193"><span class="hs-identifier hs-var">hasFS</span></a><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-194"></a><span>    </span><span class="hs-comment">-- TODO Is uninterruptibleMask_ absolutely necessary here?</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-identifier">getSt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495139"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495192"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621679495202"><a href="#local-6989586621679495202"><span class="hs-identifier">getSt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#uninterruptibleMask_"><span class="hs-identifier hs-var">uninterruptibleMask_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a><span> </span><a href="#local-6989586621679495194"><span class="hs-identifier hs-var">varInternalState</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-197"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a name="local-6989586621679495204"><a href="#local-6989586621679495204"><span class="hs-identifier">ost</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679495204"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-198"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-199"></a><span>        </span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679495194"><span class="hs-identifier hs-var">varInternalState</span></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>
</span><a name="line-200"></a><span>        </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#throwUserError"><span class="hs-identifier hs-var">throwUserError</span></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ClosedDBError"><span class="hs-identifier hs-var">ClosedDBError</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>    </span><span class="hs-identifier">putSt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495139"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495192"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCase"><span class="hs-identifier hs-type">ExitCase</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495139"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495192"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495138"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>    </span><a name="local-6989586621679495203"><a href="#local-6989586621679495203"><span class="hs-identifier">putSt</span></a></a><span> </span><a name="local-6989586621679495205"><a href="#local-6989586621679495205"><span class="hs-identifier">ost</span></a></a><span> </span><a name="local-6989586621679495206"><a href="#local-6989586621679495206"><span class="hs-identifier">ec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-comment">-- It is crucial to replace the MVar.</span><span>
</span><a name="line-205"></a><span>        </span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a><span> </span><a href="#local-6989586621679495194"><span class="hs-identifier hs-var">varInternalState</span></a><span> </span><a href="#local-6989586621679495207"><span class="hs-identifier hs-var">st'</span></a><span>
</span><a name="line-206"></a><span>        </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#dbIsOpen"><span class="hs-identifier hs-var">dbIsOpen</span></a><span> </span><a href="#local-6989586621679495207"><span class="hs-identifier hs-var">st'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cleanUp"><span class="hs-identifier hs-var">cleanUp</span></a><span> </span><a href="#local-6989586621679495193"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679495205"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-207"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-208"></a><span>        </span><a name="local-6989586621679495207"><a href="#local-6989586621679495207"><span class="hs-identifier">st'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679495206"><span class="hs-identifier hs-var">ec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-209"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseSuccess"><span class="hs-identifier hs-var">ExitCaseSuccess</span></a><span> </span><a name="local-6989586621679495208"><a href="#local-6989586621679495208"><span class="hs-identifier">ost'</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a href="#local-6989586621679495208"><span class="hs-identifier hs-var">ost'</span></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span>          </span><span class="hs-comment">-- When something goes wrong, close the ImmutableDB for safety.</span><span>
</span><a name="line-212"></a><span>          </span><span class="hs-comment">-- Except for user errors, because they stem from incorrect use of</span><span>
</span><a name="line-213"></a><span>          </span><span class="hs-comment">-- the ImmutableDB.</span><span>
</span><a name="line-214"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-215"></a><span>          </span><span class="hs-comment">-- NOTE: we only modify the ImmutableDB in a background thread of</span><span>
</span><a name="line-216"></a><span>          </span><span class="hs-comment">-- the ChainDB, not in per-connection threads that could be killed</span><span>
</span><a name="line-217"></a><span>          </span><span class="hs-comment">-- at any point. When an exception is encountered while modifying</span><span>
</span><a name="line-218"></a><span>          </span><span class="hs-comment">-- the ImmutableDB in the background thread, or that background</span><span>
</span><a name="line-219"></a><span>          </span><span class="hs-comment">-- thread itself is killed with an async exception, we will shut</span><span>
</span><a name="line-220"></a><span>          </span><span class="hs-comment">-- down the node anway, so it is safe to close the ImmutableDB here.</span><span>
</span><a name="line-221"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseAbort"><span class="hs-identifier hs-var">ExitCaseAbort</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>
</span><a name="line-222"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseException"><span class="hs-identifier hs-var">ExitCaseException</span></a><span> </span><a name="local-6989586621679495209"><a href="#local-6989586621679495209"><span class="hs-identifier">ex</span></a></a><span>
</span><a name="line-223"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#UserError"><span class="hs-identifier hs-var">UserError</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromException</span><span> </span><a href="#local-6989586621679495209"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-224"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a href="#local-6989586621679495205"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-225"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-226"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- | Perform an action that accesses the internal state of an open database.</span><span>
</span><a name="line-229"></a><span class="hs-comment">--</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- In case the database is closed, a 'ClosedDBError' is thrown.</span><span>
</span><a name="line-231"></a><span class="hs-comment">--</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- In case an 'UnexpectedError' is thrown while the action is being run, the</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- database is closed to prevent further appending to a database in a</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- potentially inconsistent state.</span><span>
</span><a name="line-235"></a><span class="hs-identifier">withOpenState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679495134"><a href="#local-6989586621679495134"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679495135"><a href="#local-6989586621679495135"><span class="hs-identifier">hash</span></a></a><span> </span><a name="local-6989586621679495136"><a href="#local-6989586621679495136"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495135"><span class="hs-identifier hs-type">hash</span></a><span>
</span><a name="line-237"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679495137"><a href="#local-6989586621679495137"><span class="hs-identifier">h</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495137"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495135"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495137"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495136"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495136"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-239"></a><a name="withOpenState"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#withOpenState"><span class="hs-identifier">withOpenState</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-var">ImmutableDBEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hasFS</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679495211"><a href="#local-6989586621679495211"><span class="hs-identifier">hasFS</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495210"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><a name="local-6989586621679495219"><a href="#local-6989586621679495219"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-240"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679495246"><a href="#local-6989586621679495246"><span class="hs-identifier">mr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#generalBracket"><span class="hs-identifier hs-var">generalBracket</span></a><span> </span><a href="#local-6989586621679495238"><span class="hs-identifier hs-var">open</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621679495239"><span class="hs-identifier hs-var">close</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#tryImmDB"><span class="hs-identifier hs-var">tryImmDB</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679495241"><span class="hs-identifier hs-var">access</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679495246"><span class="hs-identifier hs-var">mr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-242"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679495247"><a href="#local-6989586621679495247"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><a href="#local-6989586621679495247"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-243"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679495248"><a href="#local-6989586621679495248"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679495248"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-244"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-245"></a><span>    </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-var">HasFS</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495211"><span class="hs-identifier hs-var">hasFS</span></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>    </span><span class="hs-comment">-- We use 'readMVarSTM' to read a potentially stale internal state if</span><span>
</span><a name="line-248"></a><span>    </span><span class="hs-comment">-- somebody's appending to the ImmutableDB at the same time. Reads can</span><span>
</span><a name="line-249"></a><span>    </span><span class="hs-comment">-- safely happen concurrently with appends, so this is fine and allows for</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-comment">-- some extra concurrency.</span><span>
</span><a name="line-251"></a><span>    </span><span class="hs-identifier">open</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495135"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495210"><span class="hs-identifier hs-type">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>    </span><a name="local-6989586621679495238"><a href="#local-6989586621679495238"><span class="hs-identifier">open</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#readMVarSTM"><span class="hs-identifier hs-var">readMVarSTM</span></a><span> </span><a href="#local-6989586621679495212"><span class="hs-identifier hs-var">varInternalState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-253"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a name="local-6989586621679495242"><a href="#local-6989586621679495242"><span class="hs-identifier">ost</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679495242"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-254"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#throwUserError"><span class="hs-identifier hs-var">throwUserError</span></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ClosedDBError"><span class="hs-identifier hs-var">ClosedDBError</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span>    </span><span class="hs-comment">-- close doesn't take the state that @open@ returned, because the state</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-comment">-- may have been updated by someone else since we got it (remember we're</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-comment">-- using 'readMVarSTM' here, not 'takeMVar'). So we need to get the most</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-comment">-- recent state anyway.</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-identifier">close</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCase"><span class="hs-identifier hs-type">ExitCase</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#ImmutableDBError"><span class="hs-identifier hs-type">ImmutableDBError</span></a><span> </span><a href="#local-6989586621679495136"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>    </span><a name="local-6989586621679495239"><a href="#local-6989586621679495239"><span class="hs-identifier">close</span></a></a><span> </span><a name="local-6989586621679495243"><a href="#local-6989586621679495243"><span class="hs-identifier">ec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679495243"><span class="hs-identifier hs-var">ec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-263"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseAbort"><span class="hs-identifier hs-var">ExitCaseAbort</span></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseException"><span class="hs-identifier hs-var">ExitCaseException</span></a><span> </span><a name="local-6989586621679495244"><a href="#local-6989586621679495244"><span class="hs-identifier">_ex</span></a></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseSuccess"><span class="hs-identifier hs-var">ExitCaseSuccess</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>      </span><span class="hs-comment">-- In case of an ImmutableDBError, close when unexpected</span><span>
</span><a name="line-267"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseSuccess"><span class="hs-identifier hs-var">ExitCaseSuccess</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#UnexpectedError"><span class="hs-identifier hs-var">UnexpectedError</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495240"><span class="hs-identifier hs-var">shutDown</span></a><span>
</span><a name="line-268"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#ExitCaseSuccess"><span class="hs-identifier hs-var">ExitCaseSuccess</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Types.html#UserError"><span class="hs-identifier hs-var">UserError</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span>    </span><span class="hs-identifier">shutDown</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>    </span><a name="local-6989586621679495240"><a href="#local-6989586621679495240"><span class="hs-identifier">shutDown</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictMVar.html#swapMVar"><span class="hs-identifier hs-var">swapMVar</span></a><span> </span><a href="#local-6989586621679495212"><span class="hs-identifier hs-var">varInternalState</span></a><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-272"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a><span> </span><a name="local-6989586621679495245"><a href="#local-6989586621679495245"><span class="hs-identifier">ost</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#wrapFsError"><span class="hs-identifier hs-var">wrapFsError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cleanUp"><span class="hs-identifier hs-var">cleanUp</span></a><span> </span><a href="#local-6989586621679495211"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679495245"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-273"></a><span>      </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span>    </span><span class="hs-identifier">access</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495135"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495210"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495134"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495136"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-276"></a><span>    </span><a name="local-6989586621679495241"><a href="#local-6989586621679495241"><span class="hs-identifier">access</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679495219"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679495211"><span class="hs-identifier hs-var">hasFS</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-comment">-- | Close the handles in the 'OpenState'.</span><span>
</span><a name="line-279"></a><span class="hs-comment">--</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- Idempotent, as closing a handle is idempotent.</span><span>
</span><a name="line-281"></a><span class="hs-identifier">closeOpenHandles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679495131"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495131"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495132"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495131"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495133"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495132"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495131"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-282"></a><a name="closeOpenHandles"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#closeOpenHandles"><span class="hs-identifier">closeOpenHandles</span></a></a><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-var">HasFS</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679495249"><a href="#local-6989586621679495249"><span class="hs-identifier">hClose</span></a></a><span> </span><span class="hs-special">}</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-283"></a><span>    </span><a href="#local-6989586621679495249"><span class="hs-identifier hs-var">hClose</span></a><span> </span><a href="#local-6989586621679495253"><span class="hs-identifier hs-var">currentChunkHandle</span></a><span>
</span><a name="line-284"></a><span>    </span><a href="#local-6989586621679495249"><span class="hs-identifier hs-var">hClose</span></a><span> </span><a href="#local-6989586621679495254"><span class="hs-identifier hs-var">currentPrimaryHandle</span></a><span>
</span><a name="line-285"></a><span>    </span><a href="#local-6989586621679495249"><span class="hs-identifier hs-var">hClose</span></a><span> </span><a href="#local-6989586621679495255"><span class="hs-identifier hs-var">currentSecondaryHandle</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- | Clean up the 'OpenState': 'closeOpenHandles' + close the index (i.e.,</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- shut down its background thread)</span><span>
</span><a name="line-289"></a><span class="hs-identifier">cleanUp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679495128"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a><span> </span><a href="#local-6989586621679495128"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495129"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a><span> </span><a href="#local-6989586621679495128"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679495130"><span class="hs-identifier hs-type">hash</span></a><span> </span><a href="#local-6989586621679495129"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679495128"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><a name="cleanUp"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cleanUp"><span class="hs-identifier">cleanUp</span></a></a><span> </span><a name="local-6989586621679495258"><a href="#local-6989586621679495258"><span class="hs-identifier">hasFS</span></a></a><span> </span><a name="local-6989586621679495259"><a href="#local-6989586621679495259"><span class="hs-identifier">ost</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-var">OpenState</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-291"></a><span>    </span><span class="hs-identifier">Index.close</span><span> </span><a href="#local-6989586621679495267"><span class="hs-identifier hs-var">currentIndex</span></a><span>
</span><a name="line-292"></a><span>    </span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#closeOpenHandles"><span class="hs-identifier hs-var">closeOpenHandles</span></a><span> </span><a href="#local-6989586621679495258"><span class="hs-identifier hs-var">hasFS</span></a><span> </span><a href="#local-6989586621679495259"><span class="hs-identifier hs-var">ost</span></a><span>
</span><a name="line-293"></a></pre></body></html>