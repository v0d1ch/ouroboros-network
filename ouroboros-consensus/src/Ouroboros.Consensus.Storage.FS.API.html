<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia         #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-comment">-- | An abstract view over the filesystem.</span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier">Handle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier">HasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier">SomeHasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose%27"><span class="hs-identifier">hClose'</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAll"><span class="hs-identifier">hGetAll</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAllAt"><span class="hs-identifier">hGetAllAt</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactly"><span class="hs-identifier">hGetExactly</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactlyAt"><span class="hs-identifier">hGetExactlyAt</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hPut"><span class="hs-identifier">hPut</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAll"><span class="hs-identifier">hPutAll</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAllStrict"><span class="hs-identifier">hPutAllStrict</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#withFile"><span class="hs-identifier">withFile</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldM</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Builder</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BL</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Int</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoThunks</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">OnlyCheckWhnfNamed</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API.Types</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.CallStack.html"><span class="hs-identifier">Ouroboros.Consensus.Util.CallStack</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-comment">{------------------------------------------------------------------------------
 Typeclass which abstracts over the filesystem
------------------------------------------------------------------------------}</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">data</span><span> </span><span id="HasFS"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-var">HasFS</span></a></span></span><span> </span><span id="local-6989586621679983652"><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679983651"><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HasFS"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-var">HasFS</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-comment">-- | Debugging: human-readable description of file system state</span><span>
</span><span id="line-47"></span><span>    </span><span id="dumpState"><span class="annot"><span class="annottext">HasFS m h -&gt; m String
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#dumpState"><span class="hs-identifier hs-var hs-var">dumpState</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-comment">-- Operations of files</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-comment">-- | Open a file</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hOpen"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hOpen"><span class="hs-identifier hs-var hs-var">hOpen</span></a></span></span><span>                    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#OpenMode"><span class="hs-identifier hs-type">OpenMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- | Close a file</span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hClose"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose"><span class="hs-identifier hs-var hs-var">hClose</span></a></span></span><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- | Is the handle open?</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hIsOpen"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hIsOpen"><span class="hs-identifier hs-var hs-var">hIsOpen</span></a></span></span><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-comment">-- | Seek handle</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-comment">-- The offset is an 'Int64' rather than a 'Word64' because it may be</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-comment">-- negative (for use in relative positioning).</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- Unlike the Posix @lseek@, 'hSeek' does not return the new seek position</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">-- because the value returned by Posix is rather strange and unreliable</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- and we don't want to emulate it's behaviour.</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hSeek"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hSeek"><span class="hs-identifier hs-var hs-var">hSeek</span></a></span></span><span>                    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SeekMode</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- | Try to read @n@ bytes from a handle</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- When at the end of the file, an empty bytestring will be returned.</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- The returned bytestring will typically have length @n@, but may be</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-comment">-- shorter in case of a partial read, see #277. However, a partial read</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- will always return at least 1 byte, as returning 0 bytes would mean</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- that we have reached EOF.</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- Postcondition: the length of the returned bytestring &lt;= @n@ and &gt;= 0.</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hGetSome"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSome"><span class="hs-identifier hs-var hs-var">hGetSome</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">-- | Same as 'hGetSome', but does not affect the file offset. An additional argument</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-comment">-- is used to specify the offset. This allows it to be called concurrently for the</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- same file handle. However, the actual level of parallelism achieved depends on</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">-- the implementation and the operating system: generally on Unix it will be</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- \&quot;more parallel\&quot; than on Windows.</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hGetSomeAt"><span class="annot"><span class="annottext">HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSomeAt"><span class="hs-identifier hs-var hs-var">hGetSomeAt</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-88"></span><span>                             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-89"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>    </span><span class="hs-comment">-- The number of bytes to read.</span><span>
</span><span id="line-90"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-type">AbsOffset</span></a></span><span> </span><span class="hs-comment">-- The offset at which to read.</span><span>
</span><span id="line-91"></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- | Write to a handle</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- The return value indicates the number of bytes written and will</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">-- typically be equal to @l@, the length of the bytestring, but may be</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- shorter in case of a partial write, see #277.</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- If nothing can be written at all, an exception will be thrown.</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- Postcondition: the return value &lt;= @l@ and &gt; 0, unless the given</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- bytestring is empty, in which case the return value can be 0.</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hPutSome"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutSome"><span class="hs-identifier hs-var hs-var">hPutSome</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- | Truncate the file to the specified size</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">-- NOTE: Only supported in append mode.</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hTruncate"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hTruncate"><span class="hs-identifier hs-var hs-var">hTruncate</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- | Return current file size</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">-- NOTE: This is not thread safe (changes made to the file in other threads</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- may affect this thread).</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="hGetSize"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSize"><span class="hs-identifier hs-var hs-var">hGetSize</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-comment">-- Operations of directories</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- | Create new directory</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="createDirectory"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#createDirectory"><span class="hs-identifier hs-var hs-var">createDirectory</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">-- | Create new directory if it doesn't exist.</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- @createDirectoryIfMissing True@ will also try to create all parent dirs.</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="createDirectoryIfMissing"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#createDirectoryIfMissing"><span class="hs-identifier hs-var hs-var">createDirectoryIfMissing</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-comment">-- | List contents of a directory</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="listDirectory"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#listDirectory"><span class="hs-identifier hs-var hs-var">listDirectory</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- | Check if the path exists and is a directory</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="doesDirectoryExist"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#doesDirectoryExist"><span class="hs-identifier hs-var hs-var">doesDirectoryExist</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- | Check if the path exists and is a file</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="doesFileExist"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#doesFileExist"><span class="hs-identifier hs-var hs-var">doesFileExist</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- | Remove the file (which must exist)</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="removeFile"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#removeFile"><span class="hs-identifier hs-var hs-var">removeFile</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- | Rename the file (which must exist) from the first path to the second</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- path. If there is already a file at the latter path, it is replaced by</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- the new one.</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- NOTE: only works for files within the same folder.</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="renameFile"><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#renameFile"><span class="hs-identifier hs-var hs-var">renameFile</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- | Useful for better error reporting</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="mkFsErrorPath"><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#mkFsErrorPath"><span class="hs-identifier hs-var hs-var">mkFsErrorPath</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsErrorPath"><span class="hs-identifier hs-type">FsErrorPath</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679983557"><span id="local-6989586621679983559"><span id="local-6989586621679983561"><span class="annot"><span class="annottext">Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo)
Proxy (HasFS m h) -&gt; String
(Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (HasFS m h) -&gt; String)
-&gt; NoThunks (HasFS m h)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *) h.
Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *) h. Proxy (HasFS m h) -&gt; String
showTypeOf :: Proxy (HasFS m h) -&gt; String
$cshowTypeOf :: forall (m :: * -&gt; *) h. Proxy (HasFS m h) -&gt; String
wNoThunks :: Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *) h.
Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall (m :: * -&gt; *) h.
Context -&gt; HasFS m h -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OnlyCheckWhnfNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;HasFS&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983651"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span id="local-6989586621679983553"><span id="local-6989586621679983554"><span id="local-6989586621679983555"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#withFile"><span class="hs-identifier hs-type">withFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983555"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983555"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983554"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsPath"><span class="hs-identifier hs-type">FsPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#OpenMode"><span class="hs-identifier hs-type">OpenMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983554"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983555"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983553"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983555"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983553"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-152"></span><span id="withFile"><span class="annot"><span class="annottext">withFile :: HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#withFile"><span class="hs-identifier hs-var hs-var">withFile</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span class="hs-special">{</span><span id="local-6989586621679983535"><span id="local-6989586621679983536"><span id="local-6989586621679983537"><span id="local-6989586621679983538"><span id="local-6989586621679983539"><span id="local-6989586621679983540"><span id="local-6989586621679983541"><span id="local-6989586621679983542"><span id="local-6989586621679983543"><span id="local-6989586621679983544"><span id="local-6989586621679983545"><span id="local-6989586621679983546"><span id="local-6989586621679983547"><span id="local-6989586621679983548"><span id="local-6989586621679983549"><span id="local-6989586621679983550"><span id="local-6989586621679983551"><span id="local-6989586621679983552"><span class="annot"><span class="annottext">m String
HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
HasCallStack =&gt; Handle h -&gt; m Bool
HasCallStack =&gt; Handle h -&gt; m Word64
HasCallStack =&gt; Handle h -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
HasCallStack =&gt; FsPath -&gt; m Bool
HasCallStack =&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; m (Set String)
HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; FsErrorPath
mkFsErrorPath :: FsPath -&gt; FsErrorPath
renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: m String
mkFsErrorPath :: forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
renameFile :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: forall (m :: * -&gt; *) h.
HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: forall (m :: * -&gt; *) h. HasFS m h -&gt; m String
</span><a href="#local-6989586621679983535"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679983534"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679983534"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621679983533"><span class="annot"><span class="annottext">OpenMode
</span><a href="#local-6989586621679983533"><span class="hs-identifier hs-var">openMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Handle h) -&gt; (Handle h -&gt; m ()) -&gt; (Handle h -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">bracket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; OpenMode -&gt; m (Handle h)
</span><a href="#local-6989586621679983551"><span class="hs-identifier hs-var">hOpen</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679983534"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">OpenMode
</span><a href="#local-6989586621679983533"><span class="hs-identifier hs-var">openMode</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m ()
Handle h -&gt; m ()
</span><a href="#local-6989586621679983550"><span class="hs-identifier hs-var">hClose</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- | Returns 'True' when the handle was still open.</span><span>
</span><span id="line-155"></span><span id="local-6989586621679983530"><span id="local-6989586621679983531"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose%27"><span class="hs-identifier hs-type">hClose'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679983531"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983531"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983530"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983530"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983531"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-156"></span><span id="hClose%27"><span class="annot"><span class="annottext">hClose' :: HasFS m h -&gt; Handle h -&gt; m Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hClose%27"><span class="hs-identifier hs-var hs-var">hClose'</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679983529"><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m ()
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
</span><a href="#local-6989586621679983529"><span class="hs-identifier hs-var hs-var">hClose</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679983528"><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m Bool
hIsOpen :: HasCallStack =&gt; Handle h -&gt; m Bool
hIsOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
</span><a href="#local-6989586621679983528"><span class="hs-identifier hs-var hs-var">hIsOpen</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679983527"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983527"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621679983526"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679983526"><span class="hs-identifier hs-var">isOpen</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m Bool
Handle h -&gt; m Bool
</span><a href="#local-6989586621679983528"><span class="hs-identifier hs-var">hIsOpen</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983527"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679983526"><span class="hs-identifier hs-var">isOpen</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m ()
Handle h -&gt; m ()
</span><a href="#local-6989586621679983529"><span class="hs-identifier hs-var">hClose</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983527"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-160"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-keyword">else</span><span>
</span><span id="line-162"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- | Makes sure it reads all requested bytes.</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- If eof is found before all bytes are read, it throws an exception.</span><span>
</span><span id="line-166"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactly"><span class="hs-identifier hs-type">hGetExactly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679983525"><span class="annot"><a href="#local-6989586621679983525"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679983524"><span class="annot"><a href="#local-6989586621679983524"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983525"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983524"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-168"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983524"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-169"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-170"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span>
</span><span id="line-171"></span><span id="hGetExactly"><span class="annot"><span class="annottext">hGetExactly :: HasFS m h -&gt; Handle h -&gt; Word64 -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactly"><span class="hs-identifier hs-var hs-var">hGetExactly</span></a></span></span><span> </span><span id="local-6989586621679983523"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983523"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679983522"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983522"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679983521"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983521"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983520"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983521"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="#local-6989586621679983520"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621679983520"><span class="annot"><span class="annottext">go :: Word64 -&gt; [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983520"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679983519"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983519"><span class="hs-identifier hs-var">remainingBytes</span></a></span></span><span> </span><span id="local-6989586621679983518"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983518"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983519"><span class="hs-identifier hs-var">remainingBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m ByteString) -&gt; ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983518"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-176"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>        </span><span id="local-6989586621679983515"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983515"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; m ByteString
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSome"><span class="hs-identifier hs-var hs-var">hGetSome</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983523"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983522"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983519"><span class="hs-identifier hs-var">remainingBytes</span></a></span><span>
</span><span id="line-178"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983515"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-179"></span><span>          </span><span class="annot"><span class="annottext">FsError -&gt; m ByteString
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">FsError :: FsErrorType
-&gt; FsErrorPath
-&gt; String
-&gt; Maybe Errno
-&gt; PrettyCallStack
-&gt; Bool
-&gt; FsError
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsError"><span class="hs-identifier hs-type">FsError</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-180"></span><span>              </span><span class="annot"><span class="annottext">fsErrorType :: FsErrorType
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorType"><span class="hs-identifier hs-var">fsErrorType</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FsErrorType
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsReachedEOF"><span class="hs-identifier hs-var">FsReachedEOF</span></a></span><span>
</span><span id="line-181"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorPath :: FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorPath"><span class="hs-identifier hs-var">fsErrorPath</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; FsErrorPath
forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#mkFsErrorPath"><span class="hs-identifier hs-var hs-var">mkFsErrorPath</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983523"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">(FsPath -&gt; FsErrorPath) -&gt; FsPath -&gt; FsErrorPath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle h -&gt; FsPath
forall h. Handle h -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#handlePath"><span class="hs-identifier hs-var hs-var">handlePath</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983522"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-182"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorString :: String
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorString"><span class="hs-identifier hs-var">fsErrorString</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hGetExactly found eof before reading &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983521"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; bytes&quot;</span></span><span>
</span><span id="line-183"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorNo :: Maybe Errno
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorNo"><span class="hs-identifier hs-var">fsErrorNo</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Errno
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-184"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorStack :: PrettyCallStack
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorStack"><span class="hs-identifier hs-var">fsErrorStack</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
HasCallStack =&gt; PrettyCallStack
</span><a href="Ouroboros.Consensus.Util.CallStack.html#prettyCallStack"><span class="hs-identifier hs-var">prettyCallStack</span></a></span><span>
</span><span id="line-185"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsLimitation :: Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsLimitation"><span class="hs-identifier hs-var">fsLimitation</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-186"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-187"></span><span>        </span><span class="hs-comment">-- We know the length &lt;= remainingBytes, so this can't underflow</span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983520"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983519"><span class="hs-identifier hs-var">remainingBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983515"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983515"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983518"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | Like 'hGetExactly', but is thread safe since it does not change or depend</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- on the file offset. @pread@ syscall is used internally.</span><span>
</span><span id="line-192"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactlyAt"><span class="hs-identifier hs-type">hGetExactlyAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679983500"><span class="annot"><a href="#local-6989586621679983500"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679983499"><span class="annot"><a href="#local-6989586621679983499"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983500"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983499"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-194"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983499"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-195"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>    </span><span class="hs-comment">-- ^ The number of bytes to read.</span><span>
</span><span id="line-196"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-type">AbsOffset</span></a></span><span> </span><span class="hs-comment">-- ^ The offset at which to read.</span><span>
</span><span id="line-197"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span>
</span><span id="line-198"></span><span id="hGetExactlyAt"><span class="annot"><span class="annottext">hGetExactlyAt :: HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetExactlyAt"><span class="hs-identifier hs-var hs-var">hGetExactlyAt</span></a></span></span><span> </span><span id="local-6989586621679983498"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983498"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679983497"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983497"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679983496"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983496"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679983495"><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983495"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset -&gt; [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983496"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983495"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><a href="#local-6989586621679983494"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-type">AbsOffset</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621679983494"><span class="annot"><span class="annottext">go :: Word64 -&gt; AbsOffset -&gt; [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983494"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679983493"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983493"><span class="hs-identifier hs-var">remainingBytes</span></a></span></span><span> </span><span id="local-6989586621679983492"><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983492"><span class="hs-identifier hs-var">currentOffset</span></a></span></span><span> </span><span id="local-6989586621679983491"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983491"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983493"><span class="hs-identifier hs-var">remainingBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m ByteString) -&gt; ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983491"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>        </span><span id="local-6989586621679983490"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983490"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetSomeAt"><span class="hs-identifier hs-var hs-var">hGetSomeAt</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983498"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983497"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983493"><span class="hs-identifier hs-var">remainingBytes</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983492"><span class="hs-identifier hs-var">currentOffset</span></a></span><span>
</span><span id="line-205"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679983489"><span class="annot"><span class="annottext">readBytes :: Int
</span><a href="#local-6989586621679983489"><span class="hs-identifier hs-var hs-var">readBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983490"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983490"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-207"></span><span>          </span><span class="annot"><span class="annottext">FsError -&gt; m ByteString
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">FsError :: FsErrorType
-&gt; FsErrorPath
-&gt; String
-&gt; Maybe Errno
-&gt; PrettyCallStack
-&gt; Bool
-&gt; FsError
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsError"><span class="hs-identifier hs-type">FsError</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-208"></span><span>              </span><span class="annot"><span class="annottext">fsErrorType :: FsErrorType
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorType"><span class="hs-identifier hs-var">fsErrorType</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FsErrorType
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#FsReachedEOF"><span class="hs-identifier hs-var">FsReachedEOF</span></a></span><span>
</span><span id="line-209"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorPath :: FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorPath"><span class="hs-identifier hs-var">fsErrorPath</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; FsErrorPath
forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#mkFsErrorPath"><span class="hs-identifier hs-var hs-var">mkFsErrorPath</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983498"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">(FsPath -&gt; FsErrorPath) -&gt; FsPath -&gt; FsErrorPath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Handle h -&gt; FsPath
forall h. Handle h -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#handlePath"><span class="hs-identifier hs-var hs-var">handlePath</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983497"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorString :: String
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorString"><span class="hs-identifier hs-var">fsErrorString</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hGetExactlyAt found eof before reading &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983496"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; bytes&quot;</span></span><span>
</span><span id="line-211"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorNo :: Maybe Errno
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorNo"><span class="hs-identifier hs-var">fsErrorNo</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Errno
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsErrorStack :: PrettyCallStack
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsErrorStack"><span class="hs-identifier hs-var">fsErrorStack</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
HasCallStack =&gt; PrettyCallStack
</span><a href="Ouroboros.Consensus.Util.CallStack.html#prettyCallStack"><span class="hs-identifier hs-var">prettyCallStack</span></a></span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fsLimitation :: Bool
</span><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#fsLimitation"><span class="hs-identifier hs-var">fsLimitation</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- We know the length &lt;= remainingBytes, so this can't underflow.</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset -&gt; [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983494"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983493"><span class="hs-identifier hs-var">remainingBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679983489"><span class="hs-identifier hs-var">readBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983492"><span class="hs-identifier hs-var">currentOffset</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset -&gt; AbsOffset -&gt; AbsOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; AbsOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679983489"><span class="hs-identifier hs-var">readBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983490"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983491"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | Read all the data from the given file handle 64kB at a time.</span><span>
</span><span id="line-221"></span><span class="hs-comment">--</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- Stops when EOF is reached.</span><span>
</span><span id="line-223"></span><span id="local-6989586621679983486"><span id="local-6989586621679983487"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAll"><span class="hs-identifier hs-type">hGetAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679983487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983486"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983486"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span></span></span><span>
</span><span id="line-224"></span><span id="hGetAll"><span class="annot"><span class="annottext">hGetAll :: HasFS m h -&gt; Handle h -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAll"><span class="hs-identifier hs-var hs-var">hGetAll</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span class="hs-special">{</span><span id="local-6989586621679983468"><span id="local-6989586621679983469"><span id="local-6989586621679983470"><span id="local-6989586621679983471"><span id="local-6989586621679983472"><span id="local-6989586621679983473"><span id="local-6989586621679983474"><span id="local-6989586621679983475"><span id="local-6989586621679983476"><span id="local-6989586621679983477"><span id="local-6989586621679983478"><span id="local-6989586621679983479"><span id="local-6989586621679983480"><span id="local-6989586621679983481"><span id="local-6989586621679983482"><span id="local-6989586621679983483"><span id="local-6989586621679983484"><span id="local-6989586621679983485"><span class="annot"><span class="annottext">m String
HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
HasCallStack =&gt; Handle h -&gt; m Bool
HasCallStack =&gt; Handle h -&gt; m Word64
HasCallStack =&gt; Handle h -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
HasCallStack =&gt; FsPath -&gt; m Bool
HasCallStack =&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; m (Set String)
HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; FsErrorPath
mkFsErrorPath :: FsPath -&gt; FsErrorPath
renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: m String
mkFsErrorPath :: forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
renameFile :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: forall (m :: * -&gt; *) h.
HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: forall (m :: * -&gt; *) h. HasFS m h -&gt; m String
</span><a href="#local-6989586621679983468"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679983467"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983467"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983466"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621679983465"><span class="annot"><span class="annottext">bufferSize :: Word64
</span><a href="#local-6989586621679983465"><span class="hs-identifier hs-var hs-var">bufferSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">64</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621679983466"><span class="annot"><span class="annottext">go :: [ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983466"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679983463"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983463"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>      </span><span id="local-6989586621679983462"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983462"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
Handle h -&gt; Word64 -&gt; m ByteString
</span><a href="#local-6989586621679983480"><span class="hs-identifier hs-var">hGetSome</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983467"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983465"><span class="hs-identifier hs-var">bufferSize</span></a></span><span>
</span><span id="line-229"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679983461"><span class="annot"><span class="annottext">acc' :: [ByteString]
</span><a href="#local-6989586621679983461"><span class="hs-identifier hs-var hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983462"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983463"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983462"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m ByteString) -&gt; ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983461"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; m ByteString
</span><a href="#local-6989586621679983466"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983461"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | Like 'hGetAll', but is thread safe since it does not change or depend</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- on the file offset. @pread@ syscall is used internally.</span><span>
</span><span id="line-236"></span><span id="local-6989586621679983459"><span id="local-6989586621679983460"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAllAt"><span class="hs-identifier hs-type">hGetAllAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679983460"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-237"></span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983460"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983459"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-238"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983459"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-239"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#AbsOffset"><span class="hs-identifier hs-type">AbsOffset</span></a></span><span> </span><span class="hs-comment">-- ^ The offset at which to read.</span><span>
</span><span id="line-240"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983460"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span></span></span><span>
</span><span id="line-241"></span><span id="hGetAllAt"><span class="annot"><span class="annottext">hGetAllAt :: HasFS m h -&gt; Handle h -&gt; AbsOffset -&gt; m ByteString
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hGetAllAt"><span class="hs-identifier hs-var hs-var">hGetAllAt</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span class="hs-special">{</span><span id="local-6989586621679983441"><span id="local-6989586621679983442"><span id="local-6989586621679983443"><span id="local-6989586621679983444"><span id="local-6989586621679983445"><span id="local-6989586621679983446"><span id="local-6989586621679983447"><span id="local-6989586621679983448"><span id="local-6989586621679983449"><span id="local-6989586621679983450"><span id="local-6989586621679983451"><span id="local-6989586621679983452"><span id="local-6989586621679983453"><span id="local-6989586621679983454"><span id="local-6989586621679983455"><span id="local-6989586621679983456"><span id="local-6989586621679983457"><span id="local-6989586621679983458"><span class="annot"><span class="annottext">m String
HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
HasCallStack =&gt; Handle h -&gt; m Bool
HasCallStack =&gt; Handle h -&gt; m Word64
HasCallStack =&gt; Handle h -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
HasCallStack =&gt; FsPath -&gt; m Bool
HasCallStack =&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; m (Set String)
HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; FsErrorPath
mkFsErrorPath :: FsPath -&gt; FsErrorPath
renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: m String
mkFsErrorPath :: forall (m :: * -&gt; *) h. HasFS m h -&gt; FsPath -&gt; FsErrorPath
renameFile :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
removeFile :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
doesFileExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
doesDirectoryExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
createDirectoryIfMissing :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
createDirectory :: forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
hGetSize :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
hTruncate :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hPutSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
hGetSomeAt :: forall (m :: * -&gt; *) h.
HasFS m h
-&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
hGetSome :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ByteString
hSeek :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; SeekMode -&gt; Int64 -&gt; m ()
hIsOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Bool
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
hOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
dumpState :: forall (m :: * -&gt; *) h. HasFS m h -&gt; m String
</span><a href="#local-6989586621679983441"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679983440"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983440"><span class="hs-identifier hs-var">hnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; AbsOffset -&gt; m ByteString
</span><a href="#local-6989586621679983439"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621679983438"><span class="annot"><span class="annottext">bufferSize :: Word64
</span><a href="#local-6989586621679983438"><span class="hs-identifier hs-var hs-var">bufferSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">64</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621679983439"><span class="annot"><span class="annottext">go :: [ByteString] -&gt; AbsOffset -&gt; m ByteString
</span><a href="#local-6989586621679983439"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679983437"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983437"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679983436"><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983436"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>      </span><span id="local-6989586621679983435"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983435"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><a href="#local-6989586621679983452"><span class="hs-identifier hs-var">hGetSomeAt</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983440"><span class="hs-identifier hs-var">hnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983438"><span class="hs-identifier hs-var">bufferSize</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983436"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-246"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679983434"><span class="annot"><span class="annottext">acc' :: [ByteString]
</span><a href="#local-6989586621679983434"><span class="hs-identifier hs-var hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983435"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983437"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983435"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m ByteString) -&gt; ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">BL.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983434"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-249"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; AbsOffset -&gt; m ByteString
</span><a href="#local-6989586621679983439"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679983434"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679983436"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset -&gt; AbsOffset -&gt; AbsOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; AbsOffset
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983435"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-comment">-- | This function makes sure that the whole 'BS.ByteString' is written.</span><span>
</span><span id="line-252"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAllStrict"><span class="hs-identifier hs-type">hPutAllStrict</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679983601"><span class="annot"><a href="#local-6989586621679983601"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679983600"><span class="annot"><a href="#local-6989586621679983600"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-253"></span><span>              </span><span class="hs-operator">.</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679983601"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983601"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983600"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-255"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983600"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-256"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-257"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983601"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-258"></span><span id="hPutAllStrict"><span class="annot"><span class="annottext">hPutAllStrict :: HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAllStrict"><span class="hs-identifier hs-var hs-var">hPutAllStrict</span></a></span></span><span> </span><span id="local-6989586621679983433"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983433"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679983432"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983432"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ByteString -&gt; m Word64
</span><a href="#local-6989586621679983431"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><a href="#local-6989586621679983431"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983601"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621679983431"><span class="annot"><span class="annottext">go :: Word64 -&gt; ByteString -&gt; m Word64
</span><a href="#local-6989586621679983431"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679983430"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983430"><span class="hs-identifier hs-var">written</span></a></span></span><span> </span><span id="local-6989586621679983429"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983429"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>      </span><span id="local-6989586621679983428"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983428"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutSome"><span class="hs-identifier hs-var hs-var">hPutSome</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983433"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983432"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983429"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-263"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679983427"><span class="annot"><span class="annottext">bs' :: ByteString
</span><a href="#local-6989586621679983427"><span class="hs-identifier hs-var hs-var">bs'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983428"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983429"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-264"></span><span>          </span><span id="local-6989586621679983425"><span class="annot"><span class="annottext">written' :: Word64
</span><a href="#local-6989586621679983425"><span class="hs-identifier hs-var hs-var">written'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983430"><span class="hs-identifier hs-var">written</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983428"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983427"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; m Word64
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983425"><span class="hs-identifier hs-var">written'</span></a></span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ByteString -&gt; m Word64
</span><a href="#local-6989586621679983431"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983425"><span class="hs-identifier hs-var">written'</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983427"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-comment">-- | This function makes sure that the whole 'BL.ByteString' is written.</span><span>
</span><span id="line-270"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAll"><span class="hs-identifier hs-type">hPutAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679983596"><span class="annot"><a href="#local-6989586621679983596"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679983595"><span class="annot"><a href="#local-6989586621679983595"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-operator">.</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679983596"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983596"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983595"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-273"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983595"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-274"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BL.ByteString</span></span><span>
</span><span id="line-275"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983596"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-276"></span><span id="hPutAll"><span class="annot"><span class="annottext">hPutAll :: HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAll"><span class="hs-identifier hs-var hs-var">hPutAll</span></a></span></span><span> </span><span id="local-6989586621679983424"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983424"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679983423"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983423"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; ByteString -&gt; m Word64)
-&gt; Word64 -&gt; [ByteString] -&gt; m Word64
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ByteString -&gt; m Word64
</span><a href="#local-6989586621679983422"><span class="hs-identifier hs-var">putChunk</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; m Word64)
-&gt; (ByteString -&gt; [ByteString]) -&gt; ByteString -&gt; m Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><span class="hs-identifier hs-var">BL.toChunks</span></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><a href="#local-6989586621679983422"><span class="hs-identifier hs-type">putChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983596"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-279"></span><span>    </span><span id="local-6989586621679983422"><span class="annot"><span class="annottext">putChunk :: Word64 -&gt; ByteString -&gt; m Word64
</span><a href="#local-6989586621679983422"><span class="hs-identifier hs-var hs-var">putChunk</span></a></span></span><span> </span><span id="local-6989586621679983419"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983419"><span class="hs-identifier hs-var">written</span></a></span></span><span> </span><span id="local-6989586621679983418"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983418"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>      </span><span id="local-6989586621679983417"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983417"><span class="hs-identifier hs-var">written'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAllStrict"><span class="hs-identifier hs-var">hPutAllStrict</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983424"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983423"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679983418"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">Word64 -&gt; m Word64
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; m Word64) -&gt; Word64 -&gt; m Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983419"><span class="hs-identifier hs-var">written</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679983417"><span class="hs-identifier hs-var">written'</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">-- | This function makes sure that the whole 'Builder' is written.</span><span>
</span><span id="line-284"></span><span class="hs-comment">--</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- The chunk size of the resulting 'BL.ByteString' determines how much memory</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- will be used while writing to the handle.</span><span>
</span><span id="line-287"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#hPut"><span class="hs-identifier hs-type">hPut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679983415"><span class="annot"><a href="#local-6989586621679983415"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679983414"><span class="annot"><a href="#local-6989586621679983414"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-288"></span><span>     </span><span class="hs-operator">.</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679983415"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>     </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983414"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-290"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983414"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-291"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Builder</span></span><span>
</span><span id="line-292"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679983415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-293"></span><span id="hPut"><span class="annot"><span class="annottext">hPut :: HasFS m h -&gt; Handle h -&gt; Builder -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPut"><span class="hs-identifier hs-var hs-var">hPut</span></a></span></span><span> </span><span id="local-6989586621679983413"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983413"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679983412"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983412"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.FS.API.html#hPutAll"><span class="hs-identifier hs-var">hPutAll</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679983413"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679983412"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m Word64)
-&gt; (Builder -&gt; ByteString) -&gt; Builder -&gt; m Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.toLazyByteString</span></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  SomeHasFS
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="hs-comment">-- | It is often inconvenient to have to parameterise over @h@. One often makes</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- it existential, losing the ability to use derive 'Generic' and 'NoThunks'.</span><span>
</span><span id="line-301"></span><span class="hs-comment">-- This data type hides an existential @h@ parameter of a 'HasFS' and provides a</span><span>
</span><span id="line-302"></span><span class="hs-comment">-- 'NoThunks' thunks instance.</span><span>
</span><span id="line-303"></span><span class="hs-keyword">data</span><span> </span><span id="SomeHasFS"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-var">SomeHasFS</span></a></span></span><span> </span><span id="local-6989586621679983410"><span class="annot"><a href="#local-6989586621679983410"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-304"></span><span>  </span><span id="local-6989586621679983408"><span id="local-6989586621679983409"><span id="SomeHasFS"><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-var">SomeHasFS</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679983409"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#HasFS"><span class="hs-identifier hs-type">HasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983408"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983409"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-type">SomeHasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983408"><span class="hs-identifier hs-type">m</span></a></span></span></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679983401"><span id="local-6989586621679983403"><span id="local-6989586621679983405"><span class="annot"><span class="annottext">Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo)
Proxy (SomeHasFS m) -&gt; String
(Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (SomeHasFS m) -&gt; String)
-&gt; NoThunks (SomeHasFS m)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *).
Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *). Proxy (SomeHasFS m) -&gt; String
showTypeOf :: Proxy (SomeHasFS m) -&gt; String
$cshowTypeOf :: forall (m :: * -&gt; *). Proxy (SomeHasFS m) -&gt; String
wNoThunks :: Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *).
Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo)
$cnoThunks :: forall (m :: * -&gt; *).
Context -&gt; SomeHasFS m -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621679983401"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></a></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OnlyCheckWhnfNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;SomeHasFS&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.FS.API.html#SomeHasFS"><span class="hs-identifier hs-type">SomeHasFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679983410"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span></pre></body></html>