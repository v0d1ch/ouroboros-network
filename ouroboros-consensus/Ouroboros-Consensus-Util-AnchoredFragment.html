<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Util.AnchoredFragment</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Util.AnchoredFragment.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Util.AnchoredFragment</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Utility functions on anchored fragments</p><p>Intended for qualified import
 &gt; import qualified Ouroboros.Consensus.Util.AnchoredFragment as AF</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:compareHeadBlockNo">compareHeadBlockNo</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> b &#8658; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#t:Ordering" title="Data.Ord">Ordering</a></li><li class="src short"><a href="#v:forksAtMostKBlocks">forksAtMostKBlocks</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> b &#8658; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></li><li class="src short"><a href="#v:preferAnchoredCandidate">preferAnchoredCandidate</a> &#8759; &#8704; blk. <a href="Ouroboros-Consensus-Block-SupportsProtocol.html#t:BlockSupportsProtocol" title="Ouroboros.Consensus.Block.SupportsProtocol">BlockSupportsProtocol</a> blk &#8658; <a href="Ouroboros-Consensus-Config.html#t:TopLevelConfig" title="Ouroboros.Consensus.Config">TopLevelConfig</a> blk &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></li><li class="src short"><a href="#v:compareAnchoredCandidates">compareAnchoredCandidates</a> &#8759; &#8704; blk. (<a href="Ouroboros-Consensus-Block-SupportsProtocol.html#t:BlockSupportsProtocol" title="Ouroboros.Consensus.Block.SupportsProtocol">BlockSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Config.html#t:TopLevelConfig" title="Ouroboros.Consensus.Config">TopLevelConfig</a> blk &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#t:Ordering" title="Data.Ord">Ordering</a></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:compareHeadBlockNo" class="def">compareHeadBlockNo</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> b &#8658; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#t:Ordering" title="Data.Ord">Ordering</a> <a href="src/Ouroboros.Consensus.Util.AnchoredFragment.html#compareHeadBlockNo" class="link">Source</a> <a href="#v:compareHeadBlockNo" class="selflink">#</a></p><div class="doc"><p>Compare the <code>headBlockNo</code>, which is a measure of the length of the chain,
 of two anchored fragments.</p><p>A fragment with a head is always &quot;greater&quot; than one without. When both
 fragments have no head (i.e. are empty), they are <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#v:EQ" title="Data.Ord">EQ</a></code>.</p><p>Note that an EBB can share its <code>BlockNo</code> with another regular block. If
 such an EBB is the head of one fragment and the regular block with the same
 <code>BlockNo</code> is the head of the other fragment, then this function will say
 they are <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#v:EQ" title="Data.Ord">EQ</a></code>, while in fact one fragment should be preferred over the
 other.</p><p>This is not a big deal as we won't be seeing new EBBs, so they will not be
 the head of a fragment very often anyway, only when catching up. As soon as
 a new block/header is added to the fragment, the right decision will be
 made again (<code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#v:GT" title="Data.Ord">GT</a></code> or <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#v:LT" title="Data.Ord">LT</a></code>).</p></div></div><div class="top"><p class="src"><a id="v:forksAtMostKBlocks" class="def">forksAtMostKBlocks</a> <a href="src/Ouroboros.Consensus.Util.AnchoredFragment.html#forksAtMostKBlocks" class="link">Source</a> <a href="#v:forksAtMostKBlocks" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> b</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a></td><td class="doc"><p>How many blocks can it fork?</p></td></tr><tr><td class="src">&#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b</td><td class="doc"><p>Our chain.</p></td></tr><tr><td class="src">&#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> b</td><td class="doc"><p>Their chain</p></td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></td><td class="doc"><p>Indicates whether their chain forks at most the
 specified number of blocks.</p></td></tr></table></div></div><div class="top"><p class="src"><a id="v:preferAnchoredCandidate" class="def">preferAnchoredCandidate</a> <a href="src/Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate" class="link">Source</a> <a href="#v:preferAnchoredCandidate" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Block-SupportsProtocol.html#t:BlockSupportsProtocol" title="Ouroboros.Consensus.Block.SupportsProtocol">BlockSupportsProtocol</a> blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Config.html#t:TopLevelConfig" title="Ouroboros.Consensus.Config">TopLevelConfig</a> blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk)</td><td class="doc"><p>Our chain</p></td></tr><tr><td class="src">&#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk)</td><td class="doc"><p>Candidate</p></td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Lift <code><a href="Ouroboros-Consensus-Protocol-Abstract.html#v:preferCandidate" title="Ouroboros.Consensus.Protocol.Abstract">preferCandidate</a></code> to <code><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a></code></p><p>PRECONDITION: The candidate must intersect with our chain within <code>k</code> blocks
 from our tip.</p><p>NOTE: In the discussion below we assume that the anchored fragments are
 <em>suffixes</em> of their chains.</p><p>A non-empty chain is always preferred over an empty one (see discussion for
 <code><a href="Ouroboros-Consensus-Protocol-Abstract.html#v:preferCandidate" title="Ouroboros.Consensus.Protocol.Abstract">preferCandidate</a></code>), but that does not necessarily mean that a non-empty
 chain <em>fragment</em> is necessary preferred over an empty one. After all, chain
 fragments are suffixes of chains, and so in principle it's possible that we
 might prefer the empty suffix of a longer chain over the non-empty suffix of
 a shorter one.</p><p>We can distinguish between an empty fragment of a non-empty chain and a
 (necessarily) empty fragment of an empty chain by looking at the anchor
 point: if that is the genesis point, the chain must be empty. For emphasis,
 we will refer to these chains/fragments as &quot;genuinely empty&quot;.</p><p>Our own fragment will be empty in two cases only:</p><ul><li>It is genuinely empty. In this case, we prefer the candidate always,
   unless it too is genuinely empty.</li><li>We suffered from data loss, to such an extent that the volatile DB does
   not contain any blocks anymore that fit onto our immutable chain.
   This case will require more careful consideration.</li></ul><p>Unfortunately, the candidate fragment can basically be empty at any point
 due to the way that a switch-to-fork is implemented in terms of rollback
 followed by roll forward; after a maximum rollback (and before the roll
 forward), the candidate fragment is empty. (Note that a genuinely empty
 fragment is <em>never</em> preferred over our chain.)</p><p>We therefore have the following cases to consider:</p><ol><li>Both fragments are empty.</li></ol><p>Since the two fragments must intersect, that intersection point can only
    be the two anchor points, which must therefore be equal. This means that
    two fragments represent the same chain: the candidate is not preferred.</p><ol><li>Our fragment is non-empty, the candidate fragment is empty.</li></ol><p>Since the two fragments must intersect, that intersection can only be the
    anchor of the candidate. That intersection point can lie anywhere on our
    fragment.</p><p>a. If it lies at the tip of our fragment, the two fragments represent the
       same chain.
    b. If it lies before the tip of our fragment, the candidate chain is a
       strict prefix of our chain.</p><p>In either case the candidate is not preferred.</p><ol><li>Our fragment is empty, the candidate fragment is non-empty.</li></ol><p>Since the two fragments must intersect, that intersection can only be the
    anchor of our fragment. Moreover, since we have ruled out the case that
    our chain is genuinely empty, that anchor must be the tip of the immutable
    DB. In other words, the tip of the immutable DB must lie somewhere on the
    candidate chain.</p><p>a. If that is also the tip of the candidate fragment, the two fragments
       represent the same chain, and the candidate is not preferred.
    b. If it is <em>not</em> the tip, the candidate is a strict extension of our
       chain and is therefore preferred.</p><ol><li>Neither fragment is empty. In this case, we can simply call
    <code><a href="Ouroboros-Consensus-Protocol-Abstract.html#v:preferCandidate" title="Ouroboros.Consensus.Protocol.Abstract">preferCandidate</a></code> on the two heads.</li></ol><p>The case distinction between (3a) and (3b) could be avoided if we can
 assume that the candidate fragment is anchored at our own anchor point
 (which is guaranteed by trimming; see the ChainSync.md spec). In this case,
 case (3a) becomes impossible. We <em>could</em> require this as a stronger
 precondition, at the cost of potentially requiring the caller to trim every
 time before calling <code><a href="Ouroboros-Consensus-Util-AnchoredFragment.html#v:preferAnchoredCandidate" title="Ouroboros.Consensus.Util.AnchoredFragment">preferAnchoredCandidate</a></code>. We choose not to do this:
 trimming in most cases is unnecessary (it is only required if our own
 fragment is empty, which will be very rare indeed); moreover, the work we
 need to do here to distinguish between (3a) and (3b) is the same amount of
 work that a trimming would need to do (but we only need to do it rarely).</p><p>It is worth emphasizing that the above means that in the case that our
 fragment or the candidate fragment is empty, we can decide whether or not
 the candidate is preferred using only the &quot;always extend&quot; rule: we never
 need the header that corresponds to the anchor point.</p></div></div><div class="top"><p class="src"><a id="v:compareAnchoredCandidates" class="def">compareAnchoredCandidates</a> &#8759; &#8704; blk. (<a href="Ouroboros-Consensus-Block-SupportsProtocol.html#t:BlockSupportsProtocol" title="Ouroboros.Consensus.Block.SupportsProtocol">BlockSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Config.html#t:TopLevelConfig" title="Ouroboros.Consensus.Config">TopLevelConfig</a> blk &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk) &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#t:Ordering" title="Data.Ord">Ordering</a> <a href="src/Ouroboros.Consensus.Util.AnchoredFragment.html#compareAnchoredCandidates" class="link">Source</a> <a href="#v:compareAnchoredCandidates" class="selflink">#</a></p><div class="doc"><p>Lift <code><a href="Ouroboros-Consensus-Protocol-Abstract.html#v:compareCandidates" title="Ouroboros.Consensus.Protocol.Abstract">compareCandidates</a></code> to <code><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-AnchoredFragment.html#t:AnchoredFragment" title="Ouroboros.Network.AnchoredFragment">AnchoredFragment</a></code></p><p>PRECONDITION: Both candidates must be preferred to our chain.</p><p>Implementation note: since the empty fragment is never preferred over our
 chain, this is trivial. See discussion in <code><a href="Ouroboros-Consensus-Util-AnchoredFragment.html#v:preferAnchoredCandidate" title="Ouroboros.Consensus.Util.AnchoredFragment">preferAnchoredCandidate</a></code> for
 details.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>