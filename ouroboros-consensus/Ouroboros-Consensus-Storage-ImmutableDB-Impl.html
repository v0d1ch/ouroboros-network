<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.ImmutableDB.Impl</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.ImmutableDB.Impl.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="&quot;../doc-index.html&quot;">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.ImmutableDB.Impl</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Internals for testing purposes</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Immutable on-disk database of binary blobs</p><h1>Internal format</h1><p>The API of the ImmutableDB uses <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> to indicate a location in the
 chain/immutable database. The contents of the database are not stored in
 one big file that is appended to in eternity, but a separate file is
 created for each <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkNo</a></code>.</p><p>Within each <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkNo</a></code>, the entries are numbered by <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:RelativeSlot" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">RelativeSlot</a></code>s. Each
 <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> can be converted to a combination of an <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkNo</a></code> and a <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:RelativeSlot" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">RelativeSlot</a></code>
 (= <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Layout.html#t:ChunkSlot" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout">ChunkSlot</a></code>) and vice versa. This conversion depends on the size of the
 chunks: <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkSize" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkSize</a></code>. This size may not be the same for each chunk. When
 opening the database, the user must give a <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkInfo</a></code> that will be used to
 find out the size of each chunk.</p><p>For example:</p><pre>Chunks:         &lt;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; 0 &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&gt; &lt;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; 1 &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&gt;
chunk size:               4                   3
                &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488; &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488;
                &#9474;   &#9474;   &#9474;   &#9474;   &#9474;   &#9474; &#9474;   &#9474;   &#9474;   &#9474;   &#9474;
                &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496; &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496;
'RelativeSlot':   0   1   2   3   4     0   1   2   3
'SlotNo':        EBB  0   1   2   3    EBB  4   5   6</pre><p>Not all chunks can contain EBBs; see <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkInfo</a></code> for details.</p><h1>Errors</h1><p>Whenever an <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#v:UnexpectedError" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">UnexpectedError</a></code>
 is thrown during an operation, e.g., <code>appendBinaryBlob</code>, the database will be
 automatically closed because we can not guarantee a consistent state in the
 face of file system errors. See the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-API.html#v:reopen" title="Ouroboros.Consensus.Storage.ImmutableDB.API">reopen</a></code> operation and the paragraph
 below about reopening the database for more information.</p><h1>(Re)opening the database</h1><p>The database can be closed and reopened. In case the database was closed
 because of an unexpected error, the same database can be reopened again
 with <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-API.html#v:reopen" title="Ouroboros.Consensus.Storage.ImmutableDB.API">reopen</a></code> using a <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a></code>, which will truncate invalid data
 from the database until a valid prefix is recovered.</p><h1>Concurrency</h1><p>The same database should not be opened multiple times concurrently.</p><p>TODO Should we ensure this with a lock file?
 <a href="https://hackage.haskell.org/package/filelock-0.1.1.2/docs/System-FileLock.html">https://hackage.haskell.org/package/filelock-0.1.1.2/docs/System-FileLock.html</a></p><p>The database can have multiple readers, but should only have one writer.</p><h1>Layout on disk</h1><p>The database is structured on disk as follows:</p><pre>/
  00000.epoch
  00000.primary
  00000.secondary
  ..
  00008.epoch
  00008.primary
  00008.secondary</pre><p>For each chunk, there are three files on disk:</p><ul><li>A &quot;chunk file&quot; that stores the actual binary blobs. But nothing
     more, so nothing is stored for empty slots.</li><li>A &quot;secondary index file&quot; that stores information about each block:
     its hash, the slot number or epoch number in case of an EBB, a checksum
     of the block, the offset of the block in the chunk file, and more. This
     index is sparse to save space.</li><li>A &quot;primary index file&quot; that maps slots to offsets in the secondary
     index file.</li></ul></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:withDB">withDB</a> &#8759; &#8704; m h hash e a. (<a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>, <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> hash, <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> hash, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> h) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a> m h &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkInfo</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:HashInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">HashInfo</a> hash &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ChunkFileParser" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ChunkFileParser</a> e m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Parser.html#t:BlockSummary" title="Ouroboros.Consensus.Storage.ImmutableDB.Parser">BlockSummary</a> hash) hash &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">TraceEvent</a> e hash) &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl-Index-Cache.html#t:CacheConfig" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache">CacheConfig</a> &#8594; <a href="Ouroboros-Consensus-BlockchainTime-API.html#t:BlockchainTime" title="Ouroboros.Consensus.BlockchainTime.API">BlockchainTime</a> m &#8594; (<a href="Ouroboros-Consensus-Storage-ImmutableDB-API.html#t:ImmutableDB" title="Ouroboros.Consensus.Storage.ImmutableDB.API">ImmutableDB</a> hash m &#8594; m a) &#8594; m a</li><li class="src short"><a href="#v:openDBInternal">openDBInternal</a> &#8759; &#8704; m h hash e. (<a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>, <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> hash, <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> hash, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> h) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a> m h &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkInfo</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:HashInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">HashInfo</a> hash &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ChunkFileParser" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ChunkFileParser</a> e m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Parser.html#t:BlockSummary" title="Ouroboros.Consensus.Storage.ImmutableDB.Parser">BlockSummary</a> hash) hash &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">TraceEvent</a> e hash) &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl-Index-Cache.html#t:CacheConfig" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache">CacheConfig</a> &#8594; <a href="Ouroboros-Consensus-BlockchainTime-API.html#t:BlockchainTime" title="Ouroboros.Consensus.BlockchainTime.API">BlockchainTime</a> m &#8594; m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-API.html#t:ImmutableDB" title="Ouroboros.Consensus.Storage.ImmutableDB.API">ImmutableDB</a> hash m, <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#t:Internal" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">Internal</a> hash m)</li><li class="src short"><span class="keyword">data</span> <a href="#t:Internal">Internal</a> hash m = <a href="#v:Internal">Internal</a> {<ul class="subs"><li><a href="#v:deleteAfter_">deleteAfter_</a> &#8759; <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a> &#8658; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ImmTipWithInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ImmTipWithInfo</a> hash &#8594; m ()</li></ul>}</li><li class="src short"><a href="#v:deleteAfter">deleteAfter</a> &#8759; <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a> &#8658; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#t:Internal" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">Internal</a> hash m &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ImmTipWithInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ImmTipWithInfo</a> hash &#8594; m ()</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:withDB" class="def">withDB</a> &#8759; &#8704; m h hash e a. (<a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>, <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> hash, <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> hash, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> h) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a> m h &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkInfo</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:HashInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">HashInfo</a> hash &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ChunkFileParser" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ChunkFileParser</a> e m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Parser.html#t:BlockSummary" title="Ouroboros.Consensus.Storage.ImmutableDB.Parser">BlockSummary</a> hash) hash &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">TraceEvent</a> e hash) &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl-Index-Cache.html#t:CacheConfig" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache">CacheConfig</a> &#8594; <a href="Ouroboros-Consensus-BlockchainTime-API.html#t:BlockchainTime" title="Ouroboros.Consensus.BlockchainTime.API">BlockchainTime</a> m &#8594; (<a href="Ouroboros-Consensus-Storage-ImmutableDB-API.html#t:ImmutableDB" title="Ouroboros.Consensus.Storage.ImmutableDB.API">ImmutableDB</a> hash m &#8594; m a) &#8594; m a <a href="src/Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#withDB" class="link">Source</a> <a href="#v:withDB" class="selflink">#</a></p><div class="doc"><p>Open the database, creating it from scratch if necessary or reopening an
 existing one using the given <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a></code>.</p><p>See <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a></code> for more details on the different validation
 policies.</p><p>An <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ChunkFileParser" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ChunkFileParser</a></code> must be passed in order to reconstruct indices from
 chunk files. The <code><a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word" title="Data.Word">Word</a></code> that the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ChunkFileParser" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ChunkFileParser</a></code> must return for each
 <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> is the size (in bytes) occupied by the (non-empty) block
 corresponding to the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code>. The only reason we need to know the size of
 the blocks is to compute the offset of the end of the last block, so we can
 know where to truncate the file to in case of invalid trailing data. For
 all other blocks, we can derive this from the offset of the next block, but
 there is of course no block after the last one.</p><p><strong>Note</strong>: To be used in conjunction with <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#v:withDB" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">withDB</a></code>.</p></div></div><a href="#g:1" id="g:1"><h1>Internals for testing purposes</h1></a><div class="top"><p class="src"><a id="v:openDBInternal" class="def">openDBInternal</a> &#8759; &#8704; m h hash e. (<a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>, <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> hash, <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> hash, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> h) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a> m h &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Chunks-Internal.html#t:ChunkInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal">ChunkInfo</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:HashInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">HashInfo</a> hash &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ValidationPolicy" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ValidationPolicy</a> &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ChunkFileParser" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ChunkFileParser</a> e m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Parser.html#t:BlockSummary" title="Ouroboros.Consensus.Storage.ImmutableDB.Parser">BlockSummary</a> hash) hash &#8594; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">TraceEvent</a> e hash) &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl-Index-Cache.html#t:CacheConfig" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache">CacheConfig</a> &#8594; <a href="Ouroboros-Consensus-BlockchainTime-API.html#t:BlockchainTime" title="Ouroboros.Consensus.BlockchainTime.API">BlockchainTime</a> m &#8594; m (<a href="Ouroboros-Consensus-Storage-ImmutableDB-API.html#t:ImmutableDB" title="Ouroboros.Consensus.Storage.ImmutableDB.API">ImmutableDB</a> hash m, <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#t:Internal" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">Internal</a> hash m) <a href="src/Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDBInternal" class="link">Source</a> <a href="#v:openDBInternal" class="selflink">#</a></p><div class="doc"><p>For testing purposes:</p><ul><li>Exposes internal via <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#t:Internal" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">Internal</a></code></li><li>Non-bracketed, as <code>quickcheck-state-machine</code> doesn't support that.</li></ul></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Internal" class="def">Internal</a> hash m <a href="src/Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal" class="link">Source</a> <a href="#t:Internal" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Internal" class="def">Internal</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:deleteAfter_" class="def">deleteAfter_</a> &#8759; <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a> &#8658; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ImmTipWithInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ImmTipWithInfo</a> hash &#8594; m ()</dfn><div class="doc"><p>Delete everything in the database after the specified tip.</p><p>PRECONDITION: The tip must correspond to an existing block (unless it
 is <code>TipGen</code>).</p><p>The correctness of open iterators is not guaranteed, they should be
 closed before calling this operation.</p><p>Throws a <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#v:ClosedDBError" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ClosedDBError</a></code> if the database is closed.</p></div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:deleteAfter" class="def">deleteAfter</a> &#8759; <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a> &#8658; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#t:Internal" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">Internal</a> hash m &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:ImmTipWithInfo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">ImmTipWithInfo</a> hash &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter" class="link">Source</a> <a href="#v:deleteAfter" class="selflink">#</a></p><div class="doc"><p>Wrapper around <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#v:deleteAfter_" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">deleteAfter_</a></code> to ensure <code><a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a></code> constraint</p><p>See documentation of <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Impl.html#v:deleteAfter_" title="Ouroboros.Consensus.Storage.ImmutableDB.Impl">deleteAfter_</a></code>.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>