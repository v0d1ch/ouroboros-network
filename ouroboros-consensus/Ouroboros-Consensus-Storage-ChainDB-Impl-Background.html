<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.ChainDB.Impl.Background</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Launch background tasks</a></li><li><a href="#g:2">Copying blocks from the VolatileDB to the ImmutableDB</a></li><li><a href="#g:3">Executing garbage collection</a></li><li><a href="#g:4">Scheduling garbage collections</a><ul><li><a href="#g:5">Testing</a></li></ul></li><li><a href="#g:6">Adding blocks to the ChainDB</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Background tasks:</p><ul><li>Copying blocks from the VolatileDB to the ImmutableDB</li><li>Performing and scheduling garbage collections on the VolatileDB</li><li>Writing snapshots of the LedgerDB to disk and deleting old ones</li><li>Executing scheduled chain selections</li></ul></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:launchBgTasks">launchBgTasks</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; m ()</li><li class="src short"><a href="#v:copyToImmDB">copyToImmDB</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk), <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Slot.html#t:WithOrigin" title="Cardano.Slotting.Slot">WithOrigin</a> <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a>)</li><li class="src short"><a href="#v:copyAndSnapshotRunner">copyAndSnapshotRunner</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk)) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></li><li class="src short"><a href="#v:updateLedgerSnapshots">updateLedgerSnapshots</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m ()</li><li class="src short"><a href="#v:garbageCollect">garbageCollect</a> &#8759; &#8704; m blk. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ()</li><li class="src short"><span class="keyword">data</span> <a href="#t:GcSchedule">GcSchedule</a> m</li><li class="src short"><span class="keyword">data</span> <a href="#t:GcParams">GcParams</a> = <a href="#v:GcParams">GcParams</a> {<ul class="subs"><li><a href="#v:gcDelay">gcDelay</a> &#8759; !<a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a></li><li><a href="#v:gcInterval">gcInterval</a> &#8759; !<a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a></li></ul>}</li><li class="src short"><a href="#v:newGcSchedule">newGcSchedule</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m)</li><li class="src short"><a href="#v:scheduleGC">scheduleGC</a> &#8759; &#8704; m blk. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceGCEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceGCEvent</a> blk) &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; m ()</li><li class="src short"><a href="#v:computeTimeForGC">computeTimeForGC</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a> &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a> &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></li><li class="src short"><a href="#v:gcScheduleRunner">gcScheduleRunner</a> &#8759; &#8704; m. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ()) &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:ScheduledGc">ScheduledGc</a> = <a href="#v:ScheduledGc">ScheduledGc</a> {<ul class="subs"><li><a href="#v:scheduledGcTime">scheduledGcTime</a> &#8759; !<a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></li><li><a href="#v:scheduledGcSlot">scheduledGcSlot</a> &#8759; !<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></li></ul>}</li><li class="src short"><a href="#v:dumpGcSchedule">dumpGcSchedule</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:STM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">STM</a> m [<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a>]</li><li class="src short"><a href="#v:addBlockRunner">addBlockRunner</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Launch background tasks</h1></a><div class="top"><p class="src"><a id="v:launchBgTasks" class="def">launchBgTasks</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#launchBgTasks" class="link">Source</a> <a href="#v:launchBgTasks" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a></td><td class="doc"><p>Number of immutable blocks replayed on ledger DB startup</p></td></tr><tr><td class="src">&#8594; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div></div><a href="#g:2" id="g:2"><h1>Copying blocks from the VolatileDB to the ImmutableDB</h1></a><div class="top"><p class="src"><a id="v:copyToImmDB" class="def">copyToImmDB</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk), <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Slot.html#t:WithOrigin" title="Cardano.Slotting.Slot">WithOrigin</a> <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a>) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmDB" class="link">Source</a> <a href="#v:copyToImmDB" class="selflink">#</a></p><div class="doc"><p>Copy the blocks older than <code>k</code> from the VolatileDB to the ImmutableDB.</p><p>These headers of these blocks can be retrieved by dropping the <code>k</code> most
 recent blocks from the fragment stored in <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbChain" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbChain</a></code>.</p><p>The copied blocks are removed from the fragment stored in <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbChain" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbChain</a></code>.</p><p>This function does not remove blocks from the VolatileDB.</p><p>The <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> of the tip of the ImmutableDB after copying the blocks is
 returned. This can be used for a garbage collection on the VolatileDB.</p><p>NOTE: this function would not be safe when called multiple times
 concurrently. To enforce thread-safety, a lock is obtained at the start of
 this function and released at the end. So in practice, this function can be
 called multiple times concurrently, but the calls will be serialised.</p><p>NOTE: this function <em>can</em> run concurrently with all other functions, just
 not with itself.</p></div></div><div class="top"><p class="src"><a id="v:copyAndSnapshotRunner" class="def">copyAndSnapshotRunner</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyAndSnapshotRunner" class="link">Source</a> <a href="#v:copyAndSnapshotRunner" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk))</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a></td><td class="doc"><p>Number of immutable blocks replayed on ledger DB startup</p></td></tr><tr><td class="src">&#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Copy blocks from the VolDB to ImmDB and take snapshots of the LgrDB</p><p>We watch the chain for changes. Whenever the chain is longer than <code>k</code>, then
 the headers older than <code>k</code> are copied from the VolDB to the ImmDB (using
 <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:copyToImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">copyToImmDB</a></code>). Once that is complete,</p><ul><li>We periodically take a snapshot of the LgrDB (depending on its config).
   When enough blocks (depending on its config) have been replayed during
   startup, a snapshot of the replayed LgrDB will be written to disk at the
   start of this function.
   NOTE: After this initial snapshot we do not take a snapshot of the LgrDB
   until the chain has changed again, irrespective of the LgrDB policy.</li><li>Schedule GC of the VolDB (<code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:scheduleGC" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">scheduleGC</a></code>) for the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> of the most
   recent block that was copied.</li></ul><p>It is important that we only take LgrDB snapshots when are are <em>sure</em> they
 have been copied to the ImmDB, since the LgrDB assumes that all snapshots
 correspond to immutable blocks. (Of course, data corruption can occur and we
 can handle it by reverting to an older LgrDB snapshot, but we should need
 this only in exceptional circumstances.)</p><p>We do not store any state of the VolDB GC. If the node shuts down before GC
 can happen, when we restart the node and schedule the <em>next</em> GC, it will
 <em>imply</em> any previously scheduled GC, since GC is driven by slot number
 (&quot;garbage collect anything older than <code>x</code>&quot;).</p></div></div><div class="top"><p class="src"><a id="v:updateLedgerSnapshots" class="def">updateLedgerSnapshots</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots" class="link">Source</a> <a href="#v:updateLedgerSnapshots" class="selflink">#</a></p><div class="doc"><p>Write a snapshot of the LedgerDB to disk and remove old snapshots
 (typically one) so that only <code>onDiskNumSnapshots</code> snapshots are on disk.</p></div></div><a href="#g:3" id="g:3"><h1>Executing garbage collection</h1></a><div class="top"><p class="src"><a id="v:garbageCollect" class="def">garbageCollect</a> &#8759; &#8704; m blk. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect" class="link">Source</a> <a href="#v:garbageCollect" class="selflink">#</a></p><div class="doc"><p>Trigger a garbage collection for blocks older than the given <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> on
 the VolatileDB.</p><p>Also removes the corresponding cached &quot;previously applied points&quot; from the
 LedgerDB.</p><p>This is thread-safe as the VolatileDB locks itself while performing a GC.</p><p>TODO will a long GC be a bottleneck? It will block any other calls to
 <code>putBlock</code> and <code>getBlock</code>.</p></div></div><a href="#g:4" id="g:4"><h1>Scheduling garbage collections</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:GcSchedule" class="def">GcSchedule</a> m <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule" class="link">Source</a> <a href="#t:GcSchedule" class="selflink">#</a></p><div class="doc"><p>Scheduled garbage collections</p><p>When a block has been copied to the ImmutableDB, we schedule a VolatileDB
 garbage collection for the slot corresponding to the block in the future.
 How far in the future is determined by the <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:gcDelay" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">gcDelay</a></code> parameter. The goal is
 to allow some overlap so that the write to the ImmutableDB will have been
 flushed to disk before the block is removed from the VolatileDB.</p><p>We store scheduled garbage collections in a LIFO queue. Since the queue
 will be very short (see further down for why) and entries are more often
 added (at the block sync speed by a single thread) than removed (once every
 <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:gcInterval" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">gcInterval</a></code>), we simply use a <code><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Data-Sequence-Strict.html#t:StrictSeq" title="Data.Sequence.Strict">StrictSeq</a></code> stored in a <code>TVar</code> to make
 reasoning and testing easier. Entries are enqueued at the end (right) and
 dequeued from the head (left).</p><p>The <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code>s in the queue will be monotonically increasing. A fictional
 example (with hh:mm:ss):</p><pre>[(16:01:12, SlotNo 1012), (16:04:38, SlotNo 1045), ..]</pre><p>Scheduling a garbage collection with <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:scheduleGC" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">scheduleGC</a></code> will add an entry to the
 end of the queue for the given slot at the time equal to now
 (<code><a href="Ouroboros-Consensus-Util-IOLike.html#v:getMonotonicTime" title="Ouroboros.Consensus.Util.IOLike">getMonotonicTime</a></code>) + the <code>gcDelay</code> rounded to <code>gcInterval</code>. Unless the
 last entry in the queue was scheduled for the same rounded time, in that
 case the new entry replaces the existing entry. The goal of this is to
 batch garbage collections so that, when possible, at most one garbage
 collection happens every <code>gcInterval</code>.</p><p>For example, starting with an empty queue and <code>gcDelay = 5min</code> and
 <code>gcInterval = 10s</code>:</p><p>At 8:43:22, we schedule a GC for slot 10:</p><pre>[(8:48:30, SlotNo 10)]</pre><p>The scheduled time is rounded up to the next interval. Next, at 8:43:24, we
 schedule a GC for slot 11:</p><pre>[(8:48:30, SlotNo 11)]</pre><p>Note that the existing entry is replaced with the new one, as they map to
 the same <code>gcInterval</code>. Instead of two GCs 2 seconds apart, we will only
 schedule one GC.</p><p>Next, at 8:44:02, we schedule a GC for slot 12:</p><pre>[(8:48:30, SlotNo 11), (8:49:10, SlotNo 12)]</pre><p>Now, a new entry was appended to the queue, as it doesn't map to the same
 <code>gcInterval</code> as the last one.</p><p>In other words, everything scheduled in the first 10s will be done after
 20s. The bounds are the open-closed interval:</p><pre>(now + gcDelay, now + gcDelay + gcInterval]</pre><p>Whether we're syncing at high speed or downloading blocks as they are
 produced, the length of the queue will be at most <code>&#8968;gcDelay / gcInterval&#8969; +
 1</code>, e.g., 5min / 10s = 31 entries. The <code>+ 1</code> is needed because we might be
 somewhere in the middle of a <code>gcInterval</code>.</p><p>The background thread will look at head of the queue and wait until that
 has <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code> passed. After the wait, it will pop off the head of the queue
 and perform a garbage collection for the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> in the head. Note that
 the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> before the wait can be different from the one after the wait,
 precisely because of batching.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:GcParams" class="def">GcParams</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcParams" class="link">Source</a> <a href="#t:GcParams" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:GcParams" class="def">GcParams</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:gcDelay" class="def">gcDelay</a> &#8759; !<a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a></dfn><div class="doc"><p>How long to wait until performing the GC. See <code>cdbsGcDelay</code>.</p></div></li><li><dfn class="src"><a id="v:gcInterval" class="def">gcInterval</a> &#8759; !<a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a></dfn><div class="doc"><p>The GC interval: the minimum time between two GCs. See
 <code>cdbsGcInterval</code>.</p></div></li></ul></div></td></tr></table></div><div class="subs instances"><details id="i:GcParams" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:GcParams:Show:1"></span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:Show" title="Text.Show">Show</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-410" class="link">Source</a> <a href="#t:GcParams" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:GcParams:Show:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> &#8759; [<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a>] &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="#v:showList" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:newGcSchedule" class="def">newGcSchedule</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#newGcSchedule" class="link">Source</a> <a href="#v:newGcSchedule" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:scheduleGC" class="def">scheduleGC</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduleGC" class="link">Source</a> <a href="#v:scheduleGC" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceGCEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceGCEvent</a> blk)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></td><td class="doc"><p>The slot to use for garbage collection</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><a id="v:computeTimeForGC" class="def">computeTimeForGC</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#computeTimeForGC" class="link">Source</a> <a href="#v:computeTimeForGC" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcParams" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcParams</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></td><td class="doc"><p>Now</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></td><td class="doc"><p>The time at which to perform the GC</p></td></tr></table></div></div><div class="top"><p class="src"><a id="v:gcScheduleRunner" class="def">gcScheduleRunner</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcScheduleRunner" class="link">Source</a> <a href="#v:gcScheduleRunner" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ())</td><td class="doc"><p>GC function</p></td></tr><tr><td class="src">&#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><a href="#g:5" id="g:5"><h2>Testing</h2></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ScheduledGc" class="def">ScheduledGc</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#ScheduledGc" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:ScheduledGc" class="def">ScheduledGc</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:scheduledGcTime" class="def">scheduledGcTime</a> &#8759; !<a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></dfn><div class="doc"><p>Time at which to run the garbage collection</p></div></li><li><dfn class="src"><a id="v:scheduledGcSlot" class="def">scheduledGcSlot</a> &#8759; !<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></dfn><div class="doc"><p>For which slot to run the garbage collection</p></div></li></ul></div></td></tr></table></div><div class="subs instances"><details id="i:ScheduledGc" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ScheduledGc:Eq:1"></span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-398" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ScheduledGc:Eq:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-61--61-">(==)</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="#v:-61--61-" class="selflink">#</a></p><p class="src"><a href="#v:-47--61-">(/=)</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="#v:-47--61-" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ScheduledGc:Show:2"></span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:Show" title="Text.Show">Show</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-398" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ScheduledGc:Show:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> &#8759; [<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a>] &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="#v:showList" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ScheduledGc:Generic:3"></span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Generic" title="GHC.Generics">Generic</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-398" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ScheduledGc:Generic:3"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="subs associated-types"><p class="caption">Associated Types</p><p class="src"><span class="keyword">type</span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> <a href="#t:Rep" class="selflink">#</a></p></div> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:from">from</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> x <a href="#v:from" class="selflink">#</a></p><p class="src"><a href="#v:to">to</a> &#8759; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> x &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> <a href="#v:to" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ScheduledGc:NoUnexpectedThunks:4"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-398" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ScheduledGc:NoUnexpectedThunks:4"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:noUnexpectedThunks">noUnexpectedThunks</a> &#8759; [<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:noUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:whnfNoUnexpectedThunks">whnfNoUnexpectedThunks</a> &#8759; [<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:whnfNoUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:showTypeOf">showTypeOf</a> &#8759; <a href="Ouroboros-Consensus-Util-RedundantConstraints.html#t:Proxy" title="Ouroboros.Consensus.Util.RedundantConstraints">Proxy</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:showTypeOf" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ScheduledGc:Condense:5"></span> <a href="Ouroboros-Consensus-Util-Condense.html#t:Condense" title="Ouroboros.Consensus.Util.Condense">Condense</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-400" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ScheduledGc:Condense:5"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:condense">condense</a> &#8759; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="src/Ouroboros.Consensus.Util.Condense.html#condense" class="link">Source</a> <a href="#v:condense" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ScheduledGc:Rep:6"></span> <span class="keyword">type</span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a></span> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#line-398" class="link">Source</a> <a href="#t:ScheduledGc" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ScheduledGc:Rep:6"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</a></p> <div class="src"><span class="keyword">type</span> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a> = <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:D1" title="GHC.Generics">D1</a> (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:MetaData" title="GHC.Generics">MetaData</a> &quot;ScheduledGc&quot; &quot;Ouroboros.Consensus.Storage.ChainDB.Impl.Background&quot; &quot;ouroboros-consensus-0.1.0.0-inplace&quot; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:False" title="Data.Bool">False</a>) (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:C1" title="GHC.Generics">C1</a> (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:MetaCons" title="GHC.Generics">MetaCons</a> &quot;ScheduledGc&quot; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:PrefixI" title="GHC.Generics">PrefixI</a> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:True" title="Data.Bool">True</a>) (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:S1" title="GHC.Generics">S1</a> (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:MetaSel" title="GHC.Generics">MetaSel</a> (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#v:Just" title="GHC.Maybe">Just</a> &quot;scheduledGcTime&quot;) <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:NoSourceUnpackedness" title="GHC.Generics">NoSourceUnpackedness</a> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:SourceStrict" title="GHC.Generics">SourceStrict</a> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:DecidedStrict" title="GHC.Generics">DecidedStrict</a>) (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rec0" title="GHC.Generics">Rec0</a> <a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a>) <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t::-42-:" title="GHC.Generics">:*:</a> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:S1" title="GHC.Generics">S1</a> (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:MetaSel" title="GHC.Generics">MetaSel</a> (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#v:Just" title="GHC.Maybe">Just</a> &quot;scheduledGcSlot&quot;) <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:NoSourceUnpackedness" title="GHC.Generics">NoSourceUnpackedness</a> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:SourceStrict" title="GHC.Generics">SourceStrict</a> <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#v:DecidedStrict" title="GHC.Generics">DecidedStrict</a>) (<a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rec0" title="GHC.Generics">Rec0</a> <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a>)))</div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:dumpGcSchedule" class="def">dumpGcSchedule</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:STM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">STM</a> m [<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:ScheduledGc" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">ScheduledGc</a>] <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#dumpGcSchedule" class="link">Source</a> <a href="#v:dumpGcSchedule" class="selflink">#</a></p><div class="doc"><p>Return the current contents of the <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a></code> queue without modifying
 it.</p><p>For testing purposes.</p></div></div><a href="#g:6" id="g:6"><h1>Adding blocks to the ChainDB</h1></a><div class="top"><p class="src"><a id="v:addBlockRunner" class="def">addBlockRunner</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner" class="link">Source</a> <a href="#v:addBlockRunner" class="selflink">#</a></p><div class="doc"><p>Read blocks from <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbBlocksToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbBlocksToAdd</a></code> and add them synchronously to the
 ChainDB.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>