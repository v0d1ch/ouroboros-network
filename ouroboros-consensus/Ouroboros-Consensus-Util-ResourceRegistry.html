<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Util.ResourceRegistry</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link href="xhaddock.css" rel="alternate stylesheet" type="text/css" title="Classic" /><link href="ocean.css" rel="alternate stylesheet" type="text/css" title="Ocean" /><link href="xhaddock.css" rel="alternate stylesheet" type="text/css" title="Classic" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Util.ResourceRegistry</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Creating and releasing the registry itself</a></li><li><a href="#g:2">Allocating and releasing regular resources</a></li><li><a href="#g:3">Threads</a></li><li><a href="#g:4">Temporary registry</a></li><li><a href="#g:5">Combinators primarily for testing</a></li></ul></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:ResourceRegistry">ResourceRegistry</a> m</li><li class="src short"><span class="keyword">data</span> <a href="#t:RegistryClosedException">RegistryClosedException</a> = <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="#v:RegistryClosedException">RegistryClosedException</a> {<ul class="subs"><li><a href="#v:registryClosedRegistryContext">registryClosedRegistryContext</a> &#8759; !(Context m)</li><li><a href="#v:registryClosedCloseCallStack">registryClosedCloseCallStack</a> &#8759; !<a href="Ouroboros-Consensus-Util-CallStack.html#t:PrettyCallStack" title="Ouroboros.Consensus.Util.CallStack">PrettyCallStack</a></li><li><a href="#v:registryClosedAllocContext">registryClosedAllocContext</a> &#8759; !(Context m)</li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:ResourceRegistryThreadException">ResourceRegistryThreadException</a></li><li class="src short"><a href="#v:withRegistry">withRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a) &#8594; m a</li><li class="src short"><a href="#v:registryThread">registryThread</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ThreadId" title="Ouroboros.Consensus.Util.IOLike">ThreadId</a> m</li><li class="src short"><span class="keyword">data</span> <a href="#t:ResourceKey">ResourceKey</a> m</li><li class="src short"><a href="#v:allocate">allocate</a> &#8759; &#8704; m a. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; (ResourceId &#8594; m a) &#8594; (a &#8594; m ()) &#8594; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m, a)</li><li class="src short"><a href="#v:allocateEither">allocateEither</a> &#8759; &#8704; m e a. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; (ResourceId &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> e a)) &#8594; (a &#8594; m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a>) &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> e (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m, a))</li><li class="src short"><a href="#v:release">release</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> (Context m))</li><li class="src short"><a href="#v:unsafeRelease">unsafeRelease</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> (Context m))</li><li class="src short"><a href="#v:releaseAll">releaseAll</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m ()</li><li class="src short"><a href="#v:unsafeReleaseAll">unsafeReleaseAll</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m ()</li><li class="src short"><span class="keyword">data</span> <a href="#t:Thread">Thread</a> m a</li><li class="src short"><a href="#v:threadId">threadId</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ThreadId" title="Ouroboros.Consensus.Util.IOLike">ThreadId</a> m</li><li class="src short"><a href="#v:forkThread">forkThread</a> &#8759; &#8704; m a. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a &#8594; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a)</li><li class="src short"><a href="#v:cancelThread">cancelThread</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m ()</li><li class="src short"><a href="#v:withThread">withThread</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a &#8594; (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m b) &#8594; m b</li><li class="src short"><a href="#v:waitThread">waitThread</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m a</li><li class="src short"><a href="#v:waitAnyThread">waitAnyThread</a> &#8759; &#8704; m a. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; [<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a] &#8594; m a</li><li class="src short"><a href="#v:linkToRegistry">linkToRegistry</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m ()</li><li class="src short"><a href="#v:forkLinkedThread">forkLinkedThread</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a &#8594; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a)</li><li class="src short"><span class="keyword">data</span> <a href="#t:WithTempRegistry">WithTempRegistry</a> st m a</li><li class="src short"><a href="#v:runWithTempRegistry">runWithTempRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (a, st) &#8594; m a</li><li class="src short"><span class="keyword">data</span> <a href="#t:TempRegistryException">TempRegistryException</a> = <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="#v:TempRegistryRemainingResource">TempRegistryRemainingResource</a> {<ul class="subs"><li><a href="#v:tempRegistryContext">tempRegistryContext</a> &#8759; !(Context m)</li><li><a href="#v:tempRegistryResource">tempRegistryResource</a> &#8759; !(Context m)</li></ul>}</li><li class="src short"><a href="#v:allocateTemp">allocateTemp</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; m a &#8594; (a &#8594; m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a>) &#8594; (st &#8594; a &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a>) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a</li><li class="src short"><a href="#v:modifyWithTempRegistry">modifyWithTempRegistry</a> &#8759; &#8704; m st a. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; m st &#8594; (st &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ExitCase" title="Ouroboros.Consensus.Util.IOLike">ExitCase</a> st &#8594; m ()) &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/mtl-2.2.2/Control-Monad-State-Strict.html#t:StateT" title="Control.Monad.State.Strict">StateT</a> st (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) a &#8594; m a</li><li class="src short"><a href="#v:unsafeNewRegistry">unsafeNewRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m)</li><li class="src short"><a href="#v:closeRegistry">closeRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m ()</li><li class="src short"><a href="#v:countResources">countResources</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ResourceRegistry" class="def">ResourceRegistry</a> m <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry" class="link">Source</a> <a href="#t:ResourceRegistry" class="selflink">#</a></p><div class="doc"><p>Resource registry</p><p>Note on terminology: when thread A forks thread B, we will say that thread A
 is the &quot; parent &quot; and thread B is the &quot; child &quot;. No further relationship
 between the two threads is implied by this terminology. In particular, note
 that the child may outlive the parent. We will use &quot;fork&quot; and &quot;spawn&quot;
 interchangeably.</p><h1>Motivation</h1><p>Whenever we allocate resources, we must keep track of them so that we can
 deallocate them when they are no longer required. The most important tool we
 have to achieve this is <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code>:</p><pre>bracket allocateResource releaseResource $ \r -&gt;
  .. use r ..</pre><p>Often <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code> comes in the guise of a with-style combinator</p><pre>withResource $ \r -&gt;
  .. use r ..</pre><p>Where this pattern is applicable, it should be used and there is no need to
 use the <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a></code>. However, <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code> introduces strict lexical
 scoping: the resource is available inside the scope of the bracket, and
 will be deallocated once we leave that scope. That pattern is sometimes
 hard to use.</p><p>For example, suppose we have this interface to an SQL server</p><pre>query :: Query -&gt; IO QueryHandle
close :: QueryHandle -&gt; IO ()
next  :: QueryHandle -&gt; IO Row</pre><p>and suppose furthermore that we are writing a simple webserver that allows a
 client to send multiple SQL queries, get rows from any open query, and close
 queries when no longer required:</p><pre>server :: IO ()
server = go Map.empty
  where
    go :: Map QueryId QueryHandle -&gt; IO ()
    go handles = getRequest &gt;&gt;= \case
        New q -&gt; do
          h   &lt;- query q                        -- allocate
          qId &lt;- generateQueryId
          sendResponse qId
          go $ Map.insert qId h handles
        Close qId -&gt; do
          close (handles ! qId)                 -- release
          go $ Map.delete qId handles
        Next qId -&gt; do
          sendResponse =&lt;&lt; next (handles ! qId)
          go handles</pre><p>The server opens and closes query handles in response to client requests.
 Restructuring this code to use <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code> would be awkward, but as it stands
 this code does not ensure that resources get deallocated; for example, if
 the server thread is killed (<code><a href="Ouroboros-Consensus-Util-IOLike.html#v:killThread" title="Ouroboros.Consensus.Util.IOLike">killThread</a></code>), resources will be leaked.</p><p>Another, perhaps simpler, example is spawning threads. Threads too should
 be considered to be resources that we should keep track of and deallocate
 when they are no longer required, primarily because when we deallocate
 (terminate) those threads they too will have a chance to deallocate <em>their</em>
 resources. As for other resources, we have a with-style combinator for this</p><pre>withAsync $ \thread -&gt; ..</pre><p>Lexical scoping of threads is often inconvenient, however, more so than for
 regular resources. The temptation is therefore to simply fork a thread and
 forget about it, but if we are serious about resource deallocation this is
 not an acceptable solution.</p><h1>The resource registry</h1><p>The resource registry is essentially a piece of state tracking which
 resources have been allocated. The registry itself is allocated with a
 with-style combinator <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>, and when we leave that scope any
 resources not yet deallocated will be released at that point. Typically
 the registry is only used as a fall-back, ensuring that resources will
 deallocated even in the presence of exceptions. For example, here's how
 we might rewrite the above server example using a registry:</p><pre>server' :: IO ()
server' =
    withRegistry $ \registry -&gt; go registry Map.empty
  where
    go :: ResourceRegistry IO
       -&gt; Map QueryId (ResourceKey, QueryHandle)
       -&gt; IO ()
    go registry handles = getRequest &gt;&gt;= \case
        New q -&gt; do
          (key, h) &lt;- allocate registry (query q) close  -- allocate
          qId      &lt;- generateQueryId
          sendResponse qId
          go registry $ Map.insert qId (key, h) handles
        Close qId -&gt; do
          release registry (fst (handles ! qId))         -- release
          go registry $ Map.delete qId handles
        Next qId -&gt; do
          sendResponse =&lt;&lt; next (snd (handles ! qId))
          go registry handles</pre><p>We allocate the query with the help of the registry, providing the registry
 with the means to deallocate the query should that be required. We can /and
 should/ still manually release resources also: in this particular example,
 the (lexical) scope of the registry is the entire server thread, so delaying
 releasing queries until we exit that scope will probably mean we hold on to
 resources for too long. The registry is only there as a fall-back.</p><h1>Spawning threads</h1><p>We already observed in the introduction that insisting on lexical scoping
 for threads is often inconvenient, and that simply using <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:fork" title="Ouroboros.Consensus.Util.IOLike">fork</a></code> is no
 solution as it means we might leak resources. There is however another
 problem with <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:fork" title="Ouroboros.Consensus.Util.IOLike">fork</a></code>. Consider this snippet:</p><pre>withRegistry $ \registry -&gt;
  r &lt;- allocate registry allocateResource releaseResource
  fork $ .. use r ..</pre><p>It is easy to see that this code is problematic: we allocate a resource <code>r</code>,
 then spawn a thread that uses <code>r</code>, and finally leave the scope of
 <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>, thereby deallocating <code>r</code> -- leaving the thread to run with
 a now deallocated resource.</p><p>It is <em>only</em> safe for threads to use a given registry, and/or its registered
 resources, if the lifetime of those threads is tied to the lifetime of the
 registry. There would be no problem with the example above if the thread
 would be terminated when we exit the scope of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>.</p><p>The <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:forkThread" title="Ouroboros.Consensus.Util.ResourceRegistry">forkThread</a></code> combinator provided by the registry therefore does two
 things: it allocates the thread as a resource in the registry, so that it can
 kill the thread when releasing all resources in the registry. It also records
 the thread ID in a set of known threads. Whenever the registry is accessed
 from a thread <em>not</em> in this set, the registry throws a runtime exception,
 since such a thread might outlive the registry and hence its contents. The
 intention is that this guards against dangerous patterns like the one above.</p><h1>Linking</h1><p>When thread A spawns thread B using <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code>, the lifetime of B is tied
 to the lifetime of A:</p><pre>withAsync .. $ \threadB -&gt; ..</pre><p>After all, when A exits the scope of the <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code>, thread B will be
 killed. The reverse is however not true: thread B can terminate before
 thread A. It is often useful for thread A to be able to declare a dependency
 on thread B: if B somehow fails, that is, terminates with an exception, we
 want that exception to be rethrown in thread A as well. A can achieve this
 by <em>linking</em> to B:</p><pre>withAsync .. $ \threadB -&gt; do
  link threadB
  ..</pre><p>Linking a parent to a child is however of limited value if the lifetime of
 the child is not limited by the lifetime of the parent. For example, if A
 does</p><pre>threadB &lt;- async $ ..
link threadB</pre><p>and A terminates before B does, any exception thrown by B might be send to a
 thread that no longer exists. This is particularly problematic when we start
 chaining threads: if A spawns-and-links-to B which spawns-and-links-to C, and
 C throws an exception, perhaps the intention is that this gets rethrown to B,
 and then rethrown to A, terminating all three threads; however, if B has
 terminated before the exception is thrown, C will throw the exception to a
 non-existent thread and A is never notified.</p><p>For this reason, the registry's <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:linkToRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">linkToRegistry</a></code> combinator does not link the
 specified to the thread calling <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:linkToRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">linkToRegistry</a></code>, but rather to the thread
 that created the registry. After all, the lifetime of threads spawned with
 <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:forkThread" title="Ouroboros.Consensus.Util.ResourceRegistry">forkThread</a></code> can certainly exceed the lifetime of their parent threads, but
 the lifetime of <em>all</em> threads spawned using the registry will be limited by
 the scope of that registry, and hence the lifetime of the thread that created
 it. So, when we call <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:linkToRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">linkToRegistry</a></code>, the exception will be thrown the
 thread that created the registry, which (if not caught) will cause that that
 to exit the scope of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>, thereby terminating all threads in that
 registry.</p><p># Combining the registry and with-style allocation</p><p>It is perfectly possible (indeed, advisable) to use <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code> and
 bracket-like allocation functions alongside the registry, but note that the
 usual caveats with <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code> and forking threads still applies. In
 particular, spawning threads inside the <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:bracket" title="Ouroboros.Consensus.Util.IOLike">bracket</a></code> that make use of the
 bracketed resource is problematic; this is of course true whether or not a
 registry is used.</p><p>In principle this also includes <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code>; however, since <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code>
 results in a thread that is not known to the registry, such a thread will not
 be able to use the registry (the registry would throw an unknown thread
 exception, as described above). For this purpose we provide <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withThread" title="Ouroboros.Consensus.Util.ResourceRegistry">withThread</a></code>;
 <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withThread" title="Ouroboros.Consensus.Util.ResourceRegistry">withThread</a></code> (as opposed to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:forkThread" title="Ouroboros.Consensus.Util.ResourceRegistry">forkThread</a></code>) should be used when a parent thread
 wants to handle exceptions in the child thread; see <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withThread" title="Ouroboros.Consensus.Util.ResourceRegistry">withThread</a></code> for
 detailed discussion.</p><p>It is <em>also</em> fine to includes nested calls to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>. Since the
 lifetime of such a registry (and all resources within) is tied to the thread
 calling <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>, which itself is tied to the &quot;parent registry&quot; in
 which it was created, this creates a hierarchy of registries. It is of course
 essential for compositionality that we should be able to create local
 registries, but even if we do have easy access to a parent regisry, creating
 a local one where possibly is useful as it limits the scope of the resources
 created within, and hence their maximum lifetimes.</p></div><div class="subs instances"><details id="i:ResourceRegistry" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceRegistry:Generic:1"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Generic" title="GHC.Generics">Generic</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-291" class="link">Source</a> <a href="#t:ResourceRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceRegistry:Generic:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs associated-types"><p class="caption">Associated Types</p><p class="src"><span class="keyword">type</span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m) &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#t:Rep" class="selflink">#</a></p></div> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:from">from</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m) x <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:from" class="selflink">#</a></p><p class="src"><a href="#v:to">to</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m) x &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:to" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceRegistry:NoUnexpectedThunks:2"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-293" class="link">Source</a> <a href="#t:ResourceRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceRegistry:NoUnexpectedThunks:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:noUnexpectedThunks">noUnexpectedThunks</a> &#8759; [<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:noUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:whnfNoUnexpectedThunks">whnfNoUnexpectedThunks</a> &#8759; [<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:whnfNoUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:showTypeOf">showTypeOf</a> &#8759; <a href="Ouroboros-Consensus-Util-RedundantConstraints.html#t:Proxy" title="Ouroboros.Consensus.Util.RedundantConstraints">Proxy</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m) &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:showTypeOf" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceRegistry:Rep:3"></span> <span class="keyword">type</span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-291" class="link">Source</a> <a href="#t:ResourceRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceRegistry:Rep:3"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="src"><span class="keyword">type</span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m)</div></details></td></tr></table></details></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:RegistryClosedException" class="def">RegistryClosedException</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#RegistryClosedException" class="link">Source</a> <a href="#t:RegistryClosedException" class="selflink">#</a></p><div class="doc"><p>Attempt to allocate a resource in a registry which is closed</p><p>When calling <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:closeRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">closeRegistry</a></code> (typically, leaving the scope of
 <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code>), all resources in the registry must be released. If a
 concurrent thread is still allocating resources, we end up with a race
 between the thread trying to allocate new resources and the registry trying
 to free them all. To avoid this, before releasing anything, the registry will
 record itself as closed. Any attempt by a concurrent thread to allocate a new
 resource will then result in a <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a></code>.</p><p>It is probably not particularly useful for threads to try and catch this
 exception (apart from in a generic handler that does local resource cleanup).
 The thread will anyway soon receive a <code>ThreadKilled</code> exception.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a id="v:RegistryClosedException" class="def">RegistryClosedException</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:registryClosedRegistryContext" class="def">registryClosedRegistryContext</a> &#8759; !(Context m)</dfn><div class="doc"><p>The context in which the registry was created</p></div></li><li><dfn class="src"><a id="v:registryClosedCloseCallStack" class="def">registryClosedCloseCallStack</a> &#8759; !<a href="Ouroboros-Consensus-Util-CallStack.html#t:PrettyCallStack" title="Ouroboros.Consensus.Util.CallStack">PrettyCallStack</a></dfn><div class="doc"><p>Callstack to the call to <code>close</code></p><p>Note that <code>close</code> can only be called from the same thread that
 created the registry.</p></div></li><li><dfn class="src"><a id="v:registryClosedAllocContext" class="def">registryClosedAllocContext</a> &#8759; !(Context m)</dfn><div class="doc"><p>Context of the call resulting in the exception</p></div></li></ul></div></td></tr></table></div><div class="subs instances"><details id="i:RegistryClosedException" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:RegistryClosedException:Show:1"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:Show" title="Text.Show">Show</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a></span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-484" class="link">Source</a> <a href="#t:RegistryClosedException" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:RegistryClosedException:Show:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a> &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> &#8759; [<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a>] &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:showList" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:RegistryClosedException:Exception:2"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a></span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-485" class="link">Source</a> <a href="#t:RegistryClosedException" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:RegistryClosedException:Exception:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:toException">toException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a> &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:SomeException" title="Ouroboros.Consensus.Util.IOLike">SomeException</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:toException" class="selflink">#</a></p><p class="src"><a href="#v:fromException">fromException</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:SomeException" title="Ouroboros.Consensus.Util.IOLike">SomeException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:fromException" class="selflink">#</a></p><p class="src"><a href="#v:displayException">displayException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:RegistryClosedException" title="Ouroboros.Consensus.Util.ResourceRegistry">RegistryClosedException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:displayException" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ResourceRegistryThreadException" class="def">ResourceRegistryThreadException</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistryThreadException" class="link">Source</a> <a href="#t:ResourceRegistryThreadException" class="selflink">#</a></p><div class="doc"><p>Registry used from untracked threads</p><p>If this exception is raised, it indicates a bug in the caller.</p></div><div class="subs instances"><details id="i:ResourceRegistryThreadException" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceRegistryThreadException:Show:1"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:Show" title="Text.Show">Show</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a></span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-1145" class="link">Source</a> <a href="#t:ResourceRegistryThreadException" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceRegistryThreadException:Show:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a> &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> &#8759; [<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a>] &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:showList" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceRegistryThreadException:Exception:2"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a></span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-1146" class="link">Source</a> <a href="#t:ResourceRegistryThreadException" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceRegistryThreadException:Exception:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:toException">toException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a> &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:SomeException" title="Ouroboros.Consensus.Util.IOLike">SomeException</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:toException" class="selflink">#</a></p><p class="src"><a href="#v:fromException">fromException</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:SomeException" title="Ouroboros.Consensus.Util.IOLike">SomeException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:fromException" class="selflink">#</a></p><p class="src"><a href="#v:displayException">displayException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistryThreadException" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistryThreadException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:displayException" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><a href="#g:1" id="g:1"><h1>Creating and releasing the registry itself</h1></a><div class="top"><p class="src"><a id="v:withRegistry" class="def">withRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a) &#8594; m a <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#withRegistry" class="link">Source</a> <a href="#v:withRegistry" class="selflink">#</a></p><div class="doc"><p>Create a new registry</p><p>See documentation of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a></code> for a detailed discussion.</p></div></div><div class="top"><p class="src"><a id="v:registryThread" class="def">registryThread</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ThreadId" title="Ouroboros.Consensus.Util.IOLike">ThreadId</a> m <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#registryThread" class="link">Source</a> <a href="#v:registryThread" class="selflink">#</a></p><div class="doc"><p>The thread that created the registry</p></div></div><a href="#g:2" id="g:2"><h1>Allocating and releasing regular resources</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ResourceKey" class="def">ResourceKey</a> m <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceKey" class="link">Source</a> <a href="#t:ResourceKey" class="selflink">#</a></p><div class="doc"><p>Resource key</p><p>Resource keys are tied to a particular registry.</p></div><div class="subs instances"><details id="i:ResourceKey" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceKey:Generic:1"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Generic" title="GHC.Generics">Generic</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-345" class="link">Source</a> <a href="#t:ResourceKey" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceKey:Generic:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs associated-types"><p class="caption">Associated Types</p><p class="src"><span class="keyword">type</span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m) &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#t:Rep" class="selflink">#</a></p></div> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:from">from</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m) x <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:from" class="selflink">#</a></p><p class="src"><a href="#v:to">to</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m) x &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:to" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceKey:NoUnexpectedThunks:2"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-345" class="link">Source</a> <a href="#t:ResourceKey" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceKey:NoUnexpectedThunks:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:noUnexpectedThunks">noUnexpectedThunks</a> &#8759; [<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:noUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:whnfNoUnexpectedThunks">whnfNoUnexpectedThunks</a> &#8759; [<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:whnfNoUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:showTypeOf">showTypeOf</a> &#8759; <a href="Ouroboros-Consensus-Util-RedundantConstraints.html#t:Proxy" title="Ouroboros.Consensus.Util.RedundantConstraints">Proxy</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m) &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:showTypeOf" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:ResourceKey:Rep:3"></span> <span class="keyword">type</span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-345" class="link">Source</a> <a href="#t:ResourceKey" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:ResourceKey:Rep:3"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="src"><span class="keyword">type</span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Generics.html#t:Rep" title="GHC.Generics">Rep</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m)</div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:allocate" class="def">allocate</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#allocate" class="link">Source</a> <a href="#v:allocate" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (ResourceId &#8594; m a)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (a &#8594; m ())</td><td class="doc"><p>Release the resource</p></td></tr><tr><td class="src">&#8594; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m, a)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Allocate new resource</p><p>The allocation function will be run with asynchronous exceptions masked. This
 means that the resource allocation must either be fast or else interruptible;
 see &quot;Dealing with Asynchronous Exceptions during Resource Acquisition&quot;
 <a href="http://www.well-typed.com/blog/97/">http://www.well-typed.com/blog/97/</a> for details.</p></div></div><div class="top"><p class="src"><a id="v:allocateEither" class="def">allocateEither</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#allocateEither" class="link">Source</a> <a href="#v:allocateEither" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (ResourceId &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> e a))</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (a &#8594; m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a>)</td><td class="doc"><p>Release the resource, return <code><a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:True" title="Data.Bool">True</a></code> when the resource
 hasn't been released or closed before.</p></td></tr><tr><td class="src">&#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> e (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m, a))</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Generalization of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:allocate" title="Ouroboros.Consensus.Util.ResourceRegistry">allocate</a></code> for allocation functions that may fail</p></div></div><div class="top"><p class="src"><a id="v:release" class="def">release</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> (Context m)) <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#release" class="link">Source</a> <a href="#v:release" class="selflink">#</a></p><div class="doc"><p>Release resource</p><p>This deallocates the resource and removes it from the registry. It will be
 the responsibility of the caller to make sure that the resource is no longer
 used in any thread.</p><p>The deallocation function is run with exceptions masked, so that we are
 guaranteed not to remove the resource from the registry without releasing it.</p><p>Releasing an already released resource is a no-op.</p><p>When the resource has not been released before, its context is returned.</p></div></div><div class="top"><p class="src"><a id="v:unsafeRelease" class="def">unsafeRelease</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceKey" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceKey</a> m &#8594; m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> (Context m)) <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#unsafeRelease" class="link">Source</a> <a href="#v:unsafeRelease" class="selflink">#</a></p><div class="doc"><p>Unsafe version of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:release" title="Ouroboros.Consensus.Util.ResourceRegistry">release</a></code></p><p>The only difference between <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:release" title="Ouroboros.Consensus.Util.ResourceRegistry">release</a></code> and <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:unsafeRelease" title="Ouroboros.Consensus.Util.ResourceRegistry">unsafeRelease</a></code> is that the latter
 does not insist that it is called from a thread that is known to the
 registry. This is dangerous, because it implies that there is a thread with
 access to a resource which may be deallocated before that thread is
 terminated. Of course, we can't detect all such situations (when the thread
 merely uses a resource but does not allocate or release we can't tell), but
 normally when we <em>do</em> detect this we throw an exception.</p><p>This function should only be used if the above situation can be ruled out
 or handled by other means.</p></div></div><div class="top"><p class="src"><a id="v:releaseAll" class="def">releaseAll</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m () <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#releaseAll" class="link">Source</a> <a href="#v:releaseAll" class="selflink">#</a></p><div class="doc"><p>Release all resources in the <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a></code> without closing.</p><p>See <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:closeRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">closeRegistry</a></code> for more details.</p></div></div><div class="top"><p class="src"><a id="v:unsafeReleaseAll" class="def">unsafeReleaseAll</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m () <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#unsafeReleaseAll" class="link">Source</a> <a href="#v:unsafeReleaseAll" class="selflink">#</a></p><div class="doc"><p>This is to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:releaseAll" title="Ouroboros.Consensus.Util.ResourceRegistry">releaseAll</a></code> what <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:unsafeRelease" title="Ouroboros.Consensus.Util.ResourceRegistry">unsafeRelease</a></code> is to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:release" title="Ouroboros.Consensus.Util.ResourceRegistry">release</a></code>: we do not
 insist that this funciton is called from a thread that is known to the
 registry. See <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:unsafeRelease" title="Ouroboros.Consensus.Util.ResourceRegistry">unsafeRelease</a></code> for why this is dangerous.</p></div></div><a href="#g:3" id="g:3"><h1>Threads</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Thread" class="def">Thread</a> m a <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#Thread" class="link">Source</a> <a href="#t:Thread" class="selflink">#</a></p><div class="doc"><p>Thread</p><p>The internals of this type are not exported.</p></div><div class="subs instances"><details id="i:Thread" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:Thread:Eq:1"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-952" class="link">Source</a> <a href="#t:Thread" class="selflink">#</a></td><td class="doc"><p><code><a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a></code> instance for <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a></code> compares <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:threadId" title="Ouroboros.Consensus.Util.ResourceRegistry">threadId</a></code> only.</p></td></tr><tr><td colspan="2"><details id="i:id:Thread:Eq:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-61--61-">(==)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/ghc-prim-0.5.3/src" class="link">Source</a> <a href="#v:-61--61-" class="selflink">#</a></p><p class="src"><a href="#v:-47--61-">(/=)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/ghc-prim-0.5.3/src" class="link">Source</a> <a href="#v:-47--61-" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:Thread:NoUnexpectedThunks:2"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-949" class="link">Source</a> <a href="#t:Thread" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:Thread:NoUnexpectedThunks:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:noUnexpectedThunks">noUnexpectedThunks</a> &#8759; [<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:noUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:whnfNoUnexpectedThunks">whnfNoUnexpectedThunks</a> &#8759; [<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a>] &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/System-IO.html#t:IO" title="System.IO">IO</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-GHC-Heap-NormalForm-Classy.html#t:ThunkInfo" title="Cardano.Prelude.GHC.Heap.NormalForm.Classy">ThunkInfo</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:whnfNoUnexpectedThunks" class="selflink">#</a></p><p class="src"><a href="#v:showTypeOf">showTypeOf</a> &#8759; <a href="Ouroboros-Consensus-Util-RedundantConstraints.html#t:Proxy" title="Ouroboros.Consensus.Util.RedundantConstraints">Proxy</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a) &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src" class="link">Source</a> <a href="#v:showTypeOf" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:threadId" class="def">threadId</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ThreadId" title="Ouroboros.Consensus.Util.IOLike">ThreadId</a> m <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#threadId" class="link">Source</a> <a href="#v:threadId" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:forkThread" class="def">forkThread</a> &#8759; &#8704; m a. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a &#8594; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a) <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#forkThread" class="link">Source</a> <a href="#v:forkThread" class="selflink">#</a></p><div class="doc"><p>Fork a new thread</p></div></div><div class="top"><p class="src"><a id="v:cancelThread" class="def">cancelThread</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m () <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#cancelThread" class="link">Source</a> <a href="#v:cancelThread" class="selflink">#</a></p><div class="doc"><p>Cancel a thread</p><p>This is a synchronous operation: the thread will have terminated when this
 function returns.</p><p>Uses <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:uninterruptibleCancel" title="Ouroboros.Consensus.Util.IOLike">uninterruptibleCancel</a></code> because that's what <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code> does.</p></div></div><div class="top"><p class="src"><a id="v:withThread" class="def">withThread</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a &#8594; (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m b) &#8594; m b <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#withThread" class="link">Source</a> <a href="#v:withThread" class="selflink">#</a></p><div class="doc"><p>Bracketed version of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:forkThread" title="Ouroboros.Consensus.Util.ResourceRegistry">forkThread</a></code></p><p>The analogue of <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code> for the registry.</p><p>Scoping thread lifetime using <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withThread" title="Ouroboros.Consensus.Util.ResourceRegistry">withThread</a></code> is important when a parent
 thread wants to link to a child thread /and handle any exceptions arising
 from the link/:</p><pre>let handleLinkException :: ExceptionInLinkedThread -&gt; m ()
    handleLinkException = ..
in handle handleLinkException $
     withThread registry codeInChild $ \child -&gt;
       ..</pre><p>instead of</p><pre>handle handleLinkException $ do  -- PROBABLY NOT CORRECT!
  child &lt;- forkThread registry codeInChild
  ..</pre><p>where the parent may exit the scope of the exception handler before the child
 terminates. If the lifetime of the child cannot be limited to the lifetime of
 the parent, the child should probably be linked to the registry instead and
 the thread that spawned the registry should handle any exceptions.</p><p>Note that in <em>principle</em> there is no problem in using <code>withAync</code> alongside a
 registry. After all, in a pattern like</p><pre>withRegistry $ \registry -&gt;
  ..
  withAsync (.. registry ..) $ \async -&gt;
    ..</pre><p>the async will be cancelled when leaving the scope of <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code> and so
 that reference to the registry, or indeed any of the resources inside the
 registry, is safe. However, the registry implements a sanity check that the
 registry is only used from known threads. This is useful: when a thread that
 is not known to the registry (in other words, whose lifetime is not tied to
 the lifetime of the registry) spawns a resource in that registry, that
 resource may well be deallocated before the thread terminates, leading to
 undefined and hard to debug behaviour (indeed, whether or not this results in
 problems may well depend on precise timing); an exception that is thrown when
 <em>allocating</em> the resource is (more) deterministic and easier to debug.
 Unfortunately, it means that the above pattern is not applicable, as the
 thread spawned by <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code> is not known to the registry, and so if it were
 to try to use the registry, the registry would throw an error (even though
 this pattern is actually safe). This situation is not ideal, but for now we
 merely provide an alternative to <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:withAsync" title="Ouroboros.Consensus.Util.IOLike">withAsync</a></code> that <em>does</em> register the thread
 with the registry.</p><p>NOTE: Threads that are spawned out of the user's control but that must still
 make use of the registry can use the unsafe API. This should be used with
 caution, however.</p></div></div><div class="top"><p class="src"><a id="v:waitThread" class="def">waitThread</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m a <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#waitThread" class="link">Source</a> <a href="#v:waitThread" class="selflink">#</a></p><div class="doc"><p>Wait for thread to terminate and return its result.</p><p>If the thread throws an exception, this will rethrow that exception.</p><p>NOTE: If A waits on B, and B is linked to the registry, and B throws an
 exception, then A might <em>either</em> receive the exception thrown by B <em>or</em>
 the <code>ThreadKilled</code> exception thrown by the registry.</p></div></div><div class="top"><p class="src"><a id="v:waitAnyThread" class="def">waitAnyThread</a> &#8759; &#8704; m a. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; [<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a] &#8594; m a <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#waitAnyThread" class="link">Source</a> <a href="#v:waitAnyThread" class="selflink">#</a></p><div class="doc"><p>Lift <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:waitAny" title="Ouroboros.Consensus.Util.IOLike">waitAny</a></code> to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a></code></p></div></div><div class="top"><p class="src"><a id="v:linkToRegistry" class="def">linkToRegistry</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a &#8594; m () <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#linkToRegistry" class="link">Source</a> <a href="#v:linkToRegistry" class="selflink">#</a></p><div class="doc"><p>Link specified <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a></code> to the (thread that created) the registry</p></div></div><div class="top"><p class="src"><a id="v:forkLinkedThread" class="def">forkLinkedThread</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m a &#8594; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:Thread" title="Ouroboros.Consensus.Util.ResourceRegistry">Thread</a> m a) <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#forkLinkedThread" class="link">Source</a> <a href="#v:forkLinkedThread" class="selflink">#</a></p><div class="doc"><p>Fork a thread and link to it to the registry.</p><p>This function is just a convenience.</p></div></div><a href="#g:4" id="g:4"><h1>Temporary registry</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:WithTempRegistry" class="def">WithTempRegistry</a> st m a <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></p><div class="doc"><p>An action with a temporary registry in scope, see <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code>
 for more details.</p><p>The most important function to run in this monad is <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:allocateTemp" title="Ouroboros.Consensus.Util.ResourceRegistry">allocateTemp</a></code>.</p></div><div class="subs instances"><details id="i:WithTempRegistry" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:MonadState:1"></span> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-Base.html#t:MonadState" title="Cardano.Prelude.Base">MonadState</a> s m &#8658; <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/Cardano-Prelude-Base.html#t:MonadState" title="Cardano.Prelude.Base">MonadState</a> s (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-705" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:MonadState:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:get">get</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m s <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/mtl-2.2.2/src" class="link">Source</a> <a href="#v:get" class="selflink">#</a></p><p class="src"><a href="#v:put">put</a> &#8759; s &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m () <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/mtl-2.2.2/src" class="link">Source</a> <a href="#v:put" class="selflink">#</a></p><p class="src"><a href="#v:state">state</a> &#8759; (s &#8594; (a, s)) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/mtl-2.2.2/src" class="link">Source</a> <a href="#v:state" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:MonadTrans:2"></span> <a href="file:///home/coot/.cabal/store/ghc-8.6.5/mmorph-1.1.3-f950ab0585316f22c52d29c0f48156be51c5ee6af170ae24cbb38a58cfaf7cd5/share/doc/html/Control-Monad-Morph.html#t:MonadTrans" title="Control.Monad.Morph">MonadTrans</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-702" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:MonadTrans:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:lift">lift</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m &#8658; m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/transformers-0.5.6.2/src" class="link">Source</a> <a href="#v:lift" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:Monad:3"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> m &#8658; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Control-Monad.html#t:Monad" title="Control.Monad">Monad</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:Monad:3"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-62--62--61-">(&gt;&gt;=)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:-62--62--61-" class="selflink">#</a></p><p class="src"><a href="#v:-62--62-">(&gt;&gt;)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:-62--62-" class="selflink">#</a></p><p class="src"><a href="#v:return">return</a> &#8759; a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:return" class="selflink">#</a></p><p class="src"><a href="#v:fail">fail</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:fail" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:Functor:4"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Functor.html#t:Functor" title="Data.Functor">Functor</a> m &#8658; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Functor.html#t:Functor" title="Data.Functor">Functor</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:Functor:4"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:fmap">fmap</a> &#8759; (a &#8594; b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:fmap" class="selflink">#</a></p><p class="src"><a href="#v:-60--36-">(&lt;$)</a> &#8759; a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:-60--36-" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:Applicative:5"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Control-Applicative.html#t:Applicative" title="Control.Applicative">Applicative</a> m &#8658; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Control-Applicative.html#t:Applicative" title="Control.Applicative">Applicative</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:Applicative:5"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:pure">pure</a> &#8759; a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:pure" class="selflink">#</a></p><p class="src"><a href="#v:-60--42--62-">(&lt;*&gt;)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (a &#8594; b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:-60--42--62-" class="selflink">#</a></p><p class="src"><a href="#v:liftA2">liftA2</a> &#8759; (a &#8594; b &#8594; c) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:liftA2" class="selflink">#</a></p><p class="src"><a href="#v:-42--62-">(*&gt;)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:-42--62-" class="selflink">#</a></p><p class="src"><a href="#v:-60--42-">(&lt;*)</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:-60--42-" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:MonadThrow:6"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:MonadThrow" title="Ouroboros.Consensus.Util.IOLike">MonadThrow</a> m &#8658; <a href="Ouroboros-Consensus-Util-IOLike.html#t:MonadThrow" title="Ouroboros.Consensus.Util.IOLike">MonadThrow</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:MonadThrow:6"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:throwM">throwM</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; e &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:throwM" class="selflink">#</a></p><p class="src"><a href="#v:bracket">bracket</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b) &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:bracket" class="selflink">#</a></p><p class="src"><a href="#v:bracket_">bracket_</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:bracket_" class="selflink">#</a></p><p class="src"><a href="#v:finally">finally</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:finally" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:MonadCatch:7"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:MonadCatch" title="Ouroboros.Consensus.Util.IOLike">MonadCatch</a> m &#8658; <a href="Ouroboros-Consensus-Util-IOLike.html#t:MonadCatch" title="Ouroboros.Consensus.Util.IOLike">MonadCatch</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:MonadCatch:7"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:catch">catch</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; (e &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:catch" class="selflink">#</a></p><p class="src"><a href="#v:catchJust">catchJust</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; (e &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; (b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:catchJust" class="selflink">#</a></p><p class="src"><a href="#v:try">try</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> e a) <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:try" class="selflink">#</a></p><p class="src"><a href="#v:tryJust">tryJust</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; (e &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (<a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Either.html#t:Either" title="Data.Either">Either</a> b a) <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:tryJust" class="selflink">#</a></p><p class="src"><a href="#v:handle">handle</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; (e &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:handle" class="selflink">#</a></p><p class="src"><a href="#v:handleJust">handleJust</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> e &#8658; (e &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> b) &#8594; (b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:handleJust" class="selflink">#</a></p><p class="src"><a href="#v:onException">onException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:onException" class="selflink">#</a></p><p class="src"><a href="#v:bracketOnError">bracketOnError</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b) &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:bracketOnError" class="selflink">#</a></p><p class="src"><a href="#v:generalBracket">generalBracket</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ExitCase" title="Ouroboros.Consensus.Util.IOLike">ExitCase</a> b &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m c) &#8594; (a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (b, c) <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:generalBracket" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:MonadMask:8"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:MonadMask" title="Ouroboros.Consensus.Util.IOLike">MonadMask</a> m &#8658; <a href="Ouroboros-Consensus-Util-IOLike.html#t:MonadMask" title="Ouroboros.Consensus.Util.IOLike">MonadMask</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:MonadMask:8"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:mask">mask</a> &#8759; ((&#8704; a. <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:mask" class="selflink">#</a></p><p class="src"><a href="#v:uninterruptibleMask">uninterruptibleMask</a> &#8759; ((&#8704; a. <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b) &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m b <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:uninterruptibleMask" class="selflink">#</a></p><p class="src"><a href="#v:mask_">mask_</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:mask_" class="selflink">#</a></p><p class="src"><a href="#v:uninterruptibleMask_">uninterruptibleMask_</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:uninterruptibleMask_" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:MonadSTM:9"></span> <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:MonadSTM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">MonadSTM</a> m &#8658; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:MonadSTM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">MonadSTM</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:MonadSTM:9"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs associated-types"><p class="caption">Associated Types</p><p class="src"><span class="keyword">type</span> <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:STM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">STM</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Kind.html#t:Type" title="Data.Kind">Type</a> <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#t:STM" class="selflink">#</a></p></div> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:atomically">atomically</a> &#8759; <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a> &#8658; <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:STM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">STM</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:atomically" class="selflink">#</a></p><p class="src"><a href="#v:newTVarM">newTVarM</a> &#8759; a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (<a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/Control-Monad-Class-MonadSTM.html#t:TVar" title="Control.Monad.Class.MonadSTM">TVar</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) a) <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:newTVarM" class="selflink">#</a></p><p class="src"><a href="#v:newTMVarM">newTMVarM</a> &#8759; a &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (<a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/Control-Monad-Class-MonadSTM.html#t:TMVar" title="Control.Monad.Class.MonadSTM">TMVar</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) a) <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:newTMVarM" class="selflink">#</a></p><p class="src"><a href="#v:newEmptyTMVarM">newEmptyTMVarM</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (<a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/Control-Monad-Class-MonadSTM.html#t:TMVar" title="Control.Monad.Class.MonadSTM">TMVar</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) a) <a href="file:///home/coot/clients/iohk/cardano-haskell/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src" class="link">Source</a> <a href="#v:newEmptyTMVarM" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:WithTempRegistry:STM:10"></span> <span class="keyword">type</span> <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:STM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">STM</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-700" class="link">Source</a> <a href="#t:WithTempRegistry" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:WithTempRegistry:STM:10"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="src"><span class="keyword">type</span> <a href="Ouroboros-Consensus-Util-MonadSTM-NormalForm.html#t:STM" title="Ouroboros.Consensus.Util.MonadSTM.NormalForm">STM</a> (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m)</div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:runWithTempRegistry" class="def">runWithTempRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m (a, st) &#8594; m a <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#runWithTempRegistry" class="link">Source</a> <a href="#v:runWithTempRegistry" class="selflink">#</a></p><div class="doc"><p>Run an action with a temporary resource registry.</p><p>When allocating resources that are meant to end up in some final state,
 e.g., stored in a <code>TVar</code>, after which they are guaranteed to be released
 correctly, it is possible that an exception is thrown after allocating such
 a resource, but before it was stored in the final state. In that case, the
 resource would be leaked. <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code> solves that problem.</p><p>When no exception is thrown before the end of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code>, the
 user must have transferred all the resources it allocated to their final
 state. This means that these resources don't have to be released by the
 temporary registry anymore, the final state is now in charge of releasing
 them.</p><p>In case an exception is thrown before the end of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code>,
 <em>all</em> resources allocated in the temporary registry will be released.</p><p>Resources must be allocated using <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:allocateTemp" title="Ouroboros.Consensus.Util.ResourceRegistry">allocateTemp</a></code>.</p><p>To make sure that the user doesn't forget to transfer a resource to the
 final state <code>st</code>, the user must pass a function to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:allocateTemp" title="Ouroboros.Consensus.Util.ResourceRegistry">allocateTemp</a></code> that
 checks whether a given <code>st</code> contains the resource, i.e., whether the
 resource was successfully transferred to its final destination.</p><p>When no exception is thrown before the end of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code>, we
 check whether all allocated resources have been transferred to the final
 state <code>st</code>. If there's a resource that hasn't been transferred to the final
 state <em>and</em> that hasn't be released or closed before (see the release
 function passed to <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:allocateTemp" title="Ouroboros.Consensus.Util.ResourceRegistry">allocateTemp</a></code>), a <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:TempRegistryRemainingResource" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryRemainingResource</a></code>
 exception will be thrown.</p><p>For that reason, <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a></code> is parameterised over the final state
 type <code>st</code> and the given <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a></code> action must return the final
 state.</p><p>NOTE: we explicitly don't let <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code> return the final state,
 because the state <em>must</em> have been stored somewhere safely, transferring
 the resources, before the temporary registry is closed.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:TempRegistryException" class="def">TempRegistryException</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#TempRegistryException" class="link">Source</a> <a href="#t:TempRegistryException" class="selflink">#</a></p><div class="doc"><p>When <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code> exits successfully while there are still
 resources remaining in the temporary registry that haven't been transferred
 to the final state.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a id="v:TempRegistryRemainingResource" class="def">TempRegistryRemainingResource</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:tempRegistryContext" class="def">tempRegistryContext</a> &#8759; !(Context m)</dfn><div class="doc"><p>The context in which the temporary registry was created.</p></div></li><li><dfn class="src"><a id="v:tempRegistryResource" class="def">tempRegistryResource</a> &#8759; !(Context m)</dfn><div class="doc"><p>The context in which the resource was allocated that was not
 transferred to the final state.</p></div></li></ul></div></td></tr></table></div><div class="subs instances"><details id="i:TempRegistryException" open="open"><summary>Instances</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:TempRegistryException:Show:1"></span> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:Show" title="Text.Show">Show</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a></span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-675" class="link">Source</a> <a href="#t:TempRegistryException" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:TempRegistryException:Show:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> &#8759; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a> &#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> &#8759; [<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a>] &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Text-Show.html#t:ShowS" title="Text.Show">ShowS</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:showList" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:TempRegistryException:Exception:2"></span> <a href="Ouroboros-Consensus-Util-IOLike.html#t:Exception" title="Ouroboros.Consensus.Util.IOLike">Exception</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a></span> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#line-676" class="link">Source</a> <a href="#t:TempRegistryException" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:TempRegistryException:Exception:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ouroboros-Consensus-Util-ResourceRegistry.html">Ouroboros.Consensus.Util.ResourceRegistry</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:toException">toException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a> &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:SomeException" title="Ouroboros.Consensus.Util.IOLike">SomeException</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:toException" class="selflink">#</a></p><p class="src"><a href="#v:fromException">fromException</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:SomeException" title="Ouroboros.Consensus.Util.IOLike">SomeException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/GHC-Maybe.html#t:Maybe" title="GHC.Maybe">Maybe</a> <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:fromException" class="selflink">#</a></p><p class="src"><a href="#v:displayException">displayException</a> &#8759; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:TempRegistryException" title="Ouroboros.Consensus.Util.ResourceRegistry">TempRegistryException</a> &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-String.html#t:String" title="Data.String">String</a> <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/src" class="link">Source</a> <a href="#v:displayException" class="selflink">#</a></p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:allocateTemp" class="def">allocateTemp</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#allocateTemp" class="link">Source</a> <a href="#v:allocateTemp" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; m a</td><td class="doc"><p>Allocate the resource</p></td></tr><tr><td class="src">&#8594; (a &#8594; m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a>)</td><td class="doc"><p>Release the resource, return <code><a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:True" title="Data.Bool">True</a></code> when the resource was actually
 released, return <code><a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:False" title="Data.Bool">False</a></code> when the resource was already released.</p><p>Note that it is safe to always return <code><a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#v:True" title="Data.Bool">True</a></code> when unsure.</p></td></tr><tr><td class="src">&#8594; (st &#8594; a &#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a>)</td><td class="doc"><p>Check whether the resource is in the given state</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m a</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Allocate a resource in a temporary registry until it has been transferred
 to the final state <code>st</code>. See <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code> for more details.</p></div></div><div class="top"><p class="src"><a id="v:modifyWithTempRegistry" class="def">modifyWithTempRegistry</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#modifyWithTempRegistry" class="link">Source</a> <a href="#v:modifyWithTempRegistry" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; m st</td><td class="doc"><p>Get the state</p></td></tr><tr><td class="src">&#8594; (st &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:ExitCase" title="Ouroboros.Consensus.Util.IOLike">ExitCase</a> st &#8594; m ())</td><td class="doc"><p>Store the new state</p></td></tr><tr><td class="src">&#8594; <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/mtl-2.2.2/Control-Monad-State-Strict.html#t:StateT" title="Control.Monad.State.Strict">StateT</a> st (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:WithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">WithTempRegistry</a> st m) a</td><td class="doc"><p>Modify the state</p></td></tr><tr><td class="src">&#8594; m a</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Higher level API on top of <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:runWithTempRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">runWithTempRegistry</a></code>: modify the given <code>st</code>,
 allocating resources in the process that will be transferred to the
 returned <code>st</code>.</p></div></div><a href="#g:5" id="g:5"><h1>Combinators primarily for testing</h1></a><div class="top"><p class="src"><a id="v:unsafeNewRegistry" class="def">unsafeNewRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; m (<a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m) <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#unsafeNewRegistry" class="link">Source</a> <a href="#v:unsafeNewRegistry" class="selflink">#</a></p><div class="doc"><p>Create a new registry</p><p>You are strongly encouraged to use <code><a href="Ouroboros-Consensus-Util-ResourceRegistry.html#v:withRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">withRegistry</a></code> instead.
 Exported primarily for the benefit of tests.</p></div></div><div class="top"><p class="src"><a id="v:closeRegistry" class="def">closeRegistry</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m () <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#closeRegistry" class="link">Source</a> <a href="#v:closeRegistry" class="selflink">#</a></p><div class="doc"><p>Close the registry</p><p>This can only be called from the same thread that created the registry.
 This is a no-op if the registry is already closed.</p><p>This entire function runs with exceptions masked, so that we are not
 interrupted while we release all resources.</p><p>Resources will be allocated from young to old, so that resources allocated
 later can safely refer to resources created earlier.</p><p>The release functions are run in the scope of an exception handler, so that
 if releasing one resource throws an exception, we still attempt to release
 the other resources. Should we catch an exception whilst we close the
 registry, we will rethrow it after having attempted to release all resources.
 If there is more than one, we will pick a random one to rethrow, though we
 will prioritize asynchronous exceptions over other exceptions. This may be
 important for exception handlers that catch all-except-asynchronous
 exceptions.</p></div></div><div class="top"><p class="src"><a id="v:countResources" class="def">countResources</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Util-ResourceRegistry.html#t:ResourceRegistry" title="Ouroboros.Consensus.Util.ResourceRegistry">ResourceRegistry</a> m &#8594; m <a href="file:///home/coot/.ghcup/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Int.html#t:Int" title="Data.Int">Int</a> <a href="src/Ouroboros.Consensus.Util.ResourceRegistry.html#countResources" class="link">Source</a> <a href="#v:countResources" class="selflink">#</a></p><div class="doc"><p>Number of currently allocated resources</p><p>Primarily for the benefit of testing.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>