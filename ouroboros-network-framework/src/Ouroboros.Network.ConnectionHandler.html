<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns              #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds                 #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts          #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE GADTs                     #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures            #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase                #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns            #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables       #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving        #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications          #-}</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-comment">-- | Implementation of 'ConnectionHandler'</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- While connection manager responsibility is to keep track of resources:</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- sockets and threads running connection and their state changes (including</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- changes imposed by 'ConnectionHandler', e.g. weather a uni- or duplex- data</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- flow was negotiated), the responsibility of 'ConnectionHandler' is to:</span><span>
</span><span id="line-20"></span><span class="hs-comment">--</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- * run handshake protocol on the underlying bearer</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- * start mux</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- 'ConnectionHandler' is run on each inbound or outbound connection and returns</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- 'Handle'.  Upon successful handshake negotiation it returns all the</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- necessary information to run mini-protocols.  Note that it is not responsible</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- for running them: that's what a server does or p2p-governor by means of</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- 'PeerStateActions'.</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.ConnectionHandler</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier">Handle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier">HandleError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier">classifyHandleError</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#MuxConnectionHandler"><span class="hs-identifier">MuxConnectionHandler</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#makeConnectionHandler"><span class="hs-identifier">makeConnectionHandler</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#MuxConnectionManager"><span class="hs-identifier">MuxConnectionManager</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-comment">-- * tracing</span></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#ConnectionHandlerTrace"><span class="hs-identifier">ConnectionHandlerTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">SomeAsyncException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier">Control.Monad.Class.MonadSTM.Strict</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Typeable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">Network.Mux</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">miniProtocolNum</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html"><span class="hs-identifier">Ouroboros.Network.ConnectionId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier">ConnectionId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Types</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Mux.html"><span class="hs-identifier">Ouroboros.Network.Mux</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html"><span class="hs-identifier">Ouroboros.Network.MuxMode</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.RethrowPolicy.html"><span class="hs-identifier">Ouroboros.Network.RethrowPolicy</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">-- | We place an upper limit of `30s` on the time we wait on receiving an SDU.</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- There is no upper bound on the time we wait when waiting for a new SDU.</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- This makes it possible for mini-protocols to use timeouts that are larger</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- than 30s or wait forever.  `30s` for receiving an SDU corresponds to</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- a minimum speed limit of 17kbps.</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- ( 8      -- mux header length</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- + 0xffff -- maximum SDU payload</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- )</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- * 8</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- = 524_344 -- maximum bits in an SDU</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-comment">--  524_344 / 30 / 1024 = 17kbps</span><span>
</span><span id="line-75"></span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#sduTimeout"><span class="hs-identifier hs-type">sduTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-77"></span><span id="sduTimeout"><span class="annot"><span class="annottext">sduTimeout :: DiffTime
</span><a href="Ouroboros.Network.ConnectionHandler.html#sduTimeout"><span class="hs-identifier hs-var hs-var">sduTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">30</span></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | For handshake, we put a limit of `10s` for sending or receiving a single</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- `MuxSDU`.</span><span>
</span><span id="line-82"></span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#sduHandshakeTimeout"><span class="hs-identifier hs-type">sduHandshakeTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-84"></span><span id="sduHandshakeTimeout"><span class="annot"><span class="annottext">sduHandshakeTimeout :: DiffTime
</span><a href="Ouroboros.Network.ConnectionHandler.html#sduHandshakeTimeout"><span class="hs-identifier hs-var hs-var">sduHandshakeTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">10</span></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- | States of the connection handler thread.</span><span>
</span><span id="line-88"></span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- * 'MuxRunning' - successful Handshake, mux started</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- * 'HandleHandshakeClientError'</span><span>
</span><span id="line-91"></span><span class="hs-comment">--                - the connection handler thread was running client side</span><span>
</span><span id="line-92"></span><span class="hs-comment">--                of the handshake negotiation, which failed with</span><span>
</span><span id="line-93"></span><span class="hs-comment">--                a 'HandshakeException'</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- * 'HandleHandshakeServerError'</span><span>
</span><span id="line-95"></span><span class="hs-comment">--                - the connection handler thread was running server side of the</span><span>
</span><span id="line-96"></span><span class="hs-comment">--                handshake protocol, which fail with 'HandshakeException'</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- * 'HandleError'</span><span>
</span><span id="line-98"></span><span class="hs-comment">--                - the multiplexer thrown 'MuxError'.</span><span>
</span><span id="line-99"></span><span class="hs-comment">--</span><span>
</span><span id="line-100"></span><span class="hs-keyword">data</span><span> </span><span id="Handle"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-var">Handle</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177245"><span class="annot"><a href="#local-6989586621679177245"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MuxMode</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679177240"><span class="annot"><a href="#local-6989586621679177240"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679177243"><span class="annot"><a href="#local-6989586621679177243"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679177244"><span class="annot"><a href="#local-6989586621679177244"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679177242"><span class="annot"><a href="#local-6989586621679177242"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679177241"><span class="annot"><a href="#local-6989586621679177241"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-101"></span><span>    </span><span id="Handle"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-var">Handle</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-102"></span><span>        </span><span id="hMux"><span class="annot"><span class="annottext">Handle muxMode peerAddr bytes m a b -&gt; Mux muxMode m
</span><a href="Ouroboros.Network.ConnectionHandler.html#hMux"><span class="hs-identifier hs-var hs-var">hMux</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">Mux</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177245"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177244"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>        </span><span id="hMuxBundle"><span class="annot"><span class="annottext">Handle muxMode peerAddr bytes m a b
-&gt; MuxBundle muxMode bytes m a b
</span><a href="Ouroboros.Network.ConnectionHandler.html#hMuxBundle"><span class="hs-identifier hs-var hs-var">hMuxBundle</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Mux.html#MuxBundle"><span class="hs-identifier hs-type">MuxBundle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177245"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177243"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177244"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177242"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177241"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>        </span><span id="hControlMessage"><span class="annot"><span class="annottext">Handle muxMode peerAddr bytes m a b
-&gt; Bundle (StrictTVar m ControlMessage)
</span><a href="Ouroboros.Network.ConnectionHandler.html#hControlMessage"><span class="hs-identifier hs-var hs-var">hControlMessage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Mux.html#Bundle"><span class="hs-identifier hs-type">Bundle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177244"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Mux.html#ControlMessage"><span class="hs-identifier hs-type">ControlMessage</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">data</span><span> </span><span id="HandleError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-var">HandleError</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177212"><span class="annot"><a href="#local-6989586621679177212"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MuxMode</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679177211"><span class="annot"><a href="#local-6989586621679177211"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621679177279"><span id="local-6989586621679177280"><span id="HandleHandshakeClientError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeClientError"><span class="hs-identifier hs-var">HandleHandshakeClientError</span></a></span></span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">HasInitiator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177280"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">True</span></a></span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeException"><span class="hs-identifier hs-type">HandshakeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177279"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177280"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177279"><span class="hs-identifier hs-type">versionNumber</span></a></span></span></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621679177228"><span id="local-6989586621679177229"><span id="HandleHandshakeServerError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeServerError"><span class="hs-identifier hs-var">HandleHandshakeServerError</span></a></span></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">HasResponder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177229"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">True</span></a></span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeException"><span class="hs-identifier hs-type">HandshakeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177228"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177229"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177228"><span class="hs-identifier hs-type">versionNumber</span></a></span></span></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621679177281"><span id="local-6989586621679177282"><span id="HandleError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-var">HandleError</span></a></span></span><span>
</span><span id="line-120"></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-121"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177282"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177281"><span class="hs-identifier hs-type">versionNumber</span></a></span></span></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span id="local-6989586621679177206"><span id="local-6989586621679177207"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679177201"><span id="local-6989586621679177204"><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177207"><span class="hs-identifier hs-type">versionNumber</span></a></span><span>
</span><span id="line-124"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177206"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177207"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679177199"><span class="annot"><span class="annottext">show :: HandleError muxMode versionNumber -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeServerError"><span class="hs-identifier hs-type">HandleHandshakeServerError</span></a></span><span> </span><span id="local-6989586621679177197"><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177197"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HandleHandshakeServerError &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177197"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeClientError"><span class="hs-identifier hs-type">HandleHandshakeClientError</span></a></span><span> </span><span id="local-6989586621679177196"><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177196"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HandleHandshakeClientError &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177196"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span id="local-6989586621679177195"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177195"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;HandleError &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177195"><span class="hs-identifier hs-var">err</span></a></span></span></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span id="local-6989586621679177193"><span id="local-6989586621679177194"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier hs-type">classifyHandleError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177194"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177193"><span class="hs-identifier hs-type">versionNumber</span></a></span><span>
</span><span id="line-131"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#HandleErrorType"><span class="hs-identifier hs-type">HandleErrorType</span></a></span></span></span><span>
</span><span id="line-132"></span><span id="classifyHandleError"><span class="annot"><span class="annottext">classifyHandleError :: HandleError muxMode versionNumber -&gt; HandleErrorType
</span><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier hs-var hs-var">classifyHandleError</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeClientError"><span class="hs-identifier hs-type">HandleHandshakeClientError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeProtocolLimit"><span class="hs-identifier hs-type">HandshakeProtocolLimit</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolLimitFailure
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeProtocolViolation"><span class="hs-identifier hs-var">HandshakeProtocolViolation</span></a></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- TODO: 'HandshakeProtocolError' is not a protocol error! It is just</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- a negotiation failure.  It should be renamed.</span><span>
</span><span id="line-136"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier hs-var">classifyHandleError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeClientError"><span class="hs-identifier hs-type">HandleHandshakeClientError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeProtocolError"><span class="hs-identifier hs-type">HandshakeProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeProtocolError versionNumber
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span>
</span><span id="line-138"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier hs-var">classifyHandleError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeServerError"><span class="hs-identifier hs-type">HandleHandshakeServerError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeProtocolLimit"><span class="hs-identifier hs-type">HandshakeProtocolLimit</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolLimitFailure
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeProtocolViolation"><span class="hs-identifier hs-var">HandshakeProtocolViolation</span></a></span><span>
</span><span id="line-140"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier hs-var">classifyHandleError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeServerError"><span class="hs-identifier hs-type">HandleHandshakeServerError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeProtocolError"><span class="hs-identifier hs-type">HandshakeProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeProtocolError versionNumber
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- any other exception, e.g. MuxError \/ IOError, codec errors, etc.</span><span>
</span><span id="line-143"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#classifyHandleError"><span class="hs-identifier hs-var">classifyHandleError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><span class="annottext">HandleErrorType
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#HandshakeProtocolViolation"><span class="hs-identifier hs-var">HandshakeProtocolViolation</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-comment">-- | Type of 'ConnectionHandler' implemented in this module.</span><span>
</span><span id="line-148"></span><span class="hs-comment">--</span><span>
</span><span id="line-149"></span><span class="hs-keyword">type</span><span> </span><span id="MuxConnectionHandler"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#MuxConnectionHandler"><span class="hs-identifier hs-var">MuxConnectionHandler</span></a></span></span><span> </span><span id="local-6989586621679177188"><span class="annot"><a href="#local-6989586621679177188"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span id="local-6989586621679177187"><span class="annot"><a href="#local-6989586621679177187"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679177186"><span class="annot"><a href="#local-6989586621679177186"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679177185"><span class="annot"><a href="#local-6989586621679177185"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span id="local-6989586621679177184"><span class="annot"><a href="#local-6989586621679177184"><span class="hs-identifier hs-type">versionData</span></a></span></span><span> </span><span id="local-6989586621679177183"><span class="annot"><a href="#local-6989586621679177183"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679177182"><span class="annot"><a href="#local-6989586621679177182"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679177181"><span class="annot"><a href="#local-6989586621679177181"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679177180"><span class="annot"><a href="#local-6989586621679177180"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandler"><span class="hs-identifier hs-type">ConnectionHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177188"><span class="hs-identifier hs-type">muxMode</span></a></span><span>
</span><span id="line-151"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#ConnectionHandlerTrace"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177185"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177184"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>                      </span><span class="annot"><a href="#local-6989586621679177187"><span class="hs-identifier hs-type">socket</span></a></span><span>
</span><span id="line-153"></span><span>                      </span><span class="annot"><a href="#local-6989586621679177186"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-154"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177188"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177186"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177183"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177182"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177181"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177180"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177188"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177185"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679177185"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679177184"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>                      </span><span class="annot"><a href="#local-6989586621679177182"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | Type alias for 'ConnectionManager' using 'Handle'.</span><span>
</span><span id="line-160"></span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span class="hs-keyword">type</span><span> </span><span id="MuxConnectionManager"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#MuxConnectionManager"><span class="hs-identifier hs-var">MuxConnectionManager</span></a></span></span><span> </span><span id="local-6989586621679177179"><span class="annot"><a href="#local-6989586621679177179"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span id="local-6989586621679177178"><span class="annot"><a href="#local-6989586621679177178"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679177177"><span class="annot"><a href="#local-6989586621679177177"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679177176"><span class="annot"><a href="#local-6989586621679177176"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span id="local-6989586621679177175"><span class="annot"><a href="#local-6989586621679177175"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679177174"><span class="annot"><a href="#local-6989586621679177174"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679177173"><span class="annot"><a href="#local-6989586621679177173"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679177172"><span class="annot"><a href="#local-6989586621679177172"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionManager"><span class="hs-identifier hs-type">ConnectionManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177179"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177178"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177177"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-163"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177179"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177177"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177175"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177174"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177173"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177172"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177179"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177176"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>                      </span><span class="annot"><a href="#local-6989586621679177174"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="hs-comment">-- | To be used as `makeConnectionHandler` field of 'ConnectionManagerArguments'.</span><span>
</span><span id="line-168"></span><span class="hs-comment">--</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- Note: We need to pass `MiniProtocolBundle` what forces us to have two</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- different `ConnectionManager`s: one for `node-to-client` and another for</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- `node-to-node` connections.  But this is ok, as these resources are</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- independent.</span><span>
</span><span id="line-173"></span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#makeConnectionHandler"><span class="hs-identifier hs-type">makeConnectionHandler</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679177170"><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679177169"><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span id="local-6989586621679177168"><span class="annot"><a href="#local-6989586621679177168"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679177167"><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span id="local-6989586621679177166"><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span></span><span> </span><span id="local-6989586621679177165"><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679177164"><span class="annot"><a href="#local-6989586621679177164"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679177163"><span class="annot"><a href="#local-6989586621679177163"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-176"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadAsync</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-177"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadCatch</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-178"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadFork</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-179"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadLabelledSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-180"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadTime</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-182"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadTimer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-183"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadMask</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-184"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span>
</span><span id="line-185"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span>     </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-186"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-187"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">WithMuxBearer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">MuxTrace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.MuxMode.html#SingMuxMode"><span class="hs-identifier hs-type">SingMuxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- ^ describe whether this is outbound or inbound connection, and bring</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">-- evidence that we can use mux with it.</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeArguments"><span class="hs-identifier hs-type">HandshakeArguments</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.Version.html#Versions"><span class="hs-identifier hs-type">Versions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span>
</span><span id="line-194"></span><span>                </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Mux.html#OuroborosBundle"><span class="hs-identifier hs-type">OuroborosBundle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177164"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177163"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">ThreadId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.RethrowPolicy.html#RethrowPolicy"><span class="hs-identifier hs-type">RethrowPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- ^ 'ThreadId' and rethrow policy.  Rethrow policy might throw an async</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">-- exception to that thread, when trying to terminate the process.</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#MuxConnectionHandler"><span class="hs-identifier hs-type">MuxConnectionHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177168"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177164"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177163"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-199"></span><span id="makeConnectionHandler"><span class="annot"><span class="annottext">makeConnectionHandler :: Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; SingMuxMode muxMode
-&gt; HandshakeArguments
     (ConnectionId peerAddr) versionNumber versionData m
-&gt; Versions
     versionNumber
     versionData
     (OuroborosBundle muxMode peerAddr ByteString m a b)
-&gt; (ThreadId m, RethrowPolicy)
-&gt; MuxConnectionHandler
     muxMode socket peerAddr versionNumber versionData ByteString m a b
</span><a href="Ouroboros.Network.ConnectionHandler.html#makeConnectionHandler"><span class="hs-identifier hs-var hs-var">makeConnectionHandler</span></a></span></span><span> </span><span id="local-6989586621679177162"><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="#local-6989586621679177162"><span class="hs-identifier hs-var">muxTracer</span></a></span></span><span> </span><span id="local-6989586621679177161"><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="#local-6989586621679177161"><span class="hs-identifier hs-var">singMuxMode</span></a></span></span><span>
</span><span id="line-200"></span><span>                      </span><span id="local-6989586621679177160"><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId peerAddr) versionNumber versionData m
</span><a href="#local-6989586621679177160"><span class="hs-identifier hs-var">handshakeArguments</span></a></span></span><span>
</span><span id="line-201"></span><span>                      </span><span id="local-6989586621679177159"><span class="annot"><span class="annottext">Versions
  versionNumber
  versionData
  (OuroborosBundle muxMode peerAddr ByteString m a b)
</span><a href="#local-6989586621679177159"><span class="hs-identifier hs-var">versionedApplication</span></a></span></span><span>
</span><span id="line-202"></span><span>                      </span><span class="hs-special">(</span><span id="local-6989586621679177158"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679177158"><span class="hs-identifier hs-var">mainThreadId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177157"><span class="annot"><span class="annottext">RethrowPolicy
</span><a href="#local-6989586621679177157"><span class="hs-identifier hs-var">rethrowPolicy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">ConnectionHandler :: forall (muxMode :: MuxMode) handlerTrace socket peerAddr handle
       handleError version (m :: * -&gt; *).
WithMuxTuple
  muxMode
  (ConnectionHandlerFn
     handlerTrace socket peerAddr handle handleError version m)
-&gt; ConnectionHandler
     muxMode handlerTrace socket peerAddr handle handleError version m
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandler"><span class="hs-identifier hs-type">ConnectionHandler</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">connectionHandler :: WithMuxTuple
  muxMode
  (ConnectionHandlerFn
     (ConnectionHandlerTrace versionNumber versionData)
     socket
     peerAddr
     (Handle muxMode peerAddr ByteString m a b)
     (HandleError muxMode versionNumber)
     (versionNumber, versionData)
     m)
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#connectionHandler"><span class="hs-identifier hs-var">connectionHandler</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-205"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="#local-6989586621679177161"><span class="hs-identifier hs-var">singMuxMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-206"></span><span>            </span><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="Ouroboros.Network.MuxMode.html#SingInitiatorMode"><span class="hs-identifier hs-var">SingInitiatorMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>              </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
-&gt; WithMuxMode
     'InitiatorMode
     (ConnectionHandlerFn
        (ConnectionHandlerTrace versionNumber versionData)
        socket
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber)
        (versionNumber, versionData)
        m)
     (ConnectionHandlerFn
        (ConnectionHandlerTrace versionNumber versionData)
        socket
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber)
        (versionNumber, versionData)
        m)
forall a b. a -&gt; WithMuxMode 'InitiatorMode a b
</span><a href="Ouroboros.Network.MuxMode.html#WithInitiatorMode"><span class="hs-identifier hs-var">WithInitiatorMode</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
(HasInitiator muxMode ~ 'True) =&gt;
ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
</span><a href="#local-6989586621679177152"><span class="hs-identifier hs-var">outboundConnectionHandler</span></a></span><span>
</span><span id="line-208"></span><span>            </span><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="Ouroboros.Network.MuxMode.html#SingResponderMode"><span class="hs-identifier hs-var">SingResponderMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>              </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
-&gt; WithMuxMode
     'ResponderMode
     (ConnectionHandlerFn
        (ConnectionHandlerTrace versionNumber versionData)
        socket
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber)
        (versionNumber, versionData)
        m)
     (ConnectionHandlerFn
        (ConnectionHandlerTrace versionNumber versionData)
        socket
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber)
        (versionNumber, versionData)
        m)
forall b a. b -&gt; WithMuxMode 'ResponderMode a b
</span><a href="Ouroboros.Network.MuxMode.html#WithResponderMode"><span class="hs-identifier hs-var">WithResponderMode</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
(HasResponder muxMode ~ 'True) =&gt;
ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
</span><a href="#local-6989586621679177149"><span class="hs-identifier hs-var">inboundConnectionHandler</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="Ouroboros.Network.MuxMode.html#SingInitiatorResponderMode"><span class="hs-identifier hs-var">SingInitiatorResponderMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>              </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
-&gt; ConnectionHandlerFn
     (ConnectionHandlerTrace versionNumber versionData)
     socket
     peerAddr
     (Handle muxMode peerAddr ByteString m a b)
     (HandleError muxMode versionNumber)
     (versionNumber, versionData)
     m
-&gt; WithMuxMode
     'InitiatorResponderMode
     (ConnectionHandlerFn
        (ConnectionHandlerTrace versionNumber versionData)
        socket
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber)
        (versionNumber, versionData)
        m)
     (ConnectionHandlerFn
        (ConnectionHandlerTrace versionNumber versionData)
        socket
        peerAddr
        (Handle muxMode peerAddr ByteString m a b)
        (HandleError muxMode versionNumber)
        (versionNumber, versionData)
        m)
forall a b. a -&gt; b -&gt; WithMuxMode 'InitiatorResponderMode a b
</span><a href="Ouroboros.Network.MuxMode.html#WithInitiatorResponderMode"><span class="hs-identifier hs-var">WithInitiatorResponderMode</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
(HasInitiator muxMode ~ 'True) =&gt;
ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
</span><a href="#local-6989586621679177152"><span class="hs-identifier hs-var">outboundConnectionHandler</span></a></span><span>
</span><span id="line-212"></span><span>                                         </span><span class="annot"><span class="annottext">ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
(HasResponder muxMode ~ 'True) =&gt;
ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
</span><a href="#local-6989586621679177149"><span class="hs-identifier hs-var">inboundConnectionHandler</span></a></span><span>
</span><span id="line-213"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-comment">-- install classify exception handler</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><a href="#local-6989586621679177146"><span class="hs-identifier hs-type">classifyExceptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679177304"><span class="annot"><a href="#local-6989586621679177304"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-217"></span><span>                          </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#ConnectionHandlerTrace"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-219"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.RethrowPolicy.html#ErrorContext"><span class="hs-identifier hs-type">ErrorContext</span></a></span><span>
</span><span id="line-220"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177304"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177304"><span class="hs-identifier hs-type">x</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span id="local-6989586621679177146"><span class="annot"><span class="annottext">classifyExceptions :: Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; peerAddr -&gt; ErrorContext -&gt; m x -&gt; m x
</span><a href="#local-6989586621679177146"><span class="hs-identifier hs-var hs-var">classifyExceptions</span></a></span></span><span> </span><span id="local-6989586621679177145"><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177145"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679177144"><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177144"><span class="hs-identifier hs-var">remoteAddress</span></a></span></span><span> </span><span id="local-6989586621679177143"><span class="annot"><span class="annottext">ErrorContext
</span><a href="#local-6989586621679177143"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679177142"><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679177142"><span class="hs-identifier hs-var">io</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-comment">-- handle non-async exceptions</span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">(SomeException -&gt; Maybe SomeException)
-&gt; m x -&gt; (SomeException -&gt; m x) -&gt; m x
forall (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b) -&gt; m a -&gt; (b -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">catchJust</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679177140"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177140"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeAsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177140"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">SomeAsyncException</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-225"></span><span>                </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">SomeAsyncException
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-226"></span><span>                </span><span class="annot"><span class="annottext">Maybe SomeAsyncException
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeException
forall a. a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177140"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="annottext">m x
</span><a href="#local-6989586621679177142"><span class="hs-identifier hs-var">io</span></a></span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">((SomeException -&gt; m x) -&gt; m x) -&gt; (SomeException -&gt; m x) -&gt; m x
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679177138"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177138"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177137"><span class="annot"><span class="annottext">cmd :: ErrorCommand
</span><a href="#local-6989586621679177137"><span class="hs-identifier hs-var hs-var">cmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RethrowPolicy -&gt; RethrowPolicy_
</span><a href="Ouroboros.Network.RethrowPolicy.html#runRethrowPolicy"><span class="hs-identifier hs-var hs-var">runRethrowPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">RethrowPolicy
</span><a href="#local-6989586621679177157"><span class="hs-identifier hs-var">rethrowPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorContext
</span><a href="#local-6989586621679177143"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177138"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-230"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; ConnectionHandlerTrace versionNumber versionData -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177145"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorContext
-&gt; SomeException
-&gt; ErrorCommand
-&gt; ConnectionHandlerTrace versionNumber versionData
forall versionNumber versionData.
ErrorContext
-&gt; SomeException
-&gt; ErrorCommand
-&gt; ConnectionHandlerTrace versionNumber versionData
</span><a href="Ouroboros.Network.ConnectionHandler.html#TrError"><span class="hs-identifier hs-var">TrError</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorContext
</span><a href="#local-6989586621679177143"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177138"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCommand
</span><a href="#local-6989586621679177137"><span class="hs-identifier hs-var">cmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ErrorCommand
</span><a href="#local-6989586621679177137"><span class="hs-identifier hs-var">cmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-232"></span><span>            </span><span class="annot"><span class="annottext">ErrorCommand
</span><a href="Ouroboros.Network.RethrowPolicy.html#ShutdownNode"><span class="hs-identifier hs-var">ShutdownNode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>              </span><span class="annot"><span class="annottext">ThreadId m -&gt; ExceptionInHandler peerAddr -&gt; m ()
forall (m :: * -&gt; *) e.
(MonadFork m, Exception e) =&gt;
ThreadId m -&gt; e -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwTo</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679177158"><span class="hs-identifier hs-var">mainThreadId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peerAddr -&gt; SomeException -&gt; ExceptionInHandler peerAddr
forall peerAddr.
peerAddr -&gt; SomeException -&gt; ExceptionInHandler peerAddr
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#ExceptionInHandler"><span class="hs-identifier hs-var">ExceptionInHandler</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177144"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177138"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>              </span><span class="annot"><span class="annottext">SomeException -&gt; m x
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177138"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-235"></span><span>            </span><span class="annot"><span class="annottext">ErrorCommand
</span><a href="Ouroboros.Network.RethrowPolicy.html#ShutdownPeer"><span class="hs-identifier hs-var">ShutdownPeer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>              </span><span class="annot"><span class="annottext">SomeException -&gt; m x
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177138"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><a href="#local-6989586621679177152"><span class="hs-identifier hs-type">outboundConnectionHandler</span></a></span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">HasInitiator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">True</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandlerFn"><span class="hs-identifier hs-type">ConnectionHandlerFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#ConnectionHandlerTrace"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>                             </span><span class="annot"><a href="#local-6989586621679177168"><span class="hs-identifier hs-type">socket</span></a></span><span>
</span><span id="line-242"></span><span>                             </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-243"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177164"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177163"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>                             </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621679177152"><span class="annot"><span class="annottext">outboundConnectionHandler :: ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
</span><a href="#local-6989586621679177152"><span class="hs-identifier hs-var hs-var">outboundConnectionHandler</span></a></span></span><span> </span><span id="local-6989586621679177129"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679177129"><span class="hs-identifier hs-var">socket</span></a></span></span><span>
</span><span id="line-248"></span><span>                              </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#PromiseWriter"><span class="hs-identifier hs-type">PromiseWriter</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679177127"><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
writePromise :: forall (m :: * -&gt; *) a. PromiseWriter m a -&gt; a -&gt; STM m ()
writePromise :: Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#writePromise"><span class="hs-identifier hs-var hs-var">writePromise</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-249"></span><span>                              </span><span id="local-6989586621679177125"><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177125"><span class="hs-identifier hs-var">tracer</span></a></span></span><span>
</span><span id="line-250"></span><span>                              </span><span id="local-6989586621679177124"><span class="annot"><span class="annottext">connectionId :: ConnectionId peerAddr
</span><a href="#local-6989586621679177124"><span class="hs-identifier hs-var">connectionId</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679177122"><span class="annot"><span class="annottext">peerAddr
localAddress :: forall addr. ConnectionId addr -&gt; addr
localAddress :: peerAddr
</span><a href="Ouroboros.Network.ConnectionId.html#localAddress"><span class="hs-identifier hs-var hs-var">localAddress</span></a></span></span><span>
</span><span id="line-251"></span><span>                                                        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177120"><span class="annot"><span class="annottext">peerAddr
remoteAddress :: forall addr. ConnectionId addr -&gt; addr
remoteAddress :: peerAddr
</span><a href="Ouroboros.Network.ConnectionId.html#remoteAddress"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span><span>                              </span><span id="local-6989586621679177118"><span class="annot"><span class="annottext">DiffTime -&gt; socket -&gt; m (MuxBearer m)
</span><a href="#local-6989586621679177118"><span class="hs-identifier hs-var">mkMuxBearer</span></a></span></span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaskedAction :: forall (m :: * -&gt; *) a.
((forall x. m x -&gt; m x) -&gt; m a) -&gt; MaskedAction m a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#MaskedAction"><span class="hs-identifier hs-type">MaskedAction</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(forall x. m x -&gt; m x) -&gt; m ()
runWithUnmask :: (forall x. m x -&gt; m x) -&gt; m ()
runWithUnmask :: (forall x. m x -&gt; m x) -&gt; m ()
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#runWithUnmask"><span class="hs-identifier hs-var hs-var">runWithUnmask</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-255"></span><span>        </span><span class="annot"><a href="#local-6989586621679177116"><span class="hs-identifier hs-type">runWithUnmask</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679177305"><span class="annot"><a href="#local-6989586621679177305"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177305"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177305"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>        </span><span id="local-6989586621679177116"><span class="annot"><span class="annottext">runWithUnmask :: (forall x. m x -&gt; m x) -&gt; m ()
</span><a href="#local-6989586621679177116"><span class="hs-identifier hs-var hs-var">runWithUnmask</span></a></span></span><span> </span><span id="local-6989586621679177114"><span class="annot"><span class="annottext">forall x. m x -&gt; m x
</span><a href="#local-6989586621679177114"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; peerAddr -&gt; ErrorContext -&gt; m () -&gt; m ()
forall x.
Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; peerAddr -&gt; ErrorContext -&gt; m x -&gt; m x
</span><a href="#local-6989586621679177146"><span class="hs-identifier hs-var">classifyExceptions</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177125"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177120"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorContext
</span><a href="Ouroboros.Network.RethrowPolicy.html#OutboundError"><span class="hs-identifier hs-var">OutboundError</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">labelThisThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;out-conn-hndlr-&quot;</span></span><span>
</span><span id="line-259"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177122"><span class="hs-identifier hs-var">localAddress</span></a></span><span>
</span><span id="line-260"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span>
</span><span id="line-261"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177120"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span>
</span><span id="line-262"></span><span>                                    </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>            </span><span id="local-6989586621679177110"><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177110"><span class="hs-identifier hs-var">handshakeBearer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; socket -&gt; m (MuxBearer m)
</span><a href="#local-6989586621679177118"><span class="hs-identifier hs-var">mkMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.ConnectionHandler.html#sduHandshakeTimeout"><span class="hs-identifier hs-var">sduHandshakeTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679177129"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-264"></span><span>            </span><span id="local-6989586621679177109"><span class="annot"><span class="annottext">Either
  (HandshakeException versionNumber)
  (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
   versionData)
</span><a href="#local-6989586621679177109"><span class="hs-identifier hs-var">hsResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-265"></span><span>              </span><span class="annot"><span class="annottext">m (Either
     (HandshakeException versionNumber)
     (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
      versionData))
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall x. m x -&gt; m x
</span><a href="#local-6989586621679177114"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuxBearer m
-&gt; ConnectionId peerAddr
-&gt; HandshakeArguments
     (ConnectionId peerAddr) versionNumber versionData m
-&gt; Versions
     versionNumber
     versionData
     (OuroborosBundle muxMode peerAddr ByteString m a b)
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall (m :: * -&gt; *) vNumber connectionId vData application.
(MonadAsync m, MonadFork m, MonadMonotonicTime m, MonadTimer m,
 MonadMask m, MonadThrow (STM m), Ord vNumber) =&gt;
MuxBearer m
-&gt; connectionId
-&gt; HandshakeArguments connectionId vNumber vData m
-&gt; Versions vNumber vData application
-&gt; m (Either
        (HandshakeException vNumber) (application, vNumber, vData))
</span><a href="Ouroboros.Network.Protocol.Handshake.html#runHandshakeClient"><span class="hs-identifier hs-var">runHandshakeClient</span></a></span><span> </span><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177110"><span class="hs-identifier hs-var">handshakeBearer</span></a></span><span>
</span><span id="line-266"></span><span>                                         </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679177124"><span class="hs-identifier hs-var">connectionId</span></a></span><span>
</span><span id="line-267"></span><span>                                         </span><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId peerAddr) versionNumber versionData m
</span><a href="#local-6989586621679177160"><span class="hs-identifier hs-var">handshakeArguments</span></a></span><span>
</span><span id="line-268"></span><span>                                         </span><span class="annot"><span class="annottext">Versions
  versionNumber
  versionData
  (OuroborosBundle muxMode peerAddr ByteString m a b)
</span><a href="#local-6989586621679177159"><span class="hs-identifier hs-var">versionedApplication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>              </span><span class="hs-comment">-- 'runHandshakeClient' only deals with protocol limit errors or</span><span>
</span><span id="line-270"></span><span>              </span><span class="hs-comment">-- handshake negotiation failures, but not with 'IOException's or</span><span>
</span><span id="line-271"></span><span>              </span><span class="hs-comment">-- 'MuxError's.</span><span>
</span><span id="line-272"></span><span>              </span><span class="annot"><span class="annottext">m (Either
     (HandshakeException versionNumber)
     (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
      versionData))
-&gt; (SomeException
    -&gt; m (Either
            (HandshakeException versionNumber)
            (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
             versionData)))
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679177106"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177106"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="#local-6989586621679177127"><span class="hs-identifier hs-var">writePromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandleError muxMode versionNumber
-&gt; Either
     (HandleError muxMode versionNumber)
     (Handle muxMode peerAddr ByteString m a b,
      (versionNumber, versionData))
forall a b. a -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; HandleError muxMode versionNumber
forall (muxMode :: MuxMode) versionNumber.
SomeException -&gt; HandleError muxMode versionNumber
</span><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-var">HandleError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177106"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>                </span><span class="annot"><span class="annottext">SomeException
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177106"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-275"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (HandshakeException versionNumber)
  (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
   versionData)
</span><a href="#local-6989586621679177109"><span class="hs-identifier hs-var">hsResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>              </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679177104"><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177104"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="#local-6989586621679177127"><span class="hs-identifier hs-var">writePromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandleError muxMode versionNumber
-&gt; Either
     (HandleError muxMode versionNumber)
     (Handle muxMode peerAddr ByteString m a b,
      (versionNumber, versionData))
forall a b. a -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandshakeException versionNumber
-&gt; HandleError muxMode versionNumber
forall (muxMode :: MuxMode) versionNumber.
(HasInitiator muxMode ~ 'True) =&gt;
HandshakeException versionNumber
-&gt; HandleError muxMode versionNumber
</span><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeClientError"><span class="hs-identifier hs-var">HandleHandshakeClientError</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177104"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; ConnectionHandlerTrace versionNumber versionData -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177125"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandshakeException versionNumber
-&gt; ConnectionHandlerTrace versionNumber versionData
forall versionNumber versionData.
HandshakeException versionNumber
-&gt; ConnectionHandlerTrace versionNumber versionData
</span><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeClientError"><span class="hs-identifier hs-var">TrHandshakeClientError</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177104"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>              </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177102"><span class="annot"><span class="annottext">OuroborosBundle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177102"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177101"><span class="annot"><span class="annottext">versionNumber
</span><a href="#local-6989586621679177101"><span class="hs-identifier hs-var">versionNumber</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177100"><span class="annot"><span class="annottext">versionData
</span><a href="#local-6989586621679177100"><span class="hs-identifier hs-var">agreedOptions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-281"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall x. m x -&gt; m x
</span><a href="#local-6989586621679177114"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; ConnectionHandlerTrace versionNumber versionData -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177125"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">versionNumber
-&gt; versionData -&gt; ConnectionHandlerTrace versionNumber versionData
forall versionNumber versionData.
versionNumber
-&gt; versionData -&gt; ConnectionHandlerTrace versionNumber versionData
</span><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeSuccess"><span class="hs-identifier hs-var">TrHandshakeSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">versionNumber
</span><a href="#local-6989586621679177101"><span class="hs-identifier hs-var">versionNumber</span></a></span><span> </span><span class="annot"><span class="annottext">versionData
</span><a href="#local-6989586621679177100"><span class="hs-identifier hs-var">agreedOptions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>                  </span><span id="local-6989586621679177098"><span class="annot"><span class="annottext">Bundle (StrictTVar m ControlMessage)
</span><a href="#local-6989586621679177098"><span class="hs-identifier hs-var">controlMessageBundle</span></a></span></span><span>
</span><span id="line-284"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679177097"><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177097"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679177096"><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177096"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679177095"><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177095"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WithProtocolTemperature 'Hot (StrictTVar m ControlMessage)
-&gt; WithProtocolTemperature 'Warm (StrictTVar m ControlMessage)
-&gt; WithProtocolTemperature
     'Established (StrictTVar m ControlMessage)
-&gt; Bundle (StrictTVar m ControlMessage)
forall a.
WithProtocolTemperature 'Hot a
-&gt; WithProtocolTemperature 'Warm a
-&gt; WithProtocolTemperature 'Established a
-&gt; Bundle a
</span><a href="Ouroboros.Network.Mux.html#Bundle"><span class="hs-identifier hs-var">Bundle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
-&gt; WithProtocolTemperature 'Hot (StrictTVar m ControlMessage)
forall a. a -&gt; WithProtocolTemperature 'Hot a
</span><a href="Ouroboros.Network.Mux.html#WithHot"><span class="hs-identifier hs-var">WithHot</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177097"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
-&gt; WithProtocolTemperature 'Warm (StrictTVar m ControlMessage)
forall a. a -&gt; WithProtocolTemperature 'Warm a
</span><a href="Ouroboros.Network.Mux.html#WithWarm"><span class="hs-identifier hs-var">WithWarm</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177096"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
-&gt; WithProtocolTemperature
     'Established (StrictTVar m ControlMessage)
forall a. a -&gt; WithProtocolTemperature 'Established a
</span><a href="Ouroboros.Network.Mux.html#WithEstablished"><span class="hs-identifier hs-var">WithEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177095"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>                        </span><span class="annot"><span class="annottext">(StrictTVar m ControlMessage
 -&gt; StrictTVar m ControlMessage
 -&gt; StrictTVar m ControlMessage
 -&gt; Bundle (StrictTVar m ControlMessage))
-&gt; m (StrictTVar m ControlMessage)
-&gt; m (StrictTVar m ControlMessage
      -&gt; StrictTVar m ControlMessage
      -&gt; Bundle (StrictTVar m ControlMessage))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; m (StrictTVar m ControlMessage)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="Ouroboros.Network.Mux.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span>
</span><span id="line-286"></span><span>                        </span><span class="annot"><span class="annottext">m (StrictTVar m ControlMessage
   -&gt; StrictTVar m ControlMessage
   -&gt; Bundle (StrictTVar m ControlMessage))
-&gt; m (StrictTVar m ControlMessage)
-&gt; m (StrictTVar m ControlMessage
      -&gt; Bundle (StrictTVar m ControlMessage))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; m (StrictTVar m ControlMessage)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="Ouroboros.Network.Mux.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span>
</span><span id="line-287"></span><span>                        </span><span class="annot"><span class="annottext">m (StrictTVar m ControlMessage
   -&gt; Bundle (StrictTVar m ControlMessage))
-&gt; m (StrictTVar m ControlMessage)
-&gt; m (Bundle (StrictTVar m ControlMessage))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; m (StrictTVar m ControlMessage)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="Ouroboros.Network.Mux.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span>
</span><span id="line-288"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177087"><span class="annot"><span class="annottext">muxBundle :: MuxBundle muxMode ByteString m a b
</span><a href="#local-6989586621679177087"><span class="hs-identifier hs-var hs-var">muxBundle</span></a></span></span><span>
</span><span id="line-289"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Bundle (ControlMessageSTM m)
-&gt; OuroborosBundle muxMode peerAddr ByteString m a b
-&gt; MuxBundle muxMode ByteString m a b
forall (mode :: MuxMode) addr bytes (m :: * -&gt; *) a b.
ConnectionId addr
-&gt; Bundle (ControlMessageSTM m)
-&gt; OuroborosBundle mode addr bytes m a b
-&gt; MuxBundle mode bytes m a b
</span><a href="Ouroboros.Network.Mux.html#mkMuxApplicationBundle"><span class="hs-identifier hs-var">mkMuxApplicationBundle</span></a></span><span>
</span><span id="line-290"></span><span>                            </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679177124"><span class="hs-identifier hs-var">connectionId</span></a></span><span>
</span><span id="line-291"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage -&gt; ControlMessageSTM m
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictTVar m ControlMessage -&gt; ControlMessageSTM m)
-&gt; Bundle (StrictTVar m ControlMessage)
-&gt; Bundle (ControlMessageSTM m)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bundle (StrictTVar m ControlMessage)
</span><a href="#local-6989586621679177098"><span class="hs-identifier hs-var">controlMessageBundle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>                            </span><span class="annot"><span class="annottext">OuroborosBundle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177102"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-293"></span><span>                  </span><span id="local-6989586621679177084"><span class="annot"><span class="annottext">Mux muxMode m
</span><a href="#local-6989586621679177084"><span class="hs-identifier hs-var">mux</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MiniProtocolBundle muxMode -&gt; m (Mux muxMode m)
forall (m :: * -&gt; *) (mode :: MuxMode).
MonadSTM m =&gt;
MiniProtocolBundle mode -&gt; m (Mux mode m)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">newMux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuxBundle muxMode ByteString m a b -&gt; MiniProtocolBundle muxMode
forall (mode :: MuxMode) bytes (m :: * -&gt; *) a b.
MuxBundle mode bytes m a b -&gt; MiniProtocolBundle mode
</span><a href="Ouroboros.Network.Mux.html#mkMiniProtocolBundle"><span class="hs-identifier hs-var">mkMiniProtocolBundle</span></a></span><span> </span><span class="annot"><span class="annottext">MuxBundle muxMode ByteString m a b
</span><a href="#local-6989586621679177087"><span class="hs-identifier hs-var">muxBundle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679177081"><span class="annot"><span class="annottext">handle :: Handle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177081"><span class="hs-identifier hs-var hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle :: forall (muxMode :: MuxMode) peerAddr bytes (m :: * -&gt; *) a b.
Mux muxMode m
-&gt; MuxBundle muxMode bytes m a b
-&gt; Bundle (StrictTVar m ControlMessage)
-&gt; Handle muxMode peerAddr bytes m a b
</span><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-295"></span><span>                          </span><span class="annot"><span class="annottext">hMux :: Mux muxMode m
</span><a href="Ouroboros.Network.ConnectionHandler.html#hMux"><span class="hs-identifier hs-var">hMux</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mux muxMode m
</span><a href="#local-6989586621679177084"><span class="hs-identifier hs-var">mux</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-296"></span><span>                          </span><span class="annot"><span class="annottext">hMuxBundle :: MuxBundle muxMode ByteString m a b
</span><a href="Ouroboros.Network.ConnectionHandler.html#hMuxBundle"><span class="hs-identifier hs-var">hMuxBundle</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MuxBundle muxMode ByteString m a b
</span><a href="#local-6989586621679177087"><span class="hs-identifier hs-var">muxBundle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-297"></span><span>                          </span><span class="annot"><span class="annottext">hControlMessage :: Bundle (StrictTVar m ControlMessage)
</span><a href="Ouroboros.Network.ConnectionHandler.html#hControlMessage"><span class="hs-identifier hs-var">hControlMessage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bundle (StrictTVar m ControlMessage)
</span><a href="#local-6989586621679177098"><span class="hs-identifier hs-var">controlMessageBundle</span></a></span><span>
</span><span id="line-298"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-299"></span><span>                  </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="#local-6989586621679177127"><span class="hs-identifier hs-var">writePromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Handle muxMode peerAddr ByteString m a b,
 (versionNumber, versionData))
-&gt; Either
     (HandleError muxMode versionNumber)
     (Handle muxMode peerAddr ByteString m a b,
      (versionNumber, versionData))
forall a b. b -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177081"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">versionNumber
</span><a href="#local-6989586621679177101"><span class="hs-identifier hs-var">versionNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">versionData
</span><a href="#local-6989586621679177100"><span class="hs-identifier hs-var">agreedOptions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>                  </span><span id="local-6989586621679177080"><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177080"><span class="hs-identifier hs-var">bearer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; socket -&gt; m (MuxBearer m)
</span><a href="#local-6989586621679177118"><span class="hs-identifier hs-var">mkMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.ConnectionHandler.html#sduTimeout"><span class="hs-identifier hs-var">sduTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679177129"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-301"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m MuxTrace -&gt; Mux muxMode m -&gt; MuxBearer m -&gt; m ()
forall (m :: * -&gt; *) (mode :: MuxMode).
(MonadAsync m, MonadCatch m, MonadFork m, MonadLabelledSTM m,
 MonadThrow (STM m), MonadTime m, MonadTimer m, MonadMask m) =&gt;
Tracer m MuxTrace -&gt; Mux mode m -&gt; MuxBearer m -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">runMux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; MuxTrace -&gt; WithMuxBearer (ConnectionId peerAddr) MuxTrace
forall peerid a. peerid -&gt; a -&gt; WithMuxBearer peerid a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">WithMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679177124"><span class="hs-identifier hs-var">connectionId</span></a></span><span> </span><span class="annot"><span class="annottext">(MuxTrace -&gt; WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; Tracer m MuxTrace
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="#local-6989586621679177162"><span class="hs-identifier hs-var">muxTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>                         </span><span class="annot"><span class="annottext">Mux muxMode m
</span><a href="#local-6989586621679177084"><span class="hs-identifier hs-var">mux</span></a></span><span> </span><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177080"><span class="hs-identifier hs-var">bearer</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><a href="#local-6989586621679177149"><span class="hs-identifier hs-type">inboundConnectionHandler</span></a></span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">HasResponder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">True</span></a></span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#ConnectionHandlerFn"><span class="hs-identifier hs-type">ConnectionHandlerFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#ConnectionHandlerTrace"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>                             </span><span class="annot"><a href="#local-6989586621679177168"><span class="hs-identifier hs-type">socket</span></a></span><span>
</span><span id="line-309"></span><span>                             </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span>
</span><span id="line-310"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177170"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/bytestring-0.10.12.0/src"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177164"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177163"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-type">HandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177169"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679177167"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679177166"><span class="hs-identifier hs-type">versionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>                             </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621679177149"><span class="annot"><span class="annottext">inboundConnectionHandler :: ConnectionHandlerFn
  (ConnectionHandlerTrace versionNumber versionData)
  socket
  peerAddr
  (Handle muxMode peerAddr ByteString m a b)
  (HandleError muxMode versionNumber)
  (versionNumber, versionData)
  m
</span><a href="#local-6989586621679177149"><span class="hs-identifier hs-var hs-var">inboundConnectionHandler</span></a></span></span><span> </span><span id="local-6989586621679177077"><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679177077"><span class="hs-identifier hs-var">socket</span></a></span></span><span>
</span><span id="line-315"></span><span>                             </span><span class="annot"><a href="Ouroboros.Network.ConnectionManager.Types.html#PromiseWriter"><span class="hs-identifier hs-type">PromiseWriter</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679177076"><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
writePromise :: Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
writePromise :: forall (m :: * -&gt; *) a. PromiseWriter m a -&gt; a -&gt; STM m ()
</span><a href="#local-6989586621679177076"><span class="hs-identifier hs-var hs-var">writePromise</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-316"></span><span>                             </span><span id="local-6989586621679177075"><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">tracer</span></a></span></span><span>
</span><span id="line-317"></span><span>                             </span><span id="local-6989586621679177074"><span class="annot"><span class="annottext">connectionId :: ConnectionId peerAddr
</span><a href="#local-6989586621679177074"><span class="hs-identifier hs-var">connectionId</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.ConnectionId.html#ConnectionId"><span class="hs-identifier hs-type">ConnectionId</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679177073"><span class="annot"><span class="annottext">peerAddr
localAddress :: peerAddr
localAddress :: forall addr. ConnectionId addr -&gt; addr
</span><a href="#local-6989586621679177073"><span class="hs-identifier hs-var hs-var">localAddress</span></a></span></span><span>
</span><span id="line-318"></span><span>                                                       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177072"><span class="annot"><span class="annottext">peerAddr
remoteAddress :: peerAddr
remoteAddress :: forall addr. ConnectionId addr -&gt; addr
</span><a href="#local-6989586621679177072"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-319"></span><span>                             </span><span id="local-6989586621679177071"><span class="annot"><span class="annottext">DiffTime -&gt; socket -&gt; m (MuxBearer m)
</span><a href="#local-6989586621679177071"><span class="hs-identifier hs-var">mkMuxBearer</span></a></span></span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaskedAction :: forall (m :: * -&gt; *) a.
((forall x. m x -&gt; m x) -&gt; m a) -&gt; MaskedAction m a
</span><a href="Ouroboros.Network.ConnectionManager.Types.html#MaskedAction"><span class="hs-identifier hs-type">MaskedAction</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(forall x. m x -&gt; m x) -&gt; m ()
runWithUnmask :: (forall x. m x -&gt; m x) -&gt; m ()
runWithUnmask :: (forall x. m x -&gt; m x) -&gt; m ()
</span><a href="#local-6989586621679177070"><span class="hs-identifier hs-var hs-var">runWithUnmask</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-322"></span><span>        </span><span class="annot"><a href="#local-6989586621679177070"><span class="hs-identifier hs-type">runWithUnmask</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679177069"><span class="annot"><a href="#local-6989586621679177069"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177069"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177069"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679177165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>        </span><span id="local-6989586621679177070"><span class="annot"><span class="annottext">runWithUnmask :: (forall x. m x -&gt; m x) -&gt; m ()
</span><a href="#local-6989586621679177070"><span class="hs-identifier hs-var hs-var">runWithUnmask</span></a></span></span><span> </span><span id="local-6989586621679177068"><span class="annot"><span class="annottext">forall x. m x -&gt; m x
</span><a href="#local-6989586621679177068"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; peerAddr -&gt; ErrorContext -&gt; m () -&gt; m ()
forall x.
Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; peerAddr -&gt; ErrorContext -&gt; m x -&gt; m x
</span><a href="#local-6989586621679177146"><span class="hs-identifier hs-var">classifyExceptions</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177072"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorContext
</span><a href="Ouroboros.Network.RethrowPolicy.html#InboundError"><span class="hs-identifier hs-var">InboundError</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">labelThisThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in-conn-hndlr-&quot;</span></span><span>
</span><span id="line-326"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177073"><span class="hs-identifier hs-var">localAddress</span></a></span><span>
</span><span id="line-327"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span>
</span><span id="line-328"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerAddr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">peerAddr
</span><a href="#local-6989586621679177072"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span>
</span><span id="line-329"></span><span>                                    </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>            </span><span id="local-6989586621679177066"><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177066"><span class="hs-identifier hs-var">handshakeBearer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; socket -&gt; m (MuxBearer m)
</span><a href="#local-6989586621679177071"><span class="hs-identifier hs-var">mkMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.ConnectionHandler.html#sduHandshakeTimeout"><span class="hs-identifier hs-var">sduHandshakeTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679177077"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-331"></span><span>            </span><span id="local-6989586621679177065"><span class="annot"><span class="annottext">Either
  (HandshakeException versionNumber)
  (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
   versionData)
</span><a href="#local-6989586621679177065"><span class="hs-identifier hs-var">hsResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-332"></span><span>              </span><span class="annot"><span class="annottext">m (Either
     (HandshakeException versionNumber)
     (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
      versionData))
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall x. m x -&gt; m x
</span><a href="#local-6989586621679177068"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuxBearer m
-&gt; ConnectionId peerAddr
-&gt; HandshakeArguments
     (ConnectionId peerAddr) versionNumber versionData m
-&gt; Versions
     versionNumber
     versionData
     (OuroborosBundle muxMode peerAddr ByteString m a b)
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall (m :: * -&gt; *) vNumber connectionId vData application.
(MonadAsync m, MonadFork m, MonadMonotonicTime m, MonadTimer m,
 MonadMask m, MonadThrow (STM m), Ord vNumber) =&gt;
MuxBearer m
-&gt; connectionId
-&gt; HandshakeArguments connectionId vNumber vData m
-&gt; Versions vNumber vData application
-&gt; m (Either
        (HandshakeException vNumber) (application, vNumber, vData))
</span><a href="Ouroboros.Network.Protocol.Handshake.html#runHandshakeServer"><span class="hs-identifier hs-var">runHandshakeServer</span></a></span><span> </span><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177066"><span class="hs-identifier hs-var">handshakeBearer</span></a></span><span>
</span><span id="line-333"></span><span>                                         </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679177074"><span class="hs-identifier hs-var">connectionId</span></a></span><span>
</span><span id="line-334"></span><span>                                         </span><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId peerAddr) versionNumber versionData m
</span><a href="#local-6989586621679177160"><span class="hs-identifier hs-var">handshakeArguments</span></a></span><span>
</span><span id="line-335"></span><span>                                         </span><span class="annot"><span class="annottext">Versions
  versionNumber
  versionData
  (OuroborosBundle muxMode peerAddr ByteString m a b)
</span><a href="#local-6989586621679177159"><span class="hs-identifier hs-var">versionedApplication</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>              </span><span class="hs-comment">-- 'runHandshakeServer' only deals with protocol limit errors or</span><span>
</span><span id="line-337"></span><span>              </span><span class="hs-comment">-- handshake negotiation failures, but not with 'IOException's or</span><span>
</span><span id="line-338"></span><span>              </span><span class="hs-comment">-- 'MuxError's.</span><span>
</span><span id="line-339"></span><span>              </span><span class="annot"><span class="annottext">m (Either
     (HandshakeException versionNumber)
     (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
      versionData))
-&gt; (SomeException
    -&gt; m (Either
            (HandshakeException versionNumber)
            (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
             versionData)))
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679177063"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177063"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="#local-6989586621679177076"><span class="hs-identifier hs-var">writePromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandleError muxMode versionNumber
-&gt; Either
     (HandleError muxMode versionNumber)
     (Handle muxMode peerAddr ByteString m a b,
      (versionNumber, versionData))
forall a b. a -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; HandleError muxMode versionNumber
forall (muxMode :: MuxMode) versionNumber.
SomeException -&gt; HandleError muxMode versionNumber
</span><a href="Ouroboros.Network.ConnectionHandler.html#HandleError"><span class="hs-identifier hs-var">HandleError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177063"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>                </span><span class="annot"><span class="annottext">SomeException
-&gt; m (Either
        (HandshakeException versionNumber)
        (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
         versionData))
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679177063"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either
  (HandshakeException versionNumber)
  (OuroborosBundle muxMode peerAddr ByteString m a b, versionNumber,
   versionData)
</span><a href="#local-6989586621679177065"><span class="hs-identifier hs-var">hsResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-344"></span><span>              </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679177062"><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177062"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="#local-6989586621679177076"><span class="hs-identifier hs-var">writePromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandleError muxMode versionNumber
-&gt; Either
     (HandleError muxMode versionNumber)
     (Handle muxMode peerAddr ByteString m a b,
      (versionNumber, versionData))
forall a b. a -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandshakeException versionNumber
-&gt; HandleError muxMode versionNumber
forall (muxMode :: MuxMode) versionNumber.
(HasResponder muxMode ~ 'True) =&gt;
HandshakeException versionNumber
-&gt; HandleError muxMode versionNumber
</span><a href="Ouroboros.Network.ConnectionHandler.html#HandleHandshakeServerError"><span class="hs-identifier hs-var">HandleHandshakeServerError</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177062"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; ConnectionHandlerTrace versionNumber versionData -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HandshakeException versionNumber
-&gt; ConnectionHandlerTrace versionNumber versionData
forall versionNumber versionData.
HandshakeException versionNumber
-&gt; ConnectionHandlerTrace versionNumber versionData
</span><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeServerError"><span class="hs-identifier hs-var">TrHandshakeServerError</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeException versionNumber
</span><a href="#local-6989586621679177062"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>              </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679177060"><span class="annot"><span class="annottext">OuroborosBundle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177060"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177059"><span class="annot"><span class="annottext">versionNumber
</span><a href="#local-6989586621679177059"><span class="hs-identifier hs-var">versionNumber</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679177058"><span class="annot"><span class="annottext">versionData
</span><a href="#local-6989586621679177058"><span class="hs-identifier hs-var">agreedOptions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall x. m x -&gt; m x
</span><a href="#local-6989586621679177068"><span class="hs-identifier hs-var">unmask</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
-&gt; ConnectionHandlerTrace versionNumber versionData -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ConnectionHandlerTrace versionNumber versionData)
</span><a href="#local-6989586621679177075"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">versionNumber
-&gt; versionData -&gt; ConnectionHandlerTrace versionNumber versionData
forall versionNumber versionData.
versionNumber
-&gt; versionData -&gt; ConnectionHandlerTrace versionNumber versionData
</span><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeSuccess"><span class="hs-identifier hs-var">TrHandshakeSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">versionNumber
</span><a href="#local-6989586621679177059"><span class="hs-identifier hs-var">versionNumber</span></a></span><span> </span><span class="annot"><span class="annottext">versionData
</span><a href="#local-6989586621679177058"><span class="hs-identifier hs-var">agreedOptions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>                  </span><span id="local-6989586621679177057"><span class="annot"><span class="annottext">Bundle (StrictTVar m ControlMessage)
</span><a href="#local-6989586621679177057"><span class="hs-identifier hs-var">controlMessageBundle</span></a></span></span><span>
</span><span id="line-351"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679177056"><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177056"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679177055"><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177055"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679177054"><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177054"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WithProtocolTemperature 'Hot (StrictTVar m ControlMessage)
-&gt; WithProtocolTemperature 'Warm (StrictTVar m ControlMessage)
-&gt; WithProtocolTemperature
     'Established (StrictTVar m ControlMessage)
-&gt; Bundle (StrictTVar m ControlMessage)
forall a.
WithProtocolTemperature 'Hot a
-&gt; WithProtocolTemperature 'Warm a
-&gt; WithProtocolTemperature 'Established a
-&gt; Bundle a
</span><a href="Ouroboros.Network.Mux.html#Bundle"><span class="hs-identifier hs-var">Bundle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
-&gt; WithProtocolTemperature 'Hot (StrictTVar m ControlMessage)
forall a. a -&gt; WithProtocolTemperature 'Hot a
</span><a href="Ouroboros.Network.Mux.html#WithHot"><span class="hs-identifier hs-var">WithHot</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177056"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
-&gt; WithProtocolTemperature 'Warm (StrictTVar m ControlMessage)
forall a. a -&gt; WithProtocolTemperature 'Warm a
</span><a href="Ouroboros.Network.Mux.html#WithWarm"><span class="hs-identifier hs-var">WithWarm</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177055"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
-&gt; WithProtocolTemperature
     'Established (StrictTVar m ControlMessage)
forall a. a -&gt; WithProtocolTemperature 'Established a
</span><a href="Ouroboros.Network.Mux.html#WithEstablished"><span class="hs-identifier hs-var">WithEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ControlMessage
</span><a href="#local-6989586621679177054"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>                        </span><span class="annot"><span class="annottext">(StrictTVar m ControlMessage
 -&gt; StrictTVar m ControlMessage
 -&gt; StrictTVar m ControlMessage
 -&gt; Bundle (StrictTVar m ControlMessage))
-&gt; m (StrictTVar m ControlMessage)
-&gt; m (StrictTVar m ControlMessage
      -&gt; StrictTVar m ControlMessage
      -&gt; Bundle (StrictTVar m ControlMessage))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; m (StrictTVar m ControlMessage)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="Ouroboros.Network.Mux.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span>
</span><span id="line-353"></span><span>                        </span><span class="annot"><span class="annottext">m (StrictTVar m ControlMessage
   -&gt; StrictTVar m ControlMessage
   -&gt; Bundle (StrictTVar m ControlMessage))
-&gt; m (StrictTVar m ControlMessage)
-&gt; m (StrictTVar m ControlMessage
      -&gt; Bundle (StrictTVar m ControlMessage))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; m (StrictTVar m ControlMessage)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="Ouroboros.Network.Mux.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span>
</span><span id="line-354"></span><span>                        </span><span class="annot"><span class="annottext">m (StrictTVar m ControlMessage
   -&gt; Bundle (StrictTVar m ControlMessage))
-&gt; m (StrictTVar m ControlMessage)
-&gt; m (Bundle (StrictTVar m ControlMessage))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage -&gt; m (StrictTVar m ControlMessage)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="Ouroboros.Network.Mux.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span>
</span><span id="line-355"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679177053"><span class="annot"><span class="annottext">muxBundle :: MuxBundle muxMode ByteString m a b
</span><a href="#local-6989586621679177053"><span class="hs-identifier hs-var hs-var">muxBundle</span></a></span></span><span>
</span><span id="line-356"></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; Bundle (ControlMessageSTM m)
-&gt; OuroborosBundle muxMode peerAddr ByteString m a b
-&gt; MuxBundle muxMode ByteString m a b
forall (mode :: MuxMode) addr bytes (m :: * -&gt; *) a b.
ConnectionId addr
-&gt; Bundle (ControlMessageSTM m)
-&gt; OuroborosBundle mode addr bytes m a b
-&gt; MuxBundle mode bytes m a b
</span><a href="Ouroboros.Network.Mux.html#mkMuxApplicationBundle"><span class="hs-identifier hs-var">mkMuxApplicationBundle</span></a></span><span>
</span><span id="line-357"></span><span>                            </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679177074"><span class="hs-identifier hs-var">connectionId</span></a></span><span>
</span><span id="line-358"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ControlMessage -&gt; ControlMessageSTM m
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictTVar m ControlMessage -&gt; ControlMessageSTM m)
-&gt; Bundle (StrictTVar m ControlMessage)
-&gt; Bundle (ControlMessageSTM m)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bundle (StrictTVar m ControlMessage)
</span><a href="#local-6989586621679177057"><span class="hs-identifier hs-var">controlMessageBundle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>                            </span><span class="annot"><span class="annottext">OuroborosBundle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177060"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-360"></span><span>                  </span><span id="local-6989586621679177052"><span class="annot"><span class="annottext">Mux muxMode m
</span><a href="#local-6989586621679177052"><span class="hs-identifier hs-var">mux</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MiniProtocolBundle muxMode -&gt; m (Mux muxMode m)
forall (m :: * -&gt; *) (mode :: MuxMode).
MonadSTM m =&gt;
MiniProtocolBundle mode -&gt; m (Mux mode m)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">newMux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuxBundle muxMode ByteString m a b -&gt; MiniProtocolBundle muxMode
forall (mode :: MuxMode) bytes (m :: * -&gt; *) a b.
MuxBundle mode bytes m a b -&gt; MiniProtocolBundle mode
</span><a href="Ouroboros.Network.Mux.html#mkMiniProtocolBundle"><span class="hs-identifier hs-var">mkMiniProtocolBundle</span></a></span><span> </span><span class="annot"><span class="annottext">MuxBundle muxMode ByteString m a b
</span><a href="#local-6989586621679177053"><span class="hs-identifier hs-var">muxBundle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679177051"><span class="annot"><span class="annottext">handle :: Handle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177051"><span class="hs-identifier hs-var hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle :: forall (muxMode :: MuxMode) peerAddr bytes (m :: * -&gt; *) a b.
Mux muxMode m
-&gt; MuxBundle muxMode bytes m a b
-&gt; Bundle (StrictTVar m ControlMessage)
-&gt; Handle muxMode peerAddr bytes m a b
</span><a href="Ouroboros.Network.ConnectionHandler.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-362"></span><span>                          </span><span class="annot"><span class="annottext">hMux :: Mux muxMode m
</span><a href="Ouroboros.Network.ConnectionHandler.html#hMux"><span class="hs-identifier hs-var">hMux</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mux muxMode m
</span><a href="#local-6989586621679177052"><span class="hs-identifier hs-var">mux</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-363"></span><span>                          </span><span class="annot"><span class="annottext">hMuxBundle :: MuxBundle muxMode ByteString m a b
</span><a href="Ouroboros.Network.ConnectionHandler.html#hMuxBundle"><span class="hs-identifier hs-var">hMuxBundle</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MuxBundle muxMode ByteString m a b
</span><a href="#local-6989586621679177053"><span class="hs-identifier hs-var">muxBundle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-364"></span><span>                          </span><span class="annot"><span class="annottext">hControlMessage :: Bundle (StrictTVar m ControlMessage)
</span><a href="Ouroboros.Network.ConnectionHandler.html#hControlMessage"><span class="hs-identifier hs-var">hControlMessage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bundle (StrictTVar m ControlMessage)
</span><a href="#local-6989586621679177057"><span class="hs-identifier hs-var">controlMessageBundle</span></a></span><span>
</span><span id="line-365"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-366"></span><span>                  </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  (HandleError muxMode versionNumber)
  (Handle muxMode peerAddr ByteString m a b,
   (versionNumber, versionData))
-&gt; STM m ()
</span><a href="#local-6989586621679177076"><span class="hs-identifier hs-var">writePromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Handle muxMode peerAddr ByteString m a b,
 (versionNumber, versionData))
-&gt; Either
     (HandleError muxMode versionNumber)
     (Handle muxMode peerAddr ByteString m a b,
      (versionNumber, versionData))
forall a b. b -&gt; Either a b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle muxMode peerAddr ByteString m a b
</span><a href="#local-6989586621679177051"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">versionNumber
</span><a href="#local-6989586621679177059"><span class="hs-identifier hs-var">versionNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">versionData
</span><a href="#local-6989586621679177058"><span class="hs-identifier hs-var">agreedOptions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>                  </span><span id="local-6989586621679177050"><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177050"><span class="hs-identifier hs-var">bearer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; socket -&gt; m (MuxBearer m)
</span><a href="#local-6989586621679177071"><span class="hs-identifier hs-var">mkMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.ConnectionHandler.html#sduTimeout"><span class="hs-identifier hs-var">sduTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">socket
</span><a href="#local-6989586621679177077"><span class="hs-identifier hs-var">socket</span></a></span><span>
</span><span id="line-368"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m MuxTrace -&gt; Mux muxMode m -&gt; MuxBearer m -&gt; m ()
forall (m :: * -&gt; *) (mode :: MuxMode).
(MonadAsync m, MonadCatch m, MonadFork m, MonadLabelledSTM m,
 MonadThrow (STM m), MonadTime m, MonadTimer m, MonadMask m) =&gt;
Tracer m MuxTrace -&gt; Mux mode m -&gt; MuxBearer m -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">runMux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId peerAddr
-&gt; MuxTrace -&gt; WithMuxBearer (ConnectionId peerAddr) MuxTrace
forall peerid a. peerid -&gt; a -&gt; WithMuxBearer peerid a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-var">WithMuxBearer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId peerAddr
</span><a href="#local-6989586621679177074"><span class="hs-identifier hs-var">connectionId</span></a></span><span> </span><span class="annot"><span class="annottext">(MuxTrace -&gt; WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; Tracer m MuxTrace
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
</span><a href="#local-6989586621679177162"><span class="hs-identifier hs-var">muxTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>                             </span><span class="annot"><span class="annottext">Mux muxMode m
</span><a href="#local-6989586621679177052"><span class="hs-identifier hs-var">mux</span></a></span><span> </span><span class="annot"><span class="annottext">MuxBearer m
</span><a href="#local-6989586621679177050"><span class="hs-identifier hs-var">bearer</span></a></span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">--</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- Tracing</span><span>
</span><span id="line-375"></span><span class="hs-comment">--</span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="hs-comment">-- | 'ConnectionHandlerTrace' is embedded into 'ConnectionManagerTrace' with</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- 'Ouroboros.Network.ConnectionManager.Types.ConnectionHandlerTrace'</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- constructor.  It already includes 'ConnectionId' so we don't need to take</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- care of it here.</span><span>
</span><span id="line-382"></span><span class="hs-comment">--</span><span>
</span><span id="line-383"></span><span class="hs-comment">-- TODO: when 'Handshake' will get its own tracer, independent of 'Mux', it</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- should be embedded into 'ConnectionHandlerTrace'.</span><span>
</span><span id="line-385"></span><span class="hs-comment">--</span><span>
</span><span id="line-386"></span><span class="hs-keyword">data</span><span> </span><span id="ConnectionHandlerTrace"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#ConnectionHandlerTrace"><span class="hs-identifier hs-var">ConnectionHandlerTrace</span></a></span></span><span> </span><span id="local-6989586621679177326"><span class="annot"><a href="#local-6989586621679177326"><span class="hs-identifier hs-type">versionNumber</span></a></span></span><span> </span><span id="local-6989586621679177325"><span class="annot"><a href="#local-6989586621679177325"><span class="hs-identifier hs-type">versionData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>      </span><span id="TrHandshakeSuccess"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeSuccess"><span class="hs-identifier hs-var">TrHandshakeSuccess</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679177326"><span class="hs-identifier hs-type">versionNumber</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177325"><span class="hs-identifier hs-type">versionData</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrHandshakeClientError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeClientError"><span class="hs-identifier hs-var">TrHandshakeClientError</span></a></span></span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeException"><span class="hs-identifier hs-type">HandshakeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177326"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrHandshakeServerError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#TrHandshakeServerError"><span class="hs-identifier hs-var">TrHandshakeServerError</span></a></span></span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.Handshake.html#HandshakeException"><span class="hs-identifier hs-type">HandshakeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679177326"><span class="hs-identifier hs-type">versionNumber</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TrError"><span class="annot"><a href="Ouroboros.Network.ConnectionHandler.html#TrError"><span class="hs-identifier hs-var">TrError</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.RethrowPolicy.html#ErrorContext"><span class="hs-identifier hs-type">ErrorContext</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.RethrowPolicy.html#ErrorCommand"><span class="hs-identifier hs-type">ErrorCommand</span></a></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679177044"><span id="local-6989586621679177046"><span id="local-6989586621679177048"><span class="annot"><span class="annottext">Int -&gt; ConnectionHandlerTrace versionNumber versionData -&gt; ShowS
[ConnectionHandlerTrace versionNumber versionData] -&gt; ShowS
ConnectionHandlerTrace versionNumber versionData -&gt; String
(Int -&gt; ConnectionHandlerTrace versionNumber versionData -&gt; ShowS)
-&gt; (ConnectionHandlerTrace versionNumber versionData -&gt; String)
-&gt; ([ConnectionHandlerTrace versionNumber versionData] -&gt; ShowS)
-&gt; Show (ConnectionHandlerTrace versionNumber versionData)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall versionNumber versionData.
(Show versionNumber, Show versionData) =&gt;
Int -&gt; ConnectionHandlerTrace versionNumber versionData -&gt; ShowS
forall versionNumber versionData.
(Show versionNumber, Show versionData) =&gt;
[ConnectionHandlerTrace versionNumber versionData] -&gt; ShowS
forall versionNumber versionData.
(Show versionNumber, Show versionData) =&gt;
ConnectionHandlerTrace versionNumber versionData -&gt; String
showList :: [ConnectionHandlerTrace versionNumber versionData] -&gt; ShowS
$cshowList :: forall versionNumber versionData.
(Show versionNumber, Show versionData) =&gt;
[ConnectionHandlerTrace versionNumber versionData] -&gt; ShowS
show :: ConnectionHandlerTrace versionNumber versionData -&gt; String
$cshow :: forall versionNumber versionData.
(Show versionNumber, Show versionData) =&gt;
ConnectionHandlerTrace versionNumber versionData -&gt; String
showsPrec :: Int -&gt; ConnectionHandlerTrace versionNumber versionData -&gt; ShowS
$cshowsPrec :: forall versionNumber versionData.
(Show versionNumber, Show versionData) =&gt;
Int -&gt; ConnectionHandlerTrace versionNumber versionData -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-394"></span></pre></body></html>