<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE RecursiveDo         #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving  #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Subscription.Worker</span><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SocketStateChange"><span class="hs-identifier hs-type">SocketStateChange</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SocketState"><span class="hs-identifier hs-type">SocketState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplication"><span class="hs-identifier hs-type">CompleteApplication</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectResult"><span class="hs-identifier hs-type">ConnectResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#Main"><span class="hs-identifier hs-type">Main</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#StateVar"><span class="hs-identifier hs-type">StateVar</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#LocalAddresses"><span class="hs-identifier hs-type">LocalAddresses</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>    </span><span class="hs-comment">-- * Subscription worker</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier hs-type">WorkerCallbacks</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier hs-type">WorkerParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#worker"><span class="hs-identifier hs-var">worker</span></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-comment">-- * Socket API</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#safeConnect"><span class="hs-identifier hs-var">safeConnect</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-comment">-- * Constants</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#defaultConnectionAttemptDelay"><span class="hs-identifier hs-var">defaultConnectionAttemptDelay</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#minConnectionAttemptDelay"><span class="hs-identifier hs-var">minConnectionAttemptDelay</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#maxConnectionAttemptDelay"><span class="hs-identifier hs-var">maxConnectionAttemptDelay</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ipRetryDelay"><span class="hs-identifier hs-var">ipRetryDelay</span></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-comment">-- * Errors</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier hs-type">SubscriberError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-comment">-- * Tracing</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier hs-type">SubscriptionTrace</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Concurrent.STM</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">STM</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forever</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">join</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Fix</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFix</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">traverse_</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Void</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Void</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Stack</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network.Socket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Family</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">AF_UNIX</span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Printf</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadFork.html"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html"><span class="hs-identifier">Control.Monad.Class.MonadSTM.Strict</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html"><span class="hs-identifier">Control.Tracer</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.ErrorPolicy.html"><span class="hs-identifier">Ouroboros.Network.ErrorPolicy</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplication"><span class="hs-identifier hs-type">CompleteApplication</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplicationResult"><span class="hs-identifier hs-type">CompleteApplicationResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.Server.ConnectionTable.html"><span class="hs-identifier">Ouroboros.Network.Server.ConnectionTable</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.Snocket.html"><span class="hs-identifier">Ouroboros.Network.Snocket</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Network.Snocket.html"><span class="hs-identifier">Ouroboros.Network.Snocket</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Snocket</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.Subscription.Subscriber.html"><span class="hs-identifier">Ouroboros.Network.Subscription.Subscriber</span></a><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- | Time to wait between connection attempts when we don't have any DeltaQ</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- info.</span><span>
</span><a name="line-66"></a><span class="hs-comment">--</span><span>
</span><a name="line-67"></a><span class="hs-identifier">defaultConnectionAttemptDelay</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-68"></a><a name="defaultConnectionAttemptDelay"><a href="Ouroboros.Network.Subscription.Worker.html#defaultConnectionAttemptDelay"><span class="hs-identifier">defaultConnectionAttemptDelay</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0.025</span><span> </span><span class="hs-comment">-- 25ms delay</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">-- | Minimum time to wait between connection attempts.</span><span>
</span><a name="line-71"></a><span class="hs-comment">--</span><span>
</span><a name="line-72"></a><span class="hs-identifier">minConnectionAttemptDelay</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-73"></a><a name="minConnectionAttemptDelay"><a href="Ouroboros.Network.Subscription.Worker.html#minConnectionAttemptDelay"><span class="hs-identifier">minConnectionAttemptDelay</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0.010</span><span> </span><span class="hs-comment">-- 10ms delay</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- | Maximum time to wait between connection attempts.</span><span>
</span><a name="line-76"></a><span class="hs-comment">--</span><span>
</span><a name="line-77"></a><span class="hs-identifier">maxConnectionAttemptDelay</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-78"></a><a name="maxConnectionAttemptDelay"><a href="Ouroboros.Network.Subscription.Worker.html#maxConnectionAttemptDelay"><span class="hs-identifier">maxConnectionAttemptDelay</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-comment">-- 2s delay</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- | Minimum time to wait between ip reconnects</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-identifier">ipRetryDelay</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-83"></a><a name="ipRetryDelay"><a href="Ouroboros.Network.Subscription.Worker.html#ipRetryDelay"><span class="hs-identifier">ipRetryDelay</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">10</span><span> </span><span class="hs-comment">-- 10s delay</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-keyword">data</span><span> </span><a name="ResOrAct"><a href="Ouroboros.Network.Subscription.Worker.html#ResOrAct"><span class="hs-identifier">ResOrAct</span></a></a><span> </span><a name="local-6989586621679138749"><a href="#local-6989586621679138749"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138750"><a href="#local-6989586621679138750"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138751"><a href="#local-6989586621679138751"><span class="hs-identifier">tr</span></a></a><span> </span><a name="local-6989586621679138752"><a href="#local-6989586621679138752"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-86"></a><span>     </span><a name="Res"><a href="Ouroboros.Network.Subscription.Worker.html#Res"><span class="hs-identifier">Res</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679138750"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138752"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Act"><a href="Ouroboros.Network.Subscription.Worker.html#Act"><span class="hs-identifier">Act</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138749"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ threads to kill</span><span>
</span><a name="line-88"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679138751"><span class="hs-identifier hs-type">tr</span></a><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- ^ trace point</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- | Result queue.  The spawned threads will keep writing to it, while the main</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- server will read from it.</span><span>
</span><a name="line-92"></a><span class="hs-comment">--</span><span>
</span><a name="line-93"></a><span class="hs-keyword">type</span><span> </span><a name="ResultQ"><a href="Ouroboros.Network.Subscription.Worker.html#ResultQ"><span class="hs-identifier">ResultQ</span></a></a><span> </span><a name="local-6989586621679138745"><a href="#local-6989586621679138745"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138746"><a href="#local-6989586621679138746"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138747"><a href="#local-6989586621679138747"><span class="hs-identifier">tr</span></a></a><span> </span><a name="local-6989586621679138748"><a href="#local-6989586621679138748"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a><span> </span><a href="#local-6989586621679138745"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#ResOrAct"><span class="hs-identifier hs-type">ResOrAct</span></a><span> </span><a href="#local-6989586621679138745"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138746"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138747"><span class="hs-identifier hs-type">tr</span></a><span> </span><a href="#local-6989586621679138748"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">newResultQ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138922"><a href="#local-6989586621679138922"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138923"><a href="#local-6989586621679138923"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138924"><a href="#local-6989586621679138924"><span class="hs-identifier">tr</span></a></a><span> </span><a name="local-6989586621679138925"><a href="#local-6989586621679138925"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679138922"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679138922"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#ResultQ"><span class="hs-identifier hs-type">ResultQ</span></a><span> </span><a href="#local-6989586621679138922"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138923"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138924"><span class="hs-identifier hs-type">tr</span></a><span> </span><a href="#local-6989586621679138925"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><a name="newResultQ"><a href="Ouroboros.Network.Subscription.Worker.html#newResultQ"><span class="hs-identifier">newResultQ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#newTQueue"><span class="hs-identifier hs-var">newTQueue</span></a><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">-- | Mutable state kept by the worker.  All the workers in this module are</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- polymorphic over the state type.  The state is updated with two callbacks:</span><span>
</span><a name="line-100"></a><span class="hs-comment">--</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- * 'CompleteConnect'     - STM transaction which runs when the connect call</span><span>
</span><a name="line-102"></a><span class="hs-comment">--                           returned, if it thrown an exception it will be</span><span>
</span><a name="line-103"></a><span class="hs-comment">--                           passed to the callback.</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- * 'CompleteApplication' - STM transaction which runs when application</span><span>
</span><a name="line-105"></a><span class="hs-comment">--                           returned.  It will receive the result of the</span><span>
</span><a name="line-106"></a><span class="hs-comment">--                           application or an exception raised by it.</span><span>
</span><a name="line-107"></a><span class="hs-comment">--</span><span>
</span><a name="line-108"></a><span class="hs-keyword">type</span><span> </span><a name="StateVar"><a href="Ouroboros.Network.Subscription.Worker.html#StateVar"><span class="hs-identifier">StateVar</span></a></a><span> </span><a name="local-6989586621679138743"><a href="#local-6989586621679138743"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138744"><a href="#local-6989586621679138744"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679138743"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138744"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | The set of all spawned threads. Used for waiting or cancelling them when</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- the server shuts down.</span><span>
</span><a name="line-112"></a><span class="hs-comment">--</span><span>
</span><a name="line-113"></a><span class="hs-keyword">type</span><span> </span><a name="ThreadsVar"><a href="Ouroboros.Network.Subscription.Worker.html#ThreadsVar"><span class="hs-identifier">ThreadsVar</span></a></a><span> </span><a name="local-6989586621679138742"><a href="#local-6989586621679138742"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679138742"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138742"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-keyword">data</span><span> </span><a name="SocketState"><a href="Ouroboros.Network.Subscription.Worker.html#SocketState"><span class="hs-identifier">SocketState</span></a></a><span> </span><a name="local-6989586621679138740"><a href="#local-6989586621679138740"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138741"><a href="#local-6989586621679138741"><span class="hs-identifier">addr</span></a></a><span>
</span><a name="line-117"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="CreatedSocket"><a href="Ouroboros.Network.Subscription.Worker.html#CreatedSocket"><span class="hs-identifier">CreatedSocket</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621679138741"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138740"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="ClosedSocket"><a href="Ouroboros.Network.Subscription.Worker.html#ClosedSocket"><span class="hs-identifier">ClosedSocket</span></a></a><span>  </span><span class="hs-glyph">!</span><a href="#local-6989586621679138741"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138740"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- | Callback which fires: when we create or close a socket.</span><span>
</span><a name="line-121"></a><span class="hs-comment">--</span><span>
</span><a name="line-122"></a><span class="hs-keyword">type</span><span> </span><a name="SocketStateChange"><a href="Ouroboros.Network.Subscription.Worker.html#SocketStateChange"><span class="hs-identifier">SocketStateChange</span></a></a><span> </span><a name="local-6989586621679138737"><a href="#local-6989586621679138737"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138738"><a href="#local-6989586621679138738"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138739"><a href="#local-6989586621679138739"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SocketState"><span class="hs-identifier hs-type">SocketState</span></a><span> </span><a href="#local-6989586621679138737"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138739"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138738"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679138737"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138738"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | Given current state 'retry' too keep the subscription worker going.</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- When this transaction returns, all the threads spawned by the worker will be</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- killed.</span><span>
</span><a name="line-127"></a><span class="hs-comment">--</span><span>
</span><a name="line-128"></a><span class="hs-keyword">type</span><span> </span><a name="Main"><a href="Ouroboros.Network.Subscription.Worker.html#Main"><span class="hs-identifier">Main</span></a></a><span> </span><a name="local-6989586621679138734"><a href="#local-6989586621679138734"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138735"><a href="#local-6989586621679138735"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138736"><a href="#local-6989586621679138736"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679138735"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679138734"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138736"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">data</span><span> </span><a name="LocalAddresses"><a href="Ouroboros.Network.Subscription.Worker.html#LocalAddresses"><span class="hs-identifier">LocalAddresses</span></a></a><span> </span><a name="local-6989586621679138733"><a href="#local-6989586621679138733"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="LocalAddresses"><a href="Ouroboros.Network.Subscription.Worker.html#LocalAddresses"><span class="hs-identifier">LocalAddresses</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-comment">-- | Local IPv4 address to use, Nothing indicates don't use IPv4</span><span>
</span><a name="line-132"></a><span>    </span><a name="laIpv4"><a href="Ouroboros.Network.Subscription.Worker.html#laIpv4"><span class="hs-identifier">laIpv4</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679138733"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-comment">-- | Local IPv6 address to use, Nothing indicates don't use IPv6</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="laIpv6"><a href="Ouroboros.Network.Subscription.Worker.html#laIpv6"><span class="hs-identifier">laIpv6</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679138733"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-comment">-- | Local Unix address to use, Nothing indicates don't use Unix sockets</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="laUnix"><a href="Ouroboros.Network.Subscription.Worker.html#laUnix"><span class="hs-identifier">laUnix</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679138733"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">-- | Allocate a socket and connect to a peer, execute the continuation with</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- async exceptions masked.  The continuation receives the 'unmask' callback.</span><span>
</span><a name="line-142"></a><span class="hs-comment">--</span><span>
</span><a name="line-143"></a><span class="hs-identifier">safeConnect</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadThrow"><span class="hs-identifier hs-type">MonadThrow</span></a><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-144"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadMask"><span class="hs-identifier hs-type">MonadMask</span></a><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-145"></a><span>               </span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138918"><span class="hs-identifier hs-type">sock</span></a><span> </span><a href="#local-6989586621679138919"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-147"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138919"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-148"></a><span>            </span><span class="hs-comment">-- ^ remote addr</span><span>
</span><a name="line-149"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138919"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-150"></a><span>            </span><span class="hs-comment">-- ^ local addr</span><span>
</span><a name="line-151"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>            </span><span class="hs-comment">-- ^ allocate extra action; executed with async exceptions masked in</span><span>
</span><a name="line-153"></a><span>            </span><span class="hs-comment">-- the allocation action of 'bracket'</span><span>
</span><a name="line-154"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>            </span><span class="hs-comment">-- ^ release extra action; executed with async exceptions masked in</span><span>
</span><a name="line-156"></a><span>            </span><span class="hs-comment">-- the closing action of 'bracket'</span><span>
</span><a name="line-157"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138921"><a href="#local-6989586621679138921"><span class="hs-identifier">x</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138921"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138921"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138918"><span class="hs-identifier hs-type">sock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138920"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>            </span><span class="hs-comment">-- ^ continuation executed with async exceptions</span><span>
</span><a name="line-159"></a><span>            </span><span class="hs-comment">-- masked; it receives: unmask function, allocated socket and</span><span>
</span><a name="line-160"></a><span>            </span><span class="hs-comment">-- connection error.</span><span>
</span><a name="line-161"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138917"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138920"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-162"></a><a name="safeConnect"><a href="Ouroboros.Network.Subscription.Worker.html#safeConnect"><span class="hs-identifier">safeConnect</span></a></a><span> </span><a name="local-6989586621679138926"><a href="#local-6989586621679138926"><span class="hs-identifier">sn</span></a></a><span> </span><a name="local-6989586621679138927"><a href="#local-6989586621679138927"><span class="hs-identifier">remoteAddr</span></a></a><span> </span><a name="local-6989586621679138928"><a href="#local-6989586621679138928"><span class="hs-identifier">localAddr</span></a></a><span> </span><a name="local-6989586621679138929"><a href="#local-6989586621679138929"><span class="hs-identifier">malloc</span></a></a><span> </span><a name="local-6989586621679138930"><a href="#local-6989586621679138930"><span class="hs-identifier">mclean</span></a></a><span> </span><a name="local-6989586621679138931"><a href="#local-6989586621679138931"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-163"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#bracket"><span class="hs-identifier hs-var">bracket</span></a><span>
</span><a name="line-164"></a><span>      </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679138932"><a href="#local-6989586621679138932"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">Snocket.open</span><span> </span><a href="#local-6989586621679138926"><span class="hs-identifier hs-var">sn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">Snocket.addrFamily</span><span> </span><a href="#local-6989586621679138926"><span class="hs-identifier hs-var">sn</span></a><span> </span><a href="#local-6989586621679138927"><span class="hs-identifier hs-var">remoteAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>          </span><a href="#local-6989586621679138929"><span class="hs-identifier hs-var">malloc</span></a><span>
</span><a name="line-166"></a><span>          </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679138932"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-167"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679138933"><a href="#local-6989586621679138933"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Snocket.close</span><span> </span><a href="#local-6989586621679138926"><span class="hs-identifier hs-var">sn</span></a><span> </span><a href="#local-6989586621679138933"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679138930"><span class="hs-identifier hs-var">mclean</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679138934"><a href="#local-6989586621679138934"><span class="hs-identifier">sock</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#mask"><span class="hs-identifier hs-var">mask</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679138935"><a href="#local-6989586621679138935"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679138936"><a href="#local-6989586621679138936"><span class="hs-identifier">doBind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">Snocket.addrFamily</span><span> </span><a href="#local-6989586621679138926"><span class="hs-identifier hs-var">sn</span></a><span> </span><a href="#local-6989586621679138928"><span class="hs-identifier hs-var">localAddr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-171"></a><span>                            </span><a href="Ouroboros.Network.Snocket.html#SocketFamily"><span class="hs-identifier hs-var">Snocket.SocketFamily</span></a><span> </span><a name="local-6989586621679138937"><a href="#local-6989586621679138937"><span class="hs-identifier">fam</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138937"><span class="hs-identifier hs-var">fam</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">AF_UNIX</span><span>
</span><a name="line-172"></a><span>                            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- Bind is a nop for Named Pipes anyway</span><span>
</span><a name="line-173"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679138936"><span class="hs-identifier hs-var">doBind</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-174"></a><span>            </span><span class="hs-identifier">Snocket.bind</span><span> </span><a href="#local-6989586621679138926"><span class="hs-identifier hs-var">sn</span></a><span> </span><a href="#local-6989586621679138934"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679138928"><span class="hs-identifier hs-var">localAddr</span></a><span>
</span><a name="line-175"></a><span>          </span><a name="local-6989586621679138938"><a href="#local-6989586621679138938"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#try"><span class="hs-identifier hs-var">try</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138935"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">Snocket.connect</span><span> </span><a href="#local-6989586621679138926"><span class="hs-identifier hs-var">sn</span></a><span> </span><a href="#local-6989586621679138934"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679138927"><span class="hs-identifier hs-var">remoteAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>          </span><a href="#local-6989586621679138931"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679138935"><span class="hs-identifier hs-var">unmask</span></a><span> </span><a href="#local-6989586621679138934"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679138938"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">--</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- Internal API</span><span>
</span><a name="line-182"></a><span class="hs-comment">--</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- | GADT which classifies connection result.</span><span>
</span><a name="line-186"></a><span class="hs-comment">--</span><span>
</span><a name="line-187"></a><span class="hs-keyword">data</span><span> </span><a name="ConnectResult"><a href="Ouroboros.Network.Subscription.Worker.html#ConnectResult"><span class="hs-identifier">ConnectResult</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-188"></a><span>      </span><a name="ConnectSuccess"><a href="Ouroboros.Network.Subscription.Worker.html#ConnectSuccess"><span class="hs-identifier">ConnectSuccess</span></a></a><span>
</span><a name="line-189"></a><span>    </span><span class="hs-comment">-- ^ Successful connection.</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="ConnectSuccessLast"><a href="Ouroboros.Network.Subscription.Worker.html#ConnectSuccessLast"><span class="hs-identifier">ConnectSuccessLast</span></a></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-comment">-- ^ Successfully connection, reached the valency target.  Other ongoing</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-comment">-- connection attempts will be killed.</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="ConnectValencyExceeded"><a href="Ouroboros.Network.Subscription.Worker.html#ConnectValencyExceeded"><span class="hs-identifier">ConnectValencyExceeded</span></a></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-comment">-- ^ Someone else manged to create the final connection to a target before</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-comment">-- us.</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">-- | Traverse 'SubscriptionTarget's in an infinite loop.</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-identifier">subscriptionLoop</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138910"><a href="#local-6989586621679138910"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138911"><a href="#local-6989586621679138911"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138912"><a href="#local-6989586621679138912"><span class="hs-identifier">sock</span></a></a><span> </span><a name="local-6989586621679138913"><a href="#local-6989586621679138913"><span class="hs-identifier">localAddrs</span></a></a><span> </span><a name="local-6989586621679138914"><a href="#local-6989586621679138914"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138915"><a href="#local-6989586621679138915"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679138916"><a href="#local-6989586621679138916"><span class="hs-identifier">x</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-202"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-203"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadFork.html#MonadFork"><span class="hs-identifier hs-type">MonadFork</span></a><span>  </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-204"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadMask"><span class="hs-identifier hs-type">MonadMask</span></a><span>  </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-205"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span>   </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-206"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#MonadTime"><span class="hs-identifier hs-type">MonadTime</span></a><span>  </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-207"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-208"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFix</span><span>   </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-209"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-211"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-212"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span>              </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier hs-type">SubscriptionTrace</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>    </span><span class="hs-comment">-- various state variables of the subscription loop</span><span>
</span><a name="line-216"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ConnectionTable"><span class="hs-identifier hs-type">ConnectionTable</span></a><span>     </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>   </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-217"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ResultQ"><span class="hs-identifier hs-type">ResultQ</span></a><span>             </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>   </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679138915"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-218"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#StateVar"><span class="hs-identifier hs-type">StateVar</span></a><span>            </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138911"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-219"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ThreadsVar"><span class="hs-identifier hs-type">ThreadsVar</span></a><span>          </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a><span>             </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138912"><span class="hs-identifier hs-type">sock</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier hs-type">WorkerCallbacks</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138911"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138915"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679138916"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier hs-type">WorkerParams</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138913"><span class="hs-identifier hs-type">localAddrs</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-225"></a><span>    </span><span class="hs-comment">-- ^ given a remote address, pick the local one</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138912"><span class="hs-identifier hs-type">sock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138915"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-comment">-- ^ application</span><span>
</span><a name="line-228"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Void</span><span>
</span><a name="line-229"></a><a name="subscriptionLoop"><a href="Ouroboros.Network.Subscription.Worker.html#subscriptionLoop"><span class="hs-identifier">subscriptionLoop</span></a></a><span>
</span><a name="line-230"></a><span>      </span><a name="local-6989586621679138939"><a href="#local-6989586621679138939"><span class="hs-identifier">tr</span></a></a><span> </span><a name="local-6989586621679138940"><a href="#local-6989586621679138940"><span class="hs-identifier">tbl</span></a></a><span> </span><a name="local-6989586621679138941"><a href="#local-6989586621679138941"><span class="hs-identifier">resQ</span></a></a><span> </span><a name="local-6989586621679138942"><a href="#local-6989586621679138942"><span class="hs-identifier">sVar</span></a></a><span> </span><a name="local-6989586621679138943"><a href="#local-6989586621679138943"><span class="hs-identifier">threadsVar</span></a></a><span> </span><a name="local-6989586621679138944"><a href="#local-6989586621679138944"><span class="hs-identifier">snocket</span></a></a><span>
</span><a name="line-231"></a><span>      </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier hs-var">WorkerCallbacks</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wcSocketStateChangeTx</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679138945"><a href="#local-6989586621679138945"><span class="hs-identifier">socketStateChangeTx</span></a></a><span>
</span><a name="line-232"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wcCompleteApplicationTx</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679138946"><a href="#local-6989586621679138946"><span class="hs-identifier">completeApplicationTx</span></a></a><span>
</span><a name="line-233"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-234"></a><span>      </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier hs-var">WorkerParams</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wpLocalAddresses</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679138947"><a href="#local-6989586621679138947"><span class="hs-identifier">localAddresses</span></a></a><span>
</span><a name="line-235"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wpConnectionAttemptDelay</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679138948"><a href="#local-6989586621679138948"><span class="hs-identifier">connectionAttemptDelay</span></a></a><span>
</span><a name="line-236"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wpSubscriptionTarget</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679138949"><a href="#local-6989586621679138949"><span class="hs-identifier">subscriptionTargets</span></a></a><span>
</span><a name="line-237"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wpValency</span><span>                </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679138950"><a href="#local-6989586621679138950"><span class="hs-identifier">valency</span></a></a><span>
</span><a name="line-238"></a><span>                   </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679138951"><a href="#local-6989586621679138951"><span class="hs-identifier">wpSelectAddress</span></a></a><span>
</span><a name="line-239"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-240"></a><span>      </span><a name="local-6989586621679138952"><a href="#local-6989586621679138952"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-241"></a><span>    </span><a name="local-6989586621679139001"><a href="#local-6989586621679139001"><span class="hs-identifier">valencyVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#newValencyCounter"><span class="hs-identifier hs-var">newValencyCounter</span></a><span> </span><a href="#local-6989586621679138940"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="#local-6989586621679138950"><span class="hs-identifier hs-var">valency</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>    </span><span class="hs-comment">-- outer loop: set new 'conThread' variable, get targets and traverse</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-comment">-- through them trying to connect to each addr.</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-identifier hs-var">forever</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-246"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceStart"><span class="hs-identifier hs-var">SubscriptionTraceStart</span></a><span> </span><a href="#local-6989586621679138950"><span class="hs-identifier hs-var">valency</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>      </span><a name="local-6989586621679139002"><a href="#local-6989586621679139002"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a><span>
</span><a name="line-248"></a><span>      </span><a name="local-6989586621679139003"><a href="#local-6989586621679139003"><span class="hs-identifier">conThreads</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newTVar"><span class="hs-identifier hs-var">newTVar</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-249"></a><span>      </span><a name="local-6989586621679139004"><a href="#local-6989586621679139004"><span class="hs-identifier">sTarget</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679138949"><span class="hs-identifier hs-var">subscriptionTargets</span></a><span>
</span><a name="line-250"></a><span>      </span><a href="#local-6989586621679138953"><span class="hs-identifier hs-var">innerLoop</span></a><span> </span><a href="#local-6989586621679139003"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><a href="#local-6989586621679139001"><span class="hs-identifier hs-var">valencyVar</span></a><span> </span><a href="#local-6989586621679139004"><span class="hs-identifier hs-var">sTarget</span></a><span>
</span><a name="line-251"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#waitValencyCounter"><span class="hs-identifier hs-var">waitValencyCounter</span></a><span> </span><a href="#local-6989586621679139001"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>      </span><span class="hs-comment">-- We always wait at least 'ipRetryDelay' seconds between calls to</span><span>
</span><a name="line-254"></a><span>      </span><span class="hs-comment">-- 'getTargets', and before trying to restart the subscriptions we also</span><span>
</span><a name="line-255"></a><span>      </span><span class="hs-comment">-- wait 1 second so that if multiple subscription targets fail around the</span><span>
</span><a name="line-256"></a><span>      </span><span class="hs-comment">-- same time we will try to restart with a valency</span><span>
</span><a name="line-257"></a><span>      </span><span class="hs-comment">-- higher than 1.</span><span>
</span><a name="line-258"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#threadDelay"><span class="hs-identifier hs-var">threadDelay</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-259"></a><span>      </span><a name="local-6989586621679139005"><a href="#local-6989586621679139005"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a><span>
</span><a name="line-260"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679139006"><a href="#local-6989586621679139006"><span class="hs-identifier">duration</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#diffTime"><span class="hs-identifier hs-var">diffTime</span></a><span> </span><a href="#local-6989586621679139005"><span class="hs-identifier hs-var">end</span></a><span> </span><a href="#local-6989586621679139002"><span class="hs-identifier hs-var">start</span></a><span>
</span><a name="line-261"></a><span>      </span><a name="local-6989586621679139007"><a href="#local-6989586621679139007"><span class="hs-identifier">currentValency</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#readValencyCounter"><span class="hs-identifier hs-var">readValencyCounter</span></a><span> </span><a href="#local-6989586621679139001"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-262"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceRestart"><span class="hs-identifier hs-var">SubscriptionTraceRestart</span></a><span> </span><a href="#local-6989586621679139006"><span class="hs-identifier hs-var">duration</span></a><span> </span><a href="#local-6989586621679138950"><span class="hs-identifier hs-var">valency</span></a><span>
</span><a name="line-263"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621679138950"><span class="hs-identifier hs-var">valency</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679139007"><span class="hs-identifier hs-var">currentValency</span></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679139006"><span class="hs-identifier hs-var">duration</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ipRetryDelay"><span class="hs-identifier hs-var">ipRetryDelay</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-266"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#threadDelay"><span class="hs-identifier hs-var">threadDelay</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ipRetryDelay"><span class="hs-identifier hs-var">ipRetryDelay</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679139006"><span class="hs-identifier hs-var">duration</span></a><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-comment">-- a single run through @sTarget :: SubcriptionTarget m addr@.</span><span>
</span><a name="line-270"></a><span>    </span><span class="hs-identifier">innerLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ValencyCounter"><span class="hs-identifier hs-type">ValencyCounter</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-272"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-273"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>    </span><a name="local-6989586621679138953"><a href="#local-6989586621679138953"><span class="hs-identifier">innerLoop</span></a></a><span> </span><a name="local-6989586621679138957"><a href="#local-6989586621679138957"><span class="hs-identifier">conThreads</span></a></a><span> </span><a name="local-6989586621679138958"><a href="#local-6989586621679138958"><span class="hs-identifier">valencyVar</span></a></a><span> </span><a name="local-6989586621679138959"><a href="#local-6989586621679138959"><span class="hs-identifier">sTarget</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-275"></a><span>      </span><a name="local-6989586621679138960"><a href="#local-6989586621679138960"><span class="hs-identifier">mt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getSubscriptionTarget</span><span> </span><a href="#local-6989586621679138959"><span class="hs-identifier hs-var">sTarget</span></a><span>
</span><a name="line-276"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138960"><span class="hs-identifier hs-var">mt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-278"></a><span>          </span><a name="local-6989586621679138961"><a href="#local-6989586621679138961"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138957"><span class="hs-identifier hs-var">conThreads</span></a><span>
</span><a name="line-279"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138961"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-280"></a><span>              </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionWaiting"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionWaiting</span></a><span> </span><a href="#local-6989586621679138961"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>          </span><span class="hs-comment">-- We wait on the list of active connection threads instead of using</span><span>
</span><a name="line-283"></a><span>          </span><span class="hs-comment">-- an async wait function since some of the connections may succeed</span><span>
</span><a name="line-284"></a><span>          </span><span class="hs-comment">-- and then should be left running.</span><span>
</span><a name="line-285"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-286"></a><span>          </span><span class="hs-comment">-- Note: active connections are removed from 'conThreads' when the</span><span>
</span><a name="line-287"></a><span>          </span><span class="hs-comment">-- 'connect' call finishes.</span><span>
</span><a name="line-288"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>              </span><a name="local-6989586621679138962"><a href="#local-6989586621679138962"><span class="hs-identifier">activeCons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138957"><span class="hs-identifier hs-var">conThreads</span></a><span>
</span><a name="line-290"></a><span>              </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679138962"><span class="hs-identifier hs-var">activeCons</span></a><span class="hs-special">)</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#retry"><span class="hs-identifier hs-var">retry</span></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>          </span><a name="local-6989586621679138963"><a href="#local-6989586621679138963"><span class="hs-identifier">valencyLeft</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#readValencyCounter"><span class="hs-identifier hs-var">readValencyCounter</span></a><span> </span><a href="#local-6989586621679138958"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-293"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679138963"><span class="hs-identifier hs-var">valencyLeft</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-294"></a><span>             </span><span class="hs-keyword">then</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionRunning"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionRunning</span></a><span>
</span><a name="line-295"></a><span>             </span><span class="hs-keyword">else</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionFailed"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionFailed</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679138964"><a href="#local-6989586621679138964"><span class="hs-identifier">remoteAddr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679138965"><a href="#local-6989586621679138965"><span class="hs-identifier">sTargetNext</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-298"></a><span>          </span><a name="local-6989586621679138966"><a href="#local-6989586621679138966"><span class="hs-identifier">valencyLeft</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#readValencyCounter"><span class="hs-identifier hs-var">readValencyCounter</span></a><span> </span><a href="#local-6989586621679138958"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span>          </span><span class="hs-comment">-- If we have already created enough connections (valencyLeft &lt;= 0)</span><span>
</span><a name="line-301"></a><span>          </span><span class="hs-comment">-- we don't need to traverse the rest of the list.</span><span>
</span><a name="line-302"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679138966"><span class="hs-identifier hs-var">valencyLeft</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-303"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionRunning"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionRunning</span></a><span>
</span><a name="line-304"></a><span>              </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679138954"><span class="hs-identifier hs-var">innerStep</span></a><span> </span><a href="#local-6989586621679138957"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><a href="#local-6989586621679138958"><span class="hs-identifier hs-var">valencyVar</span></a><span> </span><a href="#local-6989586621679138964"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138965"><span class="hs-identifier hs-var">sTargetNext</span></a><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span>    </span><span class="hs-identifier">innerStep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>              </span><span class="hs-comment">-- ^ outstanding connection threads; threads are removed as soon</span><span>
</span><a name="line-308"></a><span>              </span><span class="hs-comment">-- as the connection succeeds.  They are all cancelled when</span><span>
</span><a name="line-309"></a><span>              </span><span class="hs-comment">-- valency drops to 0.  The asynchronous exception which cancels</span><span>
</span><a name="line-310"></a><span>              </span><span class="hs-comment">-- the connection thread can only occur while connecting and not</span><span>
</span><a name="line-311"></a><span>              </span><span class="hs-comment">-- when an application is running.  This is guaranteed since</span><span>
</span><a name="line-312"></a><span>              </span><span class="hs-comment">-- threads are removed from this set as soon connecting is</span><span>
</span><a name="line-313"></a><span>              </span><span class="hs-comment">-- finished (successfully or not) and before application is</span><span>
</span><a name="line-314"></a><span>              </span><span class="hs-comment">-- started.</span><span>
</span><a name="line-315"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ValencyCounter"><span class="hs-identifier hs-type">ValencyCounter</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-316"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-317"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-318"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>    </span><a name="local-6989586621679138954"><a href="#local-6989586621679138954"><span class="hs-identifier">innerStep</span></a></a><span> </span><a name="local-6989586621679138967"><a href="#local-6989586621679138967"><span class="hs-identifier">conThreads</span></a></a><span> </span><a name="local-6989586621679138968"><a href="#local-6989586621679138968"><span class="hs-identifier">valencyVar</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679138969"><a href="#local-6989586621679138969"><span class="hs-identifier">remoteAddr</span></a></a><span> </span><a name="local-6989586621679138970"><a href="#local-6989586621679138970"><span class="hs-identifier">sTargetNext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-320"></a><span>      </span><a name="local-6989586621679138971"><a href="#local-6989586621679138971"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#refConnection"><span class="hs-identifier hs-var">refConnection</span></a><span> </span><a href="#local-6989586621679138940"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138968"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-321"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138971"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-322"></a><span>        </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ConnectionTableCreate"><span class="hs-identifier hs-var">ConnectionTableCreate</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-323"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138951"><span class="hs-identifier hs-var">wpSelectAddress</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138947"><span class="hs-identifier hs-var">localAddresses</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-324"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-325"></a><span>              </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceUnsupportedRemoteAddr"><span class="hs-identifier hs-var">SubscriptionTraceUnsupportedRemoteAddr</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>            </span><span class="hs-comment">-- This part is very similar to</span><span>
</span><a name="line-328"></a><span>            </span><span class="hs-comment">-- 'Ouroboros.Network.Server.Socket.spawnOne', it should not</span><span>
</span><a name="line-329"></a><span>            </span><span class="hs-comment">-- deadlock by the same reasons.  The difference is that we are</span><span>
</span><a name="line-330"></a><span>            </span><span class="hs-comment">-- using 'mask' and 'async' as 'asyncWithUnmask' is not available.</span><span>
</span><a name="line-331"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679138972"><a href="#local-6989586621679138972"><span class="hs-identifier">localAddr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-332"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">rec</span><span>
</span><a name="line-333"></a><span>                  </span><a name="local-6989586621679138973"><a href="#local-6989586621679138973"><span class="hs-identifier">thread</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#async"><span class="hs-identifier hs-var">async</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-334"></a><span>                    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectStart"><span class="hs-identifier hs-var">SubscriptionTraceConnectStart</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span>
</span><a name="line-335"></a><span>                    </span><span class="hs-comment">-- Try to connect; 'safeConnect' is using 'bracket' to</span><span>
</span><a name="line-336"></a><span>                    </span><span class="hs-comment">-- create / close a socket and update the states.  The</span><span>
</span><a name="line-337"></a><span>                    </span><span class="hs-comment">-- continuation, e.g.  'connAction' runs with async</span><span>
</span><a name="line-338"></a><span>                    </span><span class="hs-comment">-- exceptions masked, and receives the unmask function from</span><span>
</span><a name="line-339"></a><span>                    </span><span class="hs-comment">-- this bracket.</span><span>
</span><a name="line-340"></a><span>                    </span><a href="Ouroboros.Network.Subscription.Worker.html#safeConnect"><span class="hs-identifier hs-var">safeConnect</span></a><span>
</span><a name="line-341"></a><span>                      </span><a href="#local-6989586621679138944"><span class="hs-identifier hs-var">snocket</span></a><span>
</span><a name="line-342"></a><span>                      </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span>
</span><a name="line-343"></a><span>                      </span><a href="#local-6989586621679138972"><span class="hs-identifier hs-var">localAddr</span></a><span>
</span><a name="line-344"></a><span>                      </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>                        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceAllocateSocket"><span class="hs-identifier hs-var">SubscriptionTraceAllocateSocket</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span>
</span><a name="line-346"></a><span>                        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-347"></a><span>                          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a><span> </span><a href="#local-6989586621679138967"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.insert</span><span> </span><a href="#local-6989586621679138973"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>                          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a><span> </span><a href="#local-6989586621679138943"><span class="hs-identifier hs-var">threadsVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.insert</span><span> </span><a href="#local-6989586621679138973"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>                          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span>
</span><a name="line-350"></a><span>                            </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679138945"><span class="hs-identifier hs-var">socketStateChangeTx</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#CreatedSocket"><span class="hs-identifier hs-var">CreatedSocket</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138973"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>                            </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span> </span><span class="hs-operator hs-var">$!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>                      </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>                        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-354"></a><span>                          </span><span class="hs-comment">-- The thread is removed from 'conThreads'</span><span>
</span><a name="line-355"></a><span>                          </span><span class="hs-comment">-- inside 'connAction'.</span><span>
</span><a name="line-356"></a><span>                          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a><span> </span><a href="#local-6989586621679138943"><span class="hs-identifier hs-var">threadsVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679138973"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>                          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span>
</span><a name="line-358"></a><span>                            </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679138945"><span class="hs-identifier hs-var">socketStateChangeTx</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#ClosedSocket"><span class="hs-identifier hs-var">ClosedSocket</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138973"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>                            </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span> </span><span class="hs-operator hs-var">$!</span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>                        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceCloseSocket"><span class="hs-identifier hs-var">SubscriptionTraceCloseSocket</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621679138955"><span class="hs-identifier hs-var">connAction</span></a><span>
</span><a name="line-362"></a><span>                        </span><a href="#local-6989586621679138973"><span class="hs-identifier hs-var">thread</span></a><span> </span><a href="#local-6989586621679138967"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><a href="#local-6989586621679138968"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-363"></a><span>                        </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679138974"><a href="#local-6989586621679138974"><span class="hs-identifier">delay</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138948"><span class="hs-identifier hs-var">connectionAttemptDelay</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-366"></a><span>                                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679138975"><a href="#local-6989586621679138975"><span class="hs-identifier">d</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138975"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#minConnectionAttemptDelay"><span class="hs-identifier hs-var">minConnectionAttemptDelay</span></a><span>
</span><a name="line-367"></a><span>                                             </span><span class="hs-special">`</span><span class="hs-identifier hs-var">min</span><span class="hs-special">`</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#maxConnectionAttemptDelay"><span class="hs-identifier hs-var">maxConnectionAttemptDelay</span></a><span>
</span><a name="line-368"></a><span>                                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#defaultConnectionAttemptDelay"><span class="hs-identifier hs-var">defaultConnectionAttemptDelay</span></a><span>
</span><a name="line-369"></a><span>                </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span>
</span><a name="line-370"></a><span>                          </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionWaitingNewConnection"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionWaitingNewConnection</span></a><span> </span><a href="#local-6989586621679138974"><span class="hs-identifier hs-var">delay</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>                </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#threadDelay"><span class="hs-identifier hs-var">threadDelay</span></a><span> </span><a href="#local-6989586621679138974"><span class="hs-identifier hs-var">delay</span></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>        </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ConnectionTableExist"><span class="hs-identifier hs-var">ConnectionTableExist</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-374"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectionExist"><span class="hs-identifier hs-var">SubscriptionTraceConnectionExist</span></a><span> </span><a href="#local-6989586621679138969"><span class="hs-identifier hs-var">remoteAddr</span></a><span>
</span><a name="line-375"></a><span>        </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ConnectionTableDuplicate"><span class="hs-identifier hs-var">ConnectionTableDuplicate</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>      </span><a href="#local-6989586621679138953"><span class="hs-identifier hs-var">innerLoop</span></a><span> </span><a href="#local-6989586621679138967"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><a href="#local-6989586621679138968"><span class="hs-identifier hs-var">valencyVar</span></a><span> </span><a href="#local-6989586621679138970"><span class="hs-identifier hs-var">sTargetNext</span></a><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span>    </span><span class="hs-comment">-- Start connection thread: connect to the remote peer, run application.</span><span>
</span><a name="line-379"></a><span>    </span><span class="hs-comment">-- This function runs with asynchronous exceptions masked.</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-identifier">connAction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ValencyCounter"><span class="hs-identifier hs-type">ValencyCounter</span></a><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-384"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138914"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-385"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138956"><a href="#local-6989586621679138956"><span class="hs-identifier">y</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138956"><span class="hs-identifier hs-type">y</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138956"><span class="hs-identifier hs-type">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- unmask exceptions</span><span>
</span><a name="line-386"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138912"><span class="hs-identifier hs-type">sock</span></a><span>
</span><a name="line-387"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138910"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>    </span><a name="local-6989586621679138955"><a href="#local-6989586621679138955"><span class="hs-identifier">connAction</span></a></a><span> </span><a name="local-6989586621679138976"><a href="#local-6989586621679138976"><span class="hs-identifier">thread</span></a></a><span> </span><a name="local-6989586621679138977"><a href="#local-6989586621679138977"><span class="hs-identifier">conThreads</span></a></a><span> </span><a name="local-6989586621679138978"><a href="#local-6989586621679138978"><span class="hs-identifier">valencyVar</span></a></a><span> </span><a name="local-6989586621679138979"><a href="#local-6989586621679138979"><span class="hs-identifier">remoteAddr</span></a></a><span> </span><a name="local-6989586621679138980"><a href="#local-6989586621679138980"><span class="hs-identifier">unmask</span></a></a><span> </span><a name="local-6989586621679138981"><a href="#local-6989586621679138981"><span class="hs-identifier">sock</span></a></a><span> </span><a name="local-6989586621679138982"><a href="#local-6989586621679138982"><span class="hs-identifier">connectionRes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-390"></a><span>      </span><a name="local-6989586621679138983"><a href="#local-6989586621679138983"><span class="hs-identifier">localAddr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">Snocket.getLocalAddr</span><span> </span><a href="#local-6989586621679138944"><span class="hs-identifier hs-var">snocket</span></a><span> </span><a href="#local-6989586621679138981"><span class="hs-identifier hs-var">sock</span></a><span>
</span><a name="line-391"></a><span>      </span><a name="local-6989586621679138984"><a href="#local-6989586621679138984"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a><span>
</span><a name="line-392"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138982"><span class="hs-identifier hs-var">connectionRes</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-393"></a><span>        </span><span class="hs-comment">-- connection error</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SomeException</span><span> </span><a name="local-6989586621679138985"><a href="#local-6989586621679138985"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-395"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectException"><span class="hs-identifier hs-var">SubscriptionTraceConnectException</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138985"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-396"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-397"></a><span>            </span><span class="hs-comment">-- remove thread from active connections threads</span><span>
</span><a name="line-398"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a><span> </span><a href="#local-6989586621679138977"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679138976"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span>            </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplicationResult"><span class="hs-identifier hs-var">CompleteApplicationResult</span></a><span>
</span><a name="line-401"></a><span>              </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679138986"><a href="#local-6989586621679138986"><span class="hs-identifier">carState</span></a></a><span>
</span><a name="line-402"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679138987"><a href="#local-6989586621679138987"><span class="hs-identifier">carThreads</span></a></a><span>
</span><a name="line-403"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679138988"><a href="#local-6989586621679138988"><span class="hs-identifier">carTrace</span></a></a><span>
</span><a name="line-404"></a><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679138946"><span class="hs-identifier hs-var">completeApplicationTx</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#ConnectionError"><span class="hs-identifier hs-var">ConnectionError</span></a><span> </span><a href="#local-6989586621679138984"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138985"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span> </span><a href="#local-6989586621679138986"><span class="hs-identifier hs-var">carState</span></a><span>
</span><a name="line-406"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTQueue"><span class="hs-identifier hs-var">writeTQueue</span></a><span> </span><a href="#local-6989586621679138941"><span class="hs-identifier hs-var">resQ</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#Act"><span class="hs-identifier hs-var">Act</span></a><span> </span><a href="#local-6989586621679138987"><span class="hs-identifier hs-var">carThreads</span></a><span> </span><a href="#local-6989586621679138988"><span class="hs-identifier hs-var">carTrace</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-comment">-- connection succeeded</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-410"></a><span>          </span><a name="local-6989586621679138993"><a href="#local-6989586621679138993"><span class="hs-identifier">connRes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>            </span><span class="hs-comment">-- we successfully connected, remove the thread from</span><span>
</span><a name="line-412"></a><span>            </span><span class="hs-comment">-- outstanding connection threads.</span><span>
</span><a name="line-413"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#modifyTVar"><span class="hs-identifier hs-var">modifyTVar</span></a><span> </span><a href="#local-6989586621679138977"><span class="hs-identifier hs-var">conThreads</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679138976"><span class="hs-identifier hs-var">thread</span></a><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>            </span><a name="local-6989586621679138989"><a href="#local-6989586621679138989"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#readValencyCounter"><span class="hs-identifier hs-var">readValencyCounter</span></a><span> </span><a href="#local-6989586621679138978"><span class="hs-identifier hs-var">valencyVar</span></a><span>
</span><a name="line-416"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679138989"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-417"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-418"></a><span>                </span><a href="Ouroboros.Network.Server.ConnectionTable.html#addConnection"><span class="hs-identifier hs-var">addConnection</span></a><span> </span><a href="#local-6989586621679138940"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138983"><span class="hs-identifier hs-var">localAddr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679138978"><span class="hs-identifier hs-var">valencyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>                </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplicationResult"><span class="hs-identifier hs-var">CompleteApplicationResult</span></a><span>
</span><a name="line-420"></a><span>                  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679138990"><a href="#local-6989586621679138990"><span class="hs-identifier">carState</span></a></a><span>
</span><a name="line-421"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679138991"><a href="#local-6989586621679138991"><span class="hs-identifier">carThreads</span></a></a><span>
</span><a name="line-422"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679138992"><a href="#local-6989586621679138992"><span class="hs-identifier">carTrace</span></a></a><span>
</span><a name="line-423"></a><span>                  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679138946"><span class="hs-identifier hs-var">completeApplicationTx</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#Connected"><span class="hs-identifier hs-var">Connected</span></a><span> </span><a href="#local-6989586621679138984"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679138942"><span class="hs-identifier hs-var">sVar</span></a><span> </span><a href="#local-6989586621679138990"><span class="hs-identifier hs-var">carState</span></a><span>
</span><a name="line-425"></a><span>                </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTQueue"><span class="hs-identifier hs-var">writeTQueue</span></a><span> </span><a href="#local-6989586621679138941"><span class="hs-identifier hs-var">resQ</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#Act"><span class="hs-identifier hs-var">Act</span></a><span> </span><a href="#local-6989586621679138991"><span class="hs-identifier hs-var">carThreads</span></a><span> </span><a href="#local-6989586621679138992"><span class="hs-identifier hs-var">carTrace</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679138989"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-427"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectSuccessLast"><span class="hs-identifier hs-var">ConnectSuccessLast</span></a><span>
</span><a name="line-428"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectSuccess"><span class="hs-identifier hs-var">ConnectSuccess</span></a><span>
</span><a name="line-429"></a><span>              </span><span class="hs-keyword">else</span><span>
</span><a name="line-430"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectValencyExceeded"><span class="hs-identifier hs-var">ConnectValencyExceeded</span></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>          </span><span class="hs-comment">-- handle connection result</span><span>
</span><a name="line-433"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectEnd"><span class="hs-identifier hs-var">SubscriptionTraceConnectEnd</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">connRes</span></a><span>
</span><a name="line-434"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">connRes</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-435"></a><span>            </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectValencyExceeded"><span class="hs-identifier hs-var">ConnectValencyExceeded</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>            </span><span class="hs-comment">-- otherwise it was a success</span><span>
</span><a name="line-437"></a><span>            </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-438"></a><span>              </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138993"><span class="hs-identifier hs-var">connRes</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectSuccessLast"><span class="hs-identifier hs-var">ConnectSuccessLast</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-439"></a><span>                </span><span class="hs-comment">-- outstanding connection threads</span><span>
</span><a name="line-440"></a><span>                </span><a name="local-6989586621679138994"><a href="#local-6989586621679138994"><span class="hs-identifier">threads</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679138977"><span class="hs-identifier hs-var">conThreads</span></a><span>
</span><a name="line-441"></a><span>                </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679138995"><a href="#local-6989586621679138995"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-442"></a><span>                        </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#cancelWith"><span class="hs-identifier hs-var">cancelWith</span></a><span> </span><a href="#local-6989586621679138995"><span class="hs-identifier hs-var">tid</span></a><span>
</span><a name="line-443"></a><span>                        </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier hs-var">SubscriberError</span></a><span>
</span><a name="line-444"></a><span>                          </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberParrallelConnectionCancelled"><span class="hs-identifier hs-var">SubscriberParrallelConnectionCancelled</span></a><span>
</span><a name="line-445"></a><span>                          </span><span class="hs-string">&quot;Parrallel connection cancelled&quot;</span><span>
</span><a name="line-446"></a><span>                          </span><span class="hs-identifier hs-var">callStack</span><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>                      </span><span class="hs-special">)</span><a href="#local-6989586621679138994"><span class="hs-identifier hs-var">threads</span></a><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>              </span><span class="hs-comment">-- run application</span><span>
</span><a name="line-451"></a><span>              </span><a name="local-6989586621679138996"><a href="#local-6989586621679138996"><span class="hs-identifier">appRes</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679138915"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-452"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#try"><span class="hs-identifier hs-var">try</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679138980"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138952"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679138981"><span class="hs-identifier hs-var">sock</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138996"><span class="hs-identifier hs-var">appRes</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-455"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679138997"><a href="#local-6989586621679138997"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679138939"><span class="hs-identifier hs-var">tr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceApplicationException"><span class="hs-identifier hs-var">SubscriptionTraceApplicationException</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138997"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>              </span><a name="local-6989586621679138998"><a href="#local-6989586621679138998"><span class="hs-identifier">t'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a><span>
</span><a name="line-459"></a><span>              </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-460"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679138996"><span class="hs-identifier hs-var">appRes</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-461"></a><span>                  </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679138999"><a href="#local-6989586621679138999"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-462"></a><span>                    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTQueue"><span class="hs-identifier hs-var">writeTQueue</span></a><span> </span><a href="#local-6989586621679138941"><span class="hs-identifier hs-var">resQ</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#Res"><span class="hs-identifier hs-var">Res</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#ApplicationResult"><span class="hs-identifier hs-var">ApplicationResult</span></a><span> </span><a href="#local-6989586621679138998"><span class="hs-identifier hs-var">t'</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138999"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>                  </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SomeException</span><span> </span><a name="local-6989586621679139000"><a href="#local-6989586621679139000"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-464"></a><span>                    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#writeTQueue"><span class="hs-identifier hs-var">writeTQueue</span></a><span> </span><a href="#local-6989586621679138941"><span class="hs-identifier hs-var">resQ</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#Res"><span class="hs-identifier hs-var">Res</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#ApplicationError"><span class="hs-identifier hs-var">ApplicationError</span></a><span> </span><a href="#local-6989586621679138998"><span class="hs-identifier hs-var">t'</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679139000"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>                </span><a href="Ouroboros.Network.Server.ConnectionTable.html#removeConnectionSTM"><span class="hs-identifier hs-var">removeConnectionSTM</span></a><span> </span><a href="#local-6989586621679138940"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="#local-6989586621679138979"><span class="hs-identifier hs-var">remoteAddr</span></a><span> </span><a href="#local-6989586621679138983"><span class="hs-identifier hs-var">localAddr</span></a><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-comment">-- | Almost the same as 'Ouroboros.Network.Server.Socket.mainLoop'.</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- 'mainLoop' reads from the result queue and runs the 'CompleteApplication'</span><span>
</span><a name="line-469"></a><span class="hs-comment">-- callback.</span><span>
</span><a name="line-470"></a><span class="hs-comment">--</span><span>
</span><a name="line-471"></a><span class="hs-identifier">mainLoop</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138906"><a href="#local-6989586621679138906"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138907"><a href="#local-6989586621679138907"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679138908"><a href="#local-6989586621679138908"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138909"><a href="#local-6989586621679138909"><span class="hs-identifier">t</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-473"></a><span>     </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a><span> </span><a href="#local-6989586621679138908"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a><span class="hs-special">)</span><span>
</span><a name="line-474"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ResultQ"><span class="hs-identifier hs-type">ResultQ</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138908"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a><span> </span><a href="#local-6989586621679138908"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679138907"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-475"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ThreadsVar"><span class="hs-identifier hs-type">ThreadsVar</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span>
</span><a name="line-476"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#StateVar"><span class="hs-identifier hs-type">StateVar</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138906"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-477"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplication"><span class="hs-identifier hs-type">CompleteApplication</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138906"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138908"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138907"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-478"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#Main"><span class="hs-identifier hs-type">Main</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138906"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138909"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-479"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138909"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-480"></a><a name="mainLoop"><a href="Ouroboros.Network.Subscription.Worker.html#mainLoop"><span class="hs-identifier">mainLoop</span></a></a><span> </span><a name="local-6989586621679139008"><a href="#local-6989586621679139008"><span class="hs-identifier">errorPolicyTracer</span></a></a><span> </span><a name="local-6989586621679139009"><a href="#local-6989586621679139009"><span class="hs-identifier">resQ</span></a></a><span> </span><a name="local-6989586621679139010"><a href="#local-6989586621679139010"><span class="hs-identifier">threadsVar</span></a></a><span> </span><a name="local-6989586621679139011"><a href="#local-6989586621679139011"><span class="hs-identifier">statusVar</span></a></a><span> </span><a name="local-6989586621679139012"><a href="#local-6989586621679139012"><span class="hs-identifier">completeApplicationTx</span></a></a><span> </span><a name="local-6989586621679139013"><a href="#local-6989586621679139013"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-481"></a><span>    </span><span class="hs-identifier hs-var">join</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679139014"><span class="hs-identifier hs-var">mainTx</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">STM.orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679139015"><span class="hs-identifier hs-var">connectionTx</span></a><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-483"></a><span>    </span><span class="hs-comment">-- Sample the state, and run the main action. If it does not retry, then</span><span>
</span><a name="line-484"></a><span>    </span><span class="hs-comment">-- the `mainLoop` finishes with `pure t` where `t` is the main action result.</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-identifier">mainTx</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138909"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>    </span><a name="local-6989586621679139014"><a href="#local-6989586621679139014"><span class="hs-identifier">mainTx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-487"></a><span>      </span><a name="local-6989586621679139016"><a href="#local-6989586621679139016"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679139011"><span class="hs-identifier hs-var">statusVar</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679139013"><span class="hs-identifier hs-var">main</span></a><span>
</span><a name="line-488"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679139016"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>    </span><span class="hs-comment">-- Wait for some connection to finish, update the state with its result,</span><span>
</span><a name="line-491"></a><span>    </span><span class="hs-comment">-- then recurse onto `mainLoop`.</span><span>
</span><a name="line-492"></a><span>    </span><span class="hs-identifier">connectionTx</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138909"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-493"></a><span>    </span><a name="local-6989586621679139015"><a href="#local-6989586621679139015"><span class="hs-identifier">connectionTx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-494"></a><span>      </span><a name="local-6989586621679139017"><a href="#local-6989586621679139017"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">STM.readTQueue</span><span> </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">resQ</span></a><span>
</span><a name="line-495"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679139017"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-496"></a><span>        </span><a href="Ouroboros.Network.Subscription.Worker.html#Act"><span class="hs-identifier hs-var">Act</span></a><span> </span><a name="local-6989586621679139018"><a href="#local-6989586621679139018"><span class="hs-identifier">threads</span></a></a><span> </span><a name="local-6989586621679139019"><a href="#local-6989586621679139019"><span class="hs-identifier">tr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-497"></a><span>          </span><span class="hs-identifier hs-var">traverse_</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#cancel"><span class="hs-identifier hs-var">cancel</span></a><span> </span><a href="#local-6989586621679139018"><span class="hs-identifier hs-var">threads</span></a><span>
</span><a name="line-498"></a><span>          </span><span class="hs-identifier hs-var">traverse_</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679139008"><span class="hs-identifier hs-var">errorPolicyTracer</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679139019"><span class="hs-identifier hs-var">tr</span></a><span>
</span><a name="line-499"></a><span>          </span><a href="Ouroboros.Network.Subscription.Worker.html#mainLoop"><span class="hs-identifier hs-var">mainLoop</span></a><span> </span><a href="#local-6989586621679139008"><span class="hs-identifier hs-var">errorPolicyTracer</span></a><span> </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">resQ</span></a><span> </span><a href="#local-6989586621679139010"><span class="hs-identifier hs-var">threadsVar</span></a><span> </span><a href="#local-6989586621679139011"><span class="hs-identifier hs-var">statusVar</span></a><span> </span><a href="#local-6989586621679139012"><span class="hs-identifier hs-var">completeApplicationTx</span></a><span> </span><a href="#local-6989586621679139013"><span class="hs-identifier hs-var">main</span></a><span>
</span><a name="line-500"></a><span>        </span><a href="Ouroboros.Network.Subscription.Worker.html#Res"><span class="hs-identifier hs-var">Res</span></a><span> </span><a name="local-6989586621679139020"><a href="#local-6989586621679139020"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-501"></a><span>          </span><a name="local-6989586621679139021"><a href="#local-6989586621679139021"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679139011"><span class="hs-identifier hs-var">statusVar</span></a><span>
</span><a name="line-502"></a><span>          </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplicationResult"><span class="hs-identifier hs-var">CompleteApplicationResult</span></a><span>
</span><a name="line-503"></a><span>            </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679139022"><a href="#local-6989586621679139022"><span class="hs-identifier">carState</span></a></a><span>
</span><a name="line-504"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679139023"><a href="#local-6989586621679139023"><span class="hs-identifier">carThreads</span></a></a><span>
</span><a name="line-505"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679139024"><a href="#local-6989586621679139024"><span class="hs-identifier">carTrace</span></a></a><span>
</span><a name="line-506"></a><span>            </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679139012"><span class="hs-identifier hs-var">completeApplicationTx</span></a><span> </span><a href="#local-6989586621679139020"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679139021"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-507"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679139011"><span class="hs-identifier hs-var">statusVar</span></a><span> </span><a href="#local-6989586621679139022"><span class="hs-identifier hs-var">carState</span></a><span>
</span><a name="line-508"></a><span>          </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-509"></a><span>            </span><span class="hs-identifier hs-var">traverse_</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#cancel"><span class="hs-identifier hs-var">cancel</span></a><span> </span><a href="#local-6989586621679139023"><span class="hs-identifier hs-var">carThreads</span></a><span>
</span><a name="line-510"></a><span>            </span><span class="hs-identifier hs-var">traverse_</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679139008"><span class="hs-identifier hs-var">errorPolicyTracer</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679139024"><span class="hs-identifier hs-var">carTrace</span></a><span>
</span><a name="line-511"></a><span>            </span><a href="Ouroboros.Network.Subscription.Worker.html#mainLoop"><span class="hs-identifier hs-var">mainLoop</span></a><span> </span><a href="#local-6989586621679139008"><span class="hs-identifier hs-var">errorPolicyTracer</span></a><span> </span><a href="#local-6989586621679139009"><span class="hs-identifier hs-var">resQ</span></a><span> </span><a href="#local-6989586621679139010"><span class="hs-identifier hs-var">threadsVar</span></a><span> </span><a href="#local-6989586621679139011"><span class="hs-identifier hs-var">statusVar</span></a><span> </span><a href="#local-6989586621679139012"><span class="hs-identifier hs-var">completeApplicationTx</span></a><span> </span><a href="#local-6989586621679139013"><span class="hs-identifier hs-var">main</span></a><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-comment">--</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- Worker</span><span>
</span><a name="line-516"></a><span class="hs-comment">--</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-comment">-- | Worker STM callbacks</span><span>
</span><a name="line-519"></a><span class="hs-comment">--</span><span>
</span><a name="line-520"></a><span class="hs-keyword">data</span><span> </span><a name="WorkerCallbacks"><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier">WorkerCallbacks</span></a></a><span> </span><a name="local-6989586621679138728"><a href="#local-6989586621679138728"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138729"><a href="#local-6989586621679138729"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138730"><a href="#local-6989586621679138730"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138731"><a href="#local-6989586621679138731"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679138732"><a href="#local-6989586621679138732"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WorkerCallbacks"><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier">WorkerCallbacks</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-521"></a><span>    </span><a name="wcSocketStateChangeTx"><a href="Ouroboros.Network.Subscription.Worker.html#wcSocketStateChangeTx"><span class="hs-identifier">wcSocketStateChangeTx</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SocketStateChange"><span class="hs-identifier hs-type">SocketStateChange</span></a><span> </span><a href="#local-6989586621679138728"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138729"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138730"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">,</span><span>
</span><a name="line-522"></a><span>    </span><a name="wcCompleteApplicationTx"><a href="Ouroboros.Network.Subscription.Worker.html#wcCompleteApplicationTx"><span class="hs-identifier">wcCompleteApplicationTx</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#CompleteApplication"><span class="hs-identifier hs-type">CompleteApplication</span></a><span> </span><a href="#local-6989586621679138728"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138729"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138730"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138731"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span>
</span><a name="line-523"></a><span>    </span><a name="wcMainTx"><a href="Ouroboros.Network.Subscription.Worker.html#wcMainTx"><span class="hs-identifier">wcMainTx</span></a></a><span>                </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#Main"><span class="hs-identifier hs-type">Main</span></a><span> </span><a href="#local-6989586621679138728"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138729"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138732"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span class="hs-comment">-- | Worker parameters</span><span>
</span><a name="line-527"></a><span class="hs-comment">--</span><span>
</span><a name="line-528"></a><span class="hs-keyword">data</span><span> </span><a name="WorkerParams"><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier">WorkerParams</span></a></a><span> </span><a name="local-6989586621679138725"><a href="#local-6989586621679138725"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679138726"><a href="#local-6989586621679138726"><span class="hs-identifier">localAddrs</span></a></a><span> </span><a name="local-6989586621679138727"><a href="#local-6989586621679138727"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WorkerParams"><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier">WorkerParams</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-529"></a><span>    </span><a name="wpLocalAddresses"><a href="Ouroboros.Network.Subscription.Worker.html#wpLocalAddresses"><span class="hs-identifier">wpLocalAddresses</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679138726"><span class="hs-identifier hs-type">localAddrs</span></a><span> </span><a href="#local-6989586621679138727"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">,</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-comment">-- ^ local addresses of the server</span><span>
</span><a name="line-531"></a><span>    </span><a name="wpSelectAddress"><a href="Ouroboros.Network.Subscription.Worker.html#wpSelectAddress"><span class="hs-identifier">wpSelectAddress</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679138727"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679138726"><span class="hs-identifier hs-type">localAddrs</span></a><span> </span><a href="#local-6989586621679138727"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679138727"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">,</span><span>
</span><a name="line-532"></a><span>    </span><span class="hs-comment">-- ^ given remote addr pick the local address </span><span>
</span><a name="line-533"></a><span>    </span><a name="wpConnectionAttemptDelay"><a href="Ouroboros.Network.Subscription.Worker.html#wpConnectionAttemptDelay"><span class="hs-identifier">wpConnectionAttemptDelay</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679138727"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">,</span><span>
</span><a name="line-534"></a><span>    </span><span class="hs-comment">-- ^ delay after a connection attempt to 'addr'</span><span>
</span><a name="line-535"></a><span>    </span><a name="wpSubscriptionTarget"><a href="Ouroboros.Network.Subscription.Worker.html#wpSubscriptionTarget"><span class="hs-identifier">wpSubscriptionTarget</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679138725"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Subscriber.html#SubscriptionTarget"><span class="hs-identifier hs-type">SubscriptionTarget</span></a><span> </span><a href="#local-6989586621679138725"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679138727"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-536"></a><span>    </span><a name="wpValency"><a href="Ouroboros.Network.Subscription.Worker.html#wpValency"><span class="hs-identifier">wpValency</span></a></a><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-537"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-comment">-- |  This is the most abstract worker, which puts all the pieces together.  It</span><span>
</span><a name="line-540"></a><span class="hs-comment">-- will execute until @main :: Main m s t@ returns.  It runs</span><span>
</span><a name="line-541"></a><span class="hs-comment">-- 'subscriptionLoop' in a new threads and will exit when it dies.  Spawn</span><span>
</span><a name="line-542"></a><span class="hs-comment">-- threads are cancelled in a 'finally' callback by throwing 'SubscriberError'.</span><span>
</span><a name="line-543"></a><span class="hs-comment">--</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- Note: This function runs in 'IO' only because 'MonadSTM' does not yet support</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- 'orElse', PR #432.</span><span>
</span><a name="line-546"></a><span class="hs-comment">--</span><span>
</span><a name="line-547"></a><span class="hs-identifier">worker</span><span>
</span><a name="line-548"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138900"><a href="#local-6989586621679138900"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679138901"><a href="#local-6989586621679138901"><span class="hs-identifier">sock</span></a></a><span> </span><a name="local-6989586621679138902"><a href="#local-6989586621679138902"><span class="hs-identifier">localAddrs</span></a></a><span> </span><a name="local-6989586621679138903"><a href="#local-6989586621679138903"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138904"><a href="#local-6989586621679138904"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679138905"><a href="#local-6989586621679138905"><span class="hs-identifier">x</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-549"></a><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-550"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-551"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span>              </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier hs-type">SubscriptionTrace</span></a><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span>              </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ErrorPolicy.html#WithAddr"><span class="hs-identifier hs-type">WithAddr</span></a><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="Ouroboros.Network.ErrorPolicy.html#ErrorPolicyTrace"><span class="hs-identifier hs-type">ErrorPolicyTrace</span></a><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Server.ConnectionTable.html#ConnectionTable"><span class="hs-identifier hs-type">ConnectionTable</span></a><span>     </span><span class="hs-identifier hs-type">IO</span><span>   </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-555"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#StateVar"><span class="hs-identifier hs-type">StateVar</span></a><span>            </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138900"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Snocket.html#Snocket"><span class="hs-identifier hs-type">Snocket</span></a><span>             </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138901"><span class="hs-identifier hs-type">sock</span></a><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier hs-type">WorkerCallbacks</span></a><span>     </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138900"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138904"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679138905"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-560"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerParams"><span class="hs-identifier hs-type">WorkerParams</span></a><span>        </span><span class="hs-identifier hs-type">IO</span><span>   </span><a href="#local-6989586621679138902"><span class="hs-identifier hs-type">localAddrs</span></a><span> </span><a href="#local-6989586621679138903"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679138901"><span class="hs-identifier hs-type">sock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138904"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>    </span><span class="hs-comment">-- ^ application</span><span>
</span><a name="line-564"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679138905"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-565"></a><a name="worker"><a href="Ouroboros.Network.Subscription.Worker.html#worker"><span class="hs-identifier">worker</span></a></a><span> </span><a name="local-6989586621679139025"><a href="#local-6989586621679139025"><span class="hs-identifier">tr</span></a></a><span> </span><a name="local-6989586621679139026"><a href="#local-6989586621679139026"><span class="hs-identifier">errTrace</span></a></a><span> </span><a name="local-6989586621679139027"><a href="#local-6989586621679139027"><span class="hs-identifier">tbl</span></a></a><span> </span><a name="local-6989586621679139028"><a href="#local-6989586621679139028"><span class="hs-identifier">sVar</span></a></a><span> </span><a name="local-6989586621679139029"><a href="#local-6989586621679139029"><span class="hs-identifier">snocket</span></a></a><span> </span><a name="local-6989586621679139030"><a href="#local-6989586621679139030"><span class="hs-identifier">workerCallbacks</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.Subscription.Worker.html#WorkerCallbacks"><span class="hs-identifier hs-var">WorkerCallbacks</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679139031"><a href="#local-6989586621679139031"><span class="hs-identifier">wcCompleteApplicationTx</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679139032"><a href="#local-6989586621679139032"><span class="hs-identifier">wcMainTx</span></a></a><span> </span><span class="hs-special">}</span><span> </span><a name="local-6989586621679139033"><a href="#local-6989586621679139033"><span class="hs-identifier">workerParams</span></a></a><span> </span><a name="local-6989586621679139034"><a href="#local-6989586621679139034"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-566"></a><span>    </span><a name="local-6989586621679139040"><a href="#local-6989586621679139040"><span class="hs-identifier">resQ</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#newResultQ"><span class="hs-identifier hs-var">newResultQ</span></a><span>
</span><a name="line-567"></a><span>    </span><a name="local-6989586621679139041"><a href="#local-6989586621679139041"><span class="hs-identifier">threadsVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#newTVar"><span class="hs-identifier hs-var">newTVar</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-568"></a><span>    </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#withAsync"><span class="hs-identifier hs-var">withAsync</span></a><span>
</span><a name="line-569"></a><span>      </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#subscriptionLoop"><span class="hs-identifier hs-var">subscriptionLoop</span></a><span> </span><a href="#local-6989586621679139025"><span class="hs-identifier hs-var">tr</span></a><span> </span><a href="#local-6989586621679139027"><span class="hs-identifier hs-var">tbl</span></a><span> </span><a href="#local-6989586621679139040"><span class="hs-identifier hs-var">resQ</span></a><span> </span><a href="#local-6989586621679139028"><span class="hs-identifier hs-var">sVar</span></a><span> </span><a href="#local-6989586621679139041"><span class="hs-identifier hs-var">threadsVar</span></a><span> </span><a href="#local-6989586621679139029"><span class="hs-identifier hs-var">snocket</span></a><span>
</span><a name="line-570"></a><span>         </span><a href="#local-6989586621679139030"><span class="hs-identifier hs-var">workerCallbacks</span></a><span> </span><a href="#local-6989586621679139033"><span class="hs-identifier hs-var">workerParams</span></a><span> </span><a href="#local-6989586621679139034"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-571"></a><span>           </span><a href="Ouroboros.Network.Subscription.Worker.html#mainLoop"><span class="hs-identifier hs-var">mainLoop</span></a><span> </span><a href="#local-6989586621679139026"><span class="hs-identifier hs-var">errTrace</span></a><span> </span><a href="#local-6989586621679139040"><span class="hs-identifier hs-var">resQ</span></a><span> </span><a href="#local-6989586621679139041"><span class="hs-identifier hs-var">threadsVar</span></a><span> </span><a href="#local-6989586621679139028"><span class="hs-identifier hs-var">sVar</span></a><span> </span><a href="#local-6989586621679139031"><span class="hs-identifier hs-var">wcCompleteApplicationTx</span></a><span> </span><a href="#local-6989586621679139032"><span class="hs-identifier hs-var">wcMainTx</span></a><span>
</span><a name="line-572"></a><span>           </span><span class="hs-special">`</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#finally"><span class="hs-identifier hs-var">finally</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679139035"><span class="hs-identifier hs-var">killThreads</span></a><span> </span><a href="#local-6989586621679139041"><span class="hs-identifier hs-var">threadsVar</span></a><span>
</span><a name="line-573"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-574"></a><span>    </span><a name="local-6989586621679139035"><a href="#local-6989586621679139035"><span class="hs-identifier">killThreads</span></a></a><span> </span><a name="local-6989586621679139036"><a href="#local-6989586621679139036"><span class="hs-identifier">threadsVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-575"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679139037"><a href="#local-6989586621679139037"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier hs-var">SubscriberError</span></a><span>
</span><a name="line-576"></a><span>                </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberWorkerCancelled"><span class="hs-identifier hs-var">SubscriberWorkerCancelled</span></a><span>
</span><a name="line-577"></a><span>                </span><span class="hs-string">&quot;SubscriptionWorker exiting&quot;</span><span>
</span><a name="line-578"></a><span>                </span><span class="hs-identifier hs-var">callStack</span><span>
</span><a name="line-579"></a><span>      </span><a name="local-6989586621679139038"><a href="#local-6989586621679139038"><span class="hs-identifier">children</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679139036"><span class="hs-identifier hs-var">threadsVar</span></a><span>
</span><a name="line-580"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679139039"><a href="#local-6989586621679139039"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#cancelWith"><span class="hs-identifier hs-var">cancelWith</span></a><span> </span><a href="#local-6989586621679139039"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679139037"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679139038"><span class="hs-identifier hs-var">children</span></a><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-comment">--</span><span>
</span><a name="line-584"></a><span class="hs-comment">-- Auxiliary types: errors, traces</span><span>
</span><a name="line-585"></a><span class="hs-comment">--</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-keyword">data</span><span> </span><a name="SubscriberError"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier">SubscriberError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SubscriberError"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier">SubscriberError</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-588"></a><span>      </span><a name="seType"><a href="Ouroboros.Network.Subscription.Worker.html#seType"><span class="hs-identifier">seType</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberErrorType"><span class="hs-identifier hs-type">SubscriberErrorType</span></a><span>
</span><a name="line-589"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="seMessage"><a href="Ouroboros.Network.Subscription.Worker.html#seMessage"><span class="hs-identifier">seMessage</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-590"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="seStack"><a href="Ouroboros.Network.Subscription.Worker.html#seStack"><span class="hs-identifier">seStack</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">CallStack</span><span>
</span><a name="line-591"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span class="hs-comment">-- | Enumeration of error conditions.</span><span>
</span><a name="line-594"></a><span class="hs-comment">--</span><span>
</span><a name="line-595"></a><span class="hs-keyword">data</span><span> </span><a name="SubscriberErrorType"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberErrorType"><span class="hs-identifier">SubscriberErrorType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SubscriberParrallelConnectionCancelled"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberParrallelConnectionCancelled"><span class="hs-identifier">SubscriberParrallelConnectionCancelled</span></a></a><span>
</span><a name="line-596"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a name="SubscriberWorkerCancelled"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberWorkerCancelled"><span class="hs-identifier">SubscriberWorkerCancelled</span></a></a><span>
</span><a name="line-597"></a><span>                         </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier hs-type">SubscriberError</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-600"></a><span>    </span><a name="local-8214565720323788856"><span class="hs-identifier">displayException</span></a><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriberError"><span class="hs-identifier hs-var">SubscriberError</span></a><span class="hs-special">{</span><a name="local-6989586621679138775"><a href="#local-6989586621679138775"><span class="hs-identifier">seType</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679138776"><a href="#local-6989586621679138776"><span class="hs-identifier">seMessage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679138777"><a href="#local-6989586621679138777"><span class="hs-identifier">seStack</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-601"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">printf</span><span> </span><span class="hs-string">&quot;%s %s at %s&quot;</span><span>
</span><a name="line-602"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138775"><span class="hs-identifier hs-var">seType</span></a><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138776"><span class="hs-identifier hs-var">seMessage</span></a><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">prettyCallStack</span><span> </span><a href="#local-6989586621679138777"><span class="hs-identifier hs-var">seStack</span></a><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-keyword">data</span><span> </span><a name="SubscriptionTrace"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier">SubscriptionTrace</span></a></a><span> </span><a name="local-6989586621679138721"><a href="#local-6989586621679138721"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-608"></a><span>      </span><a name="SubscriptionTraceConnectStart"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectStart"><span class="hs-identifier">SubscriptionTraceConnectStart</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-609"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceConnectEnd"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectEnd"><span class="hs-identifier">SubscriptionTraceConnectEnd</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#ConnectResult"><span class="hs-identifier hs-type">ConnectResult</span></a><span>
</span><a name="line-610"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138722"><a href="#local-6989586621679138722"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="#local-6989586621679138722"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="SubscriptionTraceSocketAllocationException"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSocketAllocationException"><span class="hs-identifier">SubscriptionTraceSocketAllocationException</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138722"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-611"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138723"><a href="#local-6989586621679138723"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="#local-6989586621679138723"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="SubscriptionTraceConnectException"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectException"><span class="hs-identifier">SubscriptionTraceConnectException</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138723"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-612"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679138724"><a href="#local-6989586621679138724"><span class="hs-identifier">e</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="#local-6989586621679138724"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="SubscriptionTraceApplicationException"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceApplicationException"><span class="hs-identifier">SubscriptionTraceApplicationException</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span> </span><a href="#local-6989586621679138724"><span class="hs-identifier hs-type">e</span></a><span>
</span><a name="line-613"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceTryConnectToPeer"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceTryConnectToPeer"><span class="hs-identifier">SubscriptionTraceTryConnectToPeer</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-614"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceSkippingPeer"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSkippingPeer"><span class="hs-identifier">SubscriptionTraceSkippingPeer</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-615"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceSubscriptionRunning"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionRunning"><span class="hs-identifier">SubscriptionTraceSubscriptionRunning</span></a></a><span>
</span><a name="line-616"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceSubscriptionWaiting"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionWaiting"><span class="hs-identifier">SubscriptionTraceSubscriptionWaiting</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceSubscriptionFailed"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionFailed"><span class="hs-identifier">SubscriptionTraceSubscriptionFailed</span></a></a><span>
</span><a name="line-618"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceSubscriptionWaitingNewConnection"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionWaitingNewConnection"><span class="hs-identifier">SubscriptionTraceSubscriptionWaitingNewConnection</span></a></a><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-619"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceStart"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceStart"><span class="hs-identifier">SubscriptionTraceStart</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-620"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceRestart"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceRestart"><span class="hs-identifier">SubscriptionTraceRestart</span></a></a><span> </span><span class="hs-identifier hs-type">DiffTime</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceConnectionExist"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectionExist"><span class="hs-identifier">SubscriptionTraceConnectionExist</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-622"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceUnsupportedRemoteAddr"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceUnsupportedRemoteAddr"><span class="hs-identifier">SubscriptionTraceUnsupportedRemoteAddr</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-623"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceMissingLocalAddress"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceMissingLocalAddress"><span class="hs-identifier">SubscriptionTraceMissingLocalAddress</span></a></a><span>
</span><a name="line-624"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceAllocateSocket"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceAllocateSocket"><span class="hs-identifier">SubscriptionTraceAllocateSocket</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-625"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SubscriptionTraceCloseSocket"><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceCloseSocket"><span class="hs-identifier">SubscriptionTraceCloseSocket</span></a></a><span> </span><a href="#local-6989586621679138721"><span class="hs-identifier hs-type">addr</span></a><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679138753"><span class="hs-identifier hs-type">addr</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTrace"><span class="hs-identifier hs-type">SubscriptionTrace</span></a><span> </span><a href="#local-6989586621679138753"><span class="hs-identifier hs-type">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-628"></a><span>    </span><a name="local-8214565720323790330"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectStart"><span class="hs-identifier hs-var">SubscriptionTraceConnectStart</span></a><span> </span><a name="local-6989586621679138754"><a href="#local-6989586621679138754"><span class="hs-identifier">dst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-629"></a><span>        </span><span class="hs-string">&quot;Connection Attempt Start, destination &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138754"><span class="hs-identifier hs-var">dst</span></a><span>
</span><a name="line-630"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectEnd"><span class="hs-identifier hs-var">SubscriptionTraceConnectEnd</span></a><span> </span><a name="local-6989586621679138755"><a href="#local-6989586621679138755"><span class="hs-identifier">dst</span></a></a><span> </span><a name="local-6989586621679138756"><a href="#local-6989586621679138756"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-631"></a><span>        </span><span class="hs-string">&quot;Connection Attempt End, destination &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138755"><span class="hs-identifier hs-var">dst</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; outcome: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138756"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-632"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSocketAllocationException"><span class="hs-identifier hs-var">SubscriptionTraceSocketAllocationException</span></a><span> </span><a name="local-6989586621679138757"><a href="#local-6989586621679138757"><span class="hs-identifier">dst</span></a></a><span> </span><a name="local-6989586621679138758"><a href="#local-6989586621679138758"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-string">&quot;Socket Allocation Exception, destination &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138757"><span class="hs-identifier hs-var">dst</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; exception: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138758"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-634"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectException"><span class="hs-identifier hs-var">SubscriptionTraceConnectException</span></a><span> </span><a name="local-6989586621679138759"><a href="#local-6989586621679138759"><span class="hs-identifier">dst</span></a></a><span> </span><a name="local-6989586621679138760"><a href="#local-6989586621679138760"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-635"></a><span>        </span><span class="hs-string">&quot;Connection Attempt Exception, destination &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138759"><span class="hs-identifier hs-var">dst</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; exception: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138760"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-636"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceTryConnectToPeer"><span class="hs-identifier hs-var">SubscriptionTraceTryConnectToPeer</span></a><span> </span><a name="local-6989586621679138761"><a href="#local-6989586621679138761"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-637"></a><span>        </span><span class="hs-string">&quot;Trying to connect to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138761"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-638"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSkippingPeer"><span class="hs-identifier hs-var">SubscriptionTraceSkippingPeer</span></a><span> </span><a name="local-6989586621679138762"><a href="#local-6989586621679138762"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-string">&quot;Skipping peer &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138762"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-640"></a><span>    </span><span class="hs-identifier">show</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionRunning"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionRunning</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-641"></a><span>        </span><span class="hs-string">&quot;Required subscriptions started&quot;</span><span>
</span><a name="line-642"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionWaiting"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionWaiting</span></a><span> </span><a name="local-6989586621679138763"><a href="#local-6989586621679138763"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-643"></a><span>        </span><span class="hs-string">&quot;Waiting on &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138763"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; active connections&quot;</span><span>
</span><a name="line-644"></a><span>    </span><span class="hs-identifier">show</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionFailed"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionFailed</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-645"></a><span>        </span><span class="hs-string">&quot;Failed to start all required subscriptions&quot;</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceSubscriptionWaitingNewConnection"><span class="hs-identifier hs-var">SubscriptionTraceSubscriptionWaitingNewConnection</span></a><span> </span><a name="local-6989586621679138764"><a href="#local-6989586621679138764"><span class="hs-identifier">delay</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-647"></a><span>        </span><span class="hs-string">&quot;Waiting &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138764"><span class="hs-identifier hs-var">delay</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; before attempting a new connection&quot;</span><span>
</span><a name="line-648"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceStart"><span class="hs-identifier hs-var">SubscriptionTraceStart</span></a><span> </span><a name="local-6989586621679138765"><a href="#local-6989586621679138765"><span class="hs-identifier">val</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Starting Subscription Worker, valency &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138765"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-649"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceRestart"><span class="hs-identifier hs-var">SubscriptionTraceRestart</span></a><span> </span><a name="local-6989586621679138766"><a href="#local-6989586621679138766"><span class="hs-identifier">duration</span></a></a><span> </span><a name="local-6989586621679138767"><a href="#local-6989586621679138767"><span class="hs-identifier">desiredVal</span></a></a><span> </span><a name="local-6989586621679138768"><a href="#local-6989586621679138768"><span class="hs-identifier">currentVal</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-650"></a><span>        </span><span class="hs-string">&quot;Restarting Subscription after &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138766"><span class="hs-identifier hs-var">duration</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; desired valency &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-651"></a><span>        </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138767"><span class="hs-identifier hs-var">desiredVal</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; current valency &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138768"><span class="hs-identifier hs-var">currentVal</span></a><span>
</span><a name="line-652"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceConnectionExist"><span class="hs-identifier hs-var">SubscriptionTraceConnectionExist</span></a><span> </span><a name="local-6989586621679138769"><a href="#local-6989586621679138769"><span class="hs-identifier">dst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-653"></a><span>        </span><span class="hs-string">&quot;Connection Existed to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138769"><span class="hs-identifier hs-var">dst</span></a><span>
</span><a name="line-654"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceUnsupportedRemoteAddr"><span class="hs-identifier hs-var">SubscriptionTraceUnsupportedRemoteAddr</span></a><span> </span><a name="local-6989586621679138770"><a href="#local-6989586621679138770"><span class="hs-identifier">dst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-655"></a><span>        </span><span class="hs-string">&quot;Unsupported remote target address &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138770"><span class="hs-identifier hs-var">dst</span></a><span>
</span><a name="line-656"></a><span>    </span><span class="hs-comment">-- TODO: add address family</span><span>
</span><a name="line-657"></a><span>    </span><span class="hs-identifier">show</span><span> </span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceMissingLocalAddress"><span class="hs-identifier hs-var">SubscriptionTraceMissingLocalAddress</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-658"></a><span>        </span><span class="hs-string">&quot;Missing local address&quot;</span><span>
</span><a name="line-659"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceApplicationException"><span class="hs-identifier hs-var">SubscriptionTraceApplicationException</span></a><span> </span><a name="local-6989586621679138771"><a href="#local-6989586621679138771"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679138772"><a href="#local-6989586621679138772"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-660"></a><span>        </span><span class="hs-string">&quot;Application Exception: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138771"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138772"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-661"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceAllocateSocket"><span class="hs-identifier hs-var">SubscriptionTraceAllocateSocket</span></a><span> </span><a name="local-6989586621679138773"><a href="#local-6989586621679138773"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-662"></a><span>        </span><span class="hs-string">&quot;Allocate socket to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138773"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-663"></a><span>    </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Subscription.Worker.html#SubscriptionTraceCloseSocket"><span class="hs-identifier hs-var">SubscriptionTraceCloseSocket</span></a><span> </span><a name="local-6989586621679138774"><a href="#local-6989586621679138774"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-664"></a><span>        </span><span class="hs-string">&quot;Closed socket to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679138774"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-665"></a></pre></body></html>