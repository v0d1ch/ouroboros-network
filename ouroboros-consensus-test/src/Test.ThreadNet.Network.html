<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds      #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds            #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass       #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts     #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE GADTs                #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase           #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns       #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes           #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards      #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables  #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving   #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications     #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies         #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">-- | Setup network</span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Test.ThreadNet.Network</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier">CalcMessageDelay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#ForgeEbbEnv"><span class="hs-identifier">ForgeEbbEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#RekeyM"><span class="hs-identifier">RekeyM</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier">TestNodeInitialization</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#ThreadNetworkArgs"><span class="hs-identifier">ThreadNetworkArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TracingConstraints"><span class="hs-identifier">TracingConstraints</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#noCalcMessageDelay"><span class="hs-identifier">noCalcMessageDelay</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#plainTestNodeInitialization"><span class="hs-identifier">plainTestNodeInitialization</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#runThreadNetwork"><span class="hs-identifier">runThreadNetwork</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Tracers</span></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolFatalException"><span class="hs-identifier">MiniProtocolFatalException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolState"><span class="hs-identifier">MiniProtocolState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Test Output</span></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier">NodeDBs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeOutput"><span class="hs-identifier">NodeOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestOutput"><span class="hs-identifier">TestOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Read</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DeserialiseFailure</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Exn</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MonadSTM</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">MonadTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier">MonadTimer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Exc</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isRight</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Identity</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Typeable</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Void</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mkStdGen</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.BlockFetch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">BlockFetchConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>                     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">TraceLabelPeer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">Ouroboros.Network.Channel</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">Ouroboros.Network.Codec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier">AnyMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier">CodecFailure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>                     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier">mapFailureCodec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">Ouroboros.Network.Codec</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Codec</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.MockChain.Chain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Chain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Genesis</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Point</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CS</span></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">Ouroboros.Network.Mux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">ControlMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">ControlMessageSTM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.NodeToNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">MiniProtocolParameters</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.KeepAlive.Type</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">Ouroboros.Network.Protocol.Limits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier">waitForever</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission.Type</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission2.Type</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.BlockchainTime</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Fragment.InFuture</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InFuture</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsMempool</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Mempool</span></a></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.ChainSync.Client</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CSClient</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Network.NodeToNode</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NTN</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Node.InitStorage</span></a></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Node.NetworkProtocolVersion</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Node.ProtocolInfo</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Node.Run</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Node.Tracers</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.NodeId</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.NodeKernel</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NodeKernel</span></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Abstract</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.Assert</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.Condense</span></a></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.RedundantConstraints</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.STM</span></a></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Util.Time</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainDB</span></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">ChainDbArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.FS.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">SomeHasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImmutableDB</span></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Index</span></span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.DiskPolicy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LgrDB</span></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VolatileDB</span></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.ThreadNet.TxGen.html"><span class="hs-identifier">Test.ThreadNet.TxGen</span></a></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.ThreadNet.Util.NodeJoinPlan.html"><span class="hs-identifier">Test.ThreadNet.Util.NodeJoinPlan</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.ThreadNet.Util.NodeRestarts.html"><span class="hs-identifier">Test.ThreadNet.Util.NodeRestarts</span></a></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.ThreadNet.Util.NodeTopology.html"><span class="hs-identifier">Test.ThreadNet.Util.NodeTopology</span></a></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.ThreadNet.Util.Seed.html"><span class="hs-identifier">Test.ThreadNet.Util.Seed</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html"><span class="hs-identifier">Test.Util.FS.Sim.MockFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier">MockFS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html"><span class="hs-identifier">Test.Util.FS.Sim.MockFS</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Mock</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.FS.Sim.STM.html"><span class="hs-identifier">Test.Util.FS.Sim.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.Util.FS.Sim.STM.html#simHasFS"><span class="hs-identifier">simHasFS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.HardFork.Future.html"><span class="hs-identifier">Test.Util.HardFork.Future</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.Util.HardFork.Future.html#Future"><span class="hs-identifier">Future</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Test.Util.HardFork.Future.html"><span class="hs-identifier">Test.Util.HardFork.Future</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HFF</span></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html"><span class="hs-identifier">Test.Util.HardFork.OracularClock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier">OracularClock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html"><span class="hs-identifier">Test.Util.HardFork.OracularClock</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OracularClock</span></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.Slots.html"><span class="hs-identifier">Test.Util.Slots</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.Util.Slots.html#NumSlots"><span class="hs-identifier">NumSlots</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.Time.html"><span class="hs-identifier">Test.Util.Time</span></a></span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Test.Util.Tracer.html"><span class="hs-identifier">Test.Util.Tracer</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- | How to forge an EBB</span><span>
</span><span id="line-131"></span><span class="hs-comment">--</span><span>
</span><span id="line-132"></span><span class="hs-keyword">data</span><span> </span><span id="ForgeEbbEnv"><span class="annot"><a href="Test.ThreadNet.Network.html#ForgeEbbEnv"><span class="hs-identifier hs-var">ForgeEbbEnv</span></a></span></span><span> </span><span id="local-6989586621679262591"><span class="annot"><a href="#local-6989586621679262591"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ForgeEbbEnv"><span class="annot"><a href="Test.ThreadNet.Network.html#ForgeEbbEnv"><span class="hs-identifier hs-var">ForgeEbbEnv</span></a></span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="forgeEBB"><span class="annot"><span class="annottext">ForgeEbbEnv blk
-&gt; TopLevelConfig blk -&gt; SlotNo -&gt; BlockNo -&gt; ChainHash blk -&gt; blk
</span><a href="Test.ThreadNet.Network.html#forgeEBB"><span class="hs-identifier hs-var hs-var">forgeEBB</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-134"></span><span>         </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262591"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-136"></span><span>         </span><span class="hs-comment">-- EBB slot</span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-138"></span><span>         </span><span class="hs-comment">-- EBB block number (i.e. that of its predecessor)</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">ChainHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262591"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-140"></span><span>         </span><span class="hs-comment">-- EBB predecessor's hash</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262591"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span id="local-6989586621679262085"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262080"><span id="local-6989586621679262082"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#ForgeEbbEnv"><span class="hs-identifier hs-type">ForgeEbbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262085"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621679262078"><span class="annot"><span class="annottext">showsPrec :: Int -&gt; ForgeEbbEnv blk -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">showsPrec</span></span></span><span> </span><span id="local-6989586621679262076"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679262076"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForgeEbbEnv blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ShowS -&gt; ShowS
</span><span class="hs-identifier hs-var">showParen</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679262076"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ShowS -&gt; ShowS) -&gt; ShowS -&gt; ShowS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
</span><span class="hs-identifier hs-var">showString</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ForgeEbbEnv _&quot;</span></span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- | How to rekey a node with a fresh operational key</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- When there is a 'NodeRekey' scheduled in the 'NodeRestarts', the test node</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- will restart and use 'tnaRekeyM' to compute its new 'ProtocolInfo'.</span><span>
</span><span id="line-150"></span><span class="hs-keyword">type</span><span> </span><span id="RekeyM"><span class="annot"><a href="Test.ThreadNet.Network.html#RekeyM"><span class="hs-identifier hs-var">RekeyM</span></a></span></span><span> </span><span id="local-6989586621679262072"><span class="annot"><a href="#local-6989586621679262072"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262071"><span class="annot"><a href="#local-6989586621679262071"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-151"></span><span>     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262072"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262071"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-154"></span><span>     </span><span class="hs-comment">-- ^ The slot in which the node is rekeying</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262072"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>     </span><span class="hs-comment">-- ^ Which epoch the slot is in</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262072"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262072"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262071"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>     </span><span class="hs-comment">-- ^ 'tniProtocolInfo' should include new delegation cert/operational key,</span><span>
</span><span id="line-159"></span><span>     </span><span class="hs-comment">-- and 'tniCrucialTxs' should include the new delegation certificate</span><span>
</span><span id="line-160"></span><span>     </span><span class="hs-comment">-- transaction</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Data used when starting/restarting a node</span><span>
</span><span id="line-163"></span><span class="hs-keyword">data</span><span> </span><span id="TestNodeInitialization"><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-var">TestNodeInitialization</span></a></span></span><span> </span><span id="local-6989586621679262958"><span class="annot"><a href="#local-6989586621679262958"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262959"><span class="annot"><a href="#local-6989586621679262959"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TestNodeInitialization"><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-var">TestNodeInitialization</span></a></span></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="tniCrucialTxs"><span class="annot"><span class="annottext">TestNodeInitialization m blk -&gt; [GenTx blk]
</span><a href="Test.ThreadNet.Network.html#tniCrucialTxs"><span class="hs-identifier hs-var hs-var">tniCrucialTxs</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262959"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- ^ these transactions are added immediately and repeatedly (whenever the</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- 'ledgerTipSlot' changes)</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- In particular, a leading node's crucial transactions must (if valid)</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">-- enter its mempool each slot /before/ the node takes the mempool snapshot</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-comment">-- that determines which transactions will be included in the block it's</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- about to forge.</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tniProtocolInfo"><span class="annot"><span class="annottext">TestNodeInitialization m blk -&gt; ProtocolInfo m blk
</span><a href="Test.ThreadNet.Network.html#tniProtocolInfo"><span class="hs-identifier hs-var hs-var">tniProtocolInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262958"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262959"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span id="local-6989586621679262790"><span id="local-6989586621679262791"><span class="annot"><a href="Test.ThreadNet.Network.html#plainTestNodeInitialization"><span class="hs-identifier hs-type">plainTestNodeInitialization</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262791"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262790"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262791"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262790"><span class="hs-identifier hs-type">blk</span></a></span></span></span><span>
</span><span id="line-177"></span><span id="plainTestNodeInitialization"><span class="annot"><span class="annottext">plainTestNodeInitialization :: ProtocolInfo m blk -&gt; TestNodeInitialization m blk
</span><a href="Test.ThreadNet.Network.html#plainTestNodeInitialization"><span class="hs-identifier hs-var hs-var">plainTestNodeInitialization</span></a></span></span><span> </span><span id="local-6989586621679262067"><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679262067"><span class="hs-identifier hs-var">pInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TestNodeInitialization :: forall (m :: * -&gt; *) blk.
[GenTx blk] -&gt; ProtocolInfo m blk -&gt; TestNodeInitialization m blk
</span><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tniCrucialTxs :: [GenTx blk]
</span><a href="Test.ThreadNet.Network.html#tniCrucialTxs"><span class="hs-identifier hs-var">tniCrucialTxs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tniProtocolInfo :: ProtocolInfo m blk
</span><a href="Test.ThreadNet.Network.html#tniProtocolInfo"><span class="hs-identifier hs-var">tniProtocolInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679262067"><span class="hs-identifier hs-var">pInfo</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | Compute the chain diffusion delay</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- This is the number of slots a 'CS.MsgRollForward' should arrive after the</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- forge slot of the header it is carrying.</span><span>
</span><span id="line-186"></span><span class="hs-comment">--</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- It may depend on the @(sender, recipient)@, the current slot, and header.</span><span>
</span><span id="line-188"></span><span class="hs-keyword">newtype</span><span> </span><span id="CalcMessageDelay"><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-var">CalcMessageDelay</span></a></span></span><span> </span><span id="local-6989586621679262951"><span class="annot"><a href="#local-6989586621679262951"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CalcMessageDelay"><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-var">CalcMessageDelay</span></a></span></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262951"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.Slots.html#NumSlots"><span class="hs-identifier hs-type">NumSlots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span id="local-6989586621679262065"><span class="annot"><a href="Test.ThreadNet.Network.html#noCalcMessageDelay"><span class="hs-identifier hs-type">noCalcMessageDelay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262065"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-192"></span><span id="noCalcMessageDelay"><span class="annot"><span class="annottext">noCalcMessageDelay :: CalcMessageDelay blk
</span><a href="Test.ThreadNet.Network.html#noCalcMessageDelay"><span class="hs-identifier hs-var hs-var">noCalcMessageDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CoreNodeId, CoreNodeId) -&gt; SlotNo -&gt; Header blk -&gt; NumSlots)
-&gt; CalcMessageDelay blk
forall blk.
((CoreNodeId, CoreNodeId) -&gt; SlotNo -&gt; Header blk -&gt; NumSlots)
-&gt; CalcMessageDelay blk
</span><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-var">CalcMessageDelay</span></a></span><span> </span><span class="annot"><span class="annottext">(((CoreNodeId, CoreNodeId) -&gt; SlotNo -&gt; Header blk -&gt; NumSlots)
 -&gt; CalcMessageDelay blk)
-&gt; ((CoreNodeId, CoreNodeId) -&gt; SlotNo -&gt; Header blk -&gt; NumSlots)
-&gt; CalcMessageDelay blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; NumSlots
</span><a href="Test.Util.Slots.html#NumSlots"><span class="hs-identifier hs-var">NumSlots</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-comment">-- | This type occurs in records where most of the fields are data</span><span>
</span><span id="line-195"></span><span id="local-6989586621679262063"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679262058"><span id="local-6989586621679262061"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262063"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>  </span><span id="local-6989586621679262057"><span class="annot"><span class="annottext">show :: CalcMessageDelay blk -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></span></span><span> </span><span class="annot"><span class="annottext">CalcMessageDelay blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_CalcMessageDelay&quot;</span></span></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Parameters for the test node net</span><span>
</span><span id="line-199"></span><span class="hs-comment">--</span><span>
</span><span id="line-200"></span><span class="hs-keyword">data</span><span> </span><span id="ThreadNetworkArgs"><span class="annot"><a href="Test.ThreadNet.Network.html#ThreadNetworkArgs"><span class="hs-identifier hs-var">ThreadNetworkArgs</span></a></span></span><span> </span><span id="local-6989586621679262904"><span class="annot"><a href="#local-6989586621679262904"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262903"><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ThreadNetworkArgs"><span class="annot"><a href="Test.ThreadNet.Network.html#ThreadNetworkArgs"><span class="hs-identifier hs-var">ThreadNetworkArgs</span></a></span></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="tnaForgeEbbEnv"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; Maybe (ForgeEbbEnv blk)
</span><a href="Test.ThreadNet.Network.html#tnaForgeEbbEnv"><span class="hs-identifier hs-var hs-var">tnaForgeEbbEnv</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#ForgeEbbEnv"><span class="hs-identifier hs-type">ForgeEbbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaFuture"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; Future
</span><a href="Test.ThreadNet.Network.html#tnaFuture"><span class="hs-identifier hs-var hs-var">tnaFuture</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.Util.HardFork.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaJoinPlan"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; NodeJoinPlan
</span><a href="Test.ThreadNet.Network.html#tnaJoinPlan"><span class="hs-identifier hs-var hs-var">tnaJoinPlan</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.NodeJoinPlan.html#NodeJoinPlan"><span class="hs-identifier hs-type">NodeJoinPlan</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaNodeInfo"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk
-&gt; CoreNodeId -&gt; TestNodeInitialization m blk
</span><a href="Test.ThreadNet.Network.html#tnaNodeInfo"><span class="hs-identifier hs-var hs-var">tnaNodeInfo</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262904"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaNumCoreNodes"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; NumCoreNodes
</span><a href="Test.ThreadNet.Network.html#tnaNumCoreNodes"><span class="hs-identifier hs-var hs-var">tnaNumCoreNodes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NumCoreNodes</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaNumSlots"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; NumSlots
</span><a href="Test.ThreadNet.Network.html#tnaNumSlots"><span class="hs-identifier hs-var hs-var">tnaNumSlots</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.Util.Slots.html#NumSlots"><span class="hs-identifier hs-type">NumSlots</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaMessageDelay"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; CalcMessageDelay blk
</span><a href="Test.ThreadNet.Network.html#tnaMessageDelay"><span class="hs-identifier hs-var hs-var">tnaMessageDelay</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaSeed"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; Seed
</span><a href="Test.ThreadNet.Network.html#tnaSeed"><span class="hs-identifier hs-var hs-var">tnaSeed</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.Seed.html#Seed"><span class="hs-identifier hs-type">Seed</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaMkRekeyM"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; Maybe (m (RekeyM m blk))
</span><a href="Test.ThreadNet.Network.html#tnaMkRekeyM"><span class="hs-identifier hs-var hs-var">tnaMkRekeyM</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262904"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#RekeyM"><span class="hs-identifier hs-type">RekeyM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262904"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaRestarts"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; NodeRestarts
</span><a href="Test.ThreadNet.Network.html#tnaRestarts"><span class="hs-identifier hs-var hs-var">tnaRestarts</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRestarts"><span class="hs-identifier hs-type">NodeRestarts</span></a></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaTopology"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; NodeTopology
</span><a href="Test.ThreadNet.Network.html#tnaTopology"><span class="hs-identifier hs-var hs-var">tnaTopology</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.NodeTopology.html#NodeTopology"><span class="hs-identifier hs-type">NodeTopology</span></a></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaTxGenExtra"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; TxGenExtra blk
</span><a href="Test.ThreadNet.Network.html#tnaTxGenExtra"><span class="hs-identifier hs-var hs-var">tnaTxGenExtra</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.TxGen.html#TxGenExtra"><span class="hs-identifier hs-type">TxGenExtra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaVersion"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; NodeToNodeVersion
</span><a href="Test.ThreadNet.Network.html#tnaVersion"><span class="hs-identifier hs-var hs-var">tnaVersion</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tnaBlockVersion"><span class="annot"><span class="annottext">ThreadNetworkArgs m blk -&gt; BlockNodeToNodeVersion blk
</span><a href="Test.ThreadNet.Network.html#tnaBlockVersion"><span class="hs-identifier hs-var hs-var">tnaBlockVersion</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockNodeToNodeVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262903"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Vertex and Edge Statuses
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="hs-comment">-- | A /vertex/ denotes the \&quot;operator of a node\&quot;; in production, that's</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- typically a person.</span><span>
</span><span id="line-223"></span><span class="hs-comment">--</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- There is always exactly one vertex for each genesis key. When its current</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- node instance crashes/terminates, the vertex replaces it with a new one.</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- Every node instance created by a vertex uses the same file system.</span><span>
</span><span id="line-227"></span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- The term \&quot;vertex\&quot; is only explicitly used in this module. However, the</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- concept exists throughout the project; it's usually denoted by the term</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- \&quot;node\&quot;, which can mean either \&quot;vertex\&quot; or \&quot;node instance\&quot;. We take</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- more care than usual in this module to be explicit, but still often rely on</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- context.</span><span>
</span><span id="line-233"></span><span class="hs-comment">--</span><span>
</span><span id="line-234"></span><span class="hs-keyword">data</span><span> </span><span id="VertexStatus"><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatus"><span class="hs-identifier hs-var">VertexStatus</span></a></span></span><span> </span><span id="local-6989586621679262870"><span class="annot"><a href="#local-6989586621679262870"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262871"><span class="annot"><a href="#local-6989586621679262871"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="VDown"><span class="annot"><a href="Test.ThreadNet.Network.html#VDown"><span class="hs-identifier hs-var">VDown</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262871"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262871"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">-- ^ The vertex does not currently have a node instance; its previous</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-comment">-- instance stopped with this chain and ledger state (empty/initial before</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-comment">-- first instance)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="VFalling"><span class="annot"><a href="Test.ThreadNet.Network.html#VFalling"><span class="hs-identifier hs-var">VFalling</span></a></span></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">-- ^ The vertex has a node instance, but it is about to transition to</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-comment">-- 'VDown' as soon as its edges transition to 'EDown'.</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="VUp"><span class="annot"><a href="Test.ThreadNet.Network.html#VUp"><span class="hs-identifier hs-var">VUp</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeKernel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262870"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="annot"><a href="#local-6989586621679262871"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-type">LimitedApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262870"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262871"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-comment">-- ^ The vertex currently has a node instance, with these handles.</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-comment">-- | A directed /edge/ denotes the \&quot;operator of a node-to-node connection\&quot;;</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- in production, that's generally the TCP connection and the networking layers</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- built atop it.</span><span>
</span><span id="line-248"></span><span class="hs-comment">--</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- There are always exactly two edges between two vertices that are connected</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- by the 'NodeTopology': one for the client-server relationship in each</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- direction. When the mini protocol instances crash, the edge replaces them</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- with new instances, possibly after a delay (see 'RestartCause').</span><span>
</span><span id="line-253"></span><span class="hs-comment">--</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- (We do not need 'EFalling' because node instances can exist without mini</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- protocols; we only need 'VFalling' because mini protocol instances cannot</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- exist without node instances.)</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="hs-keyword">data</span><span> </span><span id="EdgeStatus"><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatus"><span class="hs-identifier hs-var">EdgeStatus</span></a></span></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EDown"><span class="annot"><a href="Test.ThreadNet.Network.html#EDown"><span class="hs-identifier hs-var">EDown</span></a></span></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- ^ The edge does not currently have mini protocol instances.</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="EUp"><span class="annot"><a href="Test.ThreadNet.Network.html#EUp"><span class="hs-identifier hs-var">EUp</span></a></span></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-comment">-- ^ The edge currently has mini protocol instances.</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679262032"><span id="local-6989586621679262034"><span class="annot"><span class="annottext">EdgeStatus -&gt; EdgeStatus -&gt; Bool
(EdgeStatus -&gt; EdgeStatus -&gt; Bool)
-&gt; (EdgeStatus -&gt; EdgeStatus -&gt; Bool) -&gt; Eq EdgeStatus
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: EdgeStatus -&gt; EdgeStatus -&gt; Bool
$c/= :: EdgeStatus -&gt; EdgeStatus -&gt; Bool
== :: EdgeStatus -&gt; EdgeStatus -&gt; Bool
$c== :: EdgeStatus -&gt; EdgeStatus -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-keyword">type</span><span> </span><span id="VertexStatusVar"><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-var">VertexStatusVar</span></a></span></span><span> </span><span id="local-6989586621679262030"><span class="annot"><a href="#local-6989586621679262030"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262029"><span class="annot"><a href="#local-6989586621679262029"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatus"><span class="hs-identifier hs-type">VertexStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262029"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span class="hs-keyword">type</span><span> </span><span id="EdgeStatusVar"><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatusVar"><span class="hs-identifier hs-var">EdgeStatusVar</span></a></span></span><span> </span><span id="local-6989586621679262028"><span class="annot"><a href="#local-6989586621679262028"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262028"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatus"><span class="hs-identifier hs-type">EdgeStatus</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Running the node net
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">-- | Setup a network of core nodes, where each joins according to the node join</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- plan and is interconnected according to the node topology</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- We run for the specified number of blocks, then return the final state of</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- each node.</span><span>
</span><span id="line-277"></span><span class="annot"><a href="Test.ThreadNet.Network.html#runThreadNetwork"><span class="hs-identifier hs-type">runThreadNetwork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262027"><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262026"><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-278"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-279"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadTime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-280"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">MonadTimer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-281"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RunNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-282"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.TxGen.html#TxGen"><span class="hs-identifier hs-type">TxGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-283"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TracingConstraints"><span class="hs-identifier hs-type">TracingConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-284"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-285"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">SystemTime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#ThreadNetworkArgs"><span class="hs-identifier hs-type">ThreadNetworkArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#TestOutput"><span class="hs-identifier hs-type">TestOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span id="runThreadNetwork"><span class="annot"><span class="annottext">runThreadNetwork :: SystemTime m -&gt; ThreadNetworkArgs m blk -&gt; m (TestOutput blk)
</span><a href="Test.ThreadNet.Network.html#runThreadNetwork"><span class="hs-identifier hs-var hs-var">runThreadNetwork</span></a></span></span><span> </span><span id="local-6989586621679262025"><span class="annot"><span class="annottext">SystemTime m
</span><a href="#local-6989586621679262025"><span class="hs-identifier hs-var">systemTime</span></a></span></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#ThreadNetworkArgs"><span class="hs-identifier hs-type">ThreadNetworkArgs</span></a></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tnaForgeEbbEnv :: forall (m :: * -&gt; *) blk.
ThreadNetworkArgs m blk -&gt; Maybe (ForgeEbbEnv blk)
</span><a href="Test.ThreadNet.Network.html#tnaForgeEbbEnv"><span class="hs-identifier hs-var">tnaForgeEbbEnv</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262024"><span class="annot"><span class="annottext">Maybe (ForgeEbbEnv blk)
</span><a href="#local-6989586621679262024"><span class="hs-identifier hs-var">mbForgeEbbEnv</span></a></span></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaFuture :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; Future
</span><a href="Test.ThreadNet.Network.html#tnaFuture"><span class="hs-identifier hs-var">tnaFuture</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262023"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621679262023"><span class="hs-identifier hs-var">future</span></a></span></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaJoinPlan :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; NodeJoinPlan
</span><a href="Test.ThreadNet.Network.html#tnaJoinPlan"><span class="hs-identifier hs-var">tnaJoinPlan</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262022"><span class="annot"><span class="annottext">NodeJoinPlan
</span><a href="#local-6989586621679262022"><span class="hs-identifier hs-var">nodeJoinPlan</span></a></span></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaNodeInfo :: forall (m :: * -&gt; *) blk.
ThreadNetworkArgs m blk
-&gt; CoreNodeId -&gt; TestNodeInitialization m blk
</span><a href="Test.ThreadNet.Network.html#tnaNodeInfo"><span class="hs-identifier hs-var">tnaNodeInfo</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262021"><span class="annot"><span class="annottext">CoreNodeId -&gt; TestNodeInitialization m blk
</span><a href="#local-6989586621679262021"><span class="hs-identifier hs-var">mkProtocolInfo</span></a></span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaNumCoreNodes :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; NumCoreNodes
</span><a href="Test.ThreadNet.Network.html#tnaNumCoreNodes"><span class="hs-identifier hs-var">tnaNumCoreNodes</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262020"><span class="annot"><span class="annottext">NumCoreNodes
</span><a href="#local-6989586621679262020"><span class="hs-identifier hs-var">numCoreNodes</span></a></span></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaNumSlots :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; NumSlots
</span><a href="Test.ThreadNet.Network.html#tnaNumSlots"><span class="hs-identifier hs-var">tnaNumSlots</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262019"><span class="annot"><span class="annottext">NumSlots
</span><a href="#local-6989586621679262019"><span class="hs-identifier hs-var">numSlots</span></a></span></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaMessageDelay :: forall (m :: * -&gt; *) blk.
ThreadNetworkArgs m blk -&gt; CalcMessageDelay blk
</span><a href="Test.ThreadNet.Network.html#tnaMessageDelay"><span class="hs-identifier hs-var">tnaMessageDelay</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262018"><span class="annot"><span class="annottext">CalcMessageDelay blk
</span><a href="#local-6989586621679262018"><span class="hs-identifier hs-var">calcMessageDelay</span></a></span></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaSeed :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; Seed
</span><a href="Test.ThreadNet.Network.html#tnaSeed"><span class="hs-identifier hs-var">tnaSeed</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262017"><span class="annot"><span class="annottext">Seed
</span><a href="#local-6989586621679262017"><span class="hs-identifier hs-var">seed</span></a></span></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaMkRekeyM :: forall (m :: * -&gt; *) blk.
ThreadNetworkArgs m blk -&gt; Maybe (m (RekeyM m blk))
</span><a href="Test.ThreadNet.Network.html#tnaMkRekeyM"><span class="hs-identifier hs-var">tnaMkRekeyM</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262016"><span class="annot"><span class="annottext">Maybe (m (RekeyM m blk))
</span><a href="#local-6989586621679262016"><span class="hs-identifier hs-var">mbMkRekeyM</span></a></span></span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaRestarts :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; NodeRestarts
</span><a href="Test.ThreadNet.Network.html#tnaRestarts"><span class="hs-identifier hs-var">tnaRestarts</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262015"><span class="annot"><span class="annottext">NodeRestarts
</span><a href="#local-6989586621679262015"><span class="hs-identifier hs-var">nodeRestarts</span></a></span></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaTopology :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; NodeTopology
</span><a href="Test.ThreadNet.Network.html#tnaTopology"><span class="hs-identifier hs-var">tnaTopology</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262014"><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679262014"><span class="hs-identifier hs-var">nodeTopology</span></a></span></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaTxGenExtra :: forall (m :: * -&gt; *) blk. ThreadNetworkArgs m blk -&gt; TxGenExtra blk
</span><a href="Test.ThreadNet.Network.html#tnaTxGenExtra"><span class="hs-identifier hs-var">tnaTxGenExtra</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262013"><span class="annot"><span class="annottext">TxGenExtra blk
</span><a href="#local-6989586621679262013"><span class="hs-identifier hs-var">txGenExtra</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaVersion :: forall (m :: * -&gt; *) blk.
ThreadNetworkArgs m blk -&gt; NodeToNodeVersion
</span><a href="Test.ThreadNet.Network.html#tnaVersion"><span class="hs-identifier hs-var">tnaVersion</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262012"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679262012"><span class="hs-identifier hs-var">version</span></a></span></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tnaBlockVersion :: forall (m :: * -&gt; *) blk.
ThreadNetworkArgs m blk -&gt; BlockNodeToNodeVersion blk
</span><a href="Test.ThreadNet.Network.html#tnaBlockVersion"><span class="hs-identifier hs-var">tnaBlockVersion</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679262011"><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679262011"><span class="hs-identifier hs-var">blockVersion</span></a></span></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResourceRegistry m -&gt; m (TestOutput blk)) -&gt; m (TestOutput blk)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">withRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">((ResourceRegistry m -&gt; m (TestOutput blk)) -&gt; m (TestOutput blk))
-&gt; (ResourceRegistry m -&gt; m (TestOutput blk)) -&gt; m (TestOutput blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679262009"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679262009"><span class="hs-identifier hs-var">sharedRegistry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621679262008"><span class="annot"><span class="annottext">Maybe (RekeyM m blk)
</span><a href="#local-6989586621679262008"><span class="hs-identifier hs-var">mbRekeyM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (m (RekeyM m blk)) -&gt; m (Maybe (RekeyM m blk))
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">Maybe (m (RekeyM m blk))
</span><a href="#local-6989586621679262016"><span class="hs-identifier hs-var">mbMkRekeyM</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- This shared registry is used for 'newTestBlockchainTime' and the</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">-- network communication threads. Each node will create its own registry</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- for its ChainDB.</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- TODO each node should run in its own thread and have its own (single</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- top-level, bracketed) registry used to spawn all of the node's threads,</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- including its own BlockchainTime. This will allow us to use</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">-- ChainDB.withDB and avoid issues with termination and using registries</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">-- from the wrong thread. To stop the network, wait for all the nodes'</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- blockchain times to be done and then kill the main thread of each node,</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-comment">-- which should terminate all other threads it spawned.</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262006"><span class="annot"><span class="annottext">clock :: OracularClock m
</span><a href="#local-6989586621679262006"><span class="hs-identifier hs-var hs-var">clock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SystemTime m -&gt; NumSlots -&gt; Future -&gt; OracularClock m
forall (m :: * -&gt; *).
IOLike m =&gt;
SystemTime m -&gt; NumSlots -&gt; Future -&gt; OracularClock m
</span><a href="Test.Util.HardFork.OracularClock.html#mkOracularClock"><span class="hs-identifier hs-var">OracularClock.mkOracularClock</span></a></span><span> </span><span class="annot"><span class="annottext">SystemTime m
</span><a href="#local-6989586621679262025"><span class="hs-identifier hs-var">systemTime</span></a></span><span> </span><span class="annot"><span class="annottext">NumSlots
</span><a href="#local-6989586621679262019"><span class="hs-identifier hs-var">numSlots</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621679262023"><span class="hs-identifier hs-var">future</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- This function is organized around the notion of a network of nodes as a</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- simple graph with no loops. The graph topology is determined by</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-comment">-- @nodeTopology@.</span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- Each graph vertex is a node operator, and maintains its own Ouroboros</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">-- core node, which in turn has its own private threads managing its</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- internal state. Some nodes join the network later than others, according</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- to @nodeJoinPlan@.</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-comment">-- Each undirected edge denotes two opposing directed edges. Each directed</span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-comment">-- edge denotes a bundle of mini protocols with client threads on the tail</span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-comment">-- node and server threads on the head node. These mini protocols begin as</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-comment">-- soon as both nodes have joined the network, according to @nodeJoinPlan@.</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-comment">-- allocate the status variable for each vertex</span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621679262004"><span class="annot"><span class="annottext">Map CoreNodeId (StrictTVar m (VertexStatus m blk))
</span><a href="#local-6989586621679262004"><span class="hs-identifier hs-var">vertexStatusVars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([(CoreNodeId, StrictTVar m (VertexStatus m blk))]
 -&gt; Map CoreNodeId (StrictTVar m (VertexStatus m blk)))
-&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
-&gt; m (Map CoreNodeId (StrictTVar m (VertexStatus m blk)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(CoreNodeId, StrictTVar m (VertexStatus m blk))]
-&gt; Map CoreNodeId (StrictTVar m (VertexStatus m blk))
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">(m [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
 -&gt; m (Map CoreNodeId (StrictTVar m (VertexStatus m blk))))
-&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
-&gt; m (Map CoreNodeId (StrictTVar m (VertexStatus m blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">[CoreNodeId]
-&gt; (CoreNodeId
    -&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk)))
-&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[CoreNodeId]
</span><a href="#local-6989586621679262001"><span class="hs-identifier hs-var">coreNodeIds</span></a></span><span> </span><span class="annot"><span class="annottext">((CoreNodeId -&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk)))
 -&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk))])
-&gt; (CoreNodeId
    -&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk)))
-&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679262000"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679262000"><span class="hs-identifier hs-var">nid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- assume they all start with the empty chain and the same initial</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-comment">-- ledger</span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261999"><span class="annot"><span class="annottext">nodeInitData :: TestNodeInitialization m blk
</span><a href="#local-6989586621679261999"><span class="hs-identifier hs-var hs-var">nodeInitData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; TestNodeInitialization m blk
</span><a href="#local-6989586621679262021"><span class="hs-identifier hs-var">mkProtocolInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">CoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>            </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261997"><span class="annot"><span class="annottext">ProtocolInfo m blk
tniProtocolInfo :: ProtocolInfo m blk
tniProtocolInfo :: forall (m :: * -&gt; *) blk.
TestNodeInitialization m blk -&gt; ProtocolInfo m blk
</span><a href="#local-6989586621679261997"><span class="hs-identifier hs-var hs-var">tniProtocolInfo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TestNodeInitialization m blk
</span><a href="#local-6989586621679261999"><span class="hs-identifier hs-var">nodeInitData</span></a></span><span>
</span><span id="line-337"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261995"><span class="annot"><span class="annottext">ExtLedgerState blk
pInfoInitLedger :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; ExtLedgerState b
pInfoInitLedger :: ExtLedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">pInfoInitLedger</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261997"><span class="hs-identifier hs-var">tniProtocolInfo</span></a></span><span>
</span><span id="line-338"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261992"><span class="annot"><span class="annottext">LedgerState blk
ledgerState :: forall blk. ExtLedgerState blk -&gt; LedgerState blk
ledgerState :: LedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679261995"><span class="hs-identifier hs-var">pInfoInitLedger</span></a></span><span>
</span><span id="line-339"></span><span>        </span><span id="local-6989586621679261990"><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261990"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VertexStatus m blk -&gt; m (StrictTVar m (VertexStatus m blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">uncheckedNewTVarM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Chain blk -&gt; LedgerState blk -&gt; VertexStatus m blk
forall (m :: * -&gt; *) blk.
Chain blk -&gt; LedgerState blk -&gt; VertexStatus m blk
</span><a href="Test.ThreadNet.Network.html#VDown"><span class="hs-identifier hs-var">VDown</span></a></span><span> </span><span class="annot"><span class="annottext">Chain blk
forall block. Chain block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">Genesis</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261992"><span class="hs-identifier hs-var">ledgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">(CoreNodeId, StrictTVar m (VertexStatus m blk))
-&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679262000"><span class="hs-identifier hs-var">nid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261990"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-comment">-- fork the directed edges, which also allocates their status variables</span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261988"><span class="annot"><span class="annottext">uedges :: [(CoreNodeId, CoreNodeId)]
</span><a href="#local-6989586621679261988"><span class="hs-identifier hs-var hs-var">uedges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeTopology -&gt; [(CoreNodeId, CoreNodeId)]
</span><a href="Test.ThreadNet.Util.NodeTopology.html#edgesNodeTopology"><span class="hs-identifier hs-var">edgesNodeTopology</span></a></span><span> </span><span class="annot"><span class="annottext">NodeTopology
</span><a href="#local-6989586621679262014"><span class="hs-identifier hs-var">nodeTopology</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621679261986"><span class="annot"><span class="annottext">Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m)
</span><a href="#local-6989586621679261986"><span class="hs-identifier hs-var">edgeStatusVars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
 -&gt; Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m))
-&gt; m [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
-&gt; m (Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
-&gt; Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
 -&gt; Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m))
-&gt; ([[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
    -&gt; [((CoreNodeId, CoreNodeId), EdgeStatusVar m)])
-&gt; [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
-&gt; Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
-&gt; [((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
 -&gt; m (Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m)))
-&gt; m [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
-&gt; m (Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-comment">-- assume they all use the same CodecConfig</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261983"><span class="annot"><span class="annottext">nodeInitData :: TestNodeInitialization m blk
</span><a href="#local-6989586621679261983"><span class="hs-identifier hs-var hs-var">nodeInitData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; TestNodeInitialization m blk
</span><a href="#local-6989586621679262021"><span class="hs-identifier hs-var">mkProtocolInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CoreNodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">CoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>          </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261982"><span class="annot"><span class="annottext">ProtocolInfo m blk
tniProtocolInfo :: ProtocolInfo m blk
tniProtocolInfo :: forall (m :: * -&gt; *) blk.
TestNodeInitialization m blk -&gt; ProtocolInfo m blk
</span><a href="#local-6989586621679261982"><span class="hs-identifier hs-var hs-var">tniProtocolInfo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TestNodeInitialization m blk
</span><a href="#local-6989586621679261983"><span class="hs-identifier hs-var">nodeInitData</span></a></span><span>
</span><span id="line-348"></span><span>          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261981"><span class="annot"><span class="annottext">TopLevelConfig blk
pInfoConfig :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
pInfoConfig :: TopLevelConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">pInfoConfig</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261982"><span class="hs-identifier hs-var">tniProtocolInfo</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span id="local-6989586621679261979"><span class="annot"><span class="annottext">codecConfig :: CodecConfig blk
</span><a href="#local-6989586621679261979"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; CodecConfig blk
forall blk. TopLevelConfig blk -&gt; CodecConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261981"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><span class="annottext">[(CoreNodeId, CoreNodeId)]
-&gt; ((CoreNodeId, CoreNodeId)
    -&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)])
-&gt; m [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(CoreNodeId, CoreNodeId)]
</span><a href="#local-6989586621679261988"><span class="hs-identifier hs-var">uedges</span></a></span><span> </span><span class="annot"><span class="annottext">(((CoreNodeId, CoreNodeId)
  -&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)])
 -&gt; m [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]])
-&gt; ((CoreNodeId, CoreNodeId)
    -&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)])
-&gt; m [[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261977"><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId)
</span><a href="#local-6989586621679261977"><span class="hs-identifier hs-var">uedge</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; OracularClock m
-&gt; Tracer m (SlotNo, MiniProtocolState)
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; Map CoreNodeId (StrictTVar m (VertexStatus m blk))
-&gt; (CoreNodeId, CoreNodeId)
-&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
forall (m :: * -&gt; *) blk.
(IOLike m, RunNode blk, HasCallStack) =&gt;
ResourceRegistry m
-&gt; OracularClock m
-&gt; Tracer m (SlotNo, MiniProtocolState)
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; Map CoreNodeId (VertexStatusVar m blk)
-&gt; (CoreNodeId, CoreNodeId)
-&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
</span><a href="Test.ThreadNet.Network.html#forkBothEdges"><span class="hs-identifier hs-var">forkBothEdges</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679262009"><span class="hs-identifier hs-var">sharedRegistry</span></a></span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679262006"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-354"></span><span>          </span><span class="hs-comment">-- traces when/why the mini protocol instances start and stop</span><span>
</span><span id="line-355"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
forall (m :: * -&gt; *) a. (Applicative m, Show a) =&gt; Tracer m a
</span><a href="Test.ThreadNet.Network.html#nullDebugTracer"><span class="hs-identifier hs-var">nullDebugTracer</span></a></span><span>
</span><span id="line-356"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679262012"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679262011"><span class="hs-identifier hs-var">blockVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679261979"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CalcMessageDelay blk
</span><a href="#local-6989586621679262018"><span class="hs-identifier hs-var">calcMessageDelay</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>          </span><span class="annot"><span class="annottext">Map CoreNodeId (StrictTVar m (VertexStatus m blk))
</span><a href="#local-6989586621679262004"><span class="hs-identifier hs-var">vertexStatusVars</span></a></span><span>
</span><span id="line-359"></span><span>          </span><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId)
</span><a href="#local-6989586621679261977"><span class="hs-identifier hs-var">uedge</span></a></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-comment">-- fork the vertices</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261974"><span class="annot"><span class="annottext">nodesByJoinSlot :: [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
</span><a href="#local-6989586621679261974"><span class="hs-identifier hs-var hs-var">nodesByJoinSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>          </span><span class="annot"><span class="annottext">((SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))
 -&gt; SlotNo)
-&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
-&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">List.sortOn</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk))) -&gt; SlotNo
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
 -&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))])
-&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
-&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>   </span><span class="hs-comment">-- sort non-descending by join slot</span><span>
</span><span id="line-364"></span><span>          </span><span class="annot"><span class="annottext">((CoreNodeId, StrictTVar m (VertexStatus m blk))
 -&gt; (SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk))))
-&gt; [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
-&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679261972"><span class="annot"><span class="annottext">nv :: (CoreNodeId, StrictTVar m (VertexStatus m blk))
</span><a href="#local-6989586621679261972"><span class="hs-identifier hs-var">nv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679261971"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261971"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId -&gt; SlotNo
</span><a href="#local-6989586621679261970"><span class="hs-identifier hs-var">joinSlotOf</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261971"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, StrictTVar m (VertexStatus m blk))
</span><a href="#local-6989586621679261972"><span class="hs-identifier hs-var">nv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(CoreNodeId, StrictTVar m (VertexStatus m blk))]
 -&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))])
-&gt; [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
-&gt; [(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-365"></span><span>          </span><span class="annot"><span class="annottext">Map CoreNodeId (StrictTVar m (VertexStatus m blk))
-&gt; [(CoreNodeId, StrictTVar m (VertexStatus m blk))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map CoreNodeId (StrictTVar m (VertexStatus m blk))
</span><a href="#local-6989586621679262004"><span class="hs-identifier hs-var">vertexStatusVars</span></a></span><span>
</span><span id="line-366"></span><span>    </span><span id="local-6989586621679261968"><span class="annot"><span class="annottext">[(CoreNodeId, StrictTVar m (VertexStatus m blk),
  m (NodeInfo blk MockFS []))]
</span><a href="#local-6989586621679261968"><span class="hs-identifier hs-var">vertexInfos0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
-&gt; ((SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))
    -&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk),
          m (NodeInfo blk MockFS [])))
-&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk),
       m (NodeInfo blk MockFS []))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))]
</span><a href="#local-6989586621679261974"><span class="hs-identifier hs-var">nodesByJoinSlot</span></a></span><span> </span><span class="annot"><span class="annottext">(((SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))
  -&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk),
        m (NodeInfo blk MockFS [])))
 -&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk),
        m (NodeInfo blk MockFS []))])
-&gt; ((SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))
    -&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk),
          m (NodeInfo blk MockFS [])))
-&gt; m [(CoreNodeId, StrictTVar m (VertexStatus m blk),
       m (NodeInfo blk MockFS []))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261967"><span class="annot"><span class="annottext">(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))
</span><a href="#local-6989586621679261967"><span class="hs-identifier hs-var">vertexData</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-367"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261966"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261966"><span class="hs-identifier hs-var">joinSlot</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261965"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261965"><span class="hs-identifier hs-var">coreNodeId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261964"><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261964"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SlotNo, (CoreNodeId, StrictTVar m (VertexStatus m blk)))
</span><a href="#local-6989586621679261967"><span class="hs-identifier hs-var">vertexData</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>      </span><span class="hs-comment">-- the vertex cannot create its first node instance until the</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-comment">-- 'NodeJoinPlan' allows</span><span>
</span><span id="line-371"></span><span>      </span><span id="local-6989586621679261963"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261963"><span class="hs-identifier hs-var">tooLate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; SlotNo -&gt; m Bool
forall (m :: * -&gt; *). OracularClock m -&gt; SlotNo -&gt; m Bool
</span><a href="Test.Util.HardFork.OracularClock.html#blockUntilSlot"><span class="hs-identifier hs-var hs-var">OracularClock.blockUntilSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679262006"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261966"><span class="hs-identifier hs-var">joinSlot</span></a></span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261963"><span class="hs-identifier hs-var">tooLate</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unsatisfiable nodeJoinPlan: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261965"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>      </span><span class="hs-comment">-- fork the per-vertex state variables, including the mock filesystem</span><span>
</span><span id="line-376"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261959"><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261959"><span class="hs-identifier hs-var">nodeInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261958"><span class="annot"><span class="annottext">m (NodeInfo blk MockFS [])
</span><a href="#local-6989586621679261958"><span class="hs-identifier hs-var">readNodeInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (NodeInfo blk (StrictTVar m MockFS) (Tracer m),
   m (NodeInfo blk MockFS []))
forall blk (m :: * -&gt; *).
IOLike m =&gt;
m (NodeInfo blk (StrictTVar m MockFS) (Tracer m),
   m (NodeInfo blk MockFS []))
</span><a href="Test.ThreadNet.Network.html#newNodeInfo"><span class="hs-identifier hs-var">newNodeInfo</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-comment">-- a tvar containing the next slot to be recorded in</span><span>
</span><span id="line-379"></span><span>      </span><span class="hs-comment">-- nodeEventsTipBlockNos</span><span>
</span><span id="line-380"></span><span>      </span><span id="local-6989586621679261956"><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261956"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; m (StrictTVar m SlotNo)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">uncheckedNewTVarM</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261966"><span class="hs-identifier hs-var">joinSlot</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261955"><span class="annot"><span class="annottext">myEdgeStatusVars :: [EdgeStatusVar m]
</span><a href="#local-6989586621679261955"><span class="hs-identifier hs-var hs-var">myEdgeStatusVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261954"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-384"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679261953"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261953"><span class="hs-identifier hs-var">n1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261952"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261952"><span class="hs-identifier hs-var">n2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261954"><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261954"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m)
-&gt; [((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map (CoreNodeId, CoreNodeId) (EdgeStatusVar m)
</span><a href="#local-6989586621679261986"><span class="hs-identifier hs-var">edgeStatusVars</span></a></span><span>
</span><span id="line-385"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261965"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; [CoreNodeId] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261953"><span class="hs-identifier hs-var">n1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261952"><span class="hs-identifier hs-var">n2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-386"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><span class="annottext">Maybe (RekeyM m blk)
-&gt; OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; CoreNodeId
-&gt; StrictTVar m (VertexStatus m blk)
-&gt; [EdgeStatusVar m]
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; StrictTVar m SlotNo
-&gt; m ()
</span><a href="#local-6989586621679261950"><span class="hs-identifier hs-var">forkVertex</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">Maybe (RekeyM m blk)
</span><a href="#local-6989586621679262008"><span class="hs-identifier hs-var">mbRekeyM</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679262006"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261966"><span class="hs-identifier hs-var">joinSlot</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679262009"><span class="hs-identifier hs-var">sharedRegistry</span></a></span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261965"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261964"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="annottext">[EdgeStatusVar m]
</span><a href="#local-6989586621679261955"><span class="hs-identifier hs-var">myEdgeStatusVars</span></a></span><span>
</span><span id="line-395"></span><span>        </span><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261959"><span class="hs-identifier hs-var">nodeInfo</span></a></span><span>
</span><span id="line-396"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261956"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">OracularClock m
-&gt; ResourceRegistry m
-&gt; StrictTVar m (VertexStatus m blk)
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; StrictTVar m SlotNo
-&gt; m ()
</span><a href="#local-6989586621679261949"><span class="hs-identifier hs-var">forkInstrumentation</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679262006"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679262009"><span class="hs-identifier hs-var">sharedRegistry</span></a></span><span>
</span><span id="line-401"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261964"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261959"><span class="hs-identifier hs-var">nodeInfo</span></a></span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261956"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><span class="annottext">(CoreNodeId, StrictTVar m (VertexStatus m blk),
 m (NodeInfo blk MockFS []))
-&gt; m (CoreNodeId, StrictTVar m (VertexStatus m blk),
      m (NodeInfo blk MockFS []))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261965"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261964"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (NodeInfo blk MockFS [])
</span><a href="#local-6989586621679261958"><span class="hs-identifier hs-var">readNodeInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-comment">-- Wait for the last slot to end</span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><span class="annottext">OracularClock m -&gt; m ()
forall (m :: * -&gt; *). OracularClock m -&gt; m ()
</span><a href="Test.Util.HardFork.OracularClock.html#waitUntilDone"><span class="hs-identifier hs-var hs-var">OracularClock.waitUntilDone</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679262006"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-comment">-- Collect all nodes' final chains</span><span>
</span><span id="line-411"></span><span>    </span><span id="local-6989586621679261947"><span class="annot"><span class="annottext">[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
</span><a href="#local-6989586621679261947"><span class="hs-identifier hs-var">vertexInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-412"></span><span>      </span><span class="annot"><span class="annottext">STM
  m
  [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
    LedgerState blk)]
-&gt; m [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
       LedgerState blk)]
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
     LedgerState blk)]
 -&gt; m [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
        LedgerState blk)])
-&gt; STM
     m
     [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
       LedgerState blk)]
-&gt; m [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
       LedgerState blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><span class="annottext">[(CoreNodeId, StrictTVar m (VertexStatus m blk),
  m (NodeInfo blk MockFS []))]
-&gt; ((CoreNodeId, StrictTVar m (VertexStatus m blk),
     m (NodeInfo blk MockFS []))
    -&gt; STM
         m
         (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
          LedgerState blk))
-&gt; STM
     m
     [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
       LedgerState blk)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(CoreNodeId, StrictTVar m (VertexStatus m blk),
  m (NodeInfo blk MockFS []))]
</span><a href="#local-6989586621679261968"><span class="hs-identifier hs-var">vertexInfos0</span></a></span><span> </span><span class="annot"><span class="annottext">(((CoreNodeId, StrictTVar m (VertexStatus m blk),
   m (NodeInfo blk MockFS []))
  -&gt; STM
       m
       (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
        LedgerState blk))
 -&gt; STM
      m
      [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
        LedgerState blk)])
-&gt; ((CoreNodeId, StrictTVar m (VertexStatus m blk),
     m (NodeInfo blk MockFS []))
    -&gt; STM
         m
         (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
          LedgerState blk))
-&gt; STM
     m
     [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
       LedgerState blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679261945"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261945"><span class="hs-identifier hs-var">coreNodeId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261944"><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261944"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261943"><span class="annot"><span class="annottext">m (NodeInfo blk MockFS [])
</span><a href="#local-6989586621679261943"><span class="hs-identifier hs-var">readNodeInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk) -&gt; STM m (VertexStatus m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261944"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (VertexStatus m blk)
-&gt; (VertexStatus m blk
    -&gt; STM
         m
         (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
          LedgerState blk))
-&gt; STM
     m
     (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
      LedgerState blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-415"></span><span>          </span><span class="annot"><a href="Test.ThreadNet.Network.html#VDown"><span class="hs-identifier hs-type">VDown</span></a></span><span> </span><span id="local-6989586621679261941"><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261941"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679261940"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261940"><span class="hs-identifier hs-var">ldgr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
 LedgerState blk)
-&gt; STM
     m
     (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
      LedgerState blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261945"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (NodeInfo blk MockFS [])
</span><a href="#local-6989586621679261943"><span class="hs-identifier hs-var">readNodeInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261941"><span class="hs-identifier hs-var">ch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261940"><span class="hs-identifier hs-var">ldgr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>          </span><span class="annot"><span class="annottext">VertexStatus m blk
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
   LedgerState blk)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span>    </span><span class="annot"><span class="annottext">[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
-&gt; m (TestOutput blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
-&gt; m (TestOutput blk)
</span><a href="Test.ThreadNet.Network.html#mkTestOutput"><span class="hs-identifier hs-var">mkTestOutput</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
</span><a href="#local-6989586621679261947"><span class="hs-identifier hs-var">vertexInfos</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy (Show (LedgerView (BlockProtocol blk))) -&gt; ()
forall (c :: Constraint) (proxy :: Constraint -&gt; *).
c =&gt;
proxy c -&gt; ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy (Show (LedgerView (BlockProtocol blk)))
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-comment">-- epoch size of the first era (ie the one that might have EBBs)</span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><a href="#local-6989586621679261935"><span class="hs-identifier hs-type">epochSize0</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochSize</span></span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621679261935"><span class="annot"><span class="annottext">epochSize0 :: EpochSize
</span><a href="#local-6989586621679261935"><span class="hs-identifier hs-var hs-var">epochSize0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; EpochSize
</span><a href="Test.Util.HardFork.Future.html#futureFirstEpochSize"><span class="hs-identifier hs-var">HFF.futureFirstEpochSize</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621679262023"><span class="hs-identifier hs-var">future</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>    </span><span class="annot"><a href="#local-6989586621679262001"><span class="hs-identifier hs-type">coreNodeIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621679262001"><span class="annot"><span class="annottext">coreNodeIds :: [CoreNodeId]
</span><a href="#local-6989586621679262001"><span class="hs-identifier hs-var hs-var">coreNodeIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NumCoreNodes -&gt; [CoreNodeId]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">enumCoreNodes</span></a></span><span> </span><span class="annot"><span class="annottext">NumCoreNodes
</span><a href="#local-6989586621679262020"><span class="hs-identifier hs-var">numCoreNodes</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>    </span><span class="annot"><a href="#local-6989586621679261970"><span class="hs-identifier hs-type">joinSlotOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-430"></span><span>    </span><span id="local-6989586621679261970"><span class="annot"><span class="annottext">joinSlotOf :: CoreNodeId -&gt; SlotNo
</span><a href="#local-6989586621679261970"><span class="hs-identifier hs-var hs-var">joinSlotOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; NodeJoinPlan -&gt; CoreNodeId -&gt; SlotNo
NodeJoinPlan -&gt; CoreNodeId -&gt; SlotNo
</span><a href="Test.ThreadNet.Util.NodeJoinPlan.html#coreNodeIdJoinSlot"><span class="hs-identifier hs-var">coreNodeIdJoinSlot</span></a></span><span> </span><span class="annot"><span class="annottext">NodeJoinPlan
</span><a href="#local-6989586621679262022"><span class="hs-identifier hs-var">nodeJoinPlan</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>    </span><span class="annot"><a href="#local-6989586621679261950"><span class="hs-identifier hs-type">forkVertex</span></a></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#RekeyM"><span class="hs-identifier hs-type">RekeyM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-435"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatusVar"><span class="hs-identifier hs-type">EdgeStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-442"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>    </span><span id="local-6989586621679261950"><span class="annot"><span class="annottext">forkVertex :: Maybe (RekeyM m blk)
-&gt; OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; CoreNodeId
-&gt; StrictTVar m (VertexStatus m blk)
-&gt; [EdgeStatusVar m]
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; StrictTVar m SlotNo
-&gt; m ()
</span><a href="#local-6989586621679261950"><span class="hs-identifier hs-var hs-var">forkVertex</span></a></span></span><span>
</span><span id="line-444"></span><span>      </span><span id="local-6989586621679261931"><span class="annot"><span class="annottext">Maybe (RekeyM m blk)
</span><a href="#local-6989586621679261931"><span class="hs-identifier hs-var">mbRekeyM</span></a></span></span><span>
</span><span id="line-445"></span><span>      </span><span id="local-6989586621679261930"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261930"><span class="hs-identifier hs-var">clock</span></a></span></span><span>
</span><span id="line-446"></span><span>      </span><span id="local-6989586621679261929"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261929"><span class="hs-identifier hs-var">joinSlot</span></a></span></span><span>
</span><span id="line-447"></span><span>      </span><span id="local-6989586621679261928"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261928"><span class="hs-identifier hs-var">sharedRegistry</span></a></span></span><span>
</span><span id="line-448"></span><span>      </span><span id="local-6989586621679261927"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span></span><span>
</span><span id="line-449"></span><span>      </span><span id="local-6989586621679261926"><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261926"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span></span><span>
</span><span id="line-450"></span><span>      </span><span id="local-6989586621679261925"><span class="annot"><span class="annottext">[EdgeStatusVar m]
</span><a href="#local-6989586621679261925"><span class="hs-identifier hs-var">edgeStatusVars</span></a></span></span><span>
</span><span id="line-451"></span><span>      </span><span id="local-6989586621679261924"><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261924"><span class="hs-identifier hs-var">nodeInfo</span></a></span></span><span>
</span><span id="line-452"></span><span>      </span><span id="local-6989586621679261923"><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261923"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-453"></span><span>        </span><span class="annot"><span class="annottext">m (Thread m ()) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (Thread m ()) -&gt; m ()) -&gt; m (Thread m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m () -&gt; m (Thread m ())
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">forkLinkedThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261928"><span class="hs-identifier hs-var">sharedRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261920"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (Thread m ())) -&gt; m () -&gt; m (Thread m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>          </span><span class="annot"><span class="annottext">SlotNo
-&gt; ProtocolInfo m blk
-&gt; NodeRestart
-&gt; Map SlotNo NodeRestart
-&gt; m ()
</span><a href="#local-6989586621679261919"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261918"><span class="hs-identifier hs-var">tniProtocolInfo</span></a></span><span> </span><span class="annot"><span class="annottext">NodeRestart
</span><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRestart"><span class="hs-identifier hs-var">NodeRestart</span></a></span><span> </span><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261916"><span class="hs-identifier hs-var">restarts0</span></a></span><span>
</span><span id="line-455"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-456"></span><span>        </span><span id="local-6989586621679261920"><span class="annot"><span class="annottext">label :: String
</span><a href="#local-6989586621679261920"><span class="hs-keyword hs-var hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vertex-&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Condense a =&gt; a -&gt; String
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">condense</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span>
</span><span id="line-459"></span><span>           </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679261914"><span class="annot"><span class="annottext">[GenTx blk]
tniCrucialTxs :: [GenTx blk]
tniCrucialTxs :: forall (m :: * -&gt; *) blk.
TestNodeInitialization m blk -&gt; [GenTx blk]
</span><a href="#local-6989586621679261914"><span class="hs-identifier hs-var hs-var">tniCrucialTxs</span></a></span></span><span>
</span><span id="line-460"></span><span>           </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261918"><span class="annot"><span class="annottext">ProtocolInfo m blk
tniProtocolInfo :: ProtocolInfo m blk
tniProtocolInfo :: forall (m :: * -&gt; *) blk.
TestNodeInitialization m blk -&gt; ProtocolInfo m blk
</span><a href="#local-6989586621679261918"><span class="hs-identifier hs-var hs-var">tniProtocolInfo</span></a></span></span><span>
</span><span id="line-461"></span><span>           </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; TestNodeInitialization m blk
</span><a href="#local-6989586621679262021"><span class="hs-identifier hs-var">mkProtocolInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span>        </span><span class="annot"><a href="#local-6989586621679261916"><span class="hs-identifier hs-type">restarts0</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRestart"><span class="hs-identifier hs-type">NodeRestart</span></a></span><span>
</span><span id="line-464"></span><span>        </span><span id="local-6989586621679261916"><span class="annot"><span class="annottext">restarts0 :: Map SlotNo NodeRestart
</span><a href="#local-6989586621679261916"><span class="hs-identifier hs-var hs-var">restarts0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map CoreNodeId NodeRestart -&gt; Maybe NodeRestart)
-&gt; Map SlotNo (Map CoreNodeId NodeRestart)
-&gt; Map SlotNo NodeRestart
forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId -&gt; Map CoreNodeId NodeRestart -&gt; Maybe NodeRestart
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map SlotNo (Map CoreNodeId NodeRestart)
</span><a href="#local-6989586621679261911"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-465"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-466"></span><span>            </span><span class="annot"><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRestarts"><span class="hs-identifier hs-type">NodeRestarts</span></a></span><span> </span><span id="local-6989586621679261911"><span class="annot"><span class="annottext">Map SlotNo (Map CoreNodeId NodeRestart)
</span><a href="#local-6989586621679261911"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeRestarts
</span><a href="#local-6989586621679262015"><span class="hs-identifier hs-var">nodeRestarts</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>        </span><span class="annot"><a href="#local-6989586621679261919"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-469"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-470"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRestart"><span class="hs-identifier hs-type">NodeRestart</span></a></span><span>
</span><span id="line-471"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRestart"><span class="hs-identifier hs-type">NodeRestart</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>        </span><span id="local-6989586621679261919"><span class="annot"><span class="annottext">loop :: SlotNo
-&gt; ProtocolInfo m blk
-&gt; NodeRestart
-&gt; Map SlotNo NodeRestart
-&gt; m ()
</span><a href="#local-6989586621679261919"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679261909"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261909"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679261908"><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261908"><span class="hs-identifier hs-var">pInfo</span></a></span></span><span> </span><span id="local-6989586621679261907"><span class="annot"><span class="annottext">NodeRestart
</span><a href="#local-6989586621679261907"><span class="hs-identifier hs-var">nr</span></a></span></span><span> </span><span id="local-6989586621679261906"><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261906"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-473"></span><span>          </span><span class="hs-comment">-- a registry solely for the resources of this specific node instance</span><span>
</span><span id="line-474"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679261905"><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
</span><a href="#local-6989586621679261905"><span class="hs-identifier hs-var">again</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261904"><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261904"><span class="hs-identifier hs-var">finalChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261903"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261903"><span class="hs-identifier hs-var">finalLdgr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ResourceRegistry m
 -&gt; m (Maybe
         (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
       Chain blk, LedgerState blk))
-&gt; m (Maybe
        (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
      Chain blk, LedgerState blk)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">withRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">((ResourceRegistry m
  -&gt; m (Maybe
          (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
        Chain blk, LedgerState blk))
 -&gt; m (Maybe
         (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
       Chain blk, LedgerState blk))
-&gt; (ResourceRegistry m
    -&gt; m (Maybe
            (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
          Chain blk, LedgerState blk))
-&gt; m (Maybe
        (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
      Chain blk, LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261902"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261902"><span class="hs-identifier hs-var">nodeRegistry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-475"></span><span>            </span><span class="hs-comment">-- change the node's key and prepare a delegation transaction if</span><span>
</span><span id="line-476"></span><span>            </span><span class="hs-comment">-- the node is restarting because it just rekeyed</span><span>
</span><span id="line-477"></span><span>            </span><span id="local-6989586621679261901"><span class="annot"><span class="annottext">TestNodeInitialization m blk
</span><a href="#local-6989586621679261901"><span class="hs-identifier hs-var">tni'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeRestart
</span><a href="#local-6989586621679261907"><span class="hs-identifier hs-var">nr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (RekeyM m blk)
</span><a href="#local-6989586621679261931"><span class="hs-identifier hs-var">mbRekeyM</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-478"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeRestart
</span><a href="Test.ThreadNet.Util.NodeRestarts.html#NodeRekey"><span class="hs-identifier hs-var">NodeRekey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679261899"><span class="annot"><span class="annottext">RekeyM m blk
</span><a href="#local-6989586621679261899"><span class="hs-identifier hs-var">rekeyM</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-479"></span><span>                </span><span class="annot"><span class="annottext">RekeyM m blk
</span><a href="#local-6989586621679261899"><span class="hs-identifier hs-var">rekeyM</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261908"><span class="hs-identifier hs-var">pInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261909"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EpochNo -&gt; m EpochNo
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EpochNo -&gt; m EpochNo)
-&gt; (SlotNo -&gt; EpochNo) -&gt; SlotNo -&gt; m EpochNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Future -&gt; SlotNo -&gt; EpochNo
</span><a href="Test.Util.HardFork.Future.html#futureSlotToEpoch"><span class="hs-identifier hs-var">HFF.futureSlotToEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621679262023"><span class="hs-identifier hs-var">future</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>              </span><span class="annot"><span class="annottext">(NodeRestart, Maybe (RekeyM m blk))
</span><span class="hs-identifier">_</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-481"></span><span>                  </span><span class="annot"><span class="annottext">TestNodeInitialization m blk -&gt; m (TestNodeInitialization m blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TestNodeInitialization m blk -&gt; m (TestNodeInitialization m blk))
-&gt; TestNodeInitialization m blk -&gt; m (TestNodeInitialization m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk -&gt; TestNodeInitialization m blk
forall (m :: * -&gt; *) blk.
ProtocolInfo m blk -&gt; TestNodeInitialization m blk
</span><a href="Test.ThreadNet.Network.html#plainTestNodeInitialization"><span class="hs-identifier hs-var">plainTestNodeInitialization</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261908"><span class="hs-identifier hs-var">pInfo</span></a></span><span>
</span><span id="line-482"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TestNodeInitialization"><span class="hs-identifier hs-type">TestNodeInitialization</span></a></span><span>
</span><span id="line-483"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tniCrucialTxs :: forall (m :: * -&gt; *) blk.
TestNodeInitialization m blk -&gt; [GenTx blk]
</span><a href="Test.ThreadNet.Network.html#tniCrucialTxs"><span class="hs-identifier hs-var">tniCrucialTxs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679261897"><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261897"><span class="hs-identifier hs-var">crucialTxs'</span></a></span></span><span>
</span><span id="line-484"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tniProtocolInfo :: forall (m :: * -&gt; *) blk.
TestNodeInitialization m blk -&gt; ProtocolInfo m blk
</span><a href="Test.ThreadNet.Network.html#tniProtocolInfo"><span class="hs-identifier hs-var">tniProtocolInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679261896"><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261896"><span class="hs-identifier hs-var">pInfo'</span></a></span></span><span>
</span><span id="line-485"></span><span>                  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TestNodeInitialization m blk
</span><a href="#local-6989586621679261901"><span class="hs-identifier hs-var">tni'</span></a></span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span>            </span><span class="hs-comment">-- allocate the node's internal state and fork its internal threads</span><span>
</span><span id="line-488"></span><span>            </span><span class="hs-comment">-- (specifically not the communication threads running the Mini</span><span>
</span><span id="line-489"></span><span>            </span><span class="hs-comment">-- Protocols, like the ChainSync Client)</span><span>
</span><span id="line-490"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679261895"><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261895"><span class="hs-identifier hs-var">kernel</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261894"><span class="annot"><span class="annottext">LimitedApp m NodeId blk
</span><a href="#local-6989586621679261894"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
CoreNodeId
-&gt; OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; ProtocolInfo m blk
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; [GenTx blk]
-&gt; m (NodeKernel m NodeId Void blk, LimitedApp m NodeId blk)
CoreNodeId
-&gt; OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; ProtocolInfo m blk
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; [GenTx blk]
-&gt; m (NodeKernel m NodeId Void blk, LimitedApp m NodeId blk)
</span><a href="#local-6989586621679261893"><span class="hs-identifier hs-var">forkNode</span></a></span><span>
</span><span id="line-491"></span><span>              </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-492"></span><span>              </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261930"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-493"></span><span>              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261929"><span class="hs-identifier hs-var">joinSlot</span></a></span><span>
</span><span id="line-494"></span><span>              </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261902"><span class="hs-identifier hs-var">nodeRegistry</span></a></span><span>
</span><span id="line-495"></span><span>              </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261896"><span class="hs-identifier hs-var">pInfo'</span></a></span><span>
</span><span id="line-496"></span><span>              </span><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261924"><span class="hs-identifier hs-var">nodeInfo</span></a></span><span>
</span><span id="line-497"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261897"><span class="hs-identifier hs-var">crucialTxs'</span></a></span><span> </span><span class="annot"><span class="annottext">[GenTx blk] -&gt; [GenTx blk] -&gt; [GenTx blk]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261914"><span class="hs-identifier hs-var">tniCrucialTxs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk) -&gt; VertexStatus m blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261926"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">(VertexStatus m blk -&gt; STM m ()) -&gt; VertexStatus m blk -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
-&gt; LimitedApp m NodeId blk -&gt; VertexStatus m blk
forall (m :: * -&gt; *) blk.
NodeKernel m NodeId Void blk
-&gt; LimitedApp m NodeId blk -&gt; VertexStatus m blk
</span><a href="Test.ThreadNet.Network.html#VUp"><span class="hs-identifier hs-var">VUp</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261895"><span class="hs-identifier hs-var">kernel</span></a></span><span> </span><span class="annot"><span class="annottext">LimitedApp m NodeId blk
</span><a href="#local-6989586621679261894"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span>            </span><span class="hs-comment">-- wait until this node instance should stop</span><span>
</span><span id="line-501"></span><span>            </span><span id="local-6989586621679261891"><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
</span><a href="#local-6989586621679261891"><span class="hs-identifier hs-var">again</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Map SlotNo NodeRestart
-&gt; Maybe ((SlotNo, NodeRestart), Map SlotNo NodeRestart)
forall k a. Map k a -&gt; Maybe ((k, a), Map k a)
</span><span class="hs-identifier hs-var">Map.minViewWithKey</span></span><span> </span><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261906"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-502"></span><span>              </span><span class="hs-comment">-- end of test</span><span>
</span><span id="line-503"></span><span>              </span><span class="annot"><span class="annottext">Maybe ((SlotNo, NodeRestart), Map SlotNo NodeRestart)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>                </span><span class="annot"><span class="annottext">OracularClock m -&gt; m ()
forall (m :: * -&gt; *). OracularClock m -&gt; m ()
</span><a href="Test.Util.HardFork.OracularClock.html#waitUntilDone"><span class="hs-identifier hs-var hs-var">OracularClock.waitUntilDone</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261930"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-505"></span><span>                </span><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
-&gt; m (Maybe
        (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-506"></span><span>              </span><span class="hs-comment">-- onset of schedule restart slot</span><span>
</span><span id="line-507"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679261889"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261889"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261888"><span class="annot"><span class="annottext">NodeRestart
</span><a href="#local-6989586621679261888"><span class="hs-identifier hs-var">nr'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261887"><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261887"><span class="hs-identifier hs-var">rs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>                </span><span class="hs-comment">-- wait until the node should stop</span><span>
</span><span id="line-509"></span><span>                </span><span id="local-6989586621679261886"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261886"><span class="hs-identifier hs-var">tooLate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; SlotNo -&gt; m Bool
forall (m :: * -&gt; *). OracularClock m -&gt; SlotNo -&gt; m Bool
</span><a href="Test.Util.HardFork.OracularClock.html#blockUntilSlot"><span class="hs-identifier hs-var hs-var">OracularClock.blockUntilSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261930"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261889"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-510"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261886"><span class="hs-identifier hs-var">tooLate</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unsatisfiable nodeRestarts: &quot;</span></span><span>
</span><span id="line-512"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, SlotNo) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261927"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261889"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>                </span><span class="hs-comment">-- this synchronization prevents a race with the</span><span>
</span><span id="line-515"></span><span>                </span><span class="hs-comment">-- instrumentation thread: we it want to record the current</span><span>
</span><span id="line-516"></span><span>                </span><span class="hs-comment">-- block number at the start of the slot, before this vertex</span><span>
</span><span id="line-517"></span><span>                </span><span class="hs-comment">-- restarts the node</span><span>
</span><span id="line-518"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>                  </span><span id="local-6989586621679261885"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261885"><span class="hs-identifier hs-var">nextSlot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo -&gt; STM m SlotNo
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261923"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span><span>
</span><span id="line-520"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (stm :: * -&gt; *). MonadSTMTx stm =&gt; Bool -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m ()) -&gt; Bool -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261885"><span class="hs-identifier hs-var">nextSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261889"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>                </span><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
-&gt; m (Maybe
        (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe
   (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
 -&gt; m (Maybe
         (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)))
-&gt; Maybe
     (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
-&gt; m (Maybe
        (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
-&gt; Maybe
     (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261889"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261896"><span class="hs-identifier hs-var">pInfo'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NodeRestart
</span><a href="#local-6989586621679261888"><span class="hs-identifier hs-var">nr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261887"><span class="hs-identifier hs-var">rs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span>            </span><span class="hs-comment">-- stop threads that depend on/stimulate the kernel</span><span>
</span><span id="line-525"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk) -&gt; VertexStatus m blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261926"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">VertexStatus m blk
forall (m :: * -&gt; *) blk. VertexStatus m blk
</span><a href="Test.ThreadNet.Network.html#VFalling"><span class="hs-identifier hs-var">VFalling</span></a></span><span>
</span><span id="line-526"></span><span>            </span><span class="annot"><span class="annottext">[EdgeStatusVar m] -&gt; (EdgeStatusVar m -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[EdgeStatusVar m]
</span><a href="#local-6989586621679261925"><span class="hs-identifier hs-var">edgeStatusVars</span></a></span><span> </span><span class="annot"><span class="annottext">((EdgeStatusVar m -&gt; m ()) -&gt; m ())
-&gt; (EdgeStatusVar m -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261882"><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261882"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>              </span><span class="annot"><span class="annottext">EdgeStatusVar m -&gt; STM m EdgeStatus
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261882"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM m EdgeStatus -&gt; (EdgeStatus -&gt; STM m ()) -&gt; STM m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (stm :: * -&gt; *). MonadSTMTx stm =&gt; Bool -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m ())
-&gt; (EdgeStatus -&gt; Bool) -&gt; EdgeStatus -&gt; STM m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EdgeStatus -&gt; EdgeStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EdgeStatus
</span><a href="Test.ThreadNet.Network.html#EDown"><span class="hs-identifier hs-var">EDown</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-comment">-- assuming nothing else is changing it, read the final chain</span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261881"><span class="annot"><span class="annottext">chainDB :: ChainDB m blk
</span><a href="#local-6989586621679261881"><span class="hs-identifier hs-var hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk -&gt; ChainDB m blk
forall (m :: * -&gt; *) remotePeer localPeer blk.
NodeKernel m remotePeer localPeer blk -&gt; ChainDB m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">getChainDB</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261895"><span class="hs-identifier hs-var">kernel</span></a></span><span>
</span><span id="line-531"></span><span>            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261879"><span class="annot"><span class="annottext">LedgerState blk
ledgerState :: LedgerState blk
ledgerState :: forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="#local-6989586621679261879"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (ExtLedgerState blk) -&gt; m (ExtLedgerState blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (ExtLedgerState blk) -&gt; m (ExtLedgerState blk))
-&gt; STM m (ExtLedgerState blk) -&gt; m (ExtLedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-532"></span><span>              </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
(Monad (STM m), IsLedger (LedgerState blk)) =&gt;
ChainDB m blk -&gt; STM m (ExtLedgerState blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.getCurrentLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261881"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-533"></span><span>            </span><span id="local-6989586621679261877"><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261877"><span class="hs-identifier hs-var">finalChain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; m (Chain blk)
forall (m :: * -&gt; *) blk.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ChainDB m blk -&gt; m (Chain blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.toChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261881"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span>            </span><span class="annot"><span class="annottext">(Maybe
   (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
 Chain blk, LedgerState blk)
-&gt; m (Maybe
        (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart),
      Chain blk, LedgerState blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
</span><a href="#local-6989586621679261891"><span class="hs-identifier hs-var">again</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261877"><span class="hs-identifier hs-var">finalChain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261879"><span class="hs-identifier hs-var">ledgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-comment">-- end of the node's withRegistry</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk) -&gt; VertexStatus m blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261926"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">(VertexStatus m blk -&gt; STM m ()) -&gt; VertexStatus m blk -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-539"></span><span>            </span><span class="annot"><span class="annottext">Chain blk -&gt; LedgerState blk -&gt; VertexStatus m blk
forall (m :: * -&gt; *) blk.
Chain blk -&gt; LedgerState blk -&gt; VertexStatus m blk
</span><a href="Test.ThreadNet.Network.html#VDown"><span class="hs-identifier hs-var">VDown</span></a></span><span> </span><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261904"><span class="hs-identifier hs-var">finalChain</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261903"><span class="hs-identifier hs-var">finalLdgr</span></a></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
</span><a href="#local-6989586621679261905"><span class="hs-identifier hs-var">again</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-542"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (SlotNo, ProtocolInfo m blk, NodeRestart, Map SlotNo NodeRestart)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261875"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261875"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261874"><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261874"><span class="hs-identifier hs-var">pInfo'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261873"><span class="annot"><span class="annottext">NodeRestart
</span><a href="#local-6989586621679261873"><span class="hs-identifier hs-var">nr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261872"><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261872"><span class="hs-identifier hs-var">rs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo
-&gt; ProtocolInfo m blk
-&gt; NodeRestart
-&gt; Map SlotNo NodeRestart
-&gt; m ()
</span><a href="#local-6989586621679261919"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261875"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261874"><span class="hs-identifier hs-var">pInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">NodeRestart
</span><a href="#local-6989586621679261873"><span class="hs-identifier hs-var">nr'</span></a></span><span> </span><span class="annot"><span class="annottext">Map SlotNo NodeRestart
</span><a href="#local-6989586621679261872"><span class="hs-identifier hs-var">rs'</span></a></span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-comment">-- | Instrumentation: record the tip's block number at the onset of the</span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-comment">-- slot.</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-comment">-- With such a short transaction (read a few TVars) we assume this runs (1)</span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- before anything else in the slot and (2) once per slot.</span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><a href="#local-6989586621679261949"><span class="hs-identifier hs-type">forkInstrumentation</span></a></span><span>
</span><span id="line-551"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-552"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-553"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-554"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-556"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>    </span><span id="local-6989586621679261949"><span class="annot"><span class="annottext">forkInstrumentation :: OracularClock m
-&gt; ResourceRegistry m
-&gt; StrictTVar m (VertexStatus m blk)
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; StrictTVar m SlotNo
-&gt; m ()
</span><a href="#local-6989586621679261949"><span class="hs-identifier hs-var hs-var">forkInstrumentation</span></a></span></span><span>
</span><span id="line-558"></span><span>      </span><span id="local-6989586621679261871"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261871"><span class="hs-identifier hs-var">clock</span></a></span></span><span>
</span><span id="line-559"></span><span>      </span><span id="local-6989586621679261870"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261870"><span class="hs-identifier hs-var">registry</span></a></span></span><span>
</span><span id="line-560"></span><span>      </span><span id="local-6989586621679261869"><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261869"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span></span><span>
</span><span id="line-561"></span><span>      </span><span id="local-6989586621679261868"><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261868"><span class="hs-identifier hs-var">nodeInfo</span></a></span></span><span>
</span><span id="line-562"></span><span>      </span><span id="local-6989586621679261867"><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261867"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-563"></span><span>        </span><span class="annot"><span class="annottext">m (m ()) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (m ()) -&gt; m ()) -&gt; m (m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; OracularClock m -&gt; String -&gt; (SlotNo -&gt; m ()) -&gt; m (m ())
forall (m :: * -&gt; *).
HasCallStack =&gt;
ResourceRegistry m
-&gt; OracularClock m -&gt; String -&gt; (SlotNo -&gt; m ()) -&gt; m (m ())
</span><a href="Test.Util.HardFork.OracularClock.html#forkEachSlot"><span class="hs-identifier hs-var">OracularClock.forkEachSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261870"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261871"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261865"><span class="hs-identifier hs-var">lbl</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; m ()) -&gt; m (m ())) -&gt; (SlotNo -&gt; m ()) -&gt; m (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261864"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261864"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>          </span><span id="local-6989586621679261863"><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679261863"><span class="hs-identifier hs-var">bno</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (WithOrigin BlockNo) -&gt; m (WithOrigin BlockNo)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (WithOrigin BlockNo) -&gt; m (WithOrigin BlockNo))
-&gt; STM m (WithOrigin BlockNo) -&gt; m (WithOrigin BlockNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk) -&gt; STM m (VertexStatus m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261869"><span class="hs-identifier hs-var">vertexStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (VertexStatus m blk)
-&gt; (VertexStatus m blk -&gt; STM m (WithOrigin BlockNo))
-&gt; STM m (WithOrigin BlockNo)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-565"></span><span>            </span><span class="annot"><a href="Test.ThreadNet.Network.html#VUp"><span class="hs-identifier hs-type">VUp</span></a></span><span> </span><span id="local-6989586621679261862"><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261862"><span class="hs-identifier hs-var">kernel</span></a></span></span><span> </span><span class="annot"><span class="annottext">LimitedApp m NodeId blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (WithOrigin BlockNo)
forall (m :: * -&gt; *) blk.
(Monad (STM m), HasHeader (Header blk)) =&gt;
ChainDB m blk -&gt; STM m (WithOrigin BlockNo)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.getTipBlockNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk -&gt; ChainDB m blk
forall (m :: * -&gt; *) remotePeer localPeer blk.
NodeKernel m remotePeer localPeer blk -&gt; ChainDB m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">getChainDB</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261862"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>            </span><span class="annot"><span class="annottext">VertexStatus m blk
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m (WithOrigin BlockNo)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-567"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (SlotNo, WithOrigin BlockNo)
-&gt; (SlotNo, WithOrigin BlockNo) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, WithOrigin BlockNo)
</span><a href="#local-6989586621679261859"><span class="hs-identifier hs-var">nodeEventsTipBlockNos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261864"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679261863"><span class="hs-identifier hs-var">bno</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo -&gt; (SlotNo -&gt; SlotNo) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261867"><span class="hs-identifier hs-var">nextInstrSlotVar</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; SlotNo) -&gt; STM m ()) -&gt; (SlotNo -&gt; SlotNo) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261864"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-570"></span><span>        </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261854"><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
nodeInfoEvents :: forall blk db (ev :: * -&gt; *).
NodeInfo blk db ev -&gt; NodeEvents blk ev
nodeInfoEvents :: NodeEvents blk (Tracer m)
</span><a href="Test.ThreadNet.Network.html#nodeInfoEvents"><span class="hs-identifier hs-var hs-var">nodeInfoEvents</span></a></span></span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261868"><span class="hs-identifier hs-var">nodeInfo</span></a></span><span>
</span><span id="line-571"></span><span>        </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-type">NodeEvents</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261859"><span class="annot"><span class="annottext">Tracer m (SlotNo, WithOrigin BlockNo)
nodeEventsTipBlockNos :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, WithOrigin BlockNo)
nodeEventsTipBlockNos :: Tracer m (SlotNo, WithOrigin BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsTipBlockNos"><span class="hs-identifier hs-var hs-var">nodeEventsTipBlockNos</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261854"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-572"></span><span>        </span><span id="local-6989586621679261865"><span class="annot"><span class="annottext">lbl :: String
</span><a href="#local-6989586621679261865"><span class="hs-identifier hs-var hs-var">lbl</span></a></span></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;instrumentation&quot;</span></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span>    </span><span class="hs-comment">-- | Persistently attempt to add the given transactions to the mempool</span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-comment">-- every time the ledger slot changes, even if successful!</span><span>
</span><span id="line-576"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-577"></span><span>    </span><span class="hs-comment">-- If we add the transaction and then the mempools discards it for some</span><span>
</span><span id="line-578"></span><span>    </span><span class="hs-comment">-- reason, this thread will add it again.</span><span>
</span><span id="line-579"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><a href="#local-6989586621679261850"><span class="hs-identifier hs-type">forkCrucialTxs</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-582"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-583"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-584"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-585"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-588"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Mempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TicketNo</span></a></span><span>
</span><span id="line-589"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-590"></span><span>         </span><span class="hs-comment">-- ^ valid transactions the node should immediately propagate</span><span>
</span><span id="line-591"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span>    </span><span id="local-6989586621679261850"><span class="annot"><span class="annottext">forkCrucialTxs :: OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; (SlotNo -&gt; STM m ())
-&gt; LedgerConfig blk
-&gt; STM m (LedgerState blk)
-&gt; Mempool m blk TicketNo
-&gt; [GenTx blk]
-&gt; m ()
</span><a href="#local-6989586621679261850"><span class="hs-identifier hs-var hs-var">forkCrucialTxs</span></a></span></span><span> </span><span id="local-6989586621679261849"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261849"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span id="local-6989586621679261848"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261848"><span class="hs-identifier hs-var">s0</span></a></span></span><span> </span><span id="local-6989586621679261847"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261847"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679261846"><span class="annot"><span class="annottext">SlotNo -&gt; STM m ()
</span><a href="#local-6989586621679261846"><span class="hs-identifier hs-var">unblockForge</span></a></span></span><span> </span><span id="local-6989586621679261845"><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621679261845"><span class="hs-identifier hs-var">lcfg</span></a></span></span><span> </span><span id="local-6989586621679261844"><span class="annot"><span class="annottext">STM m (LedgerState blk)
</span><a href="#local-6989586621679261844"><span class="hs-identifier hs-var">getLdgr</span></a></span></span><span> </span><span id="local-6989586621679261843"><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261843"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span id="local-6989586621679261842"><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261842"><span class="hs-identifier hs-var">txs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-593"></span><span>      </span><span class="annot"><span class="annottext">m (Thread m Any) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (Thread m Any) -&gt; m ()) -&gt; m (Thread m Any) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m Any -&gt; m (Thread m Any)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">forkLinkedThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261847"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;crucialTxs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(m Any -&gt; m (Thread m Any)) -&gt; m Any -&gt; m (Thread m Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-594"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261841"><span class="annot"><span class="annottext">wouldBeValid :: SlotNo -&gt; TickedLedgerState blk -&gt; GenTx blk -&gt; Bool
</span><a href="#local-6989586621679261841"><span class="hs-identifier hs-var hs-var">wouldBeValid</span></a></span></span><span> </span><span id="local-6989586621679261840"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261840"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621679261839"><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261839"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679261838"><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679261838"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-595"></span><span>                </span><span class="annot"><span class="annottext">Either
  (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
-&gt; Bool
forall a b. Either a b -&gt; Bool
</span><span class="hs-identifier hs-var">isRight</span></span><span> </span><span class="annot"><span class="annottext">(Either
   (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
 -&gt; Bool)
-&gt; Either
     (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
-&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Except
  (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
-&gt; Either
     (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
forall e a. Except e a -&gt; Either e a
</span><span class="hs-identifier hs-var">Exc.runExcept</span></span><span> </span><span class="annot"><span class="annottext">(Except
   (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
 -&gt; Either
      (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk)))
-&gt; Except
     (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
-&gt; Either
     (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; SlotNo
-&gt; GenTx blk
-&gt; TickedLedgerState blk
-&gt; Except
     (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
forall blk.
LedgerSupportsMempool blk =&gt;
LedgerConfig blk
-&gt; SlotNo
-&gt; GenTx blk
-&gt; TickedLedgerState blk
-&gt; Except
     (ApplyTxErr blk) (TickedLedgerState blk, Validated (GenTx blk))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">applyTx</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621679261845"><span class="hs-identifier hs-var">lcfg</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261840"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679261838"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261839"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span>            </span><span id="local-6989586621679261835"><span class="annot"><span class="annottext">checkSt :: SlotNo -&gt; MempoolSnapshot blk TicketNo -&gt; Bool
</span><a href="#local-6989586621679261835"><span class="hs-identifier hs-var hs-var">checkSt</span></a></span></span><span> </span><span id="local-6989586621679261834"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261834"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621679261833"><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261833"><span class="hs-identifier hs-var">snap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-598"></span><span>                </span><span class="annot"><span class="annottext">(GenTx blk -&gt; Bool) -&gt; [GenTx blk] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; TickedLedgerState blk -&gt; GenTx blk -&gt; Bool
</span><a href="#local-6989586621679261841"><span class="hs-identifier hs-var">wouldBeValid</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261834"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo -&gt; TickedLedgerState blk
forall blk idx. MempoolSnapshot blk idx -&gt; TickedLedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">snapshotLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261833"><span class="hs-identifier hs-var">snap</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261842"><span class="hs-identifier hs-var">txs0</span></a></span><span>
</span><span id="line-599"></span><span>
</span><span id="line-600"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261830"><span class="annot"><span class="annottext">loop :: (SlotNo, LedgerState blk, [TicketNo]) -&gt; m Any
</span><a href="#local-6989586621679261830"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261829"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261828"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261828"><span class="hs-identifier hs-var">ledger</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261827"><span class="annot"><span class="annottext">[TicketNo]
</span><a href="#local-6989586621679261827"><span class="hs-identifier hs-var">mempFp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-601"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679261826"><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261826"><span class="hs-identifier hs-var">snap1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261825"><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261825"><span class="hs-identifier hs-var">snap2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
-&gt; m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
 -&gt; m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo))
-&gt; STM
     m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
-&gt; m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-602"></span><span>                </span><span id="local-6989586621679261824"><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261824"><span class="hs-identifier hs-var">snap1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk TicketNo)
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk idx)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">getSnapshotFor</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261843"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">(ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk TicketNo))
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk TicketNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-603"></span><span>                  </span><span class="hs-comment">-- This node would include these crucial txs if it leads in</span><span>
</span><span id="line-604"></span><span>                  </span><span class="hs-comment">-- this slot.</span><span>
</span><span id="line-605"></span><span>                  </span><span class="annot"><span class="annottext">SlotNo -&gt; TickedLedgerState blk -&gt; ForgeLedgerState blk
forall blk. SlotNo -&gt; TickedLedgerState blk -&gt; ForgeLedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ForgeInKnownSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">(TickedLedgerState blk -&gt; ForgeLedgerState blk)
-&gt; TickedLedgerState blk -&gt; ForgeLedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; SlotNo -&gt; LedgerState blk -&gt; TickedLedgerState blk
forall l. IsLedger l =&gt; LedgerCfg l -&gt; SlotNo -&gt; l -&gt; Ticked l
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">applyChainTick</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621679261845"><span class="hs-identifier hs-var">lcfg</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261828"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-606"></span><span>                </span><span id="local-6989586621679261820"><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261820"><span class="hs-identifier hs-var">snap2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk TicketNo)
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk idx)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">getSnapshotFor</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261843"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">(ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk TicketNo))
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk TicketNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-607"></span><span>                  </span><span class="hs-comment">-- Other nodes might include these crucial txs when leading</span><span>
</span><span id="line-608"></span><span>                  </span><span class="hs-comment">-- in the next slot.</span><span>
</span><span id="line-609"></span><span>                  </span><span class="annot"><span class="annottext">SlotNo -&gt; TickedLedgerState blk -&gt; ForgeLedgerState blk
forall blk. SlotNo -&gt; TickedLedgerState blk -&gt; ForgeLedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ForgeInKnownSlot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TickedLedgerState blk -&gt; ForgeLedgerState blk)
-&gt; TickedLedgerState blk -&gt; ForgeLedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; SlotNo -&gt; LedgerState blk -&gt; TickedLedgerState blk
forall l. IsLedger l =&gt; LedgerCfg l -&gt; SlotNo -&gt; l -&gt; Ticked l
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">applyChainTick</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
</span><a href="#local-6989586621679261845"><span class="hs-identifier hs-var">lcfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261828"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-610"></span><span>                </span><span class="hs-comment">-- This loop will repeat for the next slot, so we only need to</span><span>
</span><span id="line-611"></span><span>                </span><span class="hs-comment">-- check for this one and the next.</span><span>
</span><span id="line-612"></span><span>                </span><span class="annot"><span class="annottext">(MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
-&gt; STM
     m (MempoolSnapshot blk TicketNo, MempoolSnapshot blk TicketNo)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261824"><span class="hs-identifier hs-var">snap1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261820"><span class="hs-identifier hs-var">snap2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>              </span><span class="hs-comment">-- Don't attempt to add them if we're sure they'll be invalid.</span><span>
</span><span id="line-615"></span><span>              </span><span class="hs-comment">-- That just risks blocking on a full mempool unnecessarily.</span><span>
</span><span id="line-616"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; MempoolSnapshot blk TicketNo -&gt; Bool
</span><a href="#local-6989586621679261835"><span class="hs-identifier hs-var">checkSt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261826"><span class="hs-identifier hs-var">snap1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; MempoolSnapshot blk TicketNo -&gt; Bool
</span><a href="#local-6989586621679261835"><span class="hs-identifier hs-var">checkSt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo
</span><a href="#local-6989586621679261825"><span class="hs-identifier hs-var">snap2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>                </span><span class="annot"><span class="annottext">[MempoolAddTxResult blk]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo -&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
forall (m :: * -&gt; *) blk idx.
MonadSTM m =&gt;
Mempool m blk idx -&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">addTxs</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261843"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261842"><span class="hs-identifier hs-var">txs0</span></a></span><span>
</span><span id="line-618"></span><span>                </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>
</span><span id="line-620"></span><span>              </span><span class="hs-comment">-- See 'unblockForge' in 'forkNode'</span><span>
</span><span id="line-621"></span><span>              </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; STM m ()
</span><a href="#local-6989586621679261846"><span class="hs-identifier hs-var">unblockForge</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span>              </span><span class="hs-keyword">let</span><span>
</span><span id="line-624"></span><span>                </span><span class="hs-comment">-- a clock tick might render a crucial transaction valid</span><span>
</span><span id="line-625"></span><span>                </span><span id="local-6989586621679261817"><span class="annot"><span class="annottext">slotChanged :: m (SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261817"><span class="hs-identifier hs-var hs-var">slotChanged</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-626"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261816"><span class="annot"><span class="annottext">slot' :: SlotNo
</span><a href="#local-6989586621679261816"><span class="hs-identifier hs-var hs-var">slot'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-627"></span><span>                  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; SlotNo -&gt; m Bool
forall (m :: * -&gt; *). OracularClock m -&gt; SlotNo -&gt; m Bool
</span><a href="Test.Util.HardFork.OracularClock.html#blockUntilSlot"><span class="hs-identifier hs-var hs-var">OracularClock.blockUntilSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261849"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261816"><span class="hs-identifier hs-var">slot'</span></a></span><span>
</span><span id="line-628"></span><span>                  </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261816"><span class="hs-identifier hs-var">slot'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261828"><span class="hs-identifier hs-var">ledger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TicketNo]
</span><a href="#local-6989586621679261827"><span class="hs-identifier hs-var">mempFp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span>                </span><span class="hs-comment">-- a new tx (e.g. added by TxSubmission) might render a crucial</span><span>
</span><span id="line-631"></span><span>                </span><span class="hs-comment">-- transaction valid</span><span>
</span><span id="line-632"></span><span>                </span><span id="local-6989586621679261815"><span class="annot"><span class="annottext">mempChanged :: m (SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261815"><span class="hs-identifier hs-var hs-var">mempChanged</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-633"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261814"><span class="annot"><span class="annottext">getMemp :: STM m [TicketNo]
</span><a href="#local-6989586621679261814"><span class="hs-identifier hs-var hs-var">getMemp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Validated (GenTx blk), TicketNo) -&gt; TicketNo)
-&gt; [(Validated (GenTx blk), TicketNo)] -&gt; [TicketNo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Validated (GenTx blk), TicketNo) -&gt; TicketNo
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Validated (GenTx blk), TicketNo)] -&gt; [TicketNo])
-&gt; (MempoolSnapshot blk TicketNo
    -&gt; [(Validated (GenTx blk), TicketNo)])
-&gt; MempoolSnapshot blk TicketNo
-&gt; [TicketNo]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk TicketNo -&gt; [(Validated (GenTx blk), TicketNo)]
forall blk idx.
MempoolSnapshot blk idx -&gt; [(Validated (GenTx blk), idx)]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">snapshotTxs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MempoolSnapshot blk TicketNo -&gt; [TicketNo])
-&gt; STM m (MempoolSnapshot blk TicketNo) -&gt; STM m [TicketNo]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo -&gt; STM m (MempoolSnapshot blk TicketNo)
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx -&gt; STM m (MempoolSnapshot blk idx)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">getSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261843"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-634"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621679261810"><span class="annot"><span class="annottext">[TicketNo]
</span><a href="#local-6989586621679261810"><span class="hs-identifier hs-var">mempFp'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TicketNo]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m ([TicketNo], [TicketNo]) -&gt; m ([TicketNo], [TicketNo])
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m ([TicketNo], [TicketNo]) -&gt; m ([TicketNo], [TicketNo]))
-&gt; STM m ([TicketNo], [TicketNo]) -&gt; m ([TicketNo], [TicketNo])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TicketNo] -&gt; [TicketNo])
-&gt; [TicketNo] -&gt; STM m [TicketNo] -&gt; STM m ([TicketNo], [TicketNo])
forall (stm :: * -&gt; *) a b.
(MonadSTMTx stm, Eq b) =&gt;
(a -&gt; b) -&gt; b -&gt; stm a -&gt; stm (a, b)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">blockUntilChanged</span></a></span><span> </span><span class="annot"><span class="annottext">[TicketNo] -&gt; [TicketNo]
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">[TicketNo]
</span><a href="#local-6989586621679261827"><span class="hs-identifier hs-var">mempFp</span></a></span><span> </span><span class="annot"><span class="annottext">STM m [TicketNo]
</span><a href="#local-6989586621679261814"><span class="hs-identifier hs-var">getMemp</span></a></span><span>
</span><span id="line-635"></span><span>                  </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261828"><span class="hs-identifier hs-var">ledger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TicketNo]
</span><a href="#local-6989586621679261810"><span class="hs-identifier hs-var">mempFp'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span>                </span><span class="hs-comment">-- a new ledger state might render a crucial transaction valid</span><span>
</span><span id="line-638"></span><span>                </span><span id="local-6989586621679261807"><span class="annot"><span class="annottext">ldgrChanged :: m (SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261807"><span class="hs-identifier hs-var hs-var">ldgrChanged</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261806"><span class="annot"><span class="annottext">prj :: LedgerState blk -&gt; Point blk
</span><a href="#local-6989586621679261806"><span class="hs-identifier hs-var hs-var">prj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk -&gt; LedgerState blk -&gt; Point blk
forall blk.
UpdateLedger blk =&gt;
Proxy blk -&gt; LedgerState blk -&gt; Point blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ledgerTipPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621679261804"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261804"><span class="hs-identifier hs-var">ledger'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (LedgerState blk, Point blk)
-&gt; m (LedgerState blk, Point blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (LedgerState blk, Point blk)
 -&gt; m (LedgerState blk, Point blk))
-&gt; STM m (LedgerState blk, Point blk)
-&gt; m (LedgerState blk, Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LedgerState blk -&gt; Point blk)
-&gt; Point blk
-&gt; STM m (LedgerState blk)
-&gt; STM m (LedgerState blk, Point blk)
forall (stm :: * -&gt; *) a b.
(MonadSTMTx stm, Eq b) =&gt;
(a -&gt; b) -&gt; b -&gt; stm a -&gt; stm (a, b)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">blockUntilChanged</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk -&gt; Point blk
</span><a href="#local-6989586621679261806"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerState blk -&gt; Point blk
</span><a href="#local-6989586621679261806"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261828"><span class="hs-identifier hs-var">ledger</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM m (LedgerState blk)
</span><a href="#local-6989586621679261844"><span class="hs-identifier hs-var">getLdgr</span></a></span><span>
</span><span id="line-641"></span><span>                  </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261829"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261804"><span class="hs-identifier hs-var">ledger'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TicketNo]
</span><a href="#local-6989586621679261827"><span class="hs-identifier hs-var">mempFp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span>              </span><span class="hs-comment">-- wake up when any of those change</span><span>
</span><span id="line-644"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-645"></span><span>              </span><span class="hs-comment">-- key observation: it's OK to add the crucial txs too often</span><span>
</span><span id="line-646"></span><span>              </span><span id="local-6989586621679261803"><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261803"><span class="hs-identifier hs-var">fps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Either
   (Either
      (SlotNo, LedgerState blk, [TicketNo])
      (SlotNo, LedgerState blk, [TicketNo]))
   (SlotNo, LedgerState blk, [TicketNo])
 -&gt; (SlotNo, LedgerState blk, [TicketNo]))
-&gt; m (Either
        (Either
           (SlotNo, LedgerState blk, [TicketNo])
           (SlotNo, LedgerState blk, [TicketNo]))
        (SlotNo, LedgerState blk, [TicketNo]))
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Either
   (SlotNo, LedgerState blk, [TicketNo])
   (SlotNo, LedgerState blk, [TicketNo])
 -&gt; (SlotNo, LedgerState blk, [TicketNo]))
-&gt; ((SlotNo, LedgerState blk, [TicketNo])
    -&gt; (SlotNo, LedgerState blk, [TicketNo]))
-&gt; Either
     (Either
        (SlotNo, LedgerState blk, [TicketNo])
        (SlotNo, LedgerState blk, [TicketNo]))
     (SlotNo, LedgerState blk, [TicketNo])
-&gt; (SlotNo, LedgerState blk, [TicketNo])
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SlotNo, LedgerState blk, [TicketNo])
 -&gt; (SlotNo, LedgerState blk, [TicketNo]))
-&gt; ((SlotNo, LedgerState blk, [TicketNo])
    -&gt; (SlotNo, LedgerState blk, [TicketNo]))
-&gt; Either
     (SlotNo, LedgerState blk, [TicketNo])
     (SlotNo, LedgerState blk, [TicketNo])
-&gt; (SlotNo, LedgerState blk, [TicketNo])
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
-&gt; (SlotNo, LedgerState blk, [TicketNo])
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
-&gt; (SlotNo, LedgerState blk, [TicketNo])
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
-&gt; (SlotNo, LedgerState blk, [TicketNo])
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Either
      (Either
         (SlotNo, LedgerState blk, [TicketNo])
         (SlotNo, LedgerState blk, [TicketNo]))
      (SlotNo, LedgerState blk, [TicketNo]))
 -&gt; m (SlotNo, LedgerState blk, [TicketNo]))
-&gt; m (Either
        (Either
           (SlotNo, LedgerState blk, [TicketNo])
           (SlotNo, LedgerState blk, [TicketNo]))
        (SlotNo, LedgerState blk, [TicketNo]))
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-647"></span><span>                </span><span class="annot"><span class="annottext">m (SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261817"><span class="hs-identifier hs-var">slotChanged</span></a></span><span> </span><span class="annot"><span class="annottext">m (SlotNo, LedgerState blk, [TicketNo])
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
-&gt; m (Either
        (SlotNo, LedgerState blk, [TicketNo])
        (SlotNo, LedgerState blk, [TicketNo]))
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; m b -&gt; m (Either a b)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-operator hs-var">`race`</span></a></span><span> </span><span class="annot"><span class="annottext">m (SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261815"><span class="hs-identifier hs-var">mempChanged</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either
     (SlotNo, LedgerState blk, [TicketNo])
     (SlotNo, LedgerState blk, [TicketNo]))
-&gt; m (SlotNo, LedgerState blk, [TicketNo])
-&gt; m (Either
        (Either
           (SlotNo, LedgerState blk, [TicketNo])
           (SlotNo, LedgerState blk, [TicketNo]))
        (SlotNo, LedgerState blk, [TicketNo]))
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; m b -&gt; m (Either a b)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-operator hs-var">`race`</span></a></span><span> </span><span class="annot"><span class="annottext">m (SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261807"><span class="hs-identifier hs-var">ldgrChanged</span></a></span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span>              </span><span class="hs-comment">-- avoid the race in which we wake up before the mempool's</span><span>
</span><span id="line-650"></span><span>              </span><span class="hs-comment">-- background thread wakes up by mimicking it before we do</span><span>
</span><span id="line-651"></span><span>              </span><span class="hs-comment">-- anything else</span><span>
</span><span id="line-652"></span><span>              </span><span class="annot"><span class="annottext">m (MempoolSnapshot blk TicketNo) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (MempoolSnapshot blk TicketNo) -&gt; m ())
-&gt; m (MempoolSnapshot blk TicketNo) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo -&gt; m (MempoolSnapshot blk TicketNo)
forall (m :: * -&gt; *) blk idx.
Mempool m blk idx -&gt; m (MempoolSnapshot blk idx)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">syncWithLedger</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261843"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span>              </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo]) -&gt; m Any
</span><a href="#local-6989586621679261830"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo])
</span><a href="#local-6989586621679261803"><span class="hs-identifier hs-var">fps'</span></a></span><span>
</span><span id="line-655"></span><span>        </span><span id="local-6989586621679261799"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261799"><span class="hs-identifier hs-var">ledger0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (LedgerState blk) -&gt; m (LedgerState blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (LedgerState blk) -&gt; m (LedgerState blk))
-&gt; STM m (LedgerState blk) -&gt; m (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (LedgerState blk)
</span><a href="#local-6989586621679261844"><span class="hs-identifier hs-var">getLdgr</span></a></span><span>
</span><span id="line-656"></span><span>        </span><span class="annot"><span class="annottext">(SlotNo, LedgerState blk, [TicketNo]) -&gt; m Any
</span><a href="#local-6989586621679261830"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261848"><span class="hs-identifier hs-var">s0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261799"><span class="hs-identifier hs-var">ledger0</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-comment">-- | Produce transactions every time the slot changes and submit them to</span><span>
</span><span id="line-659"></span><span>    </span><span class="hs-comment">-- the mempool.</span><span>
</span><span id="line-660"></span><span>    </span><span class="annot"><a href="#local-6989586621679261798"><span class="hs-identifier hs-type">forkTxProducer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-661"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-662"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-663"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-664"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-665"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Util.Seed.html#Seed"><span class="hs-identifier hs-type">Seed</span></a></span><span>
</span><span id="line-666"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>                      </span><span class="hs-comment">-- ^ How to get the current ledger state</span><span>
</span><span id="line-668"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Mempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TicketNo</span></a></span><span>
</span><span id="line-669"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621679261798"><span class="annot"><span class="annottext">forkTxProducer :: CoreNodeId
-&gt; ResourceRegistry m
-&gt; OracularClock m
-&gt; TopLevelConfig blk
-&gt; Seed
-&gt; STM m (ExtLedgerState blk)
-&gt; Mempool m blk TicketNo
-&gt; m ()
</span><a href="#local-6989586621679261798"><span class="hs-identifier hs-var hs-var">forkTxProducer</span></a></span></span><span> </span><span id="local-6989586621679261797"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261797"><span class="hs-identifier hs-var">coreNodeId</span></a></span></span><span> </span><span id="local-6989586621679261796"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261796"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679261795"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261795"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span id="local-6989586621679261794"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261794"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679261793"><span class="annot"><span class="annottext">Seed
</span><a href="#local-6989586621679261793"><span class="hs-identifier hs-var">nodeSeed</span></a></span></span><span> </span><span id="local-6989586621679261792"><span class="annot"><span class="annottext">STM m (ExtLedgerState blk)
</span><a href="#local-6989586621679261792"><span class="hs-identifier hs-var">getExtLedger</span></a></span></span><span> </span><span id="local-6989586621679261791"><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261791"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-671"></span><span>      </span><span class="annot"><span class="annottext">m (m ()) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (m ()) -&gt; m ()) -&gt; m (m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; OracularClock m -&gt; String -&gt; (SlotNo -&gt; m ()) -&gt; m (m ())
forall (m :: * -&gt; *).
HasCallStack =&gt;
ResourceRegistry m
-&gt; OracularClock m -&gt; String -&gt; (SlotNo -&gt; m ()) -&gt; m (m ())
</span><a href="Test.Util.HardFork.OracularClock.html#forkEachSlot"><span class="hs-identifier hs-var">OracularClock.forkEachSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261796"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261795"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;txProducer&quot;</span></span><span> </span><span class="annot"><span class="annottext">((SlotNo -&gt; m ()) -&gt; m (m ())) -&gt; (SlotNo -&gt; m ()) -&gt; m (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261790"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261790"><span class="hs-identifier hs-var">curSlotNo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-672"></span><span>        </span><span id="local-6989586621679261789"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261789"><span class="hs-identifier hs-var">ledger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (LedgerState blk) -&gt; m (LedgerState blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (LedgerState blk) -&gt; m (LedgerState blk))
-&gt; STM m (LedgerState blk) -&gt; m (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; STM m (ExtLedgerState blk) -&gt; STM m (LedgerState blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m (ExtLedgerState blk)
</span><a href="#local-6989586621679261792"><span class="hs-identifier hs-var">getExtLedger</span></a></span><span>
</span><span id="line-673"></span><span>        </span><span class="hs-comment">-- Combine the node's seed with the current slot number, to make sure</span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-comment">-- we generate different transactions in each slot.</span><span>
</span><span id="line-675"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261788"><span class="annot"><span class="annottext">txs :: [GenTx blk]
</span><a href="#local-6989586621679261788"><span class="hs-identifier hs-var hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seed -&gt; Gen [GenTx blk] -&gt; [GenTx blk]
forall a. Seed -&gt; Gen a -&gt; a
</span><a href="Test.ThreadNet.Util.Seed.html#runGen"><span class="hs-identifier hs-var">runGen</span></a></span><span>
</span><span id="line-676"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seed
</span><a href="#local-6989586621679261793"><span class="hs-identifier hs-var">nodeSeed</span></a></span><span> </span><span class="annot"><span class="annottext">Seed -&gt; Word64 -&gt; Seed
forall a. Integral a =&gt; Seed -&gt; a -&gt; Seed
</span><a href="Test.ThreadNet.Util.Seed.html#combineWith"><span class="hs-operator hs-var">`combineWith`</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Word64
</span><span class="hs-identifier hs-var hs-var">unSlotNo</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261790"><span class="hs-identifier hs-var">curSlotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
-&gt; NumCoreNodes
-&gt; SlotNo
-&gt; TopLevelConfig blk
-&gt; TxGenExtra blk
-&gt; LedgerState blk
-&gt; Gen [GenTx blk]
forall blk.
TxGen blk =&gt;
CoreNodeId
-&gt; NumCoreNodes
-&gt; SlotNo
-&gt; TopLevelConfig blk
-&gt; TxGenExtra blk
-&gt; LedgerState blk
-&gt; Gen [GenTx blk]
</span><a href="Test.ThreadNet.TxGen.html#testGenTxs"><span class="hs-identifier hs-var">testGenTxs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261797"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">NumCoreNodes
</span><a href="#local-6989586621679262020"><span class="hs-identifier hs-var">numCoreNodes</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261790"><span class="hs-identifier hs-var">curSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261794"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">TxGenExtra blk
</span><a href="#local-6989586621679262013"><span class="hs-identifier hs-var">txGenExtra</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261789"><span class="hs-identifier hs-var">ledger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>
</span><span id="line-679"></span><span>        </span><span class="annot"><span class="annottext">m [MempoolAddTxResult blk] -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m [MempoolAddTxResult blk] -&gt; m ())
-&gt; m [MempoolAddTxResult blk] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo -&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
forall (m :: * -&gt; *) blk idx.
MonadSTM m =&gt;
Mempool m blk idx -&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">addTxs</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261791"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261788"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><a href="#local-6989586621679261783"><span class="hs-identifier hs-type">mkArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-682"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-683"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-684"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-685"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtValidationError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>              </span><span class="hs-comment">-- ^ invalid block tracer</span><span>
</span><span id="line-687"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>              </span><span class="hs-comment">-- ^ added block tracer</span><span>
</span><span id="line-689"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>              </span><span class="hs-comment">-- ^ block selection tracer</span><span>
</span><span id="line-691"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-692"></span><span>              </span><span class="hs-comment">-- ^ ledger updates tracer</span><span>
</span><span id="line-693"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-type">NodeDBs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-695"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDbArgs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-696"></span><span>    </span><span id="local-6989586621679261783"><span class="annot"><span class="annottext">mkArgs :: OracularClock m
-&gt; ResourceRegistry m
-&gt; TopLevelConfig blk
-&gt; ExtLedgerState blk
-&gt; Tracer m (RealPoint blk, ExtValidationError blk)
-&gt; Tracer m (RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
-&gt; Tracer m (LedgerUpdate blk)
-&gt; NodeDBs (StrictTVar m MockFS)
-&gt; CoreNodeId
-&gt; ChainDbArgs Identity m blk
</span><a href="#local-6989586621679261783"><span class="hs-identifier hs-var hs-var">mkArgs</span></a></span></span><span>
</span><span id="line-697"></span><span>      </span><span id="local-6989586621679261782"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261782"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span id="local-6989586621679261781"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261781"><span class="hs-identifier hs-var">registry</span></a></span></span><span>
</span><span id="line-698"></span><span>      </span><span id="local-6989586621679261780"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261780"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679261779"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679261779"><span class="hs-identifier hs-var">initLedger</span></a></span></span><span>
</span><span id="line-699"></span><span>      </span><span id="local-6989586621679261778"><span class="annot"><span class="annottext">Tracer m (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261778"><span class="hs-identifier hs-var">invalidTracer</span></a></span></span><span> </span><span id="local-6989586621679261777"><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261777"><span class="hs-identifier hs-var">addTracer</span></a></span></span><span> </span><span id="local-6989586621679261776"><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261776"><span class="hs-identifier hs-var">selTracer</span></a></span></span><span> </span><span id="local-6989586621679261775"><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261775"><span class="hs-identifier hs-var">updatesTracer</span></a></span></span><span>
</span><span id="line-700"></span><span>      </span><span id="local-6989586621679261774"><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261774"><span class="hs-identifier hs-var">nodeDBs</span></a></span></span><span> </span><span id="local-6989586621679261773"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261773"><span class="hs-identifier hs-var">_coreNodeId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
SomeHasFS m
-&gt; SomeHasFS m
-&gt; SomeHasFS m
-&gt; ValidationPolicy
-&gt; BlockValidationPolicy
-&gt; BlocksPerFile
-&gt; DiskPolicy
-&gt; HKD f (TopLevelConfig blk)
-&gt; HKD f ChunkInfo
-&gt; HKD f (blk -&gt; Bool)
-&gt; HKD f (m (ExtLedgerState blk))
-&gt; HKD f (CheckInFuture m blk)
-&gt; CacheConfig
-&gt; Tracer m (TraceEvent blk)
-&gt; Tracer m (LedgerDB' blk)
-&gt; HKD f (ResourceRegistry m)
-&gt; DiffTime
-&gt; DiffTime
-&gt; Word
-&gt; ChainDbArgs f m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDbArgs</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-701"></span><span>          </span><span class="hs-comment">-- HasFS instances</span><span>
</span><span id="line-702"></span><span>          </span><span class="annot"><span class="annottext">cdbHasFSImmutableDB :: SomeHasFS m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbHasFSImmutableDB</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m HandleMock -&gt; SomeHasFS m
forall h (m :: * -&gt; *). Eq h =&gt; HasFS m h -&gt; SomeHasFS m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">SomeHasFS</span></a></span><span> </span><span class="annot"><span class="annottext">(HasFS m HandleMock -&gt; SomeHasFS m)
-&gt; HasFS m HandleMock -&gt; SomeHasFS m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m MockFS -&gt; HasFS m HandleMock
forall (m :: * -&gt; *).
(MonadSTM m, MonadThrow m) =&gt;
StrictTVar m MockFS -&gt; HasFS m HandleMock
</span><a href="Test.Util.FS.Sim.STM.html#simHasFS"><span class="hs-identifier hs-var">simHasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS) -&gt; StrictTVar m MockFS
forall db. NodeDBs db -&gt; db
</span><a href="Test.ThreadNet.Network.html#nodeDBsImm"><span class="hs-identifier hs-var hs-var">nodeDBsImm</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261774"><span class="hs-identifier hs-var">nodeDBs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbHasFSVolatileDB :: SomeHasFS m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbHasFSVolatileDB</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m HandleMock -&gt; SomeHasFS m
forall h (m :: * -&gt; *). Eq h =&gt; HasFS m h -&gt; SomeHasFS m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">SomeHasFS</span></a></span><span> </span><span class="annot"><span class="annottext">(HasFS m HandleMock -&gt; SomeHasFS m)
-&gt; HasFS m HandleMock -&gt; SomeHasFS m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m MockFS -&gt; HasFS m HandleMock
forall (m :: * -&gt; *).
(MonadSTM m, MonadThrow m) =&gt;
StrictTVar m MockFS -&gt; HasFS m HandleMock
</span><a href="Test.Util.FS.Sim.STM.html#simHasFS"><span class="hs-identifier hs-var">simHasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS) -&gt; StrictTVar m MockFS
forall db. NodeDBs db -&gt; db
</span><a href="Test.ThreadNet.Network.html#nodeDBsVol"><span class="hs-identifier hs-var hs-var">nodeDBsVol</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261774"><span class="hs-identifier hs-var">nodeDBs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbHasFSLgrDB :: SomeHasFS m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbHasFSLgrDB</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m HandleMock -&gt; SomeHasFS m
forall h (m :: * -&gt; *). Eq h =&gt; HasFS m h -&gt; SomeHasFS m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">SomeHasFS</span></a></span><span> </span><span class="annot"><span class="annottext">(HasFS m HandleMock -&gt; SomeHasFS m)
-&gt; HasFS m HandleMock -&gt; SomeHasFS m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m MockFS -&gt; HasFS m HandleMock
forall (m :: * -&gt; *).
(MonadSTM m, MonadThrow m) =&gt;
StrictTVar m MockFS -&gt; HasFS m HandleMock
</span><a href="Test.Util.FS.Sim.STM.html#simHasFS"><span class="hs-identifier hs-var">simHasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS) -&gt; StrictTVar m MockFS
forall db. NodeDBs db -&gt; db
</span><a href="Test.ThreadNet.Network.html#nodeDBsLgr"><span class="hs-identifier hs-var hs-var">nodeDBsLgr</span></a></span><span> </span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261774"><span class="hs-identifier hs-var">nodeDBs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>          </span><span class="hs-comment">-- Policy</span><span>
</span><span id="line-706"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbImmutableDbValidation :: ValidationPolicy
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbImmutableDbValidation</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ImmutableDB.ValidateAllChunks</span></a></span><span>
</span><span id="line-707"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbVolatileDbValidation :: BlockValidationPolicy
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbVolatileDbValidation</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockValidationPolicy
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">VolatileDB.ValidateAll</span></a></span><span>
</span><span id="line-708"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbMaxBlocksPerFile :: BlocksPerFile
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbMaxBlocksPerFile</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; BlocksPerFile
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">VolatileDB.mkBlocksPerFile</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">4</span></span><span>
</span><span id="line-709"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbDiskPolicy :: DiskPolicy
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbDiskPolicy</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; SnapshotInterval -&gt; DiskPolicy
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">LgrDB.defaultDiskPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; SecurityParam
forall blk.
ConsensusProtocol (BlockProtocol blk) =&gt;
TopLevelConfig blk -&gt; SecurityParam
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261780"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SnapshotInterval
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">LgrDB.DefaultSnapshotInterval</span></a></span><span>
</span><span id="line-710"></span><span>          </span><span class="hs-comment">-- Integration</span><span>
</span><span id="line-711"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTopLevelConfig :: HKD Identity (TopLevelConfig blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
HKD Identity (TopLevelConfig blk)
</span><a href="#local-6989586621679261780"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-712"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbChunkInfo :: HKD Identity ChunkInfo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbChunkInfo</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochSize -&gt; ChunkInfo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ImmutableDB.simpleChunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679261935"><span class="hs-identifier hs-var">epochSize0</span></a></span><span>
</span><span id="line-713"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbCheckIntegrity :: HKD Identity (blk -&gt; Bool)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbCheckIntegrity</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StorageConfig blk -&gt; blk -&gt; Bool
forall blk. NodeInitStorage blk =&gt; StorageConfig blk -&gt; blk -&gt; Bool
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">nodeCheckIntegrity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; StorageConfig blk
forall blk. TopLevelConfig blk -&gt; StorageConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configStorage</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261780"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-714"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbGenesis :: HKD Identity (m (ExtLedgerState blk))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbGenesis</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; m (ExtLedgerState blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679261779"><span class="hs-identifier hs-var">initLedger</span></a></span><span>
</span><span id="line-715"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbCheckInFuture :: HKD Identity (CheckInFuture m blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbCheckInFuture</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; ClockSkew -&gt; SystemTime m -&gt; CheckInFuture m blk
forall (m :: * -&gt; *) blk.
(Monad m, UpdateLedger blk, HasHardForkHistory blk) =&gt;
LedgerConfig blk
-&gt; ClockSkew -&gt; SystemTime m -&gt; CheckInFuture m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">InFuture.reference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261780"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ClockSkew
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">InFuture.defaultClockSkew</span></a></span><span>
</span><span id="line-716"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OracularClock m -&gt; SystemTime m
forall (m :: * -&gt; *). OracularClock m -&gt; SystemTime m
</span><a href="Test.Util.HardFork.OracularClock.html#finiteSystemTime"><span class="hs-identifier hs-var hs-var">OracularClock.finiteSystemTime</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261782"><span class="hs-identifier hs-var">clock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-717"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbImmutableDbCacheConfig :: CacheConfig
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbImmutableDbCacheConfig</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; DiffTime -&gt; CacheConfig
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">Index.CacheConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">60</span></span><span>
</span><span id="line-718"></span><span>        </span><span class="hs-comment">-- Misc</span><span>
</span><span id="line-719"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTracer :: Tracer m (TraceEvent blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679261739"><span class="hs-identifier hs-var">instrumentationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceEvent blk)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
forall (m :: * -&gt; *) a. (Applicative m, Show a) =&gt; Tracer m a
</span><a href="Test.ThreadNet.Network.html#nullDebugTracer"><span class="hs-identifier hs-var">nullDebugTracer</span></a></span><span>
</span><span id="line-720"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTraceLedger :: Tracer m (LedgerDB' blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbTraceLedger</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (LedgerDB' blk)
forall (m :: * -&gt; *) a. (Applicative m, Show a) =&gt; Tracer m a
</span><a href="Test.ThreadNet.Network.html#nullDebugTracer"><span class="hs-identifier hs-var">nullDebugTracer</span></a></span><span>
</span><span id="line-721"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbRegistry :: HKD Identity (ResourceRegistry m)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbRegistry</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
HKD Identity (ResourceRegistry m)
</span><a href="#local-6989586621679261781"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-722"></span><span>          </span><span class="hs-comment">-- TODO vary these</span><span>
</span><span id="line-723"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbGcDelay :: DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbGcDelay</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span>
</span><span id="line-724"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbGcInterval :: DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbGcInterval</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">1</span></span><span>
</span><span id="line-725"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbBlocksToAddSize :: Word
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cdbBlocksToAddSize</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-726"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-727"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-728"></span><span>        </span><span id="local-6989586621679261733"><span class="annot"><span class="annottext">prj :: AnchoredFragment block -&gt; BlockNo
</span><a href="#local-6989586621679261733"><span class="hs-identifier hs-var hs-var">prj</span></a></span></span><span> </span><span id="local-6989586621679261732"><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679261732"><span class="hs-identifier hs-var">af</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block -&gt; WithOrigin BlockNo
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; WithOrigin BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">AF.headBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679261732"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-729"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">At</span></span><span> </span><span id="local-6989586621679261729"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261729"><span class="hs-identifier hs-var">bno</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261729"><span class="hs-identifier hs-var">bno</span></a></span><span>
</span><span id="line-730"></span><span>            </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><span class="hs-identifier hs-var">Origin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; BlockNo
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;selTracer&quot;</span></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>        </span><span class="hs-comment">-- prop_general relies on this tracer</span><span>
</span><span id="line-733"></span><span>        </span><span id="local-6989586621679261739"><span class="annot"><span class="annottext">instrumentationTracer :: Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679261739"><span class="hs-identifier hs-var hs-var">instrumentationTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; Tracer m (TraceEvent blk)
forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; Tracer m a
</span><span class="hs-identifier hs-var">Tracer</span></span><span> </span><span class="annot"><span class="annottext">((TraceEvent blk -&gt; m ()) -&gt; Tracer m (TraceEvent blk))
-&gt; (TraceEvent blk -&gt; m ()) -&gt; Tracer m (TraceEvent blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-734"></span><span>          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.TraceAddBlockEvent</span></a></span><span>
</span><span id="line-735"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.AddBlockValidation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.InvalidBlock</span></a></span><span> </span><span id="local-6989586621679261723"><span class="annot"><span class="annottext">ExtValidationError blk
</span><a href="#local-6989586621679261723"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679261722"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261722"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-736"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, ExtValidationError blk)
-&gt; (RealPoint blk, ExtValidationError blk) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261778"><span class="hs-identifier hs-var">invalidTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261722"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExtValidationError blk
</span><a href="#local-6989586621679261723"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span>          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.TraceAddBlockEvent</span></a></span><span>
</span><span id="line-739"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.AddedBlockToVolatileDB</span></a></span><span> </span><span id="local-6989586621679261720"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261720"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679261719"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261719"><span class="hs-identifier hs-var">bno</span></a></span></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">IsNotEBB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
-&gt; (RealPoint blk, BlockNo) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261777"><span class="hs-identifier hs-var">addTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261720"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261719"><span class="hs-identifier hs-var">bno</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.TraceAddBlockEvent</span></a></span><span>
</span><span id="line-743"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.AddedToCurrentChain</span></a></span><span> </span><span id="local-6989586621679261716"><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679261716"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span id="local-6989586621679261715"><span class="annot"><span class="annottext">NewTipInfo blk
</span><a href="#local-6989586621679261715"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679261714"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679261714"><span class="hs-identifier hs-var">_old</span></a></span></span><span> </span><span id="local-6989586621679261713"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679261713"><span class="hs-identifier hs-var">new</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261712"><span class="annot"><span class="annottext">[LedgerWarning blk]
</span><a href="#local-6989586621679261712"><span class="hs-identifier hs-var">warnings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261711"><span class="annot"><span class="annottext">[LedgerUpdate blk]
</span><a href="#local-6989586621679261711"><span class="hs-identifier hs-var">updates</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk] -&gt; ([LedgerWarning blk], [LedgerUpdate blk])
forall blk.
[LedgerEvent blk] -&gt; ([LedgerWarning blk], [LedgerUpdate blk])
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">partitionLedgerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679261716"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-745"></span><span>                 </span><span class="annot"><span class="annottext">Either String () -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Either String () -&gt; a -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">assertWithMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LedgerWarning blk] -&gt; Either String ()
forall a. Show a =&gt; [a] -&gt; Either String ()
</span><a href="#local-6989586621679261708"><span class="hs-identifier hs-var">noWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerWarning blk]
</span><a href="#local-6989586621679261712"><span class="hs-identifier hs-var">warnings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-746"></span><span>                   </span><span class="annot"><span class="annottext">(LedgerUpdate blk -&gt; m ()) -&gt; [LedgerUpdate blk] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk) -&gt; LedgerUpdate blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261775"><span class="hs-identifier hs-var">updatesTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LedgerUpdate blk]
</span><a href="#local-6989586621679261711"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-747"></span><span>                   </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
-&gt; (RealPoint blk, BlockNo) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261776"><span class="hs-identifier hs-var">selTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NewTipInfo blk -&gt; RealPoint blk
forall blk. NewTipInfo blk -&gt; RealPoint blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ChainDB.newTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">NewTipInfo blk
</span><a href="#local-6989586621679261715"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; BlockNo
forall block. HasHeader block =&gt; AnchoredFragment block -&gt; BlockNo
</span><a href="#local-6989586621679261733"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679261713"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>          </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.TraceAddBlockEvent</span></a></span><span>
</span><span id="line-749"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ChainDB.SwitchedToAFork</span></a></span><span> </span><span id="local-6989586621679261704"><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679261704"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span id="local-6989586621679261703"><span class="annot"><span class="annottext">NewTipInfo blk
</span><a href="#local-6989586621679261703"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679261702"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679261702"><span class="hs-identifier hs-var">_old</span></a></span></span><span> </span><span id="local-6989586621679261701"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679261701"><span class="hs-identifier hs-var">new</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261700"><span class="annot"><span class="annottext">[LedgerWarning blk]
</span><a href="#local-6989586621679261700"><span class="hs-identifier hs-var">warnings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261699"><span class="annot"><span class="annottext">[LedgerUpdate blk]
</span><a href="#local-6989586621679261699"><span class="hs-identifier hs-var">updates</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk] -&gt; ([LedgerWarning blk], [LedgerUpdate blk])
forall blk.
[LedgerEvent blk] -&gt; ([LedgerWarning blk], [LedgerUpdate blk])
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">partitionLedgerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679261704"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-751"></span><span>                 </span><span class="annot"><span class="annottext">Either String () -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Either String () -&gt; a -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">assertWithMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LedgerWarning blk] -&gt; Either String ()
forall a. Show a =&gt; [a] -&gt; Either String ()
</span><a href="#local-6989586621679261708"><span class="hs-identifier hs-var">noWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerWarning blk]
</span><a href="#local-6989586621679261700"><span class="hs-identifier hs-var">warnings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-752"></span><span>                   </span><span class="annot"><span class="annottext">(LedgerUpdate blk -&gt; m ()) -&gt; [LedgerUpdate blk] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk) -&gt; LedgerUpdate blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261775"><span class="hs-identifier hs-var">updatesTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LedgerUpdate blk]
</span><a href="#local-6989586621679261699"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-753"></span><span>                   </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
-&gt; (RealPoint blk, BlockNo) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261776"><span class="hs-identifier hs-var">selTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NewTipInfo blk -&gt; RealPoint blk
forall blk. NewTipInfo blk -&gt; RealPoint blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ChainDB.newTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">NewTipInfo blk
</span><a href="#local-6989586621679261703"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; BlockNo
forall block. HasHeader block =&gt; AnchoredFragment block -&gt; BlockNo
</span><a href="#local-6989586621679261733"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679261701"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span>
</span><span id="line-755"></span><span>          </span><span class="annot"><span class="annottext">TraceEvent blk
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span>    </span><span class="hs-comment">-- We don't expect any ledger warnings</span><span>
</span><span id="line-758"></span><span>    </span><span class="hs-comment">-- (that would indicate node misconfiguration in the tests)</span><span>
</span><span id="line-759"></span><span>    </span><span id="local-6989586621679262636"><span class="annot"><a href="#local-6989586621679261708"><span class="hs-identifier hs-type">noWarnings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679262636"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679262636"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-760"></span><span>    </span><span id="local-6989586621679261708"><span class="annot"><span class="annottext">noWarnings :: [a] -&gt; Either String ()
</span><a href="#local-6989586621679261708"><span class="hs-identifier hs-var hs-var">noWarnings</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either String ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>    </span><span class="annot"><a href="#local-6989586621679261708"><span class="hs-identifier hs-var">noWarnings</span></a></span><span> </span><span id="local-6989586621679261698"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679261698"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unexpected warnings: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679261698"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-762"></span><span>
</span><span id="line-763"></span><span>    </span><span class="hs-comment">-- Augment a tracer message with the node which produces it.</span><span>
</span><span id="line-764"></span><span>    </span><span class="annot"><a href="#local-6989586621679261697"><span class="hs-identifier hs-type">_decorateId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-765"></span><span>    </span><span id="local-6989586621679261697"><span class="annot"><span class="annottext">_decorateId :: CoreNodeId -&gt; Tracer m String -&gt; Tracer m String
</span><a href="#local-6989586621679261697"><span class="hs-identifier hs-var hs-var">_decorateId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span> </span><span id="local-6989586621679261696"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261696"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; Tracer m String -&gt; Tracer m String
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><span class="hs-identifier hs-var">contramap</span></span><span> </span><span class="annot"><span class="annottext">(ShowS -&gt; Tracer m String -&gt; Tracer m String)
-&gt; ShowS -&gt; Tracer m String -&gt; Tracer m String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261694"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261694"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-766"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261696"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; | &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261694"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><a href="#local-6989586621679261893"><span class="hs-identifier hs-type">forkNode</span></a></span><span>
</span><span id="line-769"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span>
</span><span id="line-770"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-771"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-772"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-773"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-774"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-775"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-777"></span><span>         </span><span class="hs-comment">-- ^ valid transactions the node should immediately propagate</span><span>
</span><span id="line-778"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeKernel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-779"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-type">LimitedApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-780"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>    </span><span id="local-6989586621679261893"><span class="annot"><span class="annottext">forkNode :: CoreNodeId
-&gt; OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; ProtocolInfo m blk
-&gt; NodeInfo blk (StrictTVar m MockFS) (Tracer m)
-&gt; [GenTx blk]
-&gt; m (NodeKernel m NodeId Void blk, LimitedApp m NodeId blk)
</span><a href="#local-6989586621679261893"><span class="hs-identifier hs-var hs-var">forkNode</span></a></span></span><span> </span><span id="local-6989586621679261693"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261693"><span class="hs-identifier hs-var">coreNodeId</span></a></span></span><span> </span><span id="local-6989586621679261692"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span id="local-6989586621679261691"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261691"><span class="hs-identifier hs-var">joinSlot</span></a></span></span><span> </span><span id="local-6989586621679261690"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261690"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679261689"><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261689"><span class="hs-identifier hs-var">pInfo</span></a></span></span><span> </span><span id="local-6989586621679261688"><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261688"><span class="hs-identifier hs-var">nodeInfo</span></a></span></span><span> </span><span id="local-6989586621679261687"><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261687"><span class="hs-identifier hs-var">txs0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-782"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ProtocolInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679261684"><span id="local-6989586621679261685"><span id="local-6989586621679261686"><span class="annot"><span class="annottext">m [BlockForging m blk]
ExtLedgerState blk
TopLevelConfig blk
pInfoBlockForging :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; m [BlockForging m b]
pInfoBlockForging :: m [BlockForging m blk]
pInfoInitLedger :: ExtLedgerState blk
pInfoConfig :: TopLevelConfig blk
pInfoConfig :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; TopLevelConfig b
pInfoInitLedger :: forall (m :: * -&gt; *) b. ProtocolInfo m b -&gt; ExtLedgerState b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolInfo m blk
</span><a href="#local-6989586621679261689"><span class="hs-identifier hs-var">pInfo</span></a></span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span>
</span><span id="line-785"></span><span>            </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679261682"><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
nodeInfoEvents :: NodeEvents blk (Tracer m)
nodeInfoEvents :: forall blk db (ev :: * -&gt; *).
NodeInfo blk db ev -&gt; NodeEvents blk ev
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var hs-var">nodeInfoEvents</span></a></span></span><span>
</span><span id="line-786"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261681"><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
nodeInfoDBs :: forall blk db (ev :: * -&gt; *). NodeInfo blk db ev -&gt; NodeDBs db
nodeInfoDBs :: NodeDBs (StrictTVar m MockFS)
</span><a href="Test.ThreadNet.Network.html#nodeInfoDBs"><span class="hs-identifier hs-var hs-var">nodeInfoDBs</span></a></span></span><span>
</span><span id="line-787"></span><span>            </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeInfo blk (StrictTVar m MockFS) (Tracer m)
</span><a href="#local-6989586621679261688"><span class="hs-identifier hs-var">nodeInfo</span></a></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>      </span><span class="hs-comment">-- prop_general relies on these tracers</span><span>
</span><span id="line-790"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261679"><span class="annot"><span class="annottext">invalidTracer :: Tracer m (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261679"><span class="hs-identifier hs-var hs-var">invalidTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
-&gt; Tracer m (RealPoint blk, ExtValidationError blk)
forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (RealPoint blk, ExtValidationError blk)
</span><a href="Test.ThreadNet.Network.html#nodeEventsInvalids"><span class="hs-identifier hs-var hs-var">nodeEventsInvalids</span></a></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-791"></span><span>          </span><span id="local-6989586621679261677"><span class="annot"><span class="annottext">updatesTracer :: Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261677"><span class="hs-identifier hs-var hs-var">updatesTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m) -&gt; Tracer m (LedgerUpdate blk)
forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (LedgerUpdate blk)
</span><a href="Test.ThreadNet.Network.html#nodeEventsUpdates"><span class="hs-identifier hs-var hs-var">nodeEventsUpdates</span></a></span><span>  </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-792"></span><span>          </span><span id="local-6989586621679261675"><span class="annot"><span class="annottext">wrapTracer :: Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261675"><span class="hs-identifier hs-var hs-var">wrapTracer</span></a></span></span><span> </span><span id="local-6989586621679261674"><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261674"><span class="hs-identifier hs-var">tr</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((RealPoint blk, BlockNo) -&gt; m ())
-&gt; Tracer m (RealPoint blk, BlockNo)
forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; Tracer m a
</span><span class="hs-identifier hs-var">Tracer</span></span><span> </span><span class="annot"><span class="annottext">(((RealPoint blk, BlockNo) -&gt; m ())
 -&gt; Tracer m (RealPoint blk, BlockNo))
-&gt; ((RealPoint blk, BlockNo) -&gt; m ())
-&gt; Tracer m (RealPoint blk, BlockNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679261673"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261673"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261672"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261672"><span class="hs-identifier hs-var">bno</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-793"></span><span>            </span><span id="local-6989586621679261671"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261671"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; m SlotNo
forall (m :: * -&gt; *). OracularClock m -&gt; m SlotNo
</span><a href="Test.Util.HardFork.OracularClock.html#getCurrentSlot"><span class="hs-identifier hs-var hs-var">OracularClock.getCurrentSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-794"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; (SlotNo, RealPoint blk, BlockNo) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261674"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261671"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261673"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261672"><span class="hs-identifier hs-var">bno</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-795"></span><span>          </span><span id="local-6989586621679261669"><span class="annot"><span class="annottext">addTracer :: Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261669"><span class="hs-identifier hs-var hs-var">addTracer</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261675"><span class="hs-identifier hs-var">wrapTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(Tracer m (SlotNo, RealPoint blk, BlockNo)
 -&gt; Tracer m (RealPoint blk, BlockNo))
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsAdds"><span class="hs-identifier hs-var hs-var">nodeEventsAdds</span></a></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-796"></span><span>          </span><span id="local-6989586621679261667"><span class="annot"><span class="annottext">selTracer :: Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261667"><span class="hs-identifier hs-var hs-var">selTracer</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261675"><span class="hs-identifier hs-var">wrapTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(Tracer m (SlotNo, RealPoint blk, BlockNo)
 -&gt; Tracer m (RealPoint blk, BlockNo))
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsSelects"><span class="hs-identifier hs-var hs-var">nodeEventsSelects</span></a></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-797"></span><span>          </span><span id="local-6989586621679261665"><span class="annot"><span class="annottext">headerAddTracer :: Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261665"><span class="hs-identifier hs-var hs-var">headerAddTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261675"><span class="hs-identifier hs-var">wrapTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(Tracer m (SlotNo, RealPoint blk, BlockNo)
 -&gt; Tracer m (RealPoint blk, BlockNo))
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsHeaderAdds"><span class="hs-identifier hs-var hs-var">nodeEventsHeaderAdds</span></a></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-798"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261663"><span class="annot"><span class="annottext">chainDbArgs :: ChainDbArgs Identity m blk
</span><a href="#local-6989586621679261663"><span class="hs-identifier hs-var hs-var">chainDbArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OracularClock m
-&gt; ResourceRegistry m
-&gt; TopLevelConfig blk
-&gt; ExtLedgerState blk
-&gt; Tracer m (RealPoint blk, ExtValidationError blk)
-&gt; Tracer m (RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, BlockNo)
-&gt; Tracer m (LedgerUpdate blk)
-&gt; NodeDBs (StrictTVar m MockFS)
-&gt; CoreNodeId
-&gt; ChainDbArgs Identity m blk
</span><a href="#local-6989586621679261783"><span class="hs-identifier hs-var">mkArgs</span></a></span><span>
</span><span id="line-799"></span><span>            </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261690"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-800"></span><span>            </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679261685"><span class="hs-identifier hs-var">pInfoInitLedger</span></a></span><span>
</span><span id="line-801"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261679"><span class="hs-identifier hs-var">invalidTracer</span></a></span><span>
</span><span id="line-802"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261669"><span class="hs-identifier hs-var">addTracer</span></a></span><span>
</span><span id="line-803"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261667"><span class="hs-identifier hs-var">selTracer</span></a></span><span>
</span><span id="line-804"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261677"><span class="hs-identifier hs-var">updatesTracer</span></a></span><span>
</span><span id="line-805"></span><span>            </span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261681"><span class="hs-identifier hs-var">nodeInfoDBs</span></a></span><span>
</span><span id="line-806"></span><span>            </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261693"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-807"></span><span>      </span><span id="local-6989586621679261662"><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261662"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ResourceKey m, ChainDB m blk) -&gt; ChainDB m blk
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((ResourceKey m, ChainDB m blk) -&gt; ChainDB m blk)
-&gt; m (ResourceKey m, ChainDB m blk) -&gt; m (ChainDB m blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-808"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m (ChainDB m blk))
-&gt; (ChainDB m blk -&gt; m ())
-&gt; m (ResourceKey m, ChainDB m blk)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">allocate</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261690"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ChainDB m blk) -&gt; ResourceId -&gt; m (ChainDB m blk)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; m (ChainDB m blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, ConvertRawHash blk,
 SerialiseDiskConstraints blk) =&gt;
ChainDbArgs Identity m blk -&gt; m (ChainDB m blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.openDB</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679261663"><span class="hs-identifier hs-var">chainDbArgs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; m ()
forall (m :: * -&gt; *) blk. ChainDB m blk -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ChainDB.closeDB</span></a></span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679261657"><span class="hs-identifier hs-type">customForgeBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-811"></span><span>               </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockForging</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-812"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-813"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-814"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-815"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TickedLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-816"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-817"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IsLeader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-819"></span><span>          </span><span id="local-6989586621679261657"><span class="annot"><span class="annottext">customForgeBlock :: BlockForging m blk
-&gt; TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
</span><a href="#local-6989586621679261657"><span class="hs-identifier hs-var hs-var">customForgeBlock</span></a></span></span><span> </span><span id="local-6989586621679261656"><span class="annot"><span class="annottext">BlockForging m blk
</span><a href="#local-6989586621679261656"><span class="hs-identifier hs-var">origBlockForging</span></a></span></span><span> </span><span id="local-6989586621679261655"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261655"><span class="hs-identifier hs-var">cfg'</span></a></span></span><span> </span><span id="local-6989586621679261654"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261654"><span class="hs-identifier hs-var">currentBno</span></a></span></span><span> </span><span id="local-6989586621679261653"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261653"><span class="hs-identifier hs-var">currentSlot</span></a></span></span><span> </span><span id="local-6989586621679261652"><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261652"><span class="hs-identifier hs-var">tickedLdgSt</span></a></span></span><span> </span><span id="local-6989586621679261651"><span class="annot"><span class="annottext">[Validated (GenTx blk)]
</span><a href="#local-6989586621679261651"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span id="local-6989586621679261650"><span class="annot"><span class="annottext">IsLeader (BlockProtocol blk)
</span><a href="#local-6989586621679261650"><span class="hs-identifier hs-var">prf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-820"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261649"><span class="annot"><span class="annottext">currentEpoch :: EpochNo
</span><a href="#local-6989586621679261649"><span class="hs-identifier hs-var hs-var">currentEpoch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; SlotNo -&gt; EpochNo
</span><a href="Test.Util.HardFork.Future.html#futureSlotToEpoch"><span class="hs-identifier hs-var">HFF.futureSlotToEpoch</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621679262023"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261653"><span class="hs-identifier hs-var">currentSlot</span></a></span><span>
</span><span id="line-821"></span><span>
</span><span id="line-822"></span><span>            </span><span class="hs-comment">-- EBBs are only ever possible in the first era</span><span>
</span><span id="line-823"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261648"><span class="annot"><span class="annottext">inFirstEra :: Bool
</span><a href="#local-6989586621679261648"><span class="hs-identifier hs-var hs-var">inFirstEra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; EpochNo -&gt; Bool
</span><a href="Test.Util.HardFork.Future.html#futureEpochInFirstEra"><span class="hs-identifier hs-var">HFF.futureEpochInFirstEra</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621679262023"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679261649"><span class="hs-identifier hs-var">currentEpoch</span></a></span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679261646"><span class="hs-identifier hs-type">ebbSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-826"></span><span>                </span><span id="local-6989586621679261646"><span class="annot"><span class="annottext">ebbSlot :: SlotNo
</span><a href="#local-6989586621679261646"><span class="hs-identifier hs-var hs-var">ebbSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><span class="hs-identifier hs-var">SlotNo</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; SlotNo) -&gt; Word64 -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261644"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261642"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-827"></span><span>                  </span><span class="hs-keyword">where</span><span>
</span><span id="line-828"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>   </span><span id="local-6989586621679261644"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261644"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679261649"><span class="hs-identifier hs-var">currentEpoch</span></a></span><span>
</span><span id="line-829"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">EpochSize</span></span><span> </span><span id="local-6989586621679261642"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261642"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochSize
</span><a href="#local-6989586621679261935"><span class="hs-identifier hs-var">epochSize0</span></a></span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679261639"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-832"></span><span>                </span><span id="local-6989586621679261639"><span class="annot"><span class="annottext">p :: Point blk
</span><a href="#local-6989586621679261639"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (TickedLedgerState blk) -&gt; Point blk
forall b b'.
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">castPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Point (TickedLedgerState blk) -&gt; Point blk)
-&gt; Point (TickedLedgerState blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TickedLedgerState blk -&gt; Point (TickedLedgerState blk)
forall l. GetTip l =&gt; l -&gt; Point l
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261652"><span class="hs-identifier hs-var">tickedLdgSt</span></a></span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261636"><span class="annot"><span class="annottext">needEBB :: Bool
</span><a href="#local-6989586621679261636"><span class="hs-identifier hs-var hs-var">needEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261648"><span class="hs-identifier hs-var">inFirstEra</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; WithOrigin SlotNo
forall t. t -&gt; WithOrigin t
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261646"><span class="hs-identifier hs-var">ebbSlot</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo -&gt; WithOrigin SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; WithOrigin SlotNo
forall block. Point block -&gt; WithOrigin SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">pointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679261639"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-835"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ForgeEbbEnv blk)
</span><a href="#local-6989586621679262024"><span class="hs-identifier hs-var">mbForgeEbbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ForgeEbbEnv blk) -&gt; Maybe () -&gt; Maybe (ForgeEbbEnv blk)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679261636"><span class="hs-identifier hs-var">needEBB</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-836"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ForgeEbbEnv blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-837"></span><span>                 </span><span class="hs-comment">-- no EBB needed, forge without making one</span><span>
</span><span id="line-838"></span><span>                 </span><span class="annot"><span class="annottext">BlockForging m blk
-&gt; TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
forall (m :: * -&gt; *) blk.
BlockForging m blk
-&gt; TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">forgeBlock</span></a></span><span>
</span><span id="line-839"></span><span>                   </span><span class="annot"><span class="annottext">BlockForging m blk
</span><a href="#local-6989586621679261656"><span class="hs-identifier hs-var">origBlockForging</span></a></span><span>
</span><span id="line-840"></span><span>                   </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261655"><span class="hs-identifier hs-var">cfg'</span></a></span><span>
</span><span id="line-841"></span><span>                   </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261654"><span class="hs-identifier hs-var">currentBno</span></a></span><span>
</span><span id="line-842"></span><span>                   </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261653"><span class="hs-identifier hs-var">currentSlot</span></a></span><span>
</span><span id="line-843"></span><span>                   </span><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261652"><span class="hs-identifier hs-var">tickedLdgSt</span></a></span><span>
</span><span id="line-844"></span><span>                   </span><span class="annot"><span class="annottext">[Validated (GenTx blk)]
</span><a href="#local-6989586621679261651"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-845"></span><span>                   </span><span class="annot"><span class="annottext">IsLeader (BlockProtocol blk)
</span><a href="#local-6989586621679261650"><span class="hs-identifier hs-var">prf</span></a></span><span>
</span><span id="line-846"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679261630"><span class="annot"><span class="annottext">ForgeEbbEnv blk
</span><a href="#local-6989586621679261630"><span class="hs-identifier hs-var">forgeEbbEnv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-847"></span><span>                  </span><span class="hs-comment">-- The EBB shares its BlockNo with its predecessor (if</span><span>
</span><span id="line-848"></span><span>                  </span><span class="hs-comment">-- there is one)</span><span>
</span><span id="line-849"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261629"><span class="annot"><span class="annottext">ebbBno :: BlockNo
</span><a href="#local-6989586621679261629"><span class="hs-identifier hs-var hs-var">ebbBno</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261654"><span class="hs-identifier hs-var">currentBno</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-850"></span><span>                        </span><span class="hs-comment">-- We assume this invariant:</span><span>
</span><span id="line-851"></span><span>                        </span><span class="hs-comment">--</span><span>
</span><span id="line-852"></span><span>                        </span><span class="hs-comment">-- If forging of EBBs is enabled then the node</span><span>
</span><span id="line-853"></span><span>                        </span><span class="hs-comment">-- initialization is responsible for producing any</span><span>
</span><span id="line-854"></span><span>                        </span><span class="hs-comment">-- proper non-EBB blocks with block number 0.</span><span>
</span><span id="line-855"></span><span>                        </span><span class="hs-comment">--</span><span>
</span><span id="line-856"></span><span>                        </span><span class="hs-comment">-- So this case is unreachable.</span><span>
</span><span id="line-857"></span><span>                        </span><span class="annot"><span class="annottext">BlockNo
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; BlockNo
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Error, only node initialization can forge non-EBB with block number 0.&quot;</span></span><span>
</span><span id="line-858"></span><span>                        </span><span id="local-6989586621679261628"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261628"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockNo -&gt; BlockNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">pred</span></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261628"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-859"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261626"><span class="annot"><span class="annottext">ebb :: blk
</span><a href="#local-6989586621679261626"><span class="hs-identifier hs-var hs-var">ebb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForgeEbbEnv blk
-&gt; TopLevelConfig blk -&gt; SlotNo -&gt; BlockNo -&gt; ChainHash blk -&gt; blk
forall blk.
ForgeEbbEnv blk
-&gt; TopLevelConfig blk -&gt; SlotNo -&gt; BlockNo -&gt; ChainHash blk -&gt; blk
</span><a href="Test.ThreadNet.Network.html#forgeEBB"><span class="hs-identifier hs-var hs-var">forgeEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ForgeEbbEnv blk
</span><a href="#local-6989586621679261630"><span class="hs-identifier hs-var">forgeEbbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-860"></span><span>                              </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261646"><span class="hs-identifier hs-var">ebbSlot</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261629"><span class="hs-identifier hs-var">ebbBno</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; ChainHash blk
forall block. Point block -&gt; ChainHash block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">pointHash</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679261639"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span>                  </span><span class="hs-comment">-- fail if the EBB is invalid</span><span>
</span><span id="line-863"></span><span>                  </span><span class="hs-comment">-- if it is valid, we retick to the /same/ slot</span><span>
</span><span id="line-864"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261624"><span class="annot"><span class="annottext">apply :: blk
-&gt; TickedLedgerState blk
-&gt; Except (LedgerErr (LedgerState blk)) (LedgerState blk)
</span><a href="#local-6989586621679261624"><span class="hs-identifier hs-var hs-var">apply</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; blk
-&gt; TickedLedgerState blk
-&gt; Except (LedgerErr (LedgerState blk)) (LedgerState blk)
forall l blk.
(ApplyBlock l blk, HasCallStack) =&gt;
LedgerCfg l -&gt; blk -&gt; Ticked l -&gt; Except (LedgerErr l) l
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">applyLedgerBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-865"></span><span>                  </span><span id="local-6989586621679261622"><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261622"><span class="hs-identifier hs-var">tickedLdgSt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Except (LedgerErr (LedgerState blk)) (LedgerState blk)
-&gt; Either (LedgerErr (LedgerState blk)) (LedgerState blk)
forall e a. Except e a -&gt; Either e a
</span><span class="hs-identifier hs-var">Exc.runExcept</span></span><span> </span><span class="annot"><span class="annottext">(Except (LedgerErr (LedgerState blk)) (LedgerState blk)
 -&gt; Either (LedgerErr (LedgerState blk)) (LedgerState blk))
-&gt; Except (LedgerErr (LedgerState blk)) (LedgerState blk)
-&gt; Either (LedgerErr (LedgerState blk)) (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">blk
-&gt; TickedLedgerState blk
-&gt; Except (LedgerErr (LedgerState blk)) (LedgerState blk)
</span><a href="#local-6989586621679261624"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679261626"><span class="hs-identifier hs-var">ebb</span></a></span><span> </span><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261652"><span class="hs-identifier hs-var">tickedLdgSt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-866"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679261621"><span class="annot"><span class="annottext">LedgerErr (LedgerState blk)
</span><a href="#local-6989586621679261621"><span class="hs-identifier hs-var">e</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">JitEbbError blk -&gt; m (TickedLedgerState blk)
forall a e. Exception e =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">Exn.throw</span></span><span> </span><span class="annot"><span class="annottext">(JitEbbError blk -&gt; m (TickedLedgerState blk))
-&gt; JitEbbError blk -&gt; m (TickedLedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerErr (LedgerState blk) -&gt; JitEbbError blk
forall blk. LedgerError blk -&gt; JitEbbError blk
</span><a href="Test.ThreadNet.Network.html#JitEbbError"><span class="hs-identifier hs-var">JitEbbError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerErr (LedgerState blk)
</span><a href="#local-6989586621679261621"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-867"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679261618"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261618"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TickedLedgerState blk -&gt; m (TickedLedgerState blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TickedLedgerState blk -&gt; m (TickedLedgerState blk))
-&gt; TickedLedgerState blk -&gt; m (TickedLedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; SlotNo -&gt; LedgerState blk -&gt; TickedLedgerState blk
forall l. IsLedger l =&gt; LedgerCfg l -&gt; SlotNo -&gt; l -&gt; Ticked l
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">applyChainTick</span></a></span><span>
</span><span id="line-868"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>                                        </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261653"><span class="hs-identifier hs-var">currentSlot</span></a></span><span>
</span><span id="line-870"></span><span>                                        </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261618"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span>                  </span><span class="hs-comment">-- forge the block usings the ledger state that includes</span><span>
</span><span id="line-873"></span><span>                  </span><span class="hs-comment">-- the EBB</span><span>
</span><span id="line-874"></span><span>                  </span><span id="local-6989586621679261617"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679261617"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockForging m blk
-&gt; TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
forall (m :: * -&gt; *) blk.
BlockForging m blk
-&gt; TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">forgeBlock</span></a></span><span>
</span><span id="line-875"></span><span>                           </span><span class="annot"><span class="annottext">BlockForging m blk
</span><a href="#local-6989586621679261656"><span class="hs-identifier hs-var">origBlockForging</span></a></span><span>
</span><span id="line-876"></span><span>                           </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261655"><span class="hs-identifier hs-var">cfg'</span></a></span><span>
</span><span id="line-877"></span><span>                           </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261654"><span class="hs-identifier hs-var">currentBno</span></a></span><span>
</span><span id="line-878"></span><span>                           </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261653"><span class="hs-identifier hs-var">currentSlot</span></a></span><span>
</span><span id="line-879"></span><span>                           </span><span class="annot"><span class="annottext">TickedLedgerState blk
</span><a href="#local-6989586621679261622"><span class="hs-identifier hs-var">tickedLdgSt'</span></a></span><span>
</span><span id="line-880"></span><span>                           </span><span class="annot"><span class="annottext">[Validated (GenTx blk)]
</span><a href="#local-6989586621679261651"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-881"></span><span>                           </span><span class="annot"><span class="annottext">IsLeader (BlockProtocol blk)
</span><a href="#local-6989586621679261650"><span class="hs-identifier hs-var">prf</span></a></span><span>
</span><span id="line-882"></span><span>
</span><span id="line-883"></span><span>                  </span><span class="hs-comment">-- If the EBB or the subsequent block is invalid, then the</span><span>
</span><span id="line-884"></span><span>                  </span><span class="hs-comment">-- ChainDB will reject it as invalid, and</span><span>
</span><span id="line-885"></span><span>                  </span><span class="hs-comment">-- 'Test.ThreadNet.General.prop_general' will eventually fail</span><span>
</span><span id="line-886"></span><span>                  </span><span class="hs-comment">-- because of a block rejection.</span><span>
</span><span id="line-887"></span><span>                  </span><span class="annot"><span class="annottext">m (Point blk) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (Point blk) -&gt; m ()) -&gt; m (Point blk) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDB m blk -&gt; blk -&gt; m (Point blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.addBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261662"><span class="hs-identifier hs-var">chainDB</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679261626"><span class="hs-identifier hs-var">ebb</span></a></span><span>
</span><span id="line-888"></span><span>                  </span><span class="annot"><span class="annottext">blk -&gt; m blk
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679261617"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-889"></span><span>
</span><span id="line-890"></span><span>      </span><span id="local-6989586621679261615"><span class="annot"><span class="annottext">[BlockForging m blk]
</span><a href="#local-6989586621679261615"><span class="hs-identifier hs-var">origBlockForging</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [BlockForging m blk]
</span><a href="#local-6989586621679261684"><span class="hs-identifier hs-var">pInfoBlockForging</span></a></span><span>
</span><span id="line-891"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261614"><span class="annot"><span class="annottext">blockForging :: [BlockForging m blk]
</span><a href="#local-6989586621679261614"><span class="hs-identifier hs-var hs-var">blockForging</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-892"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">BlockForging m blk
</span><a href="#local-6989586621679261613"><span class="hs-identifier hs-var">bf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">forgeBlock :: TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">forgeBlock</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockForging m blk
-&gt; TopLevelConfig blk
-&gt; BlockNo
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; [Validated (GenTx blk)]
-&gt; IsLeader (BlockProtocol blk)
-&gt; m blk
</span><a href="#local-6989586621679261657"><span class="hs-identifier hs-var">customForgeBlock</span></a></span><span> </span><span class="annot"><span class="annottext">BlockForging m blk
</span><a href="#local-6989586621679261613"><span class="hs-identifier hs-var">bf</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-893"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679261613"><span class="annot"><span class="annottext">BlockForging m blk
</span><a href="#local-6989586621679261613"><span class="hs-identifier hs-var">bf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[BlockForging m blk]
</span><a href="#local-6989586621679261615"><span class="hs-identifier hs-var">origBlockForging</span></a></span><span>
</span><span id="line-894"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-895"></span><span>
</span><span id="line-896"></span><span>      </span><span class="hs-comment">-- This variable holds the number of the earliest slot in which the</span><span>
</span><span id="line-897"></span><span>      </span><span class="hs-comment">-- crucial txs have not yet been added. In other words, it holds the</span><span>
</span><span id="line-898"></span><span>      </span><span class="hs-comment">-- successor of the number of the latest slot in which the crucial txs</span><span>
</span><span id="line-899"></span><span>      </span><span class="hs-comment">-- have been added.</span><span>
</span><span id="line-900"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-901"></span><span>      </span><span class="hs-comment">-- Key facts: The thread that adds the crucial transactions updates this</span><span>
</span><span id="line-902"></span><span>      </span><span class="hs-comment">-- variable, and the forge tracer for 'TraceNodeIsLeader' blocks on it.</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261612"><span class="annot"><span class="annottext">SlotNo -&gt; STM m ()
</span><a href="#local-6989586621679261612"><span class="hs-identifier hs-var">unblockForge</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261611"><span class="annot"><span class="annottext">SlotNo -&gt; STM m ()
</span><a href="#local-6989586621679261611"><span class="hs-identifier hs-var">blockOnCrucial</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-904"></span><span>        </span><span id="local-6989586621679261610"><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261610"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; m (StrictTVar m SlotNo)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">uncheckedNewTVarM</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-number">0</span></span><span>
</span><span id="line-905"></span><span>        </span><span class="annot"><span class="annottext">(SlotNo -&gt; STM m (), SlotNo -&gt; STM m ())
-&gt; m (SlotNo -&gt; STM m (), SlotNo -&gt; STM m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-906"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261609"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261609"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-907"></span><span>              </span><span class="annot"><span class="annottext">StrictTVar m SlotNo -&gt; (SlotNo -&gt; SlotNo) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261610"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261609"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`max`</span></span><span class="hs-special">)</span><span>
</span><span id="line-908"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261608"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261608"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-909"></span><span>              </span><span id="local-6989586621679261607"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261607"><span class="hs-identifier hs-var">sentinel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo -&gt; STM m SlotNo
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m SlotNo
</span><a href="#local-6989586621679261610"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-910"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (stm :: * -&gt; *). MonadSTMTx stm =&gt; Bool -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m ()) -&gt; Bool -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261608"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261607"><span class="hs-identifier hs-var">sentinel</span></a></span><span>
</span><span id="line-911"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>
</span><span id="line-913"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- prop_general relies on these tracers</span><span>
</span><span id="line-914"></span><span>          </span><span id="local-6989586621679261605"><span class="annot"><span class="annottext">instrumentationTracers :: Tracers' NodeId Void blk (Tracer m)
</span><a href="#local-6989586621679261605"><span class="hs-identifier hs-var hs-var">instrumentationTracers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers m NodeId Any blk
forall (m :: * -&gt; *) remotePeer localPeer blk.
Monad m =&gt;
Tracers m remotePeer localPeer blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">nullTracers</span></a></span><span>
</span><span id="line-915"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">chainSyncClientTracer :: Tracer m (TraceLabelPeer NodeId (TraceChainSyncClientEvent blk))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">chainSyncClientTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TraceLabelPeer NodeId (TraceChainSyncClientEvent blk) -&gt; m ())
-&gt; Tracer m (TraceLabelPeer NodeId (TraceChainSyncClientEvent blk))
forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; Tracer m a
</span><span class="hs-identifier hs-var">Tracer</span></span><span> </span><span class="annot"><span class="annottext">((TraceLabelPeer NodeId (TraceChainSyncClientEvent blk) -&gt; m ())
 -&gt; Tracer
      m (TraceLabelPeer NodeId (TraceChainSyncClientEvent blk)))
-&gt; (TraceLabelPeer NodeId (TraceChainSyncClientEvent blk) -&gt; m ())
-&gt; Tracer m (TraceLabelPeer NodeId (TraceChainSyncClientEvent blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-916"></span><span>                    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CSClient.TraceDownloadedHeader</span></a></span><span> </span><span id="local-6989586621679261600"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679261600"><span class="hs-identifier hs-var">hdr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point (Header blk)
forall block. HasHeader block =&gt; block -&gt; Point block
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679261600"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-918"></span><span>                            </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">GenesisPoint</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>                            </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">BlockPoint</span></a></span><span> </span><span id="local-6989586621679261596"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261596"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679261595"><span class="annot"><span class="annottext">HeaderHash (Header blk)
</span><a href="#local-6989586621679261595"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-920"></span><span>                                </span><span class="hs-comment">-- TODO include tip in TraceDownloadedHeader</span><span>
</span><span id="line-921"></span><span>                                </span><span class="hs-comment">-- and only trace if hdr == tip?</span><span>
</span><span id="line-922"></span><span>                                </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
-&gt; (RealPoint blk, BlockNo) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261665"><span class="hs-identifier hs-var">headerAddTracer</span></a></span><span>
</span><span id="line-923"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
forall blk. SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">RealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261596"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
HeaderHash (Header blk)
</span><a href="#local-6989586621679261595"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; BlockNo
forall b. HasHeader b =&gt; b -&gt; BlockNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockNo</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679261600"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span>                    </span><span class="annot"><span class="annottext">TraceLabelPeer NodeId (TraceChainSyncClientEvent blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-925"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forgeTracer :: Tracer m (TraceLabelCreds (TraceForgeEvent blk))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">forgeTracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TraceLabelCreds (TraceForgeEvent blk) -&gt; m ())
-&gt; Tracer m (TraceLabelCreds (TraceForgeEvent blk))
forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; Tracer m a
</span><span class="hs-identifier hs-var">Tracer</span></span><span> </span><span class="annot"><span class="annottext">((TraceLabelCreds (TraceForgeEvent blk) -&gt; m ())
 -&gt; Tracer m (TraceLabelCreds (TraceForgeEvent blk)))
-&gt; (TraceLabelCreds (TraceForgeEvent blk) -&gt; m ())
-&gt; Tracer m (TraceLabelCreds (TraceForgeEvent blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TraceLabelCreds</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679261590"><span class="annot"><span class="annottext">TraceForgeEvent blk
</span><a href="#local-6989586621679261590"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-926"></span><span>                    </span><span class="annot"><span class="annottext">Tracer m (TraceForgeEvent blk) -&gt; TraceForgeEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m) -&gt; Tracer m (TraceForgeEvent blk)
forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (TraceForgeEvent blk)
</span><a href="Test.ThreadNet.Network.html#nodeEventsForges"><span class="hs-identifier hs-var hs-var">nodeEventsForges</span></a></span><span> </span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261682"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TraceForgeEvent blk
</span><a href="#local-6989586621679261590"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-927"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TraceForgeEvent blk
</span><a href="#local-6989586621679261590"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-928"></span><span>                      </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TraceNodeIsLeader</span></a></span><span> </span><span id="local-6989586621679261587"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261587"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; STM m ()
</span><a href="#local-6989586621679261611"><span class="hs-identifier hs-var">blockOnCrucial</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261587"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-929"></span><span>                      </span><span class="annot"><span class="annottext">TraceForgeEvent blk
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-930"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-931"></span><span>
</span><span id="line-932"></span><span>          </span><span class="hs-comment">-- traces the node's local events other than those from the -- ChainDB</span><span>
</span><span id="line-933"></span><span>          </span><span id="local-6989586621679261586"><span class="annot"><span class="annottext">tracers :: Tracers' NodeId Void blk (Tracer m)
</span><a href="#local-6989586621679261586"><span class="hs-identifier hs-var hs-var">tracers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers' NodeId Void blk (Tracer m)
</span><a href="#local-6989586621679261605"><span class="hs-identifier hs-var">instrumentationTracers</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' NodeId Void blk (Tracer m)
-&gt; Tracers' NodeId Void blk (Tracer m)
-&gt; Tracers' NodeId Void blk (Tracer m)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Tracers' NodeId Void blk (Tracer m)
forall (m :: * -&gt; *) peer blk.
(Monad m, Show peer, LedgerSupportsProtocol blk,
 TracingConstraints blk) =&gt;
Tracers m peer Void blk
</span><a href="Test.ThreadNet.Network.html#nullDebugTracers"><span class="hs-identifier hs-var">nullDebugTracers</span></a></span><span>
</span><span id="line-934"></span><span>
</span><span id="line-935"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- use a backoff delay of exactly one slot length (which the</span><span>
</span><span id="line-936"></span><span>          </span><span class="hs-comment">-- 'OracularClock' always knows) for the following reasons</span><span>
</span><span id="line-937"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-938"></span><span>          </span><span class="hs-comment">-- o It gives the node a chance to sync some blocks so that it will</span><span>
</span><span id="line-939"></span><span>          </span><span class="hs-comment">--   eventually not need to backoff</span><span>
</span><span id="line-940"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-941"></span><span>          </span><span class="hs-comment">-- o It maintains the invariant that the node's activities all happen &quot;</span><span>
</span><span id="line-942"></span><span>          </span><span class="hs-comment">--   during &quot; a slot onset</span><span>
</span><span id="line-943"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-944"></span><span>          </span><span class="hs-comment">-- o It avoids causing the node to miss a slot it could have</span><span>
</span><span id="line-945"></span><span>          </span><span class="hs-comment">--   nominally lead. EG If we used a backoff of two slot durations,</span><span>
</span><span id="line-946"></span><span>          </span><span class="hs-comment">--   then it might have synced during the first slot and then been</span><span>
</span><span id="line-947"></span><span>          </span><span class="hs-comment">--   able to productively lead the second slot had it not still been</span><span>
</span><span id="line-948"></span><span>          </span><span class="hs-comment">--   asleep.</span><span>
</span><span id="line-949"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-950"></span><span>          </span><span class="hs-comment">-- o We assume a node will only backoff when it joins late and only</span><span>
</span><span id="line-951"></span><span>          </span><span class="hs-comment">--   until it syncs enough of the net's existing common prefix.</span><span>
</span><span id="line-952"></span><span>          </span><span id="local-6989586621679261584"><span class="annot"><span class="annottext">hfbtBackoffDelay :: m BackoffDelay
</span><a href="#local-6989586621679261584"><span class="hs-identifier hs-var hs-var">hfbtBackoffDelay</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-953"></span><span>              </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; BackoffDelay
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">BackoffDelay</span></a></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; BackoffDelay)
-&gt; m NominalDiffTime -&gt; m BackoffDelay
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; m NominalDiffTime
forall (m :: * -&gt; *). OracularClock m -&gt; m NominalDiffTime
</span><a href="Test.Util.HardFork.OracularClock.html#delayUntilNextSlot"><span class="hs-identifier hs-var hs-var">OracularClock.delayUntilNextSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-954"></span><span>      </span><span id="local-6989586621679261581"><span class="annot"><span class="annottext">BlockchainTime m
</span><a href="#local-6989586621679261581"><span class="hs-identifier hs-var">btime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HardForkBlockchainTimeArgs m blk -&gt; m (BlockchainTime m)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHardForkHistory blk, HasCallStack) =&gt;
HardForkBlockchainTimeArgs m blk -&gt; m (BlockchainTime m)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hardForkBlockchainTime</span></a></span><span> </span><span class="annot"><span class="annottext">HardForkBlockchainTimeArgs :: forall (m :: * -&gt; *) blk.
m BackoffDelay
-&gt; STM m (LedgerState blk)
-&gt; LedgerConfig blk
-&gt; ResourceRegistry m
-&gt; SystemTime m
-&gt; Tracer m (TraceBlockchainTimeEvent RelativeTime)
-&gt; NominalDiffTime
-&gt; HardForkBlockchainTimeArgs m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">HardForkBlockchainTimeArgs</span></a></span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">m BackoffDelay
hfbtBackoffDelay :: m BackoffDelay
hfbtBackoffDelay :: m BackoffDelay
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">hfbtBackoffDelay</span></a></span><span>
</span><span id="line-956"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hfbtGetLedgerState :: STM m (LedgerState blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hfbtGetLedgerState</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-957"></span><span>            </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; STM m (ExtLedgerState blk) -&gt; STM m (LedgerState blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
(Monad (STM m), IsLedger (LedgerState blk)) =&gt;
ChainDB m blk -&gt; STM m (ExtLedgerState blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.getCurrentLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261662"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-958"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hfbtLedgerConfig :: LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hfbtLedgerConfig</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-959"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hfbtRegistry :: ResourceRegistry m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hfbtRegistry</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261690"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-960"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hfbtSystemTime :: SystemTime m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hfbtSystemTime</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; SystemTime m
forall (m :: * -&gt; *). OracularClock m -&gt; SystemTime m
</span><a href="Test.Util.HardFork.OracularClock.html#finiteSystemTime"><span class="hs-identifier hs-var hs-var">OracularClock.finiteSystemTime</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-961"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hfbtTracer :: Tracer m (TraceBlockchainTimeEvent RelativeTime)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hfbtTracer</span></a></span><span>         </span><span class="hs-glyph">=</span><span>
</span><span id="line-962"></span><span>            </span><span class="annot"><span class="annottext">(TraceBlockchainTimeEvent RelativeTime
 -&gt; TraceBlockchainTimeEvent UTCTime)
-&gt; Tracer m (TraceBlockchainTimeEvent UTCTime)
-&gt; Tracer m (TraceBlockchainTimeEvent RelativeTime)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><span class="hs-identifier hs-var">contramap</span></span><span>
</span><span id="line-963"></span><span>              </span><span class="hs-comment">-- We don't really have a SystemStart in the tests</span><span>
</span><span id="line-964"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RelativeTime -&gt; UTCTime)
-&gt; TraceBlockchainTimeEvent RelativeTime
-&gt; TraceBlockchainTimeEvent UTCTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SystemStart -&gt; RelativeTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">fromRelativeTime</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UTCTime -&gt; SystemStart
</span><span class="hs-identifier hs-var">SystemStart</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="Test.Util.Time.html#dawnOfTime"><span class="hs-identifier hs-var">dawnOfTime</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-965"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers' NodeId Void blk (Tracer m)
-&gt; Tracer m (TraceBlockchainTimeEvent UTCTime)
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceBlockchainTimeEvent UTCTime)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">blockchainTimeTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' NodeId Void blk (Tracer m)
</span><a href="#local-6989586621679261586"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hfbtMaxClockRewind :: NominalDiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">hfbtMaxClockRewind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double -&gt; NominalDiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">secondsToNominalDiffTime</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0</span></span><span>
</span><span id="line-967"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261566"><span class="annot"><span class="annottext">kaRng :: StdGen
</span><a href="#local-6989586621679261566"><span class="hs-identifier hs-var hs-var">kaRng</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Seed
</span><a href="#local-6989586621679262017"><span class="hs-identifier hs-var">seed</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-970"></span><span>                    </span><span class="annot"><a href="Test.ThreadNet.Util.Seed.html#Seed"><span class="hs-identifier hs-type">Seed</span></a></span><span> </span><span id="local-6989586621679261564"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679261564"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; StdGen
</span><span class="hs-identifier hs-var">mkStdGen</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679261564"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-971"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261563"><span class="annot"><span class="annottext">nodeKernelArgs :: NodeKernelArgs m NodeId Void blk
</span><a href="#local-6989586621679261563"><span class="hs-identifier hs-var hs-var">nodeKernelArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeKernelArgs :: forall (m :: * -&gt; *) remotePeer localPeer blk.
Tracers m remotePeer localPeer blk
-&gt; ResourceRegistry m
-&gt; TopLevelConfig blk
-&gt; BlockchainTime m
-&gt; ChainDB m blk
-&gt; (StorageConfig blk -&gt; InitChainDB m blk -&gt; m ())
-&gt; (Header blk -&gt; Word32)
-&gt; [BlockForging m blk]
-&gt; MaxTxCapacityOverride
-&gt; MempoolCapacityBytesOverride
-&gt; MiniProtocolParameters
-&gt; BlockFetchConfiguration
-&gt; StdGen
-&gt; NodeKernelArgs m remotePeer localPeer blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeKernelArgs</span></a></span><span>
</span><span id="line-972"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Tracers' NodeId Void blk (Tracer m)
$sel:tracers:NodeKernelArgs :: Tracers' NodeId Void blk (Tracer m)
tracers :: Tracers' NodeId Void blk (Tracer m)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">tracers</span></a></span><span>
</span><span id="line-973"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
$sel:registry:NodeKernelArgs :: ResourceRegistry m
registry :: ResourceRegistry m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">registry</span></a></span><span>
</span><span id="line-974"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:cfg:NodeKernelArgs :: TopLevelConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cfg</span></a></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-975"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockchainTime m
$sel:btime:NodeKernelArgs :: BlockchainTime m
btime :: BlockchainTime m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">btime</span></a></span><span>
</span><span id="line-976"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
$sel:chainDB:NodeKernelArgs :: ChainDB m blk
chainDB :: ChainDB m blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">chainDB</span></a></span><span>
</span><span id="line-977"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:initChainDB:NodeKernelArgs :: StorageConfig blk -&gt; InitChainDB m blk -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">initChainDB</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StorageConfig blk -&gt; InitChainDB m blk -&gt; m ()
forall blk (m :: * -&gt; *).
(NodeInitStorage blk, IOLike m) =&gt;
StorageConfig blk -&gt; InitChainDB m blk -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">nodeInitChainDB</span></a></span><span>
</span><span id="line-978"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:blockForging:NodeKernelArgs :: [BlockForging m blk]
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">blockForging</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BlockForging m blk]
</span><a href="#local-6989586621679261614"><span class="hs-identifier hs-var">blockForging</span></a></span><span>
</span><span id="line-979"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:blockFetchSize:NodeKernelArgs :: Header blk -&gt; Word32
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Word32
forall blk.
SerialiseNodeToNodeConstraints blk =&gt;
Header blk -&gt; Word32
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">estimateBlockSize</span></a></span><span>
</span><span id="line-980"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:maxTxCapacityOverride:NodeKernelArgs :: MaxTxCapacityOverride
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">maxTxCapacityOverride</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaxTxCapacityOverride
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NoMaxTxCapacityOverride</span></a></span><span>
</span><span id="line-981"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:mempoolCapacityOverride:NodeKernelArgs :: MempoolCapacityBytesOverride
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">mempoolCapacityOverride</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NoMempoolCapacityBytesOverride</span></a></span><span>
</span><span id="line-982"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:keepAliveRng:NodeKernelArgs :: StdGen
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">keepAliveRng</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679261566"><span class="hs-identifier hs-var">kaRng</span></a></span><span>
</span><span id="line-983"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:miniProtocolParameters:NodeKernelArgs :: MiniProtocolParameters
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MiniProtocolParameters :: Word32 -&gt; Word32 -&gt; Word -&gt; Word16 -&gt; MiniProtocolParameters
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">MiniProtocolParameters</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-984"></span><span>                  </span><span class="annot"><span class="annottext">chainSyncPipeliningHighMark :: Word32
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">chainSyncPipeliningHighMark</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">4</span></span><span class="hs-special">,</span><span>
</span><span id="line-985"></span><span>                  </span><span class="annot"><span class="annottext">chainSyncPipeliningLowMark :: Word32
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">chainSyncPipeliningLowMark</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">2</span></span><span class="hs-special">,</span><span>
</span><span id="line-986"></span><span>                  </span><span class="annot"><span class="annottext">blockFetchPipeliningMax :: Word
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockFetchPipeliningMax</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">10</span></span><span class="hs-special">,</span><span>
</span><span id="line-987"></span><span>                  </span><span class="annot"><span class="annottext">txSubmissionMaxUnacked :: Word16
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">txSubmissionMaxUnacked</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">1000</span></span><span> </span><span class="hs-comment">-- TODO ?</span><span>
</span><span id="line-988"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-989"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:blockFetchConfiguration:NodeKernelArgs :: BlockFetchConfiguration
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">blockFetchConfiguration</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockFetchConfiguration :: Word -&gt; Word -&gt; Word -&gt; DiffTime -&gt; Int -&gt; BlockFetchConfiguration
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-990"></span><span>                  </span><span class="annot"><span class="annottext">bfcMaxConcurrencyBulkSync :: Word
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">bfcMaxConcurrencyBulkSync</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>
</span><span id="line-991"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bfcMaxConcurrencyDeadline :: Word
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">bfcMaxConcurrencyDeadline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2</span></span><span>
</span><span id="line-992"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bfcMaxRequestsInflight :: Word
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">bfcMaxRequestsInflight</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">10</span></span><span>
</span><span id="line-993"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bfcDecisionLoopInterval :: DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">bfcDecisionLoopInterval</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0.0</span></span><span> </span><span class="hs-comment">-- Mock testsuite can use sub-second slot</span><span>
</span><span id="line-994"></span><span>                                                  </span><span class="hs-comment">-- interval which doesn't play nice with</span><span>
</span><span id="line-995"></span><span>                                                  </span><span class="hs-comment">-- blockfetch descision interval.</span><span>
</span><span id="line-996"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bfcSalt :: Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">bfcSalt</span></a></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-997"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-998"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-999"></span><span>
</span><span id="line-1000"></span><span>      </span><span id="local-6989586621679261533"><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261533"><span class="hs-identifier hs-var">nodeKernel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NodeKernelArgs m NodeId Void blk
-&gt; m (NodeKernel m NodeId Void blk)
forall (m :: * -&gt; *) remotePeer localPeer blk.
(IOLike m, RunNode blk, NoThunks remotePeer, Ord remotePeer,
 Hashable remotePeer) =&gt;
NodeKernelArgs m remotePeer localPeer blk
-&gt; m (NodeKernel m remotePeer localPeer blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">initNodeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernelArgs m NodeId Void blk
</span><a href="#local-6989586621679261563"><span class="hs-identifier hs-var">nodeKernelArgs</span></a></span><span>
</span><span id="line-1001"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261531"><span class="annot"><span class="annottext">mempool :: Mempool m blk TicketNo
</span><a href="#local-6989586621679261531"><span class="hs-identifier hs-var hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk -&gt; Mempool m blk TicketNo
forall (m :: * -&gt; *) remotePeer localPeer blk.
NodeKernel m remotePeer localPeer blk -&gt; Mempool m blk TicketNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">getMempool</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261533"><span class="hs-identifier hs-var">nodeKernel</span></a></span><span>
</span><span id="line-1002"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261529"><span class="annot"><span class="annottext">app :: Apps
  m
  NodeId
  ByteString
  ByteString
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
  ()
</span><a href="#local-6989586621679261529"><span class="hs-identifier hs-var hs-var">app</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
-&gt; Tracers m NodeId blk CodecError
-&gt; (NodeToNodeVersion
    -&gt; Codecs
         blk
         CodecError
         m
         ByteString
         ByteString
         ByteString
         ByteString
         (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
         (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
         (AnyMessage KeepAlive))
-&gt; m ChainSyncTimeout
-&gt; Handlers m NodeId blk
-&gt; Apps
     m
     NodeId
     ByteString
     ByteString
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
     (AnyMessage KeepAlive)
     ()
forall (m :: * -&gt; *) remotePeer localPeer blk e bCS bBF bTX bTX2
       bKA.
(IOLike m, MonadTimer m, Ord remotePeer, Exception e,
 LedgerSupportsProtocol blk, ShowProxy blk, ShowProxy (Header blk),
 ShowProxy (TxId (GenTx blk)), ShowProxy (GenTx blk)) =&gt;
NodeKernel m remotePeer localPeer blk
-&gt; Tracers m remotePeer blk e
-&gt; (NodeToNodeVersion
    -&gt; Codecs blk e m bCS bCS bBF bBF bTX bTX2 bKA)
-&gt; m ChainSyncTimeout
-&gt; Handlers m remotePeer blk
-&gt; Apps m remotePeer bCS bBF bTX bTX2 bKA ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.mkApps</span></a></span><span>
</span><span id="line-1003"></span><span>                  </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261533"><span class="hs-identifier hs-var">nodeKernel</span></a></span><span>
</span><span id="line-1004"></span><span>                  </span><span class="hs-comment">-- these tracers report every message sent/received by this</span><span>
</span><span id="line-1005"></span><span>                  </span><span class="hs-comment">-- node</span><span>
</span><span id="line-1006"></span><span>                  </span><span class="annot"><span class="annottext">Tracers m NodeId blk CodecError
forall (m :: * -&gt; *) blk peer failure.
(Monad m, HasHeader blk, TracingConstraints blk, Show peer) =&gt;
Tracers m peer blk failure
</span><a href="Test.ThreadNet.Network.html#nullDebugProtocolTracers"><span class="hs-identifier hs-var">nullDebugProtocolTracers</span></a></span><span>
</span><span id="line-1007"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     CodecError
     m
     ByteString
     ByteString
     ByteString
     ByteString
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
     (AnyMessage KeepAlive)
</span><a href="#local-6989586621679261526"><span class="hs-identifier hs-var">customNodeToNodeCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1008"></span><span>                  </span><span class="hs-comment">-- see #1882, tests that can't cope with timeouts.</span><span>
</span><span id="line-1009"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncTimeout -&gt; m ChainSyncTimeout
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ChainSyncTimeout -&gt; m ChainSyncTimeout)
-&gt; ChainSyncTimeout -&gt; m ChainSyncTimeout
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncTimeout :: Maybe DiffTime
-&gt; Maybe DiffTime -&gt; Maybe DiffTime -&gt; ChainSyncTimeout
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NTN.ChainSyncTimeout</span></a></span><span>
</span><span id="line-1010"></span><span>                     </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canAwaitTimeout :: Maybe DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">canAwaitTimeout</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">waitForever</span></a></span><span>
</span><span id="line-1011"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">intersectTimeout :: Maybe DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">intersectTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">waitForever</span></a></span><span>
</span><span id="line-1012"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mustReplyTimeout :: Maybe DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">mustReplyTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">waitForever</span></a></span><span>
</span><span id="line-1013"></span><span>                     </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1014"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernelArgs m NodeId Void blk
-&gt; NodeKernel m NodeId Void blk -&gt; Handlers m NodeId blk
forall (m :: * -&gt; *) blk remotePeer localPeer.
(IOLike m, MonadTime m, MonadTimer m, LedgerSupportsMempool blk,
 HasTxId (GenTx blk), LedgerSupportsProtocol blk, Ord remotePeer) =&gt;
NodeKernelArgs m remotePeer localPeer blk
-&gt; NodeKernel m remotePeer localPeer blk
-&gt; Handlers m remotePeer blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.mkHandlers</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernelArgs m NodeId Void blk
</span><a href="#local-6989586621679261563"><span class="hs-identifier hs-var">nodeKernelArgs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261533"><span class="hs-identifier hs-var">nodeKernel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1015"></span><span>
</span><span id="line-1016"></span><span>      </span><span class="hs-comment">-- In practice, a robust wallet/user can persistently add a transaction</span><span>
</span><span id="line-1017"></span><span>      </span><span class="hs-comment">-- until it appears on the chain. This thread adds robustness for the</span><span>
</span><span id="line-1018"></span><span>      </span><span class="hs-comment">-- @txs0@ argument, which in practice contains delegation certificates</span><span>
</span><span id="line-1019"></span><span>      </span><span class="hs-comment">-- that the node operator would very insistently add.</span><span>
</span><span id="line-1020"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1021"></span><span>      </span><span class="hs-comment">-- It's necessary here because under some circumstances a transaction in</span><span>
</span><span id="line-1022"></span><span>      </span><span class="hs-comment">-- the mempool can be \&quot;lost\&quot; due to no fault of its own. If a dlg cert</span><span>
</span><span id="line-1023"></span><span>      </span><span class="hs-comment">-- is lost, a node that rekeyed can never lead again. Moreover,</span><span>
</span><span id="line-1024"></span><span>      </span><span class="hs-comment">-- promptness of certain transactions simplifies the definition of</span><span>
</span><span id="line-1025"></span><span>      </span><span class="hs-comment">-- corresponding test properties: it's easier to predict whether a</span><span>
</span><span id="line-1026"></span><span>      </span><span class="hs-comment">-- proposal will expire if we're ensured all votes are as prompt as</span><span>
</span><span id="line-1027"></span><span>      </span><span class="hs-comment">-- possible. Lastly, the \&quot;wallet\&quot; might simply need to wait until</span><span>
</span><span id="line-1028"></span><span>      </span><span class="hs-comment">-- enough of the chain is synced that the transaction is valid.</span><span>
</span><span id="line-1029"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1030"></span><span>      </span><span class="hs-comment">-- TODO Is there a risk that this will block because the 'forkTxProducer'</span><span>
</span><span id="line-1031"></span><span>      </span><span class="hs-comment">-- fills up the mempool too quickly?</span><span>
</span><span id="line-1032"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt;
OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; (SlotNo -&gt; STM m ())
-&gt; LedgerConfig blk
-&gt; STM m (LedgerState blk)
-&gt; Mempool m blk TicketNo
-&gt; [GenTx blk]
-&gt; m ()
OracularClock m
-&gt; SlotNo
-&gt; ResourceRegistry m
-&gt; (SlotNo -&gt; STM m ())
-&gt; LedgerConfig blk
-&gt; STM m (LedgerState blk)
-&gt; Mempool m blk TicketNo
-&gt; [GenTx blk]
-&gt; m ()
</span><a href="#local-6989586621679261850"><span class="hs-identifier hs-var">forkCrucialTxs</span></a></span><span>
</span><span id="line-1033"></span><span>        </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-1034"></span><span>        </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261691"><span class="hs-identifier hs-var">joinSlot</span></a></span><span>
</span><span id="line-1035"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261690"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-1036"></span><span>        </span><span class="annot"><span class="annottext">SlotNo -&gt; STM m ()
</span><a href="#local-6989586621679261612"><span class="hs-identifier hs-var">unblockForge</span></a></span><span>
</span><span id="line-1037"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1038"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; STM m (ExtLedgerState blk) -&gt; STM m (LedgerState blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
(Monad (STM m), IsLedger (LedgerState blk)) =&gt;
ChainDB m blk -&gt; STM m (ExtLedgerState blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.getCurrentLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261662"><span class="hs-identifier hs-var">chainDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1039"></span><span>        </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261531"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-1040"></span><span>        </span><span class="annot"><span class="annottext">[GenTx blk]
</span><a href="#local-6989586621679261687"><span class="hs-identifier hs-var">txs0</span></a></span><span>
</span><span id="line-1041"></span><span>
</span><span id="line-1042"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt;
CoreNodeId
-&gt; ResourceRegistry m
-&gt; OracularClock m
-&gt; TopLevelConfig blk
-&gt; Seed
-&gt; STM m (ExtLedgerState blk)
-&gt; Mempool m blk TicketNo
-&gt; m ()
CoreNodeId
-&gt; ResourceRegistry m
-&gt; OracularClock m
-&gt; TopLevelConfig blk
-&gt; Seed
-&gt; STM m (ExtLedgerState blk)
-&gt; Mempool m blk TicketNo
-&gt; m ()
</span><a href="#local-6989586621679261798"><span class="hs-identifier hs-var">forkTxProducer</span></a></span><span>
</span><span id="line-1043"></span><span>        </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261693"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span>
</span><span id="line-1044"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261690"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-1045"></span><span>        </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261692"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-1046"></span><span>        </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261686"><span class="hs-identifier hs-var">pInfoConfig</span></a></span><span>
</span><span id="line-1047"></span><span>        </span><span class="hs-comment">-- Combine with the CoreNodeId, otherwise each node would generate the</span><span>
</span><span id="line-1048"></span><span>        </span><span class="hs-comment">-- same transactions.</span><span>
</span><span id="line-1049"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seed
</span><a href="#local-6989586621679262017"><span class="hs-identifier hs-var">seed</span></a></span><span> </span><span class="annot"><span class="annottext">Seed -&gt; Word64 -&gt; Seed
forall a. Integral a =&gt; Seed -&gt; a -&gt; Seed
</span><a href="Test.ThreadNet.Util.Seed.html#combineWith"><span class="hs-operator hs-var">`combineWith`</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; Word64
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">unCoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261693"><span class="hs-identifier hs-var">coreNodeId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1050"></span><span>        </span><span class="hs-comment">-- Uses the same varRNG as the block producer, but we split the RNG</span><span>
</span><span id="line-1051"></span><span>        </span><span class="hs-comment">-- each time, so this is fine.</span><span>
</span><span id="line-1052"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
(Monad (STM m), IsLedger (LedgerState blk)) =&gt;
ChainDB m blk -&gt; STM m (ExtLedgerState blk)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">ChainDB.getCurrentLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679261662"><span class="hs-identifier hs-var">chainDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1053"></span><span>        </span><span class="annot"><span class="annottext">Mempool m blk TicketNo
</span><a href="#local-6989586621679261531"><span class="hs-identifier hs-var">mempool</span></a></span><span>
</span><span id="line-1054"></span><span>
</span><span id="line-1055"></span><span>      </span><span class="annot"><span class="annottext">(NodeKernel m NodeId Void blk, LimitedApp m NodeId blk)
-&gt; m (NodeKernel m NodeId Void blk, LimitedApp m NodeId blk)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><a href="#local-6989586621679261533"><span class="hs-identifier hs-var">nodeKernel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Apps
  m
  NodeId
  ByteString
  ByteString
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
  ()
-&gt; LimitedApp m NodeId blk
forall (m :: * -&gt; *) peer blk.
LimitedApp' m peer blk -&gt; LimitedApp m peer blk
</span><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-var">LimitedApp</span></a></span><span> </span><span class="annot"><span class="annottext">Apps
  m
  NodeId
  ByteString
  ByteString
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
  ()
</span><a href="#local-6989586621679261529"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1056"></span><span>
</span><span id="line-1057"></span><span>    </span><span class="annot"><a href="#local-6989586621679261526"><span class="hs-identifier hs-type">customNodeToNodeCodecs</span></a></span><span>
</span><span id="line-1058"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1059"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span>
</span><span id="line-1060"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NTN.Codecs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#CodecError"><span class="hs-identifier hs-type">CodecError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262027"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1061"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span>
</span><span id="line-1062"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span>
</span><span id="line-1063"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span>
</span><span id="line-1064"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span>
</span><span id="line-1065"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">AnyMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">TxSubmission</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1066"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">AnyMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">TxSubmission2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262026"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1067"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">AnyMessage</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">KeepAlive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1068"></span><span>    </span><span id="local-6989586621679261526"><span class="annot"><span class="annottext">customNodeToNodeCodecs :: TopLevelConfig blk
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     CodecError
     m
     ByteString
     ByteString
     ByteString
     ByteString
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
     (AnyMessage KeepAlive)
</span><a href="#local-6989586621679261526"><span class="hs-identifier hs-var hs-var">customNodeToNodeCodecs</span></a></span></span><span> </span><span id="local-6989586621679261518"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261518"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679261517"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679261517"><span class="hs-identifier hs-var">ntnVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codecs :: forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) e m bSCS
-&gt; Codec (BlockFetch blk (Point blk)) e m bBF
-&gt; Codec (BlockFetch (Serialised blk) (Point blk)) e m bSBF
-&gt; Codec (TxSubmission (GenTxId blk) (GenTx blk)) e m bTX
-&gt; Codec (TxSubmission2 (GenTxId blk) (GenTx blk)) e m bTX2
-&gt; Codec KeepAlive e m bKA
-&gt; Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NTN.Codecs</span></a></span><span>
</span><span id="line-1069"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cChainSyncCodec :: Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  CodecError
  m
  ByteString
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cChainSyncCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1070"></span><span>            </span><span class="annot"><span class="annottext">(DeserialiseFailure -&gt; CodecError)
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     CodecError
     m
     ByteString
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; DeserialiseFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecBytesFailure"><span class="hs-identifier hs-var">CodecBytesFailure</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSync&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Codec
   (ChainSync (Header blk) (Point blk) (Tip blk))
   DeserialiseFailure
   m
   ByteString
 -&gt; Codec
      (ChainSync (Header blk) (Point blk) (Tip blk))
      CodecError
      m
      ByteString)
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     CodecError
     m
     ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1071"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cChainSyncCodec</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
</span><a href="#local-6989586621679261513"><span class="hs-identifier hs-var">binaryProtocolCodecs</span></a></span><span>
</span><span id="line-1072"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cChainSyncCodecSerialised :: Codec
  (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
  CodecError
  m
  ByteString
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cChainSyncCodecSerialised</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1073"></span><span>            </span><span class="annot"><span class="annottext">(DeserialiseFailure -&gt; CodecError)
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     CodecError
     m
     ByteString
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; DeserialiseFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecBytesFailure"><span class="hs-identifier hs-var">CodecBytesFailure</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSyncSerialised&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Codec
   (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
   DeserialiseFailure
   m
   ByteString
 -&gt; Codec
      (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
      CodecError
      m
      ByteString)
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     CodecError
     m
     ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1074"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) e m bSCS
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cChainSyncCodecSerialised</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
</span><a href="#local-6989586621679261513"><span class="hs-identifier hs-var">binaryProtocolCodecs</span></a></span><span>
</span><span id="line-1075"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cBlockFetchCodec :: Codec (BlockFetch blk (Point blk)) CodecError m ByteString
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cBlockFetchCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1076"></span><span>            </span><span class="annot"><span class="annottext">(DeserialiseFailure -&gt; CodecError)
-&gt; Codec
     (BlockFetch blk (Point blk)) DeserialiseFailure m ByteString
-&gt; Codec (BlockFetch blk (Point blk)) CodecError m ByteString
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; DeserialiseFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecBytesFailure"><span class="hs-identifier hs-var">CodecBytesFailure</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BlockFetch&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Codec (BlockFetch blk (Point blk)) DeserialiseFailure m ByteString
 -&gt; Codec (BlockFetch blk (Point blk)) CodecError m ByteString)
-&gt; Codec
     (BlockFetch blk (Point blk)) DeserialiseFailure m ByteString
-&gt; Codec (BlockFetch blk (Point blk)) CodecError m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1077"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
-&gt; Codec
     (BlockFetch blk (Point blk)) DeserialiseFailure m ByteString
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec (BlockFetch blk (Point blk)) e m bBF
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cBlockFetchCodec</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
</span><a href="#local-6989586621679261513"><span class="hs-identifier hs-var">binaryProtocolCodecs</span></a></span><span>
</span><span id="line-1078"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cBlockFetchCodecSerialised :: Codec
  (BlockFetch (Serialised blk) (Point blk)) CodecError m ByteString
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cBlockFetchCodecSerialised</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1079"></span><span>            </span><span class="annot"><span class="annottext">(DeserialiseFailure -&gt; CodecError)
-&gt; Codec
     (BlockFetch (Serialised blk) (Point blk))
     DeserialiseFailure
     m
     ByteString
-&gt; Codec
     (BlockFetch (Serialised blk) (Point blk)) CodecError m ByteString
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; DeserialiseFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecBytesFailure"><span class="hs-identifier hs-var">CodecBytesFailure</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BlockFetchSerialised&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Codec
   (BlockFetch (Serialised blk) (Point blk))
   DeserialiseFailure
   m
   ByteString
 -&gt; Codec
      (BlockFetch (Serialised blk) (Point blk)) CodecError m ByteString)
-&gt; Codec
     (BlockFetch (Serialised blk) (Point blk))
     DeserialiseFailure
     m
     ByteString
-&gt; Codec
     (BlockFetch (Serialised blk) (Point blk)) CodecError m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1080"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
-&gt; Codec
     (BlockFetch (Serialised blk) (Point blk))
     DeserialiseFailure
     m
     ByteString
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec (BlockFetch (Serialised blk) (Point blk)) e m bSBF
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cBlockFetchCodecSerialised</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
</span><a href="#local-6989586621679261513"><span class="hs-identifier hs-var">binaryProtocolCodecs</span></a></span><span>
</span><span id="line-1081"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cTxSubmissionCodec :: Codec
  (TxSubmission (GenTxId blk) (GenTx blk))
  CodecError
  m
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cTxSubmissionCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1082"></span><span>            </span><span class="annot"><span class="annottext">(CodecFailure -&gt; CodecError)
-&gt; Codec
     (TxSubmission (GenTxId blk) (GenTx blk))
     CodecFailure
     m
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
-&gt; Codec
     (TxSubmission (GenTxId blk) (GenTx blk))
     CodecError
     m
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="annot"><span class="annottext">CodecFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecIdFailure"><span class="hs-identifier hs-var">CodecIdFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(Codec
   (TxSubmission (GenTxId blk) (GenTx blk))
   CodecFailure
   m
   (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
 -&gt; Codec
      (TxSubmission (GenTxId blk) (GenTx blk))
      CodecError
      m
      (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk))))
-&gt; Codec
     (TxSubmission (GenTxId blk) (GenTx blk))
     CodecFailure
     m
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
-&gt; Codec
     (TxSubmission (GenTxId blk) (GenTx blk))
     CodecError
     m
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1083"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
-&gt; Codec
     (TxSubmission (GenTxId blk) (GenTx blk))
     CodecFailure
     m
     (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec (TxSubmission (GenTxId blk) (GenTx blk)) e m bTX
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cTxSubmissionCodec</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
forall (m :: * -&gt; *) blk.
Monad m =&gt;
Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.identityCodecs</span></a></span><span>
</span><span id="line-1084"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cTxSubmission2Codec :: Codec
  (TxSubmission2 (GenTxId blk) (GenTx blk))
  CodecError
  m
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cTxSubmission2Codec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1085"></span><span>            </span><span class="annot"><span class="annottext">(CodecFailure -&gt; CodecError)
-&gt; Codec
     (TxSubmission2 (GenTxId blk) (GenTx blk))
     CodecFailure
     m
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
-&gt; Codec
     (TxSubmission2 (GenTxId blk) (GenTx blk))
     CodecError
     m
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="annot"><span class="annottext">CodecFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecIdFailure"><span class="hs-identifier hs-var">CodecIdFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(Codec
   (TxSubmission2 (GenTxId blk) (GenTx blk))
   CodecFailure
   m
   (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
 -&gt; Codec
      (TxSubmission2 (GenTxId blk) (GenTx blk))
      CodecError
      m
      (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk))))
-&gt; Codec
     (TxSubmission2 (GenTxId blk) (GenTx blk))
     CodecFailure
     m
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
-&gt; Codec
     (TxSubmission2 (GenTxId blk) (GenTx blk))
     CodecError
     m
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1086"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
-&gt; Codec
     (TxSubmission2 (GenTxId blk) (GenTx blk))
     CodecFailure
     m
     (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec (TxSubmission2 (GenTxId blk) (GenTx blk)) e m bTX2
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cTxSubmission2Codec</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
forall (m :: * -&gt; *) blk.
Monad m =&gt;
Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.identityCodecs</span></a></span><span>
</span><span id="line-1087"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cKeepAliveCodec :: Codec KeepAlive CodecError m (AnyMessage KeepAlive)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">cKeepAliveCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1088"></span><span>            </span><span class="annot"><span class="annottext">(CodecFailure -&gt; CodecError)
-&gt; Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
-&gt; Codec KeepAlive CodecError m (AnyMessage KeepAlive)
forall (m :: * -&gt; *) failure failure' ps bytes.
Functor m =&gt;
(failure -&gt; failure')
-&gt; Codec ps failure m bytes -&gt; Codec ps failure' m bytes
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">mapFailureCodec</span></a></span><span> </span><span class="annot"><span class="annottext">CodecFailure -&gt; CodecError
</span><a href="Test.ThreadNet.Network.html#CodecIdFailure"><span class="hs-identifier hs-var">CodecIdFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
 -&gt; Codec KeepAlive CodecError m (AnyMessage KeepAlive))
-&gt; Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
-&gt; Codec KeepAlive CodecError m (AnyMessage KeepAlive)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1089"></span><span>              </span><span class="annot"><span class="annottext">Codecs
  Any
  CodecFailure
  m
  (AnyMessage (ChainSync (Header Any) (Point Any) (Tip Any)))
  (AnyMessage
     (ChainSync (SerialisedHeader Any) (Point Any) (Tip Any)))
  (AnyMessage (BlockFetch Any (Point Any)))
  (AnyMessage (BlockFetch (Serialised Any) (Point Any)))
  (AnyMessage (TxSubmission (GenTxId Any) (GenTx Any)))
  (AnyMessage (TxSubmission2 (GenTxId Any) (GenTx Any)))
  (AnyMessage KeepAlive)
-&gt; Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec KeepAlive e m bKA
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cKeepAliveCodec</span></a></span><span> </span><span class="annot"><span class="annottext">Codecs
  Any
  CodecFailure
  m
  (AnyMessage (ChainSync (Header Any) (Point Any) (Tip Any)))
  (AnyMessage
     (ChainSync (SerialisedHeader Any) (Point Any) (Tip Any)))
  (AnyMessage (BlockFetch Any (Point Any)))
  (AnyMessage (BlockFetch (Serialised Any) (Point Any)))
  (AnyMessage (TxSubmission (GenTxId Any) (GenTx Any)))
  (AnyMessage (TxSubmission2 (GenTxId Any) (GenTx Any)))
  (AnyMessage KeepAlive)
forall (m :: * -&gt; *) blk.
Monad m =&gt;
Codecs
  blk
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.identityCodecs</span></a></span><span>
</span><span id="line-1090"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1091"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1092"></span><span>        </span><span id="local-6989586621679261513"><span class="annot"><span class="annottext">binaryProtocolCodecs :: Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
</span><a href="#local-6989586621679261513"><span class="hs-identifier hs-var hs-var">binaryProtocolCodecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; BlockNodeToNodeVersion blk
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     DeserialiseFailure
     m
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
forall (m :: * -&gt; *) blk.
(IOLike m, SerialiseNodeToNodeConstraints blk,
 ShowProxy (GenTxId blk), ShowProxy (GenTx blk)) =&gt;
CodecConfig blk
-&gt; BlockNodeToNodeVersion blk
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     DeserialiseFailure
     m
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.defaultCodecs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; CodecConfig blk
forall blk. TopLevelConfig blk -&gt; CodecConfig blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">configCodec</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679261518"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679262011"><span class="hs-identifier hs-var">blockVersion</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679261517"><span class="hs-identifier hs-var">ntnVersion</span></a></span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span class="hs-comment">-- | Sum of 'CodecFailure' (from @identityCodecs@) and 'DeserialiseFailure'</span><span>
</span><span id="line-1095"></span><span class="hs-comment">-- (from @defaultCodecs@).</span><span>
</span><span id="line-1096"></span><span class="hs-keyword">data</span><span> </span><span id="CodecError"><span class="annot"><a href="Test.ThreadNet.Network.html#CodecError"><span class="hs-identifier hs-var">CodecError</span></a></span></span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CodecIdFailure"><span class="annot"><a href="Test.ThreadNet.Network.html#CodecIdFailure"><span class="hs-identifier hs-var">CodecIdFailure</span></a></span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">CodecFailure</span></a></span><span>
</span><span id="line-1098"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CodecBytesFailure"><span class="annot"><a href="Test.ThreadNet.Network.html#CodecBytesFailure"><span class="hs-identifier hs-var">CodecBytesFailure</span></a></span></span><span>
</span><span id="line-1099"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>  </span><span class="hs-comment">-- ^ Extra error message, e.g., the name of the codec</span><span>
</span><span id="line-1100"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">DeserialiseFailure</span></span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261498"><span id="local-6989586621679261500"><span id="local-6989586621679261502"><span class="annot"><span class="annottext">Int -&gt; CodecError -&gt; ShowS
[CodecError] -&gt; ShowS
CodecError -&gt; String
(Int -&gt; CodecError -&gt; ShowS)
-&gt; (CodecError -&gt; String)
-&gt; ([CodecError] -&gt; ShowS)
-&gt; Show CodecError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CodecError] -&gt; ShowS
$cshowList :: [CodecError] -&gt; ShowS
show :: CodecError -&gt; String
$cshow :: CodecError -&gt; String
showsPrec :: Int -&gt; CodecError -&gt; ShowS
$cshowsPrec :: Int -&gt; CodecError -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261490"><span id="local-6989586621679261492"><span id="local-6989586621679261494"><span class="annot"><span class="annottext">Show CodecError
Typeable CodecError
Typeable CodecError
-&gt; Show CodecError
-&gt; (CodecError -&gt; SomeException)
-&gt; (SomeException -&gt; Maybe CodecError)
-&gt; (CodecError -&gt; String)
-&gt; Exception CodecError
SomeException -&gt; Maybe CodecError
CodecError -&gt; String
CodecError -&gt; SomeException
forall e.
Typeable e
-&gt; Show e
-&gt; (e -&gt; SomeException)
-&gt; (SomeException -&gt; Maybe e)
-&gt; (e -&gt; String)
-&gt; Exception e
displayException :: CodecError -&gt; String
$cdisplayException :: CodecError -&gt; String
fromException :: SomeException -&gt; Maybe CodecError
$cfromException :: SomeException -&gt; Maybe CodecError
toException :: CodecError -&gt; SomeException
$ctoException :: CodecError -&gt; SomeException
$cp2Exception :: Show CodecError
$cp1Exception :: Typeable CodecError
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Exception</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1102"></span><span>
</span><span id="line-1103"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Running an edge
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1106"></span><span>
</span><span id="line-1107"></span><span class="hs-comment">-- | Cause for an edge to restart</span><span>
</span><span id="line-1108"></span><span class="hs-comment">--</span><span>
</span><span id="line-1109"></span><span class="hs-keyword">data</span><span> </span><span id="RestartCause"><span class="annot"><a href="Test.ThreadNet.Network.html#RestartCause"><span class="hs-identifier hs-var">RestartCause</span></a></span></span><span>
</span><span id="line-1110"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="RestartScheduled"><span class="annot"><a href="Test.ThreadNet.Network.html#RestartScheduled"><span class="hs-identifier hs-var">RestartScheduled</span></a></span></span><span>
</span><span id="line-1111"></span><span>    </span><span class="hs-comment">-- ^ restart because at least one of the two nodes set its status to</span><span>
</span><span id="line-1112"></span><span>    </span><span class="hs-comment">-- 'VFalling' because of a scheduled restart in 'tnaRestarts'</span><span>
</span><span id="line-1113"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RestartChainSyncTerminated"><span class="annot"><a href="Test.ThreadNet.Network.html#RestartChainSyncTerminated"><span class="hs-identifier hs-var">RestartChainSyncTerminated</span></a></span></span><span>
</span><span id="line-1114"></span><span>    </span><span class="hs-comment">-- ^ restart because the ChainSync client terminated the mini protocol</span><span>
</span><span id="line-1115"></span><span>
</span><span id="line-1116"></span><span class="hs-comment">-- | Fork two directed edges, one in each direction between the two vertices</span><span>
</span><span id="line-1117"></span><span class="hs-comment">--</span><span>
</span><span id="line-1118"></span><span id="local-6989586621679262853"><span id="local-6989586621679262854"><span class="annot"><a href="Test.ThreadNet.Network.html#forkBothEdges"><span class="hs-identifier hs-type">forkBothEdges</span></a></span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RunNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262853"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span>
</span><span id="line-1120"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1121"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1122"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockNodeToNodeVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262853"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1124"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262853"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262853"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262853"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1127"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatusVar"><span class="hs-identifier hs-type">EdgeStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262854"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1128"></span><span id="forkBothEdges"><span class="annot"><span class="annottext">forkBothEdges :: ResourceRegistry m
-&gt; OracularClock m
-&gt; Tracer m (SlotNo, MiniProtocolState)
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; Map CoreNodeId (VertexStatusVar m blk)
-&gt; (CoreNodeId, CoreNodeId)
-&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
</span><a href="Test.ThreadNet.Network.html#forkBothEdges"><span class="hs-identifier hs-var hs-var">forkBothEdges</span></a></span></span><span> </span><span id="local-6989586621679261486"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261486"><span class="hs-identifier hs-var">sharedRegistry</span></a></span></span><span> </span><span id="local-6989586621679261485"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261485"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span id="local-6989586621679261484"><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
</span><a href="#local-6989586621679261484"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679261483"><span class="annot"><span class="annottext">(NodeToNodeVersion, BlockNodeToNodeVersion blk)
</span><a href="#local-6989586621679261483"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679261482"><span class="annot"><span class="annottext">(CodecConfig blk, CalcMessageDelay blk)
</span><a href="#local-6989586621679261482"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679261481"><span class="annot"><span class="annottext">Map CoreNodeId (VertexStatusVar m blk)
</span><a href="#local-6989586621679261481"><span class="hs-identifier hs-var">vertexStatusVars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261480"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261480"><span class="hs-identifier hs-var">node1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261479"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261479"><span class="hs-identifier hs-var">node2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1129"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261478"><span class="annot"><span class="annottext">endpoint1 :: (CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261478"><span class="hs-identifier hs-var hs-var">endpoint1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; (CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261477"><span class="hs-identifier hs-var">mkEndpoint</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261480"><span class="hs-identifier hs-var">node1</span></a></span><span>
</span><span id="line-1130"></span><span>      </span><span id="local-6989586621679261476"><span class="annot"><span class="annottext">endpoint2 :: (CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261476"><span class="hs-identifier hs-var hs-var">endpoint2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; (CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261477"><span class="hs-identifier hs-var">mkEndpoint</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261479"><span class="hs-identifier hs-var">node2</span></a></span><span>
</span><span id="line-1131"></span><span>      </span><span id="local-6989586621679261477"><span class="annot"><span class="annottext">mkEndpoint :: CoreNodeId -&gt; (CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261477"><span class="hs-identifier hs-var hs-var">mkEndpoint</span></a></span></span><span> </span><span id="local-6989586621679261475"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261475"><span class="hs-identifier hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
-&gt; Map CoreNodeId (VertexStatusVar m blk)
-&gt; Maybe (VertexStatusVar m blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261475"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">Map CoreNodeId (VertexStatusVar m blk)
</span><a href="#local-6989586621679261481"><span class="hs-identifier hs-var">vertexStatusVars</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1132"></span><span>          </span><span class="annot"><span class="annottext">Maybe (VertexStatusVar m blk)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; (CoreNodeId, VertexStatusVar m blk)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; (CoreNodeId, VertexStatusVar m blk))
-&gt; String -&gt; (CoreNodeId, VertexStatusVar m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;node not found: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261475"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-1133"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679261474"><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261474"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261475"><span class="hs-identifier hs-var">node</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261474"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span>
</span><span id="line-1135"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261473"><span class="annot"><span class="annottext">mkDirEdge :: (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m ((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261473"><span class="hs-identifier hs-var hs-var">mkDirEdge</span></a></span></span><span> </span><span id="local-6989586621679261472"><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261472"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621679261471"><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261471"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1136"></span><span>        </span><span id="local-6989586621679261470"><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261470"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EdgeStatus -&gt; m (EdgeStatusVar m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">uncheckedNewTVarM</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatus
</span><a href="Test.ThreadNet.Network.html#EDown"><span class="hs-identifier hs-var">EDown</span></a></span><span>
</span><span id="line-1137"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261469"><span class="annot"><span class="annottext">label :: String
</span><a href="#local-6989586621679261469"><span class="hs-keyword hs-var hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span>
</span><span id="line-1138"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;directed-edge-&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Condense a =&gt; a -&gt; String
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">condense</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk) -&gt; CoreNodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261472"><span class="hs-identifier hs-var">e1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Condense a =&gt; a -&gt; String
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">condense</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk) -&gt; CoreNodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261471"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1139"></span><span>        </span><span class="annot"><span class="annottext">m (Thread m ()) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (Thread m ()) -&gt; m ()) -&gt; m (Thread m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m () -&gt; m (Thread m ())
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">forkLinkedThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261486"><span class="hs-identifier hs-var">sharedRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261469"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (Thread m ())) -&gt; m () -&gt; m (Thread m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1140"></span><span>          </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; Tracer m (SlotNo, MiniProtocolState)
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; OracularClock m
-&gt; EdgeStatusVar m
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, RunNode blk) =&gt;
ResourceRegistry m
-&gt; Tracer m (SlotNo, MiniProtocolState)
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; OracularClock m
-&gt; EdgeStatusVar m
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m ()
</span><a href="Test.ThreadNet.Network.html#directedEdge"><span class="hs-identifier hs-var">directedEdge</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261486"><span class="hs-identifier hs-var">sharedRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
</span><a href="#local-6989586621679261484"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">(NodeToNodeVersion, BlockNodeToNodeVersion blk)
</span><a href="#local-6989586621679261483"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">(CodecConfig blk, CalcMessageDelay blk)
</span><a href="#local-6989586621679261482"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261485"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261470"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261472"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261471"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-1141"></span><span>        </span><span class="annot"><span class="annottext">((CoreNodeId, CoreNodeId), EdgeStatusVar m)
-&gt; m ((CoreNodeId, CoreNodeId), EdgeStatusVar m)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk) -&gt; CoreNodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261472"><span class="hs-identifier hs-var">e1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk) -&gt; CoreNodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261471"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261470"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1142"></span><span>
</span><span id="line-1143"></span><span>  </span><span id="local-6989586621679261467"><span class="annot"><span class="annottext">((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261467"><span class="hs-identifier hs-var">ev12</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m ((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261473"><span class="hs-identifier hs-var">mkDirEdge</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261478"><span class="hs-identifier hs-var">endpoint1</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261476"><span class="hs-identifier hs-var">endpoint2</span></a></span><span>
</span><span id="line-1144"></span><span>  </span><span id="local-6989586621679261466"><span class="annot"><span class="annottext">((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261466"><span class="hs-identifier hs-var">ev21</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m ((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261473"><span class="hs-identifier hs-var">mkDirEdge</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261476"><span class="hs-identifier hs-var">endpoint2</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261478"><span class="hs-identifier hs-var">endpoint1</span></a></span><span>
</span><span id="line-1145"></span><span>
</span><span id="line-1146"></span><span>  </span><span class="annot"><span class="annottext">[((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
-&gt; m [((CoreNodeId, CoreNodeId), EdgeStatusVar m)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261467"><span class="hs-identifier hs-var">ev12</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((CoreNodeId, CoreNodeId), EdgeStatusVar m)
</span><a href="#local-6989586621679261466"><span class="hs-identifier hs-var">ev21</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1147"></span><span>
</span><span id="line-1148"></span><span class="hs-comment">-- | Spawn all mini protocols' threads for a given directed edge in the node</span><span>
</span><span id="line-1149"></span><span class="hs-comment">-- network topology (ie an ordered pair of core nodes, with client first and</span><span>
</span><span id="line-1150"></span><span class="hs-comment">-- server second)</span><span>
</span><span id="line-1151"></span><span class="hs-comment">--</span><span>
</span><span id="line-1152"></span><span class="hs-comment">-- The edge cannot start until both nodes are simultaneously 'VUp'.</span><span>
</span><span id="line-1153"></span><span class="hs-comment">--</span><span>
</span><span id="line-1154"></span><span class="hs-comment">-- The edge may restart itself for the reasons modeled by 'RestartCause'</span><span>
</span><span id="line-1155"></span><span class="hs-comment">--</span><span>
</span><span id="line-1156"></span><span class="hs-comment">-- The actual control flow here does not faithfully model the real</span><span>
</span><span id="line-1157"></span><span class="hs-comment">-- implementation. On an exception, for example, the actual node implementation</span><span>
</span><span id="line-1158"></span><span class="hs-comment">-- kills the other threads on the same peer as the thread that threw the</span><span>
</span><span id="line-1159"></span><span class="hs-comment">-- exception, and then relies on TCP socket semantics to eventually kill the</span><span>
</span><span id="line-1160"></span><span class="hs-comment">-- corresponding threads on the remote peer. The client node recreates its</span><span>
</span><span id="line-1161"></span><span class="hs-comment">-- client threads after a delay, and they reconnect to the remote peer, thereby</span><span>
</span><span id="line-1162"></span><span class="hs-comment">-- recreating the server threads.</span><span>
</span><span id="line-1163"></span><span class="hs-comment">--</span><span>
</span><span id="line-1164"></span><span class="hs-comment">-- This model instead propagates the exception to the rest of the /un/directed</span><span>
</span><span id="line-1165"></span><span class="hs-comment">-- edge via the @async@ interface rather than relying on some sort of mock</span><span>
</span><span id="line-1166"></span><span class="hs-comment">-- socket semantics to convey the cancellation.</span><span>
</span><span id="line-1167"></span><span class="annot"><a href="Test.ThreadNet.Network.html#directedEdge"><span class="hs-identifier hs-type">directedEdge</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1168"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262378"><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262377"><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RunNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1169"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1170"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolState"><span class="hs-identifier hs-type">MiniProtocolState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockNodeToNodeVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1172"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1173"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1174"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatusVar"><span class="hs-identifier hs-type">EdgeStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1175"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1176"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262377"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1177"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1178"></span><span id="directedEdge"><span class="annot"><span class="annottext">directedEdge :: ResourceRegistry m
-&gt; Tracer m (SlotNo, MiniProtocolState)
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; OracularClock m
-&gt; EdgeStatusVar m
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m ()
</span><a href="Test.ThreadNet.Network.html#directedEdge"><span class="hs-identifier hs-var hs-var">directedEdge</span></a></span></span><span> </span><span id="local-6989586621679261465"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261465"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679261464"><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
</span><a href="#local-6989586621679261464"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679261463"><span class="annot"><span class="annottext">(NodeToNodeVersion, BlockNodeToNodeVersion blk)
</span><a href="#local-6989586621679261463"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679261462"><span class="annot"><span class="annottext">(CodecConfig blk, CalcMessageDelay blk)
</span><a href="#local-6989586621679261462"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679261461"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261461"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span id="local-6989586621679261460"><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261460"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span></span><span> </span><span id="local-6989586621679261459"><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261459"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span id="local-6989586621679261458"><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261458"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1179"></span><span>    </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679261457"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-1180"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1181"></span><span>    </span><span id="local-6989586621679261457"><span class="annot"><span class="annottext">loop :: m ()
</span><a href="#local-6989586621679261457"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1182"></span><span>        </span><span id="local-6989586621679261456"><span class="annot"><span class="annottext">RestartCause
</span><a href="#local-6989586621679261456"><span class="hs-identifier hs-var">restart</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; OracularClock m
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; EdgeStatusVar m
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m RestartCause
forall (m :: * -&gt; *) blk.
(IOLike m, RunNode blk) =&gt;
ResourceRegistry m
-&gt; OracularClock m
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; EdgeStatusVar m
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m RestartCause
</span><a href="Test.ThreadNet.Network.html#directedEdgeInner"><span class="hs-identifier hs-var">directedEdgeInner</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261465"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261461"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">(NodeToNodeVersion, BlockNodeToNodeVersion blk)
</span><a href="#local-6989586621679261463"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">(CodecConfig blk, CalcMessageDelay blk)
</span><a href="#local-6989586621679261462"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261460"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261459"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261458"><span class="hs-identifier hs-var">server</span></a></span><span>
</span><span id="line-1183"></span><span>          </span><span class="annot"><span class="annottext">m RestartCause
-&gt; (SomeException -&gt; m RestartCause) -&gt; m RestartCause
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m RestartCause
forall a. SomeException -&gt; m a
</span><a href="#local-6989586621679261453"><span class="hs-identifier hs-var">hUnexpected</span></a></span><span>
</span><span id="line-1184"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m -&gt; EdgeStatus -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261460"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatus
</span><a href="Test.ThreadNet.Network.html#EDown"><span class="hs-identifier hs-var">EDown</span></a></span><span>
</span><span id="line-1185"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RestartCause
</span><a href="#local-6989586621679261456"><span class="hs-identifier hs-var">restart</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1186"></span><span>          </span><span class="annot"><span class="annottext">RestartCause
</span><a href="Test.ThreadNet.Network.html#RestartScheduled"><span class="hs-identifier hs-var">RestartScheduled</span></a></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1187"></span><span>          </span><span class="annot"><span class="annottext">RestartCause
</span><a href="Test.ThreadNet.Network.html#RestartChainSyncTerminated"><span class="hs-identifier hs-var">RestartChainSyncTerminated</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1188"></span><span>            </span><span class="hs-comment">-- &quot;error&quot; policy: restart at beginning of next slot</span><span>
</span><span id="line-1189"></span><span>            </span><span id="local-6989586621679261452"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261452"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; m SlotNo
forall (m :: * -&gt; *). OracularClock m -&gt; m SlotNo
</span><a href="Test.Util.HardFork.OracularClock.html#getCurrentSlot"><span class="hs-identifier hs-var hs-var">OracularClock.getCurrentSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261461"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-1190"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261451"><span class="annot"><span class="annottext">s' :: SlotNo
</span><a href="#local-6989586621679261451"><span class="hs-identifier hs-var hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261452"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1191"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
-&gt; (SlotNo, MiniProtocolState) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
</span><a href="#local-6989586621679261464"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261452"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MiniProtocolState
</span><a href="Test.ThreadNet.Network.html#MiniProtocolDelayed"><span class="hs-identifier hs-var">MiniProtocolDelayed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1192"></span><span>            </span><span class="annot"><span class="annottext">m Bool -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; m ()) -&gt; m Bool -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; SlotNo -&gt; m Bool
forall (m :: * -&gt; *). OracularClock m -&gt; SlotNo -&gt; m Bool
</span><a href="Test.Util.HardFork.OracularClock.html#blockUntilSlot"><span class="hs-identifier hs-var hs-var">OracularClock.blockUntilSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261461"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261451"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-1193"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
-&gt; (SlotNo, MiniProtocolState) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, MiniProtocolState)
</span><a href="#local-6989586621679261464"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261451"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MiniProtocolState
</span><a href="Test.ThreadNet.Network.html#MiniProtocolRestarting"><span class="hs-identifier hs-var">MiniProtocolRestarting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>        </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679261457"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-1195"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1196"></span><span>        </span><span class="hs-comment">-- Wrap synchronous exceptions in 'MiniProtocolFatalException'</span><span>
</span><span id="line-1197"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1198"></span><span>        </span><span class="annot"><a href="#local-6989586621679261453"><span class="hs-identifier hs-type">hUnexpected</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262367"><span class="annot"><a href="#local-6989586621679262367"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262367"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1199"></span><span>        </span><span id="local-6989586621679261453"><span class="annot"><span class="annottext">hUnexpected :: SomeException -&gt; m a
</span><a href="#local-6989586621679261453"><span class="hs-identifier hs-var hs-var">hUnexpected</span></a></span></span><span> </span><span id="local-6989586621679261448"><span class="annot"><span class="annottext">e :: SomeException
</span><a href="#local-6989586621679261448"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Exn.SomeException</span></span><span> </span><span id="local-6989586621679261446"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679261446"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679261448"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1200"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AsyncException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exn.AsyncException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679261448"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1201"></span><span>          </span><span class="annot"><span class="annottext">Maybe AsyncException
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeAsyncException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679261448"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1202"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeAsyncException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exn.SomeAsyncException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679261448"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1203"></span><span>            </span><span class="annot"><span class="annottext">Maybe SomeAsyncException
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MiniProtocolFatalException -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">MiniProtocolFatalException :: TypeRep
-&gt; SomeException
-&gt; CoreNodeId
-&gt; CoreNodeId
-&gt; MiniProtocolFatalException
</span><a href="Test.ThreadNet.Network.html#MiniProtocolFatalException"><span class="hs-identifier hs-type">MiniProtocolFatalException</span></a></span><span>
</span><span id="line-1204"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mpfeType :: TypeRep
</span><a href="Test.ThreadNet.Network.html#mpfeType"><span class="hs-identifier hs-var">mpfeType</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">e -&gt; TypeRep
forall a. Typeable a =&gt; a -&gt; TypeRep
</span><span class="hs-identifier hs-var">Typeable.typeOf</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679261446"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-1205"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpfeExn :: SomeException
</span><a href="Test.ThreadNet.Network.html#mpfeExn"><span class="hs-identifier hs-var">mpfeExn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679261448"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1206"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpfeClient :: CoreNodeId
</span><a href="Test.ThreadNet.Network.html#mpfeClient"><span class="hs-identifier hs-var">mpfeClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk) -&gt; CoreNodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261459"><span class="hs-identifier hs-var">client</span></a></span><span>
</span><span id="line-1207"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpfeServer :: CoreNodeId
</span><a href="Test.ThreadNet.Network.html#mpfeServer"><span class="hs-identifier hs-var">mpfeServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk) -&gt; CoreNodeId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, VertexStatusVar m blk)
</span><a href="#local-6989586621679261458"><span class="hs-identifier hs-var">server</span></a></span><span>
</span><span id="line-1208"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-1209"></span><span>
</span><span id="line-1210"></span><span class="hs-comment">-- | Spawn threads for all of the mini protocols</span><span>
</span><span id="line-1211"></span><span class="hs-comment">--</span><span>
</span><span id="line-1212"></span><span class="hs-comment">-- See 'directedEdge'.</span><span>
</span><span id="line-1213"></span><span class="annot"><a href="Test.ThreadNet.Network.html#directedEdgeInner"><span class="hs-identifier hs-type">directedEdgeInner</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1214"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262373"><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262372"><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RunNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1215"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1216"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.Util.HardFork.OracularClock.html#OracularClock"><span class="hs-identifier hs-type">OracularClock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1217"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">BlockNodeToNodeVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1218"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1219"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#EdgeStatusVar"><span class="hs-identifier hs-type">EdgeStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1220"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1221"></span><span>     </span><span class="hs-comment">-- ^ client threads on this node</span><span>
</span><span id="line-1222"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1223"></span><span>     </span><span class="hs-comment">-- ^ server threads on this node</span><span>
</span><span id="line-1224"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#RestartCause"><span class="hs-identifier hs-type">RestartCause</span></a></span><span>
</span><span id="line-1225"></span><span id="directedEdgeInner"><span class="annot"><span class="annottext">directedEdgeInner :: ResourceRegistry m
-&gt; OracularClock m
-&gt; (NodeToNodeVersion, BlockNodeToNodeVersion blk)
-&gt; (CodecConfig blk, CalcMessageDelay blk)
-&gt; EdgeStatusVar m
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; (CoreNodeId, VertexStatusVar m blk)
-&gt; m RestartCause
</span><a href="Test.ThreadNet.Network.html#directedEdgeInner"><span class="hs-identifier hs-var hs-var">directedEdgeInner</span></a></span></span><span> </span><span id="local-6989586621679261437"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261437"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679261436"><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261436"><span class="hs-identifier hs-var">clock</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261435"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679261435"><span class="hs-identifier hs-var">version</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261434"><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679261434"><span class="hs-identifier hs-var">blockVersion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261433"><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679261433"><span class="hs-identifier hs-var">cfg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261432"><span class="annot"><span class="annottext">CalcMessageDelay blk
</span><a href="#local-6989586621679261432"><span class="hs-identifier hs-var">calcMessageDelay</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679261431"><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261431"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span></span><span>
</span><span id="line-1226"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679261430"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261430"><span class="hs-identifier hs-var">node1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261429"><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261429"><span class="hs-identifier hs-var">vertexStatusVar1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261428"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261428"><span class="hs-identifier hs-var">node2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261427"><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261427"><span class="hs-identifier hs-var">vertexStatusVar2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1227"></span><span>    </span><span class="hs-comment">-- block until both nodes are 'VUp'</span><span>
</span><span id="line-1228"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-type">LimitedApp</span></a></span><span> </span><span id="local-6989586621679261426"><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
</span><a href="#local-6989586621679261426"><span class="hs-identifier hs-var">app1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-type">LimitedApp</span></a></span><span> </span><span id="local-6989586621679261425"><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
</span><a href="#local-6989586621679261425"><span class="hs-identifier hs-var">app2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (LimitedApp m NodeId blk, LimitedApp m NodeId blk)
-&gt; m (LimitedApp m NodeId blk, LimitedApp m NodeId blk)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (LimitedApp m NodeId blk, LimitedApp m NodeId blk)
 -&gt; m (LimitedApp m NodeId blk, LimitedApp m NodeId blk))
-&gt; STM m (LimitedApp m NodeId blk, LimitedApp m NodeId blk)
-&gt; m (LimitedApp m NodeId blk, LimitedApp m NodeId blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1229"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LimitedApp m NodeId blk
 -&gt; LimitedApp m NodeId blk
 -&gt; (LimitedApp m NodeId blk, LimitedApp m NodeId blk))
-&gt; STM m (LimitedApp m NodeId blk)
-&gt; STM
     m
     (LimitedApp m NodeId blk
      -&gt; (LimitedApp m NodeId blk, LimitedApp m NodeId blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk -&gt; STM m (LimitedApp m NodeId blk)
forall (m :: * -&gt; *) (m :: * -&gt; *) blk.
MonadSTM m =&gt;
StrictTVar m (VertexStatus m blk)
-&gt; STM m (LimitedApp m NodeId blk)
</span><a href="#local-6989586621679261424"><span class="hs-identifier hs-var">getApp</span></a></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261429"><span class="hs-identifier hs-var">vertexStatusVar1</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (LimitedApp m NodeId blk
   -&gt; (LimitedApp m NodeId blk, LimitedApp m NodeId blk))
-&gt; STM m (LimitedApp m NodeId blk)
-&gt; STM m (LimitedApp m NodeId blk, LimitedApp m NodeId blk)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk -&gt; STM m (LimitedApp m NodeId blk)
forall (m :: * -&gt; *) (m :: * -&gt; *) blk.
MonadSTM m =&gt;
StrictTVar m (VertexStatus m blk)
-&gt; STM m (LimitedApp m NodeId blk)
</span><a href="#local-6989586621679261424"><span class="hs-identifier hs-var">getApp</span></a></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261427"><span class="hs-identifier hs-var">vertexStatusVar2</span></a></span><span>
</span><span id="line-1230"></span><span>
</span><span id="line-1231"></span><span>    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m -&gt; EdgeStatus -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatusVar m
</span><a href="#local-6989586621679261431"><span class="hs-identifier hs-var">edgeStatusVar</span></a></span><span> </span><span class="annot"><span class="annottext">EdgeStatus
</span><a href="Test.ThreadNet.Network.html#EUp"><span class="hs-identifier hs-var">EUp</span></a></span><span>
</span><span id="line-1232"></span><span>
</span><span id="line-1233"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679262333"><span id="local-6989586621679262334"><span id="local-6989586621679262335"><span class="annot"><a href="#local-6989586621679261423"><span class="hs-identifier hs-type">miniProtocol</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1234"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1235"></span><span>             </span><span class="hs-comment">-- ^ protocol name</span><span>
</span><span id="line-1236"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262335"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#RestartCause"><span class="hs-identifier hs-type">RestartCause</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1237"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span>  </span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp%27"><span class="hs-identifier hs-type">LimitedApp'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1238"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span>
</span><span id="line-1239"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">ControlMessageSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1240"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span>
</span><span id="line-1241"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">Channel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262334"><span class="hs-identifier hs-type">msg</span></a></span><span>
</span><span id="line-1242"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262335"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679262333"><span class="hs-identifier hs-type">trailingBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1243"></span><span>             </span><span class="hs-special">)</span><span>
</span><span id="line-1244"></span><span>            </span><span class="hs-comment">-- ^ client action to run on node1</span><span>
</span><span id="line-1245"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span>  </span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp%27"><span class="hs-identifier hs-type">LimitedApp'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1246"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span>
</span><span id="line-1247"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span>
</span><span id="line-1248"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">Channel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262334"><span class="hs-identifier hs-type">msg</span></a></span><span>
</span><span id="line-1249"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262335"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679262333"><span class="hs-identifier hs-type">trailingBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1250"></span><span>             </span><span class="hs-special">)</span><span>
</span><span id="line-1251"></span><span>             </span><span class="hs-comment">-- ^ server action to run on node2</span><span>
</span><span id="line-1252"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262334"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1253"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#RestartCause"><span class="hs-identifier hs-type">RestartCause</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#RestartCause"><span class="hs-identifier hs-type">RestartCause</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1254"></span><span>        </span><span id="local-6989586621679261423"><span class="annot"><span class="annottext">miniProtocol :: String
-&gt; (String -&gt; a -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (msg -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
</span><a href="#local-6989586621679261423"><span class="hs-identifier hs-var hs-var">miniProtocol</span></a></span></span><span> </span><span id="local-6989586621679261422"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261422"><span class="hs-identifier hs-var">proto</span></a></span></span><span> </span><span id="local-6989586621679261421"><span class="annot"><span class="annottext">String -&gt; a -&gt; RestartCause
</span><a href="#local-6989586621679261421"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621679261420"><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; NodeId
-&gt; Channel m msg
-&gt; m (a, trailingBytes)
</span><a href="#local-6989586621679261420"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span id="local-6989586621679261419"><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; NodeId
-&gt; Channel m msg
-&gt; m (a, trailingBytes)
</span><a href="#local-6989586621679261419"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span id="local-6989586621679261418"><span class="annot"><span class="annottext">msg -&gt; m ()
</span><a href="#local-6989586621679261418"><span class="hs-identifier hs-var">middle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1255"></span><span>           </span><span class="hs-special">(</span><span id="local-6989586621679261417"><span class="annot"><span class="annottext">Channel m msg
</span><a href="#local-6989586621679261417"><span class="hs-identifier hs-var">chan</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261416"><span class="annot"><span class="annottext">Channel m msg
</span><a href="#local-6989586621679261416"><span class="hs-identifier hs-var">dualChan</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1256"></span><span>             </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (CoreNodeId, CoreNodeId, String)
-&gt; (msg -&gt; m ())
-&gt; m (Channel m msg, Channel m msg)
forall (m :: * -&gt; *) a.
IOLike m =&gt;
ResourceRegistry m
-&gt; (CoreNodeId, CoreNodeId, String)
-&gt; (a -&gt; m ())
-&gt; m (Channel m a, Channel m a)
</span><a href="Test.ThreadNet.Network.html#createConnectedChannelsWithDelay"><span class="hs-identifier hs-var">createConnectedChannelsWithDelay</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261437"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261430"><span class="hs-identifier hs-var">node1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261428"><span class="hs-identifier hs-var">node2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261422"><span class="hs-identifier hs-var">proto</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">msg -&gt; m ()
</span><a href="#local-6989586621679261418"><span class="hs-identifier hs-var">middle</span></a></span><span>
</span><span id="line-1257"></span><span>           </span><span class="annot"><span class="annottext">(m RestartCause, m RestartCause)
-&gt; m (m RestartCause, m RestartCause)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1258"></span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; a -&gt; RestartCause
</span><a href="#local-6989586621679261421"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261422"><span class="hs-identifier hs-var">proto</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.client&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; RestartCause)
-&gt; ((a, trailingBytes) -&gt; a) -&gt; (a, trailingBytes) -&gt; RestartCause
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a, trailingBytes) -&gt; a
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((a, trailingBytes) -&gt; RestartCause)
-&gt; m (a, trailingBytes) -&gt; m RestartCause
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; NodeId
-&gt; Channel m msg
-&gt; m (a, trailingBytes)
</span><a href="#local-6989586621679261420"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
</span><a href="#local-6989586621679261426"><span class="hs-identifier hs-var">app1</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679261435"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ControlMessage -&gt; ControlMessageSTM m
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ControlMessage
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">Continue</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId -&gt; NodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">fromCoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261428"><span class="hs-identifier hs-var">node2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Channel m msg
</span><a href="#local-6989586621679261417"><span class="hs-identifier hs-var">chan</span></a></span><span>
</span><span id="line-1259"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; a -&gt; RestartCause
</span><a href="#local-6989586621679261421"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261422"><span class="hs-identifier hs-var">proto</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.server&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; RestartCause)
-&gt; ((a, trailingBytes) -&gt; a) -&gt; (a, trailingBytes) -&gt; RestartCause
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a, trailingBytes) -&gt; a
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((a, trailingBytes) -&gt; RestartCause)
-&gt; m (a, trailingBytes) -&gt; m RestartCause
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; NodeId
-&gt; Channel m msg
-&gt; m (a, trailingBytes)
</span><a href="#local-6989586621679261419"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
</span><a href="#local-6989586621679261425"><span class="hs-identifier hs-var">app2</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679261435"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId -&gt; NodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">fromCoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261430"><span class="hs-identifier hs-var">node1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Channel m msg
</span><a href="#local-6989586621679261416"><span class="hs-identifier hs-var">dualChan</span></a></span><span>
</span><span id="line-1260"></span><span>             </span><span class="hs-special">)</span><span>
</span><span id="line-1261"></span><span>
</span><span id="line-1262"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (NonEmpty (m RestartCause))
-&gt; (NonEmpty (m RestartCause) -&gt; m RestartCause) -&gt; m RestartCause
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (m RestartCause) -&gt; m RestartCause
forall (m :: * -&gt; *) a. IOLike m =&gt; NonEmpty (m a) -&gt; m a
</span><a href="Test.ThreadNet.Network.html#withAsyncsWaitAny"><span class="hs-identifier hs-var">withAsyncsWaitAny</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (NonEmpty (m RestartCause)) -&gt; m RestartCause)
-&gt; m (NonEmpty (m RestartCause)) -&gt; m RestartCause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1263"></span><span>      </span><span class="annot"><span class="annottext">(NonEmpty (m RestartCause, m RestartCause)
 -&gt; NonEmpty (m RestartCause))
-&gt; m (NonEmpty (m RestartCause, m RestartCause))
-&gt; m (NonEmpty (m RestartCause))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (m RestartCause, m RestartCause)
-&gt; NonEmpty (m RestartCause)
forall a. NonEmpty (a, a) -&gt; NonEmpty a
</span><a href="#local-6989586621679261411"><span class="hs-identifier hs-var">flattenPairs</span></a></span><span> </span><span class="annot"><span class="annottext">(m (NonEmpty (m RestartCause, m RestartCause))
 -&gt; m (NonEmpty (m RestartCause)))
-&gt; m (NonEmpty (m RestartCause, m RestartCause))
-&gt; m (NonEmpty (m RestartCause))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1264"></span><span>      </span><span class="annot"><span class="annottext">NonEmpty (m (m RestartCause, m RestartCause))
-&gt; m (NonEmpty (m RestartCause, m RestartCause))
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (m (m RestartCause, m RestartCause))
 -&gt; m (NonEmpty (m RestartCause, m RestartCause)))
-&gt; NonEmpty (m (m RestartCause, m RestartCause))
-&gt; m (NonEmpty (m RestartCause, m RestartCause))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1265"></span><span>        </span><span class="annot"><span class="annottext">(m RestartCause, m RestartCause)
-&gt; m (m RestartCause, m RestartCause)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VertexStatusVar m blk -&gt; m RestartCause
</span><a href="#local-6989586621679261410"><span class="hs-identifier hs-var">watcher</span></a></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261429"><span class="hs-identifier hs-var">vertexStatusVar1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk -&gt; m RestartCause
</span><a href="#local-6989586621679261410"><span class="hs-identifier hs-var">watcher</span></a></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261427"><span class="hs-identifier hs-var">vertexStatusVar2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1266"></span><span>        </span><span class="annot"><span class="annottext">m (m RestartCause, m RestartCause)
-&gt; [m (m RestartCause, m RestartCause)]
-&gt; NonEmpty (m (m RestartCause, m RestartCause))
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">NE.:|</span></span><span>
</span><span id="line-1267"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (String -&gt; () -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m ByteString
    -&gt; m ((), Maybe ByteString))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m ByteString
    -&gt; m ((), Maybe ByteString))
-&gt; (ByteString -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
forall a msg trailingBytes.
String
-&gt; (String -&gt; a -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (msg -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
</span><a href="#local-6989586621679261423"><span class="hs-identifier hs-var">miniProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSync&quot;</span></span><span>
</span><span id="line-1268"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679261408"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261408"><span class="hs-identifier hs-var">_s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RestartCause
</span><a href="Test.ThreadNet.Network.html#RestartChainSyncTerminated"><span class="hs-identifier hs-var">RestartChainSyncTerminated</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1269"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; NodeId
-&gt; Channel m ByteString
-&gt; m ((), Maybe ByteString)
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ClientApp m peer bCS a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aChainSyncClient</span></a></span><span>
</span><span id="line-1270"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; NodeId
-&gt; Channel m ByteString
-&gt; m ((), Maybe ByteString)
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ServerApp m peer bCS a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aChainSyncServer</span></a></span><span>
</span><span id="line-1271"></span><span>          </span><span class="annot"><span class="annottext">ByteString -&gt; m ()
</span><a href="#local-6989586621679261405"><span class="hs-identifier hs-var">chainSyncMiddle</span></a></span><span>
</span><span id="line-1272"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (String -&gt; () -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m ByteString
    -&gt; m ((), Maybe ByteString))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m ByteString
    -&gt; m ((), Maybe ByteString))
-&gt; (ByteString -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
forall a msg trailingBytes.
String
-&gt; (String -&gt; a -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (msg -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
</span><a href="#local-6989586621679261423"><span class="hs-identifier hs-var">miniProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BlockFetch&quot;</span></span><span>
</span><span id="line-1273"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; () -&gt; RestartCause
forall void. String -&gt; () -&gt; void
</span><a href="#local-6989586621679261404"><span class="hs-identifier hs-var">neverReturns</span></a></span><span>
</span><span id="line-1274"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; NodeId
-&gt; Channel m ByteString
-&gt; m ((), Maybe ByteString)
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ClientApp m peer bBF a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aBlockFetchClient</span></a></span><span>
</span><span id="line-1275"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; NodeId
-&gt; Channel m ByteString
-&gt; m ((), Maybe ByteString)
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ServerApp m peer bBF a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aBlockFetchServer</span></a></span><span>
</span><span id="line-1276"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1277"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (String -&gt; () -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
    -&gt; m ((),
          Maybe (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
    -&gt; m ((),
          Maybe (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))))
-&gt; (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)) -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
forall a msg trailingBytes.
String
-&gt; (String -&gt; a -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (msg -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
</span><a href="#local-6989586621679261423"><span class="hs-identifier hs-var">miniProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TxSubmission&quot;</span></span><span>
</span><span id="line-1278"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; () -&gt; RestartCause
forall void. String -&gt; () -&gt; void
</span><a href="#local-6989586621679261404"><span class="hs-identifier hs-var">neverReturns</span></a></span><span>
</span><span id="line-1279"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; NodeId
-&gt; Channel m (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
-&gt; m ((),
      Maybe (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk))))
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ClientApp m peer bTX a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aTxSubmissionClient</span></a></span><span>
</span><span id="line-1280"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; NodeId
-&gt; Channel m (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk)))
-&gt; m ((),
      Maybe (AnyMessage (TxSubmission (GenTxId blk) (GenTx blk))))
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ServerApp m peer bTX a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aTxSubmissionServer</span></a></span><span>
</span><span id="line-1281"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">AnyMessage (TxSubmission (GenTxId blk) (GenTx blk))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1282"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (String -&gt; () -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m (AnyMessage KeepAlive)
    -&gt; m ((), Maybe (AnyMessage KeepAlive)))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m (AnyMessage KeepAlive)
    -&gt; m ((), Maybe (AnyMessage KeepAlive)))
-&gt; (AnyMessage KeepAlive -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
forall a msg trailingBytes.
String
-&gt; (String -&gt; a -&gt; RestartCause)
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; ControlMessageSTM m
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (LimitedApp' m NodeId blk
    -&gt; NodeToNodeVersion
    -&gt; NodeId
    -&gt; Channel m msg
    -&gt; m (a, trailingBytes))
-&gt; (msg -&gt; m ())
-&gt; m (m RestartCause, m RestartCause)
</span><a href="#local-6989586621679261423"><span class="hs-identifier hs-var">miniProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;KeepAlive&quot;</span></span><span>
</span><span id="line-1283"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; () -&gt; RestartCause
forall void. String -&gt; () -&gt; void
</span><a href="#local-6989586621679261404"><span class="hs-identifier hs-var">neverReturns</span></a></span><span>
</span><span id="line-1284"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; NodeId
-&gt; Channel m (AnyMessage KeepAlive)
-&gt; m ((), Maybe (AnyMessage KeepAlive))
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ClientApp m peer bKA a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aKeepAliveClient</span></a></span><span>
</span><span id="line-1285"></span><span>          </span><span class="annot"><span class="annottext">LimitedApp' m NodeId blk
-&gt; NodeToNodeVersion
-&gt; NodeId
-&gt; Channel m (AnyMessage KeepAlive)
-&gt; m ((), Maybe (AnyMessage KeepAlive))
forall (m :: * -&gt; *) peer bCS bBF bTX bTX2 bKA a.
Apps m peer bCS bBF bTX bTX2 bKA a -&gt; ServerApp m peer bKA a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.aKeepAliveServer</span></a></span><span>
</span><span id="line-1286"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">AnyMessage KeepAlive
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1287"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1289"></span><span>    </span><span id="local-6989586621679261424"><span class="annot"><span class="annottext">getApp :: StrictTVar m (VertexStatus m blk)
-&gt; STM m (LimitedApp m NodeId blk)
</span><a href="#local-6989586621679261424"><span class="hs-identifier hs-var hs-var">getApp</span></a></span></span><span> </span><span id="local-6989586621679261397"><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261397"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk) -&gt; STM m (VertexStatus m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (VertexStatus m blk)
</span><a href="#local-6989586621679261397"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (VertexStatus m blk)
-&gt; (VertexStatus m blk -&gt; STM m (LimitedApp m NodeId blk))
-&gt; STM m (LimitedApp m NodeId blk)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1290"></span><span>      </span><span class="annot"><a href="Test.ThreadNet.Network.html#VUp"><span class="hs-identifier hs-type">VUp</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m NodeId Void blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679261396"><span class="annot"><span class="annottext">LimitedApp m NodeId blk
</span><a href="#local-6989586621679261396"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LimitedApp m NodeId blk -&gt; STM m (LimitedApp m NodeId blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">LimitedApp m NodeId blk
</span><a href="#local-6989586621679261396"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-1291"></span><span>      </span><span class="annot"><span class="annottext">VertexStatus m blk
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m (LimitedApp m NodeId blk)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-1292"></span><span>
</span><span id="line-1293"></span><span>    </span><span class="annot"><a href="#local-6989586621679261411"><span class="hs-identifier hs-type">flattenPairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262337"><span class="annot"><a href="#local-6989586621679262337"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NE.NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262337"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679262337"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NE.NonEmpty</span></span><span> </span><span class="annot"><a href="#local-6989586621679262337"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1294"></span><span>    </span><span id="local-6989586621679261411"><span class="annot"><span class="annottext">flattenPairs :: NonEmpty (a, a) -&gt; NonEmpty a
</span><a href="#local-6989586621679261411"><span class="hs-identifier hs-var hs-var">flattenPairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NonEmpty a -&gt; NonEmpty a -&gt; NonEmpty a)
-&gt; (NonEmpty a, NonEmpty a) -&gt; NonEmpty a
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty a -&gt; NonEmpty a -&gt; NonEmpty a
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(&lt;&gt;)</span></span><span> </span><span class="annot"><span class="annottext">((NonEmpty a, NonEmpty a) -&gt; NonEmpty a)
-&gt; (NonEmpty (a, a) -&gt; (NonEmpty a, NonEmpty a))
-&gt; NonEmpty (a, a)
-&gt; NonEmpty a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (a, a) -&gt; (NonEmpty a, NonEmpty a)
forall (f :: * -&gt; *) a b. Functor f =&gt; f (a, b) -&gt; (f a, f b)
</span><span class="hs-identifier hs-var">NE.unzip</span></span><span>
</span><span id="line-1295"></span><span>
</span><span id="line-1296"></span><span>    </span><span id="local-6989586621679262314"><span class="annot"><a href="#local-6989586621679261404"><span class="hs-identifier hs-type">neverReturns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262314"><span class="hs-identifier hs-type">void</span></a></span></span><span>
</span><span id="line-1297"></span><span>    </span><span id="local-6989586621679261404"><span class="annot"><span class="annottext">neverReturns :: String -&gt; () -&gt; void
</span><a href="#local-6989586621679261404"><span class="hs-identifier hs-var hs-var">neverReturns</span></a></span></span><span> </span><span id="local-6989586621679261393"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261393"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; void
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; void) -&gt; String -&gt; void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261393"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; never returns!&quot;</span></span><span>
</span><span id="line-1298"></span><span>
</span><span id="line-1299"></span><span>    </span><span class="hs-comment">-- terminates (by returning, not via exception) when the vertex starts</span><span>
</span><span id="line-1300"></span><span>    </span><span class="hs-comment">-- 'VFalling'</span><span>
</span><span id="line-1301"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1302"></span><span>    </span><span class="hs-comment">-- because of 'withAsyncsWaitAny' used above, this brings down the whole</span><span>
</span><span id="line-1303"></span><span>    </span><span class="hs-comment">-- edge</span><span>
</span><span id="line-1304"></span><span>    </span><span class="annot"><a href="#local-6989586621679261410"><span class="hs-identifier hs-type">watcher</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#VertexStatusVar"><span class="hs-identifier hs-type">VertexStatusVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262372"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#RestartCause"><span class="hs-identifier hs-type">RestartCause</span></a></span><span>
</span><span id="line-1305"></span><span>    </span><span id="local-6989586621679261410"><span class="annot"><span class="annottext">watcher :: VertexStatusVar m blk -&gt; m RestartCause
</span><a href="#local-6989586621679261410"><span class="hs-identifier hs-var hs-var">watcher</span></a></span></span><span> </span><span id="local-6989586621679261392"><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261392"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1306"></span><span>        </span><span class="annot"><span class="annottext">STM m RestartCause -&gt; m RestartCause
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m RestartCause -&gt; m RestartCause)
-&gt; STM m RestartCause -&gt; m RestartCause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk -&gt; STM m (VertexStatus m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">VertexStatusVar m blk
</span><a href="#local-6989586621679261392"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (VertexStatus m blk)
-&gt; (VertexStatus m blk -&gt; STM m RestartCause) -&gt; STM m RestartCause
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1307"></span><span>          </span><span class="annot"><span class="annottext">VertexStatus m blk
</span><a href="Test.ThreadNet.Network.html#VFalling"><span class="hs-identifier hs-var">VFalling</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RestartCause -&gt; STM m RestartCause
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RestartCause
</span><a href="Test.ThreadNet.Network.html#RestartScheduled"><span class="hs-identifier hs-var">RestartScheduled</span></a></span><span>
</span><span id="line-1308"></span><span>          </span><span class="annot"><span class="annottext">VertexStatus m blk
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m RestartCause
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-1309"></span><span>
</span><span id="line-1310"></span><span>    </span><span class="hs-comment">-- introduce a delay for 'CS.MsgRollForward'</span><span>
</span><span id="line-1311"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1312"></span><span>    </span><span class="hs-comment">-- It is reasonable to delay only this message because this message is the</span><span>
</span><span id="line-1313"></span><span>    </span><span class="hs-comment">-- first step in process of one node diffusing a block to another node.</span><span>
</span><span id="line-1314"></span><span>    </span><span class="annot"><a href="#local-6989586621679261405"><span class="hs-identifier hs-type">chainSyncMiddle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262373"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1315"></span><span>    </span><span id="local-6989586621679261405"><span class="annot"><span class="annottext">chainSyncMiddle :: ByteString -&gt; m ()
</span><a href="#local-6989586621679261405"><span class="hs-identifier hs-var hs-var">chainSyncMiddle</span></a></span></span><span> </span><span id="local-6989586621679261391"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679261391"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1316"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261390"><span class="annot"><span class="annottext">tok :: PeerHasAgency 'AsServer ('StNext 'StMustReply)
</span><a href="#local-6989586621679261390"><span class="hs-identifier hs-var hs-var">tok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerHasAgency ('StNext 'StMustReply)
-&gt; PeerHasAgency 'AsServer ('StNext 'StMustReply)
forall ps (st :: ps).
ServerHasAgency st -&gt; PeerHasAgency 'AsServer st
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Codec.ServerAgency</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerHasAgency ('StNext 'StMustReply)
 -&gt; PeerHasAgency 'AsServer ('StNext 'StMustReply))
-&gt; ServerHasAgency ('StNext 'StMustReply)
-&gt; PeerHasAgency 'AsServer ('StNext 'StMustReply)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TokNextKind 'StMustReply -&gt; ServerHasAgency ('StNext 'StMustReply)
forall k k1 k2 (header :: k) (point :: k1) (tip :: k2)
       (k3 :: StNextKind).
TokNextKind k3 -&gt; ServerHasAgency ('StNext k3)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">CS.TokNext</span></a></span><span> </span><span class="annot"><span class="annottext">TokNextKind 'StMustReply
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">CS.TokMustReply</span></a></span><span>
</span><span id="line-1317"></span><span>        </span><span id="local-6989586621679261386"><span class="annot"><span class="annottext">DecodeStep
  ByteString
  DeserialiseFailure
  m
  (SomeMessage ('StNext 'StMustReply))
</span><a href="#local-6989586621679261386"><span class="hs-identifier hs-var">decodeStep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  DeserialiseFailure
  m
  ByteString
-&gt; PeerHasAgency 'AsServer ('StNext 'StMustReply)
-&gt; m (DecodeStep
        ByteString
        DeserialiseFailure
        m
        (SomeMessage ('StNext 'StMustReply)))
forall ps failure (m :: * -&gt; *) bytes.
Codec ps failure m bytes
-&gt; forall (pr :: PeerRole) (st :: ps).
   PeerHasAgency pr st
   -&gt; m (DecodeStep bytes failure m (SomeMessage st))
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var hs-var">Codec.decode</span></a></span><span> </span><span class="annot"><span class="annottext">Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  DeserialiseFailure
  m
  ByteString
</span><a href="#local-6989586621679261384"><span class="hs-identifier hs-var">codec</span></a></span><span> </span><span class="annot"><span class="annottext">PeerHasAgency 'AsServer ('StNext 'StMustReply)
forall header point tip.
PeerHasAgency 'AsServer ('StNext 'StMustReply)
</span><a href="#local-6989586621679261390"><span class="hs-identifier hs-var">tok</span></a></span><span>
</span><span id="line-1318"></span><span>        </span><span class="annot"><span class="annottext">[ByteString]
-&gt; DecodeStep
     ByteString
     DeserialiseFailure
     m
     (SomeMessage ('StNext 'StMustReply))
-&gt; m (Either
        DeserialiseFailure (SomeMessage ('StNext 'StMustReply)))
forall (m :: * -&gt; *) bytes failure a.
Monad m =&gt;
[bytes] -&gt; DecodeStep bytes failure m a -&gt; m (Either failure a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-var">Codec.runDecoder</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679261391"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">DecodeStep
  ByteString
  DeserialiseFailure
  m
  (SomeMessage ('StNext 'StMustReply))
</span><a href="#local-6989586621679261386"><span class="hs-identifier hs-var">decodeStep</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either DeserialiseFailure (SomeMessage ('StNext 'StMustReply)))
-&gt; (Either DeserialiseFailure (SomeMessage ('StNext 'StMustReply))
    -&gt; m ())
-&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1319"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Codec.SomeMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">CS.MsgRollForward</span></a></span><span> </span><span id="local-6989586621679261380"><span class="annot"><a href="#local-6989586621679261380"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621679261379"><span class="annot"><a href="#local-6989586621679261379"><span class="hs-identifier hs-var">_tip</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1320"></span><span>              </span><span id="local-6989586621679261378"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261378"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; m SlotNo
forall (m :: * -&gt; *). OracularClock m -&gt; m SlotNo
</span><a href="Test.Util.HardFork.OracularClock.html#getCurrentSlot"><span class="hs-identifier hs-var hs-var">OracularClock.getCurrentSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261436"><span class="hs-identifier hs-var">clock</span></a></span><span>
</span><span id="line-1321"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Test.Util.Slots.html#NumSlots"><span class="hs-identifier hs-type">NumSlots</span></a></span><span> </span><span id="local-6989586621679261377"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261377"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId) -&gt; SlotNo -&gt; Header blk -&gt; NumSlots
</span><a href="#local-6989586621679261376"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261430"><span class="hs-identifier hs-var">node1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261428"><span class="hs-identifier hs-var">node2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261378"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">header1
Header blk
</span><a href="#local-6989586621679261380"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1322"></span><span>                    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1323"></span><span>                      </span><span class="annot"><a href="Test.ThreadNet.Network.html#CalcMessageDelay"><span class="hs-identifier hs-type">CalcMessageDelay</span></a></span><span> </span><span id="local-6989586621679261376"><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId) -&gt; SlotNo -&gt; Header blk -&gt; NumSlots
</span><a href="#local-6989586621679261376"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CalcMessageDelay blk
</span><a href="#local-6989586621679261432"><span class="hs-identifier hs-var">calcMessageDelay</span></a></span><span>
</span><span id="line-1324"></span><span>              </span><span class="annot"><span class="annottext">m Bool -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; m ()) -&gt; m Bool -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OracularClock m -&gt; SlotNo -&gt; m Bool
forall (m :: * -&gt; *). OracularClock m -&gt; SlotNo -&gt; m Bool
</span><a href="Test.Util.HardFork.OracularClock.html#blockUntilSlot"><span class="hs-identifier hs-var hs-var">OracularClock.blockUntilSlot</span></a></span><span> </span><span class="annot"><span class="annottext">OracularClock m
</span><a href="#local-6989586621679261436"><span class="hs-identifier hs-var">clock</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; m Bool) -&gt; SlotNo -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">header1 -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-var">blockSlot</span></a></span><span> </span><span class="annot"><span class="annottext">header1
</span><a href="#local-6989586621679261380"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; SlotNo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><span class="hs-identifier hs-var">SlotNo</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679261377"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1325"></span><span>          </span><span class="annot"><span class="annottext">Either DeserialiseFailure (SomeMessage ('StNext 'StMustReply))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1327"></span><span>        </span><span id="local-6989586621679261384"><span class="annot"><span class="annottext">codec :: Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  DeserialiseFailure
  m
  ByteString
</span><a href="#local-6989586621679261384"><span class="hs-identifier hs-var hs-var">codec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1328"></span><span>            </span><span class="annot"><span class="annottext">Codecs
  blk
  DeserialiseFailure
  m
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
  ByteString
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
forall blk e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bTX2 bKA.
Codecs blk e m bCS bSCS bBF bSBF bTX bTX2 bKA
-&gt; Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var hs-var">NTN.cChainSyncCodec</span></a></span><span> </span><span class="annot"><span class="annottext">(Codecs
   blk
   DeserialiseFailure
   m
   ByteString
   ByteString
   ByteString
   ByteString
   ByteString
   ByteString
   ByteString
 -&gt; Codec
      (ChainSync (Header blk) (Point blk) (Tip blk))
      DeserialiseFailure
      m
      ByteString)
-&gt; Codecs
     blk
     DeserialiseFailure
     m
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; BlockNodeToNodeVersion blk
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     DeserialiseFailure
     m
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
forall (m :: * -&gt; *) blk.
(IOLike m, SerialiseNodeToNodeConstraints blk,
 ShowProxy (GenTxId blk), ShowProxy (GenTx blk)) =&gt;
CodecConfig blk
-&gt; BlockNodeToNodeVersion blk
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     DeserialiseFailure
     m
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.defaultCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679261433"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679261434"><span class="hs-identifier hs-var">blockVersion</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679261435"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-1329"></span><span>
</span><span id="line-1330"></span><span class="hs-comment">-- | Variant of 'createConnectChannels' with intermediate queues for</span><span>
</span><span id="line-1331"></span><span class="hs-comment">-- delayed-but-in-order messages</span><span>
</span><span id="line-1332"></span><span class="hs-comment">--</span><span>
</span><span id="line-1333"></span><span class="hs-comment">-- Sending adds the message to a queue. The delaying argument should use</span><span>
</span><span id="line-1334"></span><span class="hs-comment">-- 'threadDelay' in order to delay the transfer of the given message from the</span><span>
</span><span id="line-1335"></span><span class="hs-comment">-- queue to the recipient.</span><span>
</span><span id="line-1336"></span><span id="local-6989586621679262342"><span id="local-6989586621679262343"><span class="annot"><a href="Test.ThreadNet.Network.html#createConnectedChannelsWithDelay"><span class="hs-identifier hs-type">createConnectedChannelsWithDelay</span></a></span><span>
</span><span id="line-1337"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262343"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1338"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262343"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1339"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-1340"></span><span>     </span><span class="hs-comment">-- ^ (client, server, protocol)</span><span>
</span><span id="line-1341"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262342"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1342"></span><span>     </span><span class="hs-comment">-- ^ per-message delay</span><span>
</span><span id="line-1343"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">Channel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262342"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">Channel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262343"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262342"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1344"></span><span id="createConnectedChannelsWithDelay"><span class="annot"><span class="annottext">createConnectedChannelsWithDelay :: ResourceRegistry m
-&gt; (CoreNodeId, CoreNodeId, String)
-&gt; (a -&gt; m ())
-&gt; m (Channel m a, Channel m a)
</span><a href="Test.ThreadNet.Network.html#createConnectedChannelsWithDelay"><span class="hs-identifier hs-var hs-var">createConnectedChannelsWithDelay</span></a></span></span><span> </span><span id="local-6989586621679261373"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261373"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261372"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261372"><span class="hs-identifier hs-var">client</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261371"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261371"><span class="hs-identifier hs-var">server</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261370"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261370"><span class="hs-identifier hs-var">proto</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679261369"><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679261369"><span class="hs-identifier hs-var">middle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1345"></span><span>    </span><span class="hs-comment">-- queue for async send and an mvar for delayed-but-in-order reads from the</span><span>
</span><span id="line-1346"></span><span>    </span><span class="hs-comment">-- queue</span><span>
</span><span id="line-1347"></span><span>    </span><span id="local-6989586621679261368"><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261368"><span class="hs-identifier hs-var">qA</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (TQueue_ (STM m) a) -&gt; m (TQueue_ (STM m) a)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (TQueue_ (STM m) a) -&gt; m (TQueue_ (STM m) a))
-&gt; STM m (TQueue_ (STM m) a) -&gt; m (TQueue_ (STM m) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (TQueue_ (STM m) a)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm (TQueue_ stm a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.newTQueue</span></a></span><span>
</span><span id="line-1348"></span><span>    </span><span id="local-6989586621679261366"><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261366"><span class="hs-identifier hs-var">bA</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (TMVar_ (STM m) a) -&gt; m (TMVar_ (STM m) a)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (TMVar_ (STM m) a) -&gt; m (TMVar_ (STM m) a))
-&gt; STM m (TMVar_ (STM m) a) -&gt; m (TMVar_ (STM m) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (TMVar_ (STM m) a)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm (TMVar_ stm a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.newEmptyTMVar</span></a></span><span>
</span><span id="line-1349"></span><span>    </span><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId)
-&gt; TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; m ()
</span><a href="#local-6989586621679261364"><span class="hs-identifier hs-var">spawn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261372"><span class="hs-identifier hs-var">client</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261371"><span class="hs-identifier hs-var">server</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261368"><span class="hs-identifier hs-var">qA</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261366"><span class="hs-identifier hs-var">bA</span></a></span><span>
</span><span id="line-1350"></span><span>
</span><span id="line-1351"></span><span>    </span><span id="local-6989586621679261363"><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261363"><span class="hs-identifier hs-var">qB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (TQueue_ (STM m) a) -&gt; m (TQueue_ (STM m) a)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (TQueue_ (STM m) a) -&gt; m (TQueue_ (STM m) a))
-&gt; STM m (TQueue_ (STM m) a) -&gt; m (TQueue_ (STM m) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (TQueue_ (STM m) a)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm (TQueue_ stm a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.newTQueue</span></a></span><span>
</span><span id="line-1352"></span><span>    </span><span id="local-6989586621679261362"><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261362"><span class="hs-identifier hs-var">bB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (TMVar_ (STM m) a) -&gt; m (TMVar_ (STM m) a)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m (TMVar_ (STM m) a) -&gt; m (TMVar_ (STM m) a))
-&gt; STM m (TMVar_ (STM m) a) -&gt; m (TMVar_ (STM m) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (TMVar_ (STM m) a)
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; stm (TMVar_ stm a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.newEmptyTMVar</span></a></span><span>
</span><span id="line-1353"></span><span>    </span><span class="annot"><span class="annottext">(CoreNodeId, CoreNodeId)
-&gt; TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; m ()
</span><a href="#local-6989586621679261364"><span class="hs-identifier hs-var">spawn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261371"><span class="hs-identifier hs-var">server</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261372"><span class="hs-identifier hs-var">client</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261363"><span class="hs-identifier hs-var">qB</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261362"><span class="hs-identifier hs-var">bB</span></a></span><span>
</span><span id="line-1354"></span><span>
</span><span id="line-1355"></span><span>    </span><span class="annot"><span class="annottext">(Channel m a, Channel m a) -&gt; m (Channel m a, Channel m a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; Channel m a
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; Channel m a
</span><a href="#local-6989586621679261361"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261368"><span class="hs-identifier hs-var">qA</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261362"><span class="hs-identifier hs-var">bB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; Channel m a
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; Channel m a
</span><a href="#local-6989586621679261361"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261363"><span class="hs-identifier hs-var">qB</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261366"><span class="hs-identifier hs-var">bA</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- note the crossover</span><span>
</span><span id="line-1356"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1357"></span><span>    </span><span id="local-6989586621679261364"><span class="annot"><span class="annottext">spawn :: (CoreNodeId, CoreNodeId)
-&gt; TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; m ()
</span><a href="#local-6989586621679261364"><span class="hs-identifier hs-var hs-var">spawn</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261360"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261360"><span class="hs-identifier hs-var">cid1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261359"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261359"><span class="hs-identifier hs-var">cid2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679261358"><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261358"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679261357"><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261357"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1358"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261356"><span class="annot"><span class="annottext">label :: String
</span><a href="#local-6989586621679261356"><span class="hs-keyword hs-var hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1359"></span><span>                </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;delaying thread for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261370"><span class="hs-identifier hs-var">proto</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span>
</span><span id="line-1360"></span><span>                </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261360"><span class="hs-identifier hs-var">cid1</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; to &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261359"><span class="hs-identifier hs-var">cid2</span></a></span><span>
</span><span id="line-1361"></span><span>        </span><span class="annot"><span class="annottext">m (Thread m Any) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (Thread m Any) -&gt; m ()) -&gt; m (Thread m Any) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m Any -&gt; m (Thread m Any)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">forkLinkedThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679261373"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679261356"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">(m Any -&gt; m (Thread m Any)) -&gt; m Any -&gt; m (Thread m Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Any
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m Any) -&gt; m () -&gt; m Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1362"></span><span>          </span><span id="local-6989586621679261354"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679261354"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m a -&gt; m a) -&gt; STM m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a -&gt; STM m a
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; TQueue_ stm a -&gt; stm a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.readTQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261358"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-1363"></span><span>          </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679261369"><span class="hs-identifier hs-var">middle</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679261354"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1364"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a -&gt; a -&gt; STM m ()
forall (stm :: * -&gt; *) a.
MonadSTMTx stm =&gt;
TMVar_ stm a -&gt; a -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.putTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261357"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679261354"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1365"></span><span>
</span><span id="line-1366"></span><span>    </span><span id="local-6989586621679261361"><span class="annot"><span class="annottext">chan :: TQueue_ (STM m) a -&gt; TMVar_ (STM m) a -&gt; Channel m a
</span><a href="#local-6989586621679261361"><span class="hs-identifier hs-var hs-var">chan</span></a></span></span><span> </span><span id="local-6989586621679261351"><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261351"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679261350"><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261350"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Channel :: forall (m :: * -&gt; *) a. (a -&gt; m ()) -&gt; m (Maybe a) -&gt; Channel m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-type">Channel</span></a></span><span>
</span><span id="line-1367"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">recv :: m (Maybe a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">recv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe a) -&gt; m a -&gt; m (Maybe a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m (Maybe a)) -&gt; m a -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m a -&gt; m a) -&gt; STM m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a -&gt; STM m a
forall (stm :: * -&gt; *) a. MonadSTMTx stm =&gt; TMVar_ stm a -&gt; stm a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.takeTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar_ (STM m) a
</span><a href="#local-6989586621679261350"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1368"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">send :: a -&gt; m ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-framework-0.1.0.0/noopt/doc/html/ouroboros-network-framework/src"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; (a -&gt; STM m ()) -&gt; a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a -&gt; a -&gt; STM m ()
forall (stm :: * -&gt; *) a.
MonadSTMTx stm =&gt;
TQueue_ stm a -&gt; a -&gt; stm ()
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">MonadSTM.writeTQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue_ (STM m) a
</span><a href="#local-6989586621679261351"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-1369"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1370"></span><span>
</span><span id="line-1371"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Node information not bound to lifetime of a specific node instance
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1374"></span><span>
</span><span id="line-1375"></span><span class="hs-keyword">data</span><span> </span><span id="NodeInfo"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a></span></span><span> </span><span id="local-6989586621679262757"><span class="annot"><a href="#local-6989586621679262757"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679262756"><span class="annot"><a href="#local-6989586621679262756"><span class="hs-identifier hs-type">db</span></a></span></span><span> </span><span id="local-6989586621679262755"><span class="annot"><a href="#local-6989586621679262755"><span class="hs-identifier hs-type">ev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NodeInfo"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a></span></span><span>
</span><span id="line-1376"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="nodeInfoEvents"><span class="annot"><span class="annottext">NodeInfo blk db ev -&gt; NodeEvents blk ev
</span><a href="Test.ThreadNet.Network.html#nodeInfoEvents"><span class="hs-identifier hs-var hs-var">nodeInfoEvents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-type">NodeEvents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262757"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262755"><span class="hs-identifier hs-type">ev</span></a></span><span>
</span><span id="line-1377"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeInfoDBs"><span class="annot"><span class="annottext">NodeInfo blk db ev -&gt; NodeDBs db
</span><a href="Test.ThreadNet.Network.html#nodeInfoDBs"><span class="hs-identifier hs-var hs-var">nodeInfoDBs</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-type">NodeDBs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262756"><span class="hs-identifier hs-type">db</span></a></span><span>
</span><span id="line-1378"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1379"></span><span>
</span><span id="line-1380"></span><span class="hs-comment">-- | A vector with an @ev@-shaped element for a particular set of</span><span>
</span><span id="line-1381"></span><span class="hs-comment">-- instrumentation events</span><span>
</span><span id="line-1382"></span><span class="hs-comment">--</span><span>
</span><span id="line-1383"></span><span class="hs-comment">-- The @ev@ type parameter is instantiated by this module at types for</span><span>
</span><span id="line-1384"></span><span class="hs-comment">-- 'Tracer's and lists: actions for accumulating and lists as accumulations.</span><span>
</span><span id="line-1385"></span><span class="hs-keyword">data</span><span> </span><span id="NodeEvents"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-var">NodeEvents</span></a></span></span><span> </span><span id="local-6989586621679262754"><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679262753"><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NodeEvents"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-var">NodeEvents</span></a></span></span><span>
</span><span id="line-1386"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="nodeEventsAdds"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsAdds"><span class="hs-identifier hs-var hs-var">nodeEventsAdds</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-1387"></span><span>    </span><span class="hs-comment">-- ^ every 'AddedBlockToVolatileDB' excluding EBBs</span><span>
</span><span id="line-1388"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeEventsForges"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (TraceForgeEvent blk)
</span><a href="Test.ThreadNet.Network.html#nodeEventsForges"><span class="hs-identifier hs-var hs-var">nodeEventsForges</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TraceForgeEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1389"></span><span>    </span><span class="hs-comment">-- ^ every 'TraceForgeEvent'</span><span>
</span><span id="line-1390"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeEventsHeaderAdds"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsHeaderAdds"><span class="hs-identifier hs-var hs-var">nodeEventsHeaderAdds</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-1391"></span><span>    </span><span class="hs-comment">-- ^ every 'TraceDownloadedHeader', excluding EBBs</span><span>
</span><span id="line-1392"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeEventsInvalids"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (RealPoint blk, ExtValidationError blk)
</span><a href="Test.ThreadNet.Network.html#nodeEventsInvalids"><span class="hs-identifier hs-var hs-var">nodeEventsInvalids</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtValidationError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1393"></span><span>    </span><span class="hs-comment">-- ^ the point of every 'ChainDB.InvalidBlock' event</span><span>
</span><span id="line-1394"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeEventsSelects"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsSelects"><span class="hs-identifier hs-var hs-var">nodeEventsSelects</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-1395"></span><span>    </span><span class="hs-comment">-- ^ every 'ChainDB.AddedToCurrentChain' and 'ChainDB.SwitchedToAFork'</span><span>
</span><span id="line-1396"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeEventsTipBlockNos"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (SlotNo, WithOrigin BlockNo)
</span><a href="Test.ThreadNet.Network.html#nodeEventsTipBlockNos"><span class="hs-identifier hs-var hs-var">nodeEventsTipBlockNos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-1397"></span><span>    </span><span class="hs-comment">-- ^ 'ChainDB.getTipBlockNo' for each node at the onset of each slot</span><span>
</span><span id="line-1398"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeEventsUpdates"><span class="annot"><span class="annottext">NodeEvents blk ev -&gt; ev (LedgerUpdate blk)
</span><a href="Test.ThreadNet.Network.html#nodeEventsUpdates"><span class="hs-identifier hs-var hs-var">nodeEventsUpdates</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262753"><span class="hs-identifier hs-type">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262754"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1399"></span><span>    </span><span class="hs-comment">-- ^ Ledger updates every time we adopt a block/switch to a fork</span><span>
</span><span id="line-1400"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span class="hs-comment">-- | A vector with an element for each database of a node</span><span>
</span><span id="line-1403"></span><span class="hs-comment">--</span><span>
</span><span id="line-1404"></span><span class="hs-comment">-- The @db@ type parameter is instantiated by this module at types for mock</span><span>
</span><span id="line-1405"></span><span class="hs-comment">-- filesystems; either the 'MockFS' type or reference cells thereof.</span><span>
</span><span id="line-1406"></span><span class="hs-keyword">data</span><span> </span><span id="NodeDBs"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-var">NodeDBs</span></a></span></span><span> </span><span id="local-6989586621679262663"><span class="annot"><a href="#local-6989586621679262663"><span class="hs-identifier hs-type">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NodeDBs"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-var">NodeDBs</span></a></span></span><span>
</span><span id="line-1407"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="nodeDBsImm"><span class="annot"><span class="annottext">NodeDBs db -&gt; db
</span><a href="Test.ThreadNet.Network.html#nodeDBsImm"><span class="hs-identifier hs-var hs-var">nodeDBsImm</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262663"><span class="hs-identifier hs-type">db</span></a></span><span>
</span><span id="line-1408"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeDBsVol"><span class="annot"><span class="annottext">NodeDBs db -&gt; db
</span><a href="Test.ThreadNet.Network.html#nodeDBsVol"><span class="hs-identifier hs-var hs-var">nodeDBsVol</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262663"><span class="hs-identifier hs-type">db</span></a></span><span>
</span><span id="line-1409"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeDBsLgr"><span class="annot"><span class="annottext">NodeDBs db -&gt; db
</span><a href="Test.ThreadNet.Network.html#nodeDBsLgr"><span class="hs-identifier hs-var hs-var">nodeDBsLgr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262663"><span class="hs-identifier hs-type">db</span></a></span><span>
</span><span id="line-1410"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1411"></span><span>
</span><span id="line-1412"></span><span class="annot"><a href="Test.ThreadNet.Network.html#newNodeInfo"><span class="hs-identifier hs-type">newNodeInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1413"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262832"><span class="annot"><a href="#local-6989586621679262832"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679262833"><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1414"></span><span>     </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1415"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262832"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1416"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262832"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1417"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-1418"></span><span id="newNodeInfo"><span class="annot"><span class="annottext">newNodeInfo :: m (NodeInfo blk (StrictTVar m MockFS) (Tracer m),
   m (NodeInfo blk MockFS []))
</span><a href="Test.ThreadNet.Network.html#newNodeInfo"><span class="hs-identifier hs-var hs-var">newNodeInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1419"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679261343"><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261343"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261342"><span class="annot"><span class="annottext">m (NodeEvents blk [])
</span><a href="#local-6989586621679261342"><span class="hs-identifier hs-var">readEvents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1420"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261341"><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261341"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261340"><span class="annot"><span class="annottext">m [(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261340"><span class="hs-identifier hs-var">m1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (SlotNo, RealPoint blk, BlockNo),
   m [(SlotNo, RealPoint blk, BlockNo)])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1421"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261338"><span class="annot"><span class="annottext">Tracer m (TraceForgeEvent blk)
</span><a href="#local-6989586621679261338"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261337"><span class="annot"><span class="annottext">m [TraceForgeEvent blk]
</span><a href="#local-6989586621679261337"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (TraceForgeEvent blk), m [TraceForgeEvent blk])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1422"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261336"><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261336"><span class="hs-identifier hs-var">t3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261335"><span class="annot"><span class="annottext">m [(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261335"><span class="hs-identifier hs-var">m3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (SlotNo, RealPoint blk, BlockNo),
   m [(SlotNo, RealPoint blk, BlockNo)])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1423"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261334"><span class="annot"><span class="annottext">Tracer m (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261334"><span class="hs-identifier hs-var">t4</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261333"><span class="annot"><span class="annottext">m [(RealPoint blk, ExtValidationError blk)]
</span><a href="#local-6989586621679261333"><span class="hs-identifier hs-var">m4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (RealPoint blk, ExtValidationError blk),
   m [(RealPoint blk, ExtValidationError blk)])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1424"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261332"><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261332"><span class="hs-identifier hs-var">t5</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261331"><span class="annot"><span class="annottext">m [(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261331"><span class="hs-identifier hs-var">m5</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (SlotNo, RealPoint blk, BlockNo),
   m [(SlotNo, RealPoint blk, BlockNo)])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1425"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261330"><span class="annot"><span class="annottext">Tracer m (SlotNo, WithOrigin BlockNo)
</span><a href="#local-6989586621679261330"><span class="hs-identifier hs-var">t6</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261329"><span class="annot"><span class="annottext">m [(SlotNo, WithOrigin BlockNo)]
</span><a href="#local-6989586621679261329"><span class="hs-identifier hs-var">m6</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (SlotNo, WithOrigin BlockNo),
   m [(SlotNo, WithOrigin BlockNo)])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1426"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261328"><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261328"><span class="hs-identifier hs-var">t7</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261327"><span class="annot"><span class="annottext">m [LedgerUpdate blk]
</span><a href="#local-6989586621679261327"><span class="hs-identifier hs-var">m7</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Tracer m (LedgerUpdate blk), m [LedgerUpdate blk])
forall (m :: * -&gt; *) ev. MonadSTM m =&gt; m (Tracer m ev, m [ev])
</span><a href="Test.Util.Tracer.html#recordingTracerTVar"><span class="hs-identifier hs-var">recordingTracerTVar</span></a></span><span>
</span><span id="line-1427"></span><span>      </span><span class="annot"><span class="annottext">(NodeEvents blk (Tracer m), m (NodeEvents blk []))
-&gt; m (NodeEvents blk (Tracer m), m (NodeEvents blk []))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1428"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (TraceForgeEvent blk)
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (RealPoint blk, ExtValidationError blk)
-&gt; Tracer m (SlotNo, RealPoint blk, BlockNo)
-&gt; Tracer m (SlotNo, WithOrigin BlockNo)
-&gt; Tracer m (LedgerUpdate blk)
-&gt; NodeEvents blk (Tracer m)
forall blk (ev :: * -&gt; *).
ev (SlotNo, RealPoint blk, BlockNo)
-&gt; ev (TraceForgeEvent blk)
-&gt; ev (SlotNo, RealPoint blk, BlockNo)
-&gt; ev (RealPoint blk, ExtValidationError blk)
-&gt; ev (SlotNo, RealPoint blk, BlockNo)
-&gt; ev (SlotNo, WithOrigin BlockNo)
-&gt; ev (LedgerUpdate blk)
-&gt; NodeEvents blk ev
</span><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-var">NodeEvents</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261341"><span class="hs-identifier hs-var">t1</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (TraceForgeEvent blk)
</span><a href="#local-6989586621679261338"><span class="hs-identifier hs-var">t2</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261336"><span class="hs-identifier hs-var">t3</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261334"><span class="hs-identifier hs-var">t4</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261332"><span class="hs-identifier hs-var">t5</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (SlotNo, WithOrigin BlockNo)
</span><a href="#local-6989586621679261330"><span class="hs-identifier hs-var">t6</span></a></span><span>     </span><span class="annot"><span class="annottext">Tracer m (LedgerUpdate blk)
</span><a href="#local-6989586621679261328"><span class="hs-identifier hs-var">t7</span></a></span><span>
</span><span id="line-1429"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
-&gt; [TraceForgeEvent blk]
-&gt; [(SlotNo, RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, ExtValidationError blk)]
-&gt; [(SlotNo, RealPoint blk, BlockNo)]
-&gt; [(SlotNo, WithOrigin BlockNo)]
-&gt; [LedgerUpdate blk]
-&gt; NodeEvents blk []
forall blk (ev :: * -&gt; *).
ev (SlotNo, RealPoint blk, BlockNo)
-&gt; ev (TraceForgeEvent blk)
-&gt; ev (SlotNo, RealPoint blk, BlockNo)
-&gt; ev (RealPoint blk, ExtValidationError blk)
-&gt; ev (SlotNo, RealPoint blk, BlockNo)
-&gt; ev (SlotNo, WithOrigin BlockNo)
-&gt; ev (LedgerUpdate blk)
-&gt; NodeEvents blk ev
</span><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-var">NodeEvents</span></a></span><span> </span><span class="annot"><span class="annottext">([(SlotNo, RealPoint blk, BlockNo)]
 -&gt; [TraceForgeEvent blk]
 -&gt; [(SlotNo, RealPoint blk, BlockNo)]
 -&gt; [(RealPoint blk, ExtValidationError blk)]
 -&gt; [(SlotNo, RealPoint blk, BlockNo)]
 -&gt; [(SlotNo, WithOrigin BlockNo)]
 -&gt; [LedgerUpdate blk]
 -&gt; NodeEvents blk [])
-&gt; m [(SlotNo, RealPoint blk, BlockNo)]
-&gt; m ([TraceForgeEvent blk]
      -&gt; [(SlotNo, RealPoint blk, BlockNo)]
      -&gt; [(RealPoint blk, ExtValidationError blk)]
      -&gt; [(SlotNo, RealPoint blk, BlockNo)]
      -&gt; [(SlotNo, WithOrigin BlockNo)]
      -&gt; [LedgerUpdate blk]
      -&gt; NodeEvents blk [])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261340"><span class="hs-identifier hs-var">m1</span></a></span><span> </span><span class="annot"><span class="annottext">m ([TraceForgeEvent blk]
   -&gt; [(SlotNo, RealPoint blk, BlockNo)]
   -&gt; [(RealPoint blk, ExtValidationError blk)]
   -&gt; [(SlotNo, RealPoint blk, BlockNo)]
   -&gt; [(SlotNo, WithOrigin BlockNo)]
   -&gt; [LedgerUpdate blk]
   -&gt; NodeEvents blk [])
-&gt; m [TraceForgeEvent blk]
-&gt; m ([(SlotNo, RealPoint blk, BlockNo)]
      -&gt; [(RealPoint blk, ExtValidationError blk)]
      -&gt; [(SlotNo, RealPoint blk, BlockNo)]
      -&gt; [(SlotNo, WithOrigin BlockNo)]
      -&gt; [LedgerUpdate blk]
      -&gt; NodeEvents blk [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [TraceForgeEvent blk]
</span><a href="#local-6989586621679261337"><span class="hs-identifier hs-var">m2</span></a></span><span> </span><span class="annot"><span class="annottext">m ([(SlotNo, RealPoint blk, BlockNo)]
   -&gt; [(RealPoint blk, ExtValidationError blk)]
   -&gt; [(SlotNo, RealPoint blk, BlockNo)]
   -&gt; [(SlotNo, WithOrigin BlockNo)]
   -&gt; [LedgerUpdate blk]
   -&gt; NodeEvents blk [])
-&gt; m [(SlotNo, RealPoint blk, BlockNo)]
-&gt; m ([(RealPoint blk, ExtValidationError blk)]
      -&gt; [(SlotNo, RealPoint blk, BlockNo)]
      -&gt; [(SlotNo, WithOrigin BlockNo)]
      -&gt; [LedgerUpdate blk]
      -&gt; NodeEvents blk [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261335"><span class="hs-identifier hs-var">m3</span></a></span><span> </span><span class="annot"><span class="annottext">m ([(RealPoint blk, ExtValidationError blk)]
   -&gt; [(SlotNo, RealPoint blk, BlockNo)]
   -&gt; [(SlotNo, WithOrigin BlockNo)]
   -&gt; [LedgerUpdate blk]
   -&gt; NodeEvents blk [])
-&gt; m [(RealPoint blk, ExtValidationError blk)]
-&gt; m ([(SlotNo, RealPoint blk, BlockNo)]
      -&gt; [(SlotNo, WithOrigin BlockNo)]
      -&gt; [LedgerUpdate blk]
      -&gt; NodeEvents blk [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [(RealPoint blk, ExtValidationError blk)]
</span><a href="#local-6989586621679261333"><span class="hs-identifier hs-var">m4</span></a></span><span> </span><span class="annot"><span class="annottext">m ([(SlotNo, RealPoint blk, BlockNo)]
   -&gt; [(SlotNo, WithOrigin BlockNo)]
   -&gt; [LedgerUpdate blk]
   -&gt; NodeEvents blk [])
-&gt; m [(SlotNo, RealPoint blk, BlockNo)]
-&gt; m ([(SlotNo, WithOrigin BlockNo)]
      -&gt; [LedgerUpdate blk] -&gt; NodeEvents blk [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261331"><span class="hs-identifier hs-var">m5</span></a></span><span> </span><span class="annot"><span class="annottext">m ([(SlotNo, WithOrigin BlockNo)]
   -&gt; [LedgerUpdate blk] -&gt; NodeEvents blk [])
-&gt; m [(SlotNo, WithOrigin BlockNo)]
-&gt; m ([LedgerUpdate blk] -&gt; NodeEvents blk [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [(SlotNo, WithOrigin BlockNo)]
</span><a href="#local-6989586621679261329"><span class="hs-identifier hs-var">m6</span></a></span><span> </span><span class="annot"><span class="annottext">m ([LedgerUpdate blk] -&gt; NodeEvents blk [])
-&gt; m [LedgerUpdate blk] -&gt; m (NodeEvents blk [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m [LedgerUpdate blk]
</span><a href="#local-6989586621679261327"><span class="hs-identifier hs-var">m7</span></a></span><span>
</span><span id="line-1430"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-1431"></span><span>
</span><span id="line-1432"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679261326"><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261326"><span class="hs-identifier hs-var">nodeInfoDBs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261325"><span class="annot"><span class="annottext">STM m (NodeDBs MockFS)
</span><a href="#local-6989586621679261325"><span class="hs-identifier hs-var">readDBs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1433"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679261324"><span class="hs-identifier hs-type">mk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">StrictTVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262833"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1434"></span><span>          </span><span id="local-6989586621679261324"><span class="annot"><span class="annottext">mk :: m (StrictTVar m MockFS, STM m MockFS)
</span><a href="#local-6989586621679261324"><span class="hs-identifier hs-var hs-var">mk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1435"></span><span>              </span><span id="local-6989586621679261323"><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261323"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MockFS -&gt; m (StrictTVar m MockFS)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">uncheckedNewTVarM</span></a></span><span> </span><span class="annot"><span class="annottext">MockFS
</span><a href="Test.Util.FS.Sim.MockFS.html#empty"><span class="hs-identifier hs-var">Mock.empty</span></a></span><span>
</span><span id="line-1436"></span><span>              </span><span class="annot"><span class="annottext">(StrictTVar m MockFS, STM m MockFS)
-&gt; m (StrictTVar m MockFS, STM m MockFS)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261323"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m MockFS -&gt; STM m MockFS
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261323"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1437"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261321"><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261321"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261320"><span class="annot"><span class="annottext">STM m MockFS
</span><a href="#local-6989586621679261320"><span class="hs-identifier hs-var">m1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (StrictTVar m MockFS, STM m MockFS)
</span><a href="#local-6989586621679261324"><span class="hs-identifier hs-var">mk</span></a></span><span>
</span><span id="line-1438"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261319"><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261319"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261318"><span class="annot"><span class="annottext">STM m MockFS
</span><a href="#local-6989586621679261318"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (StrictTVar m MockFS, STM m MockFS)
</span><a href="#local-6989586621679261324"><span class="hs-identifier hs-var">mk</span></a></span><span>
</span><span id="line-1439"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679261317"><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261317"><span class="hs-identifier hs-var">v3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261316"><span class="annot"><span class="annottext">STM m MockFS
</span><a href="#local-6989586621679261316"><span class="hs-identifier hs-var">m3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (StrictTVar m MockFS, STM m MockFS)
</span><a href="#local-6989586621679261324"><span class="hs-identifier hs-var">mk</span></a></span><span>
</span><span id="line-1440"></span><span>      </span><span class="annot"><span class="annottext">(NodeDBs (StrictTVar m MockFS), STM m (NodeDBs MockFS))
-&gt; m (NodeDBs (StrictTVar m MockFS), STM m (NodeDBs MockFS))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1441"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">StrictTVar m MockFS
-&gt; StrictTVar m MockFS
-&gt; StrictTVar m MockFS
-&gt; NodeDBs (StrictTVar m MockFS)
forall db. db -&gt; db -&gt; db -&gt; NodeDBs db
</span><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-var">NodeDBs</span></a></span><span>     </span><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261321"><span class="hs-identifier hs-var">v1</span></a></span><span>     </span><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261319"><span class="hs-identifier hs-var">v2</span></a></span><span>     </span><span class="annot"><span class="annottext">StrictTVar m MockFS
</span><a href="#local-6989586621679261317"><span class="hs-identifier hs-var">v3</span></a></span><span>
</span><span id="line-1442"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MockFS -&gt; MockFS -&gt; MockFS -&gt; NodeDBs MockFS
forall db. db -&gt; db -&gt; db -&gt; NodeDBs db
</span><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-var">NodeDBs</span></a></span><span> </span><span class="annot"><span class="annottext">(MockFS -&gt; MockFS -&gt; MockFS -&gt; NodeDBs MockFS)
-&gt; STM m MockFS -&gt; STM m (MockFS -&gt; MockFS -&gt; NodeDBs MockFS)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m MockFS
</span><a href="#local-6989586621679261320"><span class="hs-identifier hs-var">m1</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (MockFS -&gt; MockFS -&gt; NodeDBs MockFS)
-&gt; STM m MockFS -&gt; STM m (MockFS -&gt; NodeDBs MockFS)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m MockFS
</span><a href="#local-6989586621679261318"><span class="hs-identifier hs-var">m2</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (MockFS -&gt; NodeDBs MockFS)
-&gt; STM m MockFS -&gt; STM m (NodeDBs MockFS)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m MockFS
</span><a href="#local-6989586621679261316"><span class="hs-identifier hs-var">m3</span></a></span><span>
</span><span id="line-1443"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-1444"></span><span>
</span><span id="line-1445"></span><span>  </span><span class="annot"><span class="annottext">(NodeInfo blk (StrictTVar m MockFS) (Tracer m),
 m (NodeInfo blk MockFS []))
-&gt; m (NodeInfo blk (StrictTVar m MockFS) (Tracer m),
      m (NodeInfo blk MockFS []))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1446"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">NodeInfo :: forall blk db (ev :: * -&gt; *).
NodeEvents blk ev -&gt; NodeDBs db -&gt; NodeInfo blk db ev
</span><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">NodeEvents blk (Tracer m)
nodeInfoEvents :: NodeEvents blk (Tracer m)
nodeInfoEvents :: NodeEvents blk (Tracer m)
</span><a href="#local-6989586621679261343"><span class="hs-identifier hs-var hs-var">nodeInfoEvents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NodeDBs (StrictTVar m MockFS)
nodeInfoDBs :: NodeDBs (StrictTVar m MockFS)
nodeInfoDBs :: NodeDBs (StrictTVar m MockFS)
</span><a href="#local-6989586621679261326"><span class="hs-identifier hs-var hs-var">nodeInfoDBs</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1447"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NodeEvents blk [] -&gt; NodeDBs MockFS -&gt; NodeInfo blk MockFS []
forall blk db (ev :: * -&gt; *).
NodeEvents blk ev -&gt; NodeDBs db -&gt; NodeInfo blk db ev
</span><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(NodeEvents blk [] -&gt; NodeDBs MockFS -&gt; NodeInfo blk MockFS [])
-&gt; m (NodeEvents blk [])
-&gt; m (NodeDBs MockFS -&gt; NodeInfo blk MockFS [])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m (NodeEvents blk [])
</span><a href="#local-6989586621679261342"><span class="hs-identifier hs-var">readEvents</span></a></span><span> </span><span class="annot"><span class="annottext">m (NodeDBs MockFS -&gt; NodeInfo blk MockFS [])
-&gt; m (NodeDBs MockFS) -&gt; m (NodeInfo blk MockFS [])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM m (NodeDBs MockFS) -&gt; m (NodeDBs MockFS)
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (NodeDBs MockFS)
</span><a href="#local-6989586621679261325"><span class="hs-identifier hs-var">readDBs</span></a></span><span>
</span><span id="line-1448"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1449"></span><span>
</span><span id="line-1450"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Test Output - output data about each node
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1453"></span><span>
</span><span id="line-1454"></span><span class="hs-keyword">data</span><span> </span><span id="NodeOutput"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeOutput"><span class="hs-identifier hs-var">NodeOutput</span></a></span></span><span> </span><span id="local-6989586621679262158"><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NodeOutput"><span class="annot"><a href="Test.ThreadNet.Network.html#NodeOutput"><span class="hs-identifier hs-var">NodeOutput</span></a></span></span><span>
</span><span id="line-1455"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="nodeOutputAdds"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Map SlotNo (Set (RealPoint blk, BlockNo))
</span><a href="Test.ThreadNet.Network.html#nodeOutputAdds"><span class="hs-identifier hs-var hs-var">nodeOutputAdds</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1456"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputCannotForges"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Map SlotNo [CannotForge blk]
</span><a href="Test.ThreadNet.Network.html#nodeOutputCannotForges"><span class="hs-identifier hs-var hs-var">nodeOutputCannotForges</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CannotForge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1457"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputFinalChain"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Chain blk
</span><a href="Test.ThreadNet.Network.html#nodeOutputFinalChain"><span class="hs-identifier hs-var hs-var">nodeOutputFinalChain</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1458"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputFinalLedger"><span class="annot"><span class="annottext">NodeOutput blk -&gt; LedgerState blk
</span><a href="Test.ThreadNet.Network.html#nodeOutputFinalLedger"><span class="hs-identifier hs-var hs-var">nodeOutputFinalLedger</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1459"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputForges"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Map SlotNo blk
</span><a href="Test.ThreadNet.Network.html#nodeOutputForges"><span class="hs-identifier hs-var hs-var">nodeOutputForges</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1460"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputHeaderAdds"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Map SlotNo [(RealPoint blk, BlockNo)]
</span><a href="Test.ThreadNet.Network.html#nodeOutputHeaderAdds"><span class="hs-identifier hs-var hs-var">nodeOutputHeaderAdds</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1461"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputInvalids"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Map (RealPoint blk) [ExtValidationError blk]
</span><a href="Test.ThreadNet.Network.html#nodeOutputInvalids"><span class="hs-identifier hs-var hs-var">nodeOutputInvalids</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ExtValidationError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1462"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputNodeDBs"><span class="annot"><span class="annottext">NodeOutput blk -&gt; NodeDBs MockFS
</span><a href="Test.ThreadNet.Network.html#nodeOutputNodeDBs"><span class="hs-identifier hs-var hs-var">nodeOutputNodeDBs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeDBs"><span class="hs-identifier hs-type">NodeDBs</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span>
</span><span id="line-1463"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputSelects"><span class="annot"><span class="annottext">NodeOutput blk -&gt; Map SlotNo [(RealPoint blk, BlockNo)]
</span><a href="Test.ThreadNet.Network.html#nodeOutputSelects"><span class="hs-identifier hs-var hs-var">nodeOutputSelects</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1464"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="nodeOutputUpdates"><span class="annot"><span class="annottext">NodeOutput blk -&gt; [LedgerUpdate blk]
</span><a href="Test.ThreadNet.Network.html#nodeOutputUpdates"><span class="hs-identifier hs-var hs-var">nodeOutputUpdates</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262158"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1465"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1466"></span><span>
</span><span id="line-1467"></span><span class="hs-keyword">data</span><span> </span><span id="TestOutput"><span class="annot"><a href="Test.ThreadNet.Network.html#TestOutput"><span class="hs-identifier hs-var">TestOutput</span></a></span></span><span> </span><span id="local-6989586621679262147"><span class="annot"><a href="#local-6989586621679262147"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TestOutput"><span class="annot"><a href="Test.ThreadNet.Network.html#TestOutput"><span class="hs-identifier hs-var">TestOutput</span></a></span></span><span>
</span><span id="line-1468"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="testOutputNodes"><span class="annot"><span class="annottext">TestOutput blk -&gt; Map NodeId (NodeOutput blk)
</span><a href="Test.ThreadNet.Network.html#testOutputNodes"><span class="hs-identifier hs-var hs-var">testOutputNodes</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeOutput"><span class="hs-identifier hs-type">NodeOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262147"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1469"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="testOutputTipBlockNos"><span class="annot"><span class="annottext">TestOutput blk -&gt; Map SlotNo (Map NodeId (WithOrigin BlockNo))
</span><a href="Test.ThreadNet.Network.html#testOutputTipBlockNos"><span class="hs-identifier hs-var hs-var">testOutputTipBlockNos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NodeId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1470"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1471"></span><span>
</span><span id="line-1472"></span><span class="hs-comment">-- | Gather the test output from the nodes</span><span>
</span><span id="line-1473"></span><span class="annot"><a href="Test.ThreadNet.Network.html#mkTestOutput"><span class="hs-identifier hs-type">mkTestOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1474"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262817"><span class="annot"><a href="#local-6989586621679262817"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262816"><span class="annot"><a href="#local-6989586621679262816"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262817"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262816"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1475"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-1476"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679262817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262816"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="Test.Util.FS.Sim.MockFS.html#MockFS"><span class="hs-identifier hs-type">MockFS</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1477"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262816"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1478"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262816"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1479"></span><span>        </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1480"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#TestOutput"><span class="hs-identifier hs-type">TestOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262816"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1481"></span><span id="mkTestOutput"><span class="annot"><span class="annottext">mkTestOutput :: [(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
-&gt; m (TestOutput blk)
</span><a href="Test.ThreadNet.Network.html#mkTestOutput"><span class="hs-identifier hs-var hs-var">mkTestOutput</span></a></span></span><span> </span><span id="local-6989586621679261301"><span class="annot"><span class="annottext">[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
</span><a href="#local-6989586621679261301"><span class="hs-identifier hs-var">vertexInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1482"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679261300"><span class="annot"><span class="annottext">[Map NodeId (NodeOutput blk)]
</span><a href="#local-6989586621679261300"><span class="hs-identifier hs-var">nodeOutputs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261299"><span class="annot"><span class="annottext">[Map SlotNo (Map NodeId (WithOrigin BlockNo))]
</span><a href="#local-6989586621679261299"><span class="hs-identifier hs-var">tipBlockNos'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([(Map NodeId (NodeOutput blk),
   Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
 -&gt; ([Map NodeId (NodeOutput blk)],
     [Map SlotNo (Map NodeId (WithOrigin BlockNo))]))
-&gt; m [(Map NodeId (NodeOutput blk),
       Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
-&gt; m ([Map NodeId (NodeOutput blk)],
      [Map SlotNo (Map NodeId (WithOrigin BlockNo))])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(Map NodeId (NodeOutput blk),
  Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
-&gt; ([Map NodeId (NodeOutput blk)],
    [Map SlotNo (Map NodeId (WithOrigin BlockNo))])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">(m [(Map NodeId (NodeOutput blk),
     Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
 -&gt; m ([Map NodeId (NodeOutput blk)],
       [Map SlotNo (Map NodeId (WithOrigin BlockNo))]))
-&gt; m [(Map NodeId (NodeOutput blk),
       Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
-&gt; m ([Map NodeId (NodeOutput blk)],
      [Map SlotNo (Map NodeId (WithOrigin BlockNo))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
-&gt; ((CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
     LedgerState blk)
    -&gt; m (Map NodeId (NodeOutput blk),
          Map SlotNo (Map NodeId (WithOrigin BlockNo))))
-&gt; m [(Map NodeId (NodeOutput blk),
       Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
  LedgerState blk)]
</span><a href="#local-6989586621679261301"><span class="hs-identifier hs-var">vertexInfos</span></a></span><span> </span><span class="annot"><span class="annottext">(((CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
   LedgerState blk)
  -&gt; m (Map NodeId (NodeOutput blk),
        Map SlotNo (Map NodeId (WithOrigin BlockNo))))
 -&gt; m [(Map NodeId (NodeOutput blk),
        Map SlotNo (Map NodeId (WithOrigin BlockNo)))])
-&gt; ((CoreNodeId, m (NodeInfo blk MockFS []), Chain blk,
     LedgerState blk)
    -&gt; m (Map NodeId (NodeOutput blk),
          Map SlotNo (Map NodeId (WithOrigin BlockNo))))
-&gt; m [(Map NodeId (NodeOutput blk),
       Map SlotNo (Map NodeId (WithOrigin BlockNo)))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1483"></span><span>      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679261297"><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261297"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261296"><span class="annot"><span class="annottext">m (NodeInfo blk MockFS [])
</span><a href="#local-6989586621679261296"><span class="hs-identifier hs-var">readNodeInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261295"><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261295"><span class="hs-identifier hs-var">ch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261294"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261294"><span class="hs-identifier hs-var">ldgr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1484"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261293"><span class="annot"><span class="annottext">nid :: NodeId
</span><a href="#local-6989586621679261293"><span class="hs-identifier hs-var hs-var">nid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreNodeId -&gt; NodeId
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">fromCoreNodeId</span></a></span><span> </span><span class="annot"><span class="annottext">CoreNodeId
</span><a href="#local-6989586621679261297"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-1485"></span><span>        </span><span id="local-6989586621679261292"><span class="annot"><span class="annottext">NodeInfo blk MockFS []
</span><a href="#local-6989586621679261292"><span class="hs-identifier hs-var">nodeInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (NodeInfo blk MockFS [])
</span><a href="#local-6989586621679261296"><span class="hs-identifier hs-var">readNodeInfo</span></a></span><span>
</span><span id="line-1486"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a></span><span>
</span><span id="line-1487"></span><span>              </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679261291"><span class="annot"><span class="annottext">NodeEvents blk []
nodeInfoEvents :: NodeEvents blk []
nodeInfoEvents :: forall blk db (ev :: * -&gt; *).
NodeInfo blk db ev -&gt; NodeEvents blk ev
</span><a href="#local-6989586621679261291"><span class="hs-identifier hs-var hs-var">nodeInfoEvents</span></a></span></span><span>
</span><span id="line-1488"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261290"><span class="annot"><span class="annottext">NodeDBs MockFS
nodeInfoDBs :: NodeDBs MockFS
nodeInfoDBs :: forall blk db (ev :: * -&gt; *). NodeInfo blk db ev -&gt; NodeDBs db
</span><a href="#local-6989586621679261290"><span class="hs-identifier hs-var hs-var">nodeInfoDBs</span></a></span></span><span>
</span><span id="line-1489"></span><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeInfo blk MockFS []
</span><a href="#local-6989586621679261292"><span class="hs-identifier hs-var">nodeInfo</span></a></span><span>
</span><span id="line-1490"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#NodeEvents"><span class="hs-identifier hs-type">NodeEvents</span></a></span><span>
</span><span id="line-1491"></span><span>              </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679261289"><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
nodeEventsAdds :: [(SlotNo, RealPoint blk, BlockNo)]
nodeEventsAdds :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261289"><span class="hs-identifier hs-var hs-var">nodeEventsAdds</span></a></span></span><span>
</span><span id="line-1492"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261288"><span class="annot"><span class="annottext">[TraceForgeEvent blk]
nodeEventsForges :: [TraceForgeEvent blk]
nodeEventsForges :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (TraceForgeEvent blk)
</span><a href="#local-6989586621679261288"><span class="hs-identifier hs-var hs-var">nodeEventsForges</span></a></span></span><span>
</span><span id="line-1493"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261287"><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
nodeEventsHeaderAdds :: [(SlotNo, RealPoint blk, BlockNo)]
nodeEventsHeaderAdds :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261287"><span class="hs-identifier hs-var hs-var">nodeEventsHeaderAdds</span></a></span></span><span>
</span><span id="line-1494"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261286"><span class="annot"><span class="annottext">[(RealPoint blk, ExtValidationError blk)]
nodeEventsInvalids :: [(RealPoint blk, ExtValidationError blk)]
nodeEventsInvalids :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (RealPoint blk, ExtValidationError blk)
</span><a href="#local-6989586621679261286"><span class="hs-identifier hs-var hs-var">nodeEventsInvalids</span></a></span></span><span>
</span><span id="line-1495"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261285"><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
nodeEventsSelects :: [(SlotNo, RealPoint blk, BlockNo)]
nodeEventsSelects :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, RealPoint blk, BlockNo)
</span><a href="#local-6989586621679261285"><span class="hs-identifier hs-var hs-var">nodeEventsSelects</span></a></span></span><span>
</span><span id="line-1496"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261284"><span class="annot"><span class="annottext">[(SlotNo, WithOrigin BlockNo)]
nodeEventsTipBlockNos :: [(SlotNo, WithOrigin BlockNo)]
nodeEventsTipBlockNos :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (SlotNo, WithOrigin BlockNo)
</span><a href="#local-6989586621679261284"><span class="hs-identifier hs-var hs-var">nodeEventsTipBlockNos</span></a></span></span><span>
</span><span id="line-1497"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261283"><span class="annot"><span class="annottext">[LedgerUpdate blk]
nodeEventsUpdates :: [LedgerUpdate blk]
nodeEventsUpdates :: forall blk (ev :: * -&gt; *).
NodeEvents blk ev -&gt; ev (LedgerUpdate blk)
</span><a href="#local-6989586621679261283"><span class="hs-identifier hs-var hs-var">nodeEventsUpdates</span></a></span></span><span>
</span><span id="line-1498"></span><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeEvents blk []
</span><a href="#local-6989586621679261291"><span class="hs-identifier hs-var">nodeInfoEvents</span></a></span><span>
</span><span id="line-1499"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679261282"><span class="annot"><span class="annottext">nodeOutput :: NodeOutput blk
</span><a href="#local-6989586621679261282"><span class="hs-identifier hs-var hs-var">nodeOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeOutput :: forall blk.
Map SlotNo (Set (RealPoint blk, BlockNo))
-&gt; Map SlotNo [CannotForge blk]
-&gt; Chain blk
-&gt; LedgerState blk
-&gt; Map SlotNo blk
-&gt; Map SlotNo [(RealPoint blk, BlockNo)]
-&gt; Map (RealPoint blk) [ExtValidationError blk]
-&gt; NodeDBs MockFS
-&gt; Map SlotNo [(RealPoint blk, BlockNo)]
-&gt; [LedgerUpdate blk]
-&gt; NodeOutput blk
</span><a href="Test.ThreadNet.Network.html#NodeOutput"><span class="hs-identifier hs-type">NodeOutput</span></a></span><span>
</span><span id="line-1500"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">nodeOutputAdds :: Map SlotNo (Set (RealPoint blk, BlockNo))
</span><a href="Test.ThreadNet.Network.html#nodeOutputAdds"><span class="hs-identifier hs-var">nodeOutputAdds</span></a></span><span>        </span><span class="hs-glyph">=</span><span>
</span><span id="line-1501"></span><span>                  </span><span class="annot"><span class="annottext">(Set (RealPoint blk, BlockNo)
 -&gt; Set (RealPoint blk, BlockNo) -&gt; Set (RealPoint blk, BlockNo))
-&gt; [(SlotNo, Set (RealPoint blk, BlockNo))]
-&gt; Map SlotNo (Set (RealPoint blk, BlockNo))
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromListWith</span></span><span> </span><span class="annot"><span class="annottext">Set (RealPoint blk, BlockNo)
-&gt; Set (RealPoint blk, BlockNo) -&gt; Set (RealPoint blk, BlockNo)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.union</span></span><span> </span><span class="annot"><span class="annottext">([(SlotNo, Set (RealPoint blk, BlockNo))]
 -&gt; Map SlotNo (Set (RealPoint blk, BlockNo)))
-&gt; [(SlotNo, Set (RealPoint blk, BlockNo))]
-&gt; Map SlotNo (Set (RealPoint blk, BlockNo))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1502"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261279"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(RealPoint blk, BlockNo) -&gt; Set (RealPoint blk, BlockNo)
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261277"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261276"><span class="hs-identifier hs-var">bno</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261279"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261279"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261277"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261277"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261276"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261276"><span class="hs-identifier hs-var">bno</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261289"><span class="hs-identifier hs-var">nodeEventsAdds</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1503"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputCannotForges :: Map SlotNo [CannotForge blk]
</span><a href="Test.ThreadNet.Network.html#nodeOutputCannotForges"><span class="hs-identifier hs-var">nodeOutputCannotForges</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1504"></span><span>                  </span><span class="annot"><span class="annottext">([CannotForge blk] -&gt; [CannotForge blk] -&gt; [CannotForge blk])
-&gt; [(SlotNo, [CannotForge blk])] -&gt; Map SlotNo [CannotForge blk]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromListWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([CannotForge blk] -&gt; [CannotForge blk] -&gt; [CannotForge blk])
-&gt; [CannotForge blk] -&gt; [CannotForge blk] -&gt; [CannotForge blk]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[CannotForge blk] -&gt; [CannotForge blk] -&gt; [CannotForge blk]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SlotNo, [CannotForge blk])] -&gt; Map SlotNo [CannotForge blk])
-&gt; [(SlotNo, [CannotForge blk])] -&gt; Map SlotNo [CannotForge blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1505"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261274"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CannotForge blk
</span><a href="#local-6989586621679261273"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TraceNodeCannotForge</span></a></span><span> </span><span id="local-6989586621679261274"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261274"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679261273"><span class="annot"><span class="annottext">CannotForge blk
</span><a href="#local-6989586621679261273"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TraceForgeEvent blk]
</span><a href="#local-6989586621679261288"><span class="hs-identifier hs-var">nodeEventsForges</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1506"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputFinalChain :: Chain blk
</span><a href="Test.ThreadNet.Network.html#nodeOutputFinalChain"><span class="hs-identifier hs-var">nodeOutputFinalChain</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Chain blk
</span><a href="#local-6989586621679261295"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-1507"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputFinalLedger :: LedgerState blk
</span><a href="Test.ThreadNet.Network.html#nodeOutputFinalLedger"><span class="hs-identifier hs-var">nodeOutputFinalLedger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679261294"><span class="hs-identifier hs-var">ldgr</span></a></span><span>
</span><span id="line-1508"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputForges :: Map SlotNo blk
</span><a href="Test.ThreadNet.Network.html#nodeOutputForges"><span class="hs-identifier hs-var">nodeOutputForges</span></a></span><span>      </span><span class="hs-glyph">=</span><span>
</span><span id="line-1509"></span><span>                  </span><span class="annot"><span class="annottext">[(SlotNo, blk)] -&gt; Map SlotNo blk
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(SlotNo, blk)] -&gt; Map SlotNo blk)
-&gt; [(SlotNo, blk)] -&gt; Map SlotNo blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1510"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261271"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679261270"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">TraceForgedBlock</span></a></span><span> </span><span id="local-6989586621679261271"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261271"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679261270"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679261270"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">MempoolSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TraceForgeEvent blk]
</span><a href="#local-6989586621679261288"><span class="hs-identifier hs-var">nodeEventsForges</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1511"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputHeaderAdds :: Map SlotNo [(RealPoint blk, BlockNo)]
</span><a href="Test.ThreadNet.Network.html#nodeOutputHeaderAdds"><span class="hs-identifier hs-var">nodeOutputHeaderAdds</span></a></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-1512"></span><span>                  </span><span class="annot"><span class="annottext">([(RealPoint blk, BlockNo)]
 -&gt; [(RealPoint blk, BlockNo)] -&gt; [(RealPoint blk, BlockNo)])
-&gt; [(SlotNo, [(RealPoint blk, BlockNo)])]
-&gt; Map SlotNo [(RealPoint blk, BlockNo)]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromListWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(RealPoint blk, BlockNo)]
 -&gt; [(RealPoint blk, BlockNo)] -&gt; [(RealPoint blk, BlockNo)])
-&gt; [(RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, BlockNo)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[(RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, BlockNo)] -&gt; [(RealPoint blk, BlockNo)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SlotNo, [(RealPoint blk, BlockNo)])]
 -&gt; Map SlotNo [(RealPoint blk, BlockNo)])
-&gt; [(SlotNo, [(RealPoint blk, BlockNo)])]
-&gt; Map SlotNo [(RealPoint blk, BlockNo)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1513"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261268"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261267"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261266"><span class="hs-identifier hs-var">bno</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261268"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261268"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261267"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261267"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261266"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261266"><span class="hs-identifier hs-var">bno</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261287"><span class="hs-identifier hs-var">nodeEventsHeaderAdds</span></a></span><span>
</span><span id="line-1515"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-1516"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputSelects :: Map SlotNo [(RealPoint blk, BlockNo)]
</span><a href="Test.ThreadNet.Network.html#nodeOutputSelects"><span class="hs-identifier hs-var">nodeOutputSelects</span></a></span><span>     </span><span class="hs-glyph">=</span><span>
</span><span id="line-1517"></span><span>                  </span><span class="annot"><span class="annottext">([(RealPoint blk, BlockNo)]
 -&gt; [(RealPoint blk, BlockNo)] -&gt; [(RealPoint blk, BlockNo)])
-&gt; [(SlotNo, [(RealPoint blk, BlockNo)])]
-&gt; Map SlotNo [(RealPoint blk, BlockNo)]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromListWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(RealPoint blk, BlockNo)]
 -&gt; [(RealPoint blk, BlockNo)] -&gt; [(RealPoint blk, BlockNo)])
-&gt; [(RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, BlockNo)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[(RealPoint blk, BlockNo)]
-&gt; [(RealPoint blk, BlockNo)] -&gt; [(RealPoint blk, BlockNo)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SlotNo, [(RealPoint blk, BlockNo)])]
 -&gt; Map SlotNo [(RealPoint blk, BlockNo)])
-&gt; [(SlotNo, [(RealPoint blk, BlockNo)])]
-&gt; Map SlotNo [(RealPoint blk, BlockNo)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1518"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261265"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261264"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261263"><span class="hs-identifier hs-var">bno</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1519"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261265"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679261265"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261264"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679261264"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679261263"><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679261263"><span class="hs-identifier hs-var">bno</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SlotNo, RealPoint blk, BlockNo)]
</span><a href="#local-6989586621679261285"><span class="hs-identifier hs-var">nodeEventsSelects</span></a></span><span>
</span><span id="line-1520"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-1521"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputInvalids :: Map (RealPoint blk) [ExtValidationError blk]
</span><a href="Test.ThreadNet.Network.html#nodeOutputInvalids"><span class="hs-identifier hs-var">nodeOutputInvalids</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtValidationError blk
-&gt; [ExtValidationError blk] -&gt; [ExtValidationError blk]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExtValidationError blk -&gt; [ExtValidationError blk])
-&gt; Map (RealPoint blk) (ExtValidationError blk)
-&gt; Map (RealPoint blk) [ExtValidationError blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(RealPoint blk, ExtValidationError blk)]
-&gt; Map (RealPoint blk) (ExtValidationError blk)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(RealPoint blk, ExtValidationError blk)]
</span><a href="#local-6989586621679261286"><span class="hs-identifier hs-var">nodeEventsInvalids</span></a></span><span>
</span><span id="line-1522"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputNodeDBs :: NodeDBs MockFS
</span><a href="Test.ThreadNet.Network.html#nodeOutputNodeDBs"><span class="hs-identifier hs-var">nodeOutputNodeDBs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeDBs MockFS
</span><a href="#local-6989586621679261290"><span class="hs-identifier hs-var">nodeInfoDBs</span></a></span><span>
</span><span id="line-1523"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">nodeOutputUpdates :: [LedgerUpdate blk]
</span><a href="Test.ThreadNet.Network.html#nodeOutputUpdates"><span class="hs-identifier hs-var">nodeOutputUpdates</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LedgerUpdate blk]
</span><a href="#local-6989586621679261283"><span class="hs-identifier hs-var">nodeEventsUpdates</span></a></span><span>
</span><span id="line-1524"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-1525"></span><span>
</span><span id="line-1526"></span><span>        </span><span class="annot"><span class="annottext">(Map NodeId (NodeOutput blk),
 Map SlotNo (Map NodeId (WithOrigin BlockNo)))
-&gt; m (Map NodeId (NodeOutput blk),
      Map SlotNo (Map NodeId (WithOrigin BlockNo)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1527"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">NodeId -&gt; NodeOutput blk -&gt; Map NodeId (NodeOutput blk)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679261293"><span class="hs-identifier hs-var">nid</span></a></span><span> </span><span class="annot"><span class="annottext">NodeOutput blk
</span><a href="#local-6989586621679261282"><span class="hs-identifier hs-var">nodeOutput</span></a></span><span>
</span><span id="line-1528"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NodeId -&gt; WithOrigin BlockNo -&gt; Map NodeId (WithOrigin BlockNo)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">NodeId
</span><a href="#local-6989586621679261293"><span class="hs-identifier hs-var">nid</span></a></span><span> </span><span class="annot"><span class="annottext">(WithOrigin BlockNo -&gt; Map NodeId (WithOrigin BlockNo))
-&gt; Map SlotNo (WithOrigin BlockNo)
-&gt; Map SlotNo (Map NodeId (WithOrigin BlockNo))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, WithOrigin BlockNo)] -&gt; Map SlotNo (WithOrigin BlockNo)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(SlotNo, WithOrigin BlockNo)]
</span><a href="#local-6989586621679261284"><span class="hs-identifier hs-var">nodeEventsTipBlockNos</span></a></span><span>
</span><span id="line-1529"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span>
</span><span id="line-1531"></span><span>    </span><span class="annot"><span class="annottext">TestOutput blk -&gt; m (TestOutput blk)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TestOutput blk -&gt; m (TestOutput blk))
-&gt; TestOutput blk -&gt; m (TestOutput blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TestOutput :: forall blk.
Map NodeId (NodeOutput blk)
-&gt; Map SlotNo (Map NodeId (WithOrigin BlockNo)) -&gt; TestOutput blk
</span><a href="Test.ThreadNet.Network.html#TestOutput"><span class="hs-identifier hs-type">TestOutput</span></a></span><span>
</span><span id="line-1532"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">testOutputNodes :: Map NodeId (NodeOutput blk)
</span><a href="Test.ThreadNet.Network.html#testOutputNodes"><span class="hs-identifier hs-var">testOutputNodes</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map NodeId (NodeOutput blk)] -&gt; Map NodeId (NodeOutput blk)
forall (f :: * -&gt; *) k a.
(Foldable f, Ord k) =&gt;
f (Map k a) -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.unions</span></span><span> </span><span class="annot"><span class="annottext">[Map NodeId (NodeOutput blk)]
</span><a href="#local-6989586621679261300"><span class="hs-identifier hs-var">nodeOutputs'</span></a></span><span>
</span><span id="line-1533"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">testOutputTipBlockNos :: Map SlotNo (Map NodeId (WithOrigin BlockNo))
</span><a href="Test.ThreadNet.Network.html#testOutputTipBlockNos"><span class="hs-identifier hs-var">testOutputTipBlockNos</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map NodeId (WithOrigin BlockNo)
 -&gt; Map NodeId (WithOrigin BlockNo)
 -&gt; Map NodeId (WithOrigin BlockNo))
-&gt; [Map SlotNo (Map NodeId (WithOrigin BlockNo))]
-&gt; Map SlotNo (Map NodeId (WithOrigin BlockNo))
forall (f :: * -&gt; *) k a.
(Foldable f, Ord k) =&gt;
(a -&gt; a -&gt; a) -&gt; f (Map k a) -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.unionsWith</span></span><span> </span><span class="annot"><span class="annottext">Map NodeId (WithOrigin BlockNo)
-&gt; Map NodeId (WithOrigin BlockNo)
-&gt; Map NodeId (WithOrigin BlockNo)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.union</span></span><span> </span><span class="annot"><span class="annottext">[Map SlotNo (Map NodeId (WithOrigin BlockNo))]
</span><a href="#local-6989586621679261299"><span class="hs-identifier hs-var">tipBlockNos'</span></a></span><span>
</span><span id="line-1534"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1535"></span><span>
</span><span id="line-1536"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Constraints needed for verbose tracing
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1539"></span><span>
</span><span id="line-1540"></span><span class="hs-comment">-- | Occurs throughout in positions that might be useful for debugging.</span><span>
</span><span id="line-1541"></span><span id="local-6989586621679262849"><span id="local-6989586621679262850"><span class="annot"><a href="Test.ThreadNet.Network.html#nullDebugTracer"><span class="hs-identifier hs-type">nullDebugTracer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679262850"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679262849"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679262850"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262849"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1542"></span><span id="nullDebugTracer"><span class="annot"><span class="annottext">nullDebugTracer :: Tracer m a
</span><a href="Test.ThreadNet.Network.html#nullDebugTracer"><span class="hs-identifier hs-var hs-var">nullDebugTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m a
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span> </span><span class="annot"><span class="annottext">Tracer m a -&gt; Tracer m a -&gt; Tracer m a
forall a. a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`asTypeOf`</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String -&gt; Tracer m a
forall a (m :: * -&gt; *). Show a =&gt; Tracer m String -&gt; Tracer m a
</span><span class="hs-identifier hs-var">showTracing</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String
forall (m :: * -&gt; *). Applicative m =&gt; Tracer m String
</span><span class="hs-identifier hs-var">debugTracer</span></span><span>
</span><span id="line-1543"></span><span>
</span><span id="line-1544"></span><span class="hs-comment">-- | Occurs throughout in positions that might be useful for debugging.</span><span>
</span><span id="line-1545"></span><span id="local-6989586621679262560"><span id="local-6989586621679262561"><span id="local-6989586621679262562"><span class="annot"><a href="Test.ThreadNet.Network.html#nullDebugTracers"><span class="hs-identifier hs-type">nullDebugTracers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1546"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679262562"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1547"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679262561"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-1548"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262560"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1549"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TracingConstraints"><span class="hs-identifier hs-type">TracingConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262560"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1550"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1551"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262562"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262561"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="annot"><a href="#local-6989586621679262560"><span class="hs-identifier hs-type">blk</span></a></span></span></span></span><span>
</span><span id="line-1552"></span><span id="nullDebugTracers"><span class="annot"><span class="annottext">nullDebugTracers :: Tracers m peer Void blk
</span><a href="Test.ThreadNet.Network.html#nullDebugTracers"><span class="hs-identifier hs-var hs-var">nullDebugTracers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers m peer Void blk
forall (m :: * -&gt; *) remotePeer localPeer blk.
Monad m =&gt;
Tracers m remotePeer localPeer blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">nullTracers</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m peer Void blk
-&gt; Tracers m peer Void blk -&gt; Tracers m peer Void blk
forall a. a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`asTypeOf`</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String -&gt; Tracers m peer Void blk
forall blk remotePeer (m :: * -&gt; *) localPeer.
(Show blk, Show (GenTx blk), Show (Validated (GenTx blk)),
 Show (GenTxId blk), Show (ApplyTxErr blk), Show (Header blk),
 Show (ForgeStateInfo blk), Show (ForgeStateUpdateError blk),
 Show (CannotForge blk), Show remotePeer,
 LedgerSupportsProtocol blk) =&gt;
Tracer m String -&gt; Tracers m remotePeer localPeer blk
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">showTracers</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m String
forall (m :: * -&gt; *). Applicative m =&gt; Tracer m String
</span><span class="hs-identifier hs-var">debugTracer</span></span><span>
</span><span id="line-1553"></span><span>
</span><span id="line-1554"></span><span class="hs-comment">-- | Occurs throughout in positions that might be useful for debugging.</span><span>
</span><span id="line-1555"></span><span id="local-6989586621679262490"><span id="local-6989586621679262491"><span id="local-6989586621679262492"><span id="local-6989586621679262493"><span class="annot"><a href="Test.ThreadNet.Network.html#nullDebugProtocolTracers"><span class="hs-identifier hs-type">nullDebugProtocolTracers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1556"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679262493"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1557"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262492"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1558"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TracingConstraints"><span class="hs-identifier hs-type">TracingConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262492"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1559"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679262491"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-1560"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1561"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NTN.Tracers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262491"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262492"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262490"><span class="hs-identifier hs-type">failure</span></a></span></span></span></span></span><span>
</span><span id="line-1562"></span><span id="nullDebugProtocolTracers"><span class="annot"><span class="annottext">nullDebugProtocolTracers :: Tracers m peer blk failure
</span><a href="Test.ThreadNet.Network.html#nullDebugProtocolTracers"><span class="hs-identifier hs-var hs-var">nullDebugProtocolTracers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1563"></span><span>  </span><span class="annot"><span class="annottext">Tracers m peer blk failure
forall (m :: * -&gt; *) peer blk e. Monad m =&gt; Tracers m peer blk e
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.nullTracers</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m peer blk failure
-&gt; Tracers m peer blk failure -&gt; Tracers m peer blk failure
forall a. a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`asTypeOf`</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String -&gt; Tracers m peer blk failure
forall blk peer (m :: * -&gt; *) e.
(Show blk, Show peer, Show (Header blk), Show (GenTx blk),
 Show (GenTxId blk), HasHeader blk, HasNestedContent Header blk) =&gt;
Tracer m String -&gt; Tracers m peer blk e
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-var">NTN.showTracers</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m String
forall (m :: * -&gt; *). Applicative m =&gt; Tracer m String
</span><span class="hs-identifier hs-var">debugTracer</span></span><span>
</span><span id="line-1564"></span><span>
</span><span id="line-1565"></span><span class="hs-comment">-- These constraints are when using @showTracer(s) debugTracer@ instead of</span><span>
</span><span id="line-1566"></span><span class="hs-comment">-- @nullTracer(s)@.</span><span>
</span><span id="line-1567"></span><span class="hs-keyword">type</span><span> </span><span id="TracingConstraints"><span class="annot"><a href="Test.ThreadNet.Network.html#TracingConstraints"><span class="hs-identifier hs-var">TracingConstraints</span></a></span></span><span> </span><span id="local-6989586621679261251"><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1568"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1569"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1570"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1571"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1572"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1573"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1574"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ForgeStateInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1575"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">ForgeStateUpdateError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CannotForge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1577"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">HasNestedContent</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261251"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1578"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-1579"></span><span>
</span><span id="line-1580"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Ancillaries
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1583"></span><span>
</span><span id="line-1584"></span><span class="hs-comment">-- | Spawn multiple async actions and wait for the first one to complete.</span><span>
</span><span id="line-1585"></span><span class="hs-comment">--</span><span>
</span><span id="line-1586"></span><span class="hs-comment">-- Each child thread is spawned with 'withAsync' and so won't outlive this one.</span><span>
</span><span id="line-1587"></span><span class="hs-comment">-- In the use case where each child thread only terminates on an exception, the</span><span>
</span><span id="line-1588"></span><span class="hs-comment">-- 'waitAny' ensures that this parent thread will run until a child terminates</span><span>
</span><span id="line-1589"></span><span class="hs-comment">-- with an exception, and it will also reraise that exception.</span><span>
</span><span id="line-1590"></span><span class="hs-comment">--</span><span>
</span><span id="line-1591"></span><span class="hs-comment">-- Why 'NE.NonEmpty'? An empty argument list would have blocked indefinitely,</span><span>
</span><span id="line-1592"></span><span class="hs-comment">-- which is likely not intended.</span><span>
</span><span id="line-1593"></span><span class="annot"><a href="Test.ThreadNet.Network.html#withAsyncsWaitAny"><span class="hs-identifier hs-type">withAsyncsWaitAny</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679262339"><span class="annot"><a href="#local-6989586621679262339"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262338"><span class="annot"><a href="#local-6989586621679262338"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NE.NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679262339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262338"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679262339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262338"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1594"></span><span id="withAsyncsWaitAny"><span class="annot"><span class="annottext">withAsyncsWaitAny :: NonEmpty (m a) -&gt; m a
</span><a href="Test.ThreadNet.Network.html#withAsyncsWaitAny"><span class="hs-identifier hs-var hs-var">withAsyncsWaitAny</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Async m a] -&gt; [m a] -&gt; m a
forall (f :: * -&gt; *) b. MonadAsync f =&gt; [Async f b] -&gt; [f b] -&gt; f b
</span><a href="#local-6989586621679261250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">([m a] -&gt; m a)
-&gt; (NonEmpty (m a) -&gt; [m a]) -&gt; NonEmpty (m a) -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (m a) -&gt; [m a]
forall a. NonEmpty a -&gt; [a]
</span><span class="hs-identifier hs-var">NE.toList</span></span><span>
</span><span id="line-1595"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1596"></span><span>    </span><span id="local-6989586621679261250"><span class="annot"><span class="annottext">go :: [Async f b] -&gt; [f b] -&gt; f b
</span><a href="#local-6989586621679261250"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679261248"><span class="annot"><span class="annottext">[Async f b]
</span><a href="#local-6989586621679261248"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1597"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Async f b, b) -&gt; b
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Async f b, b) -&gt; b) -&gt; f (Async f b, b) -&gt; f b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Async f b] -&gt; f (Async f b, b)
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
[Async m a] -&gt; m (Async m a, a)
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">waitAny</span></a></span><span> </span><span class="annot"><span class="annottext">[Async f b]
</span><a href="#local-6989586621679261248"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1598"></span><span>      </span><span id="local-6989586621679261246"><span class="annot"><span class="annottext">f b
</span><a href="#local-6989586621679261246"><span class="hs-identifier hs-var">m</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679261245"><span class="annot"><span class="annottext">[f b]
</span><a href="#local-6989586621679261245"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">f b -&gt; (Async f b -&gt; f b) -&gt; f b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-sim-classes-0.2.0.0/noopt/doc/html/io-sim-classes/src"><span class="hs-identifier hs-var">withAsync</span></a></span><span> </span><span class="annot"><span class="annottext">f b
</span><a href="#local-6989586621679261246"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((Async f b -&gt; f b) -&gt; f b) -&gt; (Async f b -&gt; f b) -&gt; f b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679261243"><span class="annot"><span class="annottext">Async f b
</span><a href="#local-6989586621679261243"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Async f b] -&gt; [f b] -&gt; f b
</span><a href="#local-6989586621679261250"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Async f b
</span><a href="#local-6989586621679261243"><span class="hs-identifier hs-var">h</span></a></span><span class="annot"><span class="annottext">Async f b -&gt; [Async f b] -&gt; [Async f b]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Async f b]
</span><a href="#local-6989586621679261248"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[f b]
</span><a href="#local-6989586621679261245"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-1599"></span><span>
</span><span id="line-1600"></span><span class="hs-comment">-- | The partially instantiation of the 'NetworkApplication' type according to</span><span>
</span><span id="line-1601"></span><span class="hs-comment">-- its use in this module</span><span>
</span><span id="line-1602"></span><span class="hs-comment">--</span><span>
</span><span id="line-1603"></span><span class="hs-comment">-- Used internal to this module, essentially as an abbreviation.</span><span>
</span><span id="line-1604"></span><span class="hs-keyword">data</span><span> </span><span id="LimitedApp"><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-var">LimitedApp</span></a></span></span><span> </span><span id="local-6989586621679262483"><span class="annot"><a href="#local-6989586621679262483"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679262482"><span class="annot"><a href="#local-6989586621679262482"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679262481"><span class="annot"><a href="#local-6989586621679262481"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1605"></span><span>   </span><span id="LimitedApp"><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp"><span class="hs-identifier hs-var">LimitedApp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp%27"><span class="hs-identifier hs-type">LimitedApp'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262483"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262482"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262481"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1606"></span><span>
</span><span id="line-1607"></span><span class="hs-comment">-- | Argument of 'LimitedApp' data constructor</span><span>
</span><span id="line-1608"></span><span class="hs-comment">--</span><span>
</span><span id="line-1609"></span><span class="hs-comment">-- Used internal to this module, essentially as an abbreviation.</span><span>
</span><span id="line-1610"></span><span class="hs-keyword">type</span><span> </span><span id="LimitedApp%27"><span class="annot"><a href="Test.ThreadNet.Network.html#LimitedApp%27"><span class="hs-identifier hs-var">LimitedApp'</span></a></span></span><span> </span><span id="local-6989586621679261242"><span class="annot"><a href="#local-6989586621679261242"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679261241"><span class="annot"><a href="#local-6989586621679261241"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679261240"><span class="annot"><a href="#local-6989586621679261240"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1611"></span><span>    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">NTN.Apps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261242"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261241"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-1612"></span><span>        </span><span class="hs-comment">-- The 'ChainSync' and 'BlockFetch' protocols use @'Serialised' x@ for</span><span>
</span><span id="line-1613"></span><span>        </span><span class="hs-comment">-- the servers and @x@ for the clients. Since both have to match to be</span><span>
</span><span id="line-1614"></span><span>        </span><span class="hs-comment">-- sent across a channel, we can't use @'AnyMessage' ..@, instead, we</span><span>
</span><span id="line-1615"></span><span>        </span><span class="hs-comment">-- (de)serialise the messages so that they can be sent across the</span><span>
</span><span id="line-1616"></span><span>        </span><span class="hs-comment">-- channel with the same type on both ends, i.e., 'Lazy.ByteString'.</span><span>
</span><span id="line-1617"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span>
</span><span id="line-1618"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Lazy.ByteString</span></span><span>
</span><span id="line-1619"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">AnyMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">TxSubmission</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261240"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261240"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1620"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">AnyMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">TxSubmission2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261240"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261240"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1621"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-examples-0.1.0.0/noopt/doc/html/typed-protocols-examples/src"><span class="hs-identifier hs-type">AnyMessage</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/src"><span class="hs-identifier hs-type">KeepAlive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1622"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1623"></span><span>
</span><span id="line-1624"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Tracing
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1627"></span><span>
</span><span id="line-1628"></span><span class="hs-keyword">data</span><span> </span><span id="MiniProtocolState"><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolState"><span class="hs-identifier hs-var">MiniProtocolState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MiniProtocolDelayed"><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolDelayed"><span class="hs-identifier hs-var">MiniProtocolDelayed</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="MiniProtocolRestarting"><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolRestarting"><span class="hs-identifier hs-var">MiniProtocolRestarting</span></a></span></span><span>
</span><span id="line-1629"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261234"><span id="local-6989586621679261236"><span id="local-6989586621679261238"><span class="annot"><span class="annottext">Int -&gt; MiniProtocolState -&gt; ShowS
[MiniProtocolState] -&gt; ShowS
MiniProtocolState -&gt; String
(Int -&gt; MiniProtocolState -&gt; ShowS)
-&gt; (MiniProtocolState -&gt; String)
-&gt; ([MiniProtocolState] -&gt; ShowS)
-&gt; Show MiniProtocolState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MiniProtocolState] -&gt; ShowS
$cshowList :: [MiniProtocolState] -&gt; ShowS
show :: MiniProtocolState -&gt; String
$cshow :: MiniProtocolState -&gt; String
showsPrec :: Int -&gt; MiniProtocolState -&gt; ShowS
$cshowsPrec :: Int -&gt; MiniProtocolState -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1630"></span><span>
</span><span id="line-1631"></span><span class="hs-comment">-- | Any synchronous exception from a 'directedEdge'</span><span>
</span><span id="line-1632"></span><span class="hs-keyword">data</span><span> </span><span id="MiniProtocolFatalException"><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolFatalException"><span class="hs-identifier hs-var">MiniProtocolFatalException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MiniProtocolFatalException"><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolFatalException"><span class="hs-identifier hs-var">MiniProtocolFatalException</span></a></span></span><span>
</span><span id="line-1633"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="mpfeType"><span class="annot"><span class="annottext">MiniProtocolFatalException -&gt; TypeRep
</span><a href="Test.ThreadNet.Network.html#mpfeType"><span class="hs-identifier hs-var hs-var">mpfeType</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Typeable.TypeRep</span></span><span>
</span><span id="line-1634"></span><span>    </span><span class="hs-comment">-- ^ Including the type explicitly makes it easier for a human to debug</span><span>
</span><span id="line-1635"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="mpfeExn"><span class="annot"><span class="annottext">MiniProtocolFatalException -&gt; SomeException
</span><a href="Test.ThreadNet.Network.html#mpfeExn"><span class="hs-identifier hs-var hs-var">mpfeExn</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span>
</span><span id="line-1636"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="mpfeClient"><span class="annot"><span class="annottext">MiniProtocolFatalException -&gt; CoreNodeId
</span><a href="Test.ThreadNet.Network.html#mpfeClient"><span class="hs-identifier hs-var hs-var">mpfeClient</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-1637"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="mpfeServer"><span class="annot"><span class="annottext">MiniProtocolFatalException -&gt; CoreNodeId
</span><a href="Test.ThreadNet.Network.html#mpfeServer"><span class="hs-identifier hs-var hs-var">mpfeServer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">CoreNodeId</span></a></span><span>
</span><span id="line-1638"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1639"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261228"><span id="local-6989586621679261230"><span id="local-6989586621679261232"><span class="annot"><span class="annottext">Int -&gt; MiniProtocolFatalException -&gt; ShowS
[MiniProtocolFatalException] -&gt; ShowS
MiniProtocolFatalException -&gt; String
(Int -&gt; MiniProtocolFatalException -&gt; ShowS)
-&gt; (MiniProtocolFatalException -&gt; String)
-&gt; ([MiniProtocolFatalException] -&gt; ShowS)
-&gt; Show MiniProtocolFatalException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MiniProtocolFatalException] -&gt; ShowS
$cshowList :: [MiniProtocolFatalException] -&gt; ShowS
show :: MiniProtocolFatalException -&gt; String
$cshow :: MiniProtocolFatalException -&gt; String
showsPrec :: Int -&gt; MiniProtocolFatalException -&gt; ShowS
$cshowsPrec :: Int -&gt; MiniProtocolFatalException -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1640"></span><span>
</span><span id="line-1641"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679261220"><span id="local-6989586621679261222"><span id="local-6989586621679261224"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#MiniProtocolFatalException"><span class="hs-identifier hs-type">MiniProtocolFatalException</span></a></span></span></span></span><span>
</span><span id="line-1642"></span><span>
</span><span id="line-1643"></span><span class="hs-comment">-- | Our scheme for Just-In-Time EBBs makes some assumptions</span><span>
</span><span id="line-1644"></span><span class="hs-comment">--</span><span>
</span><span id="line-1645"></span><span class="hs-keyword">data</span><span> </span><span id="JitEbbError"><span class="annot"><a href="Test.ThreadNet.Network.html#JitEbbError"><span class="hs-identifier hs-var">JitEbbError</span></a></span></span><span> </span><span id="local-6989586621679262580"><span class="annot"><a href="#local-6989586621679262580"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-1646"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="JitEbbError"><span class="annot"><a href="Test.ThreadNet.Network.html#JitEbbError"><span class="hs-identifier hs-var">JitEbbError</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679262580"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1647"></span><span>    </span><span class="hs-comment">-- ^ we were unable to extend the ledger state with the JIT EBB</span><span>
</span><span id="line-1648"></span><span>
</span><span id="line-1649"></span><span id="local-6989586621679261213"><span id="local-6989586621679261215"><span id="local-6989586621679261217"><span id="local-6989586621679261219"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261219"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#JitEbbError"><span class="hs-identifier hs-type">JitEbbError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261219"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1650"></span><span id="local-6989586621679261212"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679261204"><span id="local-6989586621679261206"><span id="local-6989586621679261208"><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/ouroboros-consensus-0.1.0.0/noopt/doc/html/ouroboros-consensus/src"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261212"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Test.ThreadNet.Network.html#JitEbbError"><span class="hs-identifier hs-type">JitEbbError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679261212"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1651"></span><span>
</span><span id="line-1652"></span><span class="hs-comment">-- | The 'TxGen' generator consecutively failed too many times</span><span>
</span><span id="line-1653"></span><span class="hs-keyword">data</span><span> </span><span id="TxGenFailure"><span class="annot"><a href="Test.ThreadNet.Network.html#TxGenFailure"><span class="hs-identifier hs-var">TxGenFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TxGenFailure"><span class="annot"><a href="Test.ThreadNet.Network.html#TxGenFailure"><span class="hs-identifier hs-var">TxGenFailure</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>   </span><span class="hs-comment">-- ^ how many times it failed</span><span>
</span><span id="line-1654"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679261197"><span id="local-6989586621679261199"><span id="local-6989586621679261201"><span class="annot"><span class="annottext">Int -&gt; TxGenFailure -&gt; ShowS
[TxGenFailure] -&gt; ShowS
TxGenFailure -&gt; String
(Int -&gt; TxGenFailure -&gt; ShowS)
-&gt; (TxGenFailure -&gt; String)
-&gt; ([TxGenFailure] -&gt; ShowS)
-&gt; Show TxGenFailure
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TxGenFailure] -&gt; ShowS
$cshowList :: [TxGenFailure] -&gt; ShowS
show :: TxGenFailure -&gt; String
$cshow :: TxGenFailure -&gt; String
showsPrec :: Int -&gt; TxGenFailure -&gt; ShowS
$cshowsPrec :: Int -&gt; TxGenFailure -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1655"></span><span>
</span><span id="line-1656"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679261189"><span id="local-6989586621679261191"><span id="local-6989586621679261193"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Test.ThreadNet.Network.html#TxGenFailure"><span class="hs-identifier hs-type">TxGenFailure</span></a></span></span></span></span><span>
</span><span id="line-1657"></span></pre></body></html>