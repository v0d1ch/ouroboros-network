<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns             #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns               #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.BlockFetch.Decision</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-7"></a><span>    </span><span class="hs-comment">-- * Deciding what to fetch</span><span>
</span><a name="line-8"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier hs-var">fetchDecisions</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-type">PeerInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier hs-type">FetchDecline</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-comment">-- ** Components of the decision-making process</span><span>
</span><a name="line-16"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier hs-var">filterPlausibleCandidates</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier hs-var">selectForkSuffixes</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier hs-var">filterNotAlreadyFetched</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithPeer</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier hs-var">prioritisePeerChains</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithOtherPeers</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier hs-var">fetchRequestDecisions</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">transpose</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">on</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">assert</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">guard</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">AnchoredFragment</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.Block.html"><span class="hs-identifier">Ouroboros.Network.Block</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.ChainFragment.html"><span class="hs-identifier">Ouroboros.Network.ChainFragment</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Network.ChainFragment.html"><span class="hs-identifier">Ouroboros.Network.ChainFragment</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">ChainFragment</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.BlockFetch.ClientState.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientState</span></a><span>
</span><a name="line-42"></a><span>                   </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>                   </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.DeltaQ</span></a><span>
</span><a name="line-47"></a><span>                   </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span>
</span><a name="line-48"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#PeerFetchInFlightLimits"><span class="hs-identifier hs-type">PeerFetchInFlightLimits</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#calculatePeerFetchInFlightLimits"><span class="hs-identifier hs-var">calculatePeerFetchInFlightLimits</span></a><span>
</span><a name="line-50"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateResponseDeadlineProbability"><span class="hs-identifier hs-var">estimateResponseDeadlineProbability</span></a><span>
</span><a name="line-51"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateExpectedResponseDuration"><span class="hs-identifier hs-var">estimateExpectedResponseDuration</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-keyword">data</span><span> </span><a name="FetchDecisionPolicy"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier">FetchDecisionPolicy</span></a></a><span> </span><a name="local-6989586621679178122"><a href="#local-6989586621679178122"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FetchDecisionPolicy"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier">FetchDecisionPolicy</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-55"></a><span>       </span><a name="maxInFlightReqsPerPeer"><a href="Ouroboros.Network.BlockFetch.Decision.html#maxInFlightReqsPerPeer"><span class="hs-identifier">maxInFlightReqsPerPeer</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- A protocol constant.</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span>       </span><a name="maxConcurrencyBulkSync"><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyBulkSync"><span class="hs-identifier">maxConcurrencyBulkSync</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>       </span><a name="maxConcurrencyDeadline"><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyDeadline"><span class="hs-identifier">maxConcurrencyDeadline</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>       </span><a name="plausibleCandidateChain"><a href="Ouroboros.Network.BlockFetch.Decision.html#plausibleCandidateChain"><span class="hs-identifier">plausibleCandidateChain</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178122"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-61"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178122"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span>       </span><a name="compareCandidateChains"><a href="Ouroboros.Network.BlockFetch.Decision.html#compareCandidateChains"><span class="hs-identifier">compareCandidateChains</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178122"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-64"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178122"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-65"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span>       </span><a name="blockFetchSize"><a href="Ouroboros.Network.BlockFetch.Decision.html#blockFetchSize"><span class="hs-identifier">blockFetchSize</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679178122"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span>
</span><a name="line-68"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">data</span><span> </span><a name="FetchMode"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier">FetchMode</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-72"></a><span>       </span><span class="hs-comment">-- | Use this mode when we are catching up on the chain but are stil</span><span>
</span><a name="line-73"></a><span>       </span><span class="hs-comment">-- well behind. In this mode the fetch logic will optimise for</span><span>
</span><a name="line-74"></a><span>       </span><span class="hs-comment">-- throughput rather than latency.</span><span>
</span><a name="line-75"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-76"></a><span>       </span><a name="FetchModeBulkSync"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeBulkSync"><span class="hs-identifier">FetchModeBulkSync</span></a></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>       </span><span class="hs-comment">-- | Use this mode for block-producing nodes that have a known deadline</span><span>
</span><a name="line-79"></a><span>       </span><span class="hs-comment">-- to produce a block and need to get the best chain before that. In</span><span>
</span><a name="line-80"></a><span>       </span><span class="hs-comment">-- this mode the fetch logic will optimise for picking the best chain</span><span>
</span><a name="line-81"></a><span>       </span><span class="hs-comment">-- within the given deadline.</span><span>
</span><a name="line-82"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="FetchModeDeadline"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeDeadline"><span class="hs-identifier">FetchModeDeadline</span></a></a><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>       </span><span class="hs-comment">-- TODO: add an additional mode for in-between: when we are a core node</span><span>
</span><a name="line-85"></a><span>       </span><span class="hs-comment">-- following the chain but do not have an imminent deadline, or are a</span><span>
</span><a name="line-86"></a><span>       </span><span class="hs-comment">-- relay forwarding chains within the network.</span><span>
</span><a name="line-87"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-88"></a><span>       </span><span class="hs-comment">-- This is a mixed mode because we have to combine the distribution of</span><span>
</span><a name="line-89"></a><span>       </span><span class="hs-comment">-- time to next block under praos, with the distribution of latency of</span><span>
</span><a name="line-90"></a><span>       </span><span class="hs-comment">-- our peers, and also the consensus preference.</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-keyword">type</span><span> </span><a name="PeerInfo"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier">PeerInfo</span></a></a><span> </span><a name="local-6989586621679178120"><a href="#local-6989586621679178120"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621679178121"><a href="#local-6989586621679178121"><span class="hs-identifier">extra</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a><span> </span><a href="#local-6989586621679178120"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>         </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178120"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>         </span><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>         </span><a href="#local-6989586621679178121"><span class="hs-identifier hs-type">extra</span></a><span>
</span><a name="line-100"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- | Throughout the decision making process we accumulate reasons to decline</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- to fetch any blocks. This type is used to wrap intermediate and final</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- results.</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-keyword">type</span><span> </span><a name="FetchDecision"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier">FetchDecision</span></a></a><span> </span><a name="local-6989586621679178119"><a href="#local-6989586621679178119"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier hs-type">FetchDecline</span></a><span> </span><a href="#local-6989586621679178119"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | All the various reasons we can decide not to fetch blocks from a peer.</span><span>
</span><a name="line-109"></a><span class="hs-comment">--</span><span>
</span><a name="line-110"></a><span class="hs-keyword">data</span><span> </span><a name="FetchDecline"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier">FetchDecline</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-111"></a><span>     </span><a name="FetchDeclineChainNotPlausible"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainNotPlausible"><span class="hs-identifier">FetchDeclineChainNotPlausible</span></a></a><span>
</span><a name="line-112"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineChainNoIntersection"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainNoIntersection"><span class="hs-identifier">FetchDeclineChainNoIntersection</span></a></a><span>
</span><a name="line-113"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineAlreadyFetched"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineAlreadyFetched"><span class="hs-identifier">FetchDeclineAlreadyFetched</span></a></a><span>
</span><a name="line-114"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineInFlightThisPeer"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightThisPeer"><span class="hs-identifier">FetchDeclineInFlightThisPeer</span></a></a><span>
</span><a name="line-115"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineInFlightOtherPeer"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightOtherPeer"><span class="hs-identifier">FetchDeclineInFlightOtherPeer</span></a></a><span>
</span><a name="line-116"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclinePeerShutdown"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerShutdown"><span class="hs-identifier">FetchDeclinePeerShutdown</span></a></a><span>
</span><a name="line-117"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclinePeerSlow"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerSlow"><span class="hs-identifier">FetchDeclinePeerSlow</span></a></a><span>
</span><a name="line-118"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineReqsInFlightLimit"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineReqsInFlightLimit"><span class="hs-identifier">FetchDeclineReqsInFlightLimit</span></a></a><span>  </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-119"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineBytesInFlightLimit"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineBytesInFlightLimit"><span class="hs-identifier">FetchDeclineBytesInFlightLimit</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span>
</span><a name="line-120"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclinePeerBusy"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerBusy"><span class="hs-identifier">FetchDeclinePeerBusy</span></a></a><span>           </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span>
</span><a name="line-121"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="FetchDeclineConcurrencyLimit"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineConcurrencyLimit"><span class="hs-identifier">FetchDeclineConcurrencyLimit</span></a></a><span>   </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- | The \&quot;oh noes?!\&quot; operator.</span><span>
</span><a name="line-126"></a><span class="hs-comment">--</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- In the case of an error, the operator provides a specific error value.</span><span>
</span><a name="line-128"></a><span class="hs-comment">--</span><span>
</span><a name="line-129"></a><span class="hs-special">(</span><span class="hs-operator">?!</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679178166"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178167"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679178167"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679178166"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-130"></a><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679178168"><a href="#local-6989586621679178168"><span class="hs-identifier">x</span></a></a><span>  </span><a name="%3F%21"><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator">?!</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679178168"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-131"></a><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator">?!</span><span> </span><a name="local-6989586621679178169"><a href="#local-6989586621679178169"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span>  </span><a href="#local-6989586621679178169"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-comment">-- | The combination of a 'ChainSuffix' and a list of discontiguous</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- 'ChainFragment's:</span><span>
</span><a name="line-135"></a><span class="hs-comment">--</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- * When comparing two 'CandidateFragments' as candidate chains, we use the</span><span>
</span><a name="line-137"></a><span class="hs-comment">--   'ChainSuffix'.</span><span>
</span><a name="line-138"></a><span class="hs-comment">--</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- * To track which blocks of that candidate still have to be downloaded, we</span><span>
</span><a name="line-140"></a><span class="hs-comment">--   use a list of discontiguous 'ChainFragment's.</span><span>
</span><a name="line-141"></a><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span class="hs-keyword">type</span><span> </span><a name="CandidateFragments"><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier">CandidateFragments</span></a></a><span> </span><a name="local-6989586621679178118"><a href="#local-6989586621679178118"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a><span> </span><a href="#local-6989586621679178118"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178118"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">fetchDecisions</span><span>
</span><a name="line-146"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178164"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">,</span><span>
</span><a name="line-147"></a><span>      </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">~</span><span> </span><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679178164"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-149"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span>
</span><a name="line-150"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a><span> </span><a href="#local-6989586621679178164"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span>
</span><a name="line-153"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-type">PeerInfo</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679178165"><span class="hs-identifier hs-type">extra</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-type">PeerInfo</span></a><span> </span><a href="#local-6989586621679178163"><span class="hs-identifier hs-type">header</span></a><span> </span><a href="#local-6989586621679178165"><span class="hs-identifier hs-type">extra</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-155"></a><a name="fetchDecisions"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier">fetchDecisions</span></a></a><span> </span><a name="local-6989586621679178170"><a href="#local-6989586621679178170"><span class="hs-identifier">fetchDecisionPolicy</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-var">FetchDecisionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-156"></a><span>                 </span><a name="local-6989586621679178171"><a href="#local-6989586621679178171"><span class="hs-identifier">plausibleCandidateChain</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-157"></a><span>                 </span><a name="local-6989586621679178172"><a href="#local-6989586621679178172"><span class="hs-identifier">compareCandidateChains</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-158"></a><span>                 </span><a name="local-6989586621679178173"><a href="#local-6989586621679178173"><span class="hs-identifier">blockFetchSize</span></a></a><span>
</span><a name="line-159"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-160"></a><span>               </span><a name="local-6989586621679178174"><a href="#local-6989586621679178174"><span class="hs-identifier">fetchMode</span></a></a><span>
</span><a name="line-161"></a><span>               </span><a name="local-6989586621679178175"><a href="#local-6989586621679178175"><span class="hs-identifier">currentChain</span></a></a><span>
</span><a name="line-162"></a><span>               </span><a name="local-6989586621679178176"><a href="#local-6989586621679178176"><span class="hs-identifier">fetchedBlocks</span></a></a><span>
</span><a name="line-163"></a><span>               </span><a name="local-6989586621679178177"><a href="#local-6989586621679178177"><span class="hs-identifier">fetchedMaxSlotNo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>    </span><span class="hs-comment">-- Finally, make a decision for each (chain, peer) pair.</span><span>
</span><a name="line-166"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier hs-var">fetchRequestDecisions</span></a><span>
</span><a name="line-167"></a><span>      </span><a href="#local-6989586621679178170"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a><span>
</span><a name="line-168"></a><span>      </span><a href="#local-6989586621679178174"><span class="hs-identifier hs-var">fetchMode</span></a><span>
</span><a name="line-169"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679178181"><span class="hs-identifier hs-var">swizzleSIG</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-comment">-- Filter to keep blocks that are not already in-flight with other peers.</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithOtherPeers</span></a><span>
</span><a name="line-173"></a><span>      </span><a href="#local-6989586621679178174"><span class="hs-identifier hs-var">fetchMode</span></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679178180"><span class="hs-identifier hs-var">swizzleSI</span></a><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span>    </span><span class="hs-comment">-- Reorder chains based on consensus policy and network timing data.</span><span>
</span><a name="line-177"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier hs-var">prioritisePeerChains</span></a><span>
</span><a name="line-178"></a><span>      </span><a href="#local-6989586621679178174"><span class="hs-identifier hs-var">fetchMode</span></a><span>
</span><a name="line-179"></a><span>      </span><a href="#local-6989586621679178172"><span class="hs-identifier hs-var">compareCandidateChains</span></a><span>
</span><a name="line-180"></a><span>      </span><a href="#local-6989586621679178173"><span class="hs-identifier hs-var">blockFetchSize</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679178179"><span class="hs-identifier hs-var">swizzleIG</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-comment">-- Filter to keep blocks that are not already in-flight for this peer.</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithPeer</span></a><span>
</span><a name="line-185"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679178178"><span class="hs-identifier hs-var">swizzleI</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-comment">-- Filter to keep blocks that have not already been downloaded.</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier hs-var">filterNotAlreadyFetched</span></a><span>
</span><a name="line-189"></a><span>      </span><a href="#local-6989586621679178176"><span class="hs-identifier hs-var">fetchedBlocks</span></a><span>
</span><a name="line-190"></a><span>      </span><a href="#local-6989586621679178177"><span class="hs-identifier hs-var">fetchedMaxSlotNo</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-comment">-- Select the suffix up to the intersection with the current chain.</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier hs-var">selectForkSuffixes</span></a><span>
</span><a name="line-194"></a><span>      </span><a href="#local-6989586621679178175"><span class="hs-identifier hs-var">currentChain</span></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-comment">-- First, filter to keep chains the consensus layer tells us are plausible.</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier hs-var">filterPlausibleCandidates</span></a><span>
</span><a name="line-198"></a><span>      </span><a href="#local-6989586621679178171"><span class="hs-identifier hs-var">plausibleCandidateChain</span></a><span>
</span><a name="line-199"></a><span>      </span><a href="#local-6989586621679178175"><span class="hs-identifier hs-var">currentChain</span></a><span>
</span><a name="line-200"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-comment">-- Data swizzling functions to get the right info into each stage.</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679178178"><a href="#local-6989586621679178178"><span class="hs-identifier">swizzleI</span></a></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621679178182"><a href="#local-6989586621679178182"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178183"><a href="#local-6989586621679178183"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>     </span><a name="local-6989586621679178184"><a href="#local-6989586621679178184"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178182"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span>         </span><a href="#local-6989586621679178184"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">,</span><span>       </span><a href="#local-6989586621679178183"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>    </span><a name="local-6989586621679178179"><a href="#local-6989586621679178179"><span class="hs-identifier">swizzleIG</span></a></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679178185"><a href="#local-6989586621679178185"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178186"><a href="#local-6989586621679178186"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>     </span><a name="local-6989586621679178187"><a href="#local-6989586621679178187"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><a name="local-6989586621679178188"><a href="#local-6989586621679178188"><span class="hs-identifier">gsvs</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178185"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span>         </span><a href="#local-6989586621679178187"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178188"><span class="hs-identifier hs-var">gsvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178186"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>    </span><a name="local-6989586621679178180"><a href="#local-6989586621679178180"><span class="hs-identifier">swizzleSI</span></a></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679178189"><a href="#local-6989586621679178189"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178190"><a href="#local-6989586621679178190"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679178191"><a href="#local-6989586621679178191"><span class="hs-identifier">status</span></a></a><span class="hs-special">,</span><a name="local-6989586621679178192"><a href="#local-6989586621679178192"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178189"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178191"><span class="hs-identifier hs-var">status</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178192"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">,</span><span>       </span><a href="#local-6989586621679178190"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>    </span><a name="local-6989586621679178181"><a href="#local-6989586621679178181"><span class="hs-identifier">swizzleSIG</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679178193"><a href="#local-6989586621679178193"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178194"><a href="#local-6989586621679178194"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679178195"><a href="#local-6989586621679178195"><span class="hs-identifier">status</span></a></a><span class="hs-special">,</span><a name="local-6989586621679178196"><a href="#local-6989586621679178196"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><a name="local-6989586621679178197"><a href="#local-6989586621679178197"><span class="hs-identifier">gsvs</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178193"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178195"><span class="hs-identifier hs-var">status</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178196"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178197"><span class="hs-identifier hs-var">gsvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178194"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">{-
We have the node's /current/ or /adopted/ chain. This is the node's chain in
the sense specified by the Ouroboros algorithm. It is a fully verified chain
with block bodies and a ledger state.

    &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472; current chain length (block number)

With chain selection we are interested in /candidate/ chains. We have these
candidate chains in the form of chains of verified headers, but without bodies.

The consensus layer gives us the current set of candidate chains from our peers
and we have the task of selecting which block bodies to download, and then
passing those block bodes back to the consensus layer. The consensus layer will
try to validate them and decide if it wants to update its current chain.

    &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9492;&#9472;&#9472;&#9472;&#9496;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; current chain length
              &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
  current     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9492;&#9472;&#9472;&#9472;&#9496;
  (blocks)    &#9474;   &#9474;     &#9474;   &#9474;
              &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;
                A         B         C         D
             candidates
             (headers)

In this example we have four candidate chains, with all but chain D strictly
longer than our current chain.

In general there are many candidate chains. We make a distinction between a
candidate chain and the peer from which it is available. It is often the
case that the same chain is available from multiple peers. We will try to be
clear about when we are referring to chains or the combination of a chain and
the peer from which it is available.

For the sake of the example let us assume we have the four chains above
available from the following peers.

peer    1         2         3         4         5         6         7
      &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
    &#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
      &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
                &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
                &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;               &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;
chain   C         A         B         A         D         B         A

This is the form in which we are informed about candidate chains from the
consensus layer, the combination of a chain and the peer it is from. This
makes sense, since these things change independently.

We will process the chains in this form, keeping the peer/chain combination all
the way through. Although there could in principle be some opportunistic saving
by sharing when multiple peers provide the same chain, taking advantage of this
adds complexity and does nothing to improve our worst case costs.

We are only interested in candidate chains that are strictly longer than our
current chain. So our first task is to filter down to this set.
-}</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-comment">-- | Keep only those candidate chains that are preferred over the current</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- chain. Typically, this means that their length is longer than the length of</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- the current chain.</span><span>
</span><a name="line-291"></a><span class="hs-comment">--</span><span>
</span><a name="line-292"></a><span class="hs-identifier">filterPlausibleCandidates</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178160"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178161"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178160"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178161"><span class="hs-identifier hs-type">block</span></a><span>  </span><span class="hs-comment">-- ^ The current chain</span><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178160"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178162"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-297"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178160"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178162"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-298"></a><a name="filterPlausibleCandidates"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier">filterPlausibleCandidates</span></a></a><span> </span><a name="local-6989586621679178198"><a href="#local-6989586621679178198"><span class="hs-identifier">plausibleCandidateChain</span></a></a><span> </span><a name="local-6989586621679178199"><a href="#local-6989586621679178199"><span class="hs-identifier">currentChain</span></a></a><span> </span><a name="local-6989586621679178200"><a href="#local-6989586621679178200"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178203"><span class="hs-identifier hs-var">chain'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178202"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178201"><a href="#local-6989586621679178201"><span class="hs-identifier">chain</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621679178202"><a href="#local-6989586621679178202"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178200"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-301"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178203"><a href="#local-6989586621679178203"><span class="hs-identifier">chain'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-302"></a><span>            </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178198"><span class="hs-identifier hs-var">plausibleCandidateChain</span></a><span> </span><a href="#local-6989586621679178199"><span class="hs-identifier hs-var">currentChain</span></a><span> </span><a href="#local-6989586621679178201"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>              </span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainNotPlausible"><span class="hs-identifier hs-var">FetchDeclineChainNotPlausible</span></a><span>
</span><a name="line-304"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679178201"><span class="hs-identifier hs-var">chain</span></a><span>
</span><a name="line-305"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">{-
In the example, this leaves us with only the candidate chains: A, B and C, but
still paired up with the various peers.


peer    1         2         3         4                   6         7
      &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;               &#9478;   &#9478;     &#9478;   &#9478;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
    &#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
      &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
                &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
                &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;               &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;
chain   C         A         B         A                   B         A
-}</span><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">{-
Of course we would at most need to download the blocks in a candidate chain
that are not already in the current chain. So we must find those intersections.

Before we do that, lets define how we represent a suffix of a chain. We do this
very simply as a chain fragment: exactly those blocks contained in the suffix.
A chain fragment is of course not a chain, but has many similar invariants.

We will later also need to represent chain ranges when we send block fetch
requests. We do this using a pair of points: the first and last blocks in the
range.  While we can represent an empty chain fragment, we cannot represent an
empty fetch range, but this is ok since we never request empty ranges.

 Chain fragment
    &#9484;&#9472;&#9472;&#9472;&#9488;
    &#9474; &#9673; &#9474; Start of range, inclusive
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474; &#9673; &#9474; End of range, inclusive.
    &#9492;&#9472;&#9472;&#9472;&#9496;
-}</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-comment">-- | A chain suffix, obtained by intersecting a candidate chain with the</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- current chain.</span><span>
</span><a name="line-357"></a><span class="hs-comment">--</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- The anchor point of a 'ChainSuffix' will be a point within the bounds of</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- the currrent chain ('AnchoredFragment.withinFragmentBounds'), indicating</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- that it forks off in the last @K@ blocks.</span><span>
</span><a name="line-361"></a><span class="hs-comment">--</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- A 'ChainSuffix' must be non-empty, as an empty suffix, i.e. the candidate</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- chain is equal to the current chain, would not be a plausible candidate.</span><span>
</span><a name="line-364"></a><span class="hs-keyword">newtype</span><span> </span><a name="ChainSuffix"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier">ChainSuffix</span></a></a><span> </span><a name="local-6989586621679178117"><a href="#local-6989586621679178117"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-365"></a><span>    </span><a name="ChainSuffix"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier">ChainSuffix</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="getChainSuffix"><a href="Ouroboros.Network.BlockFetch.Decision.html#getChainSuffix"><span class="hs-identifier">getChainSuffix</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178117"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">{-
We define the /chain suffix/ as the suffix of the candidate chain up until (but
not including) where it intersects the current chain.


   current    peer 1    peer 2

    &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;  &#9664;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9484;&#9472;&#9538;&#9472;&#9488;
    &#9474;   &#9474;               &#9474; &#9673; &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;               &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;  &#9664;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;       &#9474;   &#9474;
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9472;&#9472;&#9516;&#9472;&#9538;&#9472;&#9516;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;
              &#9474; &#9673; &#9474;     &#9474;   &#9474;
              &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;
                        &#9474; &#9673; &#9474;
                        &#9492;&#9472;&#9472;&#9472;&#9496;
                C         A

In this example we found that C was a strict extension of the current chain
and chain A was a short fork.

Note that it's possible that we don't find any intersection within the last K
blocks. This means the candidate forks by more than K and so we are not
interested in this candidate at all.
-}</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-comment">-- | Find the chain suffix for a candidate chain, with respect to the</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- current chain.</span><span>
</span><a name="line-400"></a><span class="hs-comment">--</span><span>
</span><a name="line-401"></a><span class="hs-identifier">chainForkSuffix</span><span>
</span><a name="line-402"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178158"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178159"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">,</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><a href="#local-6989586621679178158"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">~</span><span> </span><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679178159"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178159"><span class="hs-identifier hs-type">block</span></a><span>  </span><span class="hs-comment">-- ^ Current chain.</span><span>
</span><a name="line-405"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178158"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-comment">-- ^ Candidate chain</span><span>
</span><a name="line-406"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a><span> </span><a href="#local-6989586621679178158"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><a name="chainForkSuffix"><a href="Ouroboros.Network.BlockFetch.Decision.html#chainForkSuffix"><span class="hs-identifier">chainForkSuffix</span></a></a><span> </span><a name="local-6989586621679178204"><a href="#local-6989586621679178204"><span class="hs-identifier">current</span></a></a><span> </span><a name="local-6989586621679178205"><a href="#local-6989586621679178205"><span class="hs-identifier">candidate</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-408"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#intersect"><span class="hs-identifier hs-var">AnchoredFragment.intersect</span></a><span> </span><a href="#local-6989586621679178204"><span class="hs-identifier hs-var">current</span></a><span> </span><a href="#local-6989586621679178205"><span class="hs-identifier hs-var">candidate</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-409"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-410"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178206"><a href="#local-6989586621679178206"><span class="hs-identifier">candidateSuffix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-411"></a><span>        </span><span class="hs-comment">-- If the suffix is empty, it means the candidate chain was equal to</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-comment">-- the current chain and didn't fork off. Such a candidate chain is</span><span>
</span><a name="line-413"></a><span>        </span><span class="hs-comment">-- not a plausible candidate, so it must have been filtered out.</span><span>
</span><a name="line-414"></a><span>        </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#null"><span class="hs-identifier hs-var">AnchoredFragment.null</span></a><span> </span><a href="#local-6989586621679178206"><span class="hs-identifier hs-var">candidateSuffix</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-415"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-var">ChainSuffix</span></a><span> </span><a href="#local-6989586621679178206"><span class="hs-identifier hs-var">candidateSuffix</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-identifier">selectForkSuffixes</span><span>
</span><a name="line-418"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178155"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178156"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">,</span><span>
</span><a name="line-419"></a><span>      </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><a href="#local-6989586621679178155"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">~</span><span> </span><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679178156"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178156"><span class="hs-identifier hs-type">block</span></a><span>
</span><a name="line-421"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178155"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178157"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-422"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a><span>      </span><a href="#local-6989586621679178155"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178157"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-423"></a><a name="selectForkSuffixes"><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier">selectForkSuffixes</span></a></a><span> </span><a name="local-6989586621679178207"><a href="#local-6989586621679178207"><span class="hs-identifier">current</span></a></a><span> </span><a name="local-6989586621679178208"><a href="#local-6989586621679178208"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178211"><span class="hs-identifier hs-var">mchain'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178210"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-425"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178209"><a href="#local-6989586621679178209"><span class="hs-identifier">mchain</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621679178210"><a href="#local-6989586621679178210"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178208"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-426"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178211"><a href="#local-6989586621679178211"><span class="hs-identifier">mchain'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-427"></a><span>            </span><a name="local-6989586621679178212"><a href="#local-6989586621679178212"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178209"><span class="hs-identifier hs-var">mchain</span></a><span>
</span><a name="line-428"></a><span>            </span><a href="Ouroboros.Network.BlockFetch.Decision.html#chainForkSuffix"><span class="hs-identifier hs-var">chainForkSuffix</span></a><span> </span><a href="#local-6989586621679178207"><span class="hs-identifier hs-var">current</span></a><span> </span><a href="#local-6989586621679178212"><span class="hs-identifier hs-var">chain</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainNoIntersection"><span class="hs-identifier hs-var">FetchDeclineChainNoIntersection</span></a><span>
</span><a name="line-429"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">{-
We define the /fetch range/ as the suffix of the fork range that has not yet
had its blocks downloaded and block content checked against the headers.

    &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9484;&#9472;&#9472;&#9472;&#9488;
    &#9474;   &#9474;    already    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;    fetched    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;    blocks     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;               &#9474;&#9617;&#9673;&#9617;&#9474;  &#9668;  fetch range
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;
              &#9474;&#9617;&#9673;&#9617;&#9474; &#9668;   &#9474;&#9617;&#9617;&#9617;&#9474;
              &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;
                        &#9474;&#9617;&#9673;&#9617;&#9474;  &#9668;
                        &#9492;&#9472;&#9472;&#9472;&#9496;

In earlier versions of this scheme we maintained and relied on the invariant
that the ranges of fetched blocks are backwards closed. This meant we never had
discontinuous ranges of fetched or not-yet-fetched blocks. This invariant does
simplify things somewhat by keeping the ranges continuous however it precludes
fetching ranges of blocks from different peers in parallel.

We do not maintain any such invariant and so we have to deal with there being
gaps in the ranges we have already fetched or are yet to fetch. To keep the
tracking simple we do not track the ranges themselves, rather we track the set
of individual blocks without their relationship to each other.

-}</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-comment">-- | Find the fragments of the chain suffix that we still need to fetch, these</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- are the fragments covering blocks that have not yet been fetched and are</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- not currently in the process of being fetched from this peer.</span><span>
</span><a name="line-466"></a><span class="hs-comment">--</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- Typically this is a single fragment forming a suffix of the chain, but in</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- the general case we can get a bunch of discontiguous chain fragments.</span><span>
</span><a name="line-469"></a><span class="hs-comment">--</span><span>
</span><a name="line-470"></a><span class="hs-identifier">filterNotAlreadyFetched</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178152"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><a href="#local-6989586621679178152"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">~</span><span> </span><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span> </span><a href="#local-6989586621679178153"><span class="hs-identifier hs-type">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a><span> </span><a href="#local-6989586621679178153"><span class="hs-identifier hs-type">block</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span>
</span><a name="line-474"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a><span>        </span><a href="#local-6989586621679178152"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178154"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-475"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a><span> </span><a href="#local-6989586621679178152"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178154"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-476"></a><a name="filterNotAlreadyFetched"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier">filterNotAlreadyFetched</span></a></a><span> </span><a name="local-6989586621679178213"><a href="#local-6989586621679178213"><span class="hs-identifier">alreadyDownloaded</span></a></a><span> </span><a name="local-6989586621679178214"><a href="#local-6989586621679178214"><span class="hs-identifier">fetchedMaxSlotNo</span></a></a><span> </span><a name="local-6989586621679178215"><a href="#local-6989586621679178215"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-477"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178219"><span class="hs-identifier hs-var">mcandidates</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178218"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178217"><a href="#local-6989586621679178217"><span class="hs-identifier">mcandidate</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621679178218"><a href="#local-6989586621679178218"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178215"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-479"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178219"><a href="#local-6989586621679178219"><span class="hs-identifier">mcandidates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-480"></a><span>            </span><a name="local-6989586621679178220"><a href="#local-6989586621679178220"><span class="hs-identifier">candidate</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178217"><span class="hs-identifier hs-var">mcandidate</span></a><span>
</span><a name="line-481"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178221"><a href="#local-6989586621679178221"><span class="hs-identifier">chainfragment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">AnchoredFragment.unanchorFragment</span><span>
</span><a name="line-482"></a><span>                              </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">getChainSuffix</span><span> </span><a href="#local-6989586621679178220"><span class="hs-identifier hs-var">candidate</span></a><span>
</span><a name="line-483"></a><span>                </span><a name="local-6989586621679178222"><a href="#local-6989586621679178222"><span class="hs-identifier">fragments</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a><span>
</span><a name="line-484"></a><span>                              </span><a href="#local-6989586621679178216"><span class="hs-identifier hs-var">notAlreadyFetched</span></a><span>
</span><a name="line-485"></a><span>                              </span><a href="#local-6989586621679178214"><span class="hs-identifier hs-var">fetchedMaxSlotNo</span></a><span>
</span><a name="line-486"></a><span>                              </span><a href="#local-6989586621679178221"><span class="hs-identifier hs-var">chainfragment</span></a><span>
</span><a name="line-487"></a><span>            </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679178222"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineAlreadyFetched"><span class="hs-identifier hs-var">FetchDeclineAlreadyFetched</span></a><span>
</span><a name="line-488"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178220"><span class="hs-identifier hs-var">candidate</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178222"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-490"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-491"></a><span>    </span><a name="local-6989586621679178216"><a href="#local-6989586621679178216"><span class="hs-identifier">notAlreadyFetched</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679178213"><span class="hs-identifier hs-var">alreadyDownloaded</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.Block.html#castPoint"><span class="hs-identifier hs-var">castPoint</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.Block.html#blockPoint"><span class="hs-identifier hs-var">blockPoint</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-identifier">filterNotAlreadyInFlightWithPeer</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178150"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a><span> </span><a href="#local-6989586621679178150"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178150"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-497"></a><span>                                                  </span><a href="#local-6989586621679178151"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a><span> </span><a href="#local-6989586621679178150"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178151"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-499"></a><a name="filterNotAlreadyInFlightWithPeer"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier">filterNotAlreadyInFlightWithPeer</span></a></a><span> </span><a name="local-6989586621679178223"><a href="#local-6989586621679178223"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-500"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178230"><span class="hs-identifier hs-var">mcandidatefragments'</span></a><span class="hs-special">,</span><span>          </span><a href="#local-6989586621679178229"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178227"><a href="#local-6989586621679178227"><span class="hs-identifier">mcandidatefragments</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178228"><a href="#local-6989586621679178228"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178229"><a href="#local-6989586621679178229"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178223"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-502"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178230"><a href="#local-6989586621679178230"><span class="hs-identifier">mcandidatefragments'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-503"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679178231"><a href="#local-6989586621679178231"><span class="hs-identifier">candidate</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178232"><a href="#local-6989586621679178232"><span class="hs-identifier">chainfragments</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178227"><span class="hs-identifier hs-var">mcandidatefragments</span></a><span>
</span><a name="line-504"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178233"><a href="#local-6989586621679178233"><span class="hs-identifier">fragments</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a><span>
</span><a name="line-505"></a><span>                                         </span><span class="hs-special">(</span><a href="#local-6989586621679178224"><span class="hs-identifier hs-var">notAlreadyInFlight</span></a><span> </span><a href="#local-6989586621679178228"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier">peerFetchMaxSlotNo</span><span> </span><a href="#local-6989586621679178228"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>                                      </span><a href="#local-6989586621679178232"><span class="hs-identifier hs-var">chainfragments</span></a><span>
</span><a name="line-508"></a><span>            </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679178233"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightThisPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightThisPeer</span></a><span>
</span><a name="line-509"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178231"><span class="hs-identifier hs-var">candidate</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178233"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-511"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-512"></a><span>    </span><a name="local-6989586621679178224"><a href="#local-6989586621679178224"><span class="hs-identifier">notAlreadyInFlight</span></a></a><span> </span><a name="local-6989586621679178225"><a href="#local-6989586621679178225"><span class="hs-identifier">inflight</span></a></a><span> </span><a name="local-6989586621679178226"><a href="#local-6989586621679178226"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-513"></a><span>      </span><a href="Ouroboros.Network.Block.html#blockPoint"><span class="hs-identifier hs-var">blockPoint</span></a><span> </span><a href="#local-6989586621679178226"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.notMember</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">peerFetchBlocksInFlight</span><span> </span><a href="#local-6989586621679178225"><span class="hs-identifier hs-var">inflight</span></a><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span class="hs-comment">-- | A penultimate step of filtering, but this time across peers, rather than</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- individually for each peer. If we're following the parallel fetch</span><span>
</span><a name="line-518"></a><span class="hs-comment">-- mode then we filter out blocks that are already in-flight with other</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- peers.</span><span>
</span><a name="line-520"></a><span class="hs-comment">--</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- Note that this does /not/ cover blocks that are proposed to be fetched in</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- this round of decisions. That step is covered  in 'fetchRequestDecisions'.</span><span>
</span><a name="line-523"></a><span class="hs-comment">--</span><span>
</span><a name="line-524"></a><span class="hs-identifier">filterNotAlreadyInFlightWithOtherPeers</span><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178148"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span>
</span><a name="line-527"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178148"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a><span> </span><a href="#local-6989586621679178148"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-528"></a><span>                                             </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178148"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-529"></a><span>                                             </span><a href="#local-6989586621679178149"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178148"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178149"><span class="hs-identifier hs-type">peerinfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><a name="filterNotAlreadyInFlightWithOtherPeers"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier">filterNotAlreadyInFlightWithOtherPeers</span></a></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeDeadline"><span class="hs-identifier hs-var">FetchModeDeadline</span></a><span> </span><a name="local-6989586621679178234"><a href="#local-6989586621679178234"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-533"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178235"><span class="hs-identifier hs-var">mchainfragments</span></a><span class="hs-special">,</span><span>       </span><a href="#local-6989586621679178236"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178235"><a href="#local-6989586621679178235"><span class="hs-identifier">mchainfragments</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178236"><a href="#local-6989586621679178236"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178234"><span class="hs-identifier hs-var">chains</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span class="hs-identifier">filterNotAlreadyInFlightWithOtherPeers</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeBulkSync"><span class="hs-identifier hs-var">FetchModeBulkSync</span></a><span> </span><a name="local-6989586621679178237"><a href="#local-6989586621679178237"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-537"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178248"><span class="hs-identifier hs-var">mcandidatefragments'</span></a><span class="hs-special">,</span><span>      </span><a href="#local-6989586621679178247"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178246"><a href="#local-6989586621679178246"><span class="hs-identifier">mcandidatefragments</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178247"><a href="#local-6989586621679178247"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178237"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-539"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178248"><a href="#local-6989586621679178248"><span class="hs-identifier">mcandidatefragments'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-540"></a><span>            </span><a name="local-6989586621679178249"><a href="#local-6989586621679178249"><span class="hs-identifier">chainfragments</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178246"><span class="hs-identifier hs-var">mcandidatefragments</span></a><span>
</span><a name="line-541"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178250"><a href="#local-6989586621679178250"><span class="hs-identifier">fragments</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a><span>
</span><a name="line-542"></a><span>                                        </span><a href="#local-6989586621679178238"><span class="hs-identifier hs-var">notAlreadyInFlight</span></a><span>
</span><a name="line-543"></a><span>                                        </span><a href="#local-6989586621679178240"><span class="hs-identifier hs-var">maxSlotNoInFlightWithOtherPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>                                      </span><a href="#local-6989586621679178249"><span class="hs-identifier hs-var">chainfragments</span></a><span>
</span><a name="line-545"></a><span>            </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679178250"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightOtherPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightOtherPeer</span></a><span>
</span><a name="line-546"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679178250"><span class="hs-identifier hs-var">fragments</span></a><span>
</span><a name="line-547"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-548"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-549"></a><span>    </span><a name="local-6989586621679178238"><a href="#local-6989586621679178238"><span class="hs-identifier">notAlreadyInFlight</span></a></a><span> </span><a name="local-6989586621679178241"><a href="#local-6989586621679178241"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-550"></a><span>      </span><a href="Ouroboros.Network.Block.html#blockPoint"><span class="hs-identifier hs-var">blockPoint</span></a><span> </span><a href="#local-6989586621679178241"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.notMember</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679178239"><span class="hs-identifier hs-var">blocksInFlightWithOtherPeers</span></a><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span>   </span><span class="hs-comment">-- All the blocks that are already in-flight with all peers</span><span>
</span><a name="line-553"></a><span>    </span><a name="local-6989586621679178239"><a href="#local-6989586621679178239"><span class="hs-identifier">blocksInFlightWithOtherPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-554"></a><span>      </span><span class="hs-identifier hs-var">Set.unions</span><span>
</span><a name="line-555"></a><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679178242"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-556"></a><span>            </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusShutdown"><span class="hs-identifier hs-var">PeerFetchStatusShutdown</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-557"></a><span>            </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusAberrant"><span class="hs-identifier hs-var">PeerFetchStatusAberrant</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-558"></a><span>            </span><a name="local-6989586621679178244"><a href="#local-6989586621679178244"><span class="hs-identifier">_other</span></a></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">peerFetchBlocksInFlight</span><span> </span><a href="#local-6989586621679178243"><span class="hs-identifier hs-var">inflight</span></a><span>
</span><a name="line-559"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178242"><a href="#local-6989586621679178242"><span class="hs-identifier">status</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178243"><a href="#local-6989586621679178243"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178237"><span class="hs-identifier hs-var">chains</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>    </span><span class="hs-comment">-- The highest slot number that is or has been in flight for any peer.</span><span>
</span><a name="line-562"></a><span>    </span><a name="local-6989586621679178240"><a href="#local-6989586621679178240"><span class="hs-identifier">maxSlotNoInFlightWithOtherPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="Ouroboros.Network.Block.html#NoMaxSlotNo"><span class="hs-identifier hs-var">NoMaxSlotNo</span></a><span>
</span><a name="line-563"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">peerFetchMaxSlotNo</span><span> </span><a href="#local-6989586621679178245"><span class="hs-identifier hs-var">inflight</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178245"><a href="#local-6989586621679178245"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178237"><span class="hs-identifier hs-var">chains</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-comment">-- | Filter a fragment. This is an optimised variant that will behave the same</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- as 'ChainFragment.filter' if the following precondition is satisfied:</span><span>
</span><a name="line-567"></a><span class="hs-comment">--</span><span>
</span><a name="line-568"></a><span class="hs-comment">-- PRECONDITION: for all @hdr@ in the chain fragment: if @blockSlot hdr &gt;</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- maxSlotNo@ then the predicate should not hold for any header after @hdr@ in</span><span>
</span><a name="line-570"></a><span class="hs-comment">-- the chain fragment.</span><span>
</span><a name="line-571"></a><span class="hs-comment">--</span><span>
</span><a name="line-572"></a><span class="hs-comment">-- For example, when filtering out already downloaded blocks from the</span><span>
</span><a name="line-573"></a><span class="hs-comment">-- fragment, it does not make sense to keep filtering after having encountered</span><span>
</span><a name="line-574"></a><span class="hs-comment">-- the highest slot number the ChainDB has seen so far: blocks with a greater</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- slot number cannot have been downloaded yet. When the candidate fragments</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- get far ahead of the current chain, e.g., @2k@ headers, this optimisation</span><span>
</span><a name="line-577"></a><span class="hs-comment">-- avoids the linear cost of filtering these headers when we know in advance</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- they will all remain in the final fragment. In case the given slot number</span><span>
</span><a name="line-579"></a><span class="hs-comment">-- is 'NoSlotNo', no filtering takes place, as there should be no matches</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- because we haven't downloaded any blocks yet.</span><span>
</span><a name="line-581"></a><span class="hs-comment">--</span><span>
</span><a name="line-582"></a><span class="hs-comment">-- For example, when filtering out blocks already in-flight for the given</span><span>
</span><a name="line-583"></a><span class="hs-comment">-- peer, the given @maxSlotNo@ can correspond to the block with the highest</span><span>
</span><a name="line-584"></a><span class="hs-comment">-- slot number that so far has been in-flight for the given peer. When no</span><span>
</span><a name="line-585"></a><span class="hs-comment">-- blocks have been in-flight yet, @maxSlotNo@ can be 'NoSlotNo', in which</span><span>
</span><a name="line-586"></a><span class="hs-comment">-- case no filtering needs to take place, which makes sense, as there are no</span><span>
</span><a name="line-587"></a><span class="hs-comment">-- blocks to filter out. Note that this is conservative: if a block is for</span><span>
</span><a name="line-588"></a><span class="hs-comment">-- some reason multiple times in-flight (maybe it has to be redownloaded) and</span><span>
</span><a name="line-589"></a><span class="hs-comment">-- the block's slot number matches the @maxSlotNo@, it will now be filtered</span><span>
</span><a name="line-590"></a><span class="hs-comment">-- (while the filtering might previously have stopped before encountering the</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- block in question). This is fine, as the filter will now include the block,</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- because according to the filtering predicate, the block is not in-flight.</span><span>
</span><a name="line-593"></a><span class="hs-identifier">filterWithMaxSlotNo</span><span>
</span><a name="line-594"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679178147"><a href="#local-6989586621679178147"><span class="hs-identifier">header</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178147"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178147"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-596"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span>  </span><span class="hs-comment">-- ^ @maxSlotNo@</span><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178147"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-598"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178147"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span>
</span><a name="line-599"></a><a name="filterWithMaxSlotNo"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier">filterWithMaxSlotNo</span></a></a><span> </span><a name="local-6989586621679178251"><a href="#local-6989586621679178251"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679178252"><a href="#local-6989586621679178252"><span class="hs-identifier">maxSlotNo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-600"></a><span>    </span><a href="Ouroboros.Network.ChainFragment.html#filterWithStop"><span class="hs-identifier hs-var">ChainFragment.filterWithStop</span></a><span> </span><a href="#local-6989586621679178251"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679178252"><span class="hs-identifier hs-var">maxSlotNo</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-var">MaxSlotNo</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.Block.html#blockSlot"><span class="hs-identifier hs-var">blockSlot</span></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-identifier">prioritisePeerChains</span><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679178145"><a href="#local-6989586621679178145"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621679178146"><a href="#local-6989586621679178146"><span class="hs-identifier">peer</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-604"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span>
</span><a name="line-605"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a><span> </span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a><span> </span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-608"></a><span>                                                  </span><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a><span class="hs-special">,</span><span>
</span><a name="line-609"></a><span>                                                  </span><a href="#local-6989586621679178146"><span class="hs-identifier hs-type">peer</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-610"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178145"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><a href="#local-6989586621679178146"><span class="hs-identifier hs-type">peer</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-611"></a><a name="prioritisePeerChains"><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier">prioritisePeerChains</span></a></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeDeadline"><span class="hs-identifier hs-var">FetchModeDeadline</span></a><span> </span><a name="local-6989586621679178253"><a href="#local-6989586621679178253"><span class="hs-identifier">compareCandidateChains</span></a></a><span> </span><a name="local-6989586621679178254"><a href="#local-6989586621679178254"><span class="hs-identifier">blockFetchSize</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-612"></a><span>    </span><span class="hs-comment">--TODO: last tie-breaker is still original order (which is probably</span><span>
</span><a name="line-613"></a><span>    </span><span class="hs-comment">-- peerid order). We should use a random tie breaker so that adversaries</span><span>
</span><a name="line-614"></a><span>    </span><span class="hs-comment">-- cannot get any advantage.</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679178270"><a href="#local-6989586621679178270"><span class="hs-identifier">decision</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178271"><a href="#local-6989586621679178271"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-617"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679178272"><a href="#local-6989586621679178272"><span class="hs-identifier">fragment</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178272"><span class="hs-identifier hs-var">fragment</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679178270"><span class="hs-identifier hs-var">decision</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178271"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-619"></a><span>              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">transpose</span><span>
</span><a name="line-620"></a><span>              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier hs-var">equatingFst</span></a><span>
</span><a name="line-621"></a><span>                          </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier hs-var">equatingRight</span></a><span>
</span><a name="line-622"></a><span>                            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679178258"><span class="hs-identifier hs-var">chainHeadPoint</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span>  </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var">comparingFst</span></a><span>
</span><a name="line-624"></a><span>                          </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var">comparingRight</span></a><span>
</span><a name="line-625"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679178258"><span class="hs-identifier hs-var">chainHeadPoint</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>              </span><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier hs-var">equatingFst</span></a><span>
</span><a name="line-628"></a><span>              </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier hs-var">equatingRight</span></a><span>
</span><a name="line-629"></a><span>                </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingPair"><span class="hs-identifier hs-var">equatingPair</span></a><span>
</span><a name="line-630"></a><span>                   </span><span class="hs-comment">-- compare on probability band first, then preferred chain</span><span>
</span><a name="line-631"></a><span>                   </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span>
</span><a name="line-632"></a><span>                   </span><span class="hs-special">(</span><a href="#local-6989586621679178257"><span class="hs-identifier hs-var">equateCandidateChains</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">getChainSuffix</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span>
</span><a name="line-634"></a><span>                   </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679178273"><a href="#local-6989586621679178273"><span class="hs-identifier">band</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178274"><a href="#local-6989586621679178274"><span class="hs-identifier">chain</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178275"><a href="#local-6989586621679178275"><span class="hs-identifier">_fragments</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178273"><span class="hs-identifier hs-var">band</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178274"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span>  </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#descendingOrder"><span class="hs-identifier hs-var">descendingOrder</span></a><span>
</span><a name="line-636"></a><span>              </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var">comparingFst</span></a><span>
</span><a name="line-637"></a><span>                </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var">comparingRight</span></a><span>
</span><a name="line-638"></a><span>                  </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier hs-var">comparingPair</span></a><span>
</span><a name="line-639"></a><span>                     </span><span class="hs-comment">-- compare on probability band first, then preferred chain</span><span>
</span><a name="line-640"></a><span>                     </span><span class="hs-identifier hs-var">compare</span><span>
</span><a name="line-641"></a><span>                     </span><span class="hs-special">(</span><a href="#local-6989586621679178253"><span class="hs-identifier hs-var">compareCandidateChains</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">getChainSuffix</span><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>                   </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span>
</span><a name="line-643"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679178276"><a href="#local-6989586621679178276"><span class="hs-identifier">band</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178277"><a href="#local-6989586621679178277"><span class="hs-identifier">chain</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178278"><a href="#local-6989586621679178278"><span class="hs-identifier">_fragments</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178276"><span class="hs-identifier hs-var">band</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178277"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-644"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679178255"><span class="hs-identifier hs-var">annotateProbabilityBand</span></a><span>
</span><a name="line-645"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-646"></a><span>    </span><a name="local-6989586621679178255"><a href="#local-6989586621679178255"><span class="hs-identifier">annotateProbabilityBand</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679178259"><a href="#local-6989586621679178259"><span class="hs-identifier">decline</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178260"><a href="#local-6989586621679178260"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679178259"><span class="hs-identifier hs-var">decline</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178260"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-647"></a><span>    </span><span class="hs-identifier">annotateProbabilityBand</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178261"><a href="#local-6989586621679178261"><span class="hs-identifier">chain</span></a></a><span class="hs-special">,</span><a name="local-6989586621679178262"><a href="#local-6989586621679178262"><span class="hs-identifier">fragments</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178263"><a href="#local-6989586621679178263"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178264"><a href="#local-6989586621679178264"><span class="hs-identifier">gsvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178265"><a href="#local-6989586621679178265"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-648"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178266"><span class="hs-identifier hs-var">band</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178261"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178262"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178265"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-650"></a><span>        </span><a name="local-6989586621679178266"><a href="#local-6989586621679178266"><span class="hs-identifier">band</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#probabilityBand"><span class="hs-identifier hs-var">probabilityBand</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-651"></a><span>                 </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateResponseDeadlineProbability"><span class="hs-identifier hs-var">estimateResponseDeadlineProbability</span></a><span>
</span><a name="line-652"></a><span>                   </span><a href="#local-6989586621679178264"><span class="hs-identifier hs-var">gsvs</span></a><span>
</span><a name="line-653"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">peerFetchBytesInFlight</span><span> </span><a href="#local-6989586621679178263"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">)</span><span>
</span><a name="line-654"></a><span>                   </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier hs-var">totalFetchSize</span></a><span> </span><a href="#local-6989586621679178254"><span class="hs-identifier hs-var">blockFetchSize</span></a><span> </span><a href="#local-6989586621679178262"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span>
</span><a name="line-655"></a><span>                   </span><a href="#local-6989586621679178256"><span class="hs-identifier hs-var">deadline</span></a><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span>    </span><a name="local-6989586621679178256"><a href="#local-6989586621679178256"><span class="hs-identifier">deadline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-comment">-- seconds -- TODO: get this from external info</span><span>
</span><a name="line-658"></a><span>
</span><a name="line-659"></a><span>    </span><a name="local-6989586621679178257"><a href="#local-6989586621679178257"><span class="hs-identifier">equateCandidateChains</span></a></a><span> </span><a name="local-6989586621679178267"><a href="#local-6989586621679178267"><span class="hs-identifier">chain1</span></a></a><span> </span><a name="local-6989586621679178268"><a href="#local-6989586621679178268"><span class="hs-identifier">chain2</span></a></a><span>
</span><a name="line-660"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178253"><span class="hs-identifier hs-var">compareCandidateChains</span></a><span> </span><a href="#local-6989586621679178267"><span class="hs-identifier hs-var">chain1</span></a><span> </span><a href="#local-6989586621679178268"><span class="hs-identifier hs-var">chain2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-661"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span>    </span><a name="local-6989586621679178258"><a href="#local-6989586621679178258"><span class="hs-identifier">chainHeadPoint</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-var">ChainSuffix</span></a><span> </span><a name="local-6989586621679178269"><a href="#local-6989586621679178269"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.AnchoredFragment.html#headPoint"><span class="hs-identifier hs-var">AnchoredFragment.headPoint</span></a><span> </span><a href="#local-6989586621679178269"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span class="hs-identifier">prioritisePeerChains</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeBulkSync"><span class="hs-identifier hs-var">FetchModeBulkSync</span></a><span> </span><a name="local-6989586621679178279"><a href="#local-6989586621679178279"><span class="hs-identifier">compareCandidateChains</span></a></a><span> </span><a name="local-6989586621679178280"><a href="#local-6989586621679178280"><span class="hs-identifier">blockFetchSize</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679178290"><a href="#local-6989586621679178290"><span class="hs-identifier">decision</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178291"><a href="#local-6989586621679178291"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-667"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178292"><a href="#local-6989586621679178292"><span class="hs-identifier">fragment</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178292"><span class="hs-identifier hs-var">fragment</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679178290"><span class="hs-identifier hs-var">decision</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178291"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var">comparingFst</span></a><span>
</span><a name="line-669"></a><span>             </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var">comparingRight</span></a><span>
</span><a name="line-670"></a><span>               </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier hs-var">comparingPair</span></a><span>
</span><a name="line-671"></a><span>                  </span><span class="hs-comment">-- compare on preferred chain first, then duration</span><span>
</span><a name="line-672"></a><span>                  </span><span class="hs-special">(</span><a href="#local-6989586621679178279"><span class="hs-identifier hs-var">compareCandidateChains</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">getChainSuffix</span><span class="hs-special">)</span><span>
</span><a name="line-673"></a><span>                  </span><span class="hs-identifier hs-var">compare</span><span>
</span><a name="line-674"></a><span>                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span>
</span><a name="line-675"></a><span>                  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679178293"><a href="#local-6989586621679178293"><span class="hs-identifier">duration</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178294"><a href="#local-6989586621679178294"><span class="hs-identifier">chain</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178295"><a href="#local-6989586621679178295"><span class="hs-identifier">_fragments</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178294"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178293"><span class="hs-identifier hs-var">duration</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679178281"><span class="hs-identifier hs-var">annotateDuration</span></a><span>
</span><a name="line-677"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-678"></a><span>    </span><a name="local-6989586621679178281"><a href="#local-6989586621679178281"><span class="hs-identifier">annotateDuration</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679178282"><a href="#local-6989586621679178282"><span class="hs-identifier">decline</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178283"><a href="#local-6989586621679178283"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679178282"><span class="hs-identifier hs-var">decline</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178283"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-679"></a><span>    </span><span class="hs-identifier">annotateDuration</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178284"><a href="#local-6989586621679178284"><span class="hs-identifier">chain</span></a></a><span class="hs-special">,</span><a name="local-6989586621679178285"><a href="#local-6989586621679178285"><span class="hs-identifier">fragments</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178286"><a href="#local-6989586621679178286"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178287"><a href="#local-6989586621679178287"><span class="hs-identifier">gsvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178288"><a href="#local-6989586621679178288"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-680"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178289"><span class="hs-identifier hs-var">duration</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178284"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178285"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178288"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-681"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-682"></a><span>        </span><span class="hs-comment">-- TODO: consider if we should put this into bands rather than just</span><span>
</span><a name="line-683"></a><span>        </span><span class="hs-comment">-- taking the full value.</span><span>
</span><a name="line-684"></a><span>        </span><a name="local-6989586621679178289"><a href="#local-6989586621679178289"><span class="hs-identifier">duration</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateExpectedResponseDuration"><span class="hs-identifier hs-var">estimateExpectedResponseDuration</span></a><span>
</span><a name="line-685"></a><span>                     </span><a href="#local-6989586621679178287"><span class="hs-identifier hs-var">gsvs</span></a><span>
</span><a name="line-686"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">peerFetchBytesInFlight</span><span> </span><a href="#local-6989586621679178286"><span class="hs-identifier hs-var">inflight</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>                     </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier hs-var">totalFetchSize</span></a><span> </span><a href="#local-6989586621679178280"><span class="hs-identifier hs-var">blockFetchSize</span></a><span> </span><a href="#local-6989586621679178285"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-identifier">totalFetchSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178144"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-690"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178144"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-691"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178144"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span>
</span><a name="line-692"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span>
</span><a name="line-693"></a><a name="totalFetchSize"><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier">totalFetchSize</span></a></a><span> </span><a name="local-6989586621679178296"><a href="#local-6989586621679178296"><span class="hs-identifier">blockFetchSize</span></a></a><span> </span><a name="local-6989586621679178297"><a href="#local-6989586621679178297"><span class="hs-identifier">fragments</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-694"></a><span>  </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679178296"><span class="hs-identifier hs-var">blockFetchSize</span></a><span> </span><a href="#local-6989586621679178299"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-695"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679178298"><a href="#local-6989586621679178298"><span class="hs-identifier">fragment</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178297"><span class="hs-identifier hs-var">fragments</span></a><span>
</span><a name="line-696"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178299"><a href="#local-6989586621679178299"><span class="hs-identifier">header</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.ChainFragment.html#toOldestFirst"><span class="hs-identifier hs-var">ChainFragment.toOldestFirst</span></a><span> </span><a href="#local-6989586621679178298"><span class="hs-identifier hs-var">fragment</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span class="hs-keyword">type</span><span> </span><a name="Comparing"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier">Comparing</span></a></a><span> </span><a name="local-6989586621679178116"><a href="#local-6989586621679178116"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178116"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178116"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-699"></a><span class="hs-keyword">type</span><span> </span><a name="Equating"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier">Equating</span></a></a><span>  </span><a name="local-6989586621679178115"><a href="#local-6989586621679178115"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178115"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178115"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span class="hs-identifier">descendingOrder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178143"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178143"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-702"></a><a name="descendingOrder"><a href="Ouroboros.Network.BlockFetch.Decision.html#descendingOrder"><span class="hs-identifier">descendingOrder</span></a></a><span> </span><a name="local-6989586621679178300"><a href="#local-6989586621679178300"><span class="hs-identifier">cmp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="#local-6989586621679178300"><span class="hs-identifier hs-var">cmp</span></a><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-identifier">comparingPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178141"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178142"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178141"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178142"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-705"></a><a name="comparingPair"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier">comparingPair</span></a></a><span> </span><a name="local-6989586621679178301"><a href="#local-6989586621679178301"><span class="hs-identifier">cmpA</span></a></a><span> </span><a name="local-6989586621679178302"><a href="#local-6989586621679178302"><span class="hs-identifier">cmpB</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679178303"><a href="#local-6989586621679178303"><span class="hs-identifier">a1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178304"><a href="#local-6989586621679178304"><span class="hs-identifier">b1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178305"><a href="#local-6989586621679178305"><span class="hs-identifier">a2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178306"><a href="#local-6989586621679178306"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178301"><span class="hs-identifier hs-var">cmpA</span></a><span> </span><a href="#local-6989586621679178303"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-6989586621679178305"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679178302"><span class="hs-identifier hs-var">cmpB</span></a><span> </span><a href="#local-6989586621679178304"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-6989586621679178306"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-706"></a><span>
</span><a name="line-707"></a><span class="hs-identifier">equatingPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><a href="#local-6989586621679178139"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><a href="#local-6989586621679178140"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178139"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178140"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><a name="equatingPair"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingPair"><span class="hs-identifier">equatingPair</span></a></a><span> </span><a name="local-6989586621679178307"><a href="#local-6989586621679178307"><span class="hs-identifier">eqA</span></a></a><span> </span><a name="local-6989586621679178308"><a href="#local-6989586621679178308"><span class="hs-identifier">eqB</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679178309"><a href="#local-6989586621679178309"><span class="hs-identifier">a1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178310"><a href="#local-6989586621679178310"><span class="hs-identifier">b1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679178311"><a href="#local-6989586621679178311"><span class="hs-identifier">a2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178312"><a href="#local-6989586621679178312"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178307"><span class="hs-identifier hs-var">eqA</span></a><span> </span><a href="#local-6989586621679178309"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-6989586621679178311"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679178308"><span class="hs-identifier hs-var">eqB</span></a><span> </span><a href="#local-6989586621679178310"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-6989586621679178312"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span class="hs-identifier">comparingEither</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178137"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178138"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679178137"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679178138"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><a name="comparingEither"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier">comparingEither</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-712"></a><span class="hs-identifier">comparingEither</span><span> </span><a name="local-6989586621679178313"><a href="#local-6989586621679178313"><span class="hs-identifier">cmpA</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679178314"><a href="#local-6989586621679178314"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679178315"><a href="#local-6989586621679178315"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178313"><span class="hs-identifier hs-var">cmpA</span></a><span> </span><a href="#local-6989586621679178314"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679178315"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-713"></a><span class="hs-identifier">comparingEither</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679178316"><a href="#local-6989586621679178316"><span class="hs-identifier">cmpB</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679178317"><a href="#local-6989586621679178317"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679178318"><a href="#local-6989586621679178318"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178316"><span class="hs-identifier hs-var">cmpB</span></a><span> </span><a href="#local-6989586621679178317"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679178318"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-714"></a><span class="hs-identifier">comparingEither</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-715"></a><span>
</span><a name="line-716"></a><span class="hs-identifier">equatingEither</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><a href="#local-6989586621679178135"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><a href="#local-6989586621679178136"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679178135"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679178136"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-717"></a><a name="equatingEither"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier">equatingEither</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-718"></a><span class="hs-identifier">equatingEither</span><span> </span><a name="local-6989586621679178319"><a href="#local-6989586621679178319"><span class="hs-identifier">eqA</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679178320"><a href="#local-6989586621679178320"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679178321"><a href="#local-6989586621679178321"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178319"><span class="hs-identifier hs-var">eqA</span></a><span> </span><a href="#local-6989586621679178320"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679178321"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-719"></a><span class="hs-identifier">equatingEither</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679178322"><a href="#local-6989586621679178322"><span class="hs-identifier">eqB</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679178323"><a href="#local-6989586621679178323"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679178324"><a href="#local-6989586621679178324"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178322"><span class="hs-identifier hs-var">eqB</span></a><span> </span><a href="#local-6989586621679178323"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679178324"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-720"></a><span class="hs-identifier">equatingEither</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span class="hs-identifier">comparingFst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178133"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178133"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178134"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-723"></a><a name="comparingFst"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier">comparingFst</span></a></a><span> </span><a name="local-6989586621679178325"><a href="#local-6989586621679178325"><span class="hs-identifier">cmp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178325"><span class="hs-identifier hs-var">cmp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">fst</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-identifier">equatingFst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><a href="#local-6989586621679178131"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178131"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178132"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-726"></a><a name="equatingFst"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier">equatingFst</span></a></a><span> </span><a name="local-6989586621679178326"><a href="#local-6989586621679178326"><span class="hs-identifier">eq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178326"><span class="hs-identifier hs-var">eq</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">fst</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-identifier">comparingRight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><a href="#local-6989586621679178129"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679178130"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679178129"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-729"></a><a name="comparingRight"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier">comparingRight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-var">comparingEither</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-identifier">equatingRight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><a href="#local-6989586621679178127"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679178128"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679178127"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-732"></a><a name="equatingRight"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier">equatingRight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-var">equatingEither</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span class="hs-comment">-- | Given the probability of the download completing within the deadline,</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- classify that into one of three broad bands: high, medium and low.</span><span>
</span><a name="line-736"></a><span class="hs-comment">--</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- The bands are</span><span>
</span><a name="line-738"></a><span class="hs-comment">--</span><span>
</span><a name="line-739"></a><span class="hs-comment">-- * high:    98% -- 100%</span><span>
</span><a name="line-740"></a><span class="hs-comment">-- * medium:  75% --  98%</span><span>
</span><a name="line-741"></a><span class="hs-comment">-- * low:      0% --  75%</span><span>
</span><a name="line-742"></a><span class="hs-comment">--</span><span>
</span><a name="line-743"></a><span class="hs-identifier">probabilityBand</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityBand"><span class="hs-identifier hs-type">ProbabilityBand</span></a><span>
</span><a name="line-744"></a><a name="probabilityBand"><a href="Ouroboros.Network.BlockFetch.Decision.html#probabilityBand"><span class="hs-identifier">probabilityBand</span></a></a><span> </span><a name="local-6989586621679178327"><a href="#local-6989586621679178327"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-745"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178327"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0.98</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityHigh"><span class="hs-identifier hs-var">ProbabilityHigh</span></a><span>
</span><a name="line-746"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178327"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0.75</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityModerate"><span class="hs-identifier hs-var">ProbabilityModerate</span></a><span>
</span><a name="line-747"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityLow"><span class="hs-identifier hs-var">ProbabilityLow</span></a><span>
</span><a name="line-748"></a><span> </span><span class="hs-comment">-- TODO: for hysteresis, increase probability if we're already using this peer</span><span>
</span><a name="line-749"></a><span>
</span><a name="line-750"></a><span class="hs-keyword">data</span><span> </span><a name="ProbabilityBand"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityBand"><span class="hs-identifier">ProbabilityBand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ProbabilityLow"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityLow"><span class="hs-identifier">ProbabilityLow</span></a></a><span>
</span><a name="line-751"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a name="ProbabilityModerate"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityModerate"><span class="hs-identifier">ProbabilityModerate</span></a></a><span>
</span><a name="line-752"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a name="ProbabilityHigh"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityHigh"><span class="hs-identifier">ProbabilityHigh</span></a></a><span>
</span><a name="line-753"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span class="hs-comment">{-
In the second phase we walk over the prioritised fetch suffixes for each peer
and make a decision about whether we should initiate any new fetch requests.

This decision is based on a number of factors:

 * Is the fetch suffix empty? If so, there's nothing to do.
 * Do we already have block fetch requests in flight with this peer?
 * If so are we under the maximum number of in-flight blocks for this peer?
 * Is this peer still performing within expectations or has it missed any soft
   time outs?
 * Has the peer missed any hard timeouts or otherwise been disconnected.
 * Are we at our soft or hard limit of the number of peers we are prepared to
   fetch blocks from concurrently?

We look at each peer chain fetch suffix one by one. Of course decisions we
make earlier can affect decisions later, in particular the number of peers we
fetch from concurrently can increase if we fetch from a new peer, and we must
obviously take that into account when considering later peer chains.
-}</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span class="hs-identifier">fetchRequestDecisions</span><span>
</span><a name="line-779"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679178125"><a href="#local-6989586621679178125"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621679178126"><a href="#local-6989586621679178126"><span class="hs-identifier">peer</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-780"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-781"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span>
</span><a name="line-782"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-783"></a><span>                                             </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-784"></a><span>                                             </span><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a><span class="hs-special">,</span><span>
</span><a name="line-785"></a><span>                                             </span><a href="#local-6989586621679178126"><span class="hs-identifier hs-type">peer</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-786"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>  </span><a href="#local-6989586621679178126"><span class="hs-identifier hs-type">peer</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-787"></a><a name="fetchRequestDecisions"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier">fetchRequestDecisions</span></a></a><span> </span><a name="local-6989586621679178328"><a href="#local-6989586621679178328"><span class="hs-identifier">fetchDecisionPolicy</span></a></a><span> </span><a name="local-6989586621679178329"><a href="#local-6989586621679178329"><span class="hs-identifier">fetchMode</span></a></a><span> </span><a name="local-6989586621679178330"><a href="#local-6989586621679178330"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-788"></a><span>    </span><a href="#local-6989586621679178331"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679178332"><span class="hs-identifier hs-var">nConcurrentFetchPeers0</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span> </span><a href="Ouroboros.Network.Block.html#NoMaxSlotNo"><span class="hs-identifier hs-var">NoMaxSlotNo</span></a><span> </span><a href="#local-6989586621679178330"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-789"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-790"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-791"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a><span>
</span><a name="line-793"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier hs-type">FetchDecline</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-794"></a><span>            </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178333"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-795"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a><span> </span><a href="#local-6989586621679178125"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178333"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-796"></a><span>    </span><a name="local-6989586621679178331"><a href="#local-6989586621679178331"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-797"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679178334"><a href="#local-6989586621679178334"><span class="hs-identifier">nConcurrentFetchPeers</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679178335"><a href="#local-6989586621679178335"><span class="hs-identifier">blocksFetchedThisRound</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679178336"><a href="#local-6989586621679178336"><span class="hs-identifier">maxSlotNoFetchedThisRound</span></a></a><span>
</span><a name="line-798"></a><span>       </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679178337"><a href="#local-6989586621679178337"><span class="hs-identifier">mchainfragments</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178338"><a href="#local-6989586621679178338"><span class="hs-identifier">status</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178339"><a href="#local-6989586621679178339"><span class="hs-identifier">inflight</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178340"><a href="#local-6989586621679178340"><span class="hs-identifier">gsvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178341"><a href="#local-6989586621679178341"><span class="hs-identifier">peer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679178342"><a href="#local-6989586621679178342"><span class="hs-identifier">cps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">decision</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178341"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span>      </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679178331"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679178345"><span class="hs-identifier hs-var">nConcurrentFetchPeers'</span></a><span> </span><a href="#local-6989586621679178346"><span class="hs-identifier hs-var">blocksFetchedThisRound'</span></a><span>
</span><a name="line-802"></a><span>           </span><a href="#local-6989586621679178347"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound'</span></a><span> </span><a href="#local-6989586621679178342"><span class="hs-identifier hs-var">cps</span></a><span>
</span><a name="line-803"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-804"></a><span>        </span><a name="local-6989586621679178343"><a href="#local-6989586621679178343"><span class="hs-identifier">decision</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var">fetchRequestDecision</span></a><span>
</span><a name="line-805"></a><span>                     </span><a href="#local-6989586621679178328"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a><span>
</span><a name="line-806"></a><span>                     </span><a href="#local-6989586621679178329"><span class="hs-identifier hs-var">fetchMode</span></a><span>
</span><a name="line-807"></a><span>                     </span><a href="#local-6989586621679178334"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a><span>
</span><a name="line-808"></a><span>                     </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#calculatePeerFetchInFlightLimits"><span class="hs-identifier hs-var">calculatePeerFetchInFlightLimits</span></a><span> </span><a href="#local-6989586621679178340"><span class="hs-identifier hs-var">gsvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-809"></a><span>                     </span><a href="#local-6989586621679178339"><span class="hs-identifier hs-var">inflight</span></a><span>
</span><a name="line-810"></a><span>                     </span><a href="#local-6989586621679178338"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-811"></a><span>                     </span><a href="#local-6989586621679178344"><span class="hs-identifier hs-var">mchainfragments'</span></a><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span>        </span><a name="local-6989586621679178344"><a href="#local-6989586621679178344"><span class="hs-identifier">mchainfragments'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-814"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679178329"><span class="hs-identifier hs-var">fetchMode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-815"></a><span>            </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeDeadline"><span class="hs-identifier hs-var">FetchModeDeadline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178337"><span class="hs-identifier hs-var">mchainfragments</span></a><span>
</span><a name="line-816"></a><span>            </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeBulkSync"><span class="hs-identifier hs-var">FetchModeBulkSync</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-817"></a><span>                </span><a name="local-6989586621679178350"><a href="#local-6989586621679178350"><span class="hs-identifier">chainfragments</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178337"><span class="hs-identifier hs-var">mchainfragments</span></a><span>
</span><a name="line-818"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178351"><a href="#local-6989586621679178351"><span class="hs-identifier">fragments</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-819"></a><span>                      </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a><span>
</span><a name="line-820"></a><span>                                   </span><a href="#local-6989586621679178348"><span class="hs-identifier hs-var">notFetchedThisRound</span></a><span>
</span><a name="line-821"></a><span>                                   </span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>                                </span><a href="#local-6989586621679178350"><span class="hs-identifier hs-var">chainfragments</span></a><span>
</span><a name="line-823"></a><span>                </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679178351"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightOtherPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightOtherPeer</span></a><span>
</span><a name="line-824"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679178351"><span class="hs-identifier hs-var">fragments</span></a><span>
</span><a name="line-825"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-826"></a><span>                </span><a name="local-6989586621679178348"><a href="#local-6989586621679178348"><span class="hs-identifier">notFetchedThisRound</span></a></a><span> </span><a name="local-6989586621679178349"><a href="#local-6989586621679178349"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-827"></a><span>                  </span><a href="Ouroboros.Network.Block.html#blockPoint"><span class="hs-identifier hs-var">blockPoint</span></a><span> </span><a href="#local-6989586621679178349"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.notMember</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679178335"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>        </span><a name="local-6989586621679178345"><a href="#local-6989586621679178345"><span class="hs-identifier">nConcurrentFetchPeers'</span></a></a><span>
</span><a name="line-830"></a><span>          </span><span class="hs-comment">-- increment if it was idle, and now will not be</span><span>
</span><a name="line-831"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">peerFetchReqsInFlight</span><span> </span><a href="#local-6989586621679178339"><span class="hs-identifier hs-var">inflight</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-832"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Right</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">decision</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178334"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-833"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178334"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span>        </span><span class="hs-comment">-- This is only for avoiding duplication between fetch requests in this</span><span>
</span><a name="line-836"></a><span>        </span><span class="hs-comment">-- round of decisions. Avoiding duplication with blocks that are already</span><span>
</span><a name="line-837"></a><span>        </span><span class="hs-comment">-- in flight is handled by filterNotAlreadyInFlightWithOtherPeers</span><span>
</span><a name="line-838"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679178346"><a href="#local-6989586621679178346"><span class="hs-identifier">blocksFetchedThisRound'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679178347"><a href="#local-6989586621679178347"><span class="hs-identifier">maxSlotNoFetchedThisRound'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-839"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679178343"><span class="hs-identifier hs-var">decision</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-840"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-841"></a><span>              </span><span class="hs-special">(</span><a href="#local-6989586621679178335"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a><span class="hs-special">)</span><span>
</span><a name="line-842"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-var">FetchRequest</span></a><span> </span><a name="local-6989586621679178352"><a href="#local-6989586621679178352"><span class="hs-identifier">fragments</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-843"></a><span>              </span><span class="hs-special">(</span><a href="#local-6989586621679178335"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679178354"><span class="hs-identifier hs-var">blocksFetchedThisDecision</span></a><span class="hs-special">,</span><span>
</span><a name="line-844"></a><span>               </span><a href="#local-6989586621679178336"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679178353"><span class="hs-identifier hs-var">maxSlotNoFetchedThisDecision</span></a><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-846"></a><span>                </span><a name="local-6989586621679178353"><a href="#local-6989586621679178353"><span class="hs-identifier">maxSlotNoFetchedThisDecision</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-847"></a><span>                  </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="Ouroboros.Network.Block.html#NoMaxSlotNo"><span class="hs-identifier hs-var">NoMaxSlotNo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-var">MaxSlotNo</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-848"></a><span>                  </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="Ouroboros.Network.ChainFragment.html#headSlot"><span class="hs-identifier hs-var">ChainFragment.headSlot</span></a><span> </span><a href="#local-6989586621679178352"><span class="hs-identifier hs-var">fragments</span></a><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span>                </span><a name="local-6989586621679178354"><a href="#local-6989586621679178354"><span class="hs-identifier">blocksFetchedThisDecision</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-851"></a><span>                  </span><span class="hs-identifier hs-var">Set.fromList</span><span>
</span><a name="line-852"></a><span>                    </span><span class="hs-special">[</span><span> </span><a href="Ouroboros.Network.Block.html#blockPoint"><span class="hs-identifier hs-var">blockPoint</span></a><span> </span><a href="#local-6989586621679178356"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-853"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679178355"><a href="#local-6989586621679178355"><span class="hs-identifier">fragment</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679178352"><span class="hs-identifier hs-var">fragments</span></a><span>
</span><a name="line-854"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679178356"><a href="#local-6989586621679178356"><span class="hs-identifier">header</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.ChainFragment.html#toOldestFirst"><span class="hs-identifier hs-var">ChainFragment.toOldestFirst</span></a><span> </span><a href="#local-6989586621679178355"><span class="hs-identifier hs-var">fragment</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span>    </span><a name="local-6989586621679178332"><a href="#local-6989586621679178332"><span class="hs-identifier">nConcurrentFetchPeers0</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-857"></a><span>        </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-858"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">length</span><span>
</span><a name="line-859"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-var">PeerFetchInFlight</span></a><span class="hs-special">{</span><a name="local-6989586621679178357"><a href="#local-6989586621679178357"><span class="hs-identifier">peerFetchReqsInFlight</span></a></a><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-861"></a><span>                       </span><a href="#local-6989586621679178357"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679178330"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-863"></a><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-identifier">fetchRequestDecision</span><span>
</span><a name="line-866"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178124"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-867"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a><span> </span><a href="#local-6989586621679178124"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-868"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a><span>
</span><a name="line-869"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-870"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#PeerFetchInFlightLimits"><span class="hs-identifier hs-type">PeerFetchInFlightLimits</span></a><span>
</span><a name="line-871"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a><span> </span><a href="#local-6989586621679178124"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-872"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a><span> </span><a href="#local-6989586621679178124"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-873"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178124"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span>
</span><a name="line-874"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a><span>  </span><a href="#local-6989586621679178124"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><a name="fetchRequestDecision"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier">fetchRequestDecision</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679178358"><a href="#local-6989586621679178358"><span class="hs-identifier">decline</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679178358"><span class="hs-identifier hs-var">decline</span></a><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span class="hs-identifier">fetchRequestDecision</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusShutdown"><span class="hs-identifier hs-var">PeerFetchStatusShutdown</span></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-880"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerShutdown"><span class="hs-identifier hs-var">FetchDeclinePeerShutdown</span></a><span>
</span><a name="line-881"></a><span>
</span><a name="line-882"></a><span class="hs-identifier">fetchRequestDecision</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusAberrant"><span class="hs-identifier hs-var">PeerFetchStatusAberrant</span></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerSlow"><span class="hs-identifier hs-var">FetchDeclinePeerSlow</span></a><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span class="hs-identifier">fetchRequestDecision</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-var">FetchDecisionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-886"></a><span>                       </span><a name="local-6989586621679178359"><a href="#local-6989586621679178359"><span class="hs-identifier">maxConcurrencyBulkSync</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-887"></a><span>                       </span><a name="local-6989586621679178360"><a href="#local-6989586621679178360"><span class="hs-identifier">maxConcurrencyDeadline</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-888"></a><span>                       </span><a name="local-6989586621679178361"><a href="#local-6989586621679178361"><span class="hs-identifier">maxInFlightReqsPerPeer</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-889"></a><span>                       </span><a name="local-6989586621679178362"><a href="#local-6989586621679178362"><span class="hs-identifier">blockFetchSize</span></a></a><span>
</span><a name="line-890"></a><span>                     </span><span class="hs-special">}</span><span>
</span><a name="line-891"></a><span>                     </span><a name="local-6989586621679178363"><a href="#local-6989586621679178363"><span class="hs-identifier">fetchMode</span></a></a><span>
</span><a name="line-892"></a><span>                     </span><a name="local-6989586621679178364"><a href="#local-6989586621679178364"><span class="hs-identifier">nConcurrentFetchPeers</span></a></a><span>
</span><a name="line-893"></a><span>                     </span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#PeerFetchInFlightLimits"><span class="hs-identifier hs-var">PeerFetchInFlightLimits</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-894"></a><span>                       </span><a name="local-6989586621679178365"><a href="#local-6989586621679178365"><span class="hs-identifier">inFlightBytesLowWatermark</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-895"></a><span>                       </span><a name="local-6989586621679178366"><a href="#local-6989586621679178366"><span class="hs-identifier">inFlightBytesHighWatermark</span></a></a><span>
</span><a name="line-896"></a><span>                     </span><span class="hs-special">}</span><span>
</span><a name="line-897"></a><span>                     </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-var">PeerFetchInFlight</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-898"></a><span>                       </span><a name="local-6989586621679178367"><a href="#local-6989586621679178367"><span class="hs-identifier">peerFetchReqsInFlight</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-899"></a><span>                       </span><a name="local-6989586621679178368"><a href="#local-6989586621679178368"><span class="hs-identifier">peerFetchBytesInFlight</span></a></a><span>
</span><a name="line-900"></a><span>                     </span><span class="hs-special">}</span><span>
</span><a name="line-901"></a><span>                     </span><a name="local-6989586621679178369"><a href="#local-6989586621679178369"><span class="hs-identifier">peerFetchStatus</span></a></a><span>
</span><a name="line-902"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679178370"><a href="#local-6989586621679178370"><span class="hs-identifier">fetchFragments</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178367"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679178361"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a><span>
</span><a name="line-905"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineReqsInFlightLimit"><span class="hs-identifier hs-var">FetchDeclineReqsInFlightLimit</span></a><span>
</span><a name="line-906"></a><span>             </span><a href="#local-6989586621679178361"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178368"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679178366"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a><span>
</span><a name="line-909"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineBytesInFlightLimit"><span class="hs-identifier hs-var">FetchDeclineBytesInFlightLimit</span></a><span>
</span><a name="line-910"></a><span>             </span><a href="#local-6989586621679178368"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a><span>
</span><a name="line-911"></a><span>             </span><a href="#local-6989586621679178365"><span class="hs-identifier hs-var">inFlightBytesLowWatermark</span></a><span>
</span><a name="line-912"></a><span>             </span><a href="#local-6989586621679178366"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>    </span><span class="hs-comment">-- This covers the case when we could still fit in more reqs or bytes, but</span><span>
</span><a name="line-915"></a><span>    </span><span class="hs-comment">-- we want to let it drop below a low water mark before sending more so we</span><span>
</span><a name="line-916"></a><span>    </span><span class="hs-comment">-- get a bit more batching behaviour, rather than lots of 1-block reqs.</span><span>
</span><a name="line-917"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178369"><span class="hs-identifier hs-var">peerFetchStatus</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusBusy"><span class="hs-identifier hs-var">PeerFetchStatusBusy</span></a><span>
</span><a name="line-918"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerBusy"><span class="hs-identifier hs-var">FetchDeclinePeerBusy</span></a><span>
</span><a name="line-919"></a><span>             </span><a href="#local-6989586621679178368"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a><span>
</span><a name="line-920"></a><span>             </span><a href="#local-6989586621679178365"><span class="hs-identifier hs-var">inFlightBytesLowWatermark</span></a><span>
</span><a name="line-921"></a><span>             </span><a href="#local-6989586621679178366"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178367"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-924"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178371"><a href="#local-6989586621679178371"><span class="hs-identifier">maxConcurrentFetchPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679178363"><span class="hs-identifier hs-var">fetchMode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-925"></a><span>                                    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeBulkSync"><span class="hs-identifier hs-var">FetchModeBulkSync</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178359"><span class="hs-identifier hs-var">maxConcurrencyBulkSync</span></a><span>
</span><a name="line-926"></a><span>                                    </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchModeDeadline"><span class="hs-identifier hs-var">FetchModeDeadline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679178360"><span class="hs-identifier hs-var">maxConcurrencyDeadline</span></a><span>
</span><a name="line-927"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679178364"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679178371"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineConcurrencyLimit"><span class="hs-identifier hs-var">FetchDeclineConcurrencyLimit</span></a><span>
</span><a name="line-929"></a><span>             </span><a href="#local-6989586621679178363"><span class="hs-identifier hs-var">fetchMode</span></a><span> </span><a href="#local-6989586621679178371"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a><span>
</span><a name="line-930"></a><span>
</span><a name="line-931"></a><span>    </span><span class="hs-comment">-- We've checked our request limit and our byte limit. We are then</span><span>
</span><a name="line-932"></a><span>    </span><span class="hs-comment">-- guaranteed to get at least one non-empty request range.</span><span>
</span><a name="line-933"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-934"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178367"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679178361"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-935"></a><span>    </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679178370"><span class="hs-identifier hs-var">fetchFragments</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectBlocksUpToLimits"><span class="hs-identifier hs-var">selectBlocksUpToLimits</span></a><span>
</span><a name="line-938"></a><span>              </span><a href="#local-6989586621679178362"><span class="hs-identifier hs-var">blockFetchSize</span></a><span>
</span><a name="line-939"></a><span>              </span><a href="#local-6989586621679178367"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a><span>
</span><a name="line-940"></a><span>              </span><a href="#local-6989586621679178361"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a><span>
</span><a name="line-941"></a><span>              </span><a href="#local-6989586621679178368"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a><span>
</span><a name="line-942"></a><span>              </span><a href="#local-6989586621679178366"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a><span>
</span><a name="line-943"></a><span>              </span><a href="#local-6989586621679178370"><span class="hs-identifier hs-var">fetchFragments</span></a><span>
</span><a name="line-944"></a><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span class="hs-comment">-- | </span><span>
</span><a name="line-947"></a><span class="hs-comment">--</span><span>
</span><a name="line-948"></a><span class="hs-comment">-- Precondition: The result will be non-empty if</span><span>
</span><a name="line-949"></a><span class="hs-comment">--</span><span>
</span><a name="line-950"></a><span class="hs-comment">-- Property: result is non-empty if preconditions satisfied</span><span>
</span><a name="line-951"></a><span class="hs-comment">--</span><span>
</span><a name="line-952"></a><span class="hs-identifier">selectBlocksUpToLimits</span><span>
</span><a name="line-953"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a><span> </span><a href="#local-6989586621679178123"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-954"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178123"><span class="hs-identifier hs-type">header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Block body size</span><span>
</span><a name="line-955"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-comment">-- ^ Current number of requests in flight</span><span>
</span><a name="line-956"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-comment">-- ^ Maximum number of requests in flight allowed</span><span>
</span><a name="line-957"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-comment">-- ^ Current number of bytes in flight</span><span>
</span><a name="line-958"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a><span> </span><span class="hs-comment">-- ^ Maximum number of bytes in flight allowed</span><span>
</span><a name="line-959"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.ChainFragment.html#ChainFragment"><span class="hs-identifier hs-type">ChainFragment</span></a><span> </span><a href="#local-6989586621679178123"><span class="hs-identifier hs-type">header</span></a><span class="hs-special">]</span><span>
</span><a name="line-960"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a><span> </span><a href="#local-6989586621679178123"><span class="hs-identifier hs-type">header</span></a><span>
</span><a name="line-961"></a><a name="selectBlocksUpToLimits"><a href="Ouroboros.Network.BlockFetch.Decision.html#selectBlocksUpToLimits"><span class="hs-identifier">selectBlocksUpToLimits</span></a></a><span> </span><a name="local-6989586621679178372"><a href="#local-6989586621679178372"><span class="hs-identifier">blockFetchSize</span></a></a><span> </span><a name="local-6989586621679178373"><a href="#local-6989586621679178373"><span class="hs-identifier">nreqs0</span></a></a><span> </span><a name="local-6989586621679178374"><a href="#local-6989586621679178374"><span class="hs-identifier">maxreqs</span></a></a><span> </span><a name="local-6989586621679178375"><a href="#local-6989586621679178375"><span class="hs-identifier">nbytes0</span></a></a><span> </span><a name="local-6989586621679178376"><a href="#local-6989586621679178376"><span class="hs-identifier">maxbytes</span></a></a><span> </span><a name="local-6989586621679178377"><a href="#local-6989586621679178377"><span class="hs-identifier">fragments</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-962"></a><span>    </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178373"><span class="hs-identifier hs-var">nreqs0</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679178374"><span class="hs-identifier hs-var">maxreqs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679178375"><span class="hs-identifier hs-var">nbytes0</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679178376"><span class="hs-identifier hs-var">maxbytes</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679178377"><span class="hs-identifier hs-var">fragments</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-963"></a><span>    </span><span class="hs-comment">-- The case that we are already over our limits has to be checked earlier,</span><span>
</span><a name="line-964"></a><span>    </span><span class="hs-comment">-- outside of this function. From here on however we check for limits.</span><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679178395"><a href="#local-6989586621679178395"><span class="hs-identifier">fragments'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178378"><span class="hs-identifier hs-var">goFrags</span></a><span> </span><a href="#local-6989586621679178373"><span class="hs-identifier hs-var">nreqs0</span></a><span> </span><a href="#local-6989586621679178375"><span class="hs-identifier hs-var">nbytes0</span></a><span> </span><a href="#local-6989586621679178377"><span class="hs-identifier hs-var">fragments</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-967"></a><span>    </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.ChainFragment.html#null"><span class="hs-identifier hs-var">ChainFragment.null</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679178395"><span class="hs-identifier hs-var">fragments'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-968"></a><span>    </span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-var">FetchRequest</span></a><span> </span><a href="#local-6989586621679178395"><span class="hs-identifier hs-var">fragments'</span></a><span>
</span><a name="line-969"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-970"></a><span>    </span><a name="local-6989586621679178378"><a href="#local-6989586621679178378"><span class="hs-identifier">goFrags</span></a></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-971"></a><span>    </span><span class="hs-identifier">goFrags</span><span> </span><a name="local-6989586621679178380"><a href="#local-6989586621679178380"><span class="hs-identifier">nreqs</span></a></a><span> </span><a name="local-6989586621679178381"><a href="#local-6989586621679178381"><span class="hs-identifier">nbytes</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679178382"><a href="#local-6989586621679178382"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679178383"><a href="#local-6989586621679178383"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178380"><span class="hs-identifier hs-var">nreqs</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>  </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679178374"><span class="hs-identifier hs-var">maxreqs</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-973"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178379"><span class="hs-identifier hs-var">goFrag</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178380"><span class="hs-identifier hs-var">nreqs</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679178381"><span class="hs-identifier hs-var">nbytes</span></a><span> </span><a href="Ouroboros.Network.ChainFragment.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><a href="#local-6989586621679178382"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679178383"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-974"></a><span>      </span><span class="hs-comment">-- Each time we have to pick from a new discontiguous chain fragment then</span><span>
</span><a name="line-975"></a><span>      </span><span class="hs-comment">-- that will become a new request, which contributes to our in-flight</span><span>
</span><a name="line-976"></a><span>      </span><span class="hs-comment">-- request count. We never break the maxreqs limit.</span><span>
</span><a name="line-977"></a><span>
</span><a name="line-978"></a><span>    </span><a name="local-6989586621679178379"><a href="#local-6989586621679178379"><span class="hs-identifier">goFrag</span></a></a><span> </span><a name="local-6989586621679178384"><a href="#local-6989586621679178384"><span class="hs-identifier">nreqs</span></a></a><span> </span><a name="local-6989586621679178385"><a href="#local-6989586621679178385"><span class="hs-identifier">nbytes</span></a></a><span> </span><a name="local-6989586621679178386"><a href="#local-6989586621679178386"><span class="hs-identifier">c'</span></a></a><span> </span><a href="Ouroboros.Network.ChainFragment.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span>    </span><a name="local-6989586621679178387"><a href="#local-6989586621679178387"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178386"><span class="hs-identifier hs-var">c'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679178378"><span class="hs-identifier hs-var">goFrags</span></a><span> </span><a href="#local-6989586621679178384"><span class="hs-identifier hs-var">nreqs</span></a><span> </span><a href="#local-6989586621679178385"><span class="hs-identifier hs-var">nbytes</span></a><span> </span><a href="#local-6989586621679178387"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-979"></a><span>    </span><span class="hs-identifier">goFrag</span><span> </span><a name="local-6989586621679178388"><a href="#local-6989586621679178388"><span class="hs-identifier">nreqs</span></a></a><span> </span><a name="local-6989586621679178389"><a href="#local-6989586621679178389"><span class="hs-identifier">nbytes</span></a></a><span> </span><a name="local-6989586621679178390"><a href="#local-6989586621679178390"><span class="hs-identifier">c'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679178391"><a href="#local-6989586621679178391"><span class="hs-identifier">b</span></a></a><span> </span><a href="Ouroboros.Network.ChainFragment.html#%3A%3C"><span class="hs-operator hs-var">:&lt;</span></a><span> </span><a name="local-6989586621679178392"><a href="#local-6989586621679178392"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679178393"><a href="#local-6989586621679178393"><span class="hs-identifier">cs</span></a></a><span>
</span><a name="line-980"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679178394"><span class="hs-identifier hs-var">nbytes'</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679178376"><span class="hs-identifier hs-var">maxbytes</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679178390"><span class="hs-identifier hs-var">c'</span></a><span> </span><a href="Ouroboros.Network.ChainFragment.html#%3A%3E"><span class="hs-operator hs-var">:&gt;</span></a><span> </span><a href="#local-6989586621679178391"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-981"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178379"><span class="hs-identifier hs-var">goFrag</span></a><span> </span><a href="#local-6989586621679178388"><span class="hs-identifier hs-var">nreqs</span></a><span> </span><a href="#local-6989586621679178394"><span class="hs-identifier hs-var">nbytes'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679178390"><span class="hs-identifier hs-var">c'</span></a><span> </span><a href="Ouroboros.Network.ChainFragment.html#%3A%3E"><span class="hs-operator hs-var">:&gt;</span></a><span> </span><a href="#local-6989586621679178391"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679178392"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679178393"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-982"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-983"></a><span>        </span><a name="local-6989586621679178394"><a href="#local-6989586621679178394"><span class="hs-identifier">nbytes'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679178389"><span class="hs-identifier hs-var">nbytes</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679178372"><span class="hs-identifier hs-var">blockFetchSize</span></a><span> </span><a href="#local-6989586621679178391"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-984"></a><span>      </span><span class="hs-comment">-- Note that we always pick the one last block that crosses the maxbytes</span><span>
</span><a name="line-985"></a><span>      </span><span class="hs-comment">-- limit. This cover the case where we otherwise wouldn't even be able to</span><span>
</span><a name="line-986"></a><span>      </span><span class="hs-comment">-- request a single block, as it's too large.</span><span>
</span><a name="line-987"></a><span>
</span><a name="line-988"></a></pre></body></html>