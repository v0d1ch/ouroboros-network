<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures      #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-partial-fields #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.TxSubmission.Inbound</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#txSubmissionInbound"><span class="hs-identifier">txSubmissionInbound</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionMempoolWriter"><span class="hs-identifier">TxSubmissionMempoolWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionInbound"><span class="hs-identifier">TraceTxSubmissionInbound</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionProtocolError"><span class="hs-identifier">TxSubmissionProtocolError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProcessedTxCount"><span class="hs-identifier">ProcessedTxCount</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Sequence.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StrictSeq</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Sequence.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Seq</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Word16</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeNoThunks</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Prelude</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forceElemsToWHNF</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">unless</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier">Control.Monad.Class.MonadSTM.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier">checkInvariant</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier">Network.TypedProtocol.Pipelined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier">N</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier">Nat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier">natToInt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.Version.html"><span class="hs-identifier">Ouroboros.Network.NodeToNode.Version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.NodeToNode.Version.html#NodeToNodeVersion"><span class="hs-identifier">NodeToNodeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission.Server</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html"><span class="hs-identifier">Ouroboros.Network.TxSubmission.Mempool.Reader</span></a></span><span>
</span><span id="line-44"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#MempoolSnapshot"><span class="hs-identifier">MempoolSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#TxSubmissionMempoolReader"><span class="hs-identifier">TxSubmissionMempoolReader</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">-- | The consensus layer functionality that the inbound side of the tx</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- submission logic requires.</span><span>
</span><span id="line-48"></span><span class="hs-comment">--</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- This is provided to the tx submission logic by the consensus layer.</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-keyword">data</span><span> </span><span id="TxSubmissionMempoolWriter"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionMempoolWriter"><span class="hs-identifier hs-var">TxSubmissionMempoolWriter</span></a></span></span><span> </span><span id="local-6989586621679264738"><span class="annot"><a href="#local-6989586621679264738"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264737"><span class="annot"><a href="#local-6989586621679264737"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621679264736"><span class="annot"><a href="#local-6989586621679264736"><span class="hs-identifier hs-type">idx</span></a></span></span><span> </span><span id="local-6989586621679264735"><span class="annot"><a href="#local-6989586621679264735"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-52"></span><span>     </span><span id="TxSubmissionMempoolWriter"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionMempoolWriter"><span class="hs-identifier hs-var">TxSubmissionMempoolWriter</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span>       </span><span class="hs-comment">-- | Compute the transaction id from a transaction.</span><span>
</span><span id="line-55"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span>       </span><span class="hs-comment">-- This is used in the protocol handler to verify a full transaction</span><span>
</span><span id="line-57"></span><span>       </span><span class="hs-comment">-- matches a previously given transaction id.</span><span>
</span><span id="line-58"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span>       </span><span id="txId"><span class="annot"><span class="annottext">TxSubmissionMempoolWriter txid tx idx m -&gt; tx -&gt; txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#txId"><span class="hs-identifier hs-var hs-var">txId</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679264737"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264738"><span class="hs-identifier hs-type">txid</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>       </span><span class="hs-comment">-- | Supply a batch of transactions to the mempool. They are either</span><span>
</span><span id="line-62"></span><span>       </span><span class="hs-comment">-- accepted or rejected individually, but in the order supplied.</span><span>
</span><span id="line-63"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-64"></span><span>       </span><span class="hs-comment">-- The 'txid's of all transactions that were added successfully are</span><span>
</span><span id="line-65"></span><span>       </span><span class="hs-comment">-- returned.</span><span>
</span><span id="line-66"></span><span>       </span><span id="mempoolAddTxs"><span class="annot"><span class="annottext">TxSubmissionMempoolWriter txid tx idx m -&gt; [tx] -&gt; m [txid]
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#mempoolAddTxs"><span class="hs-identifier hs-var hs-var">mempoolAddTxs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679264737"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679264738"><span class="hs-identifier hs-type">txid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">data</span><span> </span><span id="ProcessedTxCount"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProcessedTxCount"><span class="hs-identifier hs-var">ProcessedTxCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ProcessedTxCount"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProcessedTxCount"><span class="hs-identifier hs-var">ProcessedTxCount</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-70"></span><span>      </span><span class="hs-comment">-- | Just accepted this many transactions.</span><span>
</span><span id="line-71"></span><span>      </span><span id="ptxcAccepted"><span class="annot"><span class="annottext">ProcessedTxCount -&gt; Int
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ptxcAccepted"><span class="hs-identifier hs-var hs-var">ptxcAccepted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-72"></span><span>      </span><span class="hs-comment">-- | Just rejected this many transactions.</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ptxcRejected"><span class="annot"><span class="annottext">ProcessedTxCount -&gt; Int
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ptxcRejected"><span class="hs-identifier hs-var hs-var">ptxcRejected</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264543"><span id="local-6989586621679264545"><span class="annot"><span class="annottext">ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool
(ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool)
-&gt; (ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool)
-&gt; Eq ProcessedTxCount
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool
$c/= :: ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool
== :: ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool
$c== :: ProcessedTxCount -&gt; ProcessedTxCount -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264536"><span id="local-6989586621679264538"><span id="local-6989586621679264540"><span class="annot"><span class="annottext">Int -&gt; ProcessedTxCount -&gt; ShowS
[ProcessedTxCount] -&gt; ShowS
ProcessedTxCount -&gt; String
(Int -&gt; ProcessedTxCount -&gt; ShowS)
-&gt; (ProcessedTxCount -&gt; String)
-&gt; ([ProcessedTxCount] -&gt; ShowS)
-&gt; Show ProcessedTxCount
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ProcessedTxCount] -&gt; ShowS
$cshowList :: [ProcessedTxCount] -&gt; ShowS
show :: ProcessedTxCount -&gt; String
$cshow :: ProcessedTxCount -&gt; String
showsPrec :: Int -&gt; ProcessedTxCount -&gt; ShowS
$cshowsPrec :: Int -&gt; ProcessedTxCount -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">data</span><span> </span><span id="TraceTxSubmissionInbound"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionInbound"><span class="hs-identifier hs-var">TraceTxSubmissionInbound</span></a></span></span><span> </span><span id="local-6989586621679264725"><span class="annot"><a href="#local-6989586621679264725"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264724"><span class="annot"><a href="#local-6989586621679264724"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- | Number of transactions just about to be inserted.</span><span>
</span><span id="line-79"></span><span>    </span><span id="TraceTxSubmissionCollected"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionCollected"><span class="hs-identifier hs-var">TraceTxSubmissionCollected</span></a></span></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- | Just processed transaction pass/fail breakdown.</span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceTxSubmissionProcessed"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionProcessed"><span class="hs-identifier hs-var">TraceTxSubmissionProcessed</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProcessedTxCount"><span class="hs-identifier hs-type">ProcessedTxCount</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">-- | Server received 'MsgDone'</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceTxInboundTerminated"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundTerminated"><span class="hs-identifier hs-var">TraceTxInboundTerminated</span></a></span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceTxInboundCanRequestMoreTxs"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundCanRequestMoreTxs"><span class="hs-identifier hs-var">TraceTxInboundCanRequestMoreTxs</span></a></span></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TraceTxInboundCannotRequestMoreTxs"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundCannotRequestMoreTxs"><span class="hs-identifier hs-var">TraceTxInboundCannotRequestMoreTxs</span></a></span></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264526"><span id="local-6989586621679264528"><span class="annot"><span class="annottext">TraceTxSubmissionInbound txid tx
-&gt; TraceTxSubmissionInbound txid tx -&gt; Bool
(TraceTxSubmissionInbound txid tx
 -&gt; TraceTxSubmissionInbound txid tx -&gt; Bool)
-&gt; (TraceTxSubmissionInbound txid tx
    -&gt; TraceTxSubmissionInbound txid tx -&gt; Bool)
-&gt; Eq (TraceTxSubmissionInbound txid tx)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
forall txid tx.
TraceTxSubmissionInbound txid tx
-&gt; TraceTxSubmissionInbound txid tx -&gt; Bool
/= :: TraceTxSubmissionInbound txid tx
-&gt; TraceTxSubmissionInbound txid tx -&gt; Bool
$c/= :: forall txid tx.
TraceTxSubmissionInbound txid tx
-&gt; TraceTxSubmissionInbound txid tx -&gt; Bool
== :: TraceTxSubmissionInbound txid tx
-&gt; TraceTxSubmissionInbound txid tx -&gt; Bool
$c== :: forall txid tx.
TraceTxSubmissionInbound txid tx
-&gt; TraceTxSubmissionInbound txid tx -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264520"><span id="local-6989586621679264522"><span id="local-6989586621679264524"><span class="annot"><span class="annottext">Int -&gt; TraceTxSubmissionInbound txid tx -&gt; ShowS
[TraceTxSubmissionInbound txid tx] -&gt; ShowS
TraceTxSubmissionInbound txid tx -&gt; String
(Int -&gt; TraceTxSubmissionInbound txid tx -&gt; ShowS)
-&gt; (TraceTxSubmissionInbound txid tx -&gt; String)
-&gt; ([TraceTxSubmissionInbound txid tx] -&gt; ShowS)
-&gt; Show (TraceTxSubmissionInbound txid tx)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx -&gt; ShowS
forall txid tx. [TraceTxSubmissionInbound txid tx] -&gt; ShowS
forall txid tx. TraceTxSubmissionInbound txid tx -&gt; String
showList :: [TraceTxSubmissionInbound txid tx] -&gt; ShowS
$cshowList :: forall txid tx. [TraceTxSubmissionInbound txid tx] -&gt; ShowS
show :: TraceTxSubmissionInbound txid tx -&gt; String
$cshow :: forall txid tx. TraceTxSubmissionInbound txid tx -&gt; String
showsPrec :: Int -&gt; TraceTxSubmissionInbound txid tx -&gt; ShowS
$cshowsPrec :: forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-keyword">data</span><span> </span><span id="TxSubmissionProtocolError"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionProtocolError"><span class="hs-identifier hs-var">TxSubmissionProtocolError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-89"></span><span>       </span><span id="ProtocolErrorTxNotRequested"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProtocolErrorTxNotRequested"><span class="hs-identifier hs-var">ProtocolErrorTxNotRequested</span></a></span></span><span>
</span><span id="line-90"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span id="ProtocolErrorTxIdsNotRequested"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProtocolErrorTxIdsNotRequested"><span class="hs-identifier hs-var">ProtocolErrorTxIdsNotRequested</span></a></span></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679264512"><span id="local-6989586621679264514"><span id="local-6989586621679264516"><span class="annot"><span class="annottext">Int -&gt; TxSubmissionProtocolError -&gt; ShowS
[TxSubmissionProtocolError] -&gt; ShowS
TxSubmissionProtocolError -&gt; String
(Int -&gt; TxSubmissionProtocolError -&gt; ShowS)
-&gt; (TxSubmissionProtocolError -&gt; String)
-&gt; ([TxSubmissionProtocolError] -&gt; ShowS)
-&gt; Show TxSubmissionProtocolError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TxSubmissionProtocolError] -&gt; ShowS
$cshowList :: [TxSubmissionProtocolError] -&gt; ShowS
show :: TxSubmissionProtocolError -&gt; String
$cshow :: TxSubmissionProtocolError -&gt; String
showsPrec :: Int -&gt; TxSubmissionProtocolError -&gt; ShowS
$cshowsPrec :: Int -&gt; TxSubmissionProtocolError -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679264506"><span id="local-6989586621679264508"><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionProtocolError"><span class="hs-identifier hs-type">TxSubmissionProtocolError</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-94"></span><span>  </span><span id="local-6989586621679264503"><span class="annot"><span class="annottext">displayException :: TxSubmissionProtocolError -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">displayException</span></a></span></span><span> </span><span class="annot"><span class="annottext">TxSubmissionProtocolError
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProtocolErrorTxNotRequested"><span class="hs-identifier hs-var">ProtocolErrorTxNotRequested</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;The peer replied with a transaction we did not ask for.&quot;</span></span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">displayException</span></a></span><span> </span><span class="annot"><span class="annottext">TxSubmissionProtocolError
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProtocolErrorTxIdsNotRequested"><span class="hs-identifier hs-var">ProtocolErrorTxIdsNotRequested</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-97"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;The peer replied with more txids than we asked for.&quot;</span></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Information maintained internally in the 'txSubmissionInbound' server</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- implementation.</span><span>
</span><span id="line-102"></span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span id="local-6989586621679264500"><span id="local-6989586621679264501"></span></span><span class="hs-keyword">data</span><span> </span><span id="ServerState"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-var">ServerState</span></a></span></span><span> </span><span id="local-6989586621679264778"><span class="annot"><a href="#local-6989586621679264778"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264777"><span class="annot"><a href="#local-6989586621679264777"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ServerState"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-var">ServerState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-104"></span><span>       </span><span class="hs-comment">-- | The number of transaction identifiers that we have requested but</span><span>
</span><span id="line-105"></span><span>       </span><span class="hs-comment">-- which have not yet been replied to. We need to track this it keep</span><span>
</span><span id="line-106"></span><span>       </span><span class="hs-comment">-- our requests within the limit on the number of unacknowledged txids.</span><span>
</span><span id="line-107"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span>       </span><span id="requestedTxIdsInFlight"><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var hs-var">requestedTxIdsInFlight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word16</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>       </span><span class="hs-comment">-- | Those transactions (by their identifier) that the client has told</span><span>
</span><span id="line-111"></span><span>       </span><span class="hs-comment">-- us about, and which we have not yet acknowledged. This is kept in</span><span>
</span><span id="line-112"></span><span>       </span><span class="hs-comment">-- the order in which the client gave them to us. This is the same order</span><span>
</span><span id="line-113"></span><span>       </span><span class="hs-comment">-- in which we submit them to the mempool (or for this example, the final</span><span>
</span><span id="line-114"></span><span>       </span><span class="hs-comment">-- result order). It is also the order we acknowledge in.</span><span>
</span><span id="line-115"></span><span>       </span><span id="unacknowledgedTxIds"><span class="annot"><span class="annottext">ServerState txid tx -&gt; StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictSeq</span></span><span> </span><span class="annot"><a href="#local-6989586621679264778"><span class="hs-identifier hs-type">txid</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>       </span><span class="hs-comment">-- | Those transactions (by their identifier) that we can request. These</span><span>
</span><span id="line-118"></span><span>       </span><span class="hs-comment">-- are a subset of the 'unacknowledgedTxIds' that we have not yet</span><span>
</span><span id="line-119"></span><span>       </span><span class="hs-comment">-- requested. This is not ordered to illustrate the fact that we can</span><span>
</span><span id="line-120"></span><span>       </span><span class="hs-comment">-- request txs out of order. We also remember the size.</span><span>
</span><span id="line-121"></span><span>       </span><span id="availableTxids"><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var hs-var">availableTxids</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264778"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Type.html#TxSizeInBytes"><span class="hs-identifier hs-type">TxSizeInBytes</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span>       </span><span class="hs-comment">-- | Transactions we have successfully downloaded but have not yet added</span><span>
</span><span id="line-124"></span><span>       </span><span class="hs-comment">-- to the mempool or acknowledged. This needed because we can request</span><span>
</span><span id="line-125"></span><span>       </span><span class="hs-comment">-- transactions out of order but must use the original order when adding</span><span>
</span><span id="line-126"></span><span>       </span><span class="hs-comment">-- to the mempool or acknowledging transactions.</span><span>
</span><span id="line-127"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span>       </span><span class="hs-comment">-- However, it's worth noting that, in a few situations, some of the</span><span>
</span><span id="line-129"></span><span>       </span><span class="hs-comment">-- transaction IDs in this 'Map' may be mapped to 'Nothing':</span><span>
</span><span id="line-130"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span>       </span><span class="hs-comment">-- * Transaction IDs mapped to 'Nothing' can represent transaction IDs</span><span>
</span><span id="line-132"></span><span>       </span><span class="hs-comment">--   that were requested, but not received. This can occur because the</span><span>
</span><span id="line-133"></span><span>       </span><span class="hs-comment">--   client will not necessarily send all of the transactions that we</span><span>
</span><span id="line-134"></span><span>       </span><span class="hs-comment">--   asked for, but we still need to acknowledge those transactions.</span><span>
</span><span id="line-135"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span>       </span><span class="hs-comment">--   For example, if we request a transaction that no longer exists in</span><span>
</span><span id="line-137"></span><span>       </span><span class="hs-comment">--   the client's mempool, the client will just exclude it from the</span><span>
</span><span id="line-138"></span><span>       </span><span class="hs-comment">--   response. However, we still need to acknowledge it (i.e. remove it</span><span>
</span><span id="line-139"></span><span>       </span><span class="hs-comment">--   from the 'unacknowledgedTxIds') in order to note that we're no</span><span>
</span><span id="line-140"></span><span>       </span><span class="hs-comment">--   longer awaiting receipt of that transaction.</span><span>
</span><span id="line-141"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span>       </span><span class="hs-comment">-- * Transaction IDs mapped to 'Nothing' can represent transactions</span><span>
</span><span id="line-143"></span><span>       </span><span class="hs-comment">--   that were not requested from the client because they're already</span><span>
</span><span id="line-144"></span><span>       </span><span class="hs-comment">--   in the mempool.</span><span>
</span><span id="line-145"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span>       </span><span class="hs-comment">--   For example, if we request some transaction IDs and notice that</span><span>
</span><span id="line-147"></span><span>       </span><span class="hs-comment">--   some subset of them have are already in the mempool, we wouldn't</span><span>
</span><span id="line-148"></span><span>       </span><span class="hs-comment">--   want to bother asking for those specific transactions. Therefore,</span><span>
</span><span id="line-149"></span><span>       </span><span class="hs-comment">--   we would just insert those transaction IDs mapped to 'Nothing' to</span><span>
</span><span id="line-150"></span><span>       </span><span class="hs-comment">--   the 'bufferedTxs' such that those transactions are acknowledged,</span><span>
</span><span id="line-151"></span><span>       </span><span class="hs-comment">--   but never actually requested.</span><span>
</span><span id="line-152"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-153"></span><span>       </span><span id="bufferedTxs"><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid (Maybe tx)
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#bufferedTxs"><span class="hs-identifier hs-var hs-var">bufferedTxs</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264778"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264777"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>       </span><span class="hs-comment">-- | The number of transactions we can acknowledge on our next request</span><span>
</span><span id="line-156"></span><span>       </span><span class="hs-comment">-- for more transactions. The number here have already been removed from</span><span>
</span><span id="line-157"></span><span>       </span><span class="hs-comment">-- 'unacknowledgedTxIds'.</span><span>
</span><span id="line-158"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span>       </span><span id="numTxsToAcknowledge"><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var hs-var">numTxsToAcknowledge</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word16</span></a></span><span>
</span><span id="line-160"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264488"><span id="local-6989586621679264490"><span id="local-6989586621679264492"><span class="annot"><span class="annottext">Int -&gt; ServerState txid tx -&gt; ShowS
[ServerState txid tx] -&gt; ShowS
ServerState txid tx -&gt; String
(Int -&gt; ServerState txid tx -&gt; ShowS)
-&gt; (ServerState txid tx -&gt; String)
-&gt; ([ServerState txid tx] -&gt; ShowS)
-&gt; Show (ServerState txid tx)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall txid tx.
(Show txid, Show tx) =&gt;
Int -&gt; ServerState txid tx -&gt; ShowS
forall txid tx.
(Show txid, Show tx) =&gt;
[ServerState txid tx] -&gt; ShowS
forall txid tx.
(Show txid, Show tx) =&gt;
ServerState txid tx -&gt; String
showList :: [ServerState txid tx] -&gt; ShowS
$cshowList :: forall txid tx.
(Show txid, Show tx) =&gt;
[ServerState txid tx] -&gt; ShowS
show :: ServerState txid tx -&gt; String
$cshow :: forall txid tx.
(Show txid, Show tx) =&gt;
ServerState txid tx -&gt; String
showsPrec :: Int -&gt; ServerState txid tx -&gt; ShowS
$cshowsPrec :: forall txid tx.
(Show txid, Show tx) =&gt;
Int -&gt; ServerState txid tx -&gt; ShowS
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. ServerState txid tx -&gt; Rep (ServerState txid tx) x)
-&gt; (forall x. Rep (ServerState txid tx) x -&gt; ServerState txid tx)
-&gt; Generic (ServerState txid tx)
forall x. Rep (ServerState txid tx) x -&gt; ServerState txid tx
forall x. ServerState txid tx -&gt; Rep (ServerState txid tx) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall txid tx x.
Rep (ServerState txid tx) x -&gt; ServerState txid tx
forall txid tx x.
ServerState txid tx -&gt; Rep (ServerState txid tx) x
$cto :: forall txid tx x.
Rep (ServerState txid tx) x -&gt; ServerState txid tx
$cfrom :: forall txid tx x.
ServerState txid tx -&gt; Rep (ServerState txid tx) x
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span id="local-6989586621679264483"><span id="local-6989586621679264484"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679264477"><span id="local-6989586621679264479"><span id="local-6989586621679264481"><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264484"><span class="hs-identifier hs-type">txid</span></a></span><span>
</span><span id="line-164"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264483"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-165"></span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264484"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264483"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span id="local-6989586621679264745"><span id="local-6989586621679264746"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#initialServerState"><span class="hs-identifier hs-type">initialServerState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264746"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264745"><span class="hs-identifier hs-type">tx</span></a></span></span></span><span>
</span><span id="line-168"></span><span id="initialServerState"><span class="annot"><span class="annottext">initialServerState :: ServerState txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#initialServerState"><span class="hs-identifier hs-var hs-var">initialServerState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
-&gt; StrictSeq txid
-&gt; Map txid TxSizeInBytes
-&gt; Map txid (Maybe tx)
-&gt; Word16
-&gt; ServerState txid tx
forall txid tx.
Word16
-&gt; StrictSeq txid
-&gt; Map txid TxSizeInBytes
-&gt; Map txid (Maybe tx)
-&gt; Word16
-&gt; ServerState txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-var">ServerState</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
forall a. StrictSeq a
</span><span class="hs-identifier hs-var">Seq.empty</span></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
forall k a. Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
forall k a. Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#txSubmissionInbound"><span class="hs-identifier hs-type">txSubmissionInbound</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679264472"><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264471"><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621679264470"><span class="annot"><a href="#local-6989586621679264470"><span class="hs-identifier hs-type">idx</span></a></span></span><span> </span><span id="local-6989586621679264469"><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-173"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span>
</span><span id="line-174"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span>
</span><span id="line-175"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-176"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-177"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadThrow</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-178"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionInbound"><span class="hs-identifier hs-type">TraceTxSubmissionInbound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word16</span></a></span><span>         </span><span class="hs-comment">-- ^ Maximum number of unacknowledged txids allowed</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#TxSubmissionMempoolReader"><span class="hs-identifier hs-type">TxSubmissionMempoolReader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264470"><span class="hs-identifier hs-type">idx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionMempoolWriter"><span class="hs-identifier hs-type">TxSubmissionMempoolWriter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264470"><span class="hs-identifier hs-type">idx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.Version.html#NodeToNodeVersion"><span class="hs-identifier hs-type">NodeToNodeVersion</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#TxSubmissionServerPipelined"><span class="hs-identifier hs-type">TxSubmissionServerPipelined</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span id="txSubmissionInbound"><span class="annot"><span class="annottext">txSubmissionInbound :: Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; Word16
-&gt; TxSubmissionMempoolReader txid tx idx m
-&gt; TxSubmissionMempoolWriter txid tx idx m
-&gt; NodeToNodeVersion
-&gt; TxSubmissionServerPipelined txid tx m ()
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#txSubmissionInbound"><span class="hs-identifier hs-var hs-var">txSubmissionInbound</span></a></span></span><span> </span><span id="local-6989586621679264468"><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679264467"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264467"><span class="hs-identifier hs-var">maxUnacked</span></a></span></span><span> </span><span id="local-6989586621679264466"><span class="annot"><span class="annottext">TxSubmissionMempoolReader txid tx idx m
</span><a href="#local-6989586621679264466"><span class="hs-identifier hs-var">mpReader</span></a></span></span><span> </span><span id="local-6989586621679264465"><span class="annot"><span class="annottext">TxSubmissionMempoolWriter txid tx idx m
</span><a href="#local-6989586621679264465"><span class="hs-identifier hs-var">mpWriter</span></a></span></span><span> </span><span id="local-6989586621679264464"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679264464"><span class="hs-identifier hs-var">_version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">m (ServerStIdle 'Z txid tx m ())
-&gt; TxSubmissionServerPipelined txid tx m ()
forall (m :: * -&gt; *) txid tx a.
m (ServerStIdle 'Z txid tx m a)
-&gt; TxSubmissionServerPipelined txid tx m a
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#TxSubmissionServerPipelined"><span class="hs-identifier hs-var">TxSubmissionServerPipelined</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle 'Z txid tx m ())
 -&gt; TxSubmissionServerPipelined txid tx m ())
-&gt; m (ServerStIdle 'Z txid tx m ())
-&gt; TxSubmissionServerPipelined txid tx m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><span class="annottext">StatefulM (ServerState txid tx) 'Z txid tx m
-&gt; ServerState txid tx -&gt; m (ServerStIdle 'Z txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var">continueWithStateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat 'Z -&gt; StatefulM (ServerState txid tx) 'Z txid tx m
forall (n :: N).
Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264461"><span class="hs-identifier hs-var">serverIdle</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
forall txid tx. ServerState txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#initialServerState"><span class="hs-identifier hs-var">initialServerState</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">-- TODO #1656: replace these fixed limits by policies based on</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- TxSizeInBytes and delta-Q and the bandwidth/delay product.</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">-- These numbers are for demo purposes only, the throughput will be low.</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621679264459"><span class="annot"><span class="annottext">maxTxIdsToRequest :: Word16
</span><a href="#local-6989586621679264459"><span class="hs-identifier hs-var hs-var">maxTxIdsToRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">3</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word16</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621679264458"><span class="annot"><span class="annottext">maxTxToRequest :: Word16
</span><a href="#local-6989586621679264458"><span class="hs-identifier hs-var hs-var">maxTxToRequest</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Word16</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#TxSubmissionMempoolReader"><span class="hs-identifier hs-type">TxSubmissionMempoolReader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679264456"><span class="annot"><span class="annottext">STM m (MempoolSnapshot txid tx idx)
mempoolGetSnapshot :: forall txid tx idx (m :: * -&gt; *).
TxSubmissionMempoolReader txid tx idx m
-&gt; STM m (MempoolSnapshot txid tx idx)
mempoolGetSnapshot :: STM m (MempoolSnapshot txid tx idx)
</span><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#mempoolGetSnapshot"><span class="hs-identifier hs-var hs-var">mempoolGetSnapshot</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxSubmissionMempoolReader txid tx idx m
</span><a href="#local-6989586621679264466"><span class="hs-identifier hs-var">mpReader</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#TxSubmissionMempoolWriter"><span class="hs-identifier hs-type">TxSubmissionMempoolWriter</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679264454"><span class="annot"><span class="annottext">tx -&gt; txid
txId :: tx -&gt; txid
txId :: forall txid tx idx (m :: * -&gt; *).
TxSubmissionMempoolWriter txid tx idx m -&gt; tx -&gt; txid
</span><a href="#local-6989586621679264454"><span class="hs-identifier hs-var hs-var">txId</span></a></span></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264453"><span class="annot"><span class="annottext">[tx] -&gt; m [txid]
mempoolAddTxs :: [tx] -&gt; m [txid]
mempoolAddTxs :: forall txid tx idx (m :: * -&gt; *).
TxSubmissionMempoolWriter txid tx idx m -&gt; [tx] -&gt; m [txid]
</span><a href="#local-6989586621679264453"><span class="hs-identifier hs-var hs-var">mempoolAddTxs</span></a></span></span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxSubmissionMempoolWriter txid tx idx m
</span><a href="#local-6989586621679264465"><span class="hs-identifier hs-var">mpWriter</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><a href="#local-6989586621679264461"><span class="hs-identifier hs-type">serverIdle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264748"><span class="annot"><a href="#local-6989586621679264748"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">N</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-203"></span><span>                  </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264748"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-204"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-type">StatefulM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679264748"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621679264461"><span class="annot"><span class="annottext">serverIdle :: Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264461"><span class="hs-identifier hs-var hs-var">serverIdle</span></a></span></span><span> </span><span id="local-6989586621679264452"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264452"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ServerState txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulM (ServerState txid tx) n txid tx m
forall s (n :: N) txid tx (m :: * -&gt; *).
(s -&gt; m (ServerStIdle n txid tx m ())) -&gt; StatefulM s n txid tx m
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-var">StatefulM</span></a></span><span> </span><span class="annot"><span class="annottext">((ServerState txid tx -&gt; m (ServerStIdle n txid tx m ()))
 -&gt; StatefulM (ServerState txid tx) n txid tx m)
-&gt; (ServerState txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulM (ServerState txid tx) n txid tx m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679264450"><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264452"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Bool
forall k. ServerState k tx -&gt; Bool
</span><a href="#local-6989586621679264449"><span class="hs-identifier hs-var">canRequestMoreTxs</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-208"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>            </span><span class="hs-comment">-- There are no replies in flight, but we do know some more txs we</span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-comment">-- can ask for, so lets ask for them and more txids.</span><span>
</span><span id="line-211"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TraceTxSubmissionInbound txid tx
forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundCanRequestMoreTxs"><span class="hs-identifier hs-var">TraceTxInboundCanRequestMoreTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Int
forall (n :: N). Nat n -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">natToInt</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264452"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>            </span><span class="annot"><span class="annottext">ServerStIdle n txid tx m () -&gt; m (ServerStIdle n txid tx m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIdle n txid tx m () -&gt; m (ServerStIdle n txid tx m ()))
-&gt; ServerStIdle n txid tx m () -&gt; m (ServerStIdle n txid tx m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful (ServerState txid tx) n txid tx m
-&gt; ServerState txid tx -&gt; ServerStIdle n txid tx m ()
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
Stateful s n txid tx m -&gt; s -&gt; ServerStIdle n txid tx m ()
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Stateful (ServerState txid tx) n txid tx m
forall (n :: N).
Nat n -&gt; Stateful (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264447"><span class="hs-identifier hs-var">serverReqTxs</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TraceTxSubmissionInbound txid tx
forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundCannotRequestMoreTxs"><span class="hs-identifier hs-var">TraceTxInboundCannotRequestMoreTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Int
forall (n :: N). Nat n -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">natToInt</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264452"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>            </span><span class="hs-comment">-- There's no replies in flight, and we have no more txs we can</span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-comment">-- ask for so the only remaining thing to do is to ask for more</span><span>
</span><span id="line-218"></span><span>            </span><span class="hs-comment">-- txids. Since this is the only thing to do now, we make this a</span><span>
</span><span id="line-219"></span><span>            </span><span class="hs-comment">-- blocking call.</span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264446"><span class="annot"><span class="annottext">numTxIdsToRequest :: Word16
</span><a href="#local-6989586621679264446"><span class="hs-identifier hs-var hs-var">numTxIdsToRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264459"><span class="hs-identifier hs-var">maxTxIdsToRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`min`</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264467"><span class="hs-identifier hs-var">maxUnacked</span></a></span><span>
</span><span id="line-221"></span><span>            </span><span class="annot"><span class="annottext">Bool
-&gt; m (ServerStIdle 'Z txid tx m ())
-&gt; m (ServerStIdle 'Z txid tx m ())
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span>
</span><span id="line-222"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid -&gt; Bool
forall a. StrictSeq a -&gt; Bool
</span><span class="hs-identifier hs-var">Seq.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; StrictSeq txid
forall txid tx. ServerState txid tx -&gt; StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid TxSizeInBytes
forall txid tx. ServerState txid tx -&gt; Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var hs-var">availableTxids</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid (Maybe tx)
forall txid tx. ServerState txid tx -&gt; Map txid (Maybe tx)
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#bufferedTxs"><span class="hs-identifier hs-var hs-var">bufferedTxs</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle 'Z txid tx m ())
 -&gt; m (ServerStIdle 'Z txid tx m ()))
-&gt; m (ServerStIdle 'Z txid tx m ())
-&gt; m (ServerStIdle 'Z txid tx m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-225"></span><span>              </span><span class="annot"><span class="annottext">ServerStIdle 'Z txid tx m () -&gt; m (ServerStIdle 'Z txid tx m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIdle 'Z txid tx m () -&gt; m (ServerStIdle 'Z txid tx m ()))
-&gt; ServerStIdle 'Z txid tx m () -&gt; m (ServerStIdle 'Z txid tx m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-226"></span><span>              </span><span class="annot"><span class="annottext">Word16
-&gt; Word16
-&gt; m ()
-&gt; (NonEmpty (txid, TxSizeInBytes)
    -&gt; m (ServerStIdle 'Z txid tx m ()))
-&gt; ServerStIdle 'Z txid tx m ()
forall (m :: * -&gt; *) a txid tx.
Word16
-&gt; Word16
-&gt; m a
-&gt; (NonEmpty (txid, TxSizeInBytes)
    -&gt; m (ServerStIdle 'Z txid tx m a))
-&gt; ServerStIdle 'Z txid tx m a
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#SendMsgRequestTxIdsBlocking"><span class="hs-identifier hs-var">SendMsgRequestTxIdsBlocking</span></a></span><span>
</span><span id="line-227"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var hs-var">numTxsToAcknowledge</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>                </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264446"><span class="hs-identifier hs-var">numTxIdsToRequest</span></a></span><span>
</span><span id="line-229"></span><span>                </span><span class="hs-comment">-- Our result if the client terminates the protocol</span><span>
</span><span id="line-230"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TraceTxSubmissionInbound txid tx
forall txid tx. TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundTerminated"><span class="hs-identifier hs-var">TraceTxInboundTerminated</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">StatefulCollect (ServerState txid tx) 'Z txid tx m
-&gt; ServerState txid tx
-&gt; Collect txid tx
-&gt; m (ServerStIdle 'Z txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulCollect s n txid tx m
-&gt; s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#collectAndContinueWithState"><span class="hs-identifier hs-var">collectAndContinueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat 'Z -&gt; StatefulCollect (ServerState txid tx) 'Z txid tx m
forall (n :: N).
Nat n -&gt; StatefulCollect (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264439"><span class="hs-identifier hs-var">handleReply</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Zero</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-232"></span><span>                    </span><span class="annot"><span class="annottext">numTxsToAcknowledge :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var">numTxsToAcknowledge</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span>
</span><span id="line-233"></span><span>                    </span><span class="annot"><span class="annottext">requestedTxIdsInFlight :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264446"><span class="hs-identifier hs-var">numTxIdsToRequest</span></a></span><span>
</span><span id="line-234"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-235"></span><span>                </span><span class="annot"><span class="annottext">(Collect txid tx -&gt; m (ServerStIdle 'Z txid tx m ()))
-&gt; (NonEmpty (txid, TxSizeInBytes) -&gt; Collect txid tx)
-&gt; NonEmpty (txid, TxSizeInBytes)
-&gt; m (ServerStIdle 'Z txid tx m ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; [(txid, TxSizeInBytes)] -&gt; Collect txid tx
forall txid tx.
Word16 -&gt; [(txid, TxSizeInBytes)] -&gt; Collect txid tx
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#CollectTxIds"><span class="hs-identifier hs-var">CollectTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264446"><span class="hs-identifier hs-var">numTxIdsToRequest</span></a></span><span>
</span><span id="line-236"></span><span>                </span><span class="annot"><span class="annottext">([(txid, TxSizeInBytes)] -&gt; Collect txid tx)
-&gt; (NonEmpty (txid, TxSizeInBytes) -&gt; [(txid, TxSizeInBytes)])
-&gt; NonEmpty (txid, TxSizeInBytes)
-&gt; Collect txid tx
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (txid, TxSizeInBytes) -&gt; [(txid, TxSizeInBytes)]
forall a. NonEmpty a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">NonEmpty.toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Succ</span></a></span><span> </span><span id="local-6989586621679264434"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264434"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Bool
forall k. ServerState k tx -&gt; Bool
</span><a href="#local-6989586621679264449"><span class="hs-identifier hs-var">canRequestMoreTxs</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-239"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>            </span><span class="hs-comment">-- We have replies in flight and we should eagerly collect them if</span><span>
</span><span id="line-241"></span><span>            </span><span class="hs-comment">-- available, but there are transactions to request too so we</span><span>
</span><span id="line-242"></span><span>            </span><span class="hs-comment">-- should not block waiting for replies.</span><span>
</span><span id="line-243"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-comment">-- Having requested more transactions, we opportunistically ask</span><span>
</span><span id="line-245"></span><span>            </span><span class="hs-comment">-- for more txids in a non-blocking way. This is how we pipeline</span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-comment">-- asking for both txs and txids.</span><span>
</span><span id="line-247"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-248"></span><span>            </span><span class="hs-comment">-- It's important not to pipeline more requests for txids when we</span><span>
</span><span id="line-249"></span><span>            </span><span class="hs-comment">-- have no txs to ask for, since (with no other guard) this will</span><span>
</span><span id="line-250"></span><span>            </span><span class="hs-comment">-- put us into a busy-polling loop.</span><span>
</span><span id="line-251"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TraceTxSubmissionInbound txid tx
forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundCanRequestMoreTxs"><span class="hs-identifier hs-var">TraceTxInboundCanRequestMoreTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Int
forall (n :: N). Nat n -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">natToInt</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264452"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>            </span><span class="annot"><span class="annottext">ServerStIdle ('S n) txid tx m ()
-&gt; m (ServerStIdle ('S n) txid tx m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIdle ('S n) txid tx m ()
 -&gt; m (ServerStIdle ('S n) txid tx m ()))
-&gt; ServerStIdle ('S n) txid tx m ()
-&gt; m (ServerStIdle ('S n) txid tx m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ServerStIdle ('S n) txid tx m ())
-&gt; (Collect txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; ServerStIdle ('S n) txid tx m ()
forall (n :: N) txid tx (m :: * -&gt; *) a.
Maybe (ServerStIdle ('S n) txid tx m a)
-&gt; (Collect txid tx -&gt; m (ServerStIdle n txid tx m a))
-&gt; ServerStIdle ('S n) txid tx m a
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#CollectPipelined"><span class="hs-identifier hs-var">CollectPipelined</span></a></span><span>
</span><span id="line-254"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerStIdle ('S n) txid tx m ()
-&gt; Maybe (ServerStIdle ('S n) txid tx m ())
forall a. a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stateful (ServerState txid tx) ('S n) txid tx m
-&gt; ServerState txid tx -&gt; ServerStIdle ('S n) txid tx m ()
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
Stateful s n txid tx m -&gt; s -&gt; ServerStIdle n txid tx m ()
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat ('S n) -&gt; Stateful (ServerState txid tx) ('S n) txid tx m
forall (n :: N).
Nat n -&gt; Stateful (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264447"><span class="hs-identifier hs-var">serverReqTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S n)
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Succ</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264434"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StatefulCollect (ServerState txid tx) n txid tx m
-&gt; ServerState txid tx
-&gt; Collect txid tx
-&gt; m (ServerStIdle n txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulCollect s n txid tx m
-&gt; s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#collectAndContinueWithState"><span class="hs-identifier hs-var">collectAndContinueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; StatefulCollect (ServerState txid tx) n txid tx m
forall (n :: N).
Nat n -&gt; StatefulCollect (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264439"><span class="hs-identifier hs-var">handleReply</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264434"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TraceTxSubmissionInbound txid tx
forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxInboundCannotRequestMoreTxs"><span class="hs-identifier hs-var">TraceTxInboundCannotRequestMoreTxs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Int
forall (n :: N). Nat n -&gt; Int
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">natToInt</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264452"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>            </span><span class="hs-comment">-- In this case there is nothing else to do so we block until we</span><span>
</span><span id="line-260"></span><span>            </span><span class="hs-comment">-- collect a reply.</span><span>
</span><span id="line-261"></span><span>            </span><span class="annot"><span class="annottext">ServerStIdle ('S n) txid tx m ()
-&gt; m (ServerStIdle ('S n) txid tx m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIdle ('S n) txid tx m ()
 -&gt; m (ServerStIdle ('S n) txid tx m ()))
-&gt; ServerStIdle ('S n) txid tx m ()
-&gt; m (ServerStIdle ('S n) txid tx m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ServerStIdle ('S n) txid tx m ())
-&gt; (Collect txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; ServerStIdle ('S n) txid tx m ()
forall (n :: N) txid tx (m :: * -&gt; *) a.
Maybe (ServerStIdle ('S n) txid tx m a)
-&gt; (Collect txid tx -&gt; m (ServerStIdle n txid tx m a))
-&gt; ServerStIdle ('S n) txid tx m a
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#CollectPipelined"><span class="hs-identifier hs-var">CollectPipelined</span></a></span><span>
</span><span id="line-262"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ServerStIdle ('S n) txid tx m ())
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-263"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StatefulCollect (ServerState txid tx) n txid tx m
-&gt; ServerState txid tx
-&gt; Collect txid tx
-&gt; m (ServerStIdle n txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulCollect s n txid tx m
-&gt; s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#collectAndContinueWithState"><span class="hs-identifier hs-var">collectAndContinueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; StatefulCollect (ServerState txid tx) n txid tx m
forall (n :: N).
Nat n -&gt; StatefulCollect (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264439"><span class="hs-identifier hs-var">handleReply</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264434"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264450"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-265"></span><span>        </span><span id="local-6989586621679264728"><span class="annot"><a href="#local-6989586621679264449"><span class="hs-identifier hs-type">canRequestMoreTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264728"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-266"></span><span>        </span><span id="local-6989586621679264449"><span class="annot"><span class="annottext">canRequestMoreTxs :: ServerState k tx -&gt; Bool
</span><a href="#local-6989586621679264449"><span class="hs-identifier hs-var hs-var">canRequestMoreTxs</span></a></span></span><span> </span><span id="local-6989586621679264432"><span class="annot"><span class="annottext">ServerState k tx
</span><a href="#local-6989586621679264432"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map k TxSizeInBytes -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState k tx -&gt; Map k TxSizeInBytes
forall txid tx. ServerState txid tx -&gt; Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var hs-var">availableTxids</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState k tx
</span><a href="#local-6989586621679264432"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><a href="#local-6989586621679264439"><span class="hs-identifier hs-type">handleReply</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264696"><span class="annot"><a href="#local-6989586621679264696"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">N</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-270"></span><span>                   </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264696"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulCollect"><span class="hs-identifier hs-type">StatefulCollect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679264696"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679264439"><span class="annot"><span class="annottext">handleReply :: Nat n -&gt; StatefulCollect (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264439"><span class="hs-identifier hs-var hs-var">handleReply</span></a></span></span><span> </span><span id="local-6989586621679264430"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264430"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ServerState txid tx
 -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulCollect (ServerState txid tx) n txid tx m
forall s (n :: N) txid tx (m :: * -&gt; *).
(s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulCollect s n txid tx m
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulCollect"><span class="hs-identifier hs-var">StatefulCollect</span></a></span><span> </span><span class="annot"><span class="annottext">((ServerState txid tx
  -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ()))
 -&gt; StatefulCollect (ServerState txid tx) n txid tx m)
-&gt; (ServerState txid tx
    -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulCollect (ServerState txid tx) n txid tx m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679264428"><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679264427"><span class="annot"><span class="annottext">Collect txid tx
</span><a href="#local-6989586621679264427"><span class="hs-identifier hs-var">collect</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Collect txid tx
</span><a href="#local-6989586621679264427"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#CollectTxIds"><span class="hs-identifier hs-type">CollectTxIds</span></a></span><span> </span><span id="local-6989586621679264426"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264426"><span class="hs-identifier hs-var">reqNo</span></a></span></span><span> </span><span id="local-6989586621679264425"><span class="annot"><span class="annottext">[(txid, TxSizeInBytes)]
</span><a href="#local-6989586621679264425"><span class="hs-identifier hs-var">txids</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>        </span><span class="hs-comment">-- Check they didn't send more than we asked for. We don't need to</span><span>
</span><span id="line-275"></span><span>        </span><span class="hs-comment">-- check for a minimum: the blocking case checks for non-zero</span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-comment">-- elsewhere, and for the non-blocking case it is quite normal for</span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-comment">-- them to send us none.</span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264424"><span class="annot"><span class="annottext">txidsSeq :: StrictSeq txid
</span><a href="#local-6989586621679264424"><span class="hs-identifier hs-var hs-var">txidsSeq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[txid] -&gt; StrictSeq txid
forall a. [a] -&gt; StrictSeq a
</span><span class="hs-identifier hs-var">Seq.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((txid, TxSizeInBytes) -&gt; txid)
-&gt; [(txid, TxSizeInBytes)] -&gt; [txid]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(txid, TxSizeInBytes) -&gt; txid
forall a b. (a, b) -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(txid, TxSizeInBytes)]
</span><a href="#local-6989586621679264425"><span class="hs-identifier hs-var">txids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>            </span><span id="local-6989586621679264422"><span class="annot"><span class="annottext">txidsMap :: Map txid TxSizeInBytes
</span><a href="#local-6989586621679264422"><span class="hs-identifier hs-var hs-var">txidsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(txid, TxSizeInBytes)] -&gt; Map txid TxSizeInBytes
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(txid, TxSizeInBytes)]
</span><a href="#local-6989586621679264425"><span class="hs-identifier hs-var">txids</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq txid -&gt; Int
forall a. StrictSeq a -&gt; Int
</span><span class="hs-identifier hs-var">Seq.length</span></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264424"><span class="hs-identifier hs-var">txidsSeq</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264426"><span class="hs-identifier hs-var">reqNo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-282"></span><span>          </span><span class="annot"><span class="annottext">TxSubmissionProtocolError -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">TxSubmissionProtocolError
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProtocolErrorTxIdsNotRequested"><span class="hs-identifier hs-var">ProtocolErrorTxIdsNotRequested</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-comment">-- Upon receiving a batch of new txids we extend our available set,</span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-comment">-- and extended the unacknowledged sequence.</span><span>
</span><span id="line-286"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-comment">-- We also pre-emptively acknowledge those txids that are already in</span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-comment">-- the mempool. This prevents us from requesting their corresponding</span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-comment">-- transactions again in the future.</span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264417"><span class="annot"><span class="annottext">st' :: ServerState txid tx
</span><a href="#local-6989586621679264417"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-291"></span><span>          </span><span class="annot"><span class="annottext">requestedTxIdsInFlight :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264426"><span class="hs-identifier hs-var">reqNo</span></a></span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-293"></span><span>        </span><span id="local-6989586621679264416"><span class="annot"><span class="annottext">MempoolSnapshot txid tx idx
</span><a href="#local-6989586621679264416"><span class="hs-identifier hs-var">mpSnapshot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (MempoolSnapshot txid tx idx)
-&gt; m (MempoolSnapshot txid tx idx)
forall (m :: * -&gt; *) a.
(MonadSTM m, ?callStack::CallStack) =&gt;
STM m a -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (MempoolSnapshot txid tx idx)
</span><a href="#local-6989586621679264456"><span class="hs-identifier hs-var">mempoolGetSnapshot</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">StatefulM (ServerState txid tx) n txid tx m
-&gt; ServerState txid tx -&gt; m (ServerStIdle n txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var">continueWithStateM</span></a></span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
forall (n :: N).
Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264461"><span class="hs-identifier hs-var">serverIdle</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264430"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx
-&gt; StrictSeq txid
-&gt; Map txid TxSizeInBytes
-&gt; MempoolSnapshot txid tx idx
-&gt; ServerState txid tx
</span><a href="#local-6989586621679264414"><span class="hs-identifier hs-var">acknowledgeTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264417"><span class="hs-identifier hs-var">st'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264424"><span class="hs-identifier hs-var">txidsSeq</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264422"><span class="hs-identifier hs-var">txidsMap</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot txid tx idx
</span><a href="#local-6989586621679264416"><span class="hs-identifier hs-var">mpSnapshot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#CollectTxs"><span class="hs-identifier hs-type">CollectTxs</span></a></span><span> </span><span id="local-6989586621679264412"><span class="annot"><span class="annottext">[txid]
</span><a href="#local-6989586621679264412"><span class="hs-identifier hs-var">txids</span></a></span></span><span> </span><span id="local-6989586621679264411"><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264411"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>        </span><span class="hs-comment">-- To start with we have to verify that the txs they have sent us do</span><span>
</span><span id="line-300"></span><span>        </span><span class="hs-comment">-- correspond to the txs we asked for. This is slightly complicated by</span><span>
</span><span id="line-301"></span><span>        </span><span class="hs-comment">-- the fact that in general we get a subset of the txs that we asked</span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-comment">-- for. We should never get a tx we did not ask for. We take a strict</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-comment">-- approach to this and check it.</span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679264410"><span class="hs-identifier hs-type">txsMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-306"></span><span>            </span><span id="local-6989586621679264410"><span class="annot"><span class="annottext">txsMap :: Map txid tx
</span><a href="#local-6989586621679264410"><span class="hs-identifier hs-var hs-var">txsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(txid, tx)] -&gt; Map txid tx
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">tx -&gt; txid
</span><a href="#local-6989586621679264454"><span class="hs-identifier hs-var">txId</span></a></span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679264409"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679264409"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679264409"><span class="annot"><span class="annottext">tx
</span><a href="#local-6989586621679264409"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264411"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>            </span><span id="local-6989586621679264408"><span class="annot"><span class="annottext">txidsReceived :: Set txid
</span><a href="#local-6989586621679264408"><span class="hs-identifier hs-var hs-var">txidsReceived</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid tx -&gt; Set txid
forall k a. Map k a -&gt; Set k
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid tx
</span><a href="#local-6989586621679264410"><span class="hs-identifier hs-var">txsMap</span></a></span><span>
</span><span id="line-309"></span><span>            </span><span id="local-6989586621679264406"><span class="annot"><span class="annottext">txidsRequested :: Set txid
</span><a href="#local-6989586621679264406"><span class="hs-identifier hs-var hs-var">txidsRequested</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[txid] -&gt; Set txid
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[txid]
</span><a href="#local-6989586621679264412"><span class="hs-identifier hs-var">txids</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set txid
</span><a href="#local-6989586621679264408"><span class="hs-identifier hs-var">txidsReceived</span></a></span><span> </span><span class="annot"><span class="annottext">Set txid -&gt; Set txid -&gt; Bool
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-operator hs-var">`Set.isSubsetOf`</span></a></span><span> </span><span class="annot"><span class="annottext">Set txid
</span><a href="#local-6989586621679264406"><span class="hs-identifier hs-var">txidsRequested</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-312"></span><span>          </span><span class="annot"><span class="annottext">TxSubmissionProtocolError -&gt; m ()
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">TxSubmissionProtocolError
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProtocolErrorTxNotRequested"><span class="hs-identifier hs-var">ProtocolErrorTxNotRequested</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>            </span><span class="hs-comment">-- We can match up all the txids we requested, with those we</span><span>
</span><span id="line-315"></span><span>            </span><span class="hs-comment">-- received.</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679264403"><span class="hs-identifier hs-type">txIdsRequestedWithTxsReceived</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>            </span><span id="local-6989586621679264403"><span class="annot"><span class="annottext">txIdsRequestedWithTxsReceived :: Map txid (Maybe tx)
</span><a href="#local-6989586621679264403"><span class="hs-identifier hs-var hs-var">txIdsRequestedWithTxsReceived</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>                </span><span class="annot"><span class="annottext">(tx -&gt; Maybe tx) -&gt; Map txid tx -&gt; Map txid (Maybe tx)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">tx -&gt; Maybe tx
forall a. a -&gt; Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid tx
</span><a href="#local-6989586621679264410"><span class="hs-identifier hs-var">txsMap</span></a></span><span>
</span><span id="line-319"></span><span>             </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(txid -&gt; Maybe tx) -&gt; Set txid -&gt; Map txid (Maybe tx)
forall k a. (k -&gt; a) -&gt; Set k -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe tx -&gt; txid -&gt; Maybe tx
forall a b. a -&gt; b -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe tx
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set txid
</span><a href="#local-6989586621679264406"><span class="hs-identifier hs-var">txidsRequested</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>            </span><span class="hs-comment">-- We still have to acknowledge the txids we were given. This</span><span>
</span><span id="line-322"></span><span>            </span><span class="hs-comment">-- combined with the fact that we request txs out of order means</span><span>
</span><span id="line-323"></span><span>            </span><span class="hs-comment">-- our bufferedTxs has to track all the txids we asked for, even</span><span>
</span><span id="line-324"></span><span>            </span><span class="hs-comment">-- though not all have replies.</span><span>
</span><span id="line-325"></span><span>            </span><span id="local-6989586621679264399"><span class="annot"><span class="annottext">bufferedTxs1 :: Map txid (Maybe tx)
</span><a href="#local-6989586621679264399"><span class="hs-identifier hs-var hs-var">bufferedTxs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid (Maybe tx)
forall txid tx. ServerState txid tx -&gt; Map txid (Maybe tx)
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#bufferedTxs"><span class="hs-identifier hs-var hs-var">bufferedTxs</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264403"><span class="hs-identifier hs-var">txIdsRequestedWithTxsReceived</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>            </span><span class="hs-comment">-- We have to update the unacknowledgedTxIds here eagerly and not</span><span>
</span><span id="line-328"></span><span>            </span><span class="hs-comment">-- delay it to serverReqTxs, otherwise we could end up blocking in</span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-comment">-- serverIdle on more pipelined results rather than being able to</span><span>
</span><span id="line-330"></span><span>            </span><span class="hs-comment">-- move on.</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-comment">-- Check if having received more txs we can now confirm any (in</span><span>
</span><span id="line-333"></span><span>            </span><span class="hs-comment">-- strict order in the unacknowledgedTxIds sequence).</span><span>
</span><span id="line-334"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679264398"><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264398"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264397"><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264397"><span class="hs-identifier hs-var">unacknowledgedTxIds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-335"></span><span>              </span><span class="annot"><span class="annottext">(txid -&gt; Bool)
-&gt; StrictSeq txid -&gt; (StrictSeq txid, StrictSeq txid)
forall a. (a -&gt; Bool) -&gt; StrictSeq a -&gt; (StrictSeq a, StrictSeq a)
</span><span class="hs-identifier hs-var">Seq.spanl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">txid -&gt; Map txid (Maybe tx) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-operator hs-var">`Map.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264399"><span class="hs-identifier hs-var">bufferedTxs1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; StrictSeq txid
forall txid tx. ServerState txid tx -&gt; StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>            </span><span class="hs-comment">-- If so we can submit the acknowledged txs to our local mempool</span><span>
</span><span id="line-338"></span><span>            </span><span id="local-6989586621679264394"><span class="annot"><span class="annottext">txsReady :: [tx]
</span><a href="#local-6989586621679264394"><span class="hs-identifier hs-var hs-var">txsReady</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(txid -&gt; [tx] -&gt; [tx]) -&gt; [tx] -&gt; StrictSeq txid -&gt; [tx]
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679264392"><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264392"><span class="hs-identifier hs-var">txid</span></a></span></span><span> </span><span id="local-6989586621679264391"><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264391"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[tx] -&gt; (tx -&gt; [tx]) -&gt; Maybe tx -&gt; [tx]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264391"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">tx -&gt; [tx] -&gt; [tx]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264391"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264399"><span class="hs-identifier hs-var">bufferedTxs1</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; txid -&gt; Maybe tx
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-operator hs-var">Map.!</span></a></span><span> </span><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264392"><span class="hs-identifier hs-var">txid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>                             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264398"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>            </span><span class="hs-comment">-- And remove acknowledged txs from our buffer</span><span>
</span><span id="line-342"></span><span>            </span><span id="local-6989586621679264388"><span class="annot"><span class="annottext">bufferedTxs2 :: Map txid (Maybe tx)
</span><a href="#local-6989586621679264388"><span class="hs-identifier hs-var hs-var">bufferedTxs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map txid (Maybe tx) -&gt; txid -&gt; Map txid (Maybe tx))
-&gt; Map txid (Maybe tx) -&gt; StrictSeq txid -&gt; Map txid (Maybe tx)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(txid -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx))
-&gt; Map txid (Maybe tx) -&gt; txid -&gt; Map txid (Maybe tx)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">txid -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                                   </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264399"><span class="hs-identifier hs-var">bufferedTxs1</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264398"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span>            </span><span class="hs-comment">-- If we are acknowleding transactions that are still in unacknowledgedTxIds'</span><span>
</span><span id="line-346"></span><span>            </span><span class="hs-comment">-- we need to re-add them so that we also can acknowledge them again later.</span><span>
</span><span id="line-347"></span><span>            </span><span class="hs-comment">-- This will happen incase of duplicate txids within the same window.</span><span>
</span><span id="line-348"></span><span>            </span><span id="local-6989586621679264385"><span class="annot"><span class="annottext">live :: [txid]
</span><a href="#local-6989586621679264385"><span class="hs-identifier hs-var hs-var">live</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(txid -&gt; Bool) -&gt; [txid] -&gt; [txid]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">txid -&gt; StrictSeq txid -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264397"><span class="hs-identifier hs-var">unacknowledgedTxIds'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([txid] -&gt; [txid]) -&gt; [txid] -&gt; [txid]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid -&gt; [txid]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264398"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span><span>
</span><span id="line-349"></span><span>            </span><span id="local-6989586621679264383"><span class="annot"><span class="annottext">bufferedTxs3 :: Map txid (Maybe tx)
</span><a href="#local-6989586621679264383"><span class="hs-identifier hs-var hs-var">bufferedTxs3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; t a
</span><span class="hs-identifier hs-var">forceElemsToWHNF</span></span><span> </span><span class="annot"><span class="annottext">(Map txid (Maybe tx) -&gt; Map txid (Maybe tx))
-&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264388"><span class="hs-identifier hs-var">bufferedTxs2</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-350"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(txid, Maybe tx)] -&gt; Map txid (Maybe tx)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[txid] -&gt; [Maybe tx] -&gt; [(txid, Maybe tx)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[txid]
</span><a href="#local-6989586621679264385"><span class="hs-identifier hs-var">live</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe tx -&gt; [Maybe tx]
forall a. a -&gt; [a]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">repeat</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe tx
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679264381"><span class="annot"><span class="annottext">collected :: Int
</span><a href="#local-6989586621679264381"><span class="hs-identifier hs-var hs-var">collected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[tx] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264411"><span class="hs-identifier hs-var">txs</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceTxSubmissionInbound txid tx -&gt; m ())
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-354"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; TraceTxSubmissionInbound txid tx
forall txid tx. Int -&gt; TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionCollected"><span class="hs-identifier hs-var">TraceTxSubmissionCollected</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679264381"><span class="hs-identifier hs-var">collected</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>        </span><span id="local-6989586621679264379"><span class="annot"><span class="annottext">[txid]
</span><a href="#local-6989586621679264379"><span class="hs-identifier hs-var">txidsAccepted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[tx] -&gt; m [txid]
</span><a href="#local-6989586621679264453"><span class="hs-identifier hs-var">mempoolAddTxs</span></a></span><span> </span><span class="annot"><span class="annottext">[tx]
</span><a href="#local-6989586621679264394"><span class="hs-identifier hs-var">txsReady</span></a></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679264378"><span class="annot"><span class="annottext">accepted :: Int
</span><a href="#local-6989586621679264378"><span class="hs-identifier hs-var hs-var">accepted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[txid] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[txid]
</span><a href="#local-6989586621679264379"><span class="hs-identifier hs-var">txidsAccepted</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound txid tx)
</span><a href="#local-6989586621679264468"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceTxSubmissionInbound txid tx -&gt; m ())
-&gt; TraceTxSubmissionInbound txid tx -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessedTxCount -&gt; TraceTxSubmissionInbound txid tx
forall txid tx.
ProcessedTxCount -&gt; TraceTxSubmissionInbound txid tx
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#TraceTxSubmissionProcessed"><span class="hs-identifier hs-var">TraceTxSubmissionProcessed</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessedTxCount :: Int -&gt; Int -&gt; ProcessedTxCount
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ProcessedTxCount"><span class="hs-identifier hs-type">ProcessedTxCount</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><span class="annottext">ptxcAccepted :: Int
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ptxcAccepted"><span class="hs-identifier hs-var">ptxcAccepted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679264378"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-362"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptxcRejected :: Int
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#ptxcRejected"><span class="hs-identifier hs-var">ptxcRejected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679264381"><span class="hs-identifier hs-var">collected</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679264378"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-363"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">StatefulM (ServerState txid tx) n txid tx m
-&gt; ServerState txid tx -&gt; m (ServerStIdle n txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var">continueWithStateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
forall (n :: N).
Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264461"><span class="hs-identifier hs-var">serverIdle</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264430"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-366"></span><span>          </span><span class="annot"><span class="annottext">bufferedTxs :: Map txid (Maybe tx)
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#bufferedTxs"><span class="hs-identifier hs-var">bufferedTxs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264383"><span class="hs-identifier hs-var">bufferedTxs3</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-367"></span><span>          </span><span class="annot"><span class="annottext">unacknowledgedTxIds :: StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264397"><span class="hs-identifier hs-var">unacknowledgedTxIds'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-368"></span><span>          </span><span class="annot"><span class="annottext">numTxsToAcknowledge :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var">numTxsToAcknowledge</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var hs-var">numTxsToAcknowledge</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264428"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-369"></span><span>                              </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word16
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq txid -&gt; Int
forall a. StrictSeq a -&gt; Int
</span><span class="hs-identifier hs-var">Seq.length</span></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264398"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-comment">-- Pre-emptively acknowledge those of the available transaction IDs that</span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-comment">-- are already in the mempool and return the updated 'ServerState'.</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-comment">-- This enables us to effectively filter out transactions that we don't</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-comment">-- need to bother requesting from the client since they're already in the</span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-comment">-- mempool.</span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><a href="#local-6989586621679264414"><span class="hs-identifier hs-type">acknowledgeTxIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-380"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictSeq</span></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span>
</span><span id="line-381"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Type.html#TxSizeInBytes"><span class="hs-identifier hs-type">TxSizeInBytes</span></a></span><span>
</span><span id="line-382"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264470"><span class="hs-identifier hs-type">idx</span></a></span><span>
</span><span id="line-383"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621679264414"><span class="annot"><span class="annottext">acknowledgeTxIds :: ServerState txid tx
-&gt; StrictSeq txid
-&gt; Map txid TxSizeInBytes
-&gt; MempoolSnapshot txid tx idx
-&gt; ServerState txid tx
</span><a href="#local-6989586621679264414"><span class="hs-identifier hs-var hs-var">acknowledgeTxIds</span></a></span></span><span> </span><span id="local-6989586621679264376"><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264376"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679264375"><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264375"><span class="hs-identifier hs-var">txidsSeq</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot txid tx idx
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StrictSeq txid -&gt; Bool
forall a. StrictSeq a -&gt; Bool
</span><span class="hs-identifier hs-var">Seq.null</span></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264375"><span class="hs-identifier hs-var">txidsSeq</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264376"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><a href="#local-6989586621679264414"><span class="hs-identifier hs-var">acknowledgeTxIds</span></a></span><span> </span><span id="local-6989586621679264374"><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679264373"><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264373"><span class="hs-identifier hs-var">txidsSeq</span></a></span></span><span> </span><span id="local-6989586621679264372"><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264372"><span class="hs-identifier hs-var">txidsMap</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span class="hs-special">{</span><span id="local-6989586621679264370"><span class="annot"><span class="annottext">txid -&gt; Bool
mempoolHasTx :: forall txid tx idx. MempoolSnapshot txid tx idx -&gt; txid -&gt; Bool
mempoolHasTx :: txid -&gt; Bool
</span><a href="Ouroboros.Network.TxSubmission.Mempool.Reader.html#mempoolHasTx"><span class="hs-identifier hs-var hs-var">mempoolHasTx</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-comment">-- Return the next 'ServerState'</span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-388"></span><span>          </span><span class="annot"><span class="annottext">availableTxids :: Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var">availableTxids</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264368"><span class="hs-identifier hs-var">availableTxids'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-389"></span><span>          </span><span class="annot"><span class="annottext">bufferedTxs :: Map txid (Maybe tx)
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#bufferedTxs"><span class="hs-identifier hs-var">bufferedTxs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264367"><span class="hs-identifier hs-var">bufferedTxs''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>          </span><span class="annot"><span class="annottext">unacknowledgedTxIds :: StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264366"><span class="hs-identifier hs-var">unacknowledgedTxIds''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-391"></span><span>          </span><span class="annot"><span class="annottext">numTxsToAcknowledge :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var">numTxsToAcknowledge</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var hs-var">numTxsToAcknowledge</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-392"></span><span>                              </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word16
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq txid -&gt; Int
forall a. StrictSeq a -&gt; Int
</span><span class="hs-identifier hs-var">Seq.length</span></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264365"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-394"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-comment">-- Divide the new txids in two: those that are already in the</span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-comment">-- mempool or in flight and those that are not. We'll request some txs from the</span><span>
</span><span id="line-398"></span><span>        </span><span class="hs-comment">-- latter.</span><span>
</span><span id="line-399"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679264364"><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264364"><span class="hs-identifier hs-var">ignoredTxids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264363"><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264363"><span class="hs-identifier hs-var">availableTxidsMp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-400"></span><span>              </span><span class="annot"><span class="annottext">(txid -&gt; TxSizeInBytes -&gt; Bool)
-&gt; Map txid TxSizeInBytes
-&gt; (Map txid TxSizeInBytes, Map txid TxSizeInBytes)
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.partitionWithKey</span></a></span><span>
</span><span id="line-401"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679264361"><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264361"><span class="hs-identifier hs-var">txid</span></a></span></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">txid -&gt; Bool
</span><a href="#local-6989586621679264370"><span class="hs-identifier hs-var">mempoolHasTx</span></a></span><span> </span><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264361"><span class="hs-identifier hs-var">txid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>                </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264372"><span class="hs-identifier hs-var">txidsMap</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>        </span><span id="local-6989586621679264360"><span class="annot"><span class="annottext">availableTxidsU :: Map txid TxSizeInBytes
</span><a href="#local-6989586621679264360"><span class="hs-identifier hs-var hs-var">availableTxidsU</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-405"></span><span>              </span><span class="annot"><span class="annottext">(txid -&gt; TxSizeInBytes -&gt; Bool)
-&gt; Map txid TxSizeInBytes -&gt; Map txid TxSizeInBytes
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.filterWithKey</span></a></span><span>
</span><span id="line-406"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679264358"><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264358"><span class="hs-identifier hs-var">txid</span></a></span></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">txid -&gt; StrictSeq txid -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">notElem</span></a></span><span> </span><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264358"><span class="hs-identifier hs-var">txid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; StrictSeq txid
forall txid tx. ServerState txid tx -&gt; StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>                </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264372"><span class="hs-identifier hs-var">txidsMap</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>        </span><span id="local-6989586621679264368"><span class="annot"><span class="annottext">availableTxids' :: Map txid TxSizeInBytes
</span><a href="#local-6989586621679264368"><span class="hs-identifier hs-var hs-var">availableTxids'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid TxSizeInBytes
forall txid tx. ServerState txid tx -&gt; Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var hs-var">availableTxids</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
-&gt; Map txid TxSizeInBytes -&gt; Map txid TxSizeInBytes
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
-&gt; Map txid TxSizeInBytes -&gt; Map txid TxSizeInBytes
forall k a b. Ord k =&gt; Map k a -&gt; Map k b -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.intersection</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264363"><span class="hs-identifier hs-var">availableTxidsMp</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264360"><span class="hs-identifier hs-var">availableTxidsU</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>        </span><span class="hs-comment">-- The txs that we intentionally don't request, because they are</span><span>
</span><span id="line-412"></span><span>        </span><span class="hs-comment">-- already in the mempool, need to be acknowledged.</span><span>
</span><span id="line-413"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-414"></span><span>        </span><span class="hs-comment">-- So we extend bufferedTxs with those txs (so of course they have</span><span>
</span><span id="line-415"></span><span>        </span><span class="hs-comment">-- no corresponding reply).</span><span>
</span><span id="line-416"></span><span>        </span><span id="local-6989586621679264355"><span class="annot"><span class="annottext">bufferedTxs' :: Map txid (Maybe tx)
</span><a href="#local-6989586621679264355"><span class="hs-identifier hs-var hs-var">bufferedTxs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid (Maybe tx)
forall txid tx. ServerState txid tx -&gt; Map txid (Maybe tx)
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#bufferedTxs"><span class="hs-identifier hs-var hs-var">bufferedTxs</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-417"></span><span>                    </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(TxSizeInBytes -&gt; Maybe tx)
-&gt; Map txid TxSizeInBytes -&gt; Map txid (Maybe tx)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe tx -&gt; TxSizeInBytes -&gt; Maybe tx
forall a b. a -&gt; b -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe tx
forall a. Maybe a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264364"><span class="hs-identifier hs-var">ignoredTxids</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span>        </span><span id="local-6989586621679264354"><span class="annot"><span class="annottext">unacknowledgedTxIds' :: StrictSeq txid
</span><a href="#local-6989586621679264354"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; StrictSeq txid
forall txid tx. ServerState txid tx -&gt; StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264374"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid -&gt; StrictSeq txid -&gt; StrictSeq txid
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264373"><span class="hs-identifier hs-var">txidsSeq</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-comment">-- Check if having decided not to request more txs we can now</span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-comment">-- confirm any txids (in strict order in the unacknowledgedTxIds</span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-comment">-- sequence). This is used in the 'numTxsToAcknowledge' below</span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-comment">-- which will then be used next time we SendMsgRequestTxIds.</span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679264365"><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264365"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264366"><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264366"><span class="hs-identifier hs-var">unacknowledgedTxIds''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>          </span><span class="annot"><span class="annottext">(txid -&gt; Bool)
-&gt; StrictSeq txid -&gt; (StrictSeq txid, StrictSeq txid)
forall a. (a -&gt; Bool) -&gt; StrictSeq a -&gt; (StrictSeq a, StrictSeq a)
</span><span class="hs-identifier hs-var">Seq.spanl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">txid -&gt; Map txid (Maybe tx) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-operator hs-var">`Map.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264355"><span class="hs-identifier hs-var">bufferedTxs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264354"><span class="hs-identifier hs-var">unacknowledgedTxIds'</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-comment">-- If so we can remove acknowledged txs from our buffer provided that they</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-comment">-- are not still in unacknowledgedTxIds''. This happens in case of duplicate</span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-comment">-- txids.</span><span>
</span><span id="line-433"></span><span>        </span><span id="local-6989586621679264367"><span class="annot"><span class="annottext">bufferedTxs'' :: Map txid (Maybe tx)
</span><a href="#local-6989586621679264367"><span class="hs-identifier hs-var hs-var">bufferedTxs''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; t a
</span><span class="hs-identifier hs-var">forceElemsToWHNF</span></span><span> </span><span class="annot"><span class="annottext">(Map txid (Maybe tx) -&gt; Map txid (Maybe tx))
-&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Map txid (Maybe tx) -&gt; txid -&gt; Map txid (Maybe tx))
-&gt; Map txid (Maybe tx) -&gt; StrictSeq txid -&gt; Map txid (Maybe tx)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679264353"><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264353"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679264352"><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264352"><span class="hs-identifier hs-var">txid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">txid -&gt; StrictSeq txid -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">elem</span></a></span><span> </span><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264352"><span class="hs-identifier hs-var">txid</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264366"><span class="hs-identifier hs-var">unacknowledgedTxIds''</span></a></span><span>
</span><span id="line-434"></span><span>                                              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264353"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-435"></span><span>                                              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">txid -&gt; Map txid (Maybe tx) -&gt; Map txid (Maybe tx)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">txid
</span><a href="#local-6989586621679264352"><span class="hs-identifier hs-var">txid</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264353"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>                                </span><span class="annot"><span class="annottext">Map txid (Maybe tx)
</span><a href="#local-6989586621679264355"><span class="hs-identifier hs-var">bufferedTxs'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSeq txid
</span><a href="#local-6989586621679264365"><span class="hs-identifier hs-var">acknowledgedTxIds</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><a href="#local-6989586621679264447"><span class="hs-identifier hs-type">serverReqTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264714"><span class="annot"><a href="#local-6989586621679264714"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">N</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-439"></span><span>                    </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264714"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-440"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679264714"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621679264447"><span class="annot"><span class="annottext">serverReqTxs :: Nat n -&gt; Stateful (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264447"><span class="hs-identifier hs-var hs-var">serverReqTxs</span></a></span></span><span> </span><span id="local-6989586621679264351"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264351"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ServerState txid tx -&gt; ServerStIdle n txid tx m ())
-&gt; Stateful (ServerState txid tx) n txid tx m
forall s (n :: N) txid tx (m :: * -&gt; *).
(s -&gt; ServerStIdle n txid tx m ()) -&gt; Stateful s n txid tx m
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((ServerState txid tx -&gt; ServerStIdle n txid tx m ())
 -&gt; Stateful (ServerState txid tx) n txid tx m)
-&gt; (ServerState txid tx -&gt; ServerStIdle n txid tx m ())
-&gt; Stateful (ServerState txid tx) n txid tx m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679264349"><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264349"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-comment">-- TODO: This implementation is deliberately naive, we pick in an</span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">-- arbitrary order and up to a fixed limit. This is to illustrate</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-comment">-- that we can request txs out of order. In the final version we will</span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-comment">-- try to pick in-order and only pick out of order when we have to.</span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-comment">-- We will also uses the size of txs in bytes as our limit for</span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-comment">-- upper and lower watermarks for pipelining. We'll also use the</span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-comment">-- amount in flight and delta-Q to estimate when we're in danger of</span><span>
</span><span id="line-449"></span><span>        </span><span class="hs-comment">-- becomming idle, and need to request stalled txs.</span><span>
</span><span id="line-450"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-451"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264348"><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264348"><span class="hs-identifier hs-var">txsToRequest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679264347"><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264347"><span class="hs-identifier hs-var">availableTxids'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-452"></span><span>              </span><span class="annot"><span class="annottext">Int
-&gt; Map txid TxSizeInBytes
-&gt; (Map txid TxSizeInBytes, Map txid TxSizeInBytes)
forall k a. Int -&gt; Map k a -&gt; (Map k a, Map k a)
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.splitAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word16 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264458"><span class="hs-identifier hs-var">maxTxToRequest</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Map txid TxSizeInBytes
forall txid tx. ServerState txid tx -&gt; Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var hs-var">availableTxids</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264349"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="annottext">[txid]
-&gt; m (ServerStIdle ('S n) txid tx m ())
-&gt; ServerStIdle n txid tx m ()
forall txid (m :: * -&gt; *) (n :: N) tx a.
[txid]
-&gt; m (ServerStIdle ('S n) txid tx m a)
-&gt; ServerStIdle n txid tx m a
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#SendMsgRequestTxsPipelined"><span class="hs-identifier hs-var">SendMsgRequestTxsPipelined</span></a></span><span>
</span><span id="line-455"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map txid TxSizeInBytes -&gt; [txid]
forall k a. Map k a -&gt; [k]
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-var">Map.keys</span></a></span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264348"><span class="hs-identifier hs-var">txsToRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StatefulM (ServerState txid tx) ('S n) txid tx m
-&gt; ServerState txid tx -&gt; m (ServerStIdle ('S n) txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var">continueWithStateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat ('S n) -&gt; StatefulM (ServerState txid tx) ('S n) txid tx m
forall (n :: N).
Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264343"><span class="hs-identifier hs-var">serverReqTxIds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S n)
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Succ</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264351"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264349"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-457"></span><span>             </span><span class="annot"><span class="annottext">availableTxids :: Map txid TxSizeInBytes
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#availableTxids"><span class="hs-identifier hs-var">availableTxids</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map txid TxSizeInBytes
</span><a href="#local-6989586621679264347"><span class="hs-identifier hs-var">availableTxids'</span></a></span><span>
</span><span id="line-458"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><a href="#local-6989586621679264343"><span class="hs-identifier hs-type">serverReqTxIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679264342"><span class="annot"><a href="#local-6989586621679264342"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">N</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-461"></span><span>                      </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264342"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-462"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-type">StatefulM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#ServerState"><span class="hs-identifier hs-type">ServerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679264342"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264472"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264471"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264469"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621679264343"><span class="annot"><span class="annottext">serverReqTxIds :: Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264343"><span class="hs-identifier hs-var hs-var">serverReqTxIds</span></a></span></span><span> </span><span id="local-6989586621679264341"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264341"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ServerState txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulM (ServerState txid tx) n txid tx m
forall s (n :: N) txid tx (m :: * -&gt; *).
(s -&gt; m (ServerStIdle n txid tx m ())) -&gt; StatefulM s n txid tx m
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-var">StatefulM</span></a></span><span> </span><span class="annot"><span class="annottext">((ServerState txid tx -&gt; m (ServerStIdle n txid tx m ()))
 -&gt; StatefulM (ServerState txid tx) n txid tx m)
-&gt; (ServerState txid tx -&gt; m (ServerStIdle n txid tx m ()))
-&gt; StatefulM (ServerState txid tx) n txid tx m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679264340"><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>          </span><span class="hs-comment">-- This definition is justified by the fact that the</span><span>
</span><span id="line-465"></span><span>          </span><span class="hs-comment">-- 'numTxsToAcknowledge' are not included in the</span><span>
</span><span id="line-466"></span><span>          </span><span class="hs-comment">-- 'unacknowledgedTxIds'.</span><span>
</span><span id="line-467"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679264339"><span class="annot"><span class="annottext">numTxIdsToRequest :: Word16
</span><a href="#local-6989586621679264339"><span class="hs-identifier hs-var hs-var">numTxIdsToRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-468"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264467"><span class="hs-identifier hs-var">maxUnacked</span></a></span><span>
</span><span id="line-469"></span><span>                    </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word16
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictSeq txid -&gt; Int
forall a. StrictSeq a -&gt; Int
</span><span class="hs-identifier hs-var">Seq.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; StrictSeq txid
forall txid tx. ServerState txid tx -&gt; StrictSeq txid
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#unacknowledgedTxIds"><span class="hs-identifier hs-var hs-var">unacknowledgedTxIds</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>                    </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>            </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">`min`</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264459"><span class="hs-identifier hs-var">maxTxIdsToRequest</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264339"><span class="hs-identifier hs-var">numTxIdsToRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ServerStIdle n txid tx m () -&gt; m (ServerStIdle n txid tx m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIdle n txid tx m () -&gt; m (ServerStIdle n txid tx m ()))
-&gt; ServerStIdle n txid tx m () -&gt; m (ServerStIdle n txid tx m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
-&gt; Word16
-&gt; m (ServerStIdle ('S n) txid tx m ())
-&gt; ServerStIdle n txid tx m ()
forall (m :: * -&gt; *) (n :: N) txid tx a.
Word16
-&gt; Word16
-&gt; m (ServerStIdle ('S n) txid tx m a)
-&gt; ServerStIdle n txid tx m a
</span><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#SendMsgRequestTxIdsPipelined"><span class="hs-identifier hs-var">SendMsgRequestTxIdsPipelined</span></a></span><span>
</span><span id="line-475"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var hs-var">numTxsToAcknowledge</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>          </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264339"><span class="hs-identifier hs-var">numTxIdsToRequest</span></a></span><span>
</span><span id="line-477"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StatefulM (ServerState txid tx) ('S n) txid tx m
-&gt; ServerState txid tx -&gt; m (ServerStIdle ('S n) txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var">continueWithStateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat ('S n) -&gt; StatefulM (ServerState txid tx) ('S n) txid tx m
forall (n :: N).
Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264461"><span class="hs-identifier hs-var">serverIdle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S n)
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/typed-protocols-0.1.0.0/noopt/doc/html/typed-protocols/src"><span class="hs-identifier hs-var">Succ</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264341"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-478"></span><span>                </span><span class="annot"><span class="annottext">requestedTxIdsInFlight :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx -&gt; Word16
forall txid tx. ServerState txid tx -&gt; Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#requestedTxIdsInFlight"><span class="hs-identifier hs-var hs-var">requestedTxIdsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-479"></span><span>                                       </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Word16
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679264339"><span class="hs-identifier hs-var">numTxIdsToRequest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-480"></span><span>                </span><span class="annot"><span class="annottext">numTxsToAcknowledge :: Word16
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#numTxsToAcknowledge"><span class="hs-identifier hs-var">numTxsToAcknowledge</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span>
</span><span id="line-481"></span><span>              </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">StatefulM (ServerState txid tx) n txid tx m
-&gt; ServerState txid tx -&gt; m (ServerStIdle n txid tx m ())
forall s (n :: N) txid tx (m :: * -&gt; *).
NoThunks s =&gt;
StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var">continueWithStateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
forall (n :: N).
Nat n -&gt; StatefulM (ServerState txid tx) n txid tx m
</span><a href="#local-6989586621679264461"><span class="hs-identifier hs-var">serverIdle</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679264341"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerState txid tx
</span><a href="#local-6989586621679264340"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span class="hs-keyword">newtype</span><span> </span><span id="Stateful"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span></span><span> </span><span id="local-6989586621679264601"><span class="annot"><a href="#local-6989586621679264601"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679264600"><span class="annot"><a href="#local-6989586621679264600"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679264599"><span class="annot"><a href="#local-6989586621679264599"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264598"><span class="annot"><a href="#local-6989586621679264598"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621679264597"><span class="annot"><a href="#local-6989586621679264597"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Stateful"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679264601"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264600"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264599"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264598"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264597"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span class="hs-keyword">newtype</span><span> </span><span id="StatefulM"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-var">StatefulM</span></a></span></span><span> </span><span id="local-6989586621679264733"><span class="annot"><a href="#local-6989586621679264733"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679264731"><span class="annot"><a href="#local-6989586621679264731"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679264730"><span class="annot"><a href="#local-6989586621679264730"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264729"><span class="annot"><a href="#local-6989586621679264729"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621679264732"><span class="annot"><a href="#local-6989586621679264732"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="StatefulM"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-var">StatefulM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679264733"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264732"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264731"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264730"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264729"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264732"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-keyword">newtype</span><span> </span><span id="StatefulCollect"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulCollect"><span class="hs-identifier hs-var">StatefulCollect</span></a></span></span><span> </span><span id="local-6989586621679264677"><span class="annot"><a href="#local-6989586621679264677"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679264673"><span class="annot"><a href="#local-6989586621679264673"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679264676"><span class="annot"><a href="#local-6989586621679264676"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679264675"><span class="annot"><a href="#local-6989586621679264675"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621679264674"><span class="annot"><a href="#local-6989586621679264674"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="StatefulCollect"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulCollect"><span class="hs-identifier hs-var">StatefulCollect</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679264677"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#Collect"><span class="hs-identifier hs-type">Collect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264676"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264675"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264674"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264673"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264676"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264675"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264674"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span class="hs-comment">-- | After checking that there are no unexpected thunks in the provided state,</span><span>
</span><span id="line-493"></span><span class="hs-comment">-- pass it to the provided function.</span><span>
</span><span id="line-494"></span><span class="hs-comment">--</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- See 'checkInvariant' and 'unsafeNoThunks'.</span><span>
</span><span id="line-496"></span><span id="local-6989586621679264715"><span id="local-6989586621679264716"><span id="local-6989586621679264717"><span id="local-6989586621679264718"><span id="local-6989586621679264719"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithState"><span class="hs-identifier hs-type">continueWithState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264719"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-497"></span><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264719"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264718"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264717"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264716"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264715"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-498"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264719"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-499"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264718"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264717"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264716"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264715"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-500"></span><span id="continueWithState"><span class="annot"><span class="annottext">continueWithState :: Stateful s n txid tx m -&gt; s -&gt; ServerStIdle n txid tx m ()
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithState"><span class="hs-identifier hs-var hs-var">continueWithState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span id="local-6989586621679264336"><span class="annot"><span class="annottext">s -&gt; ServerStIdle n txid tx m ()
</span><a href="#local-6989586621679264336"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679264335"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264335"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-501"></span><span>    </span><span class="annot"><span class="annottext">Maybe String
-&gt; ServerStIdle n txid tx m () -&gt; ServerStIdle n txid tx m ()
forall a. (?callStack::CallStack) =&gt; Maybe String -&gt; a -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">checkInvariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThunkInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(ThunkInfo -&gt; String) -&gt; Maybe ThunkInfo -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe ThunkInfo
forall a. NoThunks a =&gt; a -&gt; Maybe ThunkInfo
</span><span class="hs-identifier hs-var">unsafeNoThunks</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264335"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; ServerStIdle n txid tx m ()
</span><a href="#local-6989586621679264336"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264335"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span class="hs-comment">-- | A variant of 'continueWithState' to be more easily utilized with</span><span>
</span><span id="line-504"></span><span class="hs-comment">-- 'serverIdle' and 'serverReqTxIds'.</span><span>
</span><span id="line-505"></span><span id="local-6989586621679264750"><span id="local-6989586621679264751"><span id="local-6989586621679264752"><span id="local-6989586621679264753"><span id="local-6989586621679264754"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-type">continueWithStateM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264754"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-506"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-type">StatefulM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264754"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264753"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264752"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264751"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264750"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-507"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264754"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-508"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264750"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264753"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264752"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264751"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264750"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-509"></span><span id="continueWithStateM"><span class="annot"><span class="annottext">continueWithStateM :: StatefulM s n txid tx m -&gt; s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#continueWithStateM"><span class="hs-identifier hs-var hs-var">continueWithStateM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulM"><span class="hs-identifier hs-type">StatefulM</span></a></span><span> </span><span id="local-6989586621679264332"><span class="annot"><span class="annottext">s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="#local-6989586621679264332"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679264331"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264331"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-510"></span><span>    </span><span class="annot"><span class="annottext">Maybe String
-&gt; m (ServerStIdle n txid tx m ())
-&gt; m (ServerStIdle n txid tx m ())
forall a. (?callStack::CallStack) =&gt; Maybe String -&gt; a -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">checkInvariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThunkInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(ThunkInfo -&gt; String) -&gt; Maybe ThunkInfo -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe ThunkInfo
forall a. NoThunks a =&gt; a -&gt; Maybe ThunkInfo
</span><span class="hs-identifier hs-var">unsafeNoThunks</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264331"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; m (ServerStIdle n txid tx m ())
</span><a href="#local-6989586621679264332"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264331"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span class="hs-comment">-- | A variant of 'continueWithState' to be more easily utilized with</span><span>
</span><span id="line-513"></span><span class="hs-comment">-- 'handleReply'.</span><span>
</span><span id="line-514"></span><span id="local-6989586621679264697"><span id="local-6989586621679264698"><span id="local-6989586621679264699"><span id="local-6989586621679264700"><span id="local-6989586621679264701"><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#collectAndContinueWithState"><span class="hs-identifier hs-type">collectAndContinueWithState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679264701"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-515"></span><span>                            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulCollect"><span class="hs-identifier hs-type">StatefulCollect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264701"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264700"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264699"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264698"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264697"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-516"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264701"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-517"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#Collect"><span class="hs-identifier hs-type">Collect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264699"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264698"><span class="hs-identifier hs-type">tx</span></a></span><span>
</span><span id="line-518"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679264697"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Protocol.TxSubmission.Server.html#ServerStIdle"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264700"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264699"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264698"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679264697"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-519"></span><span id="collectAndContinueWithState"><span class="annot"><span class="annottext">collectAndContinueWithState :: StatefulCollect s n txid tx m
-&gt; s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ())
</span><a href="Ouroboros.Network.TxSubmission.Inbound.html#collectAndContinueWithState"><span class="hs-identifier hs-var hs-var">collectAndContinueWithState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.TxSubmission.Inbound.html#StatefulCollect"><span class="hs-identifier hs-type">StatefulCollect</span></a></span><span> </span><span id="local-6989586621679264330"><span class="annot"><span class="annottext">s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ())
</span><a href="#local-6989586621679264330"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679264329"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264329"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679264328"><span class="annot"><span class="annottext">Collect txid tx
</span><a href="#local-6989586621679264328"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">Maybe String
-&gt; m (ServerStIdle n txid tx m ())
-&gt; m (ServerStIdle n txid tx m ())
forall a. (?callStack::CallStack) =&gt; Maybe String -&gt; a -&gt; a
</span><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/strict-stm-0.1.0.0/noopt/doc/html/strict-stm/src"><span class="hs-identifier hs-var">checkInvariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThunkInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(ThunkInfo -&gt; String) -&gt; Maybe ThunkInfo -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe ThunkInfo
forall a. NoThunks a =&gt; a -&gt; Maybe ThunkInfo
</span><span class="hs-identifier hs-var">unsafeNoThunks</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264329"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Collect txid tx -&gt; m (ServerStIdle n txid tx m ())
</span><a href="#local-6989586621679264330"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679264329"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Collect txid tx
</span><a href="#local-6989586621679264328"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span></pre></body></html>