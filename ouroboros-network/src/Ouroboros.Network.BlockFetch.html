<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveFunctor       #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">{-| Let's start with the big picture...

@
Key:  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;   &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
      &#9475; STM-based  &#9475;  &#9553;active thread&#9553;  &#9475;state instance&#9475;&#9491;  &#9553; one thread &#9553;&#9559;
      &#9475;shared state&#9475;  &#9553;             &#9553;  &#9475;   per peer   &#9475;&#9475;  &#9553;  per peer  &#9553;&#9553;
      &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9475;  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
                                        &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;   &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
@

@
  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;     &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;
  &#9553; Chain sync  &#9553;&#9559;    &#9475;   Ledger    &#9475;
  &#9553;  protocol   &#9553;&#9553;&#9664;&#9472;&#9472;&#9472;&#9512;   state     &#9475;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9582;
  &#9553;(client side)&#9553;&#9553;    &#9475;             &#9475;            &#9474;
  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;    &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;            &#9474;
   &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9578;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;                               &#9474;
         &#9660;                                       &#9474;
  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
  &#9475;  Candidate  &#9475;     &#9475;   Set of    &#9475;     &#9553;  Chain and  &#9553;
  &#9475;  chains     &#9475;     &#9475;  downloaded &#9504;&#9472;&#9472;&#9472;&#9472;&#9654;&#9553;   ledger    &#9553;
  &#9475;  (headers)  &#9475;     &#9475;   blocks    &#9475;     &#9553;  validation &#9553;
  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9519;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;     &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9519;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;     &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
        &#9474;                   &#9474; &#9650;                  &#9474;
        &#9474; &#9581;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9583; &#9474;                  &#9474;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9660;&#9617;&#9660;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;           &#9474;                  &#9660;
&#9617;&#9617;&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;&#9617;&#9617;           &#9474;           &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9617;&#9617;&#9553;    Block    &#9553;&#9617;&#9617;           &#9474;           &#9475;   Current   &#9475;     &#9553; Block fetch &#9553;&#9559;
&#9617;&#9617;&#9570;    fetch    &#9553;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9512;    chain    &#9504;&#9472;&#9472;&#9472;&#9472;&#9654;&#9553; protocol    &#9553;&#9553;
&#9617;&#9617;&#9553;    logic    &#9553;&#9617;&#9617;           &#9474;           &#9475;  (blocks)   &#9475;     &#9553;(server side)&#9553;&#9553;
&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9617;&#9617;           &#9474;           &#9504;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9512;     &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9650;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;           &#9474;           &#9475;  Tentative  &#9475;      &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9660;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9474;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;   &#9475;    chain    &#9504;&#9472;&#9472;&#9582;
&#9617;&#9617;&#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;&#9617;&#9617;&#9617;&#9617;&#9617;&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;&#9617;&#9617;   &#9475;  (headers)  &#9475;  &#9474;  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9617;&#9617;&#9475; Block fetch &#9475;&#9491;&#9617;&#9617;&#9617;&#9617;&#9553; block fetch &#9553;&#9559;&#9617;   &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;  &#9474;  &#9553; Chain sync  &#9553;&#9559;
&#9617;&#9617;&#9475;  state and  &#9475;&#9475;&#9664;&#9472;&#9472;&#9654;&#9553;  protocol   &#9553;&#9553;&#9617;                    &#9584;&#9472;&#9654;&#9553; protocol    &#9553;&#9553;
&#9617;&#9617;&#9475;  requests   &#9475;&#9475;&#9617;&#9617;&#9617;&#9617;&#9553;(client side)&#9553;&#9553;&#9617;                       &#9553;(server side)&#9553;&#9553;
&#9617;&#9617;&#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9475;&#9617;&#9617;&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;&#9617;                       &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
&#9617;&#9617;&#9617;&#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9617;&#9617;&#9617;&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9617;                        &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;
@
Notes:

 * Thread communication is via STM based state.
 * Outbound: threads update STM state.
 * Inbound: threads wait on STM state changing (using retry).
 * These are no queues: there is only the current state, not all change events.

We consider the block fetch logic and the policy for the block fetch protocol
client together as one unit of functionality. This is the shaded area in the
diagram.

Looking at the diagram we see that these two threads interact with each other
and other threads via the following shared state

+-----------------------------+----------------+--------------------+
|  State                      |  Interactions  | Internal\/External |
+=============================+================+====================+
|  Candidate chains (headers) |  Read          |  External          |
+-----------------------------+----------------+--------------------+
|  Current chain (blocks)     |  Read          |  External          |
+-----------------------------+----------------+--------------------+
|  Set of downloaded blocks   |  Read &amp; Write  |  External          |
+-----------------------------+----------------+--------------------+
|  Block fetch requests       |  Read &amp; Write  |  Internal          |
+-----------------------------+----------------+--------------------+

The block fetch requests state is private between the block fetch logic
and the block fetch protocol client, so it is implemented here.

The other state is managed by the consensus layer and is considered external
here. So here we define interfaces for interacting with the external state.
These have to be provided when instantiating the block fetch logic.

-}</span><span>
</span><span id="line-83"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.BlockFetch</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier">blockFetchLogic</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier">BlockFetchConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier">BlockFetchConsensusInterface</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Tracer types</span></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier">FetchDecision</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier">TraceFetchClientState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier">TraceLabelPeer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><span class="hs-comment">-- * The 'FetchClientRegistry'</span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier">FetchClientRegistry</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#newFetchClientRegistry"><span class="hs-identifier">newFetchClientRegistry</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketFetchClient"><span class="hs-identifier">bracketFetchClient</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketSyncWithFetchClient"><span class="hs-identifier">bracketSyncWithFetchClient</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketKeepAliveClient"><span class="hs-identifier">bracketKeepAliveClient</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-export types used by 'BlockFetchConsensusInterface'</span></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier">FetchMode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FromConsensus"><span class="hs-identifier">FromConsensus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier">SizeInBytes</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">Data.Void</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></a></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a></span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier">AnchoredFragment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Block.html"><span class="hs-identifier">Ouroboros.Network.Block</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html"><span class="hs-identifier">Ouroboros.Network.DeltaQ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier">SizeInBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientRegistry</span></a></span><span>
</span><span id="line-118"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier">FetchClientPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier">FetchClientRegistry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketFetchClient"><span class="hs-identifier">bracketFetchClient</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketKeepAliveClient"><span class="hs-identifier">bracketKeepAliveClient</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketSyncWithFetchClient"><span class="hs-identifier">bracketSyncWithFetchClient</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#newFetchClientRegistry"><span class="hs-identifier">newFetchClientRegistry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStateVars"><span class="hs-identifier">readFetchClientsStateVars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStatus"><span class="hs-identifier">readFetchClientsStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readPeerGSVs"><span class="hs-identifier">readPeerGSVs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#setFetchClientContext"><span class="hs-identifier">setFetchClientContext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FromConsensus"><span class="hs-identifier">FromConsensus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.State</span></a></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | The consensus layer functionality that the block fetch logic requires.</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- These are provided as input to the block fetch by the consensus layer.</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-keyword">data</span><span> </span><span id="BlockFetchConsensusInterface"><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-var">BlockFetchConsensusInterface</span></a></span></span><span> </span><span id="local-6989586621679254991"><span class="annot"><a href="#local-6989586621679254991"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679254990"><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679254989"><span class="annot"><a href="#local-6989586621679254989"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679254988"><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-132"></span><span>     </span><span id="BlockFetchConsensusInterface"><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-var">BlockFetchConsensusInterface</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>       </span><span class="hs-comment">-- | Read the K-suffixes of the candidate chains.</span><span>
</span><span id="line-135"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span>       </span><span class="hs-comment">-- Assumptions:</span><span>
</span><span id="line-137"></span><span>       </span><span class="hs-comment">-- * They must be already validated.</span><span>
</span><span id="line-138"></span><span>       </span><span class="hs-comment">-- * They may contain /fewer/ than @K@ blocks.</span><span>
</span><span id="line-139"></span><span>       </span><span class="hs-comment">-- * Their anchor does not have to intersect with the current chain.</span><span>
</span><span id="line-140"></span><span>       </span><span id="readCandidateChains"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; STM m (Map peer (AnchoredFragment header))
</span><a href="Ouroboros.Network.BlockFetch.html#readCandidateChains"><span class="hs-identifier hs-var hs-var">readCandidateChains</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/containers-0.6.2.1/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254991"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>       </span><span class="hs-comment">-- | Read the K-suffix of the current chain.</span><span>
</span><span id="line-143"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span>       </span><span class="hs-comment">-- This must contain info on the last @K@ blocks (unless we're near</span><span>
</span><span id="line-145"></span><span>       </span><span class="hs-comment">-- the chain genesis of course).</span><span>
</span><span id="line-146"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-147"></span><span>       </span><span id="readCurrentChain"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; STM m (AnchoredFragment header)
</span><a href="Ouroboros.Network.BlockFetch.html#readCurrentChain"><span class="hs-identifier hs-var hs-var">readCurrentChain</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>       </span><span class="hs-comment">-- | Read the current fetch mode that the block fetch logic should use.</span><span>
</span><span id="line-150"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-151"></span><span>       </span><span class="hs-comment">-- The fetch mode is a dynamic part of the block fetch policy. In</span><span>
</span><span id="line-152"></span><span>       </span><span class="hs-comment">-- 'FetchModeBulkSync' it follows a policy that optimises for expected</span><span>
</span><span id="line-153"></span><span>       </span><span class="hs-comment">-- bandwidth over latency to fetch any particular block, whereas in</span><span>
</span><span id="line-154"></span><span>       </span><span class="hs-comment">-- 'FetchModeDeadline' it follows a policy optimises for the latency</span><span>
</span><span id="line-155"></span><span>       </span><span class="hs-comment">-- to fetch blocks, at the expense of wasting bandwidth.</span><span>
</span><span id="line-156"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-157"></span><span>       </span><span class="hs-comment">-- This mode should be set so that when the node's current chain is near</span><span>
</span><span id="line-158"></span><span>       </span><span class="hs-comment">-- to \&quot;now\&quot; it uses the deadline mode, and when it is far away it uses</span><span>
</span><span id="line-159"></span><span>       </span><span class="hs-comment">-- the bulk sync mode.</span><span>
</span><span id="line-160"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span>       </span><span id="readFetchMode"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m -&gt; STM m FetchMode
</span><a href="Ouroboros.Network.BlockFetch.html#readFetchMode"><span class="hs-identifier hs-var hs-var">readFetchMode</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchMode"><span class="hs-identifier hs-type">FetchMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span>       </span><span class="hs-comment">-- | Recent, only within last K</span><span>
</span><span id="line-164"></span><span>       </span><span id="readFetchedBlocks"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; STM m (Point block -&gt; Bool)
</span><a href="Ouroboros.Network.BlockFetch.html#readFetchedBlocks"><span class="hs-identifier hs-var hs-var">readFetchedBlocks</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254989"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>       </span><span class="hs-comment">-- | This and 'readFetchedBlocks' are required to be linked. Upon</span><span>
</span><span id="line-167"></span><span>       </span><span class="hs-comment">-- successful completion of 'addFetchedBlock' it must be the case that</span><span>
</span><span id="line-168"></span><span>       </span><span class="hs-comment">-- 'readFetchedBlocks' reports the block.</span><span>
</span><span id="line-169"></span><span>       </span><span id="addFetchedBlock"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; Point block -&gt; block -&gt; m ()
</span><a href="Ouroboros.Network.BlockFetch.html#addFetchedBlock"><span class="hs-identifier hs-var hs-var">addFetchedBlock</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254989"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679254989"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>       </span><span class="hs-comment">-- | The highest stored/downloaded slot number.</span><span>
</span><span id="line-172"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span>       </span><span class="hs-comment">-- This is used to optimise the filtering of fragments in the block</span><span>
</span><span id="line-174"></span><span>       </span><span class="hs-comment">-- fetch logic: when removing already downloaded blocks from a</span><span>
</span><span id="line-175"></span><span>       </span><span class="hs-comment">-- fragment, the filtering (with a linear cost) is stopped as soon as a</span><span>
</span><span id="line-176"></span><span>       </span><span class="hs-comment">-- block has a slot number higher than this slot number, as it cannot</span><span>
</span><span id="line-177"></span><span>       </span><span class="hs-comment">-- have been downloaded anyway.</span><span>
</span><span id="line-178"></span><span>       </span><span id="readFetchedMaxSlotNo"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.html#readFetchedMaxSlotNo"><span class="hs-identifier hs-var hs-var">readFetchedMaxSlotNo</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Block.html#MaxSlotNo"><span class="hs-identifier hs-type">MaxSlotNo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>       </span><span class="hs-comment">-- | Given the current chain, is the given chain plausible as a</span><span>
</span><span id="line-181"></span><span>       </span><span class="hs-comment">-- candidate chain. Classically for Ouroboros this would simply</span><span>
</span><span id="line-182"></span><span>       </span><span class="hs-comment">-- check if the candidate is strictly longer, but for Ouroboros</span><span>
</span><span id="line-183"></span><span>       </span><span class="hs-comment">-- with operational key certificates there are also cases where</span><span>
</span><span id="line-184"></span><span>       </span><span class="hs-comment">-- we would consider a chain of equal length to the current chain.</span><span>
</span><span id="line-185"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-186"></span><span>       </span><span id="plausibleCandidateChain"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="Ouroboros.Network.BlockFetch.html#plausibleCandidateChain"><span class="hs-identifier hs-var hs-var">plausibleCandidateChain</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-187"></span><span>                               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-188"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>       </span><span class="hs-comment">-- | Compare two candidate chains and return a preference ordering.</span><span>
</span><span id="line-191"></span><span>       </span><span class="hs-comment">-- This is used as part of selecting which chains to prioritise for</span><span>
</span><span id="line-192"></span><span>       </span><span class="hs-comment">-- downloading block bodies.</span><span>
</span><span id="line-193"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span>       </span><span id="compareCandidateChains"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="Ouroboros.Network.BlockFetch.html#compareCandidateChains"><span class="hs-identifier hs-var hs-var">compareCandidateChains</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-195"></span><span>                               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-196"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.AnchoredFragment.html#AnchoredFragment"><span class="hs-identifier hs-type">AnchoredFragment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-197"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ordering</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>       </span><span class="hs-comment">-- | Much of the logic for deciding which blocks to download from which</span><span>
</span><span id="line-200"></span><span>       </span><span class="hs-comment">-- peer depends on making estimates based on recent performance metrics.</span><span>
</span><span id="line-201"></span><span>       </span><span class="hs-comment">-- These estimates of course depend on the amount of data we will be</span><span>
</span><span id="line-202"></span><span>       </span><span class="hs-comment">-- downloading.</span><span>
</span><span id="line-203"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span>       </span><span id="blockFetchSize"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; header -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.html#blockFetchSize"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#SizeInBytes"><span class="hs-identifier hs-type">SizeInBytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>       </span><span class="hs-comment">-- | Given a block header, validate the supposed corresponding block</span><span>
</span><span id="line-207"></span><span>       </span><span class="hs-comment">-- body.</span><span>
</span><span id="line-208"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-209"></span><span>       </span><span id="blockMatchesHeader"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; header -&gt; block -&gt; Bool
</span><a href="Ouroboros.Network.BlockFetch.html#blockMatchesHeader"><span class="hs-identifier hs-var hs-var">blockMatchesHeader</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679254989"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>       </span><span class="hs-comment">-- | Calculate when a header's block was forged.</span><span>
</span><span id="line-212"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-213"></span><span>       </span><span class="hs-comment">-- PRECONDITION: This function will succeed and give a _correct_ result</span><span>
</span><span id="line-214"></span><span>       </span><span class="hs-comment">-- when applied to headers obtained via this interface (ie via</span><span>
</span><span id="line-215"></span><span>       </span><span class="hs-comment">-- Consensus, ie via 'readCurrentChain' or 'readCandidateChains').</span><span>
</span><span id="line-216"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-217"></span><span>       </span><span class="hs-comment">-- WARNING: This function may fail or, worse, __give an incorrect result</span><span>
</span><span id="line-218"></span><span>       </span><span class="hs-comment">-- (!!)__ if applied to headers obtained from sources outside of this</span><span>
</span><span id="line-219"></span><span>       </span><span class="hs-comment">-- interface. The 'FromConsensus' newtype wrapper is intended to make it</span><span>
</span><span id="line-220"></span><span>       </span><span class="hs-comment">-- difficult to make that mistake, so please pay that syntactic price</span><span>
</span><span id="line-221"></span><span>       </span><span class="hs-comment">-- and consider its meaning at each call to this function. Relatedly,</span><span>
</span><span id="line-222"></span><span>       </span><span class="hs-comment">-- preserve that argument wrapper as much as possible when deriving</span><span>
</span><span id="line-223"></span><span>       </span><span class="hs-comment">-- ancillary functions\/interfaces from this function.</span><span>
</span><span id="line-224"></span><span>       </span><span id="headerForgeUTCTime"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; FromConsensus header -&gt; STM m UTCTime
</span><a href="Ouroboros.Network.BlockFetch.html#headerForgeUTCTime"><span class="hs-identifier hs-var hs-var">headerForgeUTCTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FromConsensus"><span class="hs-identifier hs-type">FromConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254990"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">UTCTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>       </span><span class="hs-comment">-- | Calculate when a block was forged.</span><span>
</span><span id="line-227"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span>       </span><span class="hs-comment">-- PRECONDITION: Same as 'headerForgeUTCTime'.</span><span>
</span><span id="line-229"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span>       </span><span class="hs-comment">-- WARNING: Same as 'headerForgeUTCTime'.</span><span>
</span><span id="line-231"></span><span>       </span><span id="blockForgeUTCTime"><span class="annot"><span class="annottext">BlockFetchConsensusInterface peer header block m
-&gt; FromConsensus block -&gt; STM m UTCTime
</span><a href="Ouroboros.Network.BlockFetch.html#blockForgeUTCTime"><span class="hs-identifier hs-var hs-var">blockForgeUTCTime</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FromConsensus"><span class="hs-identifier hs-type">FromConsensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254989"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">UTCTime</span></a></span><span>
</span><span id="line-232"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | Configuration for FetchDecisionPolicy.</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- Should be determined by external local node config.</span><span>
</span><span id="line-236"></span><span class="hs-keyword">data</span><span> </span><span id="BlockFetchConfiguration"><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-var">BlockFetchConfiguration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>     </span><span id="BlockFetchConfiguration"><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-var">BlockFetchConfiguration</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-238"></span><span>         </span><span class="hs-comment">-- | Maximum concurrent downloads during bulk syncing.</span><span>
</span><span id="line-239"></span><span>         </span><span id="bfcMaxConcurrencyBulkSync"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyBulkSync"><span class="hs-identifier hs-var hs-var">bfcMaxConcurrencyBulkSync</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>         </span><span class="hs-comment">-- | Maximum concurrent downloads during deadline syncing.</span><span>
</span><span id="line-242"></span><span>         </span><span id="bfcMaxConcurrencyDeadline"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyDeadline"><span class="hs-identifier hs-var hs-var">bfcMaxConcurrencyDeadline</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>         </span><span class="hs-comment">-- | Maximum requests in flight per each peer.</span><span>
</span><span id="line-245"></span><span>         </span><span id="bfcMaxRequestsInflight"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxRequestsInflight"><span class="hs-identifier hs-var hs-var">bfcMaxRequestsInflight</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span>         </span><span class="hs-comment">-- | Desired intervall between calls to fetchLogicIteration</span><span>
</span><span id="line-248"></span><span>         </span><span id="bfcDecisionLoopInterval"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; DiffTime
</span><a href="Ouroboros.Network.BlockFetch.html#bfcDecisionLoopInterval"><span class="hs-identifier hs-var hs-var">bfcDecisionLoopInterval</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/time-1.9.3/src"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>         </span><span class="hs-comment">-- | Salt used when comparing peers</span><span>
</span><span id="line-251"></span><span>         </span><span id="bfcSalt"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Int
</span><a href="Ouroboros.Network.BlockFetch.html#bfcSalt"><span class="hs-identifier hs-var hs-var">bfcSalt</span></a></span></span><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-252"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- | Execute the block fetch logic. It monitors the current chain and candidate</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- chains. It decided which block bodies to fetch and manages the process of</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- fetching them, including making alternative decisions based on timeouts and</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- failures.</span><span>
</span><span id="line-258"></span><span class="hs-comment">--</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- This runs forever and should be shut down using mechanisms such as async.</span><span>
</span><span id="line-260"></span><span class="hs-comment">--</span><span>
</span><span id="line-261"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier hs-type">blockFetchLogic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679254915"><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679254914"><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679254913"><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679254912"><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-262"></span><span>                   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-263"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Block.html#HasHeader"><span class="hs-identifier hs-type">HasHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-264"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.Block.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-265"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadDelay</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-266"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadMonotonicTime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-267"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/io-classes-0.2.0.0/noopt/doc/html/io-classes/src"><span class="hs-identifier hs-type">MonadSTM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-268"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-269"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-270"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Network.Block.html#Point"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-272"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/work/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.10.4/network-mux-0.1.0.0/noopt/doc/html/network-mux/src"><span class="hs-identifier hs-type">TraceLabelPeer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-274"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier hs-type">FetchClientRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-275"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a></span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///home/runner/.ghcup/ghc/8.10.4/share/doc/ghc-8.10.4/html/libraries/base-4.14.1.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-277"></span><span id="blockFetchLogic"><span class="annot"><span class="annottext">blockFetchLogic :: Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; BlockFetchConsensusInterface peer header block m
-&gt; FetchClientRegistry peer header block m
-&gt; BlockFetchConfiguration
-&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier hs-var hs-var">blockFetchLogic</span></a></span></span><span> </span><span id="local-6989586621679254911"><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
</span><a href="#local-6989586621679254911"><span class="hs-identifier hs-var">decisionTracer</span></a></span></span><span> </span><span id="local-6989586621679254910"><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679254910"><span class="hs-identifier hs-var">clientStateTracer</span></a></span></span><span>
</span><span id="line-278"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConsensusInterface"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></a></span><span class="hs-special">{</span><span id="local-6989586621679254898"><span id="local-6989586621679254899"><span id="local-6989586621679254900"><span id="local-6989586621679254901"><span id="local-6989586621679254902"><span id="local-6989586621679254903"><span id="local-6989586621679254904"><span id="local-6989586621679254905"><span id="local-6989586621679254906"><span id="local-6989586621679254907"><span id="local-6989586621679254908"><span id="local-6989586621679254909"><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment header))
STM m (AnchoredFragment header)
STM m MaxSlotNo
STM m FetchMode
STM m (Point block -&gt; Bool)
header -&gt; SizeInBytes
header -&gt; block -&gt; Bool
HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
Point block -&gt; block -&gt; m ()
FromConsensus header -&gt; STM m UTCTime
FromConsensus block -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus block -&gt; STM m UTCTime
headerForgeUTCTime :: FromConsensus header -&gt; STM m UTCTime
blockMatchesHeader :: header -&gt; block -&gt; Bool
blockFetchSize :: header -&gt; SizeInBytes
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
readFetchedMaxSlotNo :: STM m MaxSlotNo
addFetchedBlock :: Point block -&gt; block -&gt; m ()
readFetchedBlocks :: STM m (Point block -&gt; Bool)
readFetchMode :: STM m FetchMode
readCurrentChain :: STM m (AnchoredFragment header)
readCandidateChains :: STM m (Map peer (AnchoredFragment header))
blockForgeUTCTime :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; FromConsensus block -&gt; STM m UTCTime
headerForgeUTCTime :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; FromConsensus header -&gt; STM m UTCTime
blockMatchesHeader :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; header -&gt; block -&gt; Bool
blockFetchSize :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; header -&gt; SizeInBytes
compareCandidateChains :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
plausibleCandidateChain :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
readFetchedMaxSlotNo :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m -&gt; STM m MaxSlotNo
addFetchedBlock :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; Point block -&gt; block -&gt; m ()
readFetchedBlocks :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; STM m (Point block -&gt; Bool)
readFetchMode :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m -&gt; STM m FetchMode
readCurrentChain :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; STM m (AnchoredFragment header)
readCandidateChains :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; STM m (Map peer (AnchoredFragment header))
</span><a href="#local-6989586621679254898"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>                </span><span id="local-6989586621679254897"><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
</span><a href="#local-6989586621679254897"><span class="hs-identifier hs-var">registry</span></a></span></span><span>
</span><span id="line-280"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a></span><span class="hs-special">{</span><span id="local-6989586621679254892"><span id="local-6989586621679254893"><span id="local-6989586621679254894"><span id="local-6989586621679254895"><span id="local-6989586621679254896"><span class="annot"><span class="annottext">Int
Word
DiffTime
bfcSalt :: Int
bfcDecisionLoopInterval :: DiffTime
bfcMaxRequestsInflight :: Word
bfcMaxConcurrencyDeadline :: Word
bfcMaxConcurrencyBulkSync :: Word
bfcSalt :: BlockFetchConfiguration -&gt; Int
bfcDecisionLoopInterval :: BlockFetchConfiguration -&gt; DiffTime
bfcMaxRequestsInflight :: BlockFetchConfiguration -&gt; Word
bfcMaxConcurrencyDeadline :: BlockFetchConfiguration -&gt; Word
bfcMaxConcurrencyBulkSync :: BlockFetchConfiguration -&gt; Word
</span><a href="#local-6989586621679254892"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>    </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchClientPolicy header block m
-&gt; m ()
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchClientPolicy header block m
-&gt; m ()
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#setFetchClientContext"><span class="hs-identifier hs-var">setFetchClientContext</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
</span><a href="#local-6989586621679254897"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679254910"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientPolicy header block m
</span><a href="#local-6989586621679254891"><span class="hs-identifier hs-var">fetchClientPolicy</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; m Void
forall header block (m :: * -&gt; *) peer.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block, MonadDelay m,
 MonadMonotonicTime m, MonadSTM m, Ord peer, Hashable peer) =&gt;
Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterations"><span class="hs-identifier hs-var">fetchLogicIterations</span></a></span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
</span><a href="#local-6989586621679254911"><span class="hs-identifier hs-var">decisionTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679254910"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679254889"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span class="annot"><span class="annottext">FetchTriggerVariables peer header m
</span><a href="#local-6989586621679254888"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a></span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">FetchNonTriggerVariables peer header block m
</span><a href="#local-6989586621679254887"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><a href="#local-6989586621679254891"><span class="hs-identifier hs-type">fetchClientPolicy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-type">FetchClientPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621679254891"><span class="annot"><span class="annottext">fetchClientPolicy :: FetchClientPolicy header block m
</span><a href="#local-6989586621679254891"><span class="hs-identifier hs-var hs-var">fetchClientPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientPolicy :: forall header block (m :: * -&gt; *).
(header -&gt; SizeInBytes)
-&gt; (header -&gt; block -&gt; Bool)
-&gt; (Point block -&gt; block -&gt; m ())
-&gt; (FromConsensus block -&gt; STM m UTCTime)
-&gt; FetchClientPolicy header block m
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-type">FetchClientPolicy</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-292"></span><span>                          </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
</span><a href="#local-6989586621679254885"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-293"></span><span>                          </span><span class="annot"><span class="annottext">header -&gt; block -&gt; Bool
blockMatchesHeader :: header -&gt; block -&gt; Bool
blockMatchesHeader :: header -&gt; block -&gt; Bool
</span><a href="#local-6989586621679254884"><span class="hs-identifier hs-var hs-var">blockMatchesHeader</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-294"></span><span>                          </span><span class="annot"><span class="annottext">Point block -&gt; block -&gt; m ()
addFetchedBlock :: Point block -&gt; block -&gt; m ()
addFetchedBlock :: Point block -&gt; block -&gt; m ()
</span><a href="#local-6989586621679254883"><span class="hs-identifier hs-var hs-var">addFetchedBlock</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-295"></span><span>                          </span><span class="annot"><span class="annottext">FromConsensus block -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus block -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus block -&gt; STM m UTCTime
</span><a href="#local-6989586621679254882"><span class="hs-identifier hs-var hs-var">blockForgeUTCTime</span></a></span><span>
</span><span id="line-296"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><a href="#local-6989586621679254889"><span class="hs-identifier hs-type">fetchDecisionPolicy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span id="local-6989586621679254889"><span class="annot"><span class="annottext">fetchDecisionPolicy :: FetchDecisionPolicy header
</span><a href="#local-6989586621679254889"><span class="hs-identifier hs-var hs-var">fetchDecisionPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>      </span><span class="annot"><span class="annottext">FetchDecisionPolicy :: forall header.
Word
-&gt; Word
-&gt; Word
-&gt; DiffTime
-&gt; Int
-&gt; (HasCallStack =&gt;
    AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool)
-&gt; (HasCallStack =&gt;
    AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering)
-&gt; (header -&gt; SizeInBytes)
-&gt; FetchDecisionPolicy header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">maxInFlightReqsPerPeer :: Word
</span><a href="#local-6989586621679254880"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679254894"><span class="hs-identifier hs-var">bfcMaxRequestsInflight</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">maxConcurrencyBulkSync :: Word
</span><a href="#local-6989586621679254879"><span class="hs-identifier hs-var">maxConcurrencyBulkSync</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679254896"><span class="hs-identifier hs-var">bfcMaxConcurrencyBulkSync</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">maxConcurrencyDeadline :: Word
</span><a href="#local-6989586621679254878"><span class="hs-identifier hs-var">maxConcurrencyDeadline</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679254895"><span class="hs-identifier hs-var">bfcMaxConcurrencyDeadline</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">decisionLoopInterval :: DiffTime
</span><a href="#local-6989586621679254877"><span class="hs-identifier hs-var">decisionLoopInterval</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679254893"><span class="hs-identifier hs-var">bfcDecisionLoopInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>        </span><span class="annot"><span class="annottext">peerSalt :: Int
</span><a href="#local-6989586621679254876"><span class="hs-identifier hs-var">peerSalt</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679254892"><span class="hs-identifier hs-var">bfcSalt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679254875"><span class="hs-identifier hs-var hs-var">plausibleCandidateChain</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679254874"><span class="hs-identifier hs-var hs-var">compareCandidateChains</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-309"></span><span>        </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
</span><a href="#local-6989586621679254873"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><a href="#local-6989586621679254888"><span class="hs-identifier hs-type">fetchTriggerVariables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span id="local-6989586621679254888"><span class="annot"><span class="annottext">fetchTriggerVariables :: FetchTriggerVariables peer header m
</span><a href="#local-6989586621679254888"><span class="hs-identifier hs-var hs-var">fetchTriggerVariables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-314"></span><span>      </span><span class="annot"><span class="annottext">FetchTriggerVariables :: forall peer header (m :: * -&gt; *).
STM m (AnchoredFragment header)
-&gt; STM m (Map peer (AnchoredFragment header))
-&gt; STM m (Map peer (PeerFetchStatus header))
-&gt; FetchTriggerVariables peer header m
</span><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">readStateCurrentChain :: STM m (AnchoredFragment header)
</span><a href="#local-6989586621679254871"><span class="hs-identifier hs-var">readStateCurrentChain</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment header)
</span><a href="#local-6989586621679254908"><span class="hs-identifier hs-var">readCurrentChain</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">readStateCandidateChains :: STM m (Map peer (AnchoredFragment header))
</span><a href="#local-6989586621679254870"><span class="hs-identifier hs-var">readStateCandidateChains</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment header))
</span><a href="#local-6989586621679254909"><span class="hs-identifier hs-var">readCandidateChains</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">readStatePeerStatus :: STM m (Map peer (PeerFetchStatus header))
</span><a href="#local-6989586621679254869"><span class="hs-identifier hs-var">readStatePeerStatus</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
-&gt; STM m (Map peer (PeerFetchStatus header))
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m
-&gt; STM m (Map peer (PeerFetchStatus header))
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStatus"><span class="hs-identifier hs-var">readFetchClientsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
</span><a href="#local-6989586621679254897"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><a href="#local-6989586621679254887"><span class="hs-identifier hs-type">fetchNonTriggerVariables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254915"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254914"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254913"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679254912"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span id="local-6989586621679254887"><span class="annot"><span class="annottext">fetchNonTriggerVariables :: FetchNonTriggerVariables peer header block m
</span><a href="#local-6989586621679254887"><span class="hs-identifier hs-var hs-var">fetchNonTriggerVariables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><span class="annottext">FetchNonTriggerVariables :: forall peer header block (m :: * -&gt; *).
STM m (Point block -&gt; Bool)
-&gt; STM m (Map peer (FetchClientStateVars m header))
-&gt; STM m (Map peer PeerGSV)
-&gt; STM m FetchMode
-&gt; STM m MaxSlotNo
-&gt; FetchNonTriggerVariables peer header block m
</span><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="annottext">readStateFetchedBlocks :: STM m (Point block -&gt; Bool)
</span><a href="#local-6989586621679254867"><span class="hs-identifier hs-var">readStateFetchedBlocks</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Point block -&gt; Bool)
</span><a href="#local-6989586621679254906"><span class="hs-identifier hs-var">readFetchedBlocks</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>        </span><span class="annot"><span class="annottext">readStatePeerStateVars :: STM m (Map peer (FetchClientStateVars m header))
</span><a href="#local-6989586621679254866"><span class="hs-identifier hs-var">readStatePeerStateVars</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
-&gt; STM m (Map peer (FetchClientStateVars m header))
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m
-&gt; STM m (Map peer (FetchClientStateVars m header))
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStateVars"><span class="hs-identifier hs-var">readFetchClientsStateVars</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
</span><a href="#local-6989586621679254897"><span class="hs-identifier hs-var">registry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-325"></span><span>        </span><span class="annot"><span class="annottext">readStatePeerGSVs :: STM m (Map peer PeerGSV)
</span><a href="#local-6989586621679254865"><span class="hs-identifier hs-var">readStatePeerGSVs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m -&gt; STM m (Map peer PeerGSV)
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m -&gt; STM m (Map peer PeerGSV)
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readPeerGSVs"><span class="hs-identifier hs-var">readPeerGSVs</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry peer header block m
</span><a href="#local-6989586621679254897"><span class="hs-identifier hs-var">registry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-326"></span><span>        </span><span class="annot"><span class="annottext">readStateFetchMode :: STM m FetchMode
</span><a href="#local-6989586621679254864"><span class="hs-identifier hs-var">readStateFetchMode</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m FetchMode
</span><a href="#local-6989586621679254907"><span class="hs-identifier hs-var">readFetchMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><span class="annottext">readStateFetchedMaxSlotNo :: STM m MaxSlotNo
</span><a href="#local-6989586621679254863"><span class="hs-identifier hs-var">readStateFetchedMaxSlotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m MaxSlotNo
</span><a href="#local-6989586621679254904"><span class="hs-identifier hs-var">readFetchedMaxSlotNo</span></a></span><span>
</span><span id="line-328"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-329"></span></pre></body></html>